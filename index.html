<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1.0"/>
  <title>MedSpa SEO Dashboard</title>

  <!-- Tailwind (dev CDN) -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Inter font -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet"/>

  <style>
    body { font-family:'Inter',sans-serif }
    .loader-container {display:flex;flex-direction:column;justify-content:center;align-items:center;height:100vh}
    .loader {border:4px solid #f3f3f3;border-top:4px solid #3498db;border-radius:50%;width:40px;height:40px;animation:spin 1s linear infinite}
    @keyframes spin {0%{transform:rotate(0deg)}100%{transform:rotate(360deg)}}
  </style>

  <!-- React / Babel / Recharts -->
  <script crossorigin src="https://cdn.jsdelivr.net/npm/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://cdn.jsdelivr.net/npm/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone@7.23.1/babel.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/prop-types@15/prop-types.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/recharts@2/umd/Recharts.min.js"></script>
</head>

<body class="bg-gray-50">
  <div id="root">
    <div class="loader-container">
      <div class="loader"></div>
      <p class="text-gray-500 mt-4">Loading application…</p>
    </div>
  </div>

<script type="text/babel">
/* ------------------------------------------------------------------ */
/* shared helpers / icons / generic components                        */
/* ------------------------------------------------------------------ */
const {useState,useEffect} = React;


/* ------------------------------------------------------------------ */
/* helpers  – icon factory  +  shared icons                           */
/* ------------------------------------------------------------------ */
const createIcon = path => props => (
  <svg
    xmlns="http://www.w3.org/2000/svg"
    width="24"
    height="24"
    viewBox="0 0 24 24"
    fill="none"
    stroke="currentColor"
    strokeWidth="2"
    strokeLinecap="round"
    strokeLinejoin="round"
    {...props}
  >
    {path}
  </svg>
);

/* reusable icons --------------------------------------------------- */
const Info = createIcon(
  <>
    <circle cx="12" cy="12" r="10" />
    <line  x1="12" y1="16" x2="12" y2="12" />
    <line  x1="12" y1="8"  x2="12.01" y2="8" />
  </>
);

const AlertTriangle = createIcon(
  <>
    <path d="m21.73 18-8-14a2 2 0 0 0-3.46 0l-8 14A2 2 0 0 0 4 21h16a2 2 0 0 0 1.73-3Z" />
    <line x1="12" y1="9"  x2="12" y2="13" />
    <line x1="12" y1="17" x2="12.01" y2="17" />
  </>
);

const Star = createIcon(
  <polygon points="12 2 15 8.5 22 9.3 17 14 18.3 21 12 17.7 5.7 21 7 14 2 9.3 9 8.5 12 2" />
);

const ArrowUp = createIcon(
  <>
    <line x1="12" y1="19" x2="12" y2="5" />
    <polyline points="5 12 12 5 19 12" />
  </>
);

const ArrowDown = createIcon(
  <>
    <line x1="12" y1="5"  x2="12" y2="19" />
    <polyline points="19 12 12 19 5 12" />
  </>
);

const CheckCircle  = createIcon(
  <>
    <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14" />
    <polyline points="22 4 12 14.01 9 11.01" />
  </>
);
const XCircle = createIcon(
  <>
    <circle cx="12" cy="12" r="10" />
    <line x1="15" y1="9" x2="9" y2="15" />
    <line x1="9" y1="9" x2="15" y2="15" />
  </>
);
const TrendingUp = createIcon(<polyline points="23 6 13.5 15.5 8.5 10.5 1 18" />);
const Link2 = createIcon(
  <>
    <path d="M9 17H7A5 5 0 0 1 7 7h2" />
    <path d="M15 7h2a5 5 0 0 1 0 10h-2" />
    <line x1="8" y1="12" x2="16" y2="12" />
  </>
);
const ShieldCheck = createIcon(
  <>
    <path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z" />
    <path d="m9 12 2 2 4-4" />
  </>
);

/* --- generic wrappers --- */
const Card        = ({children,className=''}) => (
  <div className={`bg-white rounded-xl shadow-md p-6 ${className}`}>{children}</div>);
const PageContent = ({children}) => (
  <main className="flex-1 p-4 sm:p-6 lg:p-8">{children}</main>);


/* ------------------------------------------------------------------ */
/* PLACEHOLDER PAGES – replace each later with real JSX               */
/* ------------------------------------------------------------------ */
const Dashboard = ({ setActiveTab }) => {
    const { ResponsiveContainer, BarChart, Bar, XAxis, YAxis, Tooltip, CartesianGrid, Cell, PieChart, Pie, Legend } = window.Recharts;
    
    // --- Additional Icon Components for this page ---
    const ExternalLink = createIcon(
      <>
        <path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6" />
        <polyline points="15 3 21 3 21 9" />
        <line x1="10" y1="14" x2="21" y2="3" />
      </>
    );
    const ChevronDown = createIcon(<polyline points="6 9 12 15 18 9" />);
    const ChevronUp = createIcon(<polyline points="18 15 12 9 6 15" />);

    // --- Reusable Components for this page ---
    const InfoTooltip = ({ text }) => (
        <div className="relative flex items-center group">
            <Info className="w-4 h-4 text-gray-400" />
            <div className="absolute left-1/2 -translate-x-1/2 bottom-full mb-2 w-64 p-3 bg-gray-800 text-white text-xs rounded-lg shadow-lg opacity-0 group-hover:opacity-100 transition-opacity duration-300 z-30 pointer-events-none">
                {text}
                <svg className="absolute text-gray-800 h-2 w-full left-0 top-full" x="0px" y="0px" viewBox="0 0 255 255"><polygon className="fill-current" points="0,0 127.5,127.5 255,0"/></svg>
            </div>
        </div>
    );
     const AdIndicator = ({ hasAd, link }) => {
        if (hasAd) {
            return (
                <a href={link} target="_blank" rel="noopener noreferrer" className="inline-flex items-center px-2 py-1 bg-green-100 text-green-800 text-xs font-semibold rounded-full hover:bg-green-200 transition-colors">
                    Active <ExternalLink className="w-3 h-3 ml-1.5" />
                </a>
            );
        }
        return <span className="px-2 py-1 text-xs font-semibold rounded-full bg-red-100 text-red-800">None</span>;
    };

    // --- Centralized data management with caching ---
    const [dashboardData, setDashboardData] = useState(null);
    const [loading, setLoading] = useState(true);
    const [error, setError] = useState(null);
    const [serviceData, setServiceData] = useState({});

    // --- Helper function to fetch data with CORS workaround ---
    const fetchWithCorsWorkaround = (url, callback) => {
        // Try regular fetch first
        fetch(url, {
            method: 'GET',
            mode: 'cors'
        })
        .then(response => response.json())
        .then(data => callback(null, data))
        .catch(err => {
            console.log('Regular fetch failed, trying JSONP approach...');
            // Fallback to JSONP-style request
            const script = document.createElement('script');
            const callbackName = 'jsonpCallback_' + Math.random().toString(36).substr(2, 9);
            window[callbackName] = (data) => {
                callback(null, data);
                document.head.removeChild(script);
                delete window[callbackName];
            };
            script.src = `${url}&callback=${callbackName}`;
            script.onerror = () => {
                callback(new Error('Failed to load data'), null);
                document.head.removeChild(script);
                delete window[callbackName];
            };
            document.head.appendChild(script);
        });
    };

    // --- Load main dashboard data once ---
    useEffect(() => {
        const params = new URLSearchParams(window.location.search);
        const workbookId = params.get('workbookId');
        if (!workbookId) {
            setError("No workbook ID provided");
            setLoading(false);
            return;
        }

        // Check if we already have cached data
        const cachedData = sessionStorage.getItem(`dashboard_${workbookId}`);
        if (cachedData) {
            try {
                const parsed = JSON.parse(cachedData);
                setDashboardData(parsed);
                setLoading(false);
                return;
            } catch (e) {
                // Invalid cache, continue with fresh fetch
            }
        }

        const scriptUrl = `https://script.google.com/macros/s/AKfycbxfOMp8d_eCVH4lFD0PNuFU1wH-gyWOwRt2EuME7GQJ4U73ZwpPDciohDH3C566YLWq/exec?workbookId=${workbookId}`;
        
        fetchWithCorsWorkaround(scriptUrl, (err, data) => {
            if (err) {
                setError(err.message);
                setLoading(false);
                return;
            }
            if (data.error) {
                setError(`Script error: ${data.error}`);
                setLoading(false);
                return;
            }
            
            // Cache the data for 5 minutes
            sessionStorage.setItem(`dashboard_${workbookId}`, JSON.stringify(data));
            setDashboardData(data);
            setLoading(false);
        });
    }, []);

    // --- Load service data in parallel ---
    useEffect(() => {
        if (!dashboardData) return;

        const locations = ['USA', 'Canada', 'Florida', 'Lakeland, FL'];
        const dataSets = ['topServices', 'newServices'];
        
        // Load all service data in parallel
        const promises = [];
        
        locations.forEach(location => {
            dataSets.forEach(dataSet => {
                const cacheKey = `services_${location}_${dataSet}`;
                const cachedData = sessionStorage.getItem(cacheKey);
                
                if (cachedData) {
                    try {
                        const parsed = JSON.parse(cachedData);
                        setServiceData(prev => ({
                            ...prev,
                            [cacheKey]: parsed
                        }));
                        return;
                    } catch (e) {
                        // Invalid cache, continue with fresh fetch
                    }
                }

                const scriptUrl = `https://script.google.com/macros/s/AKfycbys_HQL8HQdyL_-DoS0Aakvj-IzDWWW5HtNJDiFhbUwgCuKEYJ7N6iZGC-F62I7uZlV/exec?location=${location}`;
                
                const promise = new Promise((resolve) => {
                    fetchWithCorsWorkaround(scriptUrl, (err, data) => {
                        if (err || data.error) {
                            resolve({ cacheKey, error: err?.message || data.error });
                            return;
                        }
                        
                        const serviceData = dataSet === 'topServices' ? data.topServices : data.newServices;
                        
                        // Cache the data for 5 minutes
                        sessionStorage.setItem(cacheKey, JSON.stringify(serviceData));
                        
                        resolve({ cacheKey, data: serviceData });
                    });
                });
                
                promises.push(promise);
            });
        });

        // Wait for all service data to load
        Promise.all(promises).then(results => {
            const newServiceData = {};
            results.forEach(result => {
                if (result.error) {
                    newServiceData[result.cacheKey] = { error: result.error };
                } else {
                    newServiceData[result.cacheKey] = result.data;
                }
            });
            setServiceData(newServiceData);
        });
    }, [dashboardData]);

    // --- Sub-components for Dashboard ---
    const GeogridSection = ({ setActiveTab }) => {
        if (loading) {
            return <Card className="col-span-12 lg:col-span-8 flex items-center justify-center"><p className="text-gray-500">Loading Geogrid data...</p></Card>;
        }
        if (error) {
            return <Card className="col-span-12 lg:col-span-8 flex items-center justify-center"><p className="text-red-500">Geogrid Error: {error}</p></Card>;
        }
        
        const geogridData = dashboardData?.dashboard?.geogridForDashboard;
        if (!geogridData) {
            return <Card className="col-span-12 lg:col-span-8 flex items-center justify-center"><p className="text-gray-500">No Geogrid data to display for 'medspa near me'.</p></Card>;
        }
        
        return (
            <Card className="col-span-12 lg:col-span-8">
                <div className="flex justify-between items-center mb-4">
                    <div className="flex items-center space-x-2">
                        <h2 className="text-xl font-bold text-gray-800">Geogrid Map: Medspa Near Me</h2>
                        <InfoTooltip text="A snapshot of your latest Geogrid map for the keyword 'medspa near me'." />
                        <button onClick={() => setActiveTab('Geogrid Maps')} className="text-xs font-normal text-blue-600 hover:text-blue-800">(See More)</button>
                    </div>
                     <span className="font-semibold text-gray-700">{geogridData.date}</span>
                </div>
                <a href={geogridData.mapLink} target="_blank" rel="noopener noreferrer">
                    <img src={geogridData.mapLink} alt={`Geogrid Map for Medspa Near Me`} className="w-full rounded-lg mb-4 border border-gray-200" 
                        onError={(e) => { e.target.onerror = null; e.target.src='https://placehold.co/800x400/EFEFEF/333333?text=Map+Not+Available'; }}
                    />
                </a>
            </Card>
        );
    };

    const CensusInfo = () => {
        if (loading) {
            return <Card className="col-span-12 lg:col-span-4 h-full flex items-center justify-center"><p className="text-gray-500">Loading Census data...</p></Card>;
        }
        if (error) {
            return <Card className="col-span-12 lg:col-span-4 h-full flex items-center justify-center"><p className="text-red-500">Census Error: {error}</p></Card>;
        }
        
        const censusData = dashboardData?.dashboard?.censusData;
        if (!censusData) {
            return <Card className="col-span-12 lg:col-span-4 h-full flex items-center justify-center"><p className="text-gray-500">No census data available.</p></Card>;
        }

        return (
            <Card className="col-span-12 lg:col-span-4 h-full">
                 <div className="flex items-center space-x-2 mb-4">
                    <h2 className="text-xl font-bold text-gray-800">Census Data</h2>
                    <InfoTooltip text="Provides demographic and economic information for your target service area." />
                 </div>
                <div>
                    {Object.entries(censusData).map(([key, value]) => {
                        if (!value) return null;
                        return (
                             <div key={key} className="flex justify-between items-center text-sm py-3 border-t border-gray-100 first:border-t-0 first:pt-0">
                                <span className="font-medium text-gray-600">{key}</span>
                                <span className="font-semibold text-gray-800 text-right">{value}</span>
                            </div>
                        )
                    })}
                </div>
            </Card>
        );
    };

    const OverviewTable = () => {
        if (loading) {
            return <Card className="col-span-12 overflow-x-auto flex items-center justify-center"><p className="text-gray-500">Loading Overview data...</p></Card>;
        }
        if (error) {
            return <Card className="col-span-12 overflow-x-auto flex items-center justify-center"><p className="text-red-500">Overview Error: {error}</p></Card>;
        }
        
        const overviewData = dashboardData?.dashboard?.overviewData;
        if (!overviewData || overviewData.length === 0) {
            return <Card className="col-span-12 overflow-x-auto flex items-center justify-center"><p className="text-gray-500">No overview data available.</p></Card>;
        }

        return (
            <Card className="col-span-12 overflow-x-auto">
                <div className="flex justify-between items-center mb-4">
                    <div className="flex items-center space-x-2">
                        <h2 className="text-xl font-bold text-gray-800">Overview</h2>
                         <InfoTooltip text="A high-level comparison of your clinic against key competitors on important metrics like online reviews, site performance, and advertising." />
                    </div>
                    <button onClick={() => alert('Webhook for Overview refresh triggered!')} className="bg-slate-100 hover:bg-slate-200 text-slate-600 font-bold py-1 px-3 rounded-lg text-xs transition-colors duration-300">Refresh</button>
                </div>
                <table className="w-full text-left text-sm whitespace-nowrap">
                    <thead>
                        <tr className="border-b-2 border-gray-200">
                            <th className="py-2 px-3">Clinic</th>
                            <th className="py-2 px-3 text-center">Site Speed</th>
                            <th className="py-2 px-3 text-center">Keywords #1</th>
                            <th className="py-2 px-3 text-center">Backlinks</th>
                            <th className="py-2 px-3">Opening Hours</th>
                            <th className="py-2 px-3 text-center">Google Ads</th>
                            <th className="py-2 px-3 text-center">Facebook Ads</th>
                        </tr>
                    </thead>
                    <tbody>
                        {overviewData.map(c => (
                            <tr key={c.id} className={`border-b border-gray-100 ${c.isClient ? 'bg-blue-50' : ''}`}>
                                <td className="py-3 px-3">
                                    <div className="font-semibold text-gray-800">{c.name}</div>
                                    <div className="text-xs text-gray-600">{c.score} ⭐ ({c.reviews} reviews)</div>
                                </td>
                                <td className="py-3 px-3 text-center font-medium">{c.speed}</td>
                                <td className="py-3 px-3 text-center font-medium">{c.kwPos1}</td>
                                <td className="py-3 px-3 text-center font-medium">{c.backlinks.toLocaleString()}</td>
                                <td className="py-3 px-3 text-gray-600">{c.hours}</td>
                                <td className="py-3 px-3 text-center"><AdIndicator hasAd={c.gAds} /></td>
                                <td className="py-3 px-3 text-center"><AdIndicator hasAd={c.fbAds} /></td>
                            </tr>
                        ))}
                    </tbody>
                </table>
            </Card>
        );
    };
    
    const AIReport = () => {
        const [isExpanded, setIsExpanded] = useState(false);

        if (loading) {
            return <Card className="col-span-12 relative flex items-center justify-center"><p className="text-gray-500">Loading AI Report...</p></Card>;
        }
        if (error) {
            return <Card className="col-span-12 relative flex items-center justify-center"><p className="text-red-500">AI Report Error: {error}</p></Card>;
        }
        
        const reportText = dashboardData?.dashboard?.aiReport;
        if (!reportText) {
            return <Card className="col-span-12 relative flex items-center justify-center"><p className="text-gray-500">No AI report available.</p></Card>;
        }

        return (
            <Card className="col-span-12 relative">
                 <div className="flex items-center space-x-2 mb-1">
                     <h2 className="text-xl font-bold text-gray-800">AI Report</h2>
                     <InfoTooltip text="An automated SWOT (Strengths, Weaknesses, Opportunities, Threats) analysis based on the collected data, providing strategic insights and recommendations." />
                 </div>
                 <h3 className="text-md font-semibold text-gray-600 mb-3">SWOT Analysis</h3>
                 <div className={`prose prose-sm max-w-none text-gray-600 overflow-hidden relative transition-all duration-300 ${isExpanded ? 'max-h-96' : 'max-h-24'}`}>
                    <div dangerouslySetInnerHTML={{ __html: reportText?.replace(/\n/g, '<br />') }} />
                     {!isExpanded && <div className="absolute bottom-0 left-0 w-full h-12 bg-gradient-to-t from-white to-transparent"></div>}
                 </div>
                 <button onClick={() => setIsExpanded(!isExpanded)} className="mt-2 text-blue-600 hover:text-blue-800 text-sm font-semibold flex items-center">
                     {isExpanded ? 'Show Less' : 'Show More'}
                     {isExpanded ? <ChevronUp className="w-4 h-4 ml-1" /> : <ChevronDown className="w-4 h-4 ml-1" />}
                 </button>
            </Card>
        );
    }

    const ServiceList = ({ title, dataSet, tooltipText }) => {
        const [selectedLocation, setSelectedLocation] = useState('USA');
        const [expandedService, setExpandedService] = useState(null);

        const cacheKey = `services_${selectedLocation}_${dataSet}`;
        const serviceData = cacheKey in serviceData ? serviceData[cacheKey] : null;
        const hasError = serviceData && serviceData.error;

        if (!serviceData && !hasError) {
            return <Card className="col-span-12 md:col-span-6 flex items-center justify-center"><p className="text-gray-500">Loading Service Data...</p></Card>;
        }
        if (hasError) {
            return <Card className="col-span-12 md:col-span-6 flex items-center justify-center"><p className="text-red-500">Service Error: {serviceData.error}</p></Card>;
        }
        if (!serviceData || serviceData.length === 0) {
            return <Card className="col-span-12 md:col-span-6 flex items-center justify-center"><p className="text-gray-500">No service data found for {selectedLocation}.</p></Card>;
        }
        
        return (
            <Card className="col-span-12 md:col-span-6">
                <div className="flex justify-between items-start mb-4">
                    <div className="flex items-center space-x-2">
                        <h2 className="text-xl font-bold text-gray-800">{title}</h2>
                        <InfoTooltip text={tooltipText} />
                    </div>
                    <select 
                        value={selectedLocation} 
                        onChange={(e) => setSelectedLocation(e.target.value)}
                        className="text-sm border-gray-300 rounded-md shadow-sm focus:border-blue-300 focus:ring focus:ring-blue-200 focus:ring-opacity-50"
                    >
                         <option value="USA">United States</option>
                         <option value="Canada">Canada</option>
                         <option value="Florida">Florida</option>
                         <option value="Lakeland, FL">Lakeland, FL</option>
                    </select>
                </div>
                 <div className="overflow-x-auto">
                    <table className="w-full text-left text-sm whitespace-nowrap">
                       <thead>
                          <tr className="border-b-2 border-gray-200">
                             <th className="py-2 px-3">Service</th>
                             <th className="py-2 px-3 text-center">% of Search Vol</th>
                             <th className="py-2 px-3 text-center">Avg. Comp.</th>
                             <th className="py-2 px-3 text-center">Avg. CPC</th>
                             <th className="py-2 px-3 text-center">Trend</th>
                          </tr>
                       </thead>
                       <tbody>
                          {serviceData.map(service => (
                            <React.Fragment key={service.name}>
                                <tr className="border-b border-gray-100 hover:bg-slate-50 cursor-pointer" onClick={() => setExpandedService(expandedService === service.name ? null : service.name)}>
                                   <td className="py-3 px-3 font-medium text-gray-800">{service.name}</td>
                                   <td className="py-3 px-3 text-center">{service.percentage}</td>
                                   <td className="py-3 px-3 text-center">{service.avgCompetition}</td>
                                   <td className="py-3 px-3 text-center">${service.avgCpc}</td>
                                   <td className="py-3 px-3 text-center">
                                      {service.trend === 1 && <ArrowUp className="w-4 h-4 text-green-500 mx-auto" />}
                                      {service.trend === -1 && <ArrowDown className="w-4 h-4 text-red-500 mx-auto" />}
                                      {service.trend === 0 && <span className="text-gray-400">-</span>}
                                   </td>
                                </tr>
                                {expandedService === service.name && (
                                    <tr>
                                        <td colSpan="5" className="p-0">
                                            <div className="bg-slate-50 p-3">
                                                <h4 className="font-bold text-xs mb-2">Top Keywords for {service.name}</h4>
                                                 <table className="w-full text-left text-xs">
                                                     <thead>
                                                        <tr className="border-b border-gray-300">
                                                            <th className="py-1 px-2">Keyword</th>
                                                            <th className="py-1 px-2 text-center">Volume</th>
                                                        </tr>
                                                     </thead>
                                                     <tbody>
                                                        {service.keywords.map(kw => (
                                                            <tr key={kw.name} className="border-b border-gray-200">
                                                                <td className="py-1 px-2">{kw.name}</td>
                                                                <td className="py-1 px-2 text-center">{kw.volume.toLocaleString()}</td>
                                                            </tr>
                                                        ))}
                                                     </tbody>
                                                 </table>
                                            </div>
                                        </td>
                                    </tr>
                                )}
                            </React.Fragment>
                          ))}
                       </tbody>
                    </table>
                 </div>
            </Card>
        );
    };
    
    return (
        <PageContent>
            <div className="grid grid-cols-12 gap-6">
                <GeogridSection setActiveTab={setActiveTab} />
                <CensusInfo />
                <OverviewTable />
                <AIReport />
                <ServiceList title="Services by Search Volume" dataSet="topServices" tooltipText="Lists the most popular, established MedSpa services based on monthly search volume in the selected geographic area." />
                <ServiceList title="New Services by Search Volume" dataSet="newServices" tooltipText="Highlights emerging or newer services with growing search interest, indicating potential new market opportunities." />
            </div>
        </PageContent>
    );
};

/* ------------------------------------------------------------------ */
/* KEYWORDS PAGE – full live version                                  */
/* ------------------------------------------------------------------ */
const Keywords = ({ summary, table }) => {
  /* ----- competitor selector state ----- */
  const siteNames   = Object.keys(table);
  const clientName  = siteNames.find(n=>n.toLowerCase().includes('client') || n.toLowerCase().includes('look')) || siteNames[0];
  const [active, setActive] = useState(clientName);

  /* ----- rows for the selected site ----- */
  const rows   = table[active] || [];
  const ROWCAP = 200;       // show up to 200 keywords

  /* ----- summary cards ----- */
  const bucket = [
    {label:'Total', value:summary.totalKeywords},
    {label:'Pos 1', value:summary.pos1},
    {label:'Pos 2-3', value:summary.pos2_3},
    {label:'Pos 4-10', value:summary.pos4_10},
    {label:'Pos 11-20', value:summary.pos11_20},
    {label:'New',  value:summary.isNew,  color:summary.isNew  ?'text-blue-600':''},
    {label:'Up',   value:summary.isUp,   color:summary.isUp   ?'text-green-600':''},
    {label:'Down', value:summary.isDown, color:summary.isDown ?'text-red-600':''},
    {label:'Lost', value:summary.isLost, color:summary.isLost ?'text-red-600':''},
    {label:'ETV',  value:summary.etv.toFixed(2)},
    {label:'Est. Cost', value:'$'+summary.estPaidCost.toFixed(2)}
  ];

  return (
    <PageContent>
      {/* overview cards */}
      <Card className="mb-8">
        <h2 className="text-xl font-bold mb-4">Keyword Overview</h2>
        <div className="grid grid-cols-2 sm:grid-cols-4 md:grid-cols-6 lg:grid-cols-8 gap-4">
          {bucket.map(c=>(
            <div key={c.label} className="text-center">
              <p className={`text-xl font-bold ${c.color||'text-gray-800'}`}>{c.value}</p>
              <p className="text-xs text-gray-500">{c.label}</p>
            </div>
          ))}
        </div>
      </Card>

      {/* competitor pills */}
      <div className="flex flex-wrap gap-2 mb-4">
        {siteNames.map(n=>(
          <button key={n}
                  onClick={()=>setActive(n)}
                  className={`px-3 py-1 rounded-full text-sm border
                    ${active===n
                      ?'bg-blue-600 text-white border-blue-600'
                      :'bg-white text-gray-600 hover:bg-gray-100'}`}>
            {n}
          </button>
        ))}
      </div>

      {/* keyword table */}
      <Card className="overflow-x-auto">
        <table className="min-w-[880px] text-sm">
          <thead className="text-left border-b">
            <tr>
              <th className="py-2 pr-4">Keyword</th>
              <th className="py-2 pr-2">Rank</th>
              <th className="py-2 pr-2">Prev</th>
              <th className="py-2 pr-2">Δ</th>
              <th className="py-2 pr-2">Vol</th>
              <th className="py-2 pr-2">CPC</th>
              <th className="py-2 pr-2">Intent</th>
            </tr>
          </thead>
          <tbody>
            {rows.slice(0,ROWCAP).map((r,i)=>{
              const delta = r.rank_prev==='' ? null : r.rank_prev - r.rank_now;
              return (
                <tr key={i} className="border-b last:border-0">
                  <td className="py-1 pr-4 whitespace-nowrap">{r.keyword}</td>
                  <td className="py-1 pr-2">{r.rank_now}</td>
                  <td className="py-1 pr-2">{r.rank_prev || '–'}</td>
                  <td className="py-1 pr-2">
                    {r.is_new  && <Star          className="w-4 h-4 text-blue-500 inline"/>}
                    {r.is_lost && <AlertTriangle className="w-4 h-4 text-red-500  inline"/>}
                    {delta>0   && <ArrowUp       className="w-4 h-4 text-green-500 inline"/>}
                    {delta<0   && <ArrowDown     className="w-4 h-4 text-red-500   inline"/>}
                  </td>
                  <td className="py-1 pr-2">{r.search_vol}</td>
                  <td className="py-1 pr-2">${Number(r.cpc_usd).toFixed(2)}</td>
                  <td className="py-1 pr-2">{r.intent}</td>
                </tr>
              );
            })}
          </tbody>
        </table>
        {rows.length>ROWCAP &&
          <p className="text-xs text-gray-400 mt-2">
            Showing first {ROWCAP} of {rows.length} rows.
          </p>}
      </Card>
    </PageContent>
  );
};

const Backlinks     = () => <PageContent><h2 className="text-center text-gray-500">Backlinks – TODO</h2></PageContent>;
const ToolsPage     = () => <PageContent><h2 className="text-center text-gray-500">Tools – coming soon</h2></PageContent>;
const GeogridMaps = ({data}) =>
  <PageContent>
    <h2 className="text-center text-gray-500">Geogrid Maps – TODO</h2>
  </PageContent>;

/* ------------------------------------------------------------------ */
/* WEBSITE STATS – polished gauge, colour rules, horizontal bars      */
/* ------------------------------------------------------------------ */
const WebsiteStats = ({ data }) => {
  const {
    ResponsiveContainer,
    BarChart, Bar, XAxis, YAxis, Tooltip, CartesianGrid, Cell,
  } = window.Recharts;

  if (!data) {
    return (
      <PageContent>
        <div className="p-8 text-center text-gray-500">No data.</div>
      </PageContent>
    );
  }

  const { healthData, competitorPerfData } = data;

  /* ---------- colour helpers ---------- */
  const gaugeColour =
    healthData.pageScore >= 90 ? '#16a34a'
      : healthData.pageScore >= 70 ? '#eab308'
      : '#dc2626';

  const speedSec = parseFloat(String(healthData.siteSpeed).replace(/[^\d.]/g, '')) || 0;
  const speedCol = speedSec < 1.5 ? 'text-green-600'
                : speedSec < 3   ? 'text-yellow-600'
                :                  'text-red-600';

  const linkCol  = healthData.brokenLinks === 0 ? 'text-green-600'
                : healthData.brokenLinks === 1 ? 'text-yellow-600'
                :                               'text-red-600';

  const sslCol   = healthData.ssl ? 'text-green-600' : 'text-red-600';

  const passPct  = healthData.checks.checksPassed / healthData.checks.totalChecks * 100;
  const passCol  = passPct >= 88 ? 'text-green-600'
                : passPct >= 69  ? 'text-yellow-600'
                :                 'text-red-600';

  /* ---------- helpers ---------- */
  const StatCard = ({ label, value, icon }) => (
    <div className="flex items-center space-x-3">
      <div className="p-2 bg-blue-100 rounded-full">{icon}</div>
      <div>
        <p className="text-sm text-gray-500">{label}</p>
        <p className={`font-bold text-lg ${value.color || 'text-gray-800'}`}>{value.text}</p>
      </div>
    </div>
  );

  const TooltipWrap = ({ children, content }) => (
    <div className="relative group">
      {children}
      {content && (
        <div className="absolute left-1/2 -translate-x-1/2 top-full mt-3 w-80 bg-white border
                        border-gray-200 rounded-xl shadow-lg text-gray-800 text-xs opacity-0
                        group-hover:opacity-100 transition-opacity duration-200 z-20">
          <div className="p-4 max-h-60 overflow-y-auto">{content}</div>
        </div>
      )}
    </div>
  );

  /* ---------- stat-cards ---------- */
  const cards = [
    {
      label: 'Site Speed',
      value: { text: healthData.siteSpeed, color: speedCol },
      icon: <TrendingUp className="w-5 h-5 text-blue-600" />,
    },
    {
      label: 'Broken Links',
      value: { text: healthData.brokenLinks ?? '0', color: linkCol },
      icon: <Link2 className="w-5 h-5 text-blue-600" />,
    },
    {
      label: 'SSL',
      value: { text: healthData.ssl ? 'Active' : 'Inactive', color: sslCol },
      icon: <ShieldCheck className="w-5 h-5 text-blue-600" />,
    },
    {
      label: 'Checks Passed',
      value: {
        text: `${healthData.checks.checksPassed}/${healthData.checks.totalChecks}`,
        color: passCol,
      },
      icon: <CheckCircle className="w-5 h-5 text-blue-600" />,
      tooltip: (
        <>
          <h4 className="font-semibold mb-2 text-green-600">
            Passed ({healthData.checks.passedList.length})
          </h4>
          <ul className="list-disc pl-4 space-y-1 mb-3">
            {healthData.checks.passedList.map((it) => (
              <li key={it}>{it}</li>
            ))}
          </ul>
          <h4 className="font-semibold mb-2 text-red-600">
            Failed ({healthData.checks.failedList.length})
          </h4>
          <ul className="list-disc pl-4 space-y-1">
            {healthData.checks.failedList.map((it) => (
              <li key={it}>{it}</li>
            ))}
          </ul>
        </>
      ),
    },
  ];

  /* ---------- bar-chart data ---------- */
  const CHART_COLS = ['#3b82f6', '#16a34a', '#eab308', '#a855f7', '#ec4899', '#0ea5e9'];
  const speedData = competitorPerfData.map((r, idx) => ({
    name: r.name + (r.isClient ? ' (You)' : ''),
    speed: parseFloat(String(r['Site Speed (s)']).replace(/[^\d.]/g, '')) || 0,
    fill: r.isClient ? '#0ea5e9' : CHART_COLS[idx % CHART_COLS.length],
  }));

  /* ---------- JSX ---------- */
  return (
    <PageContent>

      {/* --- health section --- */}
      <Card className="mb-8">
        <h2 className="text-xl font-bold mb-4">Website Health</h2>

        <div className="grid grid-cols-1 lg:grid-cols-4 gap-6">

          {/* gauge ------------------------ */}
          <div className="flex flex-col items-center">
            <div className="relative">
              <svg className="w-32 h-32">
                {/* grey track */}
                <circle r="54" cx="64" cy="64"
                        fill="transparent" stroke="currentColor" strokeWidth="8"
                        className="text-gray-200" />
                {/* coloured arc */}
                <circle r="54" cx="64" cy="64"
                        fill="transparent" stroke={gaugeColour} strokeWidth="8"
                        strokeDasharray={2 * Math.PI * 54}
                        strokeDashoffset={healthData.pageScore >= 99.9
                          ? 0                                  // 100% closes the gap
                          : 2 * Math.PI * 54 * (1 - healthData.pageScore / 100)}
                        strokeLinecap="butt"
                        style={{ transform: 'rotate(-90deg)', transformOrigin: '50% 50%' }}
                />
              </svg>
              <span
                className="absolute inset-0 flex items-center justify-center text-3xl font-bold text-black">
                {healthData.pageScore.toFixed(1)}
              </span>
            </div>

            <p className="text-gray-600 mt-2 font-semibold">Page Score</p>

            {/* warnings first, errors second */}
            <div className="flex space-x-6 mt-4">
              <TooltipWrap
                content={
                  healthData.warnings.length
                    ? healthData.warnings.map((w) => <p key={w.id}>• {w.description}</p>)
                    : 'No warnings'
                }
              >
                <div className="flex items-center space-x-2">
                  <AlertTriangle className="w-5 h-5 text-yellow-500" />
                  <span className="font-bold text-lg text-yellow-500">
                    {healthData.warnings.length}
                  </span>
                </div>
              </TooltipWrap>

              <TooltipWrap
                content={
                  healthData.errors.length
                    ? healthData.errors.map((e) => <p key={e.id}>• {e.description}</p>)
                    : 'No errors'
                }
              >
                <div className="flex items-center space-x-2">
                  <XCircle className="w-5 h-5 text-red-500" />
                  <span className="font-bold text-lg text-red-500">
                    {healthData.errors.length}
                  </span>
                </div>
              </TooltipWrap>
            </div>
          </div>

          {/* stat cards ------------------- */}
          <div className="lg:col-span-3 grid grid-cols-1 sm:grid-cols-2 gap-6">
            {cards.map((c) => (
              <TooltipWrap key={c.label} content={c.tooltip}>
                <StatCard {...c} />
              </TooltipWrap>
            ))}
          </div>
        </div>
      </Card>

      {/* --- horizontal bar chart --- */}
      <Card>
        <h2 className="text-lg font-semibold mb-4">
          Site Speed (s) – lower is better
        </h2>
        <ResponsiveContainer width="100%" height={260}>
          <BarChart
            data={speedData}
            layout="vertical"
            margin={{ left: 80, right: 20, top: 5, bottom: 5 }}
          >
            <CartesianGrid strokeDasharray="3 3" horizontal={false} />
            <XAxis
              type="number"
              tick={{ fontSize: 12 }}
              domain={[0, (dataMax) => Math.round(dataMax * 1.2)]}
            />
            <YAxis
              dataKey="name"
              type="category"
              width={120}
              tick={{ fontSize: 12 }}
            />
            <Tooltip />
            <Bar dataKey="speed" barSize={18}>
              {speedData.map((entry, idx) => (
                <Cell key={idx} fill={entry.fill} />
              ))}
            </Bar>
          </BarChart>
        </ResponsiveContainer>
      </Card>
    </PageContent>
  );
};

/* ------------------------------------------------------------------ */
/* HEADER                                                             */
/* ------------------------------------------------------------------ */
const Header = ({active,setActive}) => {
  const tabs=['Dashboard','Website Stats','Geogrid Maps','Keywords','Backlinks','Tools'];
  return (
    <header className="bg-white shadow-sm sticky top-0 z-20">
      <nav className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
        <div className="flex items-center justify-between h-16">
          <div className="flex items-center">
            <svg className="h-8 w-8" viewBox="0 0 24 24" fill="none"
                 stroke="url(#lg)" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
              <defs>
                <linearGradient id="lg" x1="0%" y1="0%" x2="100%" y2="0%">
                  <stop offset="0%" stopColor="#3b82f6"/><stop offset="100%" stopColor="#ec4899"/>
                </linearGradient>
              </defs>
              <path d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"/>
            </svg>
            <h1 className="text-xl font-bold ml-3 bg-gradient-to-r from-blue-500 to-pink-500 bg-clip-text text-transparent">
              MedSpa SEO
            </h1>
          </div>
          <div className="hidden md:block">
            <div className="ml-10 flex space-x-4">
              {tabs.map(t=>(
                <button key={t}
                        onClick={()=>setActive(t)}
                        className={`px-3 py-2 rounded-md text-sm font-medium
                          ${active===t?'bg-blue-600 text-white':'text-gray-500 hover:bg-gray-100 hover:text-gray-900'}`}>
                  {t}
                </button>
              ))}
            </div>
          </div>
        </div>
      </nav>
    </header>
  );
};

/* ------------------------------------------------------------------ */
/* MAIN APP – fetches data, routes tabs                               */
/* ------------------------------------------------------------------ */
const App = () => {
  const [tab, setTab]   = useState('Dashboard');
  const [data, setData] = useState(null);
  const [err,  setErr]  = useState(null);
  const [load, setLoad] = useState(true);

  useEffect(() => {
    const id = new URLSearchParams(location.search).get('workbookId');
    if (!id) { setErr('Add ?workbookId=YOUR_ID to the URL'); setLoad(false); return; }

    fetch(`https://script.google.com/macros/s/AKfycbxfOMp8d_eCVH4lFD0PNuFU1wH-gyWOwRt2EuME7GQJ4U73ZwpPDciohDH3C566YLWq/exec?workbookId=${id}`)
      .then(r => r.json())
      .then(j => { if (j.error) throw new Error(j.error); setData(j); setLoad(false); })
      .catch(e => { console.error(e); setErr(e.message); setLoad(false); });
  }, []);

  /* routing */
  let body;
  if (load) {
    body = (
      <PageContent>
        <div className="p-8 text-center text-gray-500">Loading data…</div>
      </PageContent>
    );
  } else if (err) {
    body = (
      <PageContent>
        <div className="p-8 text-center text-red-500">{err}</div>
      </PageContent>
    );
  } else {
    switch (tab) {
      case 'Dashboard':
        body = <Dashboard setActiveTab={setTab} />;
        break;
      case 'Website Stats':
        body = <WebsiteStats data={data.websiteStats} />;
        break;
      case 'Geogrid Maps':
        body = <GeogridMaps data={data.geogridData} />;
        break;
      case 'Keywords':
        body = (
          <Keywords
            summary={data.keywordsSummary}
            table={data.keywordsTable}
          />
        );
        break;
      case 'Backlinks':
        body = (
          <Backlinks
            data={data.backlinksSummary}
            table={data.backlinksTable}
          />
        );
        break;
      default:
        body = <ToolsPage />;
    }
  }

  /* ----- render ----- */
  return (
    <div className="min-h-screen bg-gray-50 font-sans">
      <Header active={tab} setActive={setTab} />
      {body}
    </div>
  );
};

/* mount React app */
ReactDOM.createRoot(document.getElementById('root')).render(<App />);
</script>
</body>
</html>
