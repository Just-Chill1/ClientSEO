<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MedSpa SEO Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .loader-container { display: flex; flex-direction: column; justify-content: center; align-items: center; height: 100vh; }
        .loader { border: 4px solid #f3f3f3; border-top: 4px solid #3498db; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
    <!-- Load React and library scripts -->
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://unpkg.com/recharts/umd/Recharts.min.js"></script>
</head>
<body class="bg-gray-50">
    <div id="root">
        <div class="loader-container">
            <div class="loader"></div>
            <p class="text-gray-500 mt-4">Loading Application...</p>
        </div>
    </div>

    <!-- Main React Application -->
    <script type="text/babel">
        window.addEventListener('load', () => {
            const { useState, useEffect, Fragment } = React;
            
            const AppContainer = () => {
                const [libsLoaded, setLibsLoaded] = useState(false);

                useEffect(() => {
                    const interval = setInterval(() => {
                        if (window.React && window.ReactDOM && window.Recharts) {
                            setLibsLoaded(true);
                            clearInterval(interval);
                        }
                    }, 100);
                    return () => clearInterval(interval);
                }, []);

                if (!libsLoaded) {
                    return (
                        <div className="loader-container">
                            <div className="loader"></div>
                            <p className="text-gray-500 mt-4">Initializing Libraries...</p>
                        </div>
                    );
                }
                return <App />;
            };
            
            const App = () => {
                const [activeTab, setActiveTab] = useState('Dashboard');
                const [appData, setAppData] = useState(null);
                const [loading, setLoading] = useState(true);
                const [error, setError] = useState(null);

                useEffect(() => {
                    const params = new URLSearchParams(window.location.search);
                    const workbookId = params.get('workbookId');
                    if (!workbookId) {
                        setError("No workbook ID provided in the URL. Please add '?workbookId=YOUR_ID' to the end of the URL.");
                        setLoading(false);
                        return;
                    }

                    const scriptUrl = `https://script.google.com/macros/s/AKfycbxfOMp8d_eCVH4lFD0PNuFU1wH-gyWOwRt2EuME7GQJ4U73ZwpPDciohDH3C566YLWq/exec?workbookId=${workbookId}`;
                    
                    fetch(scriptUrl, {
                        method: 'POST',
                        mode: 'cors',
                        redirect: 'follow',
                        body: ''
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.error) {
                            throw new Error(`Script error: ${data.error}`);
                        }
                        setAppData(data);
                        setLoading(false);
                    })
                    .catch(err => {
                        console.error("Fetch Error:", err);
                        setError(err.message);
                        setLoading(false);
                    });
                }, []);
                
                const renderContent = () => {
                    if (loading) {
                        return <PageContent><div className="p-8 text-center text-gray-500">Loading live data from your workbook...</div></PageContent>;
                    }
                    if (error) {
                        return <PageContent><div className="p-8 text-center text-red-500">Error: {error}</div></PageContent>;
                    }
                    if (!appData) {
                         return <PageContent><div className="p-8 text-center text-gray-500">No data found.</div></PageContent>;
                    }

                    if (activeTab === 'Keywords') return <KeywordsPage data={appData} />;
                    if (activeTab === 'Backlinks') return <BacklinksPage data={appData} />;
                    if (activeTab === 'Geogrid Maps') return <GeogridMapsPage appData={appData} />;
                    if (activeTab === 'Website Stats') return <WebsiteStatsPage data={appData.websiteStats} />;
                    if (activeTab === 'Tools') return <div className="p-8 text-center text-gray-500">Tools Page Coming Soon...</div>;
                    return <Dashboard setActiveTab={setActiveTab} appData={appData} />;
                };

                return (
                    <div className="min-h-screen bg-gray-50 font-sans">
                        <Header activeTab={activeTab} setActiveTab={setActiveTab} />
                        {renderContent()}
                    </div>
                );
            };

            const root = ReactDOM.createRoot(document.getElementById('root'));
            root.render(<AppContainer />);
        });
    </script>
</body>
</html>
