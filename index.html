<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1.0"/>
  <title>MedSpa SEO Dashboard</title>

  <!-- Tailwind (dev CDN) -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Inter font -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet"/>

  <style>
    body { font-family:'Inter',sans-serif }
    .loader-container {display:flex;flex-direction:column;justify-content:center;align-items:center;height:100vh}
    .loader {border:4px solid #f3f3f3;border-top:4px solid #3498db;border-radius:50%;width:40px;height:40px;animation:spin 1s linear infinite}
    @keyframes spin {0%{transform:rotate(0deg)}100%{transform:rotate(360deg)}}
  </style>

  <!-- React / Babel / Recharts -->
  <script crossorigin src="https://cdn.jsdelivr.net/npm/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://cdn.jsdelivr.net/npm/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone@7.23.1/babel.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/prop-types@15/prop-types.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/recharts@2/umd/Recharts.min.js"></script>
</head>

<body class="bg-gray-50">
  <div id="root">
    <div class="loader-container">
      <div class="loader"></div>
      <p class="text-gray-500 mt-4">Loading application…</p>
    </div>
  </div>

<script type="text/babel">
/* ------------------------------------------------------------------ */
/* shared helpers / icons / generic components                        */
/* ------------------------------------------------------------------ */
const {useState,useEffect} = React;


/* ------------------------------------------------------------------ */
/* helpers  – icon factory  +  shared icons                           */
/* ------------------------------------------------------------------ */
const createIcon = path => props => (
  <svg
    xmlns="http://www.w3.org/2000/svg"
    width="24"
    height="24"
    viewBox="0 0 24 24"
    fill="none"
    stroke="currentColor"
    strokeWidth="2"
    strokeLinecap="round"
    strokeLinejoin="round"
    {...props}
  >
    {path}
  </svg>
);

/* reusable icons --------------------------------------------------- */
const Info = createIcon(
  <>
    <circle cx="12" cy="12" r="10" />
    <line  x1="12" y1="16" x2="12" y2="12" />
    <line  x1="12" y1="8"  x2="12.01" y2="8" />
  </>
);

const AlertTriangle = createIcon(
  <>
    <path d="m21.73 18-8-14a2 2 0 0 0-3.46 0l-8 14A2 2 0 0 0 4 21h16a2 2 0 0 0 1.73-3Z" />
    <line x1="12" y1="9"  x2="12" y2="13" />
    <line x1="12" y1="17" x2="12.01" y2="17" />
  </>
);

const Star = createIcon(
  <polygon points="12 2 15 8.5 22 9.3 17 14 18.3 21 12 17.7 5.7 21 7 14 2 9.3 9 8.5 12 2" />
);

const ArrowUp = createIcon(
  <>
    <line x1="12" y1="19" x2="12" y2="5" />
    <polyline points="5 12 12 5 19 12" />
  </>
);

const ArrowDown = createIcon(
  <>
    <line x1="12" y1="5"  x2="12" y2="19" />
    <polyline points="19 12 12 19 5 12" />
  </

/* --- generic wrappers --- */
const Card        = ({children,className=''}) => (
  <div className={`bg-white rounded-xl shadow-md p-6 ${className}`}>{children}</div>);
const PageContent = ({children}) => (
  <main className="flex-1 p-4 sm:p-6 lg:p-8">{children}</main>);


/* ------------------------------------------------------------------ */
/* PLACEHOLDER PAGES – replace each later with real JSX               */
/* ------------------------------------------------------------------ */
const Dashboard     = () => <PageContent><h2 className="text-center text-gray-500">Dashboard – TODO</h2></PageContent>;
/* ------------------------------------------------------------------ */
/* WEBSITE STATS – full live version                                  */
/* ------------------------------------------------------------------ */
const WebsiteStats = ({ data }) => {
  /* pull Recharts only in this page */
  const { ResponsiveContainer, BarChart, Bar, XAxis, YAxis, Tooltip, CartesianGrid } = window.Recharts;

  /* fallback if no data yet */
  if (!data) return <PageContent><div className="p-8 text-center text-gray-500">No data.</div></PageContent>;

  const { healthData, competitorPerfData, technicalSeoData } = data;

  /* --------- helper components ---------- */
  const StatCard = ({label,value,icon}) => (
    <div className="flex items-center space-x-3">
      <div className="p-2 bg-blue-100 rounded-full">{icon}</div>
      <div>
        <p className="text-sm text-gray-500">{label}</p>
        <p className="font-bold text-lg text-gray-800">{value}</p>
      </div>
    </div>
  );

  /* popover with smooth colours and scrollable list */
  const HealthCheckItem = ({icon,color,title,items}) => (
    <div className="relative group flex items-center space-x-2">
      {icon}
      <div>
        <p className={`font-bold text-lg ${color}`}>{items.length}</p>
        <p className="text-xs text-gray-500">{title}</p>
      </div>

      {/* nicer tooltip */}
      <div className="absolute left-1/2 -translate-x-1/2 top-full mt-3 w-80 bg-white border border-gray-200 text-gray-800 text-xs rounded-xl shadow-lg
                      opacity-0 pointer-events-auto group-hover:opacity-100 transition-opacity duration-200 z-20">
        <div className="p-4 max-h-60 overflow-y-auto">
          <h4 className="font-semibold mb-2">{title} ({items.length})</h4>
          <ul className="list-disc pl-4 space-y-1">
            {items.map((it,i)=><li key={i}>{it.description}</li>)}
          </ul>
          {items.length===0 && <p className="text-gray-400">No issues found.</p>}
        </div>
      </div>
    </div>
  );

  /* --------- cards at top ---------- */
  const cards=[
    {label:'Health Score',value:`${healthData.pageScore.toFixed(0)}/100`,icon:<svg className="w-5 h-5 text-blue-600" fill="none" stroke="currentColor" strokeWidth="2" viewBox="0 0 24 24"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/></svg>},
    {label:'Site Speed',value:healthData.siteSpeed,icon:<svg className="w-5 h-5 text-blue-600" fill="none" stroke="currentColor" strokeWidth="2" viewBox="0 0 24 24"><polyline points="23 6 13.5 15.5 8.5 10.5 1 18"/></svg>},
    {label:'Broken Links',value:healthData.brokenLinks?'Yes':'0',icon:<svg className="w-5 h-5 text-blue-600" fill="none" stroke="currentColor" strokeWidth="2" viewBox="0 0 24 24"><path d="M9 17H7A5 5 0 0 1 7 7h2"/><path d="M15 7h2a5 5 0 0 1 0 10h-2"/><line x1="8" y1="12" x2="16" y2="12"/></svg>},
    {label:'SSL',value:healthData.ssl?'Active':'Inactive',icon:<svg className="w-5 h-5 text-blue-600" fill="none" stroke="currentColor" strokeWidth="2" viewBox="0 0 24 24"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/><path d="m9 12 2 2 4-4"/></svg>}
  ];

  /* --------- speed chart data ---------- */
  const speedData = competitorPerfData.map(r=>({
    name: r.name + (r.isClient?' (You)':''),
    speed: parseFloat(String(r['Site Speed (s)']).replace(' sec.',''))
  }));

  return (
    <PageContent>

      {/* ------- health + errors/warnings ------- */}
      <Card className="mb-8">
        <div className="flex items-center space-x-2 mb-4">
          <h2 className="text-xl font-bold text-gray-800">Website Health</h2>
        </div>

        {/* score gauge + counts */}
        <div className="grid grid-cols-1 lg:grid-cols-4 gap-6">
          {/* Gauge */}
          <div className="flex flex-col items-center">
            <svg className="w-32 h-32">
              <circle className="text-gray-200"  strokeWidth="8" stroke="currentColor" fill="transparent" r="54" cx="64" cy="64"/>
              <circle className="text-green-500" strokeWidth="8" strokeDasharray={2*Math.PI*54}
                      strokeDashoffset={(2*Math.PI*54)*(1-healthData.pageScore/100)}
                      strokeLinecap="round" stroke="currentColor" fill="transparent" r="54" cx="64" cy="64"
                      style={{transform:'rotate(-90deg)',transformOrigin:'50% 50%'}}/>
            </svg>
            <span className="absolute mt-14 text-3xl font-bold">{healthData.pageScore.toFixed(0)}</span>
            <p className="text-gray-600 mt-2 font-semibold">Page Score</p>

            {/* errors / warnings counts */}
            <div className="flex space-x-6 mt-3">
              <HealthCheckItem icon={<svg className="w-5 h-5 text-red-500" fill="none" stroke="currentColor" strokeWidth="2" viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"/><line x1="15" y1="9" x2="9" y2="15"/><line x1="9" y1="9" x2="15" y2="15"/></svg>}
                               color="text-red-500"
                               title="Errors"
                               items={healthData.errors}/>
              <HealthCheckItem icon={<svg className="w-5 h-5 text-yellow-500" fill="none" stroke="currentColor" strokeWidth="2" viewBox="0 0 24 24"><path d="m21.73 18-8-14a2 2 0 0 0-3.46 0l-8 14A2 2 0 0 0 4 21h16a2 2 0 0 0 1.73-3Z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg>}
                               color="text-yellow-500"
                               title="Warnings"
                               items={healthData.warnings}/>
            </div>
          </div>

          {/* stat cards */}
          <div className="lg:col-span-3 grid grid-cols-1 sm:grid-cols-2 gap-6">
            {cards.map(c=><StatCard key={c.label} {...c}/>)}
          </div>
        </div>
      </Card>

      {/* ------- speed bar chart ------- */}
      <Card>
        <h2 className="text-lg font-semibold mb-4">Site Speed (seconds) – you vs competitors</h2>
        <ResponsiveContainer width="100%" height={260}>
          <BarChart data={speedData} margin={{top:10,right:20,left:0,bottom:5}}>
            <CartesianGrid strokeDasharray="3 3"/>
            <XAxis dataKey="name" tick={{fontSize:12}}/>
            <YAxis/>
            <Tooltip/>
            <Bar dataKey="speed" fill="#3b82f6"/>
          </BarChart>
        </ResponsiveContainer>
      </Card>
    </PageContent>
  );
};

const GeogridMaps   = () => <PageContent><h2 className="text-center text-gray-500">Geogrid Maps – TODO</h2></PageContent>;
/* ------------------------------------------------------------------ */
/* KEYWORDS PAGE – full live version                                  */
/* ------------------------------------------------------------------ */
const Keywords = ({ summary, table }) => {
  /* ----- competitor selector state ----- */
  const siteNames   = Object.keys(table);
  const clientName  = siteNames.find(n=>n.toLowerCase().includes('client') || n.toLowerCase().includes('look')) || siteNames[0];
  const [active, setActive] = useState(clientName);

  /* ----- rows for the selected site ----- */
  const rows   = table[active] || [];
  const ROWCAP = 200;       // show up to 200 keywords

  /* ----- summary cards ----- */
  const bucket = [
    {label:'Total', value:summary.totalKeywords},
    {label:'Pos 1', value:summary.pos1},
    {label:'Pos 2-3', value:summary.pos2_3},
    {label:'Pos 4-10', value:summary.pos4_10},
    {label:'Pos 11-20', value:summary.pos11_20},
    {label:'New',  value:summary.isNew,  color:summary.isNew  ?'text-blue-600':''},
    {label:'Up',   value:summary.isUp,   color:summary.isUp   ?'text-green-600':''},
    {label:'Down', value:summary.isDown, color:summary.isDown ?'text-red-600':''},
    {label:'Lost', value:summary.isLost, color:summary.isLost ?'text-red-600':''},
    {label:'ETV',  value:summary.etv.toFixed(2)},
    {label:'Est. Cost', value:'$'+summary.estPaidCost.toFixed(2)}
  ];

  return (
    <PageContent>
      {/* overview cards */}
      <Card className="mb-8">
        <h2 className="text-xl font-bold mb-4">Keyword Overview</h2>
        <div className="grid grid-cols-2 sm:grid-cols-4 md:grid-cols-6 lg:grid-cols-8 gap-4">
          {bucket.map(c=>(
            <div key={c.label} className="text-center">
              <p className={`text-xl font-bold ${c.color||'text-gray-800'}`}>{c.value}</p>
              <p className="text-xs text-gray-500">{c.label}</p>
            </div>
          ))}
        </div>
      </Card>

      {/* competitor pills */}
      <div className="flex flex-wrap gap-2 mb-4">
        {siteNames.map(n=>(
          <button key={n}
                  onClick={()=>setActive(n)}
                  className={`px-3 py-1 rounded-full text-sm border
                    ${active===n
                      ?'bg-blue-600 text-white border-blue-600'
                      :'bg-white text-gray-600 hover:bg-gray-100'}`}>
            {n}
          </button>
        ))}
      </div>

      {/* keyword table */}
      <Card className="overflow-x-auto">
        <table className="min-w-[880px] text-sm">
          <thead className="text-left border-b">
            <tr>
              <th className="py-2 pr-4">Keyword</th>
              <th className="py-2 pr-2">Rank</th>
              <th className="py-2 pr-2">Prev</th>
              <th className="py-2 pr-2">Δ</th>
              <th className="py-2 pr-2">Vol</th>
              <th className="py-2 pr-2">CPC</th>
              <th className="py-2 pr-2">Intent</th>
            </tr>
          </thead>
          <tbody>
            {rows.slice(0,ROWCAP).map((r,i)=>{
              const delta = r.rank_prev==='' ? null : r.rank_prev - r.rank_now;
              return (
                <tr key={i} className="border-b last:border-0">
                  <td className="py-1 pr-4 whitespace-nowrap">{r.keyword}</td>
                  <td className="py-1 pr-2">{r.rank_now}</td>
                  <td className="py-1 pr-2">{r.rank_prev || '–'}</td>
                  <td className="py-1 pr-2">
                    {r.is_new  && <Star          className="w-4 h-4 text-blue-500 inline"/>}
                    {r.is_lost && <AlertTriangle className="w-4 h-4 text-red-500  inline"/>}
                    {delta>0   && <ArrowUp       className="w-4 h-4 text-green-500 inline"/>}
                    {delta<0   && <ArrowDown     className="w-4 h-4 text-red-500   inline"/>}
                  </td>
                  <td className="py-1 pr-2">{r.search_vol}</td>
                  <td className="py-1 pr-2">${Number(r.cpc_usd).toFixed(2)}</td>
                  <td className="py-1 pr-2">{r.intent}</td>
                </tr>
              );
            })}
          </tbody>
        </table>
        {rows.length>ROWCAP &&
          <p className="text-xs text-gray-400 mt-2">
            Showing first {ROWCAP} of {rows.length} rows.
          </p>}
      </Card>
    </PageContent>
  );
};

const Backlinks     = () => <PageContent><h2 className="text-center text-gray-500">Backlinks – TODO</h2></PageContent>;
const ToolsPage     = () => <PageContent><h2 className="text-center text-gray-500">Tools – coming soon</h2></PageContent>;

/* ------------------------------------------------------------------ */
/* HEADER                                                             */
/* ------------------------------------------------------------------ */
const Header = ({active,setActive}) => {
  const tabs=['Dashboard','Website Stats','Geogrid Maps','Keywords','Backlinks','Tools'];
  return (
    <header className="bg-white shadow-sm sticky top-0 z-20">
      <nav className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
        <div className="flex items-center justify-between h-16">
          <div className="flex items-center">
            <svg className="h-8 w-8" viewBox="0 0 24 24" fill="none"
                 stroke="url(#lg)" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
              <defs>
                <linearGradient id="lg" x1="0%" y1="0%" x2="100%" y2="0%">
                  <stop offset="0%" stopColor="#3b82f6"/><stop offset="100%" stopColor="#ec4899"/>
                </linearGradient>
              </defs>
              <path d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"/>
            </svg>
            <h1 className="text-xl font-bold ml-3 bg-gradient-to-r from-blue-500 to-pink-500 bg-clip-text text-transparent">
              MedSpa SEO
            </h1>
          </div>
          <div className="hidden md:block">
            <div className="ml-10 flex space-x-4">
              {tabs.map(t=>(
                <button key={t}
                        onClick={()=>setActive(t)}
                        className={`px-3 py-2 rounded-md text-sm font-medium
                          ${active===t?'bg-blue-600 text-white':'text-gray-500 hover:bg-gray-100 hover:text-gray-900'}`}>
                  {t}
                </button>
              ))}
            </div>
          </div>
        </div>
      </nav>
    </header>
  );
};

/* ------------------------------------------------------------------ */
/* MAIN APP – fetches data, routes tabs                               */
/* ------------------------------------------------------------------ */
const App = () => {
  const [tab,setTab]   = useState('Dashboard');
  const [data,setData] = useState(null);
  const [err,setErr]   = useState(null);
  const [load,setLoad] = useState(true);

  useEffect(()=>{
    const id=new URLSearchParams(location.search).get('workbookId');
    if(!id){setErr('Add ?workbookId=YOUR_ID to the URL');setLoad(false);return;}
    fetch(`https://script.google.com/macros/s/AKfycbxfOMp8d_eCVH4lFD0PNuFU1wH-gyWOwRt2EuME7GQJ4U73ZwpPDciohDH3C566YLWq/exec?workbookId=${id}`)
      .then(r=>r.json())
      .then(j=>{if(j.error) throw new Error(j.error); setData(j); setLoad(false);})
      .catch(e=>{console.error(e); setErr(e.message); setLoad(false);});
  },[]);

  /* routing */
  let body;
  if(load)          body=<PageContent><div className="p-8 text-center text-gray-500">Loading data…</div></PageContent>;
  else if(err)      body=<PageContent><div className="p-8 text-center text-red-500">{err}</div></PageContent>;
  else switch(tab){
    case 'Dashboard':      body=<Dashboard data={data.dashboard}/>;break;
    case 'Website Stats':  body={<WebsiteStats  data={data.websiteStats}/>};break;     // TODO replace placeholder
    case 'Geogrid Maps':   body={<GeogridMaps   data={data.geogridData}/>};break;      // TODO replace placeholder
    case 'Keywords':       body={<Keywords      summary={data.keywordsSummary} table={data.keywordsTable}/>};break; // TODO replace placeholder
    case 'Backlinks':      body={<Backlinks     data={data.backlinksSummary} table={data.backlinksTable}/>};break; // TODO replace placeholder
    default:               body=<ToolsPage/>;
  }

  return (
    <div className="min-h-screen bg-gray-50 font-sans">
      <Header active={tab} setActive={setTab}/>
      {body}
    </div>
  );
};

ReactDOM.createRoot(document.getElementById('root')).render(<App/>);
</script>
</body>
</html>
