<!DOCTYPE html>
<!--
  MedSpa SEO Dashboard - Application Overview

  This file, `index.html`, serves as the front-end for the MedSpa SEO tracking dashboard.
  It is built using vanilla HTML, Tailwind CSS for styling, and React (via CDN) for dynamic components.

  Application Architecture:

  The dashboard's data is sourced from a two-workbook system hosted on Google Sheets, each managed by its own Google App Script. This architecture separates client-specific data from general service data.

  1. Client Workbook:
     - A new, unique Google Sheet (workbook) is created for each individual client.
     - This workbook contains all client-specific data, such as website stats, GBP info, keyword rankings, backlink profiles, geogrid maps, and competitor data.
     - It is managed by the `Client Workbook App Script v2.gs`.
     - The dashboard identifies and fetches data from the correct client workbook by reading the `workbookId` from the URL query parameter (e.g., ?workbookId=YOUR_ID).

  2. Services Workbook:
     - A single, shared Google Sheet that contains trend data for MedSpa services (e.g., search volume, competition).
     - This data populates the "Services by Search Volume" and "New Services by Search Volume" cards on the dashboard.
     - It is managed by the `Service Cards (Dashboard) App Script v2.gs`.
     - The script for this workbook is called with a geographic location parameter to fetch relevant data.

  This setup ensures that each client's sensitive data is isolated in its own workbook, while still allowing the dashboard to display general industry trends from a centralized source.
-->
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1.0"/>
  <title>MedSpa SEO Dashboard</title>
  
  <!-- Custom favicon matching header icon -->
  <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%23000' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'><defs><linearGradient id='favicon-gradient' x1='0%25' y1='0%25' x2='100%25' y2='0%25'><stop offset='0%25' stop-color='%233b82f6'/><stop offset='100%25' stop-color='%23ec4899'/></linearGradient></defs><path d='M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z' stroke='url(%23favicon-gradient)'/></svg>">

  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Inter font -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet"/>

  <style>
    body { font-family:'Inter',sans-serif }
    .loader-container {display:flex;flex-direction:column;justify-content:center;align-items:center;height:100vh}
    .loader {border:4px solid #f3f3f3;border-top:4px solid #3498db;border-radius:50%;width:40px;height:40px;animation:spin 1s linear infinite}
    @keyframes spin {0%{transform:rotate(0deg)}100%{transform:rotate(360deg)}}

    /* Day/Night Toggle Switch Styles */
    .day-night-switch {
      position: relative;
      width: 80px;
      height: 40px;
      border-radius: 8px;
      overflow: hidden;
      border: 1px solid #e5e7eb;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      cursor: pointer;
      transition: all 0.7s ease;
    }

    .day-night-switch.day {
      background: linear-gradient(to bottom, #87CEEB, #E0F7FA);
    }

    .day-night-switch.night {
      background: linear-gradient(to bottom, #0F2027, #203A43, #2C5364);
    }

    .switch-slider {
      position: absolute;
      top: 2px;
      left: 2px;
      width: 24px;
      height: 24px;
      background: white;
      border-radius: 4px;
      border: 1px solid #d1d5db;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
      transition: transform 0.5s cubic-bezier(0.16, 1, 0.3, 1);
      z-index: 10;
    }

    .day-night-switch.night .switch-slider {
      transform: translateX(40px);
    }

    .sun {
      position: absolute;
      width: 24px;
      height: 24px;
      background: #fbbf24;
      border-radius: 50%;
      left: 20px;
      top: 50%;
      transform: translateY(-50%);
      transition: all 0.7s ease;
      opacity: 1;
    }

    .day-night-switch.night .sun {
      transform: translateY(60px);
      opacity: 0;
    }

    .sun-rays {
      position: absolute;
      width: 100%;
      height: 100%;
    }

    .sun-ray {
      position: absolute;
      width: 2px;
      height: 8px;
      background: #f59e0b;
      left: 50%;
      top: 50%;
      transform-origin: 0 0;
      border-radius: 1px;
    }

    .sun-ray:nth-child(1) { transform: rotate(0deg) translate(-50%, -50%) translate(14px, 0); }
    .sun-ray:nth-child(2) { transform: rotate(45deg) translate(-50%, -50%) translate(14px, 0); }
    .sun-ray:nth-child(3) { transform: rotate(90deg) translate(-50%, -50%) translate(14px, 0); }
    .sun-ray:nth-child(4) { transform: rotate(135deg) translate(-50%, -50%) translate(14px, 0); }
    .sun-ray:nth-child(5) { transform: rotate(180deg) translate(-50%, -50%) translate(14px, 0); }
    .sun-ray:nth-child(6) { transform: rotate(225deg) translate(-50%, -50%) translate(14px, 0); }
    .sun-ray:nth-child(7) { transform: rotate(270deg) translate(-50%, -50%) translate(14px, 0); }
    .sun-ray:nth-child(8) { transform: rotate(315deg) translate(-50%, -50%) translate(14px, 0); }

    .moon {
      position: absolute;
      width: 20px;
      height: 20px;
      left: 60px;
      top: 50%;
      transform: translateY(-50%) translateY(-30px);
      opacity: 0;
      transition: all 0.7s ease 0.5s;
    }

    .day-night-switch.night .moon {
      transform: translateY(-50%);
      opacity: 1;
    }

    .moon-shape {
      position: relative;
      width: 100%;
      height: 100%;
      background: #f3f4f6;
      border-radius: 50%;
    }

    .moon-crater {
      position: absolute;
      background: #0F2027;
      border-radius: 50%;
      width: 90%;
      height: 90%;
      top: -10%;
      left: -25%;
    }

    .clouds {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      opacity: 0.9;
      transition: opacity 0.5s ease;
    }

    .day-night-switch.night .clouds {
      opacity: 0;
    }

    .cloud {
      position: absolute;
      background: white;
      border-radius: 50px;
    }

    .cloud-1 {
      width: 32px;
      height: 12px;
      left: 48px;
      top: 12px;
    }

    .cloud-2 {
      width: 24px;
      height: 10px;
      left: 56px;
      top: 24px;
      opacity: 0.8;
    }

    .stars {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
    }

    .star {
      position: absolute;
      width: 2px;
      height: 2px;
      background: white;
      border-radius: 50%;
      box-shadow: 0 0 4px 2px rgba(255, 255, 255, 0.4);
      opacity: 0;
      transform: scale(0);
      transition: all 0.8s ease;
    }

    .day-night-switch.night .star {
      opacity: 0.8;
      transform: scale(1);
    }

    .star:nth-child(1) { left: 8px; top: 8px; transition-delay: 0.7s; }
    .star:nth-child(2) { left: 16px; top: 20px; transition-delay: 0.82s; }
    .star:nth-child(3) { left: 24px; top: 12px; transition-delay: 0.94s; }
    .star:nth-child(4) { left: 32px; top: 24px; transition-delay: 1.06s; }
    .star:nth-child(5) { left: 40px; top: 8px; transition-delay: 1.18s; }
    .star:nth-child(6) { left: 48px; top: 28px; transition-delay: 1.3s; }
    .star:nth-child(7) { left: 56px; top: 16px; transition-delay: 1.42s; }
    .star:nth-child(8) { left: 64px; top: 32px; transition-delay: 1.54s; }

    /* Dark Mode Theme Variables */
    :root {
      /* Light mode colors */
      --bg-primary: #f9fafb;
      --bg-secondary: #ffffff;
      --bg-tertiary: #f3f4f6;
      --text-primary: #111827;
      --text-secondary: #6b7280;
      --text-tertiary: #9ca3af;
      --border-primary: #e5e7eb;
      --border-secondary: #d1d5db;
      --shadow-light: rgba(0, 0, 0, 0.1);
      --shadow-medium: rgba(0, 0, 0, 0.15);
      --shadow-heavy: rgba(0, 0, 0, 0.25);
      
      /* Card backgrounds */
      --card-bg: #ffffff;
      --card-border: #e5e7eb;
      --card-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
      
      /* Header colors */
      --header-bg: #ffffff;
      --header-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
      
      /* Button colors */
      --btn-secondary-bg: #f3f4f6;
      --btn-secondary-hover: #e5e7eb;
      --btn-secondary-text: #374151;
      
      /* Input colors */
      --input-bg: #ffffff;
      --input-border: #d1d5db;
      --input-focus: #3b82f6;
      
      /* Gradient backgrounds */
      --gradient-blue: linear-gradient(to right, #dbeafe, #e0e7ff);
      --gradient-slate: linear-gradient(to right, #f8fafc, #e2e8f0);
      --gradient-green: linear-gradient(to right, #dcfce7, #bbf7d0);
      
      /* Keywords bar colors */
      --keywords-bar-bg: linear-gradient(to right, #dcfce7, #bbf7d0);
      --keywords-bar-border: #bbf7d0;
    }

    [data-theme="dark"] {
      /* Dark mode colors */
      --bg-primary: #0f172a;
      --bg-secondary: #1e293b;
      --bg-tertiary: #334155;
      --text-primary: #f1f5f9;
      --text-secondary: #cbd5e1;
      --text-tertiary: #94a3b8;
      --border-primary: #334155;
      --border-secondary: #475569;
      --shadow-light: rgba(0, 0, 0, 0.3);
      --shadow-medium: rgba(0, 0, 0, 0.4);
      --shadow-heavy: rgba(0, 0, 0, 0.6);
      
      /* Card backgrounds */
      --card-bg: #1e293b;
      --card-border: #334155;
      --card-shadow: 0 1px 3px rgba(0, 0, 0, 0.3);
      
      /* Header colors */
      --header-bg: #1e293b;
      --header-shadow: 0 1px 2px rgba(0, 0, 0, 0.3);
      
      /* Button colors */
      --btn-secondary-bg: #334155;
      --btn-secondary-hover: #475569;
      --btn-secondary-text: #e2e8f0;
      
      /* Input colors */
      --input-bg: #334155;
      --input-border: #475569;
      --input-focus: #60a5fa;
      
      /* Gradient backgrounds */
      --gradient-blue: linear-gradient(to right, #1e40af, #3730a3);
      --gradient-slate: linear-gradient(to right, #334155, #475569);
      --gradient-green: linear-gradient(to right, #166534, #15803d);
      
      /* Keywords bar colors - more subtle for dark mode */
      --keywords-bar-bg: linear-gradient(to right, #0f3f3c, #134e4a);
      --keywords-bar-border: #0f766e;
    }

         /* Apply theme variables to base elements */
     body {
       background-color: var(--bg-primary);
       color: var(--text-primary);
       transition: background-color 0.3s ease, color 0.3s ease;
     }

     /* Dark mode text and heading styles */
     [data-theme="dark"] .text-gray-800 { color: var(--text-primary) !important; }
     [data-theme="dark"] .text-gray-900 { color: var(--text-primary) !important; }
     [data-theme="dark"] .text-gray-700 { color: var(--text-secondary) !important; }
     [data-theme="dark"] .text-gray-600 { color: var(--text-secondary) !important; }
     [data-theme="dark"] .text-gray-500 { color: var(--text-tertiary) !important; }
     [data-theme="dark"] .text-gray-400 { color: var(--text-tertiary) !important; }

     /* Dark mode background overrides */
     [data-theme="dark"] .bg-white { background-color: var(--card-bg) !important; }
     [data-theme="dark"] .bg-gray-50 { background-color: var(--bg-tertiary) !important; }
     [data-theme="dark"] .bg-gray-100 { background-color: var(--btn-secondary-bg) !important; }
     [data-theme="dark"] .bg-gray-200 { background-color: var(--btn-secondary-hover) !important; }

     /* Dark mode border overrides */
     [data-theme="dark"] .border-gray-100 { border-color: var(--border-primary) !important; }
     [data-theme="dark"] .border-gray-200 { border-color: var(--border-secondary) !important; }
     [data-theme="dark"] .border-gray-300 { border-color: var(--border-secondary) !important; }

     /* Ensure all summary stat containers have visible borders in dark mode */
     [data-theme="dark"] .space-y-3 > div,
     [data-theme="dark"] .space-y-6 > div {
       border: 1px solid var(--border-primary) !important;
       border-radius: 0.75rem;
       background-color: var(--card-bg) !important;
     }

     /* Dark mode input styles */
     [data-theme="dark"] input[type="text"],
     [data-theme="dark"] input[type="search"] {
       background-color: var(--input-bg) !important;
       border-color: var(--input-border) !important;
       color: var(--text-primary) !important;
     }

     [data-theme="dark"] input[type="text"]:focus,
     [data-theme="dark"] input[type="search"]:focus {
       border-color: var(--input-focus) !important;
       box-shadow: 0 0 0 3px rgba(96, 165, 250, 0.1) !important;
     }

     [data-theme="dark"] input::placeholder {
       color: var(--text-tertiary) !important;
     }

     /* Dark mode table styles */
     [data-theme="dark"] table {
       color: var(--text-primary);
     }

     [data-theme="dark"] thead {
       background-color: var(--bg-tertiary) !important;
     }

     [data-theme="dark"] th {
       color: var(--text-primary) !important;
       border-color: var(--border-secondary) !important;
     }

     [data-theme="dark"] td {
       color: var(--text-secondary) !important;
       border-color: var(--border-primary) !important;
     }

     /* Dark mode button styles */
     [data-theme="dark"] .hover\\:bg-gray-100:hover {
       background-color: var(--btn-secondary-hover) !important;
     }

     [data-theme="dark"] .hover\\:bg-gray-200:hover {
       background-color: var(--border-secondary) !important;
     }

     /* Dark mode gradient overrides */
     [data-theme="dark"] .bg-gradient-to-r.from-blue-50.to-indigo-50 {
       background: var(--gradient-blue) !important;
     }

     [data-theme="dark"] .bg-gradient-to-r.from-slate-50.to-blue-50 {
       background: var(--gradient-slate) !important;
     }

     [data-theme="dark"] .bg-gradient-to-r.from-gray-50.to-slate-100 {
       background: var(--gradient-slate) !important;
     }

     /* Dark mode shadow overrides */
     [data-theme="dark"] .shadow-sm { box-shadow: var(--card-shadow) !important; }
     [data-theme="dark"] .shadow-md { box-shadow: 0 4px 6px var(--shadow-light) !important; }
     [data-theme="dark"] .shadow-lg { box-shadow: 0 10px 15px var(--shadow-medium) !important; }
     [data-theme="dark"] .shadow-xl { box-shadow: 0 20px 25px var(--shadow-heavy) !important; }

     /* Dark mode specific component styles */
     [data-theme="dark"] .bg-slate-100 { 
       background-color: var(--bg-tertiary) !important; 
       color: var(--text-primary) !important;
     }

     /* Dark mode tab button styles */
     [data-theme="dark"] .bg-blue-100 { 
       background-color: rgba(59, 130, 246, 0.2) !important; 
       color: #60a5fa !important;
     }

     [data-theme="dark"] .text-blue-800 { 
       color: #60a5fa !important; 
     }

     /* Dark mode rounded containers */
     [data-theme="dark"] .rounded-xl,
     [data-theme="dark"] .rounded-lg {
       background-color: var(--card-bg);
       border-color: var(--border-primary);
     }

     /* Dark mode search icon */
     [data-theme="dark"] .text-gray-400 {
       color: var(--text-tertiary) !important;
     }

     /* Dark mode hover states for navigation */
     [data-theme="dark"] .hover\\:text-gray-900:hover {
       color: var(--text-primary) !important;
     }

     /* Dark mode for specific metric text colors */
     [data-theme="dark"] .text-blue-600 {
       color: #60a5fa !important;
     }

     [data-theme="dark"] .text-green-600 {
       color: #34d399 !important;
     }

     [data-theme="dark"] .text-red-600 {
       color: #f87171 !important;
     }

     [data-theme="dark"] .text-yellow-600 {
       color: #fbbf24 !important;
     }

     [data-theme="dark"] .text-orange-600 {
       color: #fb923c !important;
     }

     /* Ensure metric containers have proper backgrounds */
     [data-theme="dark"] .bg-gradient-to-r.from-green-50.to-emerald-50 {
       background: var(--keywords-bar-bg) !important;
       border-color: var(--keywords-bar-border) !important;
     }

     [data-theme="dark"] .border-green-200 {
       border-color: rgba(34, 197, 94, 0.3) !important;
     }

     /* Dark mode link and hover styles */
     [data-theme="dark"] a {
       color: #60a5fa !important;
     }

     [data-theme="dark"] a:hover {
       color: #93c5fd !important;
       text-decoration: underline;
     }

     /* Dark mode table row hover - subtle background change */
     [data-theme="dark"] tbody tr:hover {
       background-color: rgba(59, 130, 246, 0.05) !important;
     }

     [data-theme="dark"] tbody tr:hover td {
       color: var(--text-primary) !important;
     }

     /* Dark mode button hover improvements */
     [data-theme="dark"] button:hover {
       background-color: var(--btn-secondary-hover) !important;
       color: var(--text-primary) !important;
     }

     /* Specific styling for tab buttons in dark mode */
     [data-theme="dark"] .space-x-1 button {
       background-color: var(--bg-tertiary) !important;
       color: var(--text-secondary) !important;
       border: 1px solid var(--border-primary) !important;
     }

     [data-theme="dark"] .space-x-1 button:hover {
       background-color: var(--btn-secondary-hover) !important;
       color: var(--text-primary) !important;
     }

     /* Dark mode SummaryStat component styling */
     [data-theme="dark"] .bg-slate-50 {
       background-color: var(--bg-tertiary) !important;
       border: 1px solid var(--border-primary) !important;
     }

     [data-theme="dark"] .hover\\:bg-white:hover {
       background-color: var(--btn-secondary-hover) !important;
     }

     /* Ensure all summary containers have proper dark mode styling */
     [data-theme="dark"] .space-y-3 > div,
     [data-theme="dark"] .space-y-6 > div {
       background-color: var(--bg-tertiary) !important;
       border: 1px solid var(--border-primary) !important;
       color: var(--text-primary) !important;
     }

     /* Dark mode for metric cards in summary sections */
     [data-theme="dark"] .p-6.bg-slate-100 {
       background-color: var(--bg-tertiary) !important;
       border: 1px solid var(--border-primary) !important;
       color: var(--text-primary) !important;
     }



     /* Geogrid client color fix for dark mode */
     [data-theme="dark"] .text-blue-900 {
       color: #60a5fa !important;
     }

     /* Fix geogrid client white text in dark mode - specifically for star icons */
     [data-theme="dark"] .text-white.font-bold {
       color: #60a5fa !important;
     }

     /* AI Report and client highlights fix for dark mode */
     [data-theme="dark"] .bg-blue-50 {
       background-color: rgba(59, 130, 246, 0.1) !important;
     }

     [data-theme="dark"] .bg-blue-50\/50 {
       background-color: rgba(59, 130, 246, 0.05) !important;
     }

     [data-theme="dark"] .hover\\:bg-blue-100\/50:hover {
       background-color: rgba(59, 130, 246, 0.1) !important;
     }

     /* Remove white highlight effect in dark mode */
     [data-theme="dark"] .bg-gradient-to-b.from-transparent.to-white {
       background: transparent !important;
     }

     /* AI report gradient fix for dark mode */
     [data-theme="dark"] .bg-gradient-to-t.from-white.to-transparent {
       background: linear-gradient(to top, var(--card-bg), transparent) !important;
     }

     /* Tooltip specific hover behavior */
    .info-tooltip-trigger:hover + .info-tooltip-content {
      opacity: 1;
    }
    
    /* Map scroll zoom prevention */
    .map-container {
      position: relative;
    }
    
    /* Disable pointer events by default to prevent scroll zoom */
    .map-iframe {
      pointer-events: none;
    }
    
    /* Enable pointer events only when clicked/active */
    .map-container:active .map-iframe {
      pointer-events: auto;
    }
    
    /* Add a subtle overlay to indicate click-to-interact */
    .map-container::before {
      content: 'Click to interact with map';
      position: absolute;
      top: 10px;
      left: 50px;
      background: rgba(0, 0, 0, 0.7);
      color: white;
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 12px;
      z-index: 10;
      opacity: 0;
      transition: opacity 0.3s ease;
    }
    
    .map-container:hover::before {
      opacity: 1;
    }
    
    .map-container:active::before {
      opacity: 0;
    }
  </style>
  
  <!-- Non-critical CSS loaded after page load -->
  <style id="non-critical-css">
    /* Tooltip specific hover behavior */
    .info-tooltip-trigger:hover + .info-tooltip-content {
      opacity: 1;
    }
    
    /* Map scroll zoom prevention */
    .map-container {
      position: relative;
    }
    
    /* Disable pointer events by default to prevent scroll zoom */
    .map-iframe {
      pointer-events: none;
    }
    
    /* Enable pointer events when clicked or after first click */
    .map-container.active .map-iframe,
    .map-container:active .map-iframe {
      pointer-events: auto;
    }
    
    /* Prevent hover effects from interfering with map interaction */
    .map-container:hover {
      transform: none !important;
      scale: none !important;
    }
    
    /* Add a subtle overlay to indicate click-to-interact */
    .map-container::before {
      content: 'Click to interact with map';
      position: absolute;
      top: 10px;
      left: 50px;
      background: rgba(0, 0, 0, 0.7);
      color: white;
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 12px;
      z-index: 10;
      opacity: 0;
      transition: opacity 0.3s ease;
    }
    
    .map-container:hover::before {
      opacity: 1;
    }
    
    .map-container:active::before {
      opacity: 0;
    }
  </style>

  <!-- Preconnect to CDNs for faster loading -->
  <link rel="preconnect" href="https://unpkg.com" crossorigin>
  <link rel="dns-prefetch" href="https://unpkg.com">
  
  <!-- React / Babel / Recharts with optimized loading -->
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone@7.23.1/babel.min.js"></script>
  <script src="https://unpkg.com/prop-types@15/prop-types.min.js"></script>
  
  <!-- Recharts - using older stable version -->
  <script src="https://unpkg.com/recharts@1.8.5/umd/Recharts.js"></script>
</head>

<body class="bg-gray-50">
  <div id="root">
    <div class="loader-container">
      <div class="loader"></div>
      <p class="text-gray-500 mt-4">Loading application…</p>
      <div class="mt-6 text-xs text-gray-400">
        <div id="load-progress">Initializing...</div>
      </div>
    </div>
  </div>

<script type="text/babel">
/* ------------------------------------------------------------------ */
/* shared helpers / icons / generic components                        */
/* ------------------------------------------------------------------ */
const {useState, useEffect, useRef, useMemo} = React;

// --- Helper function to fetch data with CORS workaround and caching ---
const fetchWithCorsWorkaround = (url, callback) => {
    // Check cache first (5 minute cache)
    const cacheKey = `seo_data_${url}`;
    const cached = sessionStorage.getItem(cacheKey);
    if (cached) {
        const { data, timestamp } = JSON.parse(cached);
        if (Date.now() - timestamp < 5 * 60 * 1000) { // 5 minutes
            console.log('📦 Using cached data');
            callback(null, data);
            return;
        }
    }
    
    // Try regular fetch first
    fetch(url, {
        method: 'GET',
        mode: 'cors'
    })
    .then(response => response.json())
    .then(data => {
        // Cache the response
        sessionStorage.setItem(cacheKey, JSON.stringify({
            data,
            timestamp: Date.now()
        }));
        callback(null, data);
    })
    .catch(err => {
        console.log('Regular fetch failed, trying JSONP approach...');
        // Fallback to JSONP-style request
        const script = document.createElement('script');
        const callbackName = 'jsonpCallback_' + Math.random().toString(36).substr(2, 9);
        window[callbackName] = (data) => {
            // Cache the response
            sessionStorage.setItem(cacheKey, JSON.stringify({
                data,
                timestamp: Date.now()
            }));
            callback(null, data);
            document.head.removeChild(script);
            delete window[callbackName];
        };
        script.src = `${url}&callback=${callbackName}`;
        script.onerror = () => {
            callback(new Error('Failed to load data'), null);
            document.head.removeChild(script);
            delete window[callbackName];
        };
        document.head.appendChild(script);
    });
};

    // --- Map URL Processing for Better Centering ---
    const processMapUrlForCentering = (mapUrl) => {
        if (!mapUrl) return mapUrl;
        
        try {
            // For Google Maps embed URLs, we can add parameters to improve centering
            if (mapUrl.includes('google.com/maps/embed')) {
                let processedUrl = mapUrl;
                
                // Add zoom parameter if not present - 12 is good for local area with multiple pins
                if (!processedUrl.includes('z=') && !processedUrl.includes('zoom=')) {
                    processedUrl += processedUrl.includes('?') ? '&z=12' : '?z=12';
                }
                
                // Add output parameter to ensure proper embedding
                if (!processedUrl.includes('output=embed')) {
                    processedUrl += processedUrl.includes('?') ? '&output=embed' : '?output=embed';
                }
                
                return processedUrl;
            }
            
            // For other map services, return as-is
            return mapUrl;
        } catch (error) {
            console.warn('Error processing map URL:', error);
            return mapUrl;
        }
    };

    // Handle map interaction
    const handleMapClick = (event) => {
        const mapContainer = event.currentTarget;
        mapContainer.classList.add('active');
        
        // Remove active class after 30 seconds of inactivity
        setTimeout(() => {
            mapContainer.classList.remove('active');
        }, 30000);
    };

/* ------------------------------------------------------------------ */
/* helpers  – icon factory  +  shared icons                           */
/* ------------------------------------------------------------------ */
const createIcon = path => props => (
  <svg
    xmlns="http://www.w3.org/2000/svg"
    width="24"
    height="24"
    viewBox="0 0 24 24"
    fill="none"
    stroke="currentColor"
    strokeWidth="2"
    strokeLinecap="round"
    strokeLinejoin="round"
    {...props}
  >
    {path}
  </svg>
);

/* reusable icons --------------------------------------------------- */
const Info = createIcon(
  <>
    <circle cx="12" cy="12" r="10" />
    <line  x1="12" y1="16" x2="12" y2="12" />
    <line  x1="12" y1="8"  x2="12.01" y2="8" />
  </>
);

const AlertTriangle = createIcon(
  <>
    <path d="m21.73 18-8-14a2 2 0 0 0-3.46 0l-8 14A2 2 0 0 0 4 21h16a2 2 0 0 0 1.73-3Z" />
    <line x1="12" y1="9"  x2="12" y2="13" />
    <line x1="12" y1="17" x2="12.01" y2="17" />
  </>
);

const Star = createIcon(
  <polygon points="12 2 15 8.5 22 9.3 17 14 18.3 21 12 17.7 5.7 21 7 14 2 9.3 9 8.5 12 2" />
);

const ArrowUp = createIcon(
  <>
    <line x1="12" y1="19" x2="12" y2="5" />
    <polyline points="5 12 12 5 19 12" />
  </>
);

const ArrowDown = createIcon(
  <>
    <line x1="12" y1="5"  x2="12" y2="19" />
    <polyline points="19 12 12 19 5 12" />
  </>
);

const CheckCircle  = createIcon(
  <>
    <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14" />
    <polyline points="22 4 12 14.01 9 11.01" />
  </>
);
const XCircle = createIcon(
  <>
    <circle cx="12" cy="12" r="10" />
    <line x1="15" y1="9" x2="9" y2="15" />
    <line x1="9" y1="9" x2="15" y2="15" />
  </>
);
const TrendingUp = createIcon(<polyline points="23 6 13.5 15.5 8.5 10.5 1 18" />);
const Link2 = createIcon(
  <>
    <path d="M9 17H7A5 5 0 0 1 7 7h2" />
    <path d="M15 7h2a5 5 0 0 1 0 10h-2" />
    <line x1="8" y1="12" x2="16" y2="12" />
  </>
);
const ShieldCheck = createIcon(
  <>
    <path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z" />
    <path d="m9 12 2 2 4-4" />
  </>
);

const CalendarIcon = createIcon(
    <React.Fragment>
        <rect x="3" y="4" width="18" height="18" rx="2" ry="2" />
        <line x1="16" y1="2" x2="16" y2="6" />
        <line x1="8" y1="2" x2="8" y2="6" />
        <line x1="3" y1="10" x2="21" y2="10" />
    </React.Fragment>
);

/* --- generic wrappers --- */
const Card        = ({children,className=''}) => (
  <div className={`rounded-xl p-6 ${className}`} style={{ backgroundColor: 'var(--card-bg)', border: '1px solid var(--card-border)', boxShadow: 'var(--card-shadow)' }}>{children}</div>);
const PageContent = ({children}) => (
  <main className="flex-1 p-4 sm:p-6 lg:p-8">{children}</main>);

// --- Reusable Components ---
const InfoTooltip = ({ text }) => (
    <div className="relative flex items-center group/tooltip">
        <Info className="w-4 h-4 text-gray-400" />
        <div className="absolute left-1/2 -translate-x-1/2 bottom-full mb-2 w-64 p-3 bg-gray-800 text-white text-xs rounded-lg shadow-lg opacity-0 group-hover/tooltip:opacity-100 transition-opacity duration-300 z-30 pointer-events-none">
            {text}
            <svg className="absolute text-gray-800 h-2 w-full left-0 top-full" x="0px" y="0px" viewBox="0 0 255 255"><polygon className="fill-current" points="0,0 127.5,127.5 255,0"/></svg>
        </div>
    </div>
);

/* ------------------------------------------------------------------ */
/* PLACEHOLDER PAGES – replace each later with real JSX               */
/* ------------------------------------------------------------------ */

/* ------------------------------------------------------------------ */
/* AI Report Section (used on multiple pages)                         */
/* ------------------------------------------------------------------ */
const AIReportSection = ({ reportText, title = "SWOT Analysis" }) => {
    const [isExpanded, setIsExpanded] = useState(false);
    const [copySuccess, setCopySuccess] = useState(false);
    
    console.log('AIReportSection received reportText:', reportText);
    console.log('Type of reportText:', typeof reportText);
    
    // More robust type checking and conversion
    let formattedText = '';
    try {
        if (!reportText) {
            console.log('reportText is empty');
            return null;
        }
        
        // Convert to string if it's not already a string
        formattedText = String(reportText).trim();
        console.log('Converted formattedText:', formattedText);
        
        if (!formattedText) {
            console.log('formattedText is empty after trimming');
            return null;
        }
    } catch (error) {
        console.error('Error processing reportText:', error);
        return null;
    }

    const ChevronDown = createIcon(<polyline points="6 9 12 15 18 9" />);
    const ChevronUp = createIcon(<polyline points="18 15 12 9 6 15" />);
    const Copy = createIcon(
        <>
            <rect x="9" y="9" width="13" height="13" rx="2" ry="2" />
            <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1" />
        </>
    );
    const Check = createIcon(<polyline points="20 6 9 17 4 12" />);

    const handleCopyReport = async () => {
        try {
            // Get plain text version of the report
            const plainText = formattedText
                .replace(/<br\s*\/?>/gi, '\n')
                .replace(/<strong>(.*?)<\/strong>/gi, '**$1**')
                .replace(/<em>(.*?)<\/em>/gi, '*$1*')
                .replace(/<[^>]*>/g, ''); // Remove any remaining HTML tags
            
            await navigator.clipboard.writeText(plainText);
            setCopySuccess(true);
            setTimeout(() => setCopySuccess(false), 2000);
        } catch (err) {
            console.error('Failed to copy text: ', err);
        }
    };

    return (
                        <Card className="mt-8 group hover:shadow-xl transition-all duration-300 hover:-translate-y-0.5 hover:scale-[1.003] hover:border-blue-200/60">
            <div className="flex items-center justify-between mb-1">
                <div className="flex items-center space-x-2">
                    <h2 className="text-xl font-bold text-gray-800">AI Report</h2>
                    <InfoTooltip text="AI-generated analysis of your website's technical health, performance metrics, and competitive positioning." />
                    <button 
                        onClick={() => setIsExpanded(!isExpanded)} 
                        className="text-blue-600 hover:text-blue-800 text-sm font-semibold flex items-center transition-colors"
                    >
                        {isExpanded ? 'Show Less' : 'Show More'}
                        {isExpanded ? <ChevronUp className="w-4 h-4 ml-1" /> : <ChevronDown className="w-4 h-4 ml-1" />}
                    </button>
                </div>
                <div className="flex items-center">
                    <button 
                        onClick={handleCopyReport}
                        className="flex items-center space-x-1 px-3 py-1.5 bg-gray-100 hover:bg-gray-200 text-gray-700 text-sm font-medium rounded-lg transition-colors"
                    >
                        {copySuccess ? (
                            <>
                                <Check className="w-4 h-4 text-green-600" />
                                <span className="text-green-600">Copied!</span>
                            </>
                        ) : (
                            <>
                                <Copy className="w-4 h-4" />
                                <span>Copy Report</span>
                            </>
                        )}
                    </button>
                </div>
            </div>
            <h3 className="text-md font-semibold text-gray-600 mb-3">{title}</h3>
            <div className={`prose prose-sm max-w-none text-gray-600 overflow-hidden relative transition-all duration-300 ${isExpanded ? 'max-h-full' : 'max-h-24'}`}>
                <div 
                    dangerouslySetInnerHTML={{ 
                        __html: formattedText
                            .replace(/\n/g, '<br />')
                            .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                            .replace(/\*(.*?)\*/g, '<em>$1</em>')
                    }} 
                />
                {!isExpanded && (
                    <div className="absolute bottom-0 left-0 w-full h-12 bg-gradient-to-t from-white to-transparent"></div>
                )}
            </div>
        </Card>
    );
};



const Dashboard = ({ setActiveTab }) => {
    const { ResponsiveContainer, BarChart, Bar, XAxis, YAxis, Tooltip, CartesianGrid, Cell, PieChart, Pie, Legend } = window.Recharts;
    
    // --- Additional Icon Components for this page ---
    const ExternalLink = createIcon(
      <>
        <path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6" />
        <polyline points="15 3 21 3 21 9" />
        <line x1="10" y1="14" x2="21" y2="3" />
      </>
    );
    const ChevronDown = createIcon(<polyline points="6 9 12 15 18 9" />);
    const ChevronUp = createIcon(<polyline points="18 15 12 9 6 15" />);

    // --- Reusable Components for this page ---
    const AdIndicator = ({ status, link }) => {
        if (status === 'No Ads Found') {
            return <span className="px-2 py-1 text-xs font-semibold rounded-full bg-red-100 text-red-800">No Ads</span>;
        }
        if (status === '1 Ad Found' || status === 'Multiple Ads Found') {
            return (
                <a href={link} target="_blank" rel="noopener noreferrer" 
                   className="inline-flex items-center px-2 py-1 bg-green-100 text-green-800 text-xs font-semibold rounded-full hover:bg-green-200 transition-colors">
                    {status === '1 Ad Found' ? '1 Ad' : 'Multiple'} <ExternalLink className="w-3 h-3 ml-1.5" />
                </a>
            );
        }
        return <span className="px-2 py-1 text-xs font-semibold rounded-full bg-gray-100 text-gray-800">Unknown</span>;
    };

    // --- Sub-components for Dashboard ---
    const GeogridSection = React.memo(({ setActiveTab }) => {
        const [geogridData, setGeogridData] = useState(null);
        const [loading, setLoading] = useState(true);
        const [error, setError] = useState(null);
        const [dashboardMonthIndex, setDashboardMonthIndex] = useState(0);

        useEffect(() => {
            const params = new URLSearchParams(window.location.search);
            const workbookId = params.get('workbookId');
            if (!workbookId) {
                setError("No workbook ID provided");
                setLoading(false);
                return;
            }

            // Check cache first
            const cacheKey = `geogrid_${workbookId}`;
            const cachedData = sessionStorage.getItem(cacheKey);
            if (cachedData) {
                try {
                    const parsed = JSON.parse(cachedData);
                    const medspaNearMe = parsed['medspa near me'] || [];
                    
                    // Apply same date formatting as fresh data
                    const fixDateFormatting = (monthlyData) => {
                        const parsedDates = monthlyData.map((monthData, index) => {
                            let parsedDate = null;
                            
                            // First try to use the backend's parsedDate if available
                            if (monthData.parsedDate) {
                                parsedDate = new Date(monthData.parsedDate);
                            }
                            
                            // If parsedDate is invalid or not available, try other approaches
                            if (!parsedDate || isNaN(parsedDate.getTime())) {
                                // Try parsing the date field directly
                                if (monthData.date) {
                                    parsedDate = new Date(monthData.date);
                                    
                                    // If that fails, try US date format parsing
                                    if (isNaN(parsedDate.getTime())) {
                                        const dateStr = monthData.date.toString();
                                        const parts = dateStr.split('/');
                                        if (parts.length === 3) {
                                            const month = parseInt(parts[0]) - 1; // Convert to 0-based
                                            const day = parseInt(parts[1]);
                                            const year = parseInt(parts[2]);
                                            parsedDate = new Date(year, month, day);
                                        }
                                    }
                                }
                                
                                // Try parsing rawDate if available
                                if ((!parsedDate || isNaN(parsedDate.getTime())) && monthData.rawDate) {
                                    parsedDate = new Date(monthData.rawDate);
                                    
                                    // If that fails, try US date format parsing on rawDate
                                    if (isNaN(parsedDate.getTime())) {
                                        const dateStr = monthData.rawDate.toString();
                                        const parts = dateStr.split('/');
                                        if (parts.length === 3) {
                                            const month = parseInt(parts[0]) - 1; // Convert to 0-based
                                            const day = parseInt(parts[1]);
                                            const year = parseInt(parts[2]);
                                            parsedDate = new Date(year, month, day);
                                        }
                                    }
                                }
                            }
                            
                            return {
                                ...monthData,
                                originalDate: monthData.date,
                                parsedDate: parsedDate,
                                index: index
                            };
                        });
                        
                        // Check if we have valid parsed dates
                        const validDates = parsedDates.filter(item => item.parsedDate && !isNaN(item.parsedDate.getTime()));
                        
                        if (validDates.length === 0) {
                            console.log('⚠️ Dashboard cache: No valid dates found, using fallback sequential logic');
                            // Fallback to sequential month logic
                            return monthlyData.map((monthData, index) => {
                                const currentDate = new Date();
                                const currentMonth = currentDate.getMonth();
                                const currentYear = currentDate.getFullYear();
                                
                                let targetMonth = currentMonth - index;
                                let targetYear = currentYear;
                                
                                if (targetMonth < 0) {
                                    targetMonth += 12;
                                    targetYear--;
                                }
                                
                                const correctedDate = new Date(targetYear, targetMonth, 1);
                                const formattedDate = correctedDate.toLocaleString('default', { 
                                    month: 'long', 
                                    year: 'numeric'
                                });
                                
                                return {
                                    ...monthData,
                                    date: formattedDate,
                                    originalDate: monthData.date,
                                    correctedDate: correctedDate
                                };
                            });
                        }
                        
                        // If we have valid dates, sort by date (newest first) and format properly
                        validDates.sort((a, b) => b.parsedDate.getTime() - a.parsedDate.getTime());
                        
                        console.log('✅ Dashboard cache: Valid dates after sorting:', validDates.map(v => ({
                            date: v.parsedDate.toLocaleString('default', { month: 'long', year: 'numeric' }),
                            parsedDate: v.parsedDate,
                            originalDate: v.originalDate
                        })));
                        
                        return validDates.map(item => {
                            const formattedDate = item.parsedDate.toLocaleString('default', { 
                                month: 'long', 
                                year: 'numeric'
                            });
                            
                            return {
                                ...item,
                                date: formattedDate,
                                correctedDate: item.parsedDate
                            };
                        });
                    };
                    
                    // Process the cached data with proper date formatting
                    const processedMedspaNearMe = medspaNearMe.length > 0 ? fixDateFormatting(medspaNearMe) : [];
                    setGeogridData(processedMedspaNearMe);
                    setLoading(false);
                    return;
                } catch (e) {
                    // Invalid cache, continue with fresh fetch
                    console.error('Cache parsing error:', e);
                }
            }

            const scriptUrl = `https://script.google.com/macros/s/AKfycbxfOMp8d_eCVH4lFD0PNuFU1wH-gyWOwRt2EuME7GQJ4U73ZwpPDciohDH3C566YLWq/exec?workbookId=${workbookId}`;
            
            fetchWithCorsWorkaround(scriptUrl, (err, data) => {
                if (err) {
                    setError(err.message);
                    setLoading(false);
                    return;
                }
                if (data.error) {
                    setError(`Script error: ${data.error}`);
                    setLoading(false);
                    return;
                }
                
                try {
                    // Enhanced date formatting function (same as in GeogridMaps)
                    const fixDateFormatting = (monthlyData) => {
                        const parsedDates = monthlyData.map((monthData, index) => {
                            let parsedDate = null;
                            
                            // First try to use the backend's parsedDate if available
                            if (monthData.parsedDate) {
                                parsedDate = new Date(monthData.parsedDate);
                                console.log(`Using backend parsedDate for index ${index}:`, parsedDate);
                            }
                            
                            // If parsedDate is invalid or not available, try other approaches
                            if (!parsedDate || isNaN(parsedDate.getTime())) {
                                // Try parsing the date field directly
                                if (monthData.date) {
                                    parsedDate = new Date(monthData.date);
                                    
                                    // If that fails, try US date format parsing
                                    if (isNaN(parsedDate.getTime())) {
                                        const dateStr = monthData.date.toString();
                                        const parts = dateStr.split('/');
                                        if (parts.length === 3) {
                                            const month = parseInt(parts[0]) - 1; // Convert to 0-based
                                            const day = parseInt(parts[1]);
                                            const year = parseInt(parts[2]);
                                            parsedDate = new Date(year, month, day);
                                        }
                                    }
                                }
                                
                                // Try parsing rawDate if available
                                if ((!parsedDate || isNaN(parsedDate.getTime())) && monthData.rawDate) {
                                    parsedDate = new Date(monthData.rawDate);
                                    
                                    // If that fails, try US date format parsing on rawDate
                                    if (isNaN(parsedDate.getTime())) {
                                        const dateStr = monthData.rawDate.toString();
                                        const parts = dateStr.split('/');
                                        if (parts.length === 3) {
                                            const month = parseInt(parts[0]) - 1; // Convert to 0-based
                                            const day = parseInt(parts[1]);
                                            const year = parseInt(parts[2]);
                                            parsedDate = new Date(year, month, day);
                                        }
                                    }
                                }
                            }
                            
                            return {
                                ...monthData,
                                originalDate: monthData.date,
                                parsedDate: parsedDate,
                                index: index
                            };
                        });
                        
                        // Check if we have valid parsed dates
                        const validDates = parsedDates.filter(item => item.parsedDate && !isNaN(item.parsedDate.getTime()));
                        
                        if (validDates.length === 0) {
                            console.log('⚠️ Dashboard: No valid dates found, using fallback sequential logic');
                            // Fallback to sequential month logic
                            return monthlyData.map((monthData, index) => {
                                const currentDate = new Date();
                                const currentMonth = currentDate.getMonth();
                                const currentYear = currentDate.getFullYear();
                                
                                let targetMonth = currentMonth - index;
                                let targetYear = currentYear;
                                
                                if (targetMonth < 0) {
                                    targetMonth += 12;
                                    targetYear--;
                                }
                                
                                const correctedDate = new Date(targetYear, targetMonth, 1);
                                const formattedDate = correctedDate.toLocaleString('default', { 
                                    month: 'long', 
                                    year: 'numeric'
                                });
                                
                                return {
                                    ...monthData,
                                    date: formattedDate,
                                    originalDate: monthData.date,
                                    correctedDate: correctedDate
                                };
                            });
                        }
                        
                        // If we have valid dates, sort by date (newest first) and format properly
                        validDates.sort((a, b) => b.parsedDate.getTime() - a.parsedDate.getTime());
                        
                        console.log('✅ Dashboard: Valid dates after sorting:', validDates.map(v => ({
                            date: v.parsedDate.toLocaleString('default', { month: 'long', year: 'numeric' }),
                            parsedDate: v.parsedDate,
                            originalDate: v.originalDate
                        })));
                        
                        return validDates.map(item => {
                            const formattedDate = item.parsedDate.toLocaleString('default', { 
                                month: 'long', 
                                year: 'numeric'
                            });
                            
                            return {
                                ...item,
                                date: formattedDate,
                                correctedDate: item.parsedDate
                            };
                        });
                    };

                    // Get the geogrid data for 'medspa near me' with all months
                    const allGeogridData = data.geogridData || {};
                    const medspaNearMe = allGeogridData['medspa near me'] || [];
                    
                    // Apply date formatting to the dashboard data
                    const processedMedspaNearMe = medspaNearMe.length > 0 ? fixDateFormatting(medspaNearMe) : [];
                    
                    // Store the full geogrid data in cache (but don't overwrite the processed data)
                    sessionStorage.setItem(cacheKey, JSON.stringify(allGeogridData));
                    
                    // Set the processed monthly data for dashboard display
                    setGeogridData(processedMedspaNearMe);
                    setLoading(false);
                } catch (e) {
                    console.error('Data processing error:', e);
                    setError('Failed to process geogrid data');
                    setLoading(false);
                }
            });
        }, []);

        if (loading) {
            return <Card className="col-span-12 lg:col-span-8 flex items-center justify-center"><p className="text-gray-500">Loading Geogrid data...</p></Card>;
        }
        if (error) {
            return <Card className="col-span-12 lg:col-span-8 flex items-center justify-center"><p className="text-red-500">Geogrid Error: {error}</p></Card>;
        }
        if (!geogridData || geogridData.length === 0) {
            return <Card className="col-span-12 lg:col-span-8 flex items-center justify-center"><p className="text-gray-500">No Geogrid data to display for 'medspa near me'.</p></Card>;
        }

        const getRankColor = (rank) => {
            if (rank === null || rank === undefined) return 'bg-gray-400';
            if (rank <= 3) return 'bg-green-500';
            if (rank <= 5) return 'bg-sky-500';
            if (rank <= 10) return 'bg-yellow-500';
            if (rank <= 20) return 'bg-orange-500';
            return 'bg-red-500';
        };

        // Calculate current data based on state
        const currentDashboardData = geogridData[dashboardMonthIndex] || geogridData[0];
        const displayMonthNumber = geogridData.length - dashboardMonthIndex;

        const handleDashboardDateChange = (direction) => {
            const newIndex = dashboardMonthIndex + direction;
            if (newIndex >= 0 && newIndex < geogridData.length) {
                setDashboardMonthIndex(newIndex);
            }
        };

        if (!currentDashboardData) {
            return <Card className="col-span-12 lg:col-span-8 flex items-center justify-center"><p className="text-gray-500">No current month data available.</p></Card>;
        }

        return (
                            <Card className="col-span-12 lg:col-span-8 group hover:shadow-xl transition-all duration-300 hover:-translate-y-0.5 hover:scale-[1.003] hover:border-blue-200/60">
                <div className="grid grid-cols-1 lg:grid-cols-4 gap-6">
                    {/* Modern Competitor Rankings */}
                    {currentDashboardData.competitors && currentDashboardData.competitors.length > 0 && (
                        <div className="lg:col-span-1 flex flex-col">
                            <div className="flex justify-between items-center mb-4 min-h-[60px]">
                                <div className="flex items-center space-x-2">
                                    <h2 className="text-xl font-bold text-gray-800">Avg Score</h2>
                                    <div className="w-2 h-2 bg-gradient-to-r from-green-500 to-red-500 rounded-full"></div>
                                </div>
                            </div>
                            <div className="space-y-1.5 max-h-[580px] overflow-visible">
                                {currentDashboardData.competitors.map((comp, index) => {
                                    const isClient = comp.isClient;
                                    const rank = typeof comp.rank === 'number' ? comp.rank : 0;
                                    
                                    // Improved color scheme for geogrid scores (lower is better)
                                    const getScoreColors = (score) => {
                                        if (score <= 3) {
                                            return {
                                                border: 'border-green-500',
                                                bg: 'bg-green-50',
                                                text: 'text-green-700',
                                                accent: 'bg-green-500'
                                            };
                                        } else if (score <= 7) {
                                            return {
                                                border: 'border-yellow-500',
                                                bg: 'bg-yellow-50',
                                                text: 'text-yellow-700',
                                                accent: 'bg-yellow-500'
                                            };
                                        } else {
                                            return {
                                                border: 'border-red-500',
                                                bg: 'bg-red-50',
                                                text: 'text-red-700',
                                                accent: 'bg-red-500'
                                            };
                                        }
                                    };
                                    
                                    const scoreColors = getScoreColors(rank);
                                    
                                    // Position indicators
                                    const getPositionText = (index) => {
                                        const positions = ['1st', '2nd', '3rd', '4th', '5th'];
                                        return positions[index] || `${index + 1}th`;
                                    };
                                    
                                    return (
                                        <div key={index} className={`group relative overflow-hidden rounded-xl transition-all duration-300 hover:shadow-lg ${isClient ? 'bg-gradient-to-r from-blue-50 to-blue-100 border-2 border-blue-200 hover:border-blue-300' : 'bg-white border border-gray-200 hover:border-gray-300 hover:shadow-md'}`}>
                                            {/* Position Badge - Top Left */}
                                            <div className="absolute top-2 left-2 z-10">
                                                <span className={`inline-block px-2 py-1 rounded-full text-xs font-bold shadow-sm ${
                                                    index === 0 ? 'bg-yellow-500 text-white' :
                                                    index === 1 ? 'bg-gray-500 text-white' :
                                                    index === 2 ? 'bg-orange-500 text-white' :
                                                    'bg-blue-500 text-white'
                                                }`}>
                                                    {getPositionText(index)}
                                                </span>
                                            </div>
                                            
                                            {/* Subtle background pattern */}
                                            <div className="absolute inset-0 bg-gradient-to-br from-white/50 to-transparent pointer-events-none"></div>
                                            
                                            <div className="relative p-3 pt-6 flex items-center space-x-3">
                                                {/* Modern Score Badge - Hexagonal style */}
                                                <div className="relative">
                                                    <div className={`w-16 h-16 rounded-2xl ${scoreColors.bg} ${scoreColors.border} border-2 flex items-center justify-center font-bold ${scoreColors.text} text-lg shadow-lg group-hover:scale-105 transition-all duration-200 relative overflow-hidden`}>
                                                        {/* Accent corner */}
                                                        <div className={`absolute top-0 right-0 w-4 h-4 ${scoreColors.accent} transform rotate-45 translate-x-2 -translate-y-2`}></div>
                                                        <span className="relative z-10">{rank > 0 ? rank.toFixed(1) : '-'}</span>
                                                    </div>
                                                    {/* Subtle glow effect */}
                                                    <div className={`absolute inset-0 rounded-2xl ${scoreColors.bg} opacity-30 group-hover:opacity-50 transition-opacity duration-200 blur-sm`}></div>
                                                </div>
                                                
                                                {/* Business Info */}
                                                <div className="flex-1 min-w-0">
                                                    <div className="flex items-center space-x-2">
                                                        <p className={`font-semibold text-sm leading-tight truncate ${isClient ? 'text-blue-900' : 'text-gray-800'}`} title={comp.name || 'Unknown'}>
                                                            {comp.name || 'Unknown'}
                                                        </p>
                                                        {isClient && (
                                                            <div className="flex-shrink-0 w-4 h-4 bg-blue-500 rounded-full flex items-center justify-center">
                                                                <span className="text-xs text-white font-bold">★</span>
                                                            </div>
                                                        )}
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    );
                                })}
                            </div>
                        </div>
                    )}
                    
                    {/* Geogrid Map on the Right */}
                    <div className="lg:col-span-3">
                        <div className="flex justify-between items-center mb-4">
                            <div className="flex items-center space-x-2">
                                <h2 className="text-xl font-bold text-gray-800">Medspa Near Me</h2>
                                <InfoTooltip text="A snapshot of your Geogrid map for the keyword 'medspa near me'." />
                                <button onClick={() => setActiveTab('Geogrid Maps')} className="text-xs font-normal text-blue-600 hover:text-blue-800">(See More)</button>
                            </div>
                            
                            {/* Month slider controls */}
                            {geogridData.length > 1 && (
                                <div className="flex items-center space-x-3">
                                    <button 
                                        onClick={() => handleDashboardDateChange(1)} 
                                        disabled={dashboardMonthIndex >= geogridData.length - 1}
                                        className="flex items-center justify-center w-8 h-8 rounded-lg bg-blue-100 hover:bg-blue-200 disabled:opacity-50 disabled:cursor-not-allowed text-blue-600 transition-colors"
                                        title="Go back to older month"
                                    >
                                        <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M15 19l-7-7 7-7" />
                                        </svg>
                                    </button>
                                    <div className="text-center">
                                        <span className="font-semibold text-gray-700 text-sm">{currentDashboardData.date || 'No date'}</span>
                                        <div className="text-xs text-gray-500">
                                            {displayMonthNumber} of {geogridData.length}
                                        </div>
                                        <div className="flex items-center justify-center space-x-1 mt-1">
                                            {geogridData.map((_, index) => {
                                                const visualIndex = geogridData.length - 1 - index;
                                                return (
                                                    <div
                                                        key={index}
                                                        className={`w-2 h-2 rounded-full ${
                                                            index === dashboardMonthIndex 
                                                                ? 'bg-blue-600' 
                                                                : 'bg-gray-300 hover:bg-gray-400'
                                                        } cursor-pointer transition-colors`}
                                                        onClick={() => setDashboardMonthIndex(index)}
                                                        title={`Go to ${geogridData[index]?.date || 'Unknown month'} (${geogridData.length - index} of ${geogridData.length})`}
                                                        style={{ order: visualIndex }}
                                                    />
                                                );
                                            })}
                                        </div>
                                    </div>
                                    <button 
                                        onClick={() => handleDashboardDateChange(-1)} 
                                        disabled={dashboardMonthIndex <= 0}
                                        className="flex items-center justify-center w-8 h-8 rounded-lg bg-blue-100 hover:bg-blue-200 disabled:opacity-50 disabled:cursor-not-allowed text-blue-600 transition-colors"
                                        title="Go forward to newer month"
                                    >
                                        <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M9 5l7 7-7 7" />
                                        </svg>
                                    </button>
                                </div>
                            )}
                            
                            {/* Single month display */}
                            {geogridData.length === 1 && (
                                <span className="font-semibold text-gray-700">{currentDashboardData.date}</span>
                            )}
                        </div>
                        {currentDashboardData.mapLink ? (
                            <div className="relative w-full h-[600px] overflow-hidden map-container" onClick={handleMapClick}>
                                <iframe 
                                    src={processMapUrlForCentering(currentDashboardData.mapLink)}
                                    className="w-full h-full rounded-lg border border-gray-200 map-iframe"
                                    style={{ background: '#f9fafb' }}
                                    loading="lazy"
                                    allowFullScreen
                                    scrolling="no"
                                />
                                <a 
                                    href={currentDashboardData.mapLink} 
                                    target="_blank" 
                                    rel="noopener noreferrer"
                                    className="absolute bottom-2 right-2 bg-white/90 hover:bg-white text-gray-700 px-2 py-1 rounded text-xs flex items-center gap-1 shadow-sm transition-colors"
                                >
                                    <ExternalLink className="w-3 h-3 mr-1" />
                                    Open in new tab
                                </a>
                            </div>
                        ) : (
                            <div className="w-full h-[600px] flex flex-col items-center justify-center bg-gray-50 rounded-lg border-2 border-dashed border-gray-200">
                                <div className="bg-gray-100 p-4 rounded-full mb-4">
                                    <svg className="w-12 h-12 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M9 20l-5.447-2.724A1 1 0 013 16.382V5.618a1 1 0 011.447-.894L9 7m0 13l6-3m-6 3V7m6 10l4.553 2.276A1 1 0 0021 18.382V7.618a1 1 0 00-.553-.894L15 4m0 13V4m0 0L9 7" />
                                    </svg>
                                </div>
                                <p className="text-lg font-semibold text-gray-600 mb-2">Map Not Available Yet</p>
                                <p className="text-sm text-gray-500 text-center max-w-md">
                                    The Geogrid map for "medspa near me" is pending setup. Once available, it will show local search rankings across your service area.
                                </p>
                            </div>
                        )}
                    </div>
                </div>
            </Card>
        );
    });

    const CensusInfo = ({ censusData, loading, error }) => {
        if (loading) {
            return <Card className="col-span-12 lg:col-span-4 h-full flex items-center justify-center"><p className="text-gray-500">Loading Census data...</p></Card>;
        }
        if (error) {
            return <Card className="col-span-12 lg:col-span-4 h-full flex items-center justify-center"><p className="text-red-500">Census Error: {error}</p></Card>;
        }
        if (!censusData) {
            return <Card className="col-span-12 lg:col-span-4 h-full flex items-center justify-center"><p className="text-gray-500">No census data available.</p></Card>;
        }

        return (
                            <Card className="col-span-12 lg:col-span-4 h-full group hover:shadow-xl transition-all duration-300 hover:-translate-y-0.5 hover:scale-[1.003] hover:border-blue-200/60">
                 <div className="flex items-center space-x-2 mb-4">
                    <h2 className="text-xl font-bold text-gray-800">Census Data</h2>
                    <InfoTooltip text="Provides demographic and economic information for your target service area." />
                 </div>
                <div>
                    {Object.entries(censusData).map(([key, value]) => {
                        if (!value) return null;
                        
                        // Special formatting for multi-line values
                        if (['Age Ranges', 'Ethnicity', 'Gender', 'Languages'].includes(key)) {
                            let items = [];
                            
                            if (key === 'Gender' || key === 'Languages') {
                                items = value.split(' / ');
                            } else if (key === 'Age Ranges' || key === 'Ethnicity') {
                                // Parse age ranges and ethnicity data that comes in format like "0-17 11.3% 18-34: 19.1%"
                                // Split by patterns that indicate new entries (age range followed by percentage)
                                const regex = /(\d+[-\w\s]+?):\s*(\d+\.?\d*%)/g;
                                let match;
                                const parsedItems = [];
                                
                                while ((match = regex.exec(value)) !== null) {
                                    parsedItems.push(`${match[1].trim()}: ${match[2]}`);
                                }
                                
                                // If regex parsing didn't work, fall back to simpler splitting
                                if (parsedItems.length === 0) {
                                    // Try alternative parsing - split on percentage signs and rebuild
                                    const parts = value.split('%');
                                    for (let i = 0; i < parts.length - 1; i++) {
                                        const part = parts[i].trim();
                                        const lastSpaceIndex = part.lastIndexOf(' ');
                                        if (lastSpaceIndex > 0) {
                                            const label = part.substring(0, lastSpaceIndex).trim();
                                            const percentage = part.substring(lastSpaceIndex + 1).trim();
                                            if (label && percentage) {
                                                parsedItems.push(`${label}: ${percentage}%`);
                                            }
                                        }
                                    }
                                }
                                
                                items = parsedItems.length > 0 ? parsedItems : value.split(' ');
                            } else {
                                items = value.split(' ');
                            }
                            
                            return (
                                <div key={key} className="flex justify-between text-sm py-3 border-t border-gray-100 first:border-t-0 first:pt-0">
                                    <span className="text-gray-600">{key}</span>
                                    <div className="text-right text-gray-600 space-y-1">
                                        {items.map((item, idx) => (
                                            <div key={idx}>{item.trim()}</div>
                                        ))}
                                    </div>
                                </div>
                            );
                        }
                        
                        // Default display for other fields
                        let displayValue = value;
                        if (key === 'Median Income' && !String(value).startsWith('$')) {
                            displayValue = `$${value}`;
                        }
                        
                        return (
                            <div key={key} className="flex justify-between items-center text-sm py-3 border-t border-gray-100 first:border-t-0 first:pt-0">
                                <span className="text-gray-600">{key}</span>
                                <span className="text-gray-600 text-right">{displayValue}</span>
                            </div>
                        )
                    })}
                </div>
            </Card>
        );
    };

    const OverviewTable = ({ overviewData, loading, error, onRefresh, isRefreshing, refreshProgress, refreshMessage }) => {
        if (loading) {
            return <Card className="col-span-12 overflow-x-auto flex items-center justify-center"><p className="text-gray-500">Loading Overview data...</p></Card>;
        }
        if (error) {
            return <Card className="col-span-12 overflow-x-auto flex items-center justify-center"><p className="text-red-500">Overview Error: {error}</p></Card>;
        }
        if (!overviewData || overviewData.length === 0) {
            return <Card className="col-span-12 overflow-x-auto flex items-center justify-center"><p className="text-gray-500">No overview data available.</p></Card>;
        }

        return (
                            <Card className="col-span-12 overflow-x-auto group hover:shadow-xl transition-all duration-300 hover:-translate-y-0.5 hover:scale-[1.003] hover:border-blue-200/60">
                <div className="flex justify-between items-center mb-4">
                    <div className="flex items-center space-x-2">
                        <h2 className="text-xl font-bold text-gray-800">Overview</h2>
                         <InfoTooltip text="A high-level comparison of your clinic against key competitors on important metrics like online reviews, site performance, and advertising." />
                    </div>
                    <div className="flex items-center space-x-4">
                        {/* Inline Progress Indicator */}
                        {isRefreshing && (
                            <div className="flex items-center space-x-3 bg-white rounded-xl shadow-md px-4 py-2 border border-gray-100">
                                <div className="flex items-center space-x-2">
                                    <div className="w-4 h-4 border-2 border-blue-500 border-t-transparent rounded-full animate-spin"></div>
                                    <span className="text-sm font-medium text-gray-700">{refreshMessage}</span>
                                </div>
                                <div className="w-16 bg-gray-200 rounded-full h-2">
                                    <div 
                                        className="bg-gradient-to-r from-blue-500 to-blue-600 h-2 rounded-full transition-all duration-500 ease-out"
                                        style={{ width: `${refreshProgress}%` }}
                                    ></div>
                                </div>
                                <span className="text-xs font-medium text-blue-600 min-w-[2rem]">{refreshProgress}%</span>
                            </div>
                        )}
                        
                        <button 
                            onClick={onRefresh}
                            disabled={isRefreshing}
                            className={`px-4 py-2 rounded-lg font-medium transition-all duration-200 shadow-md hover:shadow-lg text-sm ${
                                isRefreshing 
                                    ? 'bg-gray-300 text-gray-500 cursor-not-allowed' 
                                    : 'bg-gradient-to-r from-blue-500 to-blue-600 hover:from-blue-600 hover:to-blue-700 text-white'
                            }`}
                        >
                            {isRefreshing ? 'Updating...' : 'Update Analytics'}
                        </button>
                    </div>
                </div>
                <table className="w-full text-left text-sm whitespace-nowrap">
                    <thead>
                        <tr className="border-b-2 border-gray-200">
                            <th className="py-2 px-3">Clinic</th>
                            <th className="py-2 px-3 text-center">Site Speed</th>
                            <th className="py-2 px-3 text-center">Keywords #1</th>
                            <th className="py-2 px-3 text-center">Backlinks</th>
                            <th className="py-2 px-3">Opening Hours</th>
                            <th className="py-2 px-3 text-center">Google Ads</th>
                            <th className="py-2 px-3 text-center">Facebook Ads</th>
                        </tr>
                    </thead>
                    <tbody>
                        {overviewData.map(c => (
                            <tr key={c.id} className={`border-b border-gray-100 ${c.isClient ? 'bg-blue-50' : ''}`}>
                                <td className="py-3 px-3">
                                    <div>
                                        <div className="flex items-baseline gap-2">
                                            <span className="font-semibold text-gray-800">{c.clinicName}</span>
                                            <span className="text-sm text-gray-600">
                                                {c.reviewScore} <span className="text-yellow-400">★</span> ({c.reviewCount} reviews)
                                            </span>
                                        </div>
                                        <div className="text-xs text-gray-500">
                                            {[c.address, c.borough, c.city].filter(Boolean).join(', ')}
                                        </div>
                                        {c.website && (
                                            <a href={c.website} target="_blank" rel="noopener noreferrer" 
                                               className="text-xs text-blue-600 hover:text-blue-800 hover:underline">
                                                {c.website.replace(/^https?:\/\//i, '')}
                                            </a>
                                        )}
                                    </div>
                                </td>
                                <td className="py-3 px-3 text-center font-medium">
                                    {(() => {
                                        const speed = c.speed;
                                        if (speed && speed !== 'N/A') {
                                            // Parse the speed value, removing any non-numeric characters except decimal points
                                            const numericSpeed = parseFloat(String(speed).replace(/[^\d.]/g, ''));
                                            
                                            if (!isNaN(numericSpeed)) {
                                                // ALL data is in milliseconds, always convert to seconds
                                                const seconds = (numericSpeed / 1000).toFixed(3);
                                                return `${seconds}s`;
                                            }
                                        }
                                        return speed || 'N/A';
                                    })()}
                                </td>
                                <td className="py-3 px-3 text-center font-medium">{c.kwPos1}</td>
                                <td className="py-3 px-3 text-center font-medium">{c.backlinks.toLocaleString()}</td>
                                <td className="py-3 px-3 text-gray-600">
                                    {(() => {
                                        if (!c.hours || c.hours === 'N/A') return 'N/A';
                                        
                                        const daysOrder = ['MON', 'TUE', 'WED', 'THU', 'FRI', 'SAT', 'SUN'];
                                        const hoursMap = {};
                                        
                                        // Handle both comma and semicolon separators for robust parsing
                                        c.hours.split(/, ?|; ?/).forEach(part => {
                                            const bits = part.split(/:\s?/);
                                            if (bits.length < 2) return;
                                            
                                            const day = bits[0].trim().substring(0, 3).toUpperCase();
                                            const time = bits.slice(1).join(':').trim();
                                            
                                            if (daysOrder.includes(day)) {
                                                hoursMap[day] = time;
                                            }
                                        });

                                        if (Object.keys(hoursMap).length === 0) return c.hours;
                                        
                                        const openDays = [];
                                        const closedDays = [];
                                        
                                        daysOrder.forEach(day => {
                                            const time = hoursMap[day];
                                            if (time && time.toLowerCase() !== 'closed') {
                                                openDays.push({ day, time });
                                            } else {
                                                closedDays.push(day);
                                            }
                                        });

                                        return (
                                            <div className="text-xs space-y-1">
                                                {openDays.map(item => (
                                                    <div key={item.day} className="font-semibold">
                                                        <span>{item.day}: {item.time}</span>
                                                        <span className="text-blue-600 ml-1">Open</span>
                                                    </div>
                                                ))}
                                                {closedDays.length > 0 && (
                                                    <div className="text-red-500 font-semibold">
                                                        {closedDays.join(', ')} Closed
                                                    </div>
                                                )}
                                            </div>
                                        );
                                    })()}
                                </td>
                                <td className="py-3 px-3 text-center"><AdIndicator status={c.gAds} link={c.gAdsLink} /></td>
                                <td className="py-3 px-3 text-center"><AdIndicator status={c.fbAds} link={c.fbAdsLink} /></td>
                            </tr>
                        ))}
                    </tbody>
                </table>
            </Card>
        );
    };
    
    // Modern Location Selector Component
    const LocationSelector = ({ value, onChange }) => {
        const [isOpen, setIsOpen] = useState(false);
        const [searchTerm, setSearchTerm] = useState('');
        const [focusedIndex, setFocusedIndex] = useState(-1);
        const [recentSelections, setRecentSelections] = useState([]);
        const selectorRef = useRef(null);
        const inputRef = useRef(null);
        const listRef = useRef(null);

        // Comprehensive location data
        const locations = {
            countries: [
                { id: 'USA', name: 'United States', flag: '🇺🇸', category: 'Countries' },
                { id: 'Canada', name: 'Canada', flag: '🇨🇦', category: 'Countries' }
            ],
            usStates: [
                                 { id: 'Alabama', name: 'Alabama', flag: '🇺🇸', category: '🇺🇸 States' },
                 { id: 'Alaska', name: 'Alaska', flag: '🇺🇸', category: '🇺🇸 States' },
                 { id: 'Arizona', name: 'Arizona', flag: '🇺🇸', category: '🇺🇸 States' },
                 { id: 'Arkansas', name: 'Arkansas', flag: '🇺🇸', category: '🇺🇸 States' },
                 { id: 'California', name: 'California', flag: '🇺🇸', category: '🇺🇸 States' },
                 { id: 'Colorado', name: 'Colorado', flag: '🇺🇸', category: '🇺🇸 States' },
                 { id: 'Connecticut', name: 'Connecticut', flag: '🇺🇸', category: '🇺🇸 States' },
                 { id: 'Delaware', name: 'Delaware', flag: '🇺🇸', category: '🇺🇸 States' },
                 { id: 'Florida', name: 'Florida', flag: '🇺🇸', category: '🇺🇸 States' },
                 { id: 'Georgia', name: 'Georgia', flag: '🇺🇸', category: '🇺🇸 States' },
                 { id: 'Hawaii', name: 'Hawaii', flag: '🇺🇸', category: '🇺🇸 States' },
                 { id: 'Idaho', name: 'Idaho', flag: '🇺🇸', category: '🇺🇸 States' },
                 { id: 'Illinois', name: 'Illinois', flag: '🇺🇸', category: '🇺🇸 States' },
                 { id: 'Indiana', name: 'Indiana', flag: '🇺🇸', category: '🇺🇸 States' },
                 { id: 'Iowa', name: 'Iowa', flag: '🇺🇸', category: '🇺🇸 States' },
                 { id: 'Kansas', name: 'Kansas', flag: '🇺🇸', category: '🇺🇸 States' },
                 { id: 'Kentucky', name: 'Kentucky', flag: '🇺🇸', category: '🇺🇸 States' },
                 { id: 'Louisiana', name: 'Louisiana', flag: '🇺🇸', category: '🇺🇸 States' },
                 { id: 'Maine', name: 'Maine', flag: '🇺🇸', category: '🇺🇸 States' },
                 { id: 'Maryland', name: 'Maryland', flag: '🇺🇸', category: '🇺🇸 States' },
                 { id: 'Massachusetts', name: 'Massachusetts', flag: '🇺🇸', category: '🇺🇸 States' },
                 { id: 'Michigan', name: 'Michigan', flag: '🇺🇸', category: '🇺🇸 States' },
                 { id: 'Minnesota', name: 'Minnesota', flag: '🇺🇸', category: '🇺🇸 States' },
                 { id: 'Mississippi', name: 'Mississippi', flag: '🇺🇸', category: '🇺🇸 States' },
                 { id: 'Missouri', name: 'Missouri', flag: '🇺🇸', category: '🇺🇸 States' },
                 { id: 'Montana', name: 'Montana', flag: '🇺🇸', category: '🇺🇸 States' },
                 { id: 'Nebraska', name: 'Nebraska', flag: '🇺🇸', category: '🇺🇸 States' },
                 { id: 'Nevada', name: 'Nevada', flag: '🇺🇸', category: '🇺🇸 States' },
                 { id: 'New Hampshire', name: 'New Hampshire', flag: '🇺🇸', category: '🇺🇸 States' },
                 { id: 'New Jersey', name: 'New Jersey', flag: '🇺🇸', category: '🇺🇸 States' },
                 { id: 'New Mexico', name: 'New Mexico', flag: '🇺🇸', category: '🇺🇸 States' },
                 { id: 'New York', name: 'New York', flag: '🇺🇸', category: '🇺🇸 States' },
                 { id: 'North Carolina', name: 'North Carolina', flag: '🇺🇸', category: '🇺🇸 States' },
                 { id: 'North Dakota', name: 'North Dakota', flag: '🇺🇸', category: '🇺🇸 States' },
                 { id: 'Ohio', name: 'Ohio', flag: '🇺🇸', category: '🇺🇸 States' },
                 { id: 'Oklahoma', name: 'Oklahoma', flag: '🇺🇸', category: '🇺🇸 States' },
                 { id: 'Oregon', name: 'Oregon', flag: '🇺🇸', category: '🇺🇸 States' },
                 { id: 'Pennsylvania', name: 'Pennsylvania', flag: '🇺🇸', category: '🇺🇸 States' },
                 { id: 'Rhode Island', name: 'Rhode Island', flag: '🇺🇸', category: '🇺🇸 States' },
                 { id: 'South Carolina', name: 'South Carolina', flag: '🇺🇸', category: '🇺🇸 States' },
                 { id: 'South Dakota', name: 'South Dakota', flag: '🇺🇸', category: '🇺🇸 States' },
                 { id: 'Tennessee', name: 'Tennessee', flag: '🇺🇸', category: '🇺🇸 States' },
                 { id: 'Texas', name: 'Texas', flag: '🇺🇸', category: '🇺🇸 States' },
                 { id: 'Utah', name: 'Utah', flag: '🇺🇸', category: '🇺🇸 States' },
                 { id: 'Vermont', name: 'Vermont', flag: '🇺🇸', category: '🇺🇸 States' },
                 { id: 'Virginia', name: 'Virginia', flag: '🇺🇸', category: '🇺🇸 States' },
                 { id: 'Washington', name: 'Washington', flag: '🇺🇸', category: '🇺🇸 States' },
                 { id: 'West Virginia', name: 'West Virginia', flag: '🇺🇸', category: '🇺🇸 States' },
                 { id: 'Wisconsin', name: 'Wisconsin', flag: '🇺🇸', category: '🇺🇸 States' },
                 { id: 'Wyoming', name: 'Wyoming', flag: '🇺🇸', category: '🇺🇸 States' }
            ],
                         canadianProvinces: [
                 { id: 'Alberta', name: 'Alberta', flag: '🇨🇦', category: '🇨🇦 Provinces' },
                 { id: 'British Columbia', name: 'British Columbia', flag: '🇨🇦', category: '🇨🇦 Provinces' },
                 { id: 'Manitoba', name: 'Manitoba', flag: '🇨🇦', category: '🇨🇦 Provinces' },
                 { id: 'New Brunswick', name: 'New Brunswick', flag: '🇨🇦', category: '🇨🇦 Provinces' },
                 { id: 'Newfoundland and Labrador', name: 'Newfoundland and Labrador', flag: '🇨🇦', category: '🇨🇦 Provinces' },
                 { id: 'Northwest Territories', name: 'Northwest Territories', flag: '🇨🇦', category: '🇨🇦 Provinces' },
                 { id: 'Nova Scotia', name: 'Nova Scotia', flag: '🇨🇦', category: '🇨🇦 Provinces' },
                 { id: 'Nunavut', name: 'Nunavut', flag: '🇨🇦', category: '🇨🇦 Provinces' },
                 { id: 'Ontario', name: 'Ontario', flag: '🇨🇦', category: '🇨🇦 Provinces' },
                 { id: 'Prince Edward Island', name: 'Prince Edward Island', flag: '🇨🇦', category: '🇨🇦 Provinces' },
                 { id: 'Quebec', name: 'Quebec', flag: '🇨🇦', category: '🇨🇦 Provinces' },
                 { id: 'Saskatchewan', name: 'Saskatchewan', flag: '🇨🇦', category: '🇨🇦 Provinces' },
                 { id: 'Yukon', name: 'Yukon', flag: '🇨🇦', category: '🇨🇦 Provinces' }
             ],
            cities: [
                { id: 'Lakeland, FL', name: 'Lakeland, FL', flag: '🇺🇸', category: 'Cities' }
            ]
        };

        // Flatten all locations for searching
        const allLocations = [
            ...locations.countries,
            ...locations.usStates,
            ...locations.canadianProvinces,
            ...locations.cities
        ];

        // Get current location display info
        const currentLocation = allLocations.find(loc => loc.id === value) || allLocations[0];

        // Load recent selections from localStorage
        useEffect(() => {
            const saved = localStorage.getItem('recentLocationSelections');
            if (saved) {
                try {
                    setRecentSelections(JSON.parse(saved));
                } catch (e) {
                    console.error('Error loading recent selections:', e);
                }
            }
        }, []);

        // Save recent selections to localStorage
        const saveRecentSelection = (locationId) => {
            const updated = [locationId, ...recentSelections.filter(id => id !== locationId)].slice(0, 5);
            setRecentSelections(updated);
            localStorage.setItem('recentLocationSelections', JSON.stringify(updated));
        };

        // Filter locations based on search term
        const filteredLocations = useMemo(() => {
            if (!searchTerm.trim()) {
                return allLocations;
            }

            const term = searchTerm.toLowerCase();
            return allLocations.filter(location => 
                location.name.toLowerCase().includes(term) ||
                location.category.toLowerCase().includes(term)
            ).sort((a, b) => {
                // Prioritize exact matches at the beginning
                const aStartsWith = a.name.toLowerCase().startsWith(term);
                const bStartsWith = b.name.toLowerCase().startsWith(term);
                if (aStartsWith && !bStartsWith) return -1;
                if (!aStartsWith && bStartsWith) return 1;
                return a.name.localeCompare(b.name);
            });
        }, [searchTerm, allLocations]);

        // Group filtered locations by category
        const groupedLocations = useMemo(() => {
            const groups = {};
            filteredLocations.forEach(location => {
                if (!groups[location.category]) {
                    groups[location.category] = [];
                }
                groups[location.category].push(location);
            });
            return groups;
        }, [filteredLocations]);

        // Get recent selections data
        const recentLocationsData = recentSelections
            .map(id => allLocations.find(loc => loc.id === id))
            .filter(Boolean);

        // Handle keyboard navigation
        const handleKeyDown = (e) => {
            if (!isOpen) {
                if (e.key === 'Enter' || e.key === ' ' || e.key === 'ArrowDown') {
                    e.preventDefault();
                    setIsOpen(true);
                    setFocusedIndex(0);
                }
                return;
            }

            switch (e.key) {
                case 'ArrowDown':
                    e.preventDefault();
                    setFocusedIndex(prev => 
                        prev < filteredLocations.length - 1 ? prev + 1 : 0
                    );
                    break;
                case 'ArrowUp':
                    e.preventDefault();
                    setFocusedIndex(prev => 
                        prev > 0 ? prev - 1 : filteredLocations.length - 1
                    );
                    break;
                case 'Enter':
                    e.preventDefault();
                    if (focusedIndex >= 0 && focusedIndex < filteredLocations.length) {
                        const selected = filteredLocations[focusedIndex];
                        onChange(selected.id);
                        saveRecentSelection(selected.id);
                        setIsOpen(false);
                        setSearchTerm('');
                        setFocusedIndex(-1);
                    }
                    break;
                case 'Escape':
                    e.preventDefault();
                    setIsOpen(false);
                    setSearchTerm('');
                    setFocusedIndex(-1);
                    break;
            }
        };

        // Handle selection
        const handleSelect = (location) => {
            onChange(location.id);
            saveRecentSelection(location.id);
            setIsOpen(false);
            setSearchTerm('');
            setFocusedIndex(-1);
        };

        // Close dropdown when clicking outside
        useEffect(() => {
            const handleClickOutside = (event) => {
                if (selectorRef.current && !selectorRef.current.contains(event.target)) {
                    setIsOpen(false);
                    setSearchTerm('');
                    setFocusedIndex(-1);
                }
            };

            document.addEventListener('mousedown', handleClickOutside);
            return () => document.removeEventListener('mousedown', handleClickOutside);
        }, []);

        // Scroll focused item into view
        useEffect(() => {
            if (focusedIndex >= 0 && listRef.current) {
                const focusedElement = listRef.current.querySelector(`[data-index="${focusedIndex}"]`);
                if (focusedElement) {
                    focusedElement.scrollIntoView({ block: 'nearest' });
                }
            }
        }, [focusedIndex]);

        return (
            <div className="relative" ref={selectorRef}>
                {/* Trigger Button */}
                <button
                    type="button"
                    onClick={() => {
                        setIsOpen(!isOpen);
                        if (!isOpen) {
                            setTimeout(() => inputRef.current?.focus(), 50);
                        }
                    }}
                    onKeyDown={handleKeyDown}
                    className="flex items-center justify-between w-full min-w-[200px] px-4 py-2.5 text-sm bg-white border border-gray-300 rounded-lg shadow-sm hover:border-gray-400 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors"
                >
                    <div className="flex items-center space-x-2">
                        <span className="text-lg leading-none inline-flex items-center justify-center w-5 h-5">{currentLocation.flag}</span>
                        <span className="font-medium text-gray-900">{currentLocation.name}</span>
                    </div>
                    <svg 
                        className={`w-4 h-4 text-gray-400 transition-transform ${isOpen ? 'rotate-180' : ''}`}
                        fill="none" 
                        stroke="currentColor" 
                        viewBox="0 0 24 24"
                    >
                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M19 9l-7 7-7-7" />
                    </svg>
                </button>

                {/* Dropdown Panel */}
                {isOpen && (
                    <div className="absolute top-full left-0 right-0 mt-1 bg-white border border-gray-200 rounded-lg shadow-lg z-50 max-h-96 overflow-hidden">
                        {/* Search Input */}
                        <div className="p-3 border-b border-gray-100">
                            <div className="relative">
                                <svg className="absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                                </svg>
                                <input
                                    ref={inputRef}
                                    type="text"
                                    placeholder="Search locations..."
                                    value={searchTerm}
                                    onChange={(e) => {
                                        setSearchTerm(e.target.value);
                                        setFocusedIndex(0);
                                    }}
                                    onKeyDown={handleKeyDown}
                                    className="w-full pl-10 pr-4 py-2 text-sm border border-gray-200 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                                />
                            </div>
                        </div>

                        {/* Results */}
                        <div className="max-h-80 overflow-y-auto" ref={listRef}>
                            {/* Recent Selections */}
                            {!searchTerm && recentLocationsData.length > 0 && (
                                <div className="p-2">
                                    <div className="px-2 py-1 text-xs font-semibold text-gray-500 uppercase tracking-wider">
                                        Recent
                                    </div>
                                    {recentLocationsData.map((location, index) => (
                                        <button
                                            key={`recent-${location.id}`}
                                            onClick={() => handleSelect(location)}
                                            className="w-full flex items-center space-x-3 px-3 py-2 text-left hover:bg-blue-50 rounded-md transition-colors"
                                        >
                                            <span className="text-lg leading-none inline-flex items-center justify-center w-5 h-5">{location.flag}</span>
                                            <div className="flex-1 min-w-0">
                                                <div className="font-medium text-gray-900 truncate">{location.name}</div>
                                                <div className="text-xs text-gray-500">{location.category}</div>
                                            </div>
                                            <svg className="w-4 h-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
                                            </svg>
                                        </button>
                                    ))}
                                    <div className="border-t border-gray-100 mt-2 pt-2"></div>
                                </div>
                            )}

                            {/* Grouped Results */}
                            {Object.entries(groupedLocations).map(([category, locations]) => (
                                <div key={category} className="p-2">
                                    <div className="px-2 py-1 text-xs font-semibold text-gray-500 uppercase tracking-wider">
                                        {category}
                                    </div>
                                    {locations.map((location, index) => {
                                        const globalIndex = filteredLocations.findIndex(loc => loc.id === location.id);
                                        const isFocused = globalIndex === focusedIndex;
                                        
                                        return (
                                            <button
                                                key={location.id}
                                                data-index={globalIndex}
                                                onClick={() => handleSelect(location)}
                                                className={`w-full flex items-center space-x-3 px-3 py-2 text-left rounded-md transition-colors ${
                                                    isFocused 
                                                        ? 'bg-blue-100 text-blue-900' 
                                                        : 'hover:bg-gray-50 text-gray-900'
                                                }`}
                                            >
                                                <span className="text-lg leading-none inline-flex items-center justify-center w-5 h-5">{location.flag}</span>
                                                <div className="flex-1 min-w-0">
                                                    <div className="font-medium truncate">{location.name}</div>
                                                    {location.category !== 'Countries' && (
                                                        <div className="text-xs text-gray-500">{location.category}</div>
                                                    )}
                                                </div>
                                                {value === location.id && (
                                                    <svg className="w-4 h-4 text-blue-600" fill="currentColor" viewBox="0 0 20 20">
                                                        <path fillRule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clipRule="evenodd" />
                                                    </svg>
                                                )}
                                            </button>
                                        );
                                    })}
                                </div>
                            ))}

                            {/* No Results */}
                            {searchTerm && filteredLocations.length === 0 && (
                                <div className="p-4 text-center text-gray-500">
                                    <svg className="w-8 h-8 mx-auto mb-2 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M9.172 16.172a4 4 0 015.656 0M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                                    </svg>
                                    <p className="text-sm">No locations found for "{searchTerm}"</p>
                                </div>
                            )}
                        </div>
                    </div>
                )}
            </div>
        );
    };

    const ServiceList = ({ title, dataSet, tooltipText }) => {
        const [serviceData, setServiceData] = useState(null);
        const [loading, setLoading] = useState(true);
        const [error, setError] = useState(null);
        const [selectedLocation, setSelectedLocation] = useState('USA');
        const [expandedService, setExpandedService] = useState(null);
        const [showAll, setShowAll] = useState(false);

        useEffect(() => {
            const cacheKey = `services_${selectedLocation}_${dataSet}`;
            const cachedData = sessionStorage.getItem(cacheKey);
            
            if (cachedData) {
                try {
                    const parsed = JSON.parse(cachedData);
                    setServiceData(parsed);
                    setLoading(false);
                    setError(null);
                    return;
                } catch (e) {
                    // Invalid cache, continue with fresh fetch
                }
            }

            const scriptUrl = `https://script.google.com/macros/s/AKfycbys_HQL8HQdyL_-DoS0Aakvj-IzDWWW5HtNJDiFhbUwgCuKEYJ7N6iZGC-F62I7uZlV/exec?location=${selectedLocation}`;
            setLoading(true);
            setError(null);
            
            fetchWithCorsWorkaround(scriptUrl, (err, data) => {
                if (err) {
                    console.error("ServiceList Fetch Error:", err);
                    setError(err.message);
                    setLoading(false);
                    return;
                }

                if (data.error) {
                    setError(data.error);
                    setLoading(false);
                    return;
                }

                const services = dataSet === 'topServices' ? data.topServices : data.newServices;
                if (services) {
                    // Calculate total volume for percentage
                    const totalVolume = services.reduce((sum, service) => sum + service.totalVolume, 0);
                    const servicesWithPercentage = services.map(service => ({
                        ...service,
                        volumePercentage: totalVolume > 0 ? ((service.totalVolume / totalVolume) * 100).toFixed(1) : 0
                    }));
                    sessionStorage.setItem(cacheKey, JSON.stringify(servicesWithPercentage));
                    setServiceData(servicesWithPercentage);
                }
                setLoading(false);
            });
        }, [selectedLocation, dataSet]);

        if (loading) {
            return (
                <Card className="col-span-12 md:col-span-6">
                    <div className="flex justify-between items-start mb-4">
                        <div className="flex items-center space-x-2">
                            <h2 className="text-xl font-bold text-gray-800">{title}</h2>
                            <InfoTooltip text={tooltipText} />
                        </div>
                        <LocationSelector 
                            value={selectedLocation} 
                            onChange={setSelectedLocation}
                        />
                    </div>
                    <div className="flex items-center justify-center py-8">
                        <p className="text-gray-500">Loading Service Data...</p>
                    </div>
                </Card>
            );
        }
        
        if (error) {
            return (
                <Card className="col-span-12 md:col-span-6">
                    <div className="flex justify-between items-start mb-4">
                        <div className="flex items-center space-x-2">
                            <h2 className="text-xl font-bold text-gray-800">{title}</h2>
                            <InfoTooltip text={tooltipText} />
                        </div>
                        <LocationSelector 
                            value={selectedLocation} 
                            onChange={setSelectedLocation}
                        />
                    </div>
                    <div className="flex items-center justify-center py-8">
                        <p className="text-red-500">Service Error: {error}</p>
                    </div>
                </Card>
            );
        }
        
        if (!serviceData || serviceData.length === 0) {
            return (
                <Card className="col-span-12 md:col-span-6">
                    <div className="flex justify-between items-start mb-4">
                        <div className="flex items-center space-x-2">
                            <h2 className="text-xl font-bold text-gray-800">{title}</h2>
                            <InfoTooltip text={tooltipText} />
                        </div>
                        <LocationSelector 
                            value={selectedLocation} 
                            onChange={setSelectedLocation}
                        />
                    </div>
                    <div className="flex items-center justify-center py-8">
                        <p className="text-gray-500">No service data found for {selectedLocation}.</p>
                    </div>
                </Card>
            );
        }
        
        // Get displayed services based on showAll toggle
        const displayedServices = showAll ? serviceData : serviceData.slice(0, 5);
        
        return (
            <div className="col-span-12 md:col-span-6">
                <div className="bg-white rounded-xl shadow-lg border border-gray-100 overflow-hidden group hover:shadow-xl transition-all duration-300 hover:-translate-y-0.5 hover:scale-[1.003] hover:border-blue-200/60">
                    {/* Header Section */}
                    <div className="bg-gradient-to-r from-blue-50 to-indigo-50 px-6 py-5 border-b border-gray-100">
                        <div className="flex justify-between items-start">
                            <div className="flex items-center space-x-3">
                                <div className="p-2 bg-blue-100 rounded-lg">
                                    <svg className="w-5 h-5 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" />
                                    </svg>
                                </div>
                                <div>
                                    <h2 className="text-xl font-bold text-gray-800">{title}</h2>
                                    <p className="text-sm text-gray-600 mt-1">{displayedServices.length} services • {selectedLocation}</p>
                                </div>
                                <InfoTooltip text={tooltipText} />
                            </div>
                            <LocationSelector 
                                value={selectedLocation} 
                                onChange={setSelectedLocation}
                            />
                        </div>
                    </div>

                    {/* Services List */}
                    <div className="divide-y divide-gray-100">
                        {displayedServices.map((service, index) => (
                            <div key={service.name} className="group">
                                {/* Service Row */}
                                <div 
                                    className="px-6 py-4 hover:bg-gray-50 cursor-pointer transition-colors duration-200"
                                    onClick={() => setExpandedService(expandedService === service.name ? null : service.name)}
                                >
                                    <div className="flex items-center justify-between">
                                        <div className="flex items-center space-x-4 flex-1">
                                            {/* Rank Badge */}
                                            <div className="flex-shrink-0">
                                                <div className={`w-8 h-8 rounded-full flex items-center justify-center text-sm font-bold ${
                                                    index === 0 ? 'bg-yellow-100 text-yellow-700' :
                                                    index === 1 ? 'bg-gray-100 text-gray-700' :
                                                    index === 2 ? 'bg-orange-100 text-orange-700' :
                                                    'bg-blue-100 text-blue-700'
                                                }`}>
                                                    {index + 1}
                                                </div>
                                            </div>
                                            
                                            {/* Service Info */}
                                            <div className="flex-1 min-w-0">
                                                <div className="flex items-center space-x-2">
                                                    <h3 
                                                        className="font-semibold text-gray-900 truncate max-w-xs" 
                                                        title={service.name === 'NAD' ? 'NAD+' : service.name}
                                                    >
                                                        {service.name === 'NAD' ? 'NAD+' : service.name}
                                                    </h3>
                                                    {/* Trend Badge */}
                                                    <div className={`inline-flex items-center px-2 py-1 rounded-full text-xs font-medium ${
                                                        service.trend === 1 ? 'bg-green-100 text-green-700' :
                                                        service.trend === -1 ? 'bg-red-100 text-red-700' :
                                                        'bg-gray-100 text-gray-600'
                                                    }`}>
                                                        {service.trend === 1 && <ArrowUp className="w-3 h-3 mr-1" />}
                                                        {service.trend === -1 && <ArrowDown className="w-3 h-3 mr-1" />}
                                                        {service.trend === 1 ? 'Rising' : service.trend === -1 ? 'Falling' : 'Stable'}
                                                    </div>
                                                </div>
                                                <p className="text-sm text-gray-500 mt-1">
                                                    {service.volumePercentage}% of total volume
                                                </p>
                                            </div>
                                        </div>

                                        {/* Metrics */}
                                        <div className="flex items-center space-x-8 text-sm">
                                            <div className="text-center min-w-0">
                                                <div className="font-semibold text-gray-900 whitespace-nowrap">{service.avgCompetition}</div>
                                                <div className="text-gray-500 text-xs">Competition</div>
                                            </div>
                                            <div className="text-center min-w-0">
                                                <div className="font-semibold text-gray-900 whitespace-nowrap">${service.avgCpc}</div>
                                                <div className="text-gray-500 text-xs">Avg CPC</div>
                                            </div>
                                            <div className="text-center min-w-0">
                                                <div className="font-bold text-lg text-blue-600 whitespace-nowrap">{service.volumePercentage}%</div>
                                                <div className="text-gray-500 text-xs">Volume</div>
                                            </div>
                                        </div>

                                        {/* Expand Arrow */}
                                        <div className="ml-4 flex-shrink-0">
                                            <svg 
                                                className={`w-5 h-5 text-gray-400 transition-transform duration-200 ${
                                                    expandedService === service.name ? 'rotate-180' : ''
                                                }`}
                                                fill="none" 
                                                stroke="currentColor" 
                                                viewBox="0 0 24 24"
                                            >
                                                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M19 9l-7 7-7-7" />
                                            </svg>
                                        </div>
                                    </div>
                                </div>

                                {/* Expanded Keywords Section */}
                                {expandedService === service.name && (
                                    <div className="px-6 py-4 bg-gray-50 border-t border-gray-100">
                                        <div className="space-y-3">
                                            <div className="flex items-center justify-between">
                                                <h4 className="font-semibold text-gray-800 flex items-center">
                                                    <svg className="w-4 h-4 mr-2 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M7 7h.01M7 3h5c.512 0 1.024.195 1.414.586l7 7a2 2 0 010 2.828l-7 7a2 2 0 01-2.828 0l-7-7A1.994 1.994 0 013 12V7a4 4 0 014-4z" />
                                                    </svg>
                                                    Top Keywords for {service.name}
                                                </h4>
                                                <span className="text-sm text-gray-500">
                                                    {service.keywords.length} total keywords
                                                </span>
                                            </div>
                                            
                                            <div className="grid grid-cols-1 md:grid-cols-2 gap-3">
                                                {service.keywords.map((kw, idx) => (
                                                    <div key={idx} className="flex items-center justify-between p-3 bg-white rounded-lg border border-gray-200 hover:border-blue-200 transition-colors">
                                                        <div className="flex items-center space-x-3">
                                                            <div className="w-2 h-2 bg-blue-400 rounded-full"></div>
                                                            <span className="text-sm font-medium text-gray-700">{kw.name}</span>
                                                        </div>
                                                        <div className="text-right flex items-center space-x-2">
                                                            <div>
                                                                <div className="text-sm font-semibold text-gray-900">
                                                                    {kw.volume.toLocaleString()}
                                                                </div>
                                                                <div className="text-xs text-gray-500">searches</div>
                                                            </div>
                                                            <div className="ml-2">
                                                                {kw.trend === 1 && <ArrowUp className="w-3 h-3 text-green-500" title="Increasing" />}
                                                                {kw.trend === -1 && <ArrowDown className="w-3 h-3 text-red-500" title="Decreasing" />}
                                                                {kw.trend === 0 && <span className="text-gray-400 text-xs" title="No Change">-</span>}
                                                            </div>
                                                        </div>
                                                    </div>
                                                ))}
                                            </div>
                                        </div>
                                    </div>
                                )}
                            </div>
                        ))}
                    </div>

                    {/* Footer */}
                    {serviceData.length > 5 && (
                        <div className="px-6 py-4 bg-gray-50 border-t border-gray-100">
                            <button 
                                onClick={() => setShowAll(!showAll)}
                                className="w-full flex items-center justify-center space-x-2 py-2 px-4 bg-white border border-gray-200 rounded-lg hover:bg-gray-50 hover:border-gray-300 transition-colors duration-200 text-sm font-medium text-gray-700"
                            >
                                <span>
                                    {showAll ? 'Show Less' : `Show ${serviceData.length - 5} More Services`}
                                </span>
                                {showAll ? <ChevronUp className="w-4 h-4" /> : <ChevronDown className="w-4 h-4" />}
                            </button>
                        </div>
                    )}
                </div>
            </div>
        );
    };
    
    const [dashboardData, setDashboardData] = useState(null);
    const [loading, setLoading] = useState(true);
    const [error, setError] = useState(null);
    
    // Overview table refresh state management
    const [isOverviewRefreshing, setIsOverviewRefreshing] = useState(false);
    const [overviewRefreshProgress, setOverviewRefreshProgress] = useState(0);
    const [overviewRefreshMessage, setOverviewRefreshMessage] = useState('');
    const overviewPollIntervalRef = useRef(null);
    const overviewRefreshStartTimeRef = useRef(null);

    // Cleanup polling on unmount
    useEffect(() => {
        return () => {
            if (overviewPollIntervalRef.current) {
                clearInterval(overviewPollIntervalRef.current);
            }
        };
    }, []);

    // Overview table refresh functionality
    const triggerOverviewRefresh = async () => {
        // Prevent multiple simultaneous refreshes
        if (isOverviewRefreshing) {
            console.log('Overview refresh already in progress, ignoring request');
            return;
        }
        
        console.log('Overview table refresh triggered');
        
        const webhooks = {
            onPageInsights: 'https://hook.us1.make.com/rytnhogl86u66kb84c8x4jvb9crkhwwv',
            gbpInsights: 'https://hook.us1.make.com/njgvoslc2tis3l5dkm1smswmwlvs91pb',
            facebookAds: 'https://hook.us1.make.com/rc54yq5e4b6erln6qbyltcbswgul4vj7',
            googleAds: 'https://justchill.app.n8n.cloud/webhook/718a9a18-d40f-4240-a381-761ca4ec4f82'
        };
        
        setIsOverviewRefreshing(true);
        setOverviewRefreshProgress(5);
        setOverviewRefreshMessage('Triggering overview automation...');
        overviewRefreshStartTimeRef.current = Date.now();

        try {
            // Get the workbook ID from URL parameters
            const params = new URLSearchParams(window.location.search);
            const workbookId = params.get('workbookId');
            
            if (!workbookId) {
                throw new Error('No workbook ID found in URL');
            }

            // Trigger all four webhooks in parallel
            const webhookPromises = [
                fetch(`${webhooks.onPageInsights}?spreadsheetId=${workbookId}&tabName=${encodeURIComponent('On-Page Insights')}`, { method: 'GET', mode: 'no-cors' }),
                fetch(`${webhooks.gbpInsights}?spreadsheetId=${workbookId}&tabName=${encodeURIComponent('GBP Insights')}`, { method: 'GET', mode: 'no-cors' }),
                fetch(`${webhooks.facebookAds}?spreadsheetId=${workbookId}&tabName=${encodeURIComponent('Links')}`, { method: 'GET', mode: 'no-cors' }),
                fetch(`${webhooks.googleAds}?spreadsheetId=${workbookId}&tabName=${encodeURIComponent('Links')}`, { method: 'GET', mode: 'no-cors' })
            ];
            
            console.log('Triggering all overview webhooks:', {
                onPageInsights: `${webhooks.onPageInsights}?spreadsheetId=${workbookId}&tabName=${encodeURIComponent('On-Page Insights')}`,
                gbpInsights: `${webhooks.gbpInsights}?spreadsheetId=${workbookId}&tabName=${encodeURIComponent('GBP Insights')}`,
                facebookAds: `${webhooks.facebookAds}?spreadsheetId=${workbookId}&tabName=${encodeURIComponent('Links')}`,
                googleAds: `${webhooks.googleAds}?spreadsheetId=${workbookId}&tabName=${encodeURIComponent('Links')}`
            });
            
            await Promise.all(webhookPromises);
            
            // Show success message
            console.log('All overview webhooks triggered successfully!');
            
            setOverviewRefreshProgress(15);
            setOverviewRefreshMessage('Overview automation started! Waiting 1 minute before checking for updates...');
            
            // Wait 1 minute before starting to poll for changes
            setTimeout(() => {
                startOverviewPolling();
            }, 60000); // 60 seconds delay
            
        } catch (error) {
            console.error('Error triggering overview refresh:', error);
            setIsOverviewRefreshing(false);
            setOverviewRefreshProgress(0);
            setOverviewRefreshMessage('');
            alert(`Failed to trigger overview refresh: ${error.message}`);
        }
    };

    const startOverviewPolling = () => {
        let attempts = 0;
        const maxAttempts = 3; // Poll for ~3 minutes (60s intervals)
        
        const poll = async () => {
            attempts++;
            const elapsed = (Date.now() - overviewRefreshStartTimeRef.current) / 1000;
            const progress = Math.min(15 + (attempts * 20), 95);
            
            setOverviewRefreshProgress(progress);
            
            let message;
            if (elapsed < 60) {
                message = `Overview automation running... (~60s expected)`;
            } else {
                message = `Checking for data updates...`;
            }
            setOverviewRefreshMessage(message);
            
            try {
                // Check if data has been updated by fetching fresh data
                const params = new URLSearchParams(window.location.search);
                const workbookId = params.get('workbookId');
                
                if (workbookId) {
                    const scriptUrl = `https://script.google.com/macros/s/AKfycbxfOMp8d_eCVH4lFD0PNuFU1wH-gyWOwRt2EuME7GQJ4U73ZwpPDciohDH3C566YLWq/exec?workbookId=${workbookId}`;
                    
                    const response = await fetch(scriptUrl);
                    const newData = await response.json();
                    
                    // Check for changes in overview data only
                    if (newData.dashboard && newData.dashboard.overviewData && hasOverviewDataChanged(dashboardData, newData.dashboard)) {
                        // Data has changed! Stop polling and update only the overview table
                        clearInterval(overviewPollIntervalRef.current);
                        setOverviewRefreshProgress(100);
                        setOverviewRefreshMessage('Overview table updated successfully!');
                        
                        // Update only the overview data in the dashboard, keeping other data intact
                        const updatedDashboardData = {
                            ...dashboardData,
                            overviewData: newData.dashboard.overviewData
                        };
                        
                        // Only update the dashboard cache, don't touch geogrid cache
                        const cacheKey = `dashboard_data_${workbookId}`;
                        sessionStorage.setItem(cacheKey, JSON.stringify(updatedDashboardData));
                        
                        setDashboardData(updatedDashboardData);
                        
                        // Clear refresh state after a brief success message
                        setTimeout(() => {
                            setIsOverviewRefreshing(false);
                            setOverviewRefreshProgress(0);
                            setOverviewRefreshMessage('');
                        }, 2000);
                        return;
                    }
                }
            } catch (error) {
                console.error('Error polling for overview updates:', error);
            }
            
            // Auto-refresh after max attempts
            if (attempts >= maxAttempts) {
                clearInterval(overviewPollIntervalRef.current);
                setOverviewRefreshProgress(100);
                setOverviewRefreshMessage('Automation complete! Refreshing with latest data...');
                
                try {
                    const params = new URLSearchParams(window.location.search);
                    const workbookId = params.get('workbookId');
                    
                    if (workbookId) {
                        const scriptUrl = `https://script.google.com/macros/s/AKfycbxfOMp8d_eCVH4lFD0PNuFU1wH-gyWOwRt2EuME7GQJ4U73ZwpPDciohDH3C566YLWq/exec?workbookId=${workbookId}`;
                        
                        fetch(scriptUrl)
                            .then(response => response.json())
                            .then(finalData => {
                                if (finalData.dashboard && finalData.dashboard.overviewData) {
                                    // Update only the overview data, keeping other data intact
                                    const updatedDashboardData = {
                                        ...dashboardData,
                                        overviewData: finalData.dashboard.overviewData
                                    };
                                    
                                    // Only update the dashboard cache, don't touch geogrid cache
                                    const cacheKey = `dashboard_data_${workbookId}`;
                                    sessionStorage.setItem(cacheKey, JSON.stringify(updatedDashboardData));
                                    
                                    setDashboardData(updatedDashboardData);
                                    console.log('Fallback: Overview table data refreshed after timeout');
                                    
                                    setTimeout(() => {
                                        setIsOverviewRefreshing(false);
                                        setOverviewRefreshProgress(0);
                                        setOverviewRefreshMessage('');
                                    }, 1500);
                                } else {
                                    setIsOverviewRefreshing(false);
                                    setOverviewRefreshProgress(0);
                                    setOverviewRefreshMessage('');
                                }
                            })
                            .catch(e => {
                                console.log('Fallback failed:', e);
                                setIsOverviewRefreshing(false);
                                setOverviewRefreshProgress(0);
                                setOverviewRefreshMessage('');
                            });
                    } else {
                        setIsOverviewRefreshing(false);
                        setOverviewRefreshProgress(0);
                        setOverviewRefreshMessage('');
                    }
                } catch (error) {
                    console.error('Error in fallback:', error);
                    setIsOverviewRefreshing(false);
                    setOverviewRefreshProgress(0);
                    setOverviewRefreshMessage('');
                }
            }
        };
        
        // Start with immediate poll, then continue with 60-second intervals
        overviewPollIntervalRef.current = setInterval(poll, 60000);
        
        // Poll immediately to start
        poll();
    };

    const hasOverviewDataChanged = (oldData, newData) => {
        // Check if any key overview data has changed
        const hasChanges = (
            JSON.stringify(oldData?.overviewData) !== JSON.stringify(newData?.overviewData) ||
            oldData?.aiReport !== newData?.aiReport ||
            oldData?.censusData !== newData?.censusData
        );
        
        console.log('Overview change detected:', hasChanges);
        return hasChanges;
    };

    useEffect(() => {
        const params = new URLSearchParams(window.location.search);
        const workbookId = params.get('workbookId');
        if (!workbookId) {
            setError("No workbook ID provided");
            setLoading(false);
            return;
        }

        // Use a single cache key for all dashboard data
        const cacheKey = `dashboard_data_${workbookId}`;
        const cachedData = sessionStorage.getItem(cacheKey);
        if (cachedData) {
            try {
                const parsed = JSON.parse(cachedData);
                setDashboardData(parsed);
                setLoading(false);
                return;
            } catch (e) {
                // Invalid cache, continue with fresh fetch
            }
        }

        const scriptUrl = `https://script.google.com/macros/s/AKfycbxfOMp8d_eCVH4lFD0PNuFU1wH-gyWOwRt2EuME7GQJ4U73ZwpPDciohDH3C566YLWq/exec?workbookId=${workbookId}`;
        
        fetchWithCorsWorkaround(scriptUrl, (err, data) => {
            if (err) {
                setError(err.message);
                setLoading(false);
                return;
            }
            if (data.error) {
                setError(`Script error: ${data.error}`);
                setLoading(false);
                return;
            }
            
            const dashboard = data.dashboard;
            if (dashboard) {
                sessionStorage.setItem(cacheKey, JSON.stringify(dashboard));
            }
            setDashboardData(dashboard);
            setLoading(false);
        });
    }, []);

    return (
        <PageContent>
            <div className="grid grid-cols-12 gap-6">
                <GeogridSection setActiveTab={setActiveTab} />
                <CensusInfo censusData={dashboardData?.censusData} loading={loading} error={error} />
                <OverviewTable 
                    overviewData={dashboardData?.overviewData} 
                    loading={loading} 
                    error={error}
                    onRefresh={triggerOverviewRefresh}
                    isRefreshing={isOverviewRefreshing}
                    refreshProgress={overviewRefreshProgress}
                    refreshMessage={overviewRefreshMessage}
                />
                
                {!loading && !error && dashboardData?.aiReport && (
                    <div className="col-span-12">
                       <AIReportSection reportText={dashboardData.aiReport} title="SWOT Analysis" />
                    </div>
                )}

                <ServiceList title="Services by Search Volume" dataSet="topServices" tooltipText="Lists the most popular, established MedSpa services based on monthly search volume in the selected geographic area." />
                <ServiceList title="New Services by Search Volume" dataSet="newServices" tooltipText="Highlights emerging or newer services with growing search interest, indicating potential new market opportunities." />
            </div>
        </PageContent>
    );
};

/* ------------------------------------------------------------------ */
/* KEYWORDS PAGE – full live version                                  */
/* ------------------------------------------------------------------ */
const Keywords = ({ summary, table, webhooks, setData }) => {
    const [active, setActive] = useState('');
    const [searchTerm, setSearchTerm] = useState('');
    const [currentMonthIndex, setCurrentMonthIndex] = useState(0);
    const [keywordsData, setKeywordsData] = useState(null);
    const siteNames = Object.keys(table);
    
    // Refresh state management
    const [isRefreshing, setIsRefreshing] = useState(false);
    const [refreshProgress, setRefreshProgress] = useState(0);
    const [refreshMessage, setRefreshMessage] = useState('');
    const [lastRefresh, setLastRefresh] = useState(null);
    const pollIntervalRef = useRef(null);
    const refreshStartTimeRef = useRef(null);
    
    // Set initial active site to the first one
    useEffect(() => {
        if (!active && siteNames.length > 0) {
            setActive(siteNames[0]);
        }
    }, [siteNames]);

    // Fetch keywords archive data on component mount
    useEffect(() => {
        const params = new URLSearchParams(window.location.search);
        const workbookId = params.get('workbookId');
        if (!workbookId) {
            return;
        }

        // Check cache first
        const cacheKey = `keywords_${workbookId}`;
        const cachedData = sessionStorage.getItem(cacheKey);
        if (cachedData) {
            try {
                const parsed = JSON.parse(cachedData);
                setKeywordsData(parsed);
                return;
            } catch (e) {
                // Invalid cache, continue with fresh fetch
            }
        }

        const scriptUrl = `https://script.google.com/macros/s/AKfycbxfOMp8d_eCVH4lFD0PNuFU1wH-gyWOwRt2EuME7GQJ4U73ZwpPDciohDH3C566YLWq/exec?workbookId=${workbookId}`;
        
        fetchWithCorsWorkaround(scriptUrl, (err, data) => {
            if (err) {
                console.error('Error fetching keywords data:', err);
                return;
            }
            if (data.error) {
                console.error('Script error:', data.error);
                return;
            }
            
            const keywords = {
                keywordsSummary: data.keywordsSummary,
                keywordsTable: data.keywordsTable,
                keywordsSummaryArchive: data.keywordsSummaryArchive || []
            };
            
            if (keywords.keywordsSummary && keywords.keywordsTable) {
                sessionStorage.setItem(cacheKey, JSON.stringify(keywords));
            }
            setKeywordsData(keywords);
        });
    }, []);

    // Cleanup polling on unmount
    useEffect(() => {
        return () => {
            if (pollIntervalRef.current) {
                clearInterval(pollIntervalRef.current);
            }
        };
    }, []);

    // Refresh functionality
    const triggerRefresh = async () => {
        console.log('Keywords refresh - Webhooks data:', webhooks);
        
        if (!webhooks || !webhooks['Keywords']) {
            alert('Keywords refresh webhook not configured for this workbook');
            console.log('Keywords webhook check failed. Webhooks:', webhooks);
            return;
        }

        setIsRefreshing(true);
        setRefreshProgress(5);
        setRefreshMessage('Triggering keywords automation...');
        refreshStartTimeRef.current = Date.now();

        try {
            // Get the workbook ID from URL parameters
            const params = new URLSearchParams(window.location.search);
            const workbookId = params.get('workbookId');
            
            if (!workbookId) {
                throw new Error('No workbook ID found in URL');
            }

            // Construct the webhook URL with required parameters
            const baseWebhookUrl = webhooks['Keywords'];
            const webhookUrl = `${baseWebhookUrl}?spreadsheetId=${workbookId}&tabName=${encodeURIComponent('Keywords Archive')}`;
            
            console.log('Triggering keywords webhook:', webhookUrl);
            
            const response = await fetch(webhookUrl, {
                method: 'GET',
                mode: 'no-cors' // Many webhooks don't support CORS
            });
            
            // Show success message
            console.log('Keywords webhook triggered successfully!');
            
            setRefreshProgress(15);
            setRefreshMessage('Keywords automation started! (~10s expected)...');
            
            // Start polling for data changes
            startPolling();
            
        } catch (error) {
            console.error('Error triggering keywords refresh:', error);
            setIsRefreshing(false);
            setRefreshProgress(0);
            setRefreshMessage('');
            alert(`Failed to trigger keywords refresh: ${error.message}`);
        }
    };

    const startPolling = () => {
        let attempts = 0;
        const maxAttempts = 4; // Poll for ~20 seconds (5s intervals), then fallback to auto-refresh
        
        const poll = async () => {
            attempts++;
            const elapsed = (Date.now() - refreshStartTimeRef.current) / 1000;
            const progress = Math.min(15 + (attempts * 20), 95);
            
            setRefreshProgress(progress);
            
            // Simple messaging without exposing timeout details
            let message;
            if (elapsed < 15) {
                message = `Keywords automation running... (~10s expected)`;
            } else {
                message = `Checking for data updates...`;
            }
            setRefreshMessage(message);
            
            try {
                // Check if data has been updated by fetching fresh data
                const params = new URLSearchParams(window.location.search);
                const workbookId = params.get('workbookId');
                
                if (workbookId) {
                    const scriptUrl = `https://script.google.com/macros/s/AKfycbxfOMp8d_eCVH4lFD0PNuFU1wH-gyWOwRt2EuME7GQJ4U73ZwpPDciohDH3C566YLWq/exec?workbookId=${workbookId}`;
                    
                    const response = await fetch(scriptUrl);
                    const newData = await response.json();
                    
                                         // Check for changes in keywords data
                     if (newData.keywordsSummary && newData.keywordsTable && hasKeywordsDataChanged(summary, table, newData.keywordsSummary, newData.keywordsTable)) {
                         // Data has changed! Stop polling and update in-place
                         clearInterval(pollIntervalRef.current);
                         setRefreshProgress(100);
                         setRefreshMessage('Keywords Archive updated! Loading fresh data...');
                         
                         // Update the data in-place
                         setData(newData);
                         setLastRefresh(new Date());
                         
                         // Update keywords archive data
                         const newKeywordsData = {
                             keywordsSummary: newData.keywordsSummary,
                             keywordsTable: newData.keywordsTable,
                             keywordsSummaryArchive: newData.keywordsSummaryArchive || []
                         };
                         
                         // Update cache
                         const params = new URLSearchParams(window.location.search);
                         const workbookId = params.get('workbookId');
                         if (workbookId) {
                             const cacheKey = `keywords_${workbookId}`;
                             sessionStorage.setItem(cacheKey, JSON.stringify(newKeywordsData));
                         }
                         
                         setKeywordsData(newKeywordsData);
                         
                         // Clear refresh state after a brief success message
                         setTimeout(() => {
                             setIsRefreshing(false);
                             setRefreshProgress(0);
                             setRefreshMessage('');
                         }, 2000);
                         return;
                     }
                }
            } catch (error) {
                console.error('Error polling for keywords updates:', error);
            }
            
            // Hybrid approach: After max attempts, auto-refresh with latest data
            if (attempts >= maxAttempts) {
                clearInterval(pollIntervalRef.current);
                setRefreshProgress(100);
                setRefreshMessage('Automation complete! Refreshing with latest data...');
                
                // Auto-refresh after timeout - fetch the latest data regardless
                try {
                    const params = new URLSearchParams(window.location.search);
                    const workbookId = params.get('workbookId');
                    
                    if (workbookId) {
                        const scriptUrl = `https://script.google.com/macros/s/AKfycbxfOMp8d_eCVH4lFD0PNuFU1wH-gyWOwRt2EuME7GQJ4U73ZwpPDciohDH3C566YLWq/exec?workbookId=${workbookId}`;
                        
                        fetch(scriptUrl)
                            .then(response => response.json())
                            .then(finalData => {
                                if (finalData.keywordsSummary && finalData.keywordsTable) {
                                    setData(finalData);
                                    setLastRefresh(new Date());
                                    console.log('Hybrid fallback: Keywords data refreshed after timeout');
                                    
                                    // Update keywords archive data
                                    const finalKeywordsData = {
                                        keywordsSummary: finalData.keywordsSummary,
                                        keywordsTable: finalData.keywordsTable,
                                        keywordsSummaryArchive: finalData.keywordsSummaryArchive || []
                                    };
                                    
                                    // Update cache
                                    const params = new URLSearchParams(window.location.search);
                                    const workbookId = params.get('workbookId');
                                    if (workbookId) {
                                        const cacheKey = `keywords_${workbookId}`;
                                        sessionStorage.setItem(cacheKey, JSON.stringify(finalKeywordsData));
                                    }
                                    
                                    setKeywordsData(finalKeywordsData);
                                    
                                    // Clear refresh state after updating
                                    setTimeout(() => {
                                        setIsRefreshing(false);
                                        setRefreshProgress(0);
                                        setRefreshMessage('');
                                    }, 1500);
                                } else {
                                    // Fallback failed, clear state
                                    setIsRefreshing(false);
                                    setRefreshProgress(0);
                                    setRefreshMessage('');
                                }
                            })
                            .catch(e => {
                                console.log('Hybrid fallback failed:', e);
                                setIsRefreshing(false);
                                setRefreshProgress(0);
                                setRefreshMessage('');
                            });
                    } else {
                        setIsRefreshing(false);
                        setRefreshProgress(0);
                        setRefreshMessage('');
                    }
                } catch (error) {
                    console.error('Error in hybrid fallback:', error);
                    setIsRefreshing(false);
                    setRefreshProgress(0);
                    setRefreshMessage('');
                }
            }
        };
        
        // Start with immediate poll, then continue with 5-second intervals for faster detection
        pollIntervalRef.current = setInterval(poll, 5000);
        
        // Poll immediately to start
        poll();
    };

    const hasKeywordsDataChanged = (oldSummary, oldTable, newSummary, newTable) => {
        // Hybrid approach: Check for actual keyword data changes in individual entries
        let hasActualChanges = false;
        
        // Check if any keyword data has actually changed (positions, URLs, etc.)
        Object.keys(oldTable || {}).forEach(siteName => {
            const oldKeywords = oldTable[siteName] || [];
            const newKeywords = newTable[siteName] || [];
            
            // Quick check - different number of keywords
            if (oldKeywords.length !== newKeywords.length) {
                console.log(`Keywords count changed for ${siteName}: ${oldKeywords.length} -> ${newKeywords.length}`);
                hasActualChanges = true;
                return;
            }
            
            // Deeper check - compare first few keyword entries for changes
            const checkCount = Math.min(5, oldKeywords.length); // Check first 5 keywords
            for (let i = 0; i < checkCount; i++) {
                const oldKw = oldKeywords[i];
                const newKw = newKeywords[i];
                
                if (oldKw && newKw) {
                    // Check key fields that would indicate fresh data
                    if (oldKw.rank_now !== newKw.rank_now || 
                        oldKw.rank_prev !== newKw.rank_prev ||
                        oldKw.ranking_url !== newKw.ranking_url ||
                        oldKw.ranking_title !== newKw.ranking_title) {
                        console.log(`Keyword data changed for ${siteName}: ${oldKw.keyword} position ${oldKw.rank_now} -> ${newKw.rank_now}`);
                        hasActualChanges = true;
                        return;
                    }
                }
            }
        });
        
        // Also check summary changes as backup
        const hasSummaryChanges = (
            parseInt(oldSummary?.totalKeywords) !== parseInt(newSummary?.totalKeywords) ||
            parseInt(oldSummary?.pos1) !== parseInt(newSummary?.pos1) ||
            parseInt(oldSummary?.isNew) !== parseInt(newSummary?.isNew) ||
            parseInt(oldSummary?.isUp) !== parseInt(newSummary?.isUp) ||
            parseInt(oldSummary?.isDown) !== parseInt(newSummary?.isDown) ||
            parseInt(oldSummary?.isLost) !== parseInt(newSummary?.isLost)
        );
        
        const hasChanges = hasActualChanges || hasSummaryChanges;
        
        console.log('Keywords change detection:', {
            actualDataChanges: hasActualChanges,
            summaryChanges: hasSummaryChanges,
            overallChange: hasChanges
        });
        
        return hasChanges;
    };

    const cancelRefresh = () => {
        if (pollIntervalRef.current) {
            clearInterval(pollIntervalRef.current);
        }
        setIsRefreshing(false);
        setRefreshProgress(0);
        setRefreshMessage('');
    };

    // Icons
    const Search = createIcon(
        <>
            <circle cx="11" cy="11" r="8" />
            <line x1="21" y1="21" x2="16.65" y2="16.65" />
        </>
    );
    const ExternalLink = createIcon(
        <>
            <path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6" />
            <polyline points="15 3 21 3 21 9" />
            <line x1="10" y1="14" x2="21" y2="3" />
        </>
    );

    // Reusable component for each stat in the summary
    const SummaryStat = ({ label, value, color, icon, valuePrefix = '' }) => (
        <div className="flex items-center justify-between p-3 bg-slate-50 rounded-lg transition-all hover:shadow-md hover:bg-white">
            <div className="flex items-center">
                {icon && <div className="mr-3 text-gray-400">{icon}</div>}
                <span className="text-sm text-gray-600 font-medium">{label}</span>
            </div>
            <span className={`text-lg font-bold ${color}`}>
                {value > 0 ? valuePrefix : ''}{value}
            </span>
        </div>
    );

    // Format number with fallback
    const formatNumber = (num) => {
        if (num === undefined || num === null) return '-';
        return typeof num === 'number' ? num.toLocaleString() : num;
    };

    // Format currency with fallback
    const formatCurrency = (num) => {
        if (num === undefined || num === null) return '-';
        return typeof num === 'number' ? `$${num.toFixed(2)}` : num;
    };

    // Process archive data for month slider
    const processedArchiveData = keywordsData?.keywordsSummaryArchive && keywordsData.keywordsSummaryArchive.length > 0 
        ? keywordsData.keywordsSummaryArchive.map((item, index) => {
            let parsedDate = null;
            
            // Try to use the backend's parsedDate if available
            if (item.parsedDate) {
                parsedDate = new Date(item.parsedDate);
            }
            
            // If parsedDate is invalid or not available, try other approaches
            if (!parsedDate || isNaN(parsedDate.getTime())) {
                if (item.date) {
                    parsedDate = new Date(item.date);
                    
                    // If that fails, try US date format parsing
                    if (isNaN(parsedDate.getTime())) {
                        const dateStr = item.date.toString();
                        const parts = dateStr.split('/');
                        if (parts.length === 3) {
                            const month = parseInt(parts[0]) - 1;
                            const day = parseInt(parts[1]);
                            const year = parseInt(parts[2]);
                            parsedDate = new Date(year, month, day);
                        }
                    }
                }
                
                if ((!parsedDate || isNaN(parsedDate.getTime())) && item.rawDate) {
                    parsedDate = new Date(item.rawDate);
                    
                    if (isNaN(parsedDate.getTime())) {
                        const dateStr = item.rawDate.toString();
                        const parts = dateStr.split('/');
                        if (parts.length === 3) {
                            const month = parseInt(parts[0]) - 1;
                            const day = parseInt(parts[1]);
                            const year = parseInt(parts[2]);
                            parsedDate = new Date(year, month, day);
                        }
                    }
                }
            }
            
            const formattedDate = parsedDate && !isNaN(parsedDate.getTime()) 
                ? parsedDate.toLocaleString('default', { month: 'long', year: 'numeric' })
                : item.date;
            
            return {
                ...item,
                date: formattedDate,
                parsedDate: parsedDate
            };
        }).sort((a, b) => {
            // Sort by parsed date (newest first)
            if (a.parsedDate && b.parsedDate) {
                return b.parsedDate.getTime() - a.parsedDate.getTime();
            }
            return 0;
        })
        : [];
    
    // Determine which summary data to use based on current month selection
    const currentSummaryData = processedArchiveData.length > 0 && currentMonthIndex < processedArchiveData.length
        ? processedArchiveData[currentMonthIndex]
        : summary;

    return (
        <PageContent>
            {/* Header Section */}
            <div className="mb-6">
                <div className="flex justify-between items-center">
                    <div>
                        <h1 className="text-3xl font-bold text-gray-800">Keyword Analysis</h1>
                        <p className="text-gray-600 mt-1">Track your keyword rankings and performance metrics</p>
                    </div>
                    <div className="flex items-center space-x-4">
                        {lastRefresh && (
                            <span className="text-sm text-gray-500">
                                Last updated: {lastRefresh.toLocaleTimeString()}
                            </span>
                        )}
                        
                        {/* Inline Progress Indicator */}
                        {isRefreshing && (
                            <div className="flex items-center space-x-3 bg-white rounded-xl shadow-md px-4 py-2 border border-gray-100">
                                <div className="flex items-center space-x-2">
                                    <div className="w-4 h-4 border-2 border-blue-500 border-t-transparent rounded-full animate-spin"></div>
                                    <span className="text-sm font-medium text-gray-700">{refreshMessage}</span>
                                </div>
                                <div className="w-16 bg-gray-200 rounded-full h-2">
                                    <div 
                                        className="bg-gradient-to-r from-blue-500 to-blue-600 h-2 rounded-full transition-all duration-500 ease-out"
                                        style={{ width: `${refreshProgress}%` }}
                                    ></div>
                                </div>
                                <span className="text-xs font-medium text-blue-600 min-w-[2rem]">{refreshProgress}%</span>
                            </div>
                        )}
                        
                        <button 
                            onClick={isRefreshing ? cancelRefresh : triggerRefresh}
                            disabled={!webhooks}
                            className={`px-6 py-2 rounded-xl font-medium transition-all duration-200 shadow-lg hover:shadow-xl ${
                                isRefreshing 
                                    ? 'bg-red-500 hover:bg-red-600 text-white' 
                                    : 'bg-gradient-to-r from-blue-500 to-blue-600 hover:from-blue-600 hover:to-blue-700 text-white'
                            } disabled:opacity-50 disabled:cursor-not-allowed`}
                        >
                            {isRefreshing ? 'Cancel' : 'Update Analytics'}
                        </button>
                    </div>
                </div>
            </div>

            <Card className="mb-6 group hover:shadow-xl transition-all duration-300 hover:-translate-y-0.5 hover:scale-[1.003] hover:border-blue-200/60">
                <div className="flex justify-between items-center mb-4">
                    <div className="flex items-center space-x-2">
                        <h2 className="text-xl font-bold text-gray-800">Keywords Summary</h2>
                        <InfoTooltip text="Overview of your keyword rankings, showing positions, changes, and estimated values." />
                    </div>
                    
                    {/* Month slider controls */}
                    {processedArchiveData.length > 1 && (
                        <div className="flex items-center space-x-3">
                            <button 
                                onClick={() => {
                                    const newIndex = currentMonthIndex + 1;
                                    if (newIndex < processedArchiveData.length) {
                                        setCurrentMonthIndex(newIndex);
                                    }
                                }} 
                                disabled={currentMonthIndex >= processedArchiveData.length - 1}
                                className="flex items-center justify-center w-8 h-8 rounded-lg bg-blue-100 hover:bg-blue-200 disabled:opacity-50 disabled:cursor-not-allowed text-blue-600 transition-colors"
                                title="Go back to older month"
                            >
                                <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M15 19l-7-7 7-7" />
                                </svg>
                            </button>
                            <div className="text-center">
                                <span className="font-semibold text-gray-700 text-sm">
                                    {currentMonthIndex < processedArchiveData.length 
                                        ? processedArchiveData[currentMonthIndex].date 
                                        : 'Current'}
                                </span>
                                <div className="text-xs text-gray-500">
                                    {processedArchiveData.length - currentMonthIndex} of {processedArchiveData.length}
                                </div>
                                <div className="flex items-center justify-center space-x-1 mt-1">
                                    {processedArchiveData.map((_, index) => {
                                        const visualIndex = processedArchiveData.length - 1 - index;
                                        return (
                                            <div
                                                key={index}
                                                className={`w-2 h-2 rounded-full ${
                                                    index === currentMonthIndex 
                                                        ? 'bg-blue-600' 
                                                        : 'bg-gray-300 hover:bg-gray-400'
                                                } cursor-pointer transition-colors`}
                                                onClick={() => setCurrentMonthIndex(index)}
                                                title={`Go to ${processedArchiveData[index]?.date || 'Unknown month'} (${processedArchiveData.length - index} of ${processedArchiveData.length})`}
                                                style={{ order: visualIndex }}
                                            />
                                        );
                                    })}
                                </div>
                            </div>
                            <button 
                                onClick={() => {
                                    const newIndex = currentMonthIndex - 1;
                                    if (newIndex >= 0) {
                                        setCurrentMonthIndex(newIndex);
                                    }
                                }} 
                                disabled={currentMonthIndex <= 0}
                                className="flex items-center justify-center w-8 h-8 rounded-lg bg-blue-100 hover:bg-blue-200 disabled:opacity-50 disabled:cursor-not-allowed text-blue-600 transition-colors"
                                title="Go forward to newer month"
                            >
                                <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M9 5l7 7-7 7" />
                                </svg>
                            </button>
                        </div>
                    )}
                    
                    {/* Single month display */}
                    {processedArchiveData.length <= 1 && (
                        <span className="font-semibold text-gray-700">
                            {processedArchiveData.length === 1 ? processedArchiveData[0].date : 'Current'}
                        </span>
                    )}
                </div>

                <div className="grid grid-cols-1 lg:grid-cols-3 gap-8">
                    {/* Column 1: Core & Financial Metrics */}
                    <div className="space-y-6 flex flex-col">
                        <div className="p-6 bg-slate-100 rounded-xl text-center flex-grow flex flex-col justify-center">
                            <p className="text-base text-gray-500">Total Keywords Tracked</p>
                            <p className="text-5xl font-bold text-blue-600">{(parseInt(currentSummaryData.totalKeywords) || 0).toLocaleString()}</p>
                            <p className="text-sm text-gray-500 mt-2">
                                <span className={(Number(currentSummaryData.totalKeywordsChange) || 0) >= 0 ? 'text-green-600' : 'text-red-600'}>
                                    {(Number(currentSummaryData.totalKeywordsChange) || 0) >= 0 ? '+' : ''}{Number(currentSummaryData.totalKeywordsChange) || 0}
                                </span> vs prev month
                            </p>
                            </div>
                        <div className="space-y-3">
                            <SummaryStat
                                label="Est. Traffic Value"
                                value={`$${(parseFloat(currentSummaryData.etv) || 0).toFixed(2)}`}
                            color="text-gray-800"
                            />
                            <SummaryStat
                                label="Est. Paid Cost"
                                value={`$${(parseFloat(currentSummaryData.estPaidCost) || 0).toFixed(2)}`}
                                color="text-gray-800"
                            />
                        </div>
                    </div>

                    {/* Column 2: Ranking Distribution */}
                    <div className="space-y-3">
                        <div className="flex items-center space-x-2 px-2 mb-2">
                            <h3 className="text-lg font-semibold text-gray-700">Ranking Distribution</h3>
                            <InfoTooltip text="Shows how many keywords rank in different position ranges. Higher positions (1-3) drive more traffic and are more valuable for SEO." />
                        </div>
                        {(() => {
                            // Comprehensive debug logging for ranking distribution
                            console.log('Full Keywords Summary Object:', currentSummaryData);
                            console.log('All Summary Keys:', Object.keys(currentSummaryData || {}));
                            console.log('Ranking Distribution Debug:', {
                                // Try different possible field names
                                pos1: currentSummaryData.pos1,
                                'Position 1': currentSummaryData['Position 1'],
                                pos2_3: currentSummaryData.pos2_3,
                                'Position 2-3': currentSummaryData['Position 2-3'],
                                'Positions 2-3': currentSummaryData['Positions 2-3'],
                                pos4_10: currentSummaryData.pos4_10,
                                'Position 4-10': currentSummaryData['Position 4-10'],
                                'Positions 4-10': currentSummaryData['Positions 4-10'],
                                pos11_20: currentSummaryData.pos11_20,
                                'Position 11-20': currentSummaryData['Position 11-20'],
                                'Positions 11-20': currentSummaryData['Positions 11-20']
                            });
                            return null;
                        })()}
                        {(() => {
                            // Helper function to get ranking value from different possible field names
                            const getRankingValue = (position) => {
                                const possibleFields = {
                                    pos1: [currentSummaryData.pos1, currentSummaryData['Position 1'], currentSummaryData['Positions 1']],
                                    pos2_3: [currentSummaryData.pos2_3, currentSummaryData['Position 2-3'], currentSummaryData['Positions 2-3']],
                                    pos4_10: [currentSummaryData.pos4_10, currentSummaryData['Position 4-10'], currentSummaryData['Positions 4-10']],
                                    pos11_20: [currentSummaryData.pos11_20, currentSummaryData['Position 11-20'], currentSummaryData['Positions 11-20']]
                                };
                                
                                const values = possibleFields[position] || [];
                                for (let value of values) {
                                    if (value !== undefined && value !== null && value !== '') {
                                        return parseInt(String(value).replace(/[^\d]/g, '')) || 0;
                                    }
                                }
                                return 0;
                            };
                            
                            const pos1Value = getRankingValue('pos1');
                            const pos2_3Value = getRankingValue('pos2_3');
                            const pos4_10Value = getRankingValue('pos4_10');
                            const pos11_20Value = getRankingValue('pos11_20');
                            
                            return (
                                <>
                                    <SummaryStat label="Position 1" value={pos1Value} color={pos1Value > 0 ? 'text-emerald-600' : 'text-gray-500'} />
                                    <SummaryStat label="Positions 2-3" value={pos2_3Value} color={pos2_3Value > 0 ? 'text-emerald-500' : 'text-gray-500'} />
                                    <SummaryStat label="Positions 4-10" value={pos4_10Value} color={pos4_10Value > 0 ? 'text-blue-500' : 'text-gray-500'} />
                                    <SummaryStat label="Positions 11-20" value={pos11_20Value} color={pos11_20Value > 0 ? 'text-yellow-500' : 'text-gray-500'} />
                                </>
                            );
                        })()}
                    </div>

                    {/* Column 3: Keyword Dynamics */}
                    <div className="space-y-3">
                        <div className="flex items-center space-x-2 px-2 mb-2">
                            <h3 className="text-lg font-semibold text-gray-700">Keyword Dynamics</h3>
                            <InfoTooltip text="Tracks keyword movement over time. Shows which keywords are improving, declining, newly ranking, or have been lost since the last update." />
                        </div>
                        <SummaryStat
                            label="Improved"
                            value={parseInt(currentSummaryData.isUp) || 0}
                            color={(parseInt(currentSummaryData.isUp) || 0) > 0 ? 'text-green-600' : 'text-gray-500'}
                            icon={<ArrowUp className="w-5 h-5" />}
                            valuePrefix="+"
                        />
                        <SummaryStat
                            label="New"
                            value={parseInt(currentSummaryData.isNew) || 0}
                            color={(parseInt(currentSummaryData.isNew) || 0) > 0 ? 'text-blue-600' : 'text-gray-500'}
                            icon={<Star className="w-5 h-5 text-blue-500" fill="currentColor"/>}
                        />
                        <SummaryStat
                            label="Declined"
                            value={parseInt(currentSummaryData.isDown) || 0}
                            color={(parseInt(currentSummaryData.isDown) || 0) > 0 ? 'text-red-600' : 'text-gray-500'}
                            icon={<ArrowDown className="w-5 h-5" />}
                        />
                        <SummaryStat
                            label="Lost"
                            value={parseInt(currentSummaryData.isLost) || 0}
                            color={(parseInt(currentSummaryData.isLost) || 0) > 0 ? 'text-red-600' : 'text-gray-500'}
                            icon={<XCircle className="w-5 h-5" />}
                        />
                    </div>
                </div>
            </Card>

            <Card className="group hover:shadow-xl transition-all duration-300 hover:-translate-y-0.5 hover:scale-[1.003] hover:border-blue-200/60">
                                <div className="flex items-center space-x-2 mb-4">
                    <h2 className="text-xl font-bold text-gray-800">Keywords</h2>
                    <InfoTooltip text="Analyze keyword rankings for your site and competitors. Use the tabs to switch between different sites." />
                </div>

                <div className="mb-4">
                    <div className="relative">
                        <Search className="absolute left-3 top-1/2 -translate-y-1/2 w-5 h-5 text-gray-400" />
                        <input
                            type="text"
                            placeholder="Search by keyword, URL, or title..."
                            value={searchTerm}
                            onChange={(e) => setSearchTerm(e.target.value)}
                            className="w-full pl-10 pr-4 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500"
                        />
                </div>
                </div>

                <div className="flex space-x-1 mb-4 overflow-x-auto">
                    {siteNames.map(name => (
                        <button
                            key={name}
                            onClick={() => {
                                setActive(name);
                                setSearchTerm('');
                            }}
                            className={`px-4 py-2 text-sm font-medium rounded-lg whitespace-nowrap transition-colors duration-200
                                ${active === name
                                    ? 'bg-green-100 text-green-800'
                                    : 'text-gray-600 hover:bg-gray-100'}`}
                        >
                            {name}
                        </button>
                    ))}
                </div>

                {/* Website Keywords Summary Bar */}
                {active && (
                    <div className="mb-3 py-1.5 px-3 bg-gradient-to-r from-green-50 to-emerald-50 rounded-lg border border-green-200">
                        <div className="flex items-center justify-start space-x-10">
                            {(() => {
                                const siteData = table[active] || [];
                                const totalKeywords = siteData.length;
                                const newKeywords = siteData.filter(kw => kw.is_new).length;
                                const upKeywords = siteData.filter(kw => kw.is_up).length;
                                const downKeywords = siteData.filter(kw => kw.is_down).length;
                                const lostKeywords = siteData.filter(kw => kw.is_lost).length;
                                const avgPosition = siteData.length > 0 && siteData.some(kw => kw.rank_now > 0)
                                    ? (siteData.filter(kw => kw.rank_now > 0).reduce((sum, kw) => sum + (kw.rank_now || 0), 0) / siteData.filter(kw => kw.rank_now > 0).length).toFixed(1)
                                    : 0;
                                const avgVolume = siteData.length > 0 && siteData.some(kw => kw.search_vol > 0)
                                    ? Math.round(siteData.filter(kw => kw.search_vol > 0).reduce((sum, kw) => sum + (kw.search_vol || 0), 0) / siteData.filter(kw => kw.search_vol > 0).length)
                                    : 0;
                                const avgDifficulty = siteData.length > 0 && siteData.some(kw => kw.keyword_difficulty > 0)
                                    ? (siteData.filter(kw => kw.keyword_difficulty > 0).reduce((sum, kw) => sum + (kw.keyword_difficulty || 0), 0) / siteData.filter(kw => kw.keyword_difficulty > 0).length).toFixed(0)
                                    : 0;

                                return (
                                    <>
                                        <div className="flex-1 text-center border-r border-gray-200 pr-5">
                                            <div className="text-base font-bold text-blue-600">{totalKeywords}</div>
                                            <div className="text-xs text-gray-600">Total Keywords</div>
                                        </div>
                                        <div className="flex-1 text-center border-r border-gray-200 pr-5">
                                            <div className="text-base font-bold text-green-600">{newKeywords}</div>
                                            <div className="text-xs text-gray-600">New Keywords</div>
                                        </div>
                                        <div className="flex-1 text-center border-r border-gray-200 pr-5">
                                            <div className="text-base font-bold text-orange-600">{avgPosition}</div>
                                            <div className="text-xs text-gray-600">Avg Position</div>
                                        </div>
                                        <div className="flex-1 text-center border-r border-gray-200 pr-5">
                                            <div className="text-base font-bold text-gray-700">{avgVolume.toLocaleString()}</div>
                                            <div className="text-xs text-gray-600">Avg Volume</div>
                                        </div>
                                        <div className="flex-1 text-center border-r border-gray-200 pr-5">
                                            <div className={`text-base font-bold ${avgDifficulty <= 30 ? 'text-green-600' : avgDifficulty <= 60 ? 'text-yellow-600' : 'text-red-600'}`}>
                                                {avgDifficulty}
                                            </div>
                                            <div className="text-xs text-gray-600">Avg Difficulty</div>
                                        </div>
                                        <div className="flex-1 text-center border-r border-gray-200 pr-5">
                                            <div className="flex justify-center items-center space-x-4">
                                                <div className="text-center">
                                                    <div className="flex items-center justify-center space-x-1">
                                                        <svg className="w-3 h-3 text-green-600" fill="currentColor" viewBox="0 0 20 20">
                                                            <path fillRule="evenodd" d="M5.293 9.707a1 1 0 010-1.414l4-4a1 1 0 011.414 0l4 4a1 1 0 01-1.414 1.414L11 7.414V15a1 1 0 11-2 0V7.414L6.707 9.707a1 1 0 01-1.414 0z" clipRule="evenodd" />
                                                        </svg>
                                                        <div className="text-sm font-bold text-green-600">{upKeywords}</div>
                                                    </div>
                                                    <div className="text-xs text-gray-600">Up</div>
                                                </div>
                                                <div className="text-center">
                                                    <div className="flex items-center justify-center space-x-1">
                                                        <div className="text-sm font-bold text-red-600">{downKeywords}</div>
                                                        <svg className="w-3 h-3 text-red-600" fill="currentColor" viewBox="0 0 20 20">
                                                            <path fillRule="evenodd" d="M14.707 10.293a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 111.414-1.414L9 12.586V5a1 1 0 012 0v7.586l2.293-2.293a1 1 0 011.414 0z" clipRule="evenodd" />
                                                        </svg>
                                                    </div>
                                                    <div className="text-xs text-gray-600">Down</div>
                                                </div>
                                            </div>
                                        </div>
                                    </>
                                );
                            })()}
                        </div>
                    </div>
                )}

                <div className="mt-4 overflow-x-auto">
                    <table className="w-full text-left text-sm whitespace-nowrap">
                        <thead>
                            <tr className="border-b-2 border-gray-200 bg-gray-50">
                                <th className="py-2 px-3">Keyword</th>
                                <th className="py-2 px-3 text-center">Position</th>
                                <th className="py-2 px-3 text-center">Previous</th>
                                <th className="py-2 px-3 text-center">Change</th>
                                <th className="py-2 px-3 text-center">Status</th>
                                <th className="py-2 px-3 text-center">Volume</th>
                                <th className="py-2 px-3 text-center">CPC</th>
                                <th className="py-2 px-3 text-center">Difficulty</th>
                                <th className="py-2 px-3 text-center">Intent</th>
                                <th className="py-2 px-3 text-center">Competition</th>
                                <th className="py-2 px-3">Title</th>
                                <th className="py-2 px-3 text-center">Check</th>
                            </tr>
                        </thead>
                        <tbody>
                            {table[active]?.filter(row =>
                                row.keyword?.toLowerCase().includes(searchTerm.toLowerCase()) ||
                                row.ranking_url?.toLowerCase().includes(searchTerm.toLowerCase()) ||
                                row.ranking_title?.toLowerCase().includes(searchTerm.toLowerCase())
                            )?.map((row, index) => (
                                <tr key={index} className="border-b border-gray-100 hover:bg-slate-50">
                                    <td className="py-3 px-3 font-medium">{row.keyword}</td>
                                    <td className="py-3 px-3 text-center font-medium">
                                        <span className={`inline-block px-2 py-1 rounded-full text-xs font-semibold
                                            ${row.rank_now <= 1 ? 'bg-emerald-100 text-emerald-800' :
                                            row.rank_now <= 3 ? 'bg-emerald-50 text-emerald-700' :
                                            row.rank_now <= 10 ? 'bg-blue-50 text-blue-700' :
                                            'bg-yellow-50 text-yellow-700'}`}>
                                            {formatNumber(row.rank_now)}
                                        </span>
                                    </td>
                                    <td className="py-3 px-3 text-center">{formatNumber(row.rank_prev) || '-'}</td>
                                    <td className="py-3 px-3 text-center">
                                        {row.rank_prev && row.rank_now ? (
                                            <span className={
                                                row.rank_prev > row.rank_now ? 'text-green-600' :
                                                row.rank_prev < row.rank_now ? 'text-red-600' :
                                                'text-gray-400'
                                            }>
                                                {row.rank_prev > row.rank_now ? '+' : ''}{row.rank_prev - row.rank_now || '-'}
                                            </span>
                                        ) : '-'}
                                    </td>
                                    <td className="py-3 px-3 text-center">
                                        {row.is_new ? (
                                            <span className="text-xs font-semibold px-2 py-1 bg-blue-100 text-blue-800 rounded-full">New</span>
                                        ) : row.is_lost ? (
                                            <span className="text-xs font-semibold px-2 py-1 bg-red-100 text-red-800 rounded-full">Lost</span>
                                        ) : row.is_up ? (
                                            <span className="text-xs font-semibold px-2 py-1 bg-green-100 text-green-800 rounded-full">Up</span>
                                        ) : row.is_down ? (
                                            <span className="text-xs font-semibold px-2 py-1 bg-yellow-100 text-yellow-800 rounded-full">Down</span>
                                        ) : (
                                            <span className="text-gray-400">-</span>
                                        )}
                                    </td>
                                    <td className="py-3 px-3 text-center">{formatNumber(row.search_vol)}</td>
                                    <td className="py-3 px-3 text-center">{formatCurrency(row.cpc_usd)}</td>
                                    <td className="py-3 px-3 text-center">
                                        <span className={`px-2 py-1 rounded-full text-xs font-semibold
                                            ${row.keyword_difficulty <= 30 ? 'bg-green-100 text-green-800' :
                                            row.keyword_difficulty <= 60 ? 'bg-yellow-100 text-yellow-800' :
                                            'bg-red-100 text-red-800'}`}>
                                            {row.keyword_difficulty || '-'}
                                        </span>
                                    </td>
                                    <td className="py-3 px-3 text-center">
                                        <span className={`px-2 py-1 rounded-full text-xs font-semibold
                                            ${row.intent === 'commercial' ? 'bg-green-100 text-green-800' :
                                            row.intent === 'informational' ? 'bg-blue-100 text-blue-800' :
                                            row.intent === 'navigational' ? 'bg-purple-100 text-purple-800' :
                                            'bg-gray-100 text-gray-800'}`}>
                                            {row.intent || '-'}
                                        </span>
                                    </td>
                                    <td className="py-3 px-3 text-center">
                                        <span className={`px-2 py-1 rounded-full text-xs font-semibold
                                            ${row.competition_lvl === 'low' ? 'bg-green-100 text-green-800' :
                                            row.competition_lvl === 'medium' ? 'bg-yellow-100 text-yellow-800' :
                                            row.competition_lvl === 'high' ? 'bg-red-100 text-red-800' :
                                            'bg-gray-100 text-gray-800'}`}>
                                            {row.competition_lvl || '-'}
                                        </span>
                                    </td>
                                    <td className="py-3 px-3 text-gray-600 max-w-xs truncate" title={row.ranking_title}>
                                        {row.ranking_title || '-'}
                                    </td>
                                    <td className="py-3 px-3 text-center">
                                        {row.check_url && (
                                            <a href={row.check_url} target="_blank" rel="noopener noreferrer" className="text-blue-600 hover:text-blue-800 inline-block">
                                                <ExternalLink className="w-4 h-4" />
                                            </a>
                                        )}
                                    </td>
                                </tr>
                            ))}
                        </tbody>
                    </table>
                    {table[active]?.filter(row =>
                        row.keyword?.toLowerCase().includes(searchTerm.toLowerCase()) ||
                        row.ranking_url?.toLowerCase().includes(searchTerm.toLowerCase()) ||
                        row.ranking_title?.toLowerCase().includes(searchTerm.toLowerCase())
                    )?.length === 0 && (
                        <div className="text-center py-8 text-gray-500">
                            No matching keywords found for "{searchTerm}"
                        </div>
                    )}
                </div>
            </Card>
        </PageContent>
    );
};

const Backlinks = () => {
    // Destructure chart components here, as they are only used in this component.
    const { PieChart, Pie, Cell, ResponsiveContainer, Tooltip, BarChart, Bar, XAxis, YAxis, CartesianGrid } = window.Recharts;

    // --- Additional Icon Components for this page ---
    const PlusCircle = createIcon(
      <>
        <circle cx="12" cy="12" r="10" />
        <line x1="12" y1="8" x2="12" y2="16" />
        <line x1="8" y1="12" x2="16" y2="12" />
      </>
    );
    const MinusCircle = createIcon(
      <>
        <circle cx="12" cy="12" r="10" />
        <line x1="8" y1="12" x2="16" y2="12" />
      </>
    );
    const Search = createIcon(
      <>
        <circle cx="11" cy="11" r="8" />
        <line x1="21" y1="21" x2="16.65" y2="16.65" />
      </>
    );
    const ExternalLink = createIcon(
      <>
        <path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6" />
        <polyline points="15 3 21 3 21 9" />
        <line x1="10" y1="14" x2="21" y2="3" />
      </>
    );
    const LinkIcon = createIcon(
      <>
        <path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71" />
        <path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71" />
      </>
    );
    const ShieldCheck = createIcon(
      <>
        <path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z" />
        <path d="M9 12l2 2 4-4" />
      </>
    );
    const Globe = createIcon(
      <>
        <circle cx="12" cy="12" r="10" />
        <line x1="2" y1="12" x2="22" y2="12" />
        <path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z" />
      </>
    );

    // --- Component State and Data ---
    const [backlinksData, setBacklinksData] = useState(null);
    const [loading, setLoading] = useState(true);
    const [error, setError] = useState(null);
    const [activeTableTab, setActiveTableTab] = useState('');
    const [searchTerm, setSearchTerm] = useState('');
    const [currentMonthIndex, setCurrentMonthIndex] = useState(0);
    
    // Refresh state management
    const [isRefreshing, setIsRefreshing] = useState(false);
    const [refreshProgress, setRefreshProgress] = useState(0);
    const [refreshMessage, setRefreshMessage] = useState('');
    const [lastRefresh, setLastRefresh] = useState(null);
    const pollIntervalRef = useRef(null);
    const refreshStartTimeRef = useRef(null);

    // Cleanup polling on unmount
    useEffect(() => {
        return () => {
            if (pollIntervalRef.current) {
                clearInterval(pollIntervalRef.current);
            }
        };
    }, []);

    // Refresh functionality
    const triggerRefresh = async () => {
        console.log('Backlinks refresh triggered');
        
        const webhookUrl = 'https://hook.us1.make.com/r6f9bfom4a3tflibf7hdpkuz928klx1p';
        
        setIsRefreshing(true);
        setRefreshProgress(5);
        setRefreshMessage('Triggering backlinks automation...');
        refreshStartTimeRef.current = Date.now();

        try {
            // Get the workbook ID from URL parameters
            const params = new URLSearchParams(window.location.search);
            const workbookId = params.get('workbookId');
            
            if (!workbookId) {
                throw new Error('No workbook ID found in URL');
            }

            // Construct the webhook URL with required parameters
            const fullWebhookUrl = `${webhookUrl}?spreadsheetId=${workbookId}&tabName=${encodeURIComponent('Backlinks')}`;
            
            console.log('Triggering backlinks webhook:', fullWebhookUrl);
            
            const response = await fetch(fullWebhookUrl, {
                method: 'GET',
                mode: 'no-cors' // Many webhooks don't support CORS
            });
            
            // Show success message
            console.log('Backlinks webhook triggered successfully!');
            
            setRefreshProgress(15);
            setRefreshMessage('Backlinks automation started! (~10s expected)...');
            
            // Start polling for data changes
            startPolling();
            
        } catch (error) {
            console.error('Error triggering backlinks refresh:', error);
            setIsRefreshing(false);
            setRefreshProgress(0);
            setRefreshMessage('');
            alert(`Failed to trigger backlinks refresh: ${error.message}`);
        }
    };

    const startPolling = () => {
        let attempts = 0;
        const maxAttempts = 3; // Poll for ~1.5 minutes (30s intervals) since backlinks completes in ~10s
        
        const poll = async () => {
            attempts++;
            const elapsed = (Date.now() - refreshStartTimeRef.current) / 1000;
            const progress = Math.min(15 + (attempts * 20), 95);
            
            setRefreshProgress(progress);
            
            let message;
            if (elapsed < 15) {
                message = `Backlinks automation running... (~10s expected)`;
            } else {
                message = `Checking for data updates...`;
            }
            setRefreshMessage(message);
            
            try {
                // Check if data has been updated by fetching fresh data
                const params = new URLSearchParams(window.location.search);
                const workbookId = params.get('workbookId');
                
                if (workbookId) {
                    const scriptUrl = `https://script.google.com/macros/s/AKfycbxfOMp8d_eCVH4lFD0PNuFU1wH-gyWOwRt2EuME7GQJ4U73ZwpPDciohDH3C566YLWq/exec?workbookId=${workbookId}`;
                    
                    const response = await fetch(scriptUrl);
                    const newData = await response.json();
                    
                    // Check for changes in backlinks data
                    if (newData.backlinksSummary && newData.backlinksTable && hasBacklinksDataChanged(backlinksData, { backlinksSummary: newData.backlinksSummary, backlinksTable: newData.backlinksTable })) {
                        // Data has changed! Stop polling and update in-place
                        clearInterval(pollIntervalRef.current);
                        setRefreshProgress(100);
                        setRefreshMessage('Backlinks updated! Loading fresh data...');
                        
                        // Update the data in-place
                        const newBacklinksData = {
                            backlinksSummary: newData.backlinksSummary,
                            backlinksTable: newData.backlinksTable,
                            backlinksSummaryArchive: newData.backlinksSummaryArchive || []
                        };
                        
                        // Update cache
                        const cacheKey = `backlinks_${workbookId}`;
                        sessionStorage.setItem(cacheKey, JSON.stringify(newBacklinksData));
                        
                        setBacklinksData(newBacklinksData);
                        setLastRefresh(new Date());
                        
                        // Clear refresh state after a brief success message
                        setTimeout(() => {
                            setIsRefreshing(false);
                            setRefreshProgress(0);
                            setRefreshMessage('');
                        }, 2000);
                        return;
                    }
                }
            } catch (error) {
                console.error('Error polling for backlinks updates:', error);
            }
            
            // Auto-refresh after max attempts
            if (attempts >= maxAttempts) {
                clearInterval(pollIntervalRef.current);
                setRefreshProgress(100);
                setRefreshMessage('Automation complete! Refreshing with latest data...');
                
                try {
                    const params = new URLSearchParams(window.location.search);
                    const workbookId = params.get('workbookId');
                    
                    if (workbookId) {
                        const scriptUrl = `https://script.google.com/macros/s/AKfycbxfOMp8d_eCVH4lFD0PNuFU1wH-gyWOwRt2EuME7GQJ4U73ZwpPDciohDH3C566YLWq/exec?workbookId=${workbookId}`;
                        
                        fetch(scriptUrl)
                            .then(response => response.json())
                            .then(finalData => {
                                if (finalData.backlinksSummary && finalData.backlinksTable) {
                                    const finalBacklinksData = {
                                        backlinksSummary: finalData.backlinksSummary,
                                        backlinksTable: finalData.backlinksTable,
                                        backlinksSummaryArchive: finalData.backlinksSummaryArchive || []
                                    };
                                    
                                    // Update cache
                                    const cacheKey = `backlinks_${workbookId}`;
                                    sessionStorage.setItem(cacheKey, JSON.stringify(finalBacklinksData));
                                    
                                    setBacklinksData(finalBacklinksData);
                                    setLastRefresh(new Date());
                                    console.log('Fallback: Backlinks data refreshed after timeout');
                                    
                                    setTimeout(() => {
                                        setIsRefreshing(false);
                                        setRefreshProgress(0);
                                        setRefreshMessage('');
                                    }, 1500);
                                } else {
                                    setIsRefreshing(false);
                                    setRefreshProgress(0);
                                    setRefreshMessage('');
                                }
                            })
                            .catch(e => {
                                console.log('Fallback failed:', e);
                                setIsRefreshing(false);
                                setRefreshProgress(0);
                                setRefreshMessage('');
                            });
                    } else {
                        setIsRefreshing(false);
                        setRefreshProgress(0);
                        setRefreshMessage('');
                    }
                } catch (error) {
                    console.error('Error in fallback:', error);
                    setIsRefreshing(false);
                    setRefreshProgress(0);
                    setRefreshMessage('');
                }
            }
        };
        
        // Start with immediate poll, then continue with 30-second intervals
        pollIntervalRef.current = setInterval(poll, 30000);
        
        // Poll immediately to start
        poll();
    };

    const hasBacklinksDataChanged = (oldData, newData) => {
        // Check if any key backlinks data has changed
        const hasChanges = (
            oldData?.backlinksSummary?.totalBacklinks !== newData?.backlinksSummary?.totalBacklinks ||
            oldData?.backlinksSummary?.newLinks !== newData?.backlinksSummary?.newLinks ||
            oldData?.backlinksSummary?.lostLinks !== newData?.backlinksSummary?.lostLinks ||
            oldData?.backlinksSummary?.totalDofollow !== newData?.backlinksSummary?.totalDofollow ||
            oldData?.backlinksSummary?.totalNofollow !== newData?.backlinksSummary?.totalNofollow ||
            JSON.stringify(oldData?.backlinksTable) !== JSON.stringify(newData?.backlinksTable)
        );
        
        console.log('Backlinks change detected:', hasChanges);
        return hasChanges;
    };

    const cancelRefresh = () => {
        if (pollIntervalRef.current) {
            clearInterval(pollIntervalRef.current);
        }
        setIsRefreshing(false);
        setRefreshProgress(0);
        setRefreshMessage('');
    };

    useEffect(() => {
        const params = new URLSearchParams(window.location.search);
        const workbookId = params.get('workbookId');
        if (!workbookId) {
            setError("No workbook ID provided");
            setLoading(false);
            return;
        }

        // Check cache first
        const cacheKey = `backlinks_${workbookId}`;
        const cachedData = sessionStorage.getItem(cacheKey);
        if (cachedData) {
            try {
                const parsed = JSON.parse(cachedData);
                setBacklinksData(parsed);
                setActiveTableTab(Object.keys(parsed.backlinksTable)[0] || '');
                setLoading(false);
                return;
            } catch (e) {
                // Invalid cache, continue with fresh fetch
            }
        }

        const scriptUrl = `https://script.google.com/macros/s/AKfycbxfOMp8d_eCVH4lFD0PNuFU1wH-gyWOwRt2EuME7GQJ4U73ZwpPDciohDH3C566YLWq/exec?workbookId=${workbookId}`;
        
        fetchWithCorsWorkaround(scriptUrl, (err, data) => {
            if (err) {
                setError(err.message);
                setLoading(false);
                return;
            }
            if (data.error) {
                setError(`Script error: ${data.error}`);
                setLoading(false);
                return;
            }
            
            const backlinks = {
                backlinksSummary: data.backlinksSummary,
                backlinksTable: data.backlinksTable,
                backlinksSummaryArchive: data.backlinksSummaryArchive || []
            };
            
            if (backlinks.backlinksSummary && backlinks.backlinksTable) {
                sessionStorage.setItem(cacheKey, JSON.stringify(backlinks));
                setActiveTableTab(Object.keys(backlinks.backlinksTable)[0] || '');
            }
            setBacklinksData(backlinks);
            setLoading(false);
        });
    }, []);

    if (loading) {
        return <PageContent><div className="p-8 text-center text-gray-500">Loading backlinks data...</div></PageContent>;
    }
    if (error) {
        return <PageContent><div className="p-8 text-center text-red-500">Backlinks Error: {error}</div></PageContent>;
    }
    if (!backlinksData || !backlinksData.backlinksSummary || !backlinksData.backlinksTable) {
        return <PageContent><div className="p-8 text-center text-gray-500">No backlinks data available.</div></PageContent>;
    }

    const { backlinksSummary, backlinksTable, backlinksSummaryArchive } = backlinksData;
    const siteNames = Object.keys(backlinksTable);
    
    // Process historical data with date formatting (similar to geogrid)
    const processedArchiveData = backlinksSummaryArchive && backlinksSummaryArchive.length > 0 
        ? backlinksSummaryArchive.map((item, index) => {
            let parsedDate = null;
            
            // Try to use the backend's parsedDate if available
            if (item.parsedDate) {
                parsedDate = new Date(item.parsedDate);
            }
            
            // If parsedDate is invalid or not available, try other approaches
            if (!parsedDate || isNaN(parsedDate.getTime())) {
                if (item.date) {
                    parsedDate = new Date(item.date);
                    
                    // If that fails, try US date format parsing
                    if (isNaN(parsedDate.getTime())) {
                        const dateStr = item.date.toString();
                        const parts = dateStr.split('/');
                        if (parts.length === 3) {
                            const month = parseInt(parts[0]) - 1;
                            const day = parseInt(parts[1]);
                            const year = parseInt(parts[2]);
                            parsedDate = new Date(year, month, day);
                        }
                    }
                }
                
                if ((!parsedDate || isNaN(parsedDate.getTime())) && item.rawDate) {
                    parsedDate = new Date(item.rawDate);
                    
                    if (isNaN(parsedDate.getTime())) {
                        const dateStr = item.rawDate.toString();
                        const parts = dateStr.split('/');
                        if (parts.length === 3) {
                            const month = parseInt(parts[0]) - 1;
                            const day = parseInt(parts[1]);
                            const year = parseInt(parts[2]);
                            parsedDate = new Date(year, month, day);
                        }
                    }
                }
            }
            
            const formattedDate = parsedDate && !isNaN(parsedDate.getTime()) 
                ? parsedDate.toLocaleString('default', { month: 'long', year: 'numeric' })
                : item.date;
            
            return {
                ...item,
                date: formattedDate,
                parsedDate: parsedDate
            };
        }).sort((a, b) => {
            // Sort by parsed date (newest first)
            if (a.parsedDate && b.parsedDate) {
                return b.parsedDate.getTime() - a.parsedDate.getTime();
            }
            return 0;
        })
        : [];
    
    // Determine which summary data to use based on current month selection
    const currentSummaryData = processedArchiveData.length > 0 && currentMonthIndex < processedArchiveData.length
        ? processedArchiveData[currentMonthIndex]
        : backlinksSummary;
    
    const followData = [
        { name: 'Dofollow', value: Number(currentSummaryData.totalDofollow) || 0, color: '#3b82f6' },
        { name: 'Nofollow', value: Number(currentSummaryData.totalNofollow) || 0, color: '#9ca3af' },
    ];
    const filteredBacklinks = (backlinksTable[activeTableTab] || []).filter(row =>
        row.backlinkUrl.toLowerCase().includes(searchTerm.toLowerCase()) ||
        row.title.toLowerCase().includes(searchTerm.toLowerCase())
    );

    // Reusable component for each stat in the summary
    const SummaryStat = ({ label, value, color, icon, valuePrefix = '', subtitle = null }) => (
        <div className="flex items-center justify-between p-3 bg-slate-50 rounded-lg transition-all hover:shadow-md hover:bg-white">
            <div className="flex items-center">
                {icon && <div className="mr-3 text-gray-400">{icon}</div>}
                <div>
                    <span className="text-sm text-gray-600 font-medium">{label}</span>
                    {subtitle && <p className="text-xs text-gray-500 mt-0.5">{subtitle}</p>}
                </div>
            </div>
            <span className={`text-lg font-bold ${color}`}>
                {value > 0 ? valuePrefix : ''}{value}
            </span>
        </div>
    );

    return (
        <PageContent>
            {/* Header Section */}
            <div className="mb-6">
                <div className="flex justify-between items-center">
                    <div>
                        <h1 className="text-3xl font-bold text-gray-800">Backlinks Analysis</h1>
                        <p className="text-gray-600 mt-1">Track your backlink profile and analyze link quality metrics</p>
                    </div>
                    <div className="flex items-center space-x-4">
                        {lastRefresh && (
                            <span className="text-sm text-gray-500">
                                Last updated: {lastRefresh.toLocaleTimeString()}
                            </span>
                        )}
                        
                        {/* Inline Progress Indicator */}
                        {isRefreshing && (
                            <div className="flex items-center space-x-3 bg-white rounded-xl shadow-md px-4 py-2 border border-gray-100">
                                <div className="flex items-center space-x-2">
                                    <div className="w-4 h-4 border-2 border-blue-500 border-t-transparent rounded-full animate-spin"></div>
                                    <span className="text-sm font-medium text-gray-700">{refreshMessage}</span>
                                </div>
                                <div className="w-16 bg-gray-200 rounded-full h-2">
                                    <div 
                                        className="bg-gradient-to-r from-blue-500 to-blue-600 h-2 rounded-full transition-all duration-500 ease-out"
                                        style={{ width: `${refreshProgress}%` }}
                                    ></div>
                                </div>
                                <span className="text-xs font-medium text-blue-600 min-w-[2rem]">{refreshProgress}%</span>
                            </div>
                        )}
                        
                        <button 
                            onClick={isRefreshing ? cancelRefresh : triggerRefresh}
                            className={`px-6 py-2 rounded-xl font-medium transition-all duration-200 shadow-lg hover:shadow-xl ${
                                isRefreshing 
                                    ? 'bg-red-500 hover:bg-red-600 text-white' 
                                    : 'bg-gradient-to-r from-blue-500 to-blue-600 hover:from-blue-600 hover:to-blue-700 text-white'
                            }`}
                        >
                            {isRefreshing ? 'Cancel' : 'Update Analytics'}
                        </button>
                    </div>
                </div>
            </div>

            <Card className="mb-6 group hover:shadow-xl transition-all duration-300 hover:-translate-y-0.5 hover:scale-[1.003] hover:border-blue-200/60">
                <div className="flex justify-between items-center mb-4">
                    <div className="flex items-center space-x-2">
                        <h2 className="text-xl font-bold text-gray-800">Backlinks Summary</h2>
                        <InfoTooltip text="An overview of your website's backlink profile, showing link types, quality metrics, and recent changes." />
                    </div>
                    
                    {/* Month slider controls */}
                    {processedArchiveData.length > 1 && (
                        <div className="flex items-center space-x-3">
                            <button 
                                onClick={() => {
                                    const newIndex = currentMonthIndex + 1;
                                    if (newIndex < processedArchiveData.length) {
                                        setCurrentMonthIndex(newIndex);
                                    }
                                }} 
                                disabled={currentMonthIndex >= processedArchiveData.length - 1}
                                className="flex items-center justify-center w-8 h-8 rounded-lg bg-blue-100 hover:bg-blue-200 disabled:opacity-50 disabled:cursor-not-allowed text-blue-600 transition-colors"
                                title="Go back to older month"
                            >
                                <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M15 19l-7-7 7-7" />
                                </svg>
                            </button>
                            <div className="text-center">
                                <span className="font-semibold text-gray-700 text-sm">
                                    {currentMonthIndex < processedArchiveData.length 
                                        ? processedArchiveData[currentMonthIndex].date 
                                        : 'Current'}
                                </span>
                                <div className="text-xs text-gray-500">
                                    {processedArchiveData.length - currentMonthIndex} of {processedArchiveData.length}
                                </div>
                                <div className="flex items-center justify-center space-x-1 mt-1">
                                    {processedArchiveData.map((_, index) => {
                                        const visualIndex = processedArchiveData.length - 1 - index;
                                        return (
                                            <div
                                                key={index}
                                                className={`w-2 h-2 rounded-full ${
                                                    index === currentMonthIndex 
                                                        ? 'bg-blue-600' 
                                                        : 'bg-gray-300 hover:bg-gray-400'
                                                } cursor-pointer transition-colors`}
                                                onClick={() => setCurrentMonthIndex(index)}
                                                title={`Go to ${processedArchiveData[index]?.date || 'Unknown month'} (${processedArchiveData.length - index} of ${processedArchiveData.length})`}
                                                style={{ order: visualIndex }}
                                            />
                                        );
                                    })}
                                </div>
                            </div>
                            <button 
                                onClick={() => {
                                    const newIndex = currentMonthIndex - 1;
                                    if (newIndex >= 0) {
                                        setCurrentMonthIndex(newIndex);
                                    }
                                }} 
                                disabled={currentMonthIndex <= 0}
                                className="flex items-center justify-center w-8 h-8 rounded-lg bg-blue-100 hover:bg-blue-200 disabled:opacity-50 disabled:cursor-not-allowed text-blue-600 transition-colors"
                                title="Go forward to newer month"
                            >
                                <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M9 5l7 7-7 7" />
                                </svg>
                            </button>
                        </div>
                    )}
                    
                    {/* Single month display */}
                    {processedArchiveData.length <= 1 && (
                        <span className="font-semibold text-gray-700">
                            {processedArchiveData.length === 1 ? processedArchiveData[0].date : 'Current'}
                        </span>
                    )}
                </div>

                <div className="grid grid-cols-1 lg:grid-cols-3 gap-8">
                    {/* Column 1: Core Metrics */}
                    <div className="space-y-6 flex flex-col">
                        <div className="p-6 bg-slate-100 rounded-xl text-center flex-grow flex flex-col justify-center">
                            <p className="text-base text-gray-500">Total Active Backlinks</p>
                            <p className="text-5xl font-bold text-blue-600">{(currentSummaryData.totalBacklinks || 0).toLocaleString()}</p>
                            <p className="text-sm text-gray-500 mt-2">
                                <span className={(Number(currentSummaryData.backlinksChange) || 0) >= 0 ? 'text-green-600' : 'text-red-600'}>
                                    {(Number(currentSummaryData.backlinksChange) || 0) >= 0 ? '+' : ''}{Number(currentSummaryData.backlinksChange) || 0}
                                </span> vs prev month
                            </p>
                        </div>
                        <div className="space-y-3">
                            <SummaryStat
                                label="Referring Domains"
                                value={currentSummaryData.topReferringDomains || 0}
                                color="text-gray-800"
                                icon={<Globe className="w-5 h-5" />}
                            />
                            <SummaryStat
                                label="Avg. Referring Rank"
                                value={currentSummaryData.avgRefferRank || 0}
                                color="text-gray-800"
                                icon={<ShieldCheck className="w-5 h-5" />}
                            />
                        </div>
                    </div>

                    {/* Column 2: Link Types Distribution */}
                    <div className="space-y-3">
                        <div className="flex items-center space-x-2 px-2 mb-2">
                            <h3 className="text-lg font-semibold text-gray-700">Link Types</h3>
                            <InfoTooltip text="Dofollow links pass SEO authority and help improve search rankings. Nofollow links don't pass authority but can still drive traffic and provide value." />
                        </div>
                        <div className="bg-slate-50 rounded-lg p-4">
                            <ResponsiveContainer width="100%" height={180}>
                                <BarChart data={followData} layout="vertical" margin={{ top: 20, right: 30, left: 60, bottom: 20 }}>
                                    <defs>
                                        <linearGradient id="dofollowGradient" x1="0" y1="0" x2="1" y2="0">
                                            <stop offset="0%" stopColor="#3b82f6" />
                                            <stop offset="100%" stopColor="#1e40af" />
                                        </linearGradient>
                                        <linearGradient id="nofollowGradient" x1="0" y1="0" x2="1" y2="0">
                                            <stop offset="0%" stopColor="#9ca3af" />
                                            <stop offset="100%" stopColor="#6b7280" />
                                        </linearGradient>
                                    </defs>
                                    <CartesianGrid strokeDasharray="3 3" horizontal={false} stroke="#e2e8f0" />
                                    <XAxis 
                                        type="number" 
                                        tick={{ fontSize: 12, fill: '#64748b' }}
                                        tickFormatter={(value) => value >= 1000 ? `${(value / 1000).toFixed(1)}k` : value.toString()}
                                        domain={[0, 'dataMax']}
                                        ticks={[0, 15, 30, 45, 60, 75]}
                                        interval={0}
                                    />
                                    <YAxis 
                                        dataKey="name" 
                                        type="category" 
                                        tick={{ fontSize: 12, fill: '#64748b' }}
                                        width={50}
                                    />
                                    <Tooltip 
                                        contentStyle={{ 
                                            backgroundColor: 'rgba(255, 255, 255, 0.95)', 
                                            border: '1px solid #e2e8f0', 
                                            borderRadius: '12px',
                                            boxShadow: '0 20px 25px -5px rgb(0 0 0 / 0.1)'
                                        }}
                                        itemStyle={{ color: '#374151' }}
                                        labelStyle={{ color: '#374151', fontWeight: 'bold' }}
                                        formatter={(value, name) => [value.toLocaleString(), name]}
                                    />
                                    <Bar dataKey="value" radius={[0, 6, 6, 0]} barSize={30}>
                                        {followData.map((entry, index) => (
                                            <Cell 
                                                key={`cell-${index}`} 
                                                fill={entry.name === 'Dofollow' ? 'url(#dofollowGradient)' : 'url(#nofollowGradient)'} 
                                            />
                                        ))}
                                    </Bar>
                                </BarChart>
                            </ResponsiveContainer>
                            <div className="flex justify-center space-x-6 text-sm mt-4">
                                <div className="flex items-center">
                                    <div className="w-3 h-3 rounded-full bg-blue-500 mr-2"></div>
                                    <span className="font-medium">{(currentSummaryData.totalDofollow || 0).toLocaleString()} Dofollow</span>
                                </div>
                                <div className="flex items-center">
                                    <div className="w-3 h-3 rounded-full bg-gray-400 mr-2"></div>
                                    <span className="font-medium">{(currentSummaryData.totalNofollow || 0).toLocaleString()} Nofollow</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    {/* Column 3: Link Dynamics */}
                    <div className="space-y-3">
                        <div className="flex items-center space-x-2 px-2 mb-2">
                            <h3 className="text-lg font-semibold text-gray-700">Link Dynamics</h3>
                            <InfoTooltip text="New Links: Recently acquired backlinks. Lost Links: Previously detected links that are no longer active. Spam Score: Average percentage indicating potential low-quality or spammy linking domains." />
                        </div>
                        <SummaryStat
                            label="New Links"
                            value={currentSummaryData.newLinks || 0}
                            color="text-green-600"
                            icon={<PlusCircle className="w-5 h-5" />}
                            valuePrefix="+"
                            subtitle="Gained this period"
                        />
                        <SummaryStat
                            label="Lost Links"
                            value={currentSummaryData.lostLinks || 0}
                            color="text-red-600"
                            icon={<MinusCircle className="w-5 h-5" />}
                            subtitle="Lost this period"
                        />
                        <SummaryStat
                            label="Spam Score"
                            value={`${(Number(currentSummaryData.avgSpamScore) || 0).toFixed(1)}%`}
                            color={(Number(currentSummaryData.avgSpamScore) || 0) <= 30 ? 'text-green-600' : (Number(currentSummaryData.avgSpamScore) || 0) <= 60 ? 'text-yellow-600' : 'text-red-600'}
                            icon={<ShieldCheck className="w-5 h-5" />}
                            subtitle={`${(Number(currentSummaryData.spamScoreChange) || 0) <= 0 ? '↓' : '↑'} ${Math.abs(Number(currentSummaryData.spamScoreChange) || 0).toFixed(1)}% vs prev month`}
                        />
                    </div>
                </div>
            </Card>

            <Card className="group hover:shadow-xl transition-all duration-300 hover:-translate-y-0.5 hover:scale-[1.003] hover:border-blue-200/60">
                <div className="flex justify-between items-center mb-4">
                    <div className="flex items-center space-x-2">
                        <h2 className="text-xl font-bold text-gray-800">Backlinks</h2>
                        <InfoTooltip text="Analyze backlinks for your site and competitors. Use the tabs to switch between different sites." />
                    </div>
                </div>

                <div className="mb-4">
                    <div className="relative">
                        <Search className="absolute left-3 top-1/2 -translate-y-1/2 w-5 h-5 text-gray-400" />
                        <input
                            type="text"
                            placeholder="Search by URL or title..."
                            value={searchTerm}
                            onChange={(e) => setSearchTerm(e.target.value)}
                            className="w-full pl-10 pr-4 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500"
                        />
                    </div>
                </div>

                <div className="flex space-x-1 mb-4 overflow-x-auto">
                    {siteNames.map(site => (
                        <button
                            key={site}
                            onClick={() => setActiveTableTab(site)}
                            className={`px-4 py-2 text-sm font-medium rounded-lg whitespace-nowrap transition-colors duration-200
                                ${activeTableTab === site
                                    ? 'bg-blue-100 text-blue-800'
                                    : 'text-gray-600 hover:bg-gray-100'}`}
                        >
                            {site}
                        </button>
                    ))}
                </div>

                {/* Website Summary Bar */}
                {activeTableTab && (
                    <div className="mb-3 py-1.5 px-3 bg-gradient-to-r from-blue-50 to-indigo-50 rounded-lg border border-blue-200">
                        <div className="flex items-center justify-start space-x-10">
                            {(() => {
                                const siteData = backlinksTable[activeTableTab] || [];
                                const totalBacklinks = siteData.length;
                                const newBacklinks = siteData.filter(link => link.isNew).length;
                                const dofollowCount = siteData.filter(link => link.following).length;
                                const nofollowCount = siteData.filter(link => !link.following).length;
                                const avgSpamScore = siteData.length > 0 
                                    ? (siteData.reduce((sum, link) => sum + (link.spamScore || 0), 0) / siteData.length).toFixed(1)
                                    : 0;
                                const avgRank = siteData.length > 0 
                                    ? (siteData.reduce((sum, link) => sum + (link.rank || 0), 0) / siteData.length).toFixed(0)
                                    : 0;

                                return (
                                    <>
                                        <div className="flex-1 text-center border-r border-gray-200 pr-5">
                                            <div className="text-base font-bold text-blue-600">{totalBacklinks}</div>
                                            <div className="text-xs text-gray-600">Total Backlinks</div>
                                        </div>
                                        <div className="flex-1 text-center border-r border-gray-200 pr-5">
                                            <div className="text-base font-bold text-green-600">{newBacklinks}</div>
                                            <div className="text-xs text-gray-600">New Links</div>
                                        </div>
                                        <div className="flex-1 text-center border-r border-gray-200 pr-5">
                                            <div className={`text-base font-bold ${avgSpamScore <= 30 ? 'text-green-600' : avgSpamScore <= 60 ? 'text-yellow-600' : 'text-red-600'}`}>
                                                {avgSpamScore}%
                                            </div>
                                            <div className="text-xs text-gray-600">Avg Spam Score</div>
                                        </div>
                                        <div className="flex-1 text-center border-r border-gray-200 pr-5">
                                            <div className="text-base font-bold text-gray-700">{avgRank}</div>
                                            <div className="text-xs text-gray-600">Avg Rank</div>
                                        </div>
                                        <div className="flex-1 text-center border-r border-gray-200 pr-5">
                                            <div className="flex justify-center items-center space-x-3">
                                                <div className="text-center">
                                                    <div className="text-sm font-bold text-blue-600">{dofollowCount}</div>
                                                    <div className="text-xs text-gray-600">Dofollow</div>
                                                </div>
                                                <div className="text-gray-400 text-sm">|</div>
                                                <div className="text-center">
                                                    <div className="text-sm font-bold text-gray-600">{nofollowCount}</div>
                                                    <div className="text-xs text-gray-600">Nofollow</div>
                                                </div>
                                            </div>
                                        </div>
                                    </>
                                );
                            })()}
                        </div>
                    </div>
                )}

                <div className="mt-4 overflow-x-auto">
                    <table className="w-full text-left text-sm whitespace-nowrap">
                        <thead>
                            <tr className="border-b-2 border-gray-200 bg-gray-50">
                                <th className="py-2 px-3">Backlink URL</th>
                                <th className="py-2 px-3 text-center">Status</th>
                                <th className="py-2 px-3 text-center">Spam Score</th>
                                <th className="py-2 px-3 text-center">Rank</th>
                                <th className="py-2 px-3 text-center">Type</th>
                                <th className="py-2 px-3">Title</th>
                                <th className="py-2 px-3 text-center">Link</th>
                            </tr>
                        </thead>
                        <tbody>
                            {filteredBacklinks.map((row, index) => (
                                <tr key={index} className="border-b border-gray-100 hover:bg-slate-50">
                                    <td className="py-3 px-3 font-medium text-blue-600 hover:text-blue-800">
                                        <a href={row.backlinkUrl} target="_blank" rel="noopener noreferrer" className="hover:underline">
                                            {row.backlinkUrl}
                                        </a>
                                    </td>
                                    <td className="py-3 px-3 text-center">
                                        {row.isNew ? (
                                            <span className="text-xs font-semibold px-2 py-1 bg-blue-100 text-blue-800 rounded-full">New</span>
                                        ) : row.isLost ? (
                                            <span className="text-xs font-semibold px-2 py-1 bg-red-100 text-red-800 rounded-full">Lost</span>
                                        ) : (
                                            <span className="text-gray-400">-</span>
                                        )}
                                    </td>
                                    <td className="py-3 px-3 text-center">
                                        <span className={`px-2 py-1 rounded-full text-xs font-semibold
                                            ${row.spamScore <= 30 ? 'bg-green-100 text-green-800' :
                                            row.spamScore <= 60 ? 'bg-yellow-100 text-yellow-800' :
                                            'bg-red-100 text-red-800'}`}>
                                            {row.spamScore}%
                                        </span>
                                    </td>
                                    <td className="py-3 px-3 text-center">{row.rank}</td>
                                    <td className="py-3 px-3 text-center">
                                        <span className={`px-2 py-1 rounded-full text-xs font-semibold
                                            ${row.following ? 'bg-blue-100 text-blue-800' : 'bg-gray-100 text-gray-800'}`}>
                                            {row.following ? 'Dofollow' : 'Nofollow'}
                                        </span>
                                    </td>
                                    <td className="py-3 px-3 text-gray-600 max-w-xs truncate" title={row.title}>
                                        {row.title || '-'}
                                    </td>
                                    <td className="py-3 px-3 text-center">
                                        <a href={row.linkUrl} target="_blank" rel="noopener noreferrer" className="text-blue-600 hover:text-blue-800 inline-block">
                                            <ExternalLink className="w-4 h-4" />
                                        </a>
                                    </td>
                                </tr>
                            ))}
                        </tbody>
                    </table>
                    {filteredBacklinks.length === 0 && (
                        <div className="text-center py-8 text-gray-500">
                            No matching backlinks found for "{searchTerm}"
                        </div>
                    )}
                </div>
            </Card>
        </PageContent>
    );
};

const ToolsPage     = () => <PageContent><h2 className="text-center text-gray-500">Tools – coming soon</h2></PageContent>;
const GeogridMaps = () => {
    const { ResponsiveContainer, BarChart, Bar, XAxis, YAxis, Tooltip, CartesianGrid, Cell, LabelList } = window.Recharts;
    const [geogridData, setGeogridData] = useState(null);
    const [loading, setLoading] = useState(true);
    const [error, setError] = useState(null);

    // List of keywords we want to display
    const targetKeywords = [
        'medspa',
        'medspa near me',
        'beauty spa',
        'medical spa',
        'aesthetics spa',
        'best med spa near me'
    ];
    
    const getRankColor = (rank) => {
        if (rank === null || rank === undefined) return 'bg-gray-400';
        if (rank <= 3) return 'bg-green-500';
        if (rank <= 5) return 'bg-sky-500';
        if (rank <= 10) return 'bg-yellow-500';
        if (rank <= 20) return 'bg-orange-500';
        return 'bg-red-500';
    };

    useEffect(() => {
        const params = new URLSearchParams(window.location.search);
        const workbookId = params.get('workbookId');
        if (!workbookId) {
            setError("No workbook ID provided");
            setLoading(false);
            return;
        }

        // Use a different cache key for the full geogrid data
        const cacheKey = `full_geogrid_${workbookId}`;
        
        // Try to get data from cache first
        const cachedData = sessionStorage.getItem(cacheKey);
        if (cachedData) {
            try {
                const parsed = JSON.parse(cachedData);
                setGeogridData(parsed);
                setLoading(false);
                return;
            } catch (e) {
                console.error('Cache parsing error:', e);
                // Clear invalid cache
                sessionStorage.removeItem(cacheKey);
            }
        }

        // If no cache or invalid cache, fetch fresh data
        setLoading(true);
        const scriptUrl = `https://script.google.com/macros/s/AKfycbxfOMp8d_eCVH4lFD0PNuFU1wH-gyWOwRt2EuME7GQJ4U73ZwpPDciohDH3C566YLWq/exec?workbookId=${workbookId}`;
        
        fetchWithCorsWorkaround(scriptUrl, (err, data) => {
            if (err) {
                setError(err.message);
                setLoading(false);
                return;
            }
            if (data.error) {
                setError(`Script error: ${data.error}`);
                setLoading(false);
                return;
            }
            
            try {
                // Enhanced helper function to fix date parsing and handle missing months
                const fixDateFormatting = (monthlyData) => {
                    if (!Array.isArray(monthlyData) || monthlyData.length === 0) return monthlyData;
                    
                    console.log('📅 Original monthly data:', monthlyData.map(m => ({ 
                        date: m.date, 
                        originalDate: m.date, 
                        rawDate: m.rawDate,
                        parsedDate: m.parsedDate 
                    })));
                    
                    // Try to parse the original dates first
                    const parsedDates = monthlyData.map((monthData, index) => {
                        let parsedDate = null;
                        
                        // If we have a parsedDate from the backend, use it
                        if (monthData.parsedDate) {
                            parsedDate = new Date(monthData.parsedDate);
                        }
                        
                        // If no parsedDate from backend, try multiple parsing approaches
                        if (!parsedDate || isNaN(parsedDate.getTime())) {
                            if (monthData.date) {
                                // First try parsing as-is
                                parsedDate = new Date(monthData.date);
                                
                                // If that fails, try US date format parsing
                                if (isNaN(parsedDate.getTime())) {
                                    // Try parsing MM/DD/YYYY format
                                    const dateStr = monthData.date.toString();
                                    const parts = dateStr.split('/');
                                    if (parts.length === 3) {
                                        const month = parseInt(parts[0]) - 1; // Convert to 0-based
                                        const day = parseInt(parts[1]);
                                        const year = parseInt(parts[2]);
                                        parsedDate = new Date(year, month, day);
                                    }
                                }
                            }
                            
                            // Try parsing rawDate if available
                            if ((!parsedDate || isNaN(parsedDate.getTime())) && monthData.rawDate) {
                                parsedDate = new Date(monthData.rawDate);
                                
                                // If that fails, try US date format parsing on rawDate
                                if (isNaN(parsedDate.getTime())) {
                                    const dateStr = monthData.rawDate.toString();
                                    const parts = dateStr.split('/');
                                    if (parts.length === 3) {
                                        const month = parseInt(parts[0]) - 1; // Convert to 0-based
                                        const day = parseInt(parts[1]);
                                        const year = parseInt(parts[2]);
                                        parsedDate = new Date(year, month, day);
                                    }
                                }
                            }
                        }
                        
                        return {
                            ...monthData,
                            originalDate: monthData.date,
                            parsedDate: parsedDate,
                            index: index
                        };
                    });
                    
                    // Check if we have valid parsed dates
                    const validDates = parsedDates.filter(item => item.parsedDate && !isNaN(item.parsedDate.getTime()));
                    
                    if (validDates.length === 0) {
                        console.log('⚠️ No valid dates found, using fallback sequential logic');
                        // Fallback to sequential month logic
                        return monthlyData.map((monthData, index) => {
                            const currentDate = new Date();
                            const currentMonth = currentDate.getMonth();
                            const currentYear = currentDate.getFullYear();
                            
                            let targetMonth = currentMonth - index;
                            let targetYear = currentYear;
                            
                            if (targetMonth < 0) {
                                targetMonth += 12;
                                targetYear--;
                            }
                            
                            const correctedDate = new Date(targetYear, targetMonth, 1);
                            const formattedDate = correctedDate.toLocaleString('default', { 
                                month: 'long', 
                                year: 'numeric'
                            });
                            
                            return {
                                ...monthData,
                                date: formattedDate,
                                originalDate: monthData.date,
                                correctedDate: correctedDate
                            };
                        });
                    }
                    
                    // If we have valid dates, sort by date (newest first) and format properly
                    validDates.sort((a, b) => b.parsedDate.getTime() - a.parsedDate.getTime());
                    
                    console.log('✅ Valid dates after sorting:', validDates.map(v => ({
                        date: v.parsedDate.toLocaleString('default', { month: 'long', year: 'numeric' }),
                        parsedDate: v.parsedDate,
                        originalDate: v.originalDate
                    })));
                    
                    return validDates.map(item => {
                        const formattedDate = item.parsedDate.toLocaleString('default', { 
                            month: 'long', 
                            year: 'numeric'
                        });
                        
                        return {
                            ...item,
                            date: formattedDate,
                            correctedDate: item.parsedDate
                        };
                    });
                };

                // Get geogrid data and normalize keywords
                const rawData = data.geogridData || {};
                console.log('🔍 Raw geogrid data from server:', rawData);
                
                const normalizedData = {};
                Object.entries(rawData).forEach(([key, value]) => {
                    if (Array.isArray(value)) {
                        console.log(`📅 Processing keyword "${key}" with ${value.length} months:`, value.map(v => v.date));
                        
                        // Always apply our enhanced date formatting
                        const processedData = fixDateFormatting(value);
                        console.log(`✅ Processed "${key}":`, processedData.map(v => ({ date: v.date, originalDate: v.originalDate })));
                        
                        normalizedData[key.toLowerCase().trim()] = processedData;
                    } else {
                        normalizedData[key.toLowerCase().trim()] = value;
                    }
                });

                // Cache the normalized data
                sessionStorage.setItem(cacheKey, JSON.stringify(normalizedData));
                
                setGeogridData(normalizedData);
                setLoading(false);
            } catch (e) {
                console.error('Data processing error:', e);
                setError('Failed to process geogrid data');
                setLoading(false);
            }
        });
    }, []);

    if (loading) {
        return (
            <PageContent>
                <div className="flex justify-between items-center mb-6">
                    <div>
                        <h1 className="text-3xl font-bold text-gray-800">Geogrid Search Results</h1>
                        <p className="text-gray-500 mt-1">Track your local search rankings across different keywords</p>
                    </div>
                    <button
                        disabled
                        className="bg-slate-100 text-slate-400 font-bold py-1 px-3 rounded-lg text-xs cursor-not-allowed"
                    >
                        Refresh
                    </button>
                </div>
                <div className="grid grid-cols-1 md:grid-cols-2 gap-8">
                    {targetKeywords.map(keyword => (
                        <Card key={keyword} className="animate-pulse">
                            <div className="h-[500px] bg-gray-100 rounded-lg"></div>
                        </Card>
                    ))}
                </div>
            </PageContent>
        );
    }

    const GeogridMapCard = ({ keyword, monthlyData }) => {
        const [currentMonthIndex, setCurrentMonthIndex] = useState(0);
        const CHART_COLORS = ['#3b82f6', '#16a34a', '#f97316', '#a855f7', '#ec4899'];
        
        // Initialize to show the newest month (index 0 since data is sorted newest first)
        // But we want to display it as "X of Y" where X starts at the total count
        const displayMonthNumber = monthlyData.length - currentMonthIndex;

        // Debug logging
        console.log(`GeogridMapCard for "${keyword}":`, {
            monthlyDataLength: monthlyData?.length,
            monthlyData: monthlyData,
            currentMonthIndex,
            dates: monthlyData?.map(m => m.date),
            currentData: monthlyData?.[currentMonthIndex],
            availableIndices: monthlyData?.map((_, i) => i)
        });

        // Validate monthlyData
        if (!Array.isArray(monthlyData) || monthlyData.length === 0) {
            return (
                <Card>
                    <div className="p-4 text-center text-gray-500">
                        No data available for keyword: {keyword}
                    </div>
                </Card>
            );
        }

        const currentData = monthlyData[currentMonthIndex];
        
        // Validate currentData
        if (!currentData || !currentData.competitors) {
            return (
                <Card>
                    <div className="p-4 text-center text-gray-500">
                        Invalid data format for keyword: {keyword}
                    </div>
                </Card>
            );
        }

        const handleDateChange = (direction) => {
            const newIndex = currentMonthIndex + direction;
            console.log(`📅 Month navigation for "${keyword}":`, {
                direction,
                currentIndex: currentMonthIndex,
                newIndex,
                maxIndex: monthlyData.length - 1,
                isValidIndex: newIndex >= 0 && newIndex < monthlyData.length,
                availableDates: monthlyData.map((m, i) => ({ index: i, date: m.date })),
                displayMonthNumber: monthlyData.length - currentMonthIndex,
                newDisplayNumber: monthlyData.length - newIndex
            });
            
            if (newIndex >= 0 && newIndex < monthlyData.length) {
                setCurrentMonthIndex(newIndex);
                console.log(`✅ Changed to month index ${newIndex}: ${monthlyData[newIndex]?.date} (Display: ${monthlyData.length - newIndex} of ${monthlyData.length})`);
            } else {
                console.log(`❌ Invalid month index ${newIndex} for keyword "${keyword}"`);
            }
        };

        // Ensure competitors array exists and has valid data
        const competitors = Array.isArray(currentData.competitors) ? currentData.competitors : [];

        const CustomXAxisTick = ({ x, y, payload }) => {
            const name = payload.value || '';
            
            // Smart text truncation for competitor names
            const truncateText = (text, maxLength = 15) => {
                if (text.length <= maxLength) return text;
                
                // Try to break at a space if possible
                const lastSpace = text.lastIndexOf(' ', maxLength - 1);
                if (lastSpace > maxLength * 0.6) { // Only break at space if it's not too early
                    return text.substring(0, lastSpace) + '…';
                }
                
                // Otherwise, just truncate with ellipsis
                return text.substring(0, maxLength - 1) + '…';
            };
            
            const displayName = truncateText(name);
            
            return (
                <g transform={`translate(${x},${y})`}>
                    <text 
                        x={0} 
                        y={0} 
                        dy={16} 
                        textAnchor="end" 
                        fill="#6B7280" 
                        fontSize={12} 
                        transform="rotate(-40)"
                    >
                        {displayName}
                    </text>
                </g>
            );
        };

        return (
            <Card className="group hover:shadow-xl transition-all duration-300 hover:-translate-y-0.5 hover:scale-[1.003] hover:border-blue-200/60">
                <div className="flex justify-between items-start mb-4">
                    <div>
                        <h2 className="text-xl font-bold text-gray-800">{keyword}</h2>
                        <p className="text-sm text-gray-500 mt-1">
                            {monthlyData.length > 1 ? `${monthlyData.length} months of data available` : 'Latest Rankings'}
                        </p>
                    </div>
                    <div className="flex items-center space-x-3">
                        <button 
                            onClick={() => handleDateChange(1)} 
                            disabled={currentMonthIndex >= monthlyData.length - 1}
                            className="flex items-center justify-center w-8 h-8 rounded-lg bg-blue-100 hover:bg-blue-200 disabled:opacity-50 disabled:cursor-not-allowed text-blue-600 transition-colors"
                            title="Go back to older month"
                        >
                            <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M15 19l-7-7 7-7" />
                            </svg>
                        </button>
                        <div className="text-center">
                            <span className="font-semibold text-gray-700 text-sm">{currentData.date || 'No date'}</span>
                            {monthlyData.length > 1 && (
                                <div className="text-xs text-gray-500">
                                    {displayMonthNumber} of {monthlyData.length}
                                </div>
                            )}
                            {monthlyData.length > 1 && (
                                <div className="flex items-center justify-center space-x-1 mt-1">
                                    {monthlyData.map((_, index) => {
                                        // Reverse the visual order so newest (index 0) appears on the right
                                        const visualIndex = monthlyData.length - 1 - index;
                                        return (
                                            <div
                                                key={index}
                                                className={`w-2 h-2 rounded-full ${
                                                    index === currentMonthIndex 
                                                        ? 'bg-blue-600' 
                                                        : 'bg-gray-300 hover:bg-gray-400'
                                                } cursor-pointer transition-colors`}
                                                onClick={() => setCurrentMonthIndex(index)}
                                                title={`Go to ${monthlyData[index]?.date || 'Unknown month'} (${monthlyData.length - index} of ${monthlyData.length})`}
                                                style={{ order: visualIndex }}
                                            />
                                        );
                                    })}
                                </div>
                            )}
                        </div>
                        <button 
                            onClick={() => handleDateChange(-1)} 
                            disabled={currentMonthIndex <= 0}
                            className="flex items-center justify-center w-8 h-8 rounded-lg bg-blue-100 hover:bg-blue-200 disabled:opacity-50 disabled:cursor-not-allowed text-blue-600 transition-colors"
                            title="Go forward to newer month"
                        >
                            <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M9 5l7 7-7 7" />
                            </svg>
                        </button>
                    </div>
                </div>
                
                <div className="grid grid-cols-1 md:grid-cols-4 gap-4">
                    {/* Modern Rankings Column */}
                    <div className="md:col-span-1">
                        {competitors.length > 0 && (
                            <div>
                                <div className="flex items-center space-x-2 mb-3">
                                    <h3 className="text-lg font-semibold text-gray-800">Avg Score</h3>
                                    <div className="w-2 h-2 bg-gradient-to-r from-green-500 to-red-500 rounded-full"></div>
                                </div>
                                <div className="space-y-3">
                                    {competitors.map((comp, index) => {
                                        const isClient = comp.isClient;
                                        const rank = typeof comp.rank === 'number' ? comp.rank : 0;
                                        
                                        // Improved color scheme for geogrid scores (lower is better)
                                        const getScoreColors = (score) => {
                                            if (score <= 3) {
                                                return {
                                                    border: 'border-green-500',
                                                    bg: 'bg-green-50',
                                                    text: 'text-green-700',
                                                    accent: 'bg-green-500'
                                                };
                                            } else if (score <= 7) {
                                                return {
                                                    border: 'border-yellow-500',
                                                    bg: 'bg-yellow-50',
                                                    text: 'text-yellow-700',
                                                    accent: 'bg-yellow-500'
                                                };
                                            } else {
                                                return {
                                                    border: 'border-red-500',
                                                    bg: 'bg-red-50',
                                                    text: 'text-red-700',
                                                    accent: 'bg-red-500'
                                                };
                                            }
                                        };
                                        
                                        const scoreColors = getScoreColors(rank);
                                        
                                        // Position indicators
                                        const getPositionText = (index) => {
                                            const positions = ['1st', '2nd', '3rd', '4th', '5th'];
                                            return positions[index] || `${index + 1}th`;
                                        };
                                        
                                        return (
                                            <div key={index} className={`group relative overflow-hidden rounded-xl transition-all duration-300 hover:shadow-lg ${isClient ? 'bg-gradient-to-r from-blue-50 to-blue-100 border-2 border-blue-200 hover:border-blue-300' : 'bg-white border border-gray-200 hover:border-gray-300 hover:shadow-md'}`}>
                                                {/* Position Badge - Top Left */}
                                                <div className="absolute top-2 left-2 z-10">
                                                    <span className={`inline-block px-2 py-1 rounded-full text-xs font-bold shadow-sm ${
                                                        index === 0 ? 'bg-yellow-500 text-white' :
                                                        index === 1 ? 'bg-gray-500 text-white' :
                                                        index === 2 ? 'bg-orange-500 text-white' :
                                                        'bg-blue-500 text-white'
                                                    }`}>
                                                        {getPositionText(index)}
                                                    </span>
                                                </div>
                                                
                                                {/* Subtle background pattern */}
                                                <div className="absolute inset-0 bg-gradient-to-br from-white/50 to-transparent pointer-events-none"></div>
                                                
                                                <div className="relative p-3 pt-7 flex items-center space-x-3">
                                                    {/* Modern Score Badge - Compact hexagonal style */}
                                                    <div className="relative">
                                                        <div className={`w-12 h-12 rounded-xl ${scoreColors.bg} ${scoreColors.border} border-2 flex items-center justify-center font-bold ${scoreColors.text} text-sm shadow-lg group-hover:scale-105 transition-all duration-200 relative overflow-hidden`}>
                                                            {/* Accent corner */}
                                                            <div className={`absolute top-0 right-0 w-3 h-3 ${scoreColors.accent} transform rotate-45 translate-x-1.5 -translate-y-1.5`}></div>
                                                            <span className="relative z-10">{rank > 0 ? rank.toFixed(1) : '-'}</span>
                                                        </div>
                                                        {/* Subtle glow effect */}
                                                        <div className={`absolute inset-0 rounded-xl ${scoreColors.bg} opacity-30 group-hover:opacity-50 transition-opacity duration-200 blur-sm`}></div>
                                                    </div>
                                                    
                                                    {/* Business Info */}
                                                    <div className="flex-1 min-w-0">
                                                        <div className="flex items-center space-x-2">
                                                            <p className={`font-semibold text-xs leading-tight truncate ${isClient ? 'text-blue-900' : 'text-gray-800'}`} title={comp.name || 'Unknown'}>
                                                                {comp.name || 'Unknown'}
                                                            </p>
                                                            {isClient && (
                                                                <div className="flex-shrink-0 w-3 h-3 bg-blue-500 rounded-full flex items-center justify-center">
                                                                    <span className="text-xs text-white font-bold">★</span>
                                                                </div>
                                                            )}
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        );
                                    })}
                                </div>
                            </div>
                        )}
                    </div>

                    {/* Right Column: Map */}
                    <div className="md:col-span-3">
                        {currentData.mapLink ? (
                            <div className="relative w-full h-[550px] overflow-hidden mx-0 map-container" onClick={handleMapClick}>
                                <iframe 
                                    src={processMapUrlForCentering(currentData.mapLink)}
                                    className="w-full h-full rounded-lg map-iframe"
                                    style={{ background: '#f9fafb' }}
                                    loading="lazy"
                                    allowFullScreen
                                    scrolling="no"
                                />
                                <a 
                                    href={currentData.mapLink} 
                                    target="_blank" 
                                    rel="noopener noreferrer"
                                    className="absolute bottom-2 right-2 bg-white/90 hover:bg-white text-gray-700 px-2 py-1 rounded text-xs flex items-center gap-1 shadow-sm transition-colors"
                                >
                                    <svg className="w-3 h-3" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                                        <path d="M18 13v6a2 2 0 01-2 2H5a2 2 0 01-2-2V8a2 2 0 012-2h6" />
                                        <polyline points="15 3 21 3 21 9" />
                                        <line x1="10" y1="14" x2="21" y2="3" />
                                    </svg>
                                    Open in new tab
                                </a>
                            </div>
                        ) : (
                            <div className="w-full h-[550px] flex flex-col items-center justify-center bg-gray-50 rounded-lg">
                                <div className="bg-gray-100 p-4 rounded-full mb-4">
                                    <svg className="w-12 h-12 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M9 20l-5.447-2.724A1 1 0 013 16.382V5.618a1 1 0 011.447-.894L9 7m0 13l6-3m-6 3V7m6 10l4.553 2.276A1 1 0 0021 18.382V7.618a1 1 0 00-.553-.894L15 4m0 13V4m0 0L9 7" />
                                    </svg>
                                </div>
                                <p className="text-lg font-semibold text-gray-600 mb-2">Map Not Available Yet</p>
                                <p className="text-sm text-gray-500 text-center max-w-md">
                                    The Geogrid map for "{keyword}" is pending setup. Once available, it will show local search rankings across your service area.
                                </p>
                            </div>
                        )}
                    </div>
                </div>

                                 {/* Bottom Row: Bar Chart */}
                 {competitors.length > 0 && (
                     <div className="mt-8">
                         <h3 className="text-lg font-semibold text-gray-800 mb-3">Rankings in Top 5</h3>
                         <div className="relative">
                             {/* Compact Legend - Top Right */}
                             <div className="absolute top-2 right-8 z-10 bg-white/90 backdrop-blur-sm rounded-lg px-3 py-2 shadow-sm border border-gray-200">
                                 <div className="flex items-center space-x-4 text-xs">
                                     <div className="flex items-center space-x-1.5">
                                         <div className="w-3 h-3 rounded shadow-sm" style={{ backgroundColor: '#3b82f6' }}></div>
                                         <span className="font-medium text-gray-700">Client</span>
                                     </div>
                                     <div className="flex items-center space-x-1.5">
                                         <div className="w-3 h-3 rounded shadow-sm" style={{ backgroundColor: '#7c3aed' }}></div>
                                         <span className="font-medium text-gray-700">Competitors</span>
                                     </div>
                                 </div>
                             </div>
                             
                             <ResponsiveContainer width="100%" height={280}>
                                 <BarChart data={competitors} margin={{ top: 40, right: 30, left: 20, bottom: 20 }}>
                                  <defs>
                                      {/* Simple two-color system for geogrid charts */}
                                      <linearGradient id="geogrid-client-gradient" x1="0" y1="0" x2="0" y2="1">
                                          <stop offset="0%" stopColor="#3b82f6" />
                                          <stop offset="50%" stopColor="#3b82f6" />
                                          <stop offset="100%" stopColor="#3b82f640" />
                                      </linearGradient>
                                      <linearGradient id="geogrid-competitor-gradient" x1="0" y1="0" x2="0" y2="1">
                                          <stop offset="0%" stopColor="#7c3aed" />
                                          <stop offset="50%" stopColor="#8b5cf6" />
                                          <stop offset="100%" stopColor="#7c3aed40" />
                                      </linearGradient>
                                  </defs>
                                  <CartesianGrid strokeDasharray="3 3" stroke="#f1f5f9" />
                                  <XAxis 
                                      dataKey="name" 
                                      tick={{ fontSize: 12, fill: '#64748b' }}
                                      height={40}
                                      interval={0}
                                      tickFormatter={(value) => {
                                          // Truncate names for X-axis display
                                          const truncateName = (name, maxLength = 12) => {
                                              if (!name || name.length <= maxLength) return name;
                                              return name.substring(0, maxLength - 1) + '…';
                                          };
                                          return truncateName(value);
                                      }}
                                  />
                                  <YAxis 
                                      tick={{ fontSize: 12, fill: '#64748b' }}
                                      domain={[0, dataMax => {
                                          const maxValue = Math.max(...competitors.map(c => c.top5Total || 0));
                                          const increment = 5;
                                          const suggestedMax = Math.max(10, Math.ceil(maxValue / increment) * increment);
                                          return suggestedMax;
                                      }]}
                                      ticks={(() => {
                                          const maxValue = Math.max(...competitors.map(c => c.top5Total || 0));
                                          const increment = 5;
                                          const suggestedMax = Math.max(10, Math.ceil(maxValue / increment) * increment);
                                          return [0, increment, increment * 2, increment * 3, suggestedMax];
                                      })()}
                                      tickFormatter={(value) => value.toString()}
                                  />
                                  <Tooltip 
                                      contentStyle={{ 
                                          backgroundColor: 'rgba(31, 41, 55, 0.95)', 
                                          border: '1px solid #374151', 
                                          borderRadius: '12px',
                                          boxShadow: '0 20px 25px -5px rgb(0 0 0 / 0.1)',
                                          color: '#fff'
                                      }}
                                      itemStyle={{ color: '#fff' }}
                                      labelStyle={{ color: '#fff', fontWeight: 'bold' }}
                                      formatter={(value, name, props) => [
                                          <div key="tooltip">
                                              <div style={{ fontWeight: 'bold' }}>{value}</div>
                                              <div style={{ fontSize: '11px', opacity: 0.8 }}>Top 5 Rankings</div>
                                              {props.payload?.isClient === true && <div style={{ fontSize: '11px', color: '#60a5fa' }}>⭐ Your Business</div>}
                                          </div>,
                                          'Top 5 Count'
                                      ]}
                                      cursor={{ fill: 'rgba(59, 130, 246, 0.1)' }}
                                  />
                                  <Bar dataKey='top5Total' name="Top 5 Rankings" radius={[6, 6, 0, 0]} barSize={40}>
                                      {competitors.map((entry, index) => {
                                          const isClient = entry.isClient === true;
                                          const gradientId = isClient ? 'geogrid-client-gradient' : 'geogrid-competitor-gradient';
                                          return (
                                              <Cell 
                                                  key={`cell-${index}`} 
                                                  fill={`url(#${gradientId})`}
                                              />
                                          );
                                      })}
                                      <LabelList 
                                          dataKey="top5Total" 
                                          position="top" 
                                          style={{ 
                                              fill: '#374151', 
                                              fontSize: 12, 
                                              fontWeight: 'bold' 
                                          }}
                                      />
                                  </Bar>
                             </BarChart>
                         </ResponsiveContainer>
                         </div>
                     </div>
                 )}
            </Card>
        );
    };

    // Get all available months across all keywords
    const getAvailableMonths = () => {
        const allMonths = new Set();
        Object.values(geogridData || {}).forEach(keywordData => {
            if (Array.isArray(keywordData)) {
                keywordData.forEach(monthData => {
                    if (monthData.date) {
                        allMonths.add(monthData.date);
                    }
                });
            }
        });
        return Array.from(allMonths).sort();
    };

    const availableMonths = getAvailableMonths();

    return (
        <PageContent>
            <div className="flex justify-between items-center mb-6">
                <div>
                    <h1 className="text-3xl font-bold text-gray-800">Geogrid Search Results</h1>
                    <p className="text-gray-500 mt-1">Track your local search rankings across different keywords</p>
                    {availableMonths.length > 0 && (
                        <div className="flex items-center gap-2 mt-2">
                            <span className="text-sm text-gray-600">Available months:</span>
                            <div className="flex gap-1">
                                {availableMonths.map(month => (
                                    <span key={month} className="px-2 py-1 bg-blue-100 text-blue-800 text-xs rounded-full">
                                        {month}
                                    </span>
                                ))}
                            </div>
                        </div>
                    )}
                </div>

            </div>

            <div className="grid grid-cols-1 xl:grid-cols-2 gap-4">
                {targetKeywords.map(keyword => (
                    <GeogridMapCard 
                        key={keyword} 
                        keyword={keyword} 
                        monthlyData={geogridData[keyword.toLowerCase().trim()] || []} 
                    />
                ))}
            </div>
        </PageContent>
    );
};

/* ------------------------------------------------------------------ */
/* CONSISTENT COLOR MAPPING SYSTEM                                   */
/* ------------------------------------------------------------------ */

// Consistent color mapping system for competitors across all charts
const getConsistentColor = (businessName, isClient, allBusinesses = []) => {
    // Client always gets blue
    if (isClient) {
        return {
            start: '#3b82f6',
            end: '#3b82f6',
            gradientStart: '#3b82f6',
            gradientEnd: '#3b82f640'
        };
    }
    
    // Define consistent competitor colors (same as ModernComparisonChart)
    const competitorColors = [
        { start: '#7c3aed', end: '#6d28d9', gradientStart: '#7c3aed', gradientEnd: '#7c3aed40' }, // Dark Purple
        { start: '#8b5cf6', end: '#7c3aed', gradientStart: '#8b5cf6', gradientEnd: '#8b5cf640' }, // Purple  
        { start: '#6366f1', end: '#4f46e5', gradientStart: '#6366f1', gradientEnd: '#6366f140' }, // Indigo
        { start: '#10b981', end: '#059669', gradientStart: '#10b981', gradientEnd: '#10b98140' }, // Emerald
        { start: '#f97316', end: '#ea580c', gradientStart: '#f97316', gradientEnd: '#f9731640' }  // Orange
    ];
    
    // Get all non-client businesses and sort them consistently
    const competitors = allBusinesses
        .filter(business => !business.isClient)
        .sort((a, b) => (a.name || '').localeCompare(b.name || ''));
    
    // Find the index of this business in the sorted competitor list
    const competitorIndex = competitors.findIndex(comp => comp.name === businessName);
    
    // If found, use the consistent color, otherwise use a fallback
    if (competitorIndex !== -1 && competitorIndex < competitorColors.length) {
        return competitorColors[competitorIndex];
    }
    
    // Fallback for unknown competitors (use gray)
    return {
        start: '#6b7280',
        end: '#4b5563',
        gradientStart: '#6b7280',
        gradientEnd: '#6b728040'
    };
};

/* ------------------------------------------------------------------ */
/* WEBSITE STATS - HELPER COMPONENTS & DATA                           */
/* ------------------------------------------------------------------ */
const StatCard = ({ label, value, icon, tooltip }) => {
    const cardRef = useRef(null);
    const [tooltipPosition, setTooltipPosition] = useState('top');
    const [tooltipWidthClass, setTooltipWidthClass] = useState('w-64');

    useEffect(() => {
        if (tooltip && tooltip.width === 'large') {
            setTooltipWidthClass('w-[600px]');
        } else {
            setTooltipWidthClass('w-64');
        }

        const cardElement = cardRef.current;
        if (!cardElement || !tooltip) return;

        const handleMouseEnter = () => {
            const cardRect = cardElement.getBoundingClientRect();
            const spaceAbove = cardRect.top;
            
            // A simple heuristic to decide tooltip position
            // Estimate tooltip height. large is w-[600px] so it can be tall.
            const estimatedHeight = tooltip.width === 'large' ? 350 : 150;

            if (spaceAbove < estimatedHeight && (window.innerHeight - cardRect.bottom) > spaceAbove) {
                setTooltipPosition('bottom');
            } else {
                setTooltipPosition('top');
            }
        };

        cardElement.addEventListener('mouseenter', handleMouseEnter);

        return () => {
            if (cardElement) {
                cardElement.removeEventListener('mouseenter', handleMouseEnter);
            }
        };
    }, [tooltip]);

    const content = (
        <div className="flex items-center space-x-3">
            <div className="p-2 bg-blue-100 rounded-full">{icon}</div>
            <div>
                <p className="text-sm text-gray-500">{label}</p>
                <p className={`font-bold text-lg ${value.color || 'text-gray-800'}`}>{value.text}</p>
            </div>
        </div>
    );

    if (tooltip && tooltip.content) {
        return (
            <div ref={cardRef} className="relative group cursor-help">
                {content}
                <div className={`absolute left-1/2 -translate-x-1/2 ${tooltipWidthClass} bg-gray-800 text-white text-sm rounded-lg shadow-lg opacity-0 group-hover:opacity-100 transition-opacity duration-300 z-50 pointer-events-none ${tooltipPosition === 'top' ? 'bottom-full mb-2' : 'top-full mt-2'}`}>
                    {tooltip.header && (
                         <div className="px-3 py-1.5 bg-gray-700 rounded-t-lg font-semibold border-b border-gray-600">
                            {tooltip.header}
                        </div>
                    )}
                    <div className="p-3">{tooltip.content}</div>
                    <div className={`absolute left-1/2 -translate-x-[6px] w-3 h-3 bg-gray-800 transform rotate-45 ${tooltipPosition === 'top' ? 'bottom-[-6px]' : 'top-[-6px]'}`}></div>
                </div>
            </div>
        );
    }
    return content;
};

const HealthCheckItem = ({ icon, color, title, items }) => (
    <div className="relative group flex items-center space-x-2">
        {icon}
        <div>
            <p className={`font-bold text-lg ${color}`}>{items.length}</p>
            <p className="text-xs text-gray-500">{title}</p>
             </div>
        <div className="absolute left-0 bottom-full mb-2 w-72 p-3 bg-gray-800 text-white text-xs rounded-lg shadow-lg opacity-0 group-hover:opacity-100 transition-opacity duration-300 z-10 pointer-events-none">
            <h4 className="font-bold mb-2 border-b border-gray-600 pb-1">{title} Found</h4>
            <ul className="space-y-1">
                {items.map((item, index) => <li key={index}>- {item.description}</li>)}
            </ul>
            {items.length === 0 && <p className="text-gray-400">No issues found.</p>}
                </div>
            </div>
        );

const BooleanCheck = ({ value, tooltipContent }) => {
    const check = value ? 
        <CheckCircle className="w-6 h-6 text-green-500 mx-auto hover:text-green-600 transition-colors cursor-pointer" /> : 
        <XCircle className="w-6 h-6 text-red-500 mx-auto hover:text-red-600 transition-colors cursor-pointer" />;
    const ContentTooltip = ({ content, children }) => (
         <div className="relative group/content flex justify-center">
            {children}
            <div className="absolute left-1/2 -translate-x-1/2 bottom-full mb-2 w-80 p-3 bg-gray-800 text-white text-xs rounded-lg shadow-lg opacity-0 group-hover/content:opacity-100 transition-opacity duration-300 z-10 pointer-events-none">
                {content ? content : <span className="text-gray-400">Not Found</span>}
            </div>
        </div>
    );
    if (tooltipContent) {
        return <ContentTooltip content={tooltipContent}>{check}</ContentTooltip>
    }
    return check;
};

const formatDate = (dateString) => {
    if (!dateString) return null;
        const date = new Date(dateString);
    if (isNaN(date.getTime())) return dateString; // Return original if invalid
    return date.toLocaleDateString('en-GB', { day: '2-digit', month: 'short', year: 'numeric' });
};

const checkCategories = {
    performance: {
        title: "Performance",
        icon: "⚡",
        checks: { high_loading_time: "Page loads quickly", high_waiting_time: "Server responds quickly", has_render_blocking_resources: "No render-blocking resources", size_greater_than_3mb: "Page size is optimized", small_page_size: "Page is lightweight", large_page_size: "Page size is reasonable" }
    },
    security: {
        title: "Security & Technical",
        icon: "🔒",
        checks: { is_https: "Uses secure HTTPS connection", is_http: "HTTP connection available", is_www: "WWW configuration correct", has_html_doctype: "Proper HTML structure", no_doctype: "DOCTYPE declaration present", canonical: "Canonical URL defined", flash: "No Flash content (deprecated)", frame: "No frame usage (outdated)", has_favicon: "Favicon present" }
    },
    content: {
        title: "Content Quality",
        icon: "📝",
        checks: { low_content_rate: "Sufficient content density", high_content_rate: "Content not overly dense", low_character_count: "Adequate content length", high_character_count: "Content length appropriate", low_readability_rate: "Content is readable", lorem_ipsum: "No placeholder content" }
    },
    seo: {
        title: "SEO Optimization",
        icon: "🎯",
        checks: { has_meta_title: "Meta title present", title_too_long: "Title length optimal", title_too_short: "Title length sufficient", no_title: "Title tag implemented", has_micromarkup: "Rich snippets implemented", has_micromarkup_errors: "Rich snippets valid", irrelevant_title: "Title is relevant", irrelevant_description: "Description is relevant", irrelevant_meta_keywords: "Keywords are relevant", no_description: "Meta description present", duplicate_meta_tag: "No duplicate meta tags", duplicate_title_tag: "No duplicate titles", seo_friendly_url: "URLs are SEO-friendly", seo_friendly_url_characters_check: "URL characters valid", seo_friendly_url_dynamic_check: "URLs not dynamic", seo_friendly_url_keywords_check: "URLs contain keywords", seo_friendly_url_relative_length_check: "URL length appropriate" }
    },
    accessibility: {
        title: "Accessibility",
        icon: "♿",
        checks: { no_image_alt: "Images have alt text", no_image_title: "Images have titles", deprecated_html_tags: "Modern HTML used", no_h1_tag: "Main heading present" }
    }
};

/* ------------------------------------------------------------------ */
/* WEBSITE STATS – Modern SEO Dashboard Design                        */
/* ------------------------------------------------------------------ */
const WebsiteStats = ({ data, webhooks, setData }) => {
    const { ResponsiveContainer, BarChart, Bar, XAxis, YAxis, Tooltip, CartesianGrid, Cell, RadialBarChart, RadialBar, Legend, PieChart, Pie, LineChart, Line, Area, AreaChart } = window.Recharts;
    
    // Refresh state management
    const [isRefreshing, setIsRefreshing] = useState(false);
    const [refreshProgress, setRefreshProgress] = useState(0);
    const [refreshMessage, setRefreshMessage] = useState('');
    const [lastRefresh, setLastRefresh] = useState(null);
    const pollIntervalRef = useRef(null);
    const refreshStartTimeRef = useRef(null);

    // Cleanup polling on unmount
    useEffect(() => {
        return () => {
            if (pollIntervalRef.current) {
                clearInterval(pollIntervalRef.current);
            }
        };
    }, []);

    // Refresh functionality
    const triggerRefresh = async () => {
        console.log('Webhooks data:', webhooks);
        console.log('All data keys:', Object.keys(data || {}));
        
        if (!webhooks || !webhooks['On-Page Insights']) {
            alert('Refresh webhook not configured for this workbook');
            console.log('Webhook check failed. Webhooks:', webhooks);
            return;
        }

        setIsRefreshing(true);
        setRefreshProgress(5);
        setRefreshMessage('Triggering automation...');
        refreshStartTimeRef.current = Date.now();

        try {
            // Get the workbook ID from URL parameters
            const params = new URLSearchParams(window.location.search);
            const workbookId = params.get('workbookId');
            
            if (!workbookId) {
                throw new Error('No workbook ID found in URL');
            }

            // Construct the webhook URL with required parameters
            const baseWebhookUrl = webhooks['On-Page Insights'];
            const webhookUrl = `${baseWebhookUrl}?spreadsheetId=${workbookId}&tabName=${encodeURIComponent('On-Page Insights')}`;
            
            console.log('Triggering webhook:', webhookUrl);
            console.log('Base webhook URL:', baseWebhookUrl);
            console.log('Workbook ID:', workbookId);
            
            const response = await fetch(webhookUrl, {
                method: 'GET',
                mode: 'no-cors' // Many webhooks don't support CORS
            });
            
            // Show success message
            console.log('Webhook triggered successfully!');
            
            setRefreshProgress(15);
            setRefreshMessage('Automation started! Fetching fresh data...');
            
            // Start polling for data changes
            startPolling();
            
        } catch (error) {
            console.error('Error triggering refresh:', error);
            setIsRefreshing(false);
            setRefreshProgress(0);
            setRefreshMessage('');
            alert(`Failed to trigger refresh: ${error.message}`);
        }
    };

    const startPolling = () => {
        let attempts = 0;
        const maxAttempts = 6; // Poll for ~4.5 minutes (45s intervals) - reduced to avoid jarring refreshes
        
        const poll = async () => {
            attempts++;
            const elapsed = (Date.now() - refreshStartTimeRef.current) / 1000;
            const progress = Math.min(15 + (attempts * 14), 95); // Adjusted for fewer attempts
            
            setRefreshProgress(progress);
            
            // Simplified messaging to avoid jarring updates
            let message;
            if (elapsed < 90) {
                message = `Running automation... (~60s expected)`;
            } else {
                message = `Finalizing updates...`;
            }
            setRefreshMessage(message);
            
            try {
                // Check if data has been updated by fetching fresh data
                const params = new URLSearchParams(window.location.search);
                const workbookId = params.get('workbookId');
                
                if (workbookId) {
                    const scriptUrl = `https://script.google.com/macros/s/AKfycbxfOMp8d_eCVH4lFD0PNuFU1wH-gyWOwRt2EuME7GQJ4U73ZwpPDciohDH3C566YLWq/exec?workbookId=${workbookId}`;
                    
                    const response = await fetch(scriptUrl);
                    const newData = await response.json();
                    
                    // Check specifically for AI Report and other key changes
                    if (newData.websiteStats && hasDataChanged(data, newData.websiteStats)) {
                        // Data has changed! Stop polling and update in-place
                        clearInterval(pollIntervalRef.current);
                        setRefreshProgress(100);
                        setRefreshMessage('Update complete! Loading fresh data...');
                        
                        // Update the data in-place instead of page reload
                        setData(newData);
                        setLastRefresh(new Date());
                        
                        // Clear refresh state after a brief success message
                        setTimeout(() => {
                            setIsRefreshing(false);
                            setRefreshProgress(0);
                            setRefreshMessage('');
                        }, 2000);
                        return;
                    }
                }
            } catch (error) {
                console.error('Error polling for updates:', error);
            }
            
            // Stop polling after max attempts
            if (attempts >= maxAttempts) {
                clearInterval(pollIntervalRef.current);
                setIsRefreshing(false);
                setRefreshProgress(0);
                setRefreshMessage('');
                
                // Try one final check for updates
                try {
                    const params = new URLSearchParams(window.location.search);
                    const workbookId = params.get('workbookId');
                    
                    if (workbookId) {
                        const scriptUrl = `https://script.google.com/macros/s/AKfycbxfOMp8d_eCVH4lFD0PNuFU1wH-gyWOwRt2EuME7GQJ4U73ZwpPDciohDH3C566YLWq/exec?workbookId=${workbookId}`;
                        
                        fetch(scriptUrl)
                            .then(response => response.json())
                            .then(finalData => {
                                if (finalData.websiteStats) {
                                    setData(finalData);
                                    setLastRefresh(new Date());
                                    console.log('Final data update applied');
                                }
                            })
                            .catch(e => console.log('Final check failed:', e));
                    }
                } catch (error) {
                    console.error('Error in final update check:', error);
                }
            }
        };
        
        // Start with immediate poll, then continue with 45-second intervals to reduce jarring refreshes
        pollIntervalRef.current = setInterval(poll, 45000);
        
        // Poll immediately to start
        poll();
    };

    const hasDataChanged = (oldData, newData) => {
        // Check if any key data has changed, with special focus on AI Report
        const oldAiNotes = oldData.healthData?.aiNotes;
        const newAiNotes = newData.healthData?.aiNotes;
        
        // Log AI Notes comparison for debugging
        console.log('AI Notes comparison:', {
            old: oldAiNotes,
            new: newAiNotes,
            changed: oldAiNotes !== newAiNotes
        });
        
        // Check for changes in multiple key areas
        const hasChanges = (
            // AI Report is the main indicator that automation is complete
            oldAiNotes !== newAiNotes ||
            // Also check other key metrics
            oldData.healthData?.pageScore !== newData.healthData?.pageScore ||
            oldData.healthData?.siteSpeed !== newData.healthData?.siteSpeed ||
            JSON.stringify(oldData.healthData?.speedDetails) !== JSON.stringify(newData.healthData?.speedDetails) ||
            // Check if schema data has changed
            oldData.healthData?.hasSchema !== newData.healthData?.hasSchema ||
            oldData.healthData?.hasSchemaErrors !== newData.healthData?.hasSchemaErrors
        );
        
        console.log('Data change detected:', hasChanges);
        return hasChanges;
    };

    const cancelRefresh = () => {
        if (pollIntervalRef.current) {
            clearInterval(pollIntervalRef.current);
        }
        setIsRefreshing(false);
        setRefreshProgress(0);
        setRefreshMessage('');
    };

    if (!data) {
        return <PageContent><div className="p-8 text-center text-gray-500">No Website Stats data available.</div></PageContent>;
    }

    const { healthData, competitorPerfData: rawCompetitorPerfData, technicalSeoData } = data;
    
    // AI Report handling
    let aiReport = null;
    try {
        const aiNotes = healthData?.aiNotes;
        if (aiNotes !== null && aiNotes !== undefined) {
            const cleanedNotes = String(aiNotes).trim();
            if (cleanedNotes && !['true', 'false'].includes(cleanedNotes.toLowerCase())) {
                aiReport = cleanedNotes;
            }
        }
    } catch (error) {
        console.error('Error processing AI Notes:', error);
    }

    // Enhanced competitor data processing - ALL data is in milliseconds, convert to seconds
    const competitorPerfData = (rawCompetitorPerfData || []).map(comp => {
        // Process site speed - ALL data comes in milliseconds, always convert to seconds
        let siteSpeedSeconds = 0;
        const rawSpeed = String(comp['Site Speed (s)'] || '0');
        
        if (rawSpeed && rawSpeed !== '0') {
            // Remove any non-numeric characters except decimal points
            const numericSpeed = parseFloat(rawSpeed.replace(/[^\d.]/g, '')) || 0;
            
            // ALL data is in milliseconds, always convert to seconds
            siteSpeedSeconds = numericSpeed / 1000;
        }
        
        return {
            name: comp.name || 'Unknown',
            isClient: comp.isClient || false,
            'Site Speed (seconds)': parseFloat(siteSpeedSeconds.toFixed(3)), // Round to 3 decimal places
            'Est. Monthly Traffic': parseInt(String(comp['Est. Monthly Traffic'] || '0').replace(/,/g, ''), 10) || 0,
            'Referring Domains': parseInt(String(comp['Referring Domains'] || '0').replace(/,/g, ''), 10) || 0,
            'Total Backlinks': parseInt(String(comp['Total Backlinks'] || '0').replace(/,/g, ''), 10) || 0
        };
    });

    // Enhanced color schemes
    const getScoreColor = (score) => {
        if (score >= 90) return { primary: '#10b981', secondary: '#065f46', bg: 'from-emerald-500 to-green-600' };
        if (score >= 70) return { primary: '#f59e0b', secondary: '#92400e', bg: 'from-yellow-500 to-orange-500' };
        return { primary: '#ef4444', secondary: '#991b1b', bg: 'from-red-500 to-red-600' };
    };

    const scoreColors = getScoreColor(healthData.pageScore);
    // Speed processing for status calculation - ALL data is in milliseconds
    const rawSpeedValue = parseFloat(String(healthData.siteSpeed).replace(/[^\d.]/g, '')) || 0;
    const speedSec = rawSpeedValue / 1000; // Always convert from milliseconds to seconds
    
    const speedStatus = speedSec < 1.5 ? 'excellent' : speedSec < 3 ? 'good' : 'error';
    
    const hasBrokenLinks = healthData.brokenLinks === true || String(healthData.brokenLinks).toLowerCase() === 'true';
    const checksPassed = healthData.checks.checksPassed;
    const checksPercentage = (checksPassed / healthData.checks.totalChecks) * 100;

    // Enhanced gradient colors for charts
    const GRADIENT_COLORS = [
        { client: '#3b82f6', competitor: '#7c3aed' },
        { client: '#10b981', competitor: '#8b5cf6' },
        { client: '#f59e0b', competitor: '#6d28d9' },
        { client: '#8b5cf6', competitor: '#7c3aed' },
        { client: '#ec4899', competitor: '#db2777' },
        { client: '#06b6d4', competitor: '#0891b2' }
    ];

    // Enhanced metric cards with smart tooltip positioning
            const ModernMetricCard = ({ title, value, subtitle, icon, status, trend, details, tooltip, alwaysShowDetails, categoryBreakdown }) => {
            const cardRef = useRef(null);
            const [tooltipPosition, setTooltipPosition] = useState('center-top');
            const [showTooltip, setShowTooltip] = useState(false);
            const hoverTimeoutRef = useRef(null);

        useEffect(() => {
            if (!tooltip || !cardRef.current) return;

            const handleMouseEnter = () => {
                // Clear any existing timeout
                if (hoverTimeoutRef.current) {
                    clearTimeout(hoverTimeoutRef.current);
                }
                
                // Add a small delay to prevent accidental triggers
                hoverTimeoutRef.current = setTimeout(() => {
                    const cardRect = cardRef.current?.getBoundingClientRect();
                    if (!cardRect) return;
                    
                    const tooltipWidth = tooltip.width === 'large' ? 600 : 320;
                    const viewportWidth = window.innerWidth;
                    const viewportHeight = window.innerHeight;
                    
                    // Calculate if tooltip would overflow horizontally
                    const tooltipLeft = cardRect.left + cardRect.width / 2 - tooltipWidth / 2;
                    const tooltipRight = tooltipLeft + tooltipWidth;
                    
                    // Calculate if tooltip would overflow vertically
                    const estimatedTooltipHeight = tooltip.width === 'large' ? 400 : 200;
                    const spaceAbove = cardRect.top;
                    const spaceBelow = viewportHeight - cardRect.bottom;
                    
                    let position = 'center-top';
                    
                    // Determine horizontal positioning
                    if (tooltipLeft < 20) {
                        position = 'left-top';
                    } else if (tooltipRight > viewportWidth - 20) {
                        position = 'right-top';
                    }
                    
                    // Determine vertical positioning
                    if (spaceAbove < estimatedTooltipHeight && spaceBelow > spaceAbove) {
                        position = position.replace('-top', '-bottom');
                    }
                    
                    setTooltipPosition(position);
                    setShowTooltip(true);
                }, 200); // 200ms delay
            };

            const handleMouseLeave = () => {
                // Clear timeout and hide tooltip
                if (hoverTimeoutRef.current) {
                    clearTimeout(hoverTimeoutRef.current);
                }
                setShowTooltip(false);
            };

            const cardElement = cardRef.current;
            cardElement.addEventListener('mouseenter', handleMouseEnter);
            cardElement.addEventListener('mouseleave', handleMouseLeave);
            
            return () => {
                if (cardElement) {
                    cardElement.removeEventListener('mouseenter', handleMouseEnter);
                    cardElement.removeEventListener('mouseleave', handleMouseLeave);
                }
                if (hoverTimeoutRef.current) {
                    clearTimeout(hoverTimeoutRef.current);
                }
            };
        }, [tooltip]);

        // Generate tooltip classes based on position
        const getTooltipClasses = () => {
            const baseClasses = `absolute ${tooltip?.width === 'large' ? 'w-[600px]' : 'w-80'} bg-gray-900 text-white text-sm rounded-xl shadow-2xl transition-all duration-300 z-50 pointer-events-none ${showTooltip ? 'opacity-100' : 'opacity-0'}`;
            
                         switch (tooltipPosition) {
                 case 'left-top':
                     return `${baseClasses} left-0 bottom-full mb-1`;
                 case 'right-top':
                     return `${baseClasses} right-0 bottom-full mb-1`;
                 case 'center-bottom':
                     return `${baseClasses} left-1/2 -translate-x-1/2 top-full mt-1`;
                 case 'left-bottom':
                     return `${baseClasses} left-0 top-full mt-1`;
                 case 'right-bottom':
                     return `${baseClasses} right-0 top-full mt-1`;
                 default: // center-top
                     return `${baseClasses} left-1/2 -translate-x-1/2 bottom-full mb-1`;
             }
        };

        // Generate arrow classes based on position
        const getArrowClasses = () => {
            const isBottom = tooltipPosition.includes('bottom');
            const arrowBase = 'absolute w-0 h-0';
            
            if (isBottom) {
                // Arrow pointing up (tooltip below card)
                const arrowColor = 'border-b-[8px] border-l-[8px] border-r-[8px] border-l-transparent border-r-transparent border-b-gray-900';
                if (tooltipPosition.includes('left')) {
                    return `${arrowBase} ${arrowColor} left-4 bottom-full`;
                } else if (tooltipPosition.includes('right')) {
                    return `${arrowBase} ${arrowColor} right-4 bottom-full`;
                } else {
                    return `${arrowBase} ${arrowColor} left-1/2 -translate-x-1/2 bottom-full`;
                }
            } else {
                // Arrow pointing down (tooltip above card)
                const arrowColor = 'border-t-[8px] border-l-[8px] border-r-[8px] border-l-transparent border-r-transparent border-t-gray-900';
                if (tooltipPosition.includes('left')) {
                    return `${arrowBase} ${arrowColor} left-4 top-full`;
                } else if (tooltipPosition.includes('right')) {
                    return `${arrowBase} ${arrowColor} right-4 top-full`;
                } else {
                    return `${arrowBase} ${arrowColor} left-1/2 -translate-x-1/2 top-full`;
                }
            }
        };


        
        // Determine icon styling based on status
        const iconClasses = status === 'excellent' ? 'bg-green-100 text-green-600' : 
            status === 'good' ? 'bg-green-100 text-green-600' : 
            status === 'warning' ? 'bg-yellow-100 text-yellow-600' : 
            status === 'error' ? 'bg-red-100 text-red-600' : 'bg-blue-100 text-blue-600';
        
        return (
            <div ref={cardRef} className="bg-white rounded-2xl shadow-lg hover:shadow-xl transition-all duration-300 p-6 border border-gray-100 hover:border-blue-200/60 group relative hover:-translate-y-0.5 hover:scale-[1.003]">
                <div className="flex items-start justify-between mb-4">
                    <div className={`p-3 rounded-xl ${iconClasses}`}>
                        {icon}
                    </div>
                    {trend && (
                        <div className={`flex items-center text-sm ${trend.direction === 'up' ? 'text-green-600' : 'text-red-600'}`}>
                            {trend.direction === 'up' ? <ArrowUp className="w-4 h-4 mr-1" /> : <ArrowDown className="w-4 h-4 mr-1" />}
                            {trend.value}
                        </div>
                    )}
                </div>
                <h3 className="text-gray-600 text-sm font-medium mb-2">{title}</h3>
                <p className="text-2xl font-bold text-gray-900 mb-1">{value}</p>
                {subtitle && <p className="text-sm text-gray-500">{subtitle}</p>}
                
                                 {/* Always show details for certain cards */}
                 {details && alwaysShowDetails && (
                     <div className="mt-4 pt-4 border-t border-gray-100">
                         <div className="grid grid-cols-2 gap-2 text-xs">
                             {Object.entries(details).slice(0, 10).map(([key, val]) => {
                                 // Convert technical terms to user-friendly labels
                                 const friendlyLabels = {
                                     'Time to Interactive': 'Time to Interactive',
                                     'DOM Complete': 'Page Structure Ready',
                                     'Largest Contentful Paint': 'Main Content Loaded',
                                     'First Input Delay': 'Response Time',
                                     'Connection Time': 'Server Connection',
                                     'Time to Secure Connection': 'Security Setup',
                                     'Request Sent Time': 'Request Processing',
                                     'Waiting Time (TTFB)': 'Server Response',
                                     'Download Time': 'Content Download',
                                     'Full Page Load': 'Complete Load Time'
                                 };
                                 const displayLabel = friendlyLabels[key] || key;
                                 
                                 return (
                                     <div key={key} className="flex justify-between">
                                         <span className="text-gray-500">{displayLabel}:</span>
                                         <span className="font-medium">{val || 'N/A'}</span>
                                     </div>
                                 );
                             })}
                         </div>
                     </div>
                 )}
                
                {/* Category breakdown for technical checks */}
                {categoryBreakdown && (
                    <div className="mt-4 pt-4 border-t border-gray-100">
                        <div className="grid grid-cols-1 gap-2">
                            {categoryBreakdown.map((category, index) => (
                                <div key={index} className="flex items-center justify-between text-xs">
                                    <div className="flex items-center">
                                        <span className="mr-2">{category.icon}</span>
                                        <span className="text-gray-600">{category.title}</span>
                                    </div>
                                    <div className="flex items-center">
                                        <span className={`mr-1 ${category.hasErrors ? 'text-red-500' : 'text-green-500'}`}>
                                            {category.hasErrors ? '❌' : '✅'}
                                        </span>
                                        <span className="text-gray-500">{category.passed}/{category.total}</span>
                                    </div>
                                </div>
                            ))}
                        </div>
                    </div>
                )}
                
                {/* Hover-only details for cards without alwaysShowDetails */}
                {details && !alwaysShowDetails && !categoryBreakdown && (
                    <div className="mt-4 pt-4 border-t border-gray-100 opacity-0 group-hover:opacity-100 transition-opacity">
                        <div className="grid grid-cols-2 gap-2 text-xs">
                            {Object.entries(details).slice(0, 4).map(([key, val]) => (
                                <div key={key} className="flex justify-between">
                                    <span className="text-gray-500">{key}:</span>
                                    <span className="font-medium">{val || 'N/A'}</span>
                                </div>
                            ))}
                        </div>
                    </div>
                )}
                {/* Smart Positioned Tooltip - Only show on direct card hover */}
                {tooltip && (
                    <div className={getTooltipClasses()}>
                        {tooltip.header && (
                            <div className="px-4 py-3 bg-gray-800 rounded-t-xl font-semibold border-b border-gray-700">
                                {tooltip.header}
                            </div>
                        )}
                        <div className="p-4">{tooltip.content}</div>
                        <div className={getArrowClasses()}></div>
                    </div>
                )}
            </div>
        );
    };

    // Modern warnings/errors display with tooltips
    const ModernIssueCounter = ({ icon, color, title, items, textColor }) => (
        <div className="text-center relative group cursor-help">
            <div className="flex items-center justify-center mb-2">
                {icon}
                <span className={`text-2xl font-bold ${textColor} ml-2`}>{items.length}</span>
            </div>
            <p className="text-sm text-gray-600">{title}</p>
            
            {/* Modern Tooltip */}
            <div className="absolute left-1/2 -translate-x-1/2 bottom-full mb-3 w-80 bg-gray-900 text-white text-sm rounded-xl shadow-2xl opacity-0 group-hover:opacity-100 transition-all duration-300 z-50 pointer-events-none">
                <div className="px-4 py-3 bg-gray-800 rounded-t-xl font-semibold border-b border-gray-700">
                    {title} Found ({items.length})
                </div>
                <div className="p-4 max-h-48 overflow-y-auto">
                    {items.length > 0 ? (
                        <ul className="space-y-2">
                            {items.map((item, index) => (
                                <li key={index} className="flex items-start text-xs leading-relaxed">
                                    <span className="mr-2 mt-1 w-1 h-1 bg-gray-400 rounded-full flex-shrink-0"></span>
                                    <span>{item.description}</span>
                                </li>
                            ))}
                        </ul>
                    ) : (
                        <p className="text-gray-400 text-xs">No issues found.</p>
                    )}
                </div>
                <div className="absolute left-1/2 -translate-x-1/2 top-full w-0 h-0 border-l-[8px] border-r-[8px] border-t-[8px] border-l-transparent border-r-transparent border-t-gray-900"></div>
            </div>
        </div>
    );

        // Enhanced gauge component with smooth animation
    const ModernGauge = ({ score, size = 200 }) => {
        const [isDisableTransition, setIsDisableTransition] = useState(false);
        const [isAnimationCooldown, setIsAnimationCooldown] = useState(false);
        const [hasInitialized, setHasInitialized] = useState(false);
        const [lastScore, setLastScore] = useState(score);
        const circumference = 2 * Math.PI * 85;
        const strokeDasharray = circumference;
        
        // Get score colors for this specific score
        const scoreColors = getScoreColor(score);
        
        // Cap visual progress to ensure there's always a small gap (max 96.5% visual)
        const visualScore = Math.min(score, 96.5);
        const targetOffset = circumference - (visualScore / 100) * circumference;
        
        // Animation state - start empty, animate to target
        const [currentOffset, setCurrentOffset] = useState(circumference);
        
        useEffect(() => {
            // Only animate on initial load or significant score changes
            if (!hasInitialized) {
                const timer = setTimeout(() => {
                    setCurrentOffset(targetOffset);
                    setHasInitialized(true);
                    setLastScore(score);
                }, 500);
                return () => clearTimeout(timer);
            } else if (Math.abs(score - lastScore) > 0.5) {
                // Only re-animate if score changed significantly
                setCurrentOffset(targetOffset);
                setLastScore(score);
            }
        }, [targetOffset, hasInitialized, score, lastScore]);

        const handleHover = () => {
            if (!isAnimationCooldown) {
                setIsAnimationCooldown(true);
                
                // Step 1: Disable transitions and reset to empty
                setIsDisableTransition(true);
                setCurrentOffset(circumference);
                
                // Step 2: Small delay, then enable transitions and animate to target
                setTimeout(() => {
                    setIsDisableTransition(false);
                    setCurrentOffset(targetOffset);
                }, 100);
                
                // Step 3: Reset cooldown after animation completes
                setTimeout(() => {
                    setIsAnimationCooldown(false);
                }, 1500);
            }
        };

        return (
            <div className="relative flex flex-col items-center">
                <div 
                    className="relative cursor-pointer group" 
                    style={{ width: size, height: size }}
                    onMouseEnter={handleHover}
                >
                    <svg width={size} height={size} className="transform -rotate-90">
                        <defs>
                            <linearGradient id="gaugeGradient" x1="0%" y1="0%" x2="100%" y2="100%">
                                <stop offset="0%" stopColor={scoreColors.primary} />
                                <stop offset="100%" stopColor={scoreColors.secondary} />
                            </linearGradient>
                        </defs>
                        {/* Background circle */}
                        <circle
                            cx={size / 2}
                            cy={size / 2}
                            r="85"
                            fill="transparent"
                            stroke="#f3f4f6"
                            strokeWidth="12"
                        />
                        {/* Progress circle */}
                        <circle
                            cx={size / 2}
                            cy={size / 2}
                            r="85"
                            fill="transparent"
                            stroke="url(#gaugeGradient)"
                            strokeWidth="12"
                            strokeDasharray={strokeDasharray}
                            strokeDashoffset={currentOffset}
                            strokeLinecap="butt"
                            className={isDisableTransition ? '' : 'transition-all duration-1000 ease-out'}
                            style={{ 
                                filter: 'drop-shadow(0 2px 4px rgba(0,0,0,0.1))'
                            }}
                        />
                    </svg>
                    <div className="absolute inset-0 flex flex-col items-center justify-center">
                        <span className="text-4xl font-bold text-gray-900">{score.toFixed(1)}</span>
                        <span className="text-sm text-gray-500 font-medium">out of 100</span>
                    </div>
                    {/* Subtle pulse effect on hover */}
                    <div className="absolute inset-0 rounded-full bg-gradient-to-r from-blue-500/5 to-green-500/5 opacity-0 group-hover:opacity-100 transition-opacity duration-300"></div>
                </div>
                <div className="mt-4 text-center">
                    <div className="flex items-center justify-center space-x-2">
                        <h3 className="text-lg font-semibold text-gray-900">Website Health Score</h3>
                        <div className="relative group">
                            <Info className="w-4 h-4 text-gray-400 cursor-help" />
                            <div className="absolute left-1/2 -translate-x-1/2 bottom-full mb-2 w-80 p-3 bg-gray-800 text-white text-xs rounded-lg shadow-lg opacity-0 group-hover:opacity-100 transition-opacity duration-300 z-30 pointer-events-none">
                                <div className="font-semibold mb-2 border-b border-gray-600 pb-2">Website Health Score</div>
                                <div>The score starts at 100 and deducts weighted points for any critical errors (e.g. slow load, insecure HTTP, broken links) and lesser warnings (e.g. missing meta tags, large page size).</div>
                                <div className="absolute left-1/2 -translate-x-1/2 top-full w-0 h-0 border-l-[6px] border-r-[6px] border-t-[6px] border-l-transparent border-r-transparent border-t-gray-800"></div>
                            </div>
                        </div>
                    </div>
                    <p className={`text-sm font-medium ${score >= 90 ? 'text-green-600' : score >= 70 ? 'text-yellow-600' : 'text-red-600'}`}>
                        {score >= 90 ? 'Excellent' : score >= 70 ? 'Good' : 'Needs Improvement'}
                    </p>
                </div>
            </div>
        );
    };

    // Modern comparison chart with value labels and color legend
    const ModernComparisonChart = ({ data, dataKey, title, color, isInverted = false }) => {
        const { LabelList } = window.Recharts;
        
        // Smart Y-axis calculation
        const getSmartYAxisConfig = (data, dataKey) => {
            const maxValue = Math.max(...data.map(item => item[dataKey] || 0));
            
            if (dataKey === 'Site Speed (seconds)') {
                // For seconds: 0.15, 0.30, 0.45, then max or 0.60
                const suggestedMax = Math.max(0.60, Math.ceil(maxValue * 6.67) / 6.67);
                const ticks = [0, 0.15, 0.30, 0.45, suggestedMax];
                return {
                    domain: [0, suggestedMax],
                    ticks: ticks,
                    tickFormatter: (value) => `${value.toFixed(2)}s`
                };
            } else if (dataKey.includes('Traffic')) {
                // For traffic: smart increments based on max value
                let increment, suggestedMax;
                if (maxValue <= 1000) {
                    increment = 250;
                    suggestedMax = Math.max(1000, Math.ceil(maxValue / increment) * increment);
                } else if (maxValue <= 5000) {
                    increment = 1000;
                    suggestedMax = Math.ceil(maxValue / increment) * increment;
                } else if (maxValue <= 20000) {
                    increment = 5000;
                    suggestedMax = Math.ceil(maxValue / increment) * increment;
                } else {
                    increment = 10000;
                    suggestedMax = Math.ceil(maxValue / increment) * increment;
                }
                const ticks = [0, increment, increment * 2, increment * 3, suggestedMax];
                return {
                    domain: [0, suggestedMax],
                    ticks: ticks,
                    tickFormatter: (value) => value >= 1000 ? `${(value / 1000).toFixed(0)}k` : value.toString()
                };
            } else if (dataKey.includes('Domains')) {
                // For referring domains: 20, 40, 60, 80, or based on max
                const increment = 20;
                const suggestedMax = Math.max(80, Math.ceil(maxValue / increment) * increment);
                const ticks = [0, increment, increment * 2, increment * 3, suggestedMax];
                return {
                    domain: [0, suggestedMax],
                    ticks: ticks,
                    tickFormatter: (value) => value.toString()
                };
            } else if (dataKey.includes('Backlinks')) {
                // For backlinks: 50, 100, 150, 200, or based on max
                let increment = 50;
                if (maxValue > 1000) increment = 250;
                else if (maxValue > 500) increment = 100;
                
                const suggestedMax = Math.max(200, Math.ceil(maxValue / increment) * increment);
                const ticks = [0, increment, increment * 2, increment * 3, suggestedMax];
                return {
                    domain: [0, suggestedMax],
                    ticks: ticks,
                    tickFormatter: (value) => value >= 1000 ? `${(value / 1000).toFixed(1)}k` : value.toString()
                };
            }
            
            // Default fallback
            return {
                domain: [0, 'dataMax * 1.1'],
                ticks: undefined,
                tickFormatter: (value) => value.toString()
            };
        };

        // Use consistent color mapping across all charts
        const getBusinessColors = () => {
            return data.map(business => {
                const colorInfo = getConsistentColor(business.name, business.isClient, data);
                return {
                    ...business,
                    colorInfo
                };
            });
        };

        const businessesWithColors = getBusinessColors();
        
        // Truncate name function
        const truncateName = (name, maxLength = 12) => {
            if (!name || name.length <= maxLength) return name;
            return name.substring(0, maxLength - 1) + '…';
        };
        
        // Custom label formatter for different data types
        const formatLabel = (value) => {
            if (dataKey === 'Site Speed (seconds)') {
                return `${value}s`;
            } else if (dataKey.includes('Traffic') || dataKey.includes('Backlinks') || dataKey.includes('Domains')) {
                return value >= 1000 ? `${(value / 1000).toFixed(1)}k` : value.toString();
            }
            return value.toString();
        };
        
        // Custom tooltip formatter with performance indicators
        const formatTooltip = (value, name, props) => {
            const entry = props.payload;
            const isClient = entry?.isClient;
            
            // Calculate average for comparison
            const average = data.reduce((sum, item) => sum + item[dataKey], 0) / data.length;
            const isAboveAverage = isInverted ? value < average : value > average;
            
            let formattedValue;
            let displayName;
            
            if (name === 'Site Speed (seconds)') {
                formattedValue = `${value} seconds`;
                displayName = 'Site Speed';
            } else if (name.includes('Traffic')) {
                formattedValue = value.toLocaleString();
                displayName = 'Monthly Traffic';
            } else if (name.includes('Domains')) {
                formattedValue = value.toLocaleString();
                displayName = 'Referring Domains';
            } else if (name.includes('Backlinks')) {
                formattedValue = value.toLocaleString();
                displayName = 'Total Backlinks';
            } else {
                formattedValue = value.toLocaleString();
                displayName = name;
            }
            
            const indicator = isAboveAverage ? '📈 Above Average' : '📉 Below Average';
            const clientBadge = isClient ? '⭐ Your Business' : '';
            
            return [
                <div key="tooltip">
                    <div style={{ fontWeight: 'bold' }}>{formattedValue}</div>
                    <div style={{ fontSize: '11px', opacity: 0.8 }}>{indicator}</div>
                    {clientBadge && <div style={{ fontSize: '11px', color: '#60a5fa' }}>{clientBadge}</div>}
                </div>,
                displayName
            ];
        };

        // Assign colors to each entry with truncated names
        const dataWithColors = businessesWithColors.map((entry, index) => {
            const truncatedName = truncateName(entry.name);
            return { 
                ...entry, 
                name: truncatedName,
                gradientId: `business-gradient-${index}`, 
                color: entry.colorInfo.start,
                originalName: entry.name
            };
        });

        const yAxisConfig = getSmartYAxisConfig(data, dataKey);

        return (
            <div className="bg-white rounded-2xl shadow-lg hover:shadow-xl transition-all duration-300 p-6 border border-gray-100 hover:border-blue-200/60 group hover:-translate-y-0.5 hover:scale-[1.003]">
                <div className="flex justify-between items-start mb-4">
                    <div>
                        <h3 className="text-lg font-semibold text-gray-900 mb-2">{title}</h3>
                        <p className="text-sm text-gray-500">
                            {isInverted ? 'Lower is better' : 'Higher is better'}
                            {dataKey === 'Site Speed (seconds)' && ' • Measured in seconds'}
                        </p>
                    </div>
                </div>
                <ResponsiveContainer width="100%" height={280}>
                    <BarChart data={dataWithColors} margin={{ top: 40, right: 30, left: 20, bottom: 20 }}>
                        <defs>
                            {/* Business gradients */}
                            {businessesWithColors.map((business, index) => (
                                <linearGradient key={`business-gradient-${index}`} id={`business-gradient-${index}`} x1="0" y1="0" x2="0" y2="1">
                                    <stop offset="0%" stopColor={business.colorInfo.gradientStart} />
                                    <stop offset="50%" stopColor={business.colorInfo.start} />
                                    <stop offset="100%" stopColor={business.colorInfo.gradientEnd} />
                                </linearGradient>
                            ))}
                        </defs>
                        <CartesianGrid strokeDasharray="3 3" stroke="#f1f5f9" />
                        <XAxis 
                            dataKey="name" 
                            tick={{ fontSize: 12, fill: '#64748b' }}
                            height={40}
                            interval={0}
                        />
                        <YAxis 
                            tick={{ fontSize: 12, fill: '#64748b' }}
                            domain={yAxisConfig.domain}
                            ticks={yAxisConfig.ticks}
                            tickFormatter={yAxisConfig.tickFormatter}
                        />
                        <Tooltip 
                            contentStyle={{ 
                                backgroundColor: 'rgba(31, 41, 55, 0.95)', 
                                border: '1px solid #374151', 
                                borderRadius: '12px',
                                boxShadow: '0 20px 25px -5px rgb(0 0 0 / 0.1)',
                                color: '#fff'
                            }}
                            itemStyle={{ color: '#fff' }}
                            labelStyle={{ color: '#fff', fontWeight: 'bold' }}
                            formatter={formatTooltip}
                            cursor={{ fill: 'rgba(59, 130, 246, 0.1)' }}
                        />
                        <Bar dataKey={dataKey} radius={[6, 6, 0, 0]} barSize={40}>
                            {dataWithColors.map((entry, index) => (
                                <Cell 
                                    key={`cell-${index}`} 
                                    fill={`url(#${entry.gradientId})`}
                                />
                            ))}
                            <LabelList 
                                dataKey={dataKey} 
                                position="top" 
                                style={{ 
                                    fill: '#374151', 
                                    fontSize: 12, 
                                    fontWeight: 'bold' 
                                }}
                                formatter={formatLabel}
                            />
                        </Bar>
                    </BarChart>
                </ResponsiveContainer>
                
                {/* Color Legend at Bottom */}
                <div className="mt-4 pt-4 border-t border-gray-100">
                    <div className="flex flex-col items-center space-y-2">
                        {/* Top row - 3 items */}
                        <div className="flex justify-center space-x-6">
                            {dataWithColors.slice(0, 3).map((entry, index) => (
                                <div key={index} className="flex items-center space-x-2 min-w-0">
                                    <div 
                                        className="w-3 h-3 rounded shadow-sm flex-shrink-0" 
                                        style={{ backgroundColor: entry.color }}
                                    ></div>
                                    <span className="text-xs text-gray-600 font-medium truncate" title={entry.originalName}>
                                        {truncateName(entry.originalName, 14)}
                                        {entry.isClient && ' ⭐'}
                                    </span>
                                </div>
                            ))}
                        </div>
                        {/* Bottom row - 2 items (if they exist) */}
                        {dataWithColors.length > 3 && (
                            <div className="flex justify-center space-x-6">
                                {dataWithColors.slice(3).map((entry, index) => (
                                    <div key={index + 3} className="flex items-center space-x-2 min-w-0">
                                        <div 
                                            className="w-3 h-3 rounded shadow-sm flex-shrink-0" 
                                            style={{ backgroundColor: entry.color }}
                                        ></div>
                                        <span className="text-xs text-gray-600 font-medium truncate" title={entry.originalName}>
                                            {truncateName(entry.originalName, 14)}
                                            {entry.isClient && ' ⭐'}
                                        </span>
                                    </div>
                                ))}
                            </div>
                        )}
                    </div>
                </div>
            </div>
        );
    };

    return (
        <PageContent>
            {/* Header Section */}
            <div className="mb-8">
                <div className="flex justify-between items-center">
                    <div>
                        <h1 className="text-3xl font-bold text-gray-900">Website Performance</h1>
                        <p className="text-gray-600 mt-1">Comprehensive technical SEO analysis and competitor comparison</p>
                    </div>
                    <div className="flex items-center space-x-4">
                        {lastRefresh && (
                            <span className="text-sm text-gray-500">
                                Last updated: {lastRefresh.toLocaleTimeString()}
                            </span>
                        )}
                        
                        {/* Inline Progress Indicator */}
                        {isRefreshing && (
                            <div className="flex items-center space-x-3 bg-white rounded-xl shadow-md px-4 py-2 border border-gray-100">
                                <div className="flex items-center space-x-2">
                                    <div className="w-4 h-4 border-2 border-blue-500 border-t-transparent rounded-full animate-spin"></div>
                                    <span className="text-sm font-medium text-gray-700">{refreshMessage}</span>
                                </div>
                                <div className="w-16 bg-gray-200 rounded-full h-2">
                                    <div 
                                        className="bg-gradient-to-r from-blue-500 to-blue-600 h-2 rounded-full transition-all duration-500 ease-out"
                                        style={{ width: `${refreshProgress}%` }}
                                    ></div>
                                </div>
                                <span className="text-xs font-medium text-blue-600 min-w-[2rem]">{refreshProgress}%</span>
                            </div>
                        )}
                        
                        <button 
                            onClick={isRefreshing ? cancelRefresh : triggerRefresh}
                            disabled={!webhooks}
                            className={`px-6 py-2 rounded-xl font-medium transition-all duration-200 shadow-lg hover:shadow-xl ${
                                isRefreshing 
                                    ? 'bg-red-500 hover:bg-red-600 text-white' 
                                    : 'bg-gradient-to-r from-blue-500 to-blue-600 hover:from-blue-600 hover:to-blue-700 text-white'
                            } disabled:opacity-50 disabled:cursor-not-allowed`}
                        >
                            {isRefreshing ? 'Cancel' : 'Update Analytics'}
                        </button>
                    </div>
                </div>
            </div>

            {/* Main Health Dashboard */}
            <div className="grid grid-cols-1 xl:grid-cols-12 gap-6 mb-8">
                {/* Health Score Gauge - Left Column */}
                <div className="xl:col-span-4">
                    <div className="bg-white rounded-2xl shadow-lg p-8 border border-gray-100 h-full flex flex-col justify-center hover:-translate-y-0.5 transition-all duration-300 hover:shadow-xl hover:border-blue-200/60 hover:scale-[1.003]">
                        <ModernGauge score={healthData.pageScore} />
                        <div className="flex justify-center space-x-8 mt-6">
                            <ModernIssueCounter
                                icon={<AlertTriangle className="w-5 h-5 text-yellow-500" />}
                                title="Warnings"
                                items={healthData.warnings || []}
                                textColor="text-yellow-600"
                            />
                            <ModernIssueCounter
                                icon={<XCircle className="w-5 h-5 text-red-500" />}
                                title="Errors"
                                items={healthData.errors || []}
                                textColor="text-red-600"
                            />
                        </div>
                    </div>
                </div>

                {/* Right Column - 2x2 + 3 Layout */}
                <div className="xl:col-span-8 space-y-4">
                    {/* Top Row - 2 Large Cards */}
                    <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div className="bg-white rounded-2xl shadow-lg hover:shadow-xl transition-all duration-300 p-6 border border-gray-100 hover:border-blue-200/60 relative hover:-translate-y-0.5 hover:scale-[1.003]">
                            <div className="flex items-start justify-between mb-4">
                                <div className={`p-3 rounded-xl ${speedStatus === 'excellent' ? 'bg-green-100 text-green-600' : speedStatus === 'good' ? 'bg-green-100 text-green-600' : 'bg-red-100 text-red-600'}`}>
                                    <TrendingUp className="w-6 h-6" />
                                </div>
                            </div>
                            <div className="flex items-center space-x-2 mb-2">
                                <h3 className="text-gray-600 text-sm font-medium">Page Load Speed</h3>
                                <div className="relative">
                                    <div className="info-tooltip-trigger cursor-help">
                                        <Info className="w-4 h-4 text-gray-400" />
                                    </div>
                                    <div className="absolute left-1/2 -translate-x-1/2 bottom-full mb-2 w-80 p-3 bg-gray-800 text-white text-xs rounded-lg shadow-lg opacity-0 transition-opacity duration-300 z-30 pointer-events-none info-tooltip-content">
                                        <div className="font-semibold mb-2 border-b border-gray-600 pb-2">Page Load Speed Testing</div>
                                        <div>Each test loads your page in a fresh browser and measures it in real time. Shifts in network traffic, server load, or third-party scripts may vary results.</div>
                                        <svg className="absolute text-gray-800 h-2 w-full left-0 top-full" x="0px" y="0px" viewBox="0 0 255 255"><polygon className="fill-current" points="0,0 127.5,127.5 255,0"/></svg>
                                    </div>
                                </div>
                            </div>
                            <p className="text-2xl font-bold text-gray-900 mb-1">
                                {(() => {
                                    const speed = healthData.siteSpeed;
                                    if (speed && !isNaN(speed)) {
                                        // ALL data comes in milliseconds, always convert to seconds
                                        const numericSpeed = parseFloat(speed);
                                        const seconds = (numericSpeed / 1000).toFixed(3);
                                        return `${seconds} seconds`;
                                    }
                                    return speed || 'N/A';
                                })()}
                            </p>
                            <p className="text-sm text-gray-500">{speedStatus === 'excellent' ? 'Excellent' : speedStatus === 'good' ? 'Good' : 'Poor Performance'}</p>
                            
                            {/* Speed Details */}
                            <div className="mt-4 pt-4 border-t border-gray-100">
                                <div className="grid grid-cols-2 gap-2 text-xs">
                                    {Object.entries(healthData.speedDetails).slice(0, 10).map(([key, val]) => {
                                        // Convert technical terms to user-friendly labels
                                        const friendlyLabels = {
                                            'Time to Interactive': 'Time to Interactive',
                                            'DOM Complete': 'Page Structure Ready',
                                            'Largest Contentful Paint': 'Main Content Loaded',
                                            'First Input Delay': 'Response Time',
                                            'Connection Time': 'Server Connection',
                                            'Time to Secure Connection': 'Security Setup',
                                            'Request Sent Time': 'Request Processing',
                                            'Waiting Time (TTFB)': 'Server Response',
                                            'Download Time': 'Content Download',
                                            'Full Page Load': 'Complete Load Time'
                                        };
                                        const displayLabel = friendlyLabels[key] || key;
                                        
                                        // Format the value - ALL data is in milliseconds, convert to seconds
                                        let formattedVal = val || '-';
                                        if (val && !isNaN(val)) {
                                            const numericVal = parseFloat(val);
                                            // ALL data is in milliseconds, always convert to seconds
                                            const seconds = (numericVal / 1000).toFixed(3);
                                            formattedVal = `${seconds}s`;
                                        } else if (val && typeof val === 'string' && val.includes('ms')) {
                                            // If already in ms format, convert to seconds
                                            const msValue = parseFloat(val.replace('ms', ''));
                                            if (!isNaN(msValue)) {
                                                formattedVal = `${(msValue / 1000).toFixed(3)}s`;
                                            }
                                        }
                                        
                                        return (
                                            <div key={key} className="text-gray-600 flex">
                                                <span className="text-gray-500 w-32">{displayLabel}:</span>
                                                <span className="font-medium ml-4">{formattedVal}</span>
                                            </div>
                                        );
                                    })}
                                </div>
                            </div>
                        </div>
                                                <div className="bg-white rounded-2xl shadow-lg hover:shadow-xl transition-all duration-300 p-6 border border-gray-100 hover:border-blue-200/60 group relative hover:-translate-y-0.5 hover:scale-[1.003]">
                            <div className="flex items-start justify-between mb-4">
                                <div className={`p-3 rounded-xl ${checksPercentage >= 90 ? 'bg-green-100 text-green-600' : checksPercentage >= 80 ? 'bg-green-100 text-green-600' : checksPercentage >= 60 ? 'bg-yellow-100 text-yellow-600' : 'bg-red-100 text-red-600'}`}>
                                    <CheckCircle className="w-6 h-6" />
                                </div>
                            </div>
                            <div className="flex items-center space-x-2 mb-2">
                                <h3 className="text-gray-600 text-sm font-medium">Technical Checks</h3>
                                <div className="relative">
                                    <div className="info-tooltip-trigger cursor-help">
                                        <Info className="w-4 h-4 text-gray-400" />
                                    </div>
                                    <div className="absolute left-1/2 -translate-x-1/2 bottom-full mb-2 w-80 p-3 bg-gray-800 text-white text-xs rounded-lg shadow-lg opacity-0 transition-opacity duration-300 z-30 pointer-events-none info-tooltip-content">
                                        <div className="font-semibold mb-2 border-b border-gray-600 pb-2">Technical SEO Health Check</div>
                                        <div>Automated checks for essential SEO elements including performance, security, content quality, accessibility, and technical implementation. Each check validates best practices that impact search rankings and user experience.</div>
                                        <svg className="absolute text-gray-800 h-2 w-full left-0 top-full" x="0px" y="0px" viewBox="0 0 255 255"><polygon className="fill-current" points="0,0 127.5,127.5 255,0"/></svg>
                                    </div>
                                </div>
                            </div>
                            <p className="text-2xl font-bold text-gray-900 mb-1">{checksPassed}/{healthData.checks.totalChecks}</p>
                            <p className="text-sm text-gray-500">{checksPercentage.toFixed(1)}% passed</p>
                            
                            {/* Category Breakdown */}
                            <div className="mt-4 pt-4 border-t border-gray-100">
                                <div className="grid grid-cols-1 gap-2">
                                    {(() => {
                                        // Reorder categories as requested: Performance, Security & Technical, SEO Optimization, Content Quality, Accessibility
                                        const orderedCategories = ['performance', 'security', 'seo', 'content', 'accessibility'];
                                        return orderedCategories.map(category => {
                                            const categoryData = checkCategories[category];
                                            if (!categoryData) return null;
                                            
                                            const categoryChecks = Object.entries(categoryData.checks).filter(([checkName]) => 
                                                healthData.checks.passedList.includes(checkName) || healthData.checks.failedList.includes(checkName)
                                            );
                                            
                                            if (categoryChecks.length === 0) return null;
                                            
                                            const passedCount = categoryChecks.filter(([checkName]) => healthData.checks.passedList.includes(checkName)).length;
                                            const hasErrors = passedCount < categoryChecks.length;
                                            
                                            return (
                                                <div key={category} className="flex items-center justify-between text-xs">
                                                    <div className="flex items-center">
                                                        <span className="mr-2">{categoryData.icon}</span>
                                                        <span className="text-gray-600">{categoryData.title}</span>
                                                    </div>
                                                    <div className="flex items-center">
                                                        <span className={`mr-1 ${hasErrors ? 'text-red-500' : 'text-green-500'}`}>
                                                            {hasErrors ? '❌' : '✅'}
                                                        </span>
                                                        <span className="text-gray-500">{passedCount}/{categoryChecks.length}</span>
                                                    </div>
                                                </div>
                                            );
                                        });
                                    })()}
                                </div>
                            </div>
                            
                            {/* Detailed Hover Tooltip with improved hover behavior */}
                                                                <div className="absolute left-1/2 -translate-x-1/2 top-full mt-2 w-[600px] bg-gray-900 text-white text-sm rounded-xl shadow-2xl opacity-0 group-hover:opacity-100 transition-opacity duration-300 z-[9999] pointer-events-none group-hover:pointer-events-auto">
                                <div className="px-4 py-3 bg-gray-800 rounded-t-xl font-semibold border-b border-gray-700">
                                    Technical SEO Health Check Results
                                </div>
                                <div className="p-4">
                                    <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                                        {(() => {
                                            // Reorder categories as requested: Performance, Security & Technical, SEO Optimization, Content Quality, Accessibility
                                            const topRowCategories = ['performance', 'security', 'seo'];
                                            const bottomRowCategories = ['content', 'accessibility'];
                                            const allCategories = [...topRowCategories, ...bottomRowCategories];
                                            
                                            return allCategories.map(category => {
                                                const categoryData = checkCategories[category];
                                                if (!categoryData) return null;
                                                
                                                const categoryChecks = Object.entries(categoryData.checks).filter(([checkName]) => 
                                                    healthData.checks.passedList.includes(checkName) || healthData.checks.failedList.includes(checkName)
                                                );
                                                
                                                if (categoryChecks.length === 0) return null;
                                                
                                                return (
                                                    <div key={category} className="space-y-2">
                                                        <h4 className="font-semibold flex items-center text-gray-300 text-sm">
                                                            <span className="mr-2">{categoryData.icon}</span>
                                                            {categoryData.title}
                                                        </h4>
                                                        <ul className="space-y-1.5">
                                                            {categoryChecks.map(([checkName, description]) => {
                                                                const isPassed = healthData.checks.passedList.includes(checkName);
                                                                return (
                                                                    <li key={checkName} className="flex items-start text-xs leading-relaxed">
                                                                        <span className="mr-2 flex-shrink-0 text-sm">{isPassed ? '✅' : '❌'}</span>
                                                                        <span className={isPassed ? 'text-green-300' : 'text-red-300'}>
                                                                            {description}
                                                                        </span>
                                                                    </li>
                                                                );
                                                            })}
                                                        </ul>
                                                    </div>
                                                );
                                            });
                                        })()}
                                    </div>
                                </div>
                                <div className="absolute left-1/2 -translate-x-1/2 bottom-full w-0 h-0 border-l-[8px] border-r-[8px] border-b-[8px] border-l-transparent border-r-transparent border-b-gray-900"></div>
                            </div>
                        </div>
                    </div>

                    {/* Bottom Row - 3 Compact Cards */}
                    <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div className="bg-white rounded-xl shadow-md hover:shadow-lg transition-all duration-300 p-4 border border-gray-100 hover:border-blue-200/60 hover:-translate-y-0.5 hover:scale-[1.003]">
                            <div className="flex items-center justify-between">
                                <div className={`p-2 rounded-lg ${hasBrokenLinks ? 'bg-red-100 text-red-600' : 'bg-green-100 text-green-600'}`}>
                                    <Link2 className="w-5 h-5" />
                                </div>
                            </div>
                            <div className="flex items-center space-x-1 mt-3 mb-1">
                                <h3 className="text-gray-600 text-sm font-medium">Broken Links</h3>
                                <InfoTooltip text="Checks for broken internal and external links on your website. Broken links hurt user experience and can negatively impact SEO rankings." />
                            </div>
                            <p className="text-lg font-bold text-gray-900">{hasBrokenLinks ? 'Issues Found' : 'All Good'}</p>
                            <p className="text-xs text-gray-500">{hasBrokenLinks ? 'Fix required' : 'No broken links'}</p>
                        </div>
                        
                        <div className="bg-white rounded-xl shadow-md hover:shadow-lg transition-all duration-300 p-4 border border-gray-100 hover:border-blue-200/60 hover:-translate-y-0.5 hover:scale-[1.003]">
                            <div className="flex items-center justify-between">
                                <div className={`p-2 rounded-lg ${healthData.ssl ? 'bg-green-100 text-green-600' : 'bg-red-100 text-red-600'}`}>
                                    <ShieldCheck className="w-5 h-5" />
                                </div>
                            </div>
                            <div className="flex items-center space-x-1 mt-3 mb-1">
                                <h3 className="text-gray-600 text-sm font-medium">SSL Certificate</h3>
                                <InfoTooltip text="Ensures your website uses HTTPS encryption to protect user data and improve search rankings. Google requires SSL certificates for secure browsing." />
                            </div>
                            <p className="text-lg font-bold text-gray-900">{healthData.ssl ? 'Secure' : 'Not Secure'}</p>
                            <p className="text-xs text-gray-500">{healthData.ssl ? 'HTTPS enabled' : 'HTTPS required'}</p>
                        </div>
                        
                        <div className="bg-white rounded-xl shadow-md hover:shadow-lg transition-all duration-300 p-4 border border-gray-100 hover:border-blue-200/60 hover:-translate-y-0.5 hover:scale-[1.003]">
                            <div className="flex items-center justify-between">
                                <div className={`p-2 rounded-lg ${
                                    healthData.hasSchema 
                                        ? (healthData.hasSchemaErrors ? 'bg-yellow-100 text-yellow-600' : 'bg-green-100 text-green-600')
                                        : 'bg-red-100 text-red-600'
                                }`}>
                                    <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M10 20l4-16m4 4l4 4-4 4M6 16l-4-4 4-4" />
                                    </svg>
                                </div>
                            </div>
                            <div className="flex items-center space-x-1 mt-3 mb-1">
                                <h3 className="text-gray-600 text-sm font-medium">Schema Markup</h3>
                                <InfoTooltip text="Structured data that helps search engines understand your content better. Schema markup can improve rich snippets and local business visibility in search results." />
                            </div>
                            <p className="text-lg font-bold text-gray-900">{healthData.hasSchema ? 'Implemented' : 'Missing'}</p>
                            <p className="text-xs text-gray-500">
                                {healthData.hasSchema 
                                    ? (healthData.hasSchemaErrors ? 'Has errors to fix' : 'Valid and healthy')
                                    : 'Add structured data'
                                }
                            </p>
                        </div>
                    </div>
                </div>
            </div>

            {/* Performance Comparison Section */}
            <div className="mb-8">
                <div className="bg-gradient-to-r from-blue-50 to-indigo-50 rounded-2xl p-6 border border-blue-100">
                    <h2 className="text-2xl font-bold text-gray-900 mb-2">Competitive Analysis</h2>
                    <p className="text-gray-600 mb-6">Compare your website performance against key competitors</p>
                    
                    <div className="grid grid-cols-1 lg:grid-cols-2 gap-8">
                        <ModernComparisonChart 
                            data={competitorPerfData} 
                            dataKey="Site Speed (seconds)" 
                            title="Site Speed Comparison"
                            color={GRADIENT_COLORS[0]}
                            isInverted={true}
                        />
                        <ModernComparisonChart 
                            data={competitorPerfData} 
                            dataKey="Est. Monthly Traffic" 
                            title="Monthly Traffic"
                            color={GRADIENT_COLORS[1]}
                        />
                        <ModernComparisonChart 
                            data={competitorPerfData} 
                            dataKey="Referring Domains" 
                            title="Referring Domains"
                            color={GRADIENT_COLORS[2]}
                        />
                        <ModernComparisonChart 
                            data={competitorPerfData} 
                            dataKey="Total Backlinks" 
                            title="Total Backlinks"
                            color={GRADIENT_COLORS[3]}
                        />
                    </div>
                </div>
            </div>

            {/* AI Report Section */}
            <div className="mb-8">
                <AIReportSection 
                    reportText={aiReport || 'AI Report will appear here once generated in the On-Page Insights sheet (column CP)'} 
                    title="AI-Powered Analysis" 
                />
            </div>

                        {/* Modern Technical SEO Table */}
            <div className="bg-white rounded-2xl shadow-lg border border-gray-100 overflow-hidden group hover:shadow-xl transition-all duration-300 hover:-translate-y-0.5 hover:border-blue-200/60 hover:scale-[1.001]">
                <div className="flex items-center space-x-2 mb-4">
                    <h2 className="text-xl font-bold text-gray-800">Technical SEO Checklist</h2>
                    <InfoTooltip text="Essential technical elements across all websites for optimal search engine performance." />
                </div>
                <div className="bg-gradient-to-r from-slate-50 to-blue-50 px-8 py-6 border-b border-gray-200">
                    <p className="text-gray-600">Essential technical elements across all websites</p>
                </div>
                <div className="overflow-x-auto">
                    <table className="w-full">
                        <thead>
                            <tr className="border-b-2 border-gray-200">
                                <th className="py-2 px-3 text-left">Clinic Name</th>
                                <th className="py-2 px-3 text-center">SSL Certificate</th>
                                <th className="py-2 px-3 text-center">Schema Markup</th>
                                <th className="py-2 px-3 text-center">H1 Tag</th>
                                <th className="py-2 px-3 text-center">Title Tag</th>
                                <th className="py-2 px-3 text-center">Meta Description</th>
                             </tr>
                         </thead>
                        <tbody className="divide-y divide-gray-100 bg-white">
                            {technicalSeoData.map((site, index) => (
                                <tr key={site.name || site.id || index} className={`border-b border-gray-100 ${site.isClient ? 'bg-blue-50' : ''}`}>
                                    <td className="py-3 px-3">
                                        <div>
                                            <div className={`font-semibold text-base ${site.isClient ? 'text-blue-900' : 'text-gray-900'}`}>
                                                {site.clinicName || site.name}
                                            </div>
                                            {site.website && (
                                                <div className="text-sm text-gray-500 mt-1">
                                                    <a href={site.website} target="_blank" rel="noopener noreferrer" 
                                                       className="text-blue-600 hover:text-blue-800 hover:underline transition-colors">
                                                        {site.website.replace(/^https?:\/\//i, '')}
                                                    </a>
                                                </div>
                                            )}
                                        </div>
                                    </td>
                                    <td className="py-3 px-3 text-center">
                                        {site.hasSSL ? (
                                            <CheckCircle className="w-6 h-6 text-green-500 mx-auto hover:text-green-600 transition-colors cursor-pointer" />
                                        ) : (
                                            <XCircle className="w-6 h-6 text-red-500 mx-auto hover:text-red-600 transition-colors cursor-pointer" />
                                        )}
                                    </td>
                                    <td className="py-3 px-3 text-center">
                                        {site.hasSchema ? (
                                            <CheckCircle className="w-6 h-6 text-green-500 mx-auto hover:text-green-600 transition-colors cursor-pointer" />
                                        ) : (
                                            <XCircle className="w-6 h-6 text-red-500 mx-auto hover:text-red-600 transition-colors cursor-pointer" />
                                        )}
                                    </td>
                                    <td className="py-3 px-3 text-center">
                                        <BooleanCheck value={site.h1} tooltipContent={site.h1} />
                                    </td>
                                    <td className="py-3 px-3 text-center">
                                        <BooleanCheck value={site.title} tooltipContent={site.title} />
                                    </td>
                                    <td className="py-3 px-3 text-center">
                                        <BooleanCheck value={site.description} tooltipContent={site.description} />
                                    </td>
                                 </tr>
                             ))}
                         </tbody>
                     </table>
                 </div>
            </div>
        </PageContent>
    );
};

/* ------------------------------------------------------------------ */
/* DAY/NIGHT TOGGLE SWITCH COMPONENT                                  */
/* ------------------------------------------------------------------ */
const DayNightSwitch = ({ defaultChecked = true, onToggle }) => {
  const [isDay, setIsDay] = useState(defaultChecked);

  // Sync with external theme changes
  useEffect(() => {
    setIsDay(defaultChecked);
  }, [defaultChecked]);

  const handleToggle = () => {
    const newValue = !isDay;
    setIsDay(newValue);
    onToggle?.(newValue);
  };

  return (
    <div 
      className={`day-night-switch ${isDay ? 'day' : 'night'}`}
      onClick={handleToggle}
      role="button"
      tabIndex={0}
      aria-label={`Switch to ${isDay ? 'dark' : 'light'} mode`}
      onKeyDown={(e) => {
        if (e.key === 'Enter' || e.key === ' ') {
          e.preventDefault();
          handleToggle();
        }
      }}
    >
      {/* Slider */}
      <div className="switch-slider"></div>
      
      {/* Sun */}
      <div className="sun">
        <div className="sun-rays">
          <div className="sun-ray"></div>
          <div className="sun-ray"></div>
          <div className="sun-ray"></div>
          <div className="sun-ray"></div>
          <div className="sun-ray"></div>
          <div className="sun-ray"></div>
          <div className="sun-ray"></div>
          <div className="sun-ray"></div>
        </div>
      </div>
      
      {/* Moon */}
      <div className="moon">
        <div className="moon-shape">
          <div className="moon-crater"></div>
        </div>
      </div>
      
      {/* Clouds */}
      <div className="clouds">
        <div className="cloud cloud-1"></div>
        <div className="cloud cloud-2"></div>
      </div>
      
      {/* Stars */}
      <div className="stars">
        <div className="star"></div>
        <div className="star"></div>
        <div className="star"></div>
        <div className="star"></div>
        <div className="star"></div>
        <div className="star"></div>
        <div className="star"></div>
        <div className="star"></div>
      </div>
    </div>
  );
};

/* ------------------------------------------------------------------ */
/* HEADER                                                             */
/* ------------------------------------------------------------------ */
const Header = ({active,setActive,theme,onThemeToggle}) => {
  const tabs=['Dashboard','Website Stats','Keywords','Backlinks','Geogrid Maps','Tools'];
  return (
    <header className="sticky top-0 z-20" style={{ backgroundColor: 'var(--header-bg)', boxShadow: 'var(--header-shadow)' }}>
      <nav className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
        <div className="flex items-center justify-between h-16">
          <div className="flex items-center">
            <svg className="h-8 w-8" viewBox="0 0 24 24" fill="none"
                 stroke="url(#lg)" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
              <defs>
                <linearGradient id="lg" x1="0%" y1="0%" x2="100%" y2="0%">
                  <stop offset="0%" stopColor="#3b82f6"/><stop offset="100%" stopColor="#ec4899"/>
                </linearGradient>
              </defs>
              <path d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"/>
            </svg>
            <h1 className="text-xl font-bold ml-3 bg-gradient-to-r from-blue-500 to-pink-500 bg-clip-text text-transparent">
              MedSpa SEO
            </h1>
          </div>
          <div className="flex items-center space-x-6">
            <div className="hidden md:block">
              <div className="ml-10 flex space-x-4">
                {tabs.map(t=>(
                  <button key={t}
                          onClick={()=>setActive(t)}
                          className={`px-3 py-2 rounded-md text-sm font-medium transition-colors
                            ${active===t?'bg-blue-600 text-white':'text-gray-500 hover:bg-gray-100 hover:text-gray-900'}`}
                          style={active !== t ? {
                            color: theme === 'dark' ? 'var(--text-secondary)' : undefined
                          } : undefined}>
                    {t}
                  </button>
                ))}
              </div>
            </div>
            
            {/* Day/Night Toggle Switch */}
            <DayNightSwitch 
              defaultChecked={theme === 'light'}
              onToggle={onThemeToggle}
            />
          </div>
        </div>
      </nav>
    </header>
  );
};

/* ------------------------------------------------------------------ */
/* MAIN APP – fetches data, routes tabs                               */
/* ------------------------------------------------------------------ */
const App = () => {
  // Initialize tab from URL parameter, fallback to 'Dashboard'
  const getInitialTab = () => {
    const urlParams = new URLSearchParams(location.search);
    const tabFromUrl = urlParams.get('tab');
    const validTabs = ['Dashboard', 'Website Stats', 'Geogrid Maps', 'Keywords', 'Backlinks', 'Tools'];
    return validTabs.includes(tabFromUrl) ? tabFromUrl : 'Dashboard';
  };

  // Initialize theme from localStorage, fallback to 'light'
  const getInitialTheme = () => {
    const saved = localStorage.getItem('medSpaTheme');
    return saved === 'dark' ? 'dark' : 'light';
  };

  const [tab, setTab]   = useState(getInitialTab());
  const [data, setData] = useState(null);
  const [err,  setErr]  = useState(null);
  const [load, setLoad] = useState(true);
  const [theme, setTheme] = useState(getInitialTheme());

  // Update URL when tab changes
  useEffect(() => {
    const urlParams = new URLSearchParams(location.search);
    if (tab !== 'Dashboard') {
      urlParams.set('tab', tab);
    } else {
      urlParams.delete('tab');
    }
    const newUrl = `${location.pathname}?${urlParams.toString()}`;
    window.history.replaceState({}, '', newUrl);
  }, [tab]);

  // Handle theme changes and persist to localStorage
  const handleThemeToggle = (isDay) => {
    const newTheme = isDay ? 'light' : 'dark';
    setTheme(newTheme);
    localStorage.setItem('medSpaTheme', newTheme);
    
    // Apply theme to document root
    document.documentElement.setAttribute('data-theme', newTheme);
  };

  // Apply theme on mount and when theme changes
  useEffect(() => {
    document.documentElement.setAttribute('data-theme', theme);
  }, [theme]);

  useEffect(() => {
    const id = new URLSearchParams(location.search).get('workbookId');
    if (!id) { setErr('Add ?workbookId=YOUR_ID to the URL'); setLoad(false); return; }

    fetchWithCorsWorkaround(`https://script.google.com/macros/s/AKfycbxfOMp8d_eCVH4lFD0PNuFU1wH-gyWOwRt2EuME7GQJ4U73ZwpPDciohDH3C566YLWq/exec?workbookId=${id}`, (err, j) => {
      if (err) {
        console.error(err);
        setErr(err.message);
        setLoad(false);
        return;
      }
      if (j.error) {
        setErr(`Script error: ${j.error}`);
        setLoad(false);
        return;
      }
      console.log('Data loaded successfully:', Object.keys(j));
      console.log('Webhooks in data:', j.webhooks);
      setData(j); 
      setLoad(false); 
    });
  }, []);

  /* routing */
  let body;
  if (load) {
    body = (
      <PageContent>
        <div className="p-8 text-center text-gray-500">Loading data…</div>
      </PageContent>
    );
  } else if (err) {
    body = (
      <PageContent>
        <div className="p-8 text-center text-red-500">{err}</div>
      </PageContent>
    );
  } else {
    switch (tab) {
      case 'Dashboard':
        body = <Dashboard setActiveTab={setTab} />;
        break;
      case 'Website Stats':
        body = <WebsiteStats data={data.websiteStats} webhooks={data.webhooks} setData={setData} />;
        break;
      case 'Geogrid Maps':
        body = <GeogridMaps data={data.geogridData} />;
        break;
      case 'Keywords':
        body = (
          <Keywords
            summary={data.keywordsSummary}
            table={data.keywordsTable}
            webhooks={data.webhooks}
            setData={setData}
          />
        );
        break;
      case 'Backlinks':
        body = <Backlinks />;
        break;
      default:
        body = <ToolsPage />;
    }
  }

  /* ----- render ----- */
            return (
    <div className="min-h-screen font-sans" style={{ backgroundColor: 'var(--bg-primary)' }}>
      <Header active={tab} setActive={setTab} theme={theme} onThemeToggle={handleThemeToggle} />
      {body}
    </div>
  );
};

/* ------------------------------------------------------------------ */
/* Optimized App Initialization                                       */
/* ------------------------------------------------------------------ */

// Simple app initialization with performance tracking
const initializeApp = () => {
  const requiredGlobals = ['React', 'ReactDOM', 'Recharts'];
  const allLoaded = requiredGlobals.every(global => window[global]);
  
  if (allLoaded) {
    const loadTime = performance.now();
    console.log('✅ All dependencies loaded, mounting React app...');
    console.log(`⚡ Total load time: ${loadTime.toFixed(2)}ms`);
    
    // Update progress
    const progressEl = document.getElementById('load-progress');
    if (progressEl) progressEl.textContent = 'Starting application...';
    
    ReactDOM.createRoot(document.getElementById('root')).render(<App />);
  } else {
    const missing = requiredGlobals.filter(g => !window[g]);
    console.log('⏳ Waiting for dependencies...', missing);
    
    // Update progress
    const progressEl = document.getElementById('load-progress');
    if (progressEl) progressEl.textContent = `Loading ${missing.join(', ')}...`;
    
    setTimeout(initializeApp, 100);
  }
};



// Start initialization when DOM is ready
if (document.readyState === 'loading') {
  document.addEventListener('DOMContentLoaded', initializeApp);
} else {
  initializeApp();
}
</script>
</body>
</html>
