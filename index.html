<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>MedSpa SEO Dashboard</title>

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Font -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet" />

  <style>
    body{font-family:'Inter',sans-serif}
    .loader-container{display:flex;flex-direction:column;justify-content:center;align-items:center;height:100vh}
    .loader{border:4px solid #f3f3f3;border-top:4px solid #3498db;border-radius:50%;width:40px;height:40px;animation:spin 1s linear infinite}
    @keyframes spin{0%{transform:rotate(0deg)}100%{transform:rotate(360deg)}}
  </style>

  <!-- React + Recharts -->
  <script crossorigin src="https://cdn.jsdelivr.net/npm/react@18.2.0/umd/react.production.min.js"></script>
  <script crossorigin src="https://cdn.jsdelivr.net/npm/react-dom@18.2.0/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone@7.23.1/babel.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/prop-types@15.8.1/prop-types.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/recharts@2.15.4/umd/Recharts.min.js"></script>
</head>

<body class="bg-gray-50">
  <div id="root">
    <div class="loader-container">
      <div class="loader"></div>
      <p class="text-gray-500 mt-4">Loading Application...</p>
    </div>
  </div>

  <!-- Main React Application -->
  <script type="text/babel">
    const { useState, useEffect } = React;
    /* pull Recharts symbols once */
    const { ResponsiveContainer, BarChart, Bar, XAxis, YAxis, Tooltip, CartesianGrid, Cell } = Recharts;

    /* ------------- SVG ICON FACTORY ------------- */
    const createIcon = path => props => (
      <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24"
           viewBox="0 0 24 24" fill="none" stroke="currentColor"
           strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}>
        {path}
      </svg>
    );
    const Info          = createIcon(<><circle cx="12" cy="12" r="10"/><line x1="12" y1="16" x2="12" y2="12"/><line x1="12" y1="8" x2="12.01" y2="8"/></>);
    const CheckCircle   = createIcon(<><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></>);
    const XCircle       = createIcon(<><circle cx="12" cy="12" r="10"/><line x1="15" y1="9" x2="9" y2="15"/><line x1="9" y1="9" x2="15" y2="15"/></>);
    const AlertTriangle = createIcon(<><path d="m21.73 18-8-14a2 2 0 0 0-3.46 0l-8 14A2 2 0 0 0 4 21h16a2 2 0 0 0 1.73-3Z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/></>);
    const TrendingUp    = createIcon(<polyline points="23 6 13.5 15.5 8.5 10.5 1 18"/>);
    const Link2         = createIcon(<><path d="M9 17H7A5 5 0 0 1 7 7h2"/><path d="M15 7h2a5 5 0 0 1 0 10h-2"/><line x1="8" y1="12" x2="16" y2="12"/></>);
    const ShieldCheck   = createIcon(<><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/><path d="m9 12 2 2 4-4"/></>);

    /* ------------- GENERIC HELPERS ------------- */
    const Card        = ({children,className=''}) => <div className={`bg-white rounded-xl shadow-md p-6 ${className}`}>{children}</div>;
    const PageContent = ({children}) => <main className="flex-1 p-4 sm:p-6 lg:p-8">{children}</main>;

    const InfoTooltip = ({ text }) => (
      <div className="relative group ml-1">
        <Info className="w-4 h-4 text-gray-400 cursor-help" />
        <div className="absolute left-1/2 -translate-x-1/2 bottom-full mb-2 w-72 p-3 bg-gray-800 text-white text-xs rounded-lg shadow-lg opacity-0 group-hover:opacity-100 transition-opacity duration-200 pointer-events-none z-10">
          {text}
        </div>
      </div>
    );

    /* -------- Website Stats (rich version) -------- */
    const WebsiteStatsPage = ({ data }) => {
      if (!data) return <PageContent><div className="p-8 text-center text-gray-500">No data.</div></PageContent>;

      const { healthData, competitorPerfData, technicalSeoData } = data;
      const CHART_COLORS = ['#3b82f6','#84cc16','#f97316','#a855f7','#ec4899'];

      /* KPI helpers */
      const StatCard = ({label,value,icon,tooltipContent}) => (
        <div className="relative group flex items-center space-x-3">
          <div className="p-2 bg-blue-100 rounded-full">{icon}</div>
          <div>
            <p className="text-sm text-gray-500">{label}</p>
            <p className="font-bold text-lg text-gray-800">{value}</p>
          </div>
          {tooltipContent && (
            <div className="absolute left-0 bottom-full mb-2 w-72 p-3 bg-gray-800 text-white text-xs rounded-lg shadow-lg opacity-0 group-hover:opacity-100 transition-opacity duration-200 z-10 pointer-events-none">
              {tooltipContent}
            </div>
          )}
        </div>
      );

      const HealthCheckItem = ({ icon, color, title, items }) => (
        <div className="relative group flex items-center space-x-2">
          {icon}
          <div>
            <p className={`font-bold text-lg ${color}`}>{items.length}</p>
            <p className="text-xs text-gray-500">{title}</p>
          </div>
          <div className="absolute left-0 bottom-full mb-2 w-72 p-3 bg-gray-800 text-white text-xs rounded-lg shadow-lg opacity-0 group-hover:opacity-100 transition-opacity duration-200 z-10 pointer-events-none">
            <h4 className="font-bold mb-2 border-b border-gray-600 pb-1">{title} Found</h4>
            {items.length === 0
              ? <p className="text-gray-400">No issues found.</p>
              : <ul className="space-y-1">{items.map((it,i)=><li key={i}>- {it.description}</li>)}</ul>}
          </div>
        </div>
      );

      /* clean siteSpeed */
      const rawSpeed = String(healthData.siteSpeed).replace(/[^0-9.]/g,'');
      const siteSpeedLabel = rawSpeed ? `${rawSpeed}s` : healthData.siteSpeed;

      /* bar-chart dataset */
      const chartData = competitorPerfData.map(r=>({
        name : r.name + (r.isClient ? ' (You)' : ''),
        value: parseFloat(r['Site Speed (s)'])
      }));

      return (
        <PageContent>
          {/* ------- Health card ------- */}
          <Card className="mb-8">
            <div className="flex items-center space-x-2 mb-4">
              <h2 className="text-xl font-bold text-gray-800">Your Website Health</h2>
              <InfoTooltip text="A summary of technical SEO checks performed on your website." />
            </div>

            <div className="grid grid-cols-1 lg:grid-cols-4 gap-6 bg-slate-50 p-6 rounded-lg">
              {/* score + errors */}
              <div className="flex flex-col items-center">
                {/* radial gauge */}
                <div className="relative">
                  <svg className="w-32 h-32">
                    <circle r="54" cx="64" cy="64" stroke="currentColor" strokeWidth="8" fill="transparent" className="text-gray-200"/>
                    <circle r="54" cx="64" cy="64" stroke="currentColor" strokeWidth="8" fill="transparent"
                            strokeDasharray={2*Math.PI*54}
                            strokeDashoffset={(2*Math.PI*54)*(1-healthData.pageScore/100)}
                            strokeLinecap="round" className="text-green-500"
                            style={{transform:'rotate(-90deg)',transformOrigin:'50% 50%'}}/>
                  </svg>
                  <span className="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 text-3xl font-bold">
                    {healthData.pageScore}
                  </span>
                </div>
                <p className="text-gray-600 mt-2 font-semibold">Page Score</p>
                <div className="flex items-center space-x-6 mt-3">
                  <HealthCheckItem icon={<XCircle className="w-5 h-5 text-red-500"/>}
                                   color="text-red-500" title="Errors"    items={healthData.errors}/>
                  <HealthCheckItem icon={<AlertTriangle className="w-5 h-5 text-yellow-500"/>}
                                   color="text-yellow-500" title="Warnings" items={healthData.warnings}/>
                </div>
              </div>

              {/* KPI grid */}
              <div className="lg:col-span-3 grid grid-cols-1 sm:grid-cols-2 gap-6">
                <StatCard label="Site Speed"      value={siteSpeedLabel}            icon={<TrendingUp   className="w-5 h-5 text-blue-600"/>}/>
                <StatCard label="Broken Links"    value={healthData.brokenLinks}     icon={<Link2        className="w-5 h-5 text-blue-600"/>}/>
                <StatCard label="SSL Certificate" value={healthData.ssl?'Active':'Inactive'} icon={<ShieldCheck className="w-5 h-5 text-blue-600"/>}/>
                <StatCard label="Checks Passed"
                          value={`${healthData.checks.checksPassed} / ${healthData.checks.totalChecks}`}
                          icon={<CheckCircle className="w-5 h-5 text-blue-600"/>}
                          tooltipContent={
                            <div>
                              <h4 className="font-bold mb-2 border-b border-gray-600 pb-1 text-green-400">
                                Passed ({healthData.checks.passedList.length})
                              </h4>
                              <ul className="text-xs list-disc pl-4 mb-3 max-h-48 overflow-y-auto">
                                {healthData.checks.passedList.map(it=><li key={it}>{it}</li>)}
                              </ul>
                              <h4 className="font-bold mb-2 border-b border-gray-600 pb-1 text-red-400">
                                Failed ({healthData.checks.failedList.length})
                              </h4>
                              <ul className="text-xs list-disc pl-4 max-h-48 overflow-y-auto">
                                {healthData.checks.failedList.map(it=><li key={it}>{it}</li>)}
                              </ul>
                            </div>
                          }/>
              </div>
            </div>
          </Card>

          {/* ------- Competitor performance ------- */}
          <Card>
            <div className="flex items-center space-x-2 mb-4">
              <h2 className="text-xl font-bold text-gray-800">Site Speed vs. Competitors</h2>
              <InfoTooltip text="Comparison of load time. Lower is better." />
            </div>

            <ResponsiveContainer width="100%" height={300}>
              <BarChart data={chartData} layout="vertical" margin={{top:5,right:30,left:20,bottom:5}}>
                <CartesianGrid strokeDasharray="3 3" horizontal={false}/>
                <XAxis type="number" domain={[0, d=>Math.round(d*1.2)]}/>
                <YAxis type="category" dataKey="name" width={140} tick={{fontSize:12}}/>
                <Tooltip cursor={{fill:'rgba(241,245,249,0.7)'}}
                         contentStyle={{background:'rgba(31,41,55,0.9)',border:'none',borderRadius:'6px'}}
                         itemStyle={{color:'#fff'}} labelStyle={{color:'#fff',fontWeight:'bold'}}/>
                <Bar dataKey="value" barSize={20}>
                  {chartData.map((entry,i)=>
                    <Cell key={entry.name} fill={entry.name.includes('(You)') ? '#0ea5e9' : CHART_COLORS[i%CHART_COLORS.length]}/>
                  )}
                </Bar>
              </BarChart>
            </ResponsiveContainer>
          </Card>
        </PageContent>
      );
    };

    /* ----- other pages remain placeholders ----- */
    const Dashboard      = () => <PageContent><div className="p-8 text-center text-gray-500">Dashboard Placeholder</div></PageContent>;
    const GeogridMaps    = () => <PageContent><div className="p-8 text-center text-gray-500">Geogrid Maps Placeholder</div></PageContent>;
    const KeywordsPage   = () => <PageContent><div className="p-8 text-center text-gray-500">Keywords Placeholder</div></PageContent>;
    const BacklinksPage  = () => <PageContent><div className="p-8 text-center text-gray-500">Backlinks Placeholder</div></PageContent>;

    /* --------------- HEADER --------------- */
    const Header = ({activeTab,setActiveTab}) => {
      const tabs = ['Dashboard','Website Stats','Geogrid Maps','Keywords','Backlinks','Tools'];
      return (
        <header className="bg-white shadow-sm sticky top-0 z-20">
          <nav className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div className="flex items-center justify-between h-16">
              <div className="flex items-center">
                <svg className="h-8 w-8" viewBox="0 0 24 24" fill="none"
                     stroke="url(#logo-gradient)" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                  <defs>
                    <linearGradient id="logo-gradient" x1="0%" y1="0%" x2="100%" y2="0%">
                      <stop offset="0%" style={{stopColor:'#3b82f6'}}/>
                      <stop offset="100%" style={{stopColor:'#ec4899'}}/>
                    </linearGradient>
                  </defs>
                  <path d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"/>
                </svg>
                <h1 className="text-xl font-bold ml-3 bg-gradient-to-r from-blue-500 to-pink-500 bg-clip-text text-transparent">MedSpa SEO</h1>
              </div>
              <div className="hidden md:block">
                <div className="ml-10 flex items-baseline space-x-4">
                  {tabs.map(t=>(
                    <button key={t} onClick={()=>setActiveTab(t)}
                            className={`px-3 py-2 rounded-md text-sm font-medium ${activeTab===t?'bg-blue-600 text-white':'text-gray-500 hover:bg-gray-100 hover:text-gray-900'}`}>
                      {t}
                    </button>
                  ))}
                </div>
              </div>
            </div>
          </nav>
        </header>
      );
    };

    /* --------------- APP --------------- */
    const App = () => {
      const [activeTab,setActiveTab] = useState('Dashboard');
      const [appData,setAppData]     = useState(null);
      const [loading,setLoading]     = useState(true);
      const [error, setError]        = useState(null);

      useEffect(()=>{
        const id = new URLSearchParams(window.location.search).get('workbookId');
        if(!id){ setError('Add ?workbookId=YOUR_ID to the URL'); setLoading(false); return; }
        const url = `https://script.google.com/macros/s/AKfycbxfOMp8d_eCVH4lFD0PNuFU1wH-gyWOwRt2EuME7GQJ4U73ZwpPDciohDH3C566YLWq/exec?workbookId=${id}`;
        fetch(url).then(r=>r.json()).then(j=>{ if(j.error) throw new Error(j.error); setAppData(j); setLoading(false);})
                  .catch(e=>{console.error(e); setError(e.message); setLoading(false);});
      },[]);

      const body=()=>{
        if(loading) return <PageContent><div className="p-8 text-center text-gray-500">Loading live data…</div></PageContent>;
        if(error)   return <PageContent><div className="p-8 text-center text-red-500">Error: {error}</div></PageContent>;
        if(!appData)return <PageContent><div className="p-8 text-center text-gray-500">No data.</div></PageContent>;

        switch(activeTab){
          case 'Website Stats': return <WebsiteStatsPage data={appData.websiteStats}/>;
          case 'Geogrid Maps':  return <GeogridMaps/>;
          case 'Keywords':      return <KeywordsPage/>;
          case 'Backlinks':     return <BacklinksPage/>;
          case 'Tools':         return <PageContent><div className="p-8 text-center text-gray-500">Tools Coming Soon…</div></PageContent>;
          default:              return <Dashboard/>;
        }
      };

      return (
        <div className="min-h-screen bg-gray-50 font-sans">
          <Header activeTab={activeTab} setActiveTab={setActiveTab}/>
          {body()}
        </div>
      );
    };

    /* ---------- boot ---------- */
    const AppContainer = () => {
      const [ready,setReady] = useState(false);
      useEffect(()=>{ const t=setTimeout(()=>setReady(true),0); return()=>clearTimeout(t); },[]);
      return ready ? <App/> : <div className="loader-container"><div className="loader"/><p className="text-gray-500 mt-4">Initializing Libraries…</p></div>;
    };

    ReactDOM.createRoot(document.getElementById('root')).render(<AppContainer/>);
  </script>
</body>
</html>
