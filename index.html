<!DOCTYPE html>
<!--
  MedSpa SEO Dashboard - Application Overview

  This file, `index.html`, serves as the front-end for the MedSpa SEO tracking dashboard.
  It is built using vanilla HTML, Tailwind CSS for styling, and React (via CDN) for dynamic components.

  Application Architecture:

  The dashboard's data is sourced from a two-workbook system hosted on Google Sheets, each managed by its own Google App Script. This architecture separates client-specific data from general service data.

  1. Client Workbook:
     - A new, unique Google Sheet (workbook) is created for each individual client.
     - This workbook contains all client-specific data, such as website stats, GBP info, keyword rankings, backlink profiles, geogrid maps, and competitor data.
     - It is managed by the `Client Workbook App Script v2.gs`.
     - The dashboard identifies and fetches data from the correct client workbook by reading the `workbookId` from the URL query parameter (e.g., ?workbookId=YOUR_ID).

  2. Services Workbook:
     - A single, shared Google Sheet that contains trend data for MedSpa services (e.g., search volume, competition).
     - This data populates the "Services by Search Volume" and "New Services by Search Volume" cards on the dashboard.
     - It is managed by the `Service Cards (Dashboard) App Script v2.gs`.
     - The script for this workbook is called with a geographic location parameter to fetch relevant data.

  This setup ensures that each client's sensitive data is isolated in its own workbook, while still allowing the dashboard to display general industry trends from a centralized source.
-->
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1.0"/>
  <title>MedSpa SEO Dashboard</title>

  <!-- Tailwind (dev CDN) -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Inter font -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet"/>

  <style>
    body { font-family:'Inter',sans-serif }
    .loader-container {display:flex;flex-direction:column;justify-content:center;align-items:center;height:100vh}
    .loader {border:4px solid #f3f3f3;border-top:4px solid #3498db;border-radius:50%;width:40px;height:40px;animation:spin 1s linear infinite}
    @keyframes spin {0%{transform:rotate(0deg)}100%{transform:rotate(360deg)}}
  </style>

  <!-- React / Babel / Recharts -->
  <script crossorigin src="https://cdn.jsdelivr.net/npm/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://cdn.jsdelivr.net/npm/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone@7.23.1/babel.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/prop-types@15/prop-types.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/recharts@2/umd/Recharts.min.js"></script>
</head>

<body class="bg-gray-50">
  <div id="root">
    <div class="loader-container">
      <div class="loader"></div>
      <p class="text-gray-500 mt-4">Loading application…</p>
    </div>
  </div>

<script type="text/babel">
/* ------------------------------------------------------------------ */
/* shared helpers / icons / generic components                        */
/* ------------------------------------------------------------------ */
const {useState, useEffect, useRef} = React;

// --- Helper function to fetch data with CORS workaround ---
const fetchWithCorsWorkaround = (url, callback) => {
    // Try regular fetch first
    fetch(url, {
        method: 'GET',
        mode: 'cors'
    })
    .then(response => response.json())
    .then(data => callback(null, data))
    .catch(err => {
        console.log('Regular fetch failed, trying JSONP approach...');
        // Fallback to JSONP-style request
        const script = document.createElement('script');
        const callbackName = 'jsonpCallback_' + Math.random().toString(36).substr(2, 9);
        window[callbackName] = (data) => {
            callback(null, data);
            document.head.removeChild(script);
            delete window[callbackName];
        };
        script.src = `${url}&callback=${callbackName}`;
        script.onerror = () => {
            callback(new Error('Failed to load data'), null);
            document.head.removeChild(script);
            delete window[callbackName];
        };
        document.head.appendChild(script);
    });
};

/* ------------------------------------------------------------------ */
/* helpers  – icon factory  +  shared icons                           */
/* ------------------------------------------------------------------ */
const createIcon = path => props => (
  <svg
    xmlns="http://www.w3.org/2000/svg"
    width="24"
    height="24"
    viewBox="0 0 24 24"
    fill="none"
    stroke="currentColor"
    strokeWidth="2"
    strokeLinecap="round"
    strokeLinejoin="round"
    {...props}
  >
    {path}
  </svg>
);

/* reusable icons --------------------------------------------------- */
const Info = createIcon(
  <>
    <circle cx="12" cy="12" r="10" />
    <line  x1="12" y1="16" x2="12" y2="12" />
    <line  x1="12" y1="8"  x2="12.01" y2="8" />
  </>
);

const AlertTriangle = createIcon(
  <>
    <path d="m21.73 18-8-14a2 2 0 0 0-3.46 0l-8 14A2 2 0 0 0 4 21h16a2 2 0 0 0 1.73-3Z" />
    <line x1="12" y1="9"  x2="12" y2="13" />
    <line x1="12" y1="17" x2="12.01" y2="17" />
  </>
);

const Star = createIcon(
  <polygon points="12 2 15 8.5 22 9.3 17 14 18.3 21 12 17.7 5.7 21 7 14 2 9.3 9 8.5 12 2" />
);

const ArrowUp = createIcon(
  <>
    <line x1="12" y1="19" x2="12" y2="5" />
    <polyline points="5 12 12 5 19 12" />
  </>
);

const ArrowDown = createIcon(
  <>
    <line x1="12" y1="5"  x2="12" y2="19" />
    <polyline points="19 12 12 19 5 12" />
  </>
);

const CheckCircle  = createIcon(
  <>
    <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14" />
    <polyline points="22 4 12 14.01 9 11.01" />
  </>
);
const XCircle = createIcon(
  <>
    <circle cx="12" cy="12" r="10" />
    <line x1="15" y1="9" x2="9" y2="15" />
    <line x1="9" y1="9" x2="15" y2="15" />
  </>
);
const TrendingUp = createIcon(<polyline points="23 6 13.5 15.5 8.5 10.5 1 18" />);
const Link2 = createIcon(
  <>
    <path d="M9 17H7A5 5 0 0 1 7 7h2" />
    <path d="M15 7h2a5 5 0 0 1 0 10h-2" />
    <line x1="8" y1="12" x2="16" y2="12" />
  </>
);
const ShieldCheck = createIcon(
  <>
    <path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z" />
    <path d="m9 12 2 2 4-4" />
  </>
);

/* --- generic wrappers --- */
const Card        = ({children,className=''}) => (
  <div className={`bg-white rounded-xl shadow-md p-6 ${className}`}>{children}</div>);
const PageContent = ({children}) => (
  <main className="flex-1 p-4 sm:p-6 lg:p-8">{children}</main>);

// --- Reusable Components ---
const InfoTooltip = ({ text }) => (
    <div className="relative flex items-center group">
        <Info className="w-4 h-4 text-gray-400" />
        <div className="absolute left-1/2 -translate-x-1/2 bottom-full mb-2 w-64 p-3 bg-gray-800 text-white text-xs rounded-lg shadow-lg opacity-0 group-hover:opacity-100 transition-opacity duration-300 z-30 pointer-events-none">
            {text}
            <svg className="absolute text-gray-800 h-2 w-full left-0 top-full" x="0px" y="0px" viewBox="0 0 255 255"><polygon className="fill-current" points="0,0 127.5,127.5 255,0"/></svg>
        </div>
    </div>
);

/* ------------------------------------------------------------------ */
/* PLACEHOLDER PAGES – replace each later with real JSX               */
/* ------------------------------------------------------------------ */

/* ------------------------------------------------------------------ */
/* AI Report Section (used on multiple pages)                         */
/* ------------------------------------------------------------------ */
const AIReportSection = ({ reportText, title = "SWOT Analysis" }) => {
    const [isExpanded, setIsExpanded] = useState(false);
    if (!reportText) return null;

    const ChevronDown = createIcon(<polyline points="6 9 12 15 18 9" />);
    const ChevronUp = createIcon(<polyline points="18 15 12 9 6 15" />);

    return (
        <Card className="mt-8">
             <div className="flex items-center space-x-2 mb-1">
                 <h2 className="text-xl font-bold text-gray-800">AI Report</h2>
                 <InfoTooltip text="An automated SWOT (Strengths, Weaknesses, Opportunities, Threats) analysis based on the collected data, providing strategic insights and recommendations." />
             </div>
             <h3 className="text-md font-semibold text-gray-600 mb-3">{title}</h3>
             <div className={`prose prose-sm max-w-none text-gray-600 overflow-hidden relative transition-all duration-300 ${isExpanded ? 'max-h-full' : 'max-h-24'}`}>
                <div dangerouslySetInnerHTML={{ __html: reportText.replace(/\n/g, '<br />') }} />
                 {!isExpanded && <div className="absolute bottom-0 left-0 w-full h-12 bg-gradient-to-t from-white to-transparent"></div>}
             </div>
             <button onClick={() => setIsExpanded(!isExpanded)} className="mt-2 text-blue-600 hover:text-blue-800 text-sm font-semibold flex items-center">
                 {isExpanded ? 'Show Less' : 'Show More'}
                 {isExpanded ? <ChevronUp className="w-4 h-4 ml-1" /> : <ChevronDown className="w-4 h-4 ml-1" />}
             </button>
        </Card>
    );
};

const Dashboard = ({ setActiveTab }) => {
    const { ResponsiveContainer, BarChart, Bar, XAxis, YAxis, Tooltip, CartesianGrid, Cell, PieChart, Pie, Legend } = window.Recharts;
    
    // --- Additional Icon Components for this page ---
    const ExternalLink = createIcon(
      <>
        <path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6" />
        <polyline points="15 3 21 3 21 9" />
        <line x1="10" y1="14" x2="21" y2="3" />
      </>
    );
    const ChevronDown = createIcon(<polyline points="6 9 12 15 18 9" />);
    const ChevronUp = createIcon(<polyline points="18 15 12 9 6 15" />);

    // --- Reusable Components for this page ---
    const AdIndicator = ({ status, link }) => {
        if (status === 'No Ads Found') {
            return <span className="px-2 py-1 text-xs font-semibold rounded-full bg-red-100 text-red-800">No Ads</span>;
        }
        if (status === '1 Ad Found' || status === 'Multiple Ads Found') {
            return (
                <a href={link} target="_blank" rel="noopener noreferrer" 
                   className="inline-flex items-center px-2 py-1 bg-green-100 text-green-800 text-xs font-semibold rounded-full hover:bg-green-200 transition-colors">
                    {status === '1 Ad Found' ? '1 Ad' : 'Multiple'} <ExternalLink className="w-3 h-3 ml-1.5" />
                </a>
            );
        }
        return <span className="px-2 py-1 text-xs font-semibold rounded-full bg-gray-100 text-gray-800">Unknown</span>;
    };

    // --- Sub-components for Dashboard ---
    const GeogridSection = ({ setActiveTab }) => {
        const [geogridData, setGeogridData] = useState(null);
        const [loading, setLoading] = useState(true);
        const [error, setError] = useState(null);

        useEffect(() => {
            const params = new URLSearchParams(window.location.search);
            const workbookId = params.get('workbookId');
            if (!workbookId) {
                setError("No workbook ID provided");
                setLoading(false);
                return;
            }

            // Check cache first
            const cacheKey = `geogrid_${workbookId}`;
            const cachedData = sessionStorage.getItem(cacheKey);
            if (cachedData) {
                try {
                    const parsed = JSON.parse(cachedData);
                    const medspaNearMe = parsed['medspa near me'] || [];
                    const latestData = medspaNearMe.length > 0 ? medspaNearMe[0] : null;
                    setGeogridData(latestData);
                    setLoading(false);
                    return;
                } catch (e) {
                    // Invalid cache, continue with fresh fetch
                    console.error('Cache parsing error:', e);
                }
            }

            const scriptUrl = `https://script.google.com/macros/s/AKfycbxfOMp8d_eCVH4lFD0PNuFU1wH-gyWOwRt2EuME7GQJ4U73ZwpPDciohDH3C566YLWq/exec?workbookId=${workbookId}`;
            
            fetchWithCorsWorkaround(scriptUrl, (err, data) => {
                if (err) {
                    setError(err.message);
                    setLoading(false);
                    return;
                }
                if (data.error) {
                    setError(`Script error: ${data.error}`);
                    setLoading(false);
                    return;
                }
                
                try {
                    // Get the latest geogrid data for 'medspa near me'
                    const allGeogridData = data.geogridData || {};
                    const medspaNearMe = allGeogridData['medspa near me'] || [];
                    const latestData = medspaNearMe.length > 0 ? medspaNearMe[0] : null;
                    
                    // Store the full geogrid data in cache
                    sessionStorage.setItem(cacheKey, JSON.stringify(allGeogridData));
                    
                    // Set only the latest data for dashboard display
                    setGeogridData(latestData);
                    setLoading(false);
                } catch (e) {
                    console.error('Data processing error:', e);
                    setError('Failed to process geogrid data');
                    setLoading(false);
                }
            });
        }, []);

        if (loading) {
            return <Card className="col-span-12 lg:col-span-8 flex items-center justify-center"><p className="text-gray-500">Loading Geogrid data...</p></Card>;
        }
        if (error) {
            return <Card className="col-span-12 lg:col-span-8 flex items-center justify-center"><p className="text-red-500">Geogrid Error: {error}</p></Card>;
        }
        if (!geogridData) {
            return <Card className="col-span-12 lg:col-span-8 flex items-center justify-center"><p className="text-gray-500">No Geogrid data to display for 'medspa near me'.</p></Card>;
        }

        const getRankColor = (rank) => {
            if (rank === null || rank === undefined) return 'bg-gray-400';
            if (rank <= 3) return 'bg-green-500';
            if (rank <= 5) return 'bg-sky-500';
            if (rank <= 10) return 'bg-yellow-500';
            if (rank <= 20) return 'bg-orange-500';
            return 'bg-red-500';
        };

        return (
            <Card className="col-span-12 lg:col-span-8">
                <div className="flex flex-col lg:flex-row gap-6">
                    {/* Competitor Rankings on the Left */}
                    {geogridData.competitors && geogridData.competitors.length > 0 && (
                        <div className="lg:w-[300px] flex-shrink-0">
                            <h3 className="text-lg font-semibold text-gray-800 mb-3">Avg Score</h3>
                            <div className="space-y-2">
                                {geogridData.competitors.map((comp, index) => (
                                    <div key={index} className="flex items-center space-x-3 p-2 rounded-lg bg-slate-50 border border-slate-200">
                                        <div className={`flex-shrink-0 w-10 h-10 rounded-lg flex items-center justify-center font-bold text-white text-base ${getRankColor(comp.rank)}`}>
                                            {typeof comp.rank === 'number' ? comp.rank.toFixed(1) : '-'}
                                        </div>
                                        <div>
                                            <p className="font-medium text-sm text-gray-800 leading-tight">{comp.name || 'Unknown'}</p>
                                            {comp.domain && (
                                                <p className="text-xs text-gray-500">{comp.domain}</p>
                                            )}
                                        </div>
                                    </div>
                                ))}
                            </div>
                        </div>
                    )}
                    
                    {/* Geogrid Map on the Right */}
                    <div className="flex-1 min-w-0">
                        <div className="flex justify-between items-center mb-4">
                            <div className="flex items-center space-x-2">
                                <h2 className="text-xl font-bold text-gray-800">Medspa Near Me</h2>
                                <InfoTooltip text="A snapshot of your latest Geogrid map for the keyword 'medspa near me'." />
                                <button onClick={() => setActiveTab('Geogrid Maps')} className="text-xs font-normal text-blue-600 hover:text-blue-800">(See More)</button>
                            </div>
                            <span className="font-semibold text-gray-700">{geogridData.date}</span>
                        </div>
                        {geogridData.mapLink ? (
                            <div className="relative w-full h-[600px] overflow-hidden">
                                <iframe 
                                    src={geogridData.mapLink}
                                    className="w-full h-full rounded-lg border border-gray-200"
                                    style={{ background: '#f9fafb' }}
                                    loading="lazy"
                                    allowFullScreen
                                    scrolling="no"
                                />
                                <a 
                                    href={geogridData.mapLink} 
                                    target="_blank" 
                                    rel="noopener noreferrer"
                                    className="absolute bottom-2 right-2 bg-white/90 hover:bg-white text-gray-700 px-2 py-1 rounded text-xs flex items-center gap-1 shadow-sm transition-colors"
                                >
                                    <ExternalLink className="w-3 h-3 mr-1" />
                                    Open in new tab
                                </a>
                            </div>
                        ) : (
                            <div className="w-full h-[600px] flex flex-col items-center justify-center bg-gray-50 rounded-lg border-2 border-dashed border-gray-200">
                                <div className="bg-gray-100 p-4 rounded-full mb-4">
                                    <svg className="w-12 h-12 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M9 20l-5.447-2.724A1 1 0 013 16.382V5.618a1 1 0 011.447-.894L9 7m0 13l6-3m-6 3V7m6 10l4.553 2.276A1 1 0 0021 18.382V7.618a1 1 0 00-.553-.894L15 4m0 13V4m0 0L9 7" />
                                    </svg>
                                </div>
                                <p className="text-lg font-semibold text-gray-600 mb-2">Map Not Available Yet</p>
                                <p className="text-sm text-gray-500 text-center max-w-md">
                                    The Geogrid map for "medspa near me" is pending setup. Once available, it will show local search rankings across your service area.
                                </p>
                            </div>
                        )}
                    </div>
                </div>
            </Card>
        );
    };

    const CensusInfo = ({ censusData, loading, error }) => {
        if (loading) {
            return <Card className="col-span-12 lg:col-span-4 h-full flex items-center justify-center"><p className="text-gray-500">Loading Census data...</p></Card>;
        }
        if (error) {
            return <Card className="col-span-12 lg:col-span-4 h-full flex items-center justify-center"><p className="text-red-500">Census Error: {error}</p></Card>;
        }
        if (!censusData) {
            return <Card className="col-span-12 lg:col-span-4 h-full flex items-center justify-center"><p className="text-gray-500">No census data available.</p></Card>;
        }

        return (
            <Card className="col-span-12 lg:col-span-4 h-full">
                 <div className="flex items-center space-x-2 mb-4">
                    <h2 className="text-xl font-bold text-gray-800">Census Data</h2>
                    <InfoTooltip text="Provides demographic and economic information for your target service area." />
                 </div>
                <div>
                    {Object.entries(censusData).map(([key, value]) => {
                        if (!value) return null;
                        
                        // Special formatting for multi-line values
                        if (['Age Ranges', 'Ethnicity', 'Gender', 'Languages'].includes(key)) {
                            const items = (key === 'Gender' || key === 'Languages') ? value.split(' / ') : value.split(' ');
                            return (
                                <div key={key} className="flex justify-between text-sm py-3 border-t border-gray-100 first:border-t-0 first:pt-0">
                                    <span className="text-gray-600">{key}</span>
                                    <div className="text-right text-gray-600 space-y-1">
                                        {items.map((item, idx) => (
                                            <div key={idx}>{item.trim()}</div>
                                        ))}
                                    </div>
                                </div>
                            );
                        }
                        
                        // Default display for other fields
                        let displayValue = value;
                        if (key === 'Median Income' && !String(value).startsWith('$')) {
                            displayValue = `$${value}`;
                        }
                        
                        return (
                            <div key={key} className="flex justify-between items-center text-sm py-3 border-t border-gray-100 first:border-t-0 first:pt-0">
                                <span className="text-gray-600">{key}</span>
                                <span className="text-gray-600 text-right">{displayValue}</span>
                            </div>
                        )
                    })}
                </div>
            </Card>
        );
    };

    const OverviewTable = ({ overviewData, loading, error }) => {
        if (loading) {
            return <Card className="col-span-12 overflow-x-auto flex items-center justify-center"><p className="text-gray-500">Loading Overview data...</p></Card>;
        }
        if (error) {
            return <Card className="col-span-12 overflow-x-auto flex items-center justify-center"><p className="text-red-500">Overview Error: {error}</p></Card>;
        }
        if (!overviewData || overviewData.length === 0) {
            return <Card className="col-span-12 overflow-x-auto flex items-center justify-center"><p className="text-gray-500">No overview data available.</p></Card>;
        }

        return (
            <Card className="col-span-12 overflow-x-auto">
                <div className="flex justify-between items-center mb-4">
                    <div className="flex items-center space-x-2">
                        <h2 className="text-xl font-bold text-gray-800">Overview</h2>
                         <InfoTooltip text="A high-level comparison of your clinic against key competitors on important metrics like online reviews, site performance, and advertising." />
                    </div>
                    <button onClick={() => alert('Webhook for Overview refresh triggered!')} className="bg-slate-100 hover:bg-slate-200 text-slate-600 font-bold py-1 px-3 rounded-lg text-xs transition-colors duration-300">Refresh</button>
                </div>
                <table className="w-full text-left text-sm whitespace-nowrap">
                    <thead>
                        <tr className="border-b-2 border-gray-200">
                            <th className="py-2 px-3">Clinic</th>
                            <th className="py-2 px-3 text-center">Site Speed</th>
                            <th className="py-2 px-3 text-center">Keywords #1</th>
                            <th className="py-2 px-3 text-center">Backlinks</th>
                            <th className="py-2 px-3">Opening Hours</th>
                            <th className="py-2 px-3 text-center">Google Ads</th>
                            <th className="py-2 px-3 text-center">Facebook Ads</th>
                        </tr>
                    </thead>
                    <tbody>
                        {overviewData.map(c => (
                            <tr key={c.id} className={`border-b border-gray-100 ${c.isClient ? 'bg-blue-50' : ''}`}>
                                <td className="py-3 px-3">
                                    <div>
                                        <div className="flex items-baseline gap-2">
                                            <span className="font-semibold text-gray-800">{c.clinicName}</span>
                                            <span className="text-sm text-gray-600">
                                                {c.reviewScore} <span className="text-yellow-400">★</span> ({c.reviewCount} reviews)
                                            </span>
                                        </div>
                                        <div className="text-xs text-gray-500">
                                            {[c.address, c.borough, c.city].filter(Boolean).join(', ')}
                                        </div>
                                        {c.website && (
                                            <a href={c.website} target="_blank" rel="noopener noreferrer" 
                                               className="text-xs text-blue-600 hover:text-blue-800 hover:underline">
                                                {c.website.replace(/^https?:\/\//i, '')}
                                            </a>
                                        )}
                                    </div>
                                </td>
                                <td className="py-3 px-3 text-center font-medium">{c.speed}</td>
                                <td className="py-3 px-3 text-center font-medium">{c.kwPos1}</td>
                                <td className="py-3 px-3 text-center font-medium">{c.backlinks.toLocaleString()}</td>
                                <td className="py-3 px-3 text-gray-600">
                                    {(() => {
                                        if (!c.hours || c.hours === 'N/A') return 'N/A';
                                        
                                        const daysOrder = ['MON', 'TUE', 'WED', 'THU', 'FRI', 'SAT', 'SUN'];
                                        const hoursMap = {};
                                        
                                        // Handle both comma and semicolon separators for robust parsing
                                        c.hours.split(/, ?|; ?/).forEach(part => {
                                            const bits = part.split(/:\s?/);
                                            if (bits.length < 2) return;
                                            
                                            const day = bits[0].trim().substring(0, 3).toUpperCase();
                                            const time = bits.slice(1).join(':').trim();
                                            
                                            if (daysOrder.includes(day)) {
                                                hoursMap[day] = time;
                                            }
                                        });

                                        if (Object.keys(hoursMap).length === 0) return c.hours;
                                        
                                        const openDays = [];
                                        const closedDays = [];
                                        
                                        daysOrder.forEach(day => {
                                            const time = hoursMap[day];
                                            if (time && time.toLowerCase() !== 'closed') {
                                                openDays.push({ day, time });
                                            } else {
                                                closedDays.push(day);
                                            }
                                        });

                                        return (
                                            <div className="text-xs space-y-1">
                                                {openDays.map(item => (
                                                    <div key={item.day} className="font-semibold">
                                                        <span>{item.day}: {item.time}</span>
                                                        <span className="text-blue-600 ml-1">Open</span>
                                                    </div>
                                                ))}
                                                {closedDays.length > 0 && (
                                                    <div className="text-red-500 font-semibold">
                                                        {closedDays.join(', ')} Closed
                                                    </div>
                                                )}
                                            </div>
                                        );
                                    })()}
                                </td>
                                <td className="py-3 px-3 text-center"><AdIndicator status={c.gAds} link={c.gAdsLink} /></td>
                                <td className="py-3 px-3 text-center"><AdIndicator status={c.fbAds} link={c.fbAdsLink} /></td>
                            </tr>
                        ))}
                    </tbody>
                </table>
            </Card>
        );
    };
    
    const ServiceList = ({ title, dataSet, tooltipText }) => {
        const [serviceData, setServiceData] = useState(null);
        const [loading, setLoading] = useState(true);
        const [error, setError] = useState(null);
        const [selectedLocation, setSelectedLocation] = useState('USA');
        const [expandedService, setExpandedService] = useState(null);
        const [showAll, setShowAll] = useState(false);

        useEffect(() => {
            const cacheKey = `services_${selectedLocation}_${dataSet}`;
            const cachedData = sessionStorage.getItem(cacheKey);
            
            if (cachedData) {
                try {
                    const parsed = JSON.parse(cachedData);
                    setServiceData(parsed);
                    setLoading(false);
                    setError(null);
                    return;
                } catch (e) {
                    // Invalid cache, continue with fresh fetch
                }
            }

            const scriptUrl = `https://script.google.com/macros/s/AKfycbys_HQL8HQdyL_-DoS0Aakvj-IzDWWW5HtNJDiFhbUwgCuKEYJ7N6iZGC-F62I7uZlV/exec?location=${selectedLocation}`;
            setLoading(true);
            setError(null);
            
            fetchWithCorsWorkaround(scriptUrl, (err, data) => {
                if (err) {
                    console.error("ServiceList Fetch Error:", err);
                    setError(err.message);
                    setLoading(false);
                    return;
                }

                if (data.error) {
                    setError(data.error);
                    setLoading(false);
                    return;
                }

                const services = dataSet === 'topServices' ? data.topServices : data.newServices;
                if (services) {
                    // Calculate total volume for percentage
                    const totalVolume = services.reduce((sum, service) => sum + service.totalVolume, 0);
                    const servicesWithPercentage = services.map(service => ({
                        ...service,
                        volumePercentage: totalVolume > 0 ? ((service.totalVolume / totalVolume) * 100).toFixed(1) : 0
                    }));
                    sessionStorage.setItem(cacheKey, JSON.stringify(servicesWithPercentage));
                    setServiceData(servicesWithPercentage);
                }
                setLoading(false);
            });
        }, [selectedLocation, dataSet]);

        if (loading) return <Card className="col-span-12 md:col-span-6 flex items-center justify-center"><p className="text-gray-500">Loading Service Data...</p></Card>;
        if (error) return <Card className="col-span-12 md:col-span-6 flex items-center justify-center"><p className="text-red-500">Service Error: {error}</p></Card>;
        if (!serviceData || serviceData.length === 0) return <Card className="col-span-12 md:col-span-6 flex items-center justify-center"><p className="text-gray-500">No service data found for {selectedLocation}.</p></Card>;
        
        // Get displayed services based on showAll toggle
        const displayedServices = showAll ? serviceData : serviceData.slice(0, 5);
        
        return (
            <Card className="col-span-12 md:col-span-6">
                <div className="flex justify-between items-start mb-4">
                    <div className="flex items-center space-x-2">
                        <h2 className="text-xl font-bold text-gray-800">{title}</h2>
                        <InfoTooltip text={tooltipText} />
                    </div>
                    <select 
                        value={selectedLocation} 
                        onChange={(e) => setSelectedLocation(e.target.value)}
                        className="text-sm border-gray-300 rounded-md shadow-sm focus:border-blue-300 focus:ring focus:ring-blue-200 focus:ring-opacity-50"
                    >
                         <option value="USA">United States</option>
                         <option value="Canada">Canada</option>
                         <option value="Florida">Florida</option>
                         <option value="Lakeland, FL">Lakeland, FL</option>
                    </select>
                </div>
                <div className="overflow-x-auto">
                    <table className="w-full text-left text-sm whitespace-nowrap">
                       <thead>
                          <tr className="border-b-2 border-gray-200">
                             <th className="py-2 px-3">Service</th>
                             <th className="py-2 px-3 text-center">% of Volume</th>
                             <th className="py-2 px-3 text-center">Avg. Comp.</th>
                             <th className="py-2 px-3 text-center">Avg. CPC</th>
                             <th className="py-2 px-3 text-center">Trend</th>
                          </tr>
                       </thead>
                       <tbody>
                          {displayedServices.map(service => (
                            <React.Fragment key={service.name}>
                                <tr className="border-b border-gray-100 hover:bg-slate-50 cursor-pointer" onClick={() => setExpandedService(expandedService === service.name ? null : service.name)}>
                                   <td className="py-3 px-3 font-medium text-gray-800">{service.name}</td>
                                   <td className="py-3 px-3 text-center">{service.volumePercentage}%</td>
                                   <td className="py-3 px-3 text-center">{service.avgCompetition}</td>
                                   <td className="py-3 px-3 text-center">${service.avgCpc}</td>
                                   <td className="py-3 px-3 text-center">
                                      {service.trend === 1 && <ArrowUp className="w-4 h-4 text-green-500 mx-auto" title="Increasing" />}
                                      {service.trend === -1 && <ArrowDown className="w-4 h-4 text-red-500 mx-auto" title="Decreasing" />}
                                      {service.trend === 0 && <span className="text-gray-400" title="No Change">-</span>}
                                   </td>
                                </tr>
                                {expandedService === service.name && (
                                    <tr>
                                        <td colSpan="5" className="p-0">
                                            <div className="bg-slate-50 p-3">
                                                <h4 className="font-bold text-xs mb-2">Top Keywords for {service.name}</h4>
                                                 <table className="w-full text-left text-xs">
                                                     <thead>
                                                        <tr className="border-b border-gray-300">
                                                            <th className="py-1 px-2">Keyword</th>
                                                            <th className="py-1 px-2 text-center">Volume</th>
                                                            <th className="py-1 px-2 text-center">Trend</th>
                                                        </tr>
                                                     </thead>
                                                     <tbody>
                                                        {service.keywords.map(kw => (
                                                            <tr key={kw.name} className="border-b border-gray-200">
                                                                <td className="py-1 px-2">{kw.name}</td>
                                                                <td className="py-1 px-2 text-center">{kw.volume.toLocaleString()}</td>
                                                                <td className="py-1 px-2 text-center">
                                                                    {kw.trend === 1 && <ArrowUp className="w-3 h-3 text-green-500 mx-auto" title="Increasing" />}
                                                                    {kw.trend === -1 && <ArrowDown className="w-3 h-3 text-red-500 mx-auto" title="Decreasing" />}
                                                                    {kw.trend === 0 && <span className="text-gray-400" title="No Change">-</span>}
                                                                </td>
                                                            </tr>
                                                        ))}
                                                     </tbody>
                                                 </table>
                                            </div>
                                        </td>
                                    </tr>
                                )}
                            </React.Fragment>
                          ))}
                       </tbody>
                    </table>
                    {serviceData.length > 5 && (
                        <button 
                            onClick={() => setShowAll(!showAll)}
                            className="mt-4 text-blue-600 hover:text-blue-800 text-sm font-semibold flex items-center"
                        >
                            {showAll ? 'Show Less' : `Show ${serviceData.length - 5} More`}
                            {showAll ? <ChevronUp className="w-4 h-4 ml-1" /> : <ChevronDown className="w-4 h-4 ml-1" />}
                        </button>
                    )}
                </div>
            </Card>
        );
    };
    
    const [dashboardData, setDashboardData] = useState(null);
    const [loading, setLoading] = useState(true);
    const [error, setError] = useState(null);

    useEffect(() => {
        const params = new URLSearchParams(window.location.search);
        const workbookId = params.get('workbookId');
        if (!workbookId) {
            setError("No workbook ID provided");
            setLoading(false);
            return;
        }

        // Use a single cache key for all dashboard data
        const cacheKey = `dashboard_data_${workbookId}`;
        const cachedData = sessionStorage.getItem(cacheKey);
        if (cachedData) {
            try {
                const parsed = JSON.parse(cachedData);
                setDashboardData(parsed);
                setLoading(false);
                return;
            } catch (e) {
                // Invalid cache, continue with fresh fetch
            }
        }

        const scriptUrl = `https://script.google.com/macros/s/AKfycbxfOMp8d_eCVH4lFD0PNuFU1wH-gyWOwRt2EuME7GQJ4U73ZwpPDciohDH3C566YLWq/exec?workbookId=${workbookId}`;
        
        fetchWithCorsWorkaround(scriptUrl, (err, data) => {
            if (err) {
                setError(err.message);
                setLoading(false);
                return;
            }
            if (data.error) {
                setError(`Script error: ${data.error}`);
                setLoading(false);
                return;
            }
            
            const dashboard = data.dashboard;
            if (dashboard) {
                sessionStorage.setItem(cacheKey, JSON.stringify(dashboard));
            }
            setDashboardData(dashboard);
            setLoading(false);
        });
    }, []);

    return (
        <PageContent>
            <div className="grid grid-cols-12 gap-6">
                <GeogridSection setActiveTab={setActiveTab} />
                <CensusInfo censusData={dashboardData?.censusData} loading={loading} error={error} />
                <OverviewTable overviewData={dashboardData?.overviewData} loading={loading} error={error}/>
                
                {!loading && !error && dashboardData?.aiReport && (
                    <div className="col-span-12">
                       <AIReportSection reportText={dashboardData.aiReport} title="SWOT Analysis" />
                    </div>
                )}

                <ServiceList title="Services by Search Volume" dataSet="topServices" tooltipText="Lists the most popular, established MedSpa services based on monthly search volume in the selected geographic area." />
                <ServiceList title="New Services by Search Volume" dataSet="newServices" tooltipText="Highlights emerging or newer services with growing search interest, indicating potential new market opportunities." />
            </div>
        </PageContent>
    );
};

/* ------------------------------------------------------------------ */
/* KEYWORDS PAGE – full live version                                  */
/* ------------------------------------------------------------------ */
const Keywords = ({ summary, table }) => {
    const [active, setActive] = useState('');
    const [searchTerm, setSearchTerm] = useState('');
    const siteNames = Object.keys(table);
    
    // Set initial active site to the first one
    useEffect(() => {
        if (!active && siteNames.length > 0) {
            setActive(siteNames[0]);
        }
    }, [siteNames]);

    // Icons
    const Search = createIcon(
        <>
            <circle cx="11" cy="11" r="8" />
            <line x1="21" y1="21" x2="16.65" y2="16.65" />
        </>
    );
    const ExternalLink = createIcon(
        <>
            <path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6" />
            <polyline points="15 3 21 3 21 9" />
            <line x1="10" y1="14" x2="21" y2="3" />
        </>
    );

    // Reusable component for each stat in the summary
    const SummaryStat = ({ label, value, color, icon, valuePrefix = '' }) => (
        <div className="flex items-center justify-between p-3 bg-slate-50 rounded-lg transition-all hover:shadow-md hover:bg-white">
            <div className="flex items-center">
                {icon && <div className="mr-3 text-gray-400">{icon}</div>}
                <span className="text-sm text-gray-600 font-medium">{label}</span>
            </div>
            <span className={`text-lg font-bold ${color}`}>
                {value > 0 ? valuePrefix : ''}{value}
            </span>
        </div>
    );

    // Format number with fallback
    const formatNumber = (num) => {
        if (num === undefined || num === null) return '-';
        return typeof num === 'number' ? num.toLocaleString() : num;
    };

    // Format currency with fallback
    const formatCurrency = (num) => {
        if (num === undefined || num === null) return '-';
        return typeof num === 'number' ? `$${num.toFixed(2)}` : num;
    };

    return (
        <PageContent>
            <h1 className="text-3xl font-bold text-gray-800 mb-6">Keyword Analysis</h1>

            <Card className="mb-6">
                <div className="flex items-center space-x-2 mb-4">
                    <h2 className="text-xl font-bold text-gray-800">Keywords Summary</h2>
                    <InfoTooltip text="Overview of your keyword rankings, showing positions, changes, and estimated values." />
                </div>

                <div className="grid grid-cols-1 lg:grid-cols-3 gap-8">
                    {/* Column 1: Core & Financial Metrics */}
                    <div className="space-y-6 flex flex-col">
                        <div className="p-6 bg-slate-100 rounded-xl text-center flex-grow flex flex-col justify-center">
                            <p className="text-base text-gray-500">Total Keywords Tracked</p>
                            <p className="text-5xl font-bold text-blue-600">{summary.totalKeywords.toLocaleString()}</p>
                        </div>
                        <div className="space-y-3">
                            <SummaryStat
                                label="Est. Traffic Value"
                                value={`$${summary.etv.toFixed(2)}`}
                                color="text-gray-800"
                            />
                            <SummaryStat
                                label="Est. Paid Cost"
                                value={`$${summary.estPaidCost.toFixed(2)}`}
                                color="text-gray-800"
                            />
                        </div>
                    </div>

                    {/* Column 2: Ranking Distribution */}
                    <div className="space-y-3">
                        <h3 className="text-lg font-semibold text-gray-700 px-2 mb-2">Ranking Distribution</h3>
                        <SummaryStat label="Position 1" value={summary.pos1} color={summary.pos1 > 0 ? 'text-emerald-600' : 'text-gray-500'} />
                        <SummaryStat label="Positions 2-3" value={summary.pos2_3} color={summary.pos2_3 > 0 ? 'text-emerald-500' : 'text-gray-500'} />
                        <SummaryStat label="Positions 4-10" value={summary.pos4_10} color={summary.pos4_10 > 0 ? 'text-blue-500' : 'text-gray-500'} />
                        <SummaryStat label="Positions 11-20" value={summary.pos11_20} color={summary.pos11_20 > 0 ? 'text-yellow-500' : 'text-gray-500'} />
                    </div>

                    {/* Column 3: Keyword Dynamics */}
                    <div className="space-y-3">
                        <h3 className="text-lg font-semibold text-gray-700 px-2 mb-2">Keyword Dynamics</h3>
                        <SummaryStat
                            label="Improved"
                            value={summary.isUp}
                            color={summary.isUp > 0 ? 'text-green-600' : 'text-gray-500'}
                            icon={<ArrowUp className="w-5 h-5" />}
                            valuePrefix="+"
                        />
                        <SummaryStat
                            label="New"
                            value={summary.isNew}
                            color={summary.isNew > 0 ? 'text-blue-600' : 'text-gray-500'}
                            icon={<Star className="w-5 h-5 text-blue-500" fill="currentColor"/>}
                        />
                        <SummaryStat
                            label="Declined"
                            value={summary.isDown}
                            color={summary.isDown > 0 ? 'text-red-600' : 'text-gray-500'}
                            icon={<ArrowDown className="w-5 h-5" />}
                        />
                        <SummaryStat
                            label="Lost"
                            value={summary.isLost}
                            color={summary.isLost > 0 ? 'text-red-600' : 'text-gray-500'}
                            icon={<XCircle className="w-5 h-5" />}
                        />
                    </div>
                </div>
            </Card>

            <Card>
                <div className="flex justify-between items-center mb-4">
                    <div className="flex items-center space-x-2">
                        <h2 className="text-xl font-bold text-gray-800">Keywords</h2>
                        <InfoTooltip text="Analyze keyword rankings for your site and competitors. Use the tabs to switch between different sites." />
                    </div>
                    <button
                        onClick={() => alert('Webhook for Keywords refresh triggered!')}
                        className="bg-slate-100 hover:bg-slate-200 text-slate-600 font-bold py-1 px-3 rounded-lg text-xs transition-colors duration-300"
                    >
                        Refresh
                    </button>
                </div>

                <div className="mb-4">
                    <div className="relative">
                        <Search className="absolute left-3 top-1/2 -translate-y-1/2 w-5 h-5 text-gray-400" />
                        <input
                            type="text"
                            placeholder="Search by keyword, URL, or title..."
                            value={searchTerm}
                            onChange={(e) => setSearchTerm(e.target.value)}
                            className="w-full pl-10 pr-4 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500"
                        />
                    </div>
                </div>

                <div className="border-b border-gray-200">
                    <nav className="-mb-px flex space-x-6 overflow-x-auto">
                        {siteNames.map(name => (
                            <button
                                key={name}
                                onClick={() => {
                                    setActive(name);
                                    setSearchTerm('');
                                }}
                                className={`whitespace-nowrap py-3 px-1 border-b-2 font-medium text-sm ${
                                    active === name
                                    ? 'border-blue-500 text-blue-600'
                                    : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300'
                                }`}
                            >
                                {name}
                            </button>
                        ))}
                    </nav>
                </div>

                <div className="mt-4 overflow-x-auto">
                    <table className="w-full text-left text-sm whitespace-nowrap">
                        <thead>
                            <tr className="border-b-2 border-gray-200 bg-gray-50">
                                <th className="py-2 px-3">Keyword</th>
                                <th className="py-2 px-3 text-center">Position</th>
                                <th className="py-2 px-3 text-center">Previous</th>
                                <th className="py-2 px-3 text-center">Change</th>
                                <th className="py-2 px-3 text-center">Status</th>
                                <th className="py-2 px-3 text-center">Volume</th>
                                <th className="py-2 px-3 text-center">CPC</th>
                                <th className="py-2 px-3 text-center">Difficulty</th>
                                <th className="py-2 px-3 text-center">Intent</th>
                                <th className="py-2 px-3 text-center">Competition</th>
                                <th className="py-2 px-3">Title</th>
                                <th className="py-2 px-3 text-center">Check</th>
                            </tr>
                        </thead>
                        <tbody>
                            {table[active]?.filter(row =>
                                row.keyword?.toLowerCase().includes(searchTerm.toLowerCase()) ||
                                row.ranking_url?.toLowerCase().includes(searchTerm.toLowerCase()) ||
                                row.ranking_title?.toLowerCase().includes(searchTerm.toLowerCase())
                            )?.map((row, index) => (
                                <tr key={index} className="border-b border-gray-100 hover:bg-slate-50">
                                    <td className="py-3 px-3 font-medium">{row.keyword}</td>
                                    <td className="py-3 px-3 text-center font-medium">
                                        <span className={`inline-block px-2 py-1 rounded-full text-xs font-semibold
                                            ${row.rank_now <= 1 ? 'bg-emerald-100 text-emerald-800' :
                                            row.rank_now <= 3 ? 'bg-emerald-50 text-emerald-700' :
                                            row.rank_now <= 10 ? 'bg-blue-50 text-blue-700' :
                                            'bg-yellow-50 text-yellow-700'}`}>
                                            {formatNumber(row.rank_now)}
                                        </span>
                                    </td>
                                    <td className="py-3 px-3 text-center">{formatNumber(row.rank_prev) || '-'}</td>
                                    <td className="py-3 px-3 text-center">
                                        {row.rank_prev && row.rank_now ? (
                                            <span className={
                                                row.rank_prev > row.rank_now ? 'text-green-600' :
                                                row.rank_prev < row.rank_now ? 'text-red-600' :
                                                'text-gray-400'
                                            }>
                                                {row.rank_prev > row.rank_now ? '+' : ''}{row.rank_prev - row.rank_now || '-'}
                                            </span>
                                        ) : '-'}
                                    </td>
                                    <td className="py-3 px-3 text-center">
                                        {row.is_new ? (
                                            <span className="text-xs font-semibold px-2 py-1 bg-blue-100 text-blue-800 rounded-full">New</span>
                                        ) : row.is_lost ? (
                                            <span className="text-xs font-semibold px-2 py-1 bg-red-100 text-red-800 rounded-full">Lost</span>
                                        ) : row.is_up ? (
                                            <span className="text-xs font-semibold px-2 py-1 bg-green-100 text-green-800 rounded-full">Up</span>
                                        ) : row.is_down ? (
                                            <span className="text-xs font-semibold px-2 py-1 bg-yellow-100 text-yellow-800 rounded-full">Down</span>
                                        ) : (
                                            <span className="text-gray-400">-</span>
                                        )}
                                    </td>
                                    <td className="py-3 px-3 text-center">{formatNumber(row.search_vol)}</td>
                                    <td className="py-3 px-3 text-center">{formatCurrency(row.cpc_usd)}</td>
                                    <td className="py-3 px-3 text-center">
                                        <span className={`px-2 py-1 rounded-full text-xs font-semibold
                                            ${row.keyword_difficulty <= 30 ? 'bg-green-100 text-green-800' :
                                            row.keyword_difficulty <= 60 ? 'bg-yellow-100 text-yellow-800' :
                                            'bg-red-100 text-red-800'}`}>
                                            {row.keyword_difficulty || '-'}
                                        </span>
                                    </td>
                                    <td className="py-3 px-3 text-center">
                                        <span className={`px-2 py-1 rounded-full text-xs font-semibold
                                            ${row.intent === 'commercial' ? 'bg-green-100 text-green-800' :
                                            row.intent === 'informational' ? 'bg-blue-100 text-blue-800' :
                                            row.intent === 'navigational' ? 'bg-purple-100 text-purple-800' :
                                            'bg-gray-100 text-gray-800'}`}>
                                            {row.intent || '-'}
                                        </span>
                                    </td>
                                    <td className="py-3 px-3 text-center">
                                        <span className={`px-2 py-1 rounded-full text-xs font-semibold
                                            ${row.competition_lvl === 'low' ? 'bg-green-100 text-green-800' :
                                            row.competition_lvl === 'medium' ? 'bg-yellow-100 text-yellow-800' :
                                            row.competition_lvl === 'high' ? 'bg-red-100 text-red-800' :
                                            'bg-gray-100 text-gray-800'}`}>
                                            {row.competition_lvl || '-'}
                                        </span>
                                    </td>
                                    <td className="py-3 px-3 text-gray-600 max-w-xs truncate" title={row.ranking_title}>
                                        {row.ranking_title || '-'}
                                    </td>
                                    <td className="py-3 px-3 text-center">
                                        {row.check_url && (
                                            <a href={row.check_url} target="_blank" rel="noopener noreferrer" className="text-blue-600 hover:text-blue-800 inline-block">
                                                <ExternalLink className="w-4 h-4" />
                                            </a>
                                        )}
                                    </td>
                                </tr>
                            ))}
                        </tbody>
                    </table>
                    {table[active]?.filter(row =>
                        row.keyword?.toLowerCase().includes(searchTerm.toLowerCase()) ||
                        row.ranking_url?.toLowerCase().includes(searchTerm.toLowerCase()) ||
                        row.ranking_title?.toLowerCase().includes(searchTerm.toLowerCase())
                    )?.length === 0 && (
                        <div className="text-center py-8 text-gray-500">
                            No matching keywords found for "{searchTerm}"
                        </div>
                    )}
                </div>
            </Card>
        </PageContent>
    );
};

const Backlinks = () => {
    // Destructure chart components here, as they are only used in this component.
    const { PieChart, Pie, Cell, ResponsiveContainer, Tooltip } = window.Recharts;

    // --- Additional Icon Components for this page ---
    const PlusCircle = createIcon(
      <>
        <circle cx="12" cy="12" r="10" />
        <line x1="12" y1="8" x2="12" y2="16" />
        <line x1="8" y1="12" x2="16" y2="12" />
      </>
    );
    const MinusCircle = createIcon(
      <>
        <circle cx="12" cy="12" r="10" />
        <line x1="8" y1="12" x2="16" y2="12" />
      </>
    );
    const Search = createIcon(
      <>
        <circle cx="11" cy="11" r="8" />
        <line x1="21" y1="21" x2="16.65" y2="16.65" />
      </>
    );
    const ExternalLink = createIcon(
      <>
        <path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6" />
        <polyline points="15 3 21 3 21 9" />
        <line x1="10" y1="14" x2="21" y2="3" />
      </>
    );

    // --- Component State and Data ---
    const [backlinksData, setBacklinksData] = useState(null);
    const [loading, setLoading] = useState(true);
    const [error, setError] = useState(null);
    const [activeTableTab, setActiveTableTab] = useState('');
    const [searchTerm, setSearchTerm] = useState('');

    useEffect(() => {
        const params = new URLSearchParams(window.location.search);
        const workbookId = params.get('workbookId');
        if (!workbookId) {
            setError("No workbook ID provided");
            setLoading(false);
            return;
        }

        // Check cache first
        const cacheKey = `backlinks_${workbookId}`;
        const cachedData = sessionStorage.getItem(cacheKey);
        if (cachedData) {
            try {
                const parsed = JSON.parse(cachedData);
                setBacklinksData(parsed);
                setActiveTableTab(Object.keys(parsed.backlinksTable)[0] || '');
                setLoading(false);
                return;
            } catch (e) {
                // Invalid cache, continue with fresh fetch
            }
        }

        const scriptUrl = `https://script.google.com/macros/s/AKfycbxfOMp8d_eCVH4lFD0PNuFU1wH-gyWOwRt2EuME7GQJ4U73ZwpPDciohDH3C566YLWq/exec?workbookId=${workbookId}`;
        
        fetchWithCorsWorkaround(scriptUrl, (err, data) => {
            if (err) {
                setError(err.message);
                setLoading(false);
                return;
            }
            if (data.error) {
                setError(`Script error: ${data.error}`);
                setLoading(false);
                return;
            }
            
            const backlinks = {
                backlinksSummary: data.backlinksSummary,
                backlinksTable: data.backlinksTable
            };
            
            if (backlinks.backlinksSummary && backlinks.backlinksTable) {
                sessionStorage.setItem(cacheKey, JSON.stringify(backlinks));
                setActiveTableTab(Object.keys(backlinks.backlinksTable)[0] || '');
            }
            setBacklinksData(backlinks);
            setLoading(false);
        });
    }, []);

    if (loading) {
        return <PageContent><div className="p-8 text-center text-gray-500">Loading backlinks data...</div></PageContent>;
    }
    if (error) {
        return <PageContent><div className="p-8 text-center text-red-500">Backlinks Error: {error}</div></PageContent>;
    }
    if (!backlinksData || !backlinksData.backlinksSummary || !backlinksData.backlinksTable) {
        return <PageContent><div className="p-8 text-center text-gray-500">No backlinks data available.</div></PageContent>;
    }

    const { backlinksSummary, backlinksTable } = backlinksData;
    const siteNames = Object.keys(backlinksTable);
    const followData = [
        { name: 'Dofollow', value: Number(backlinksSummary.totalDofollow) || 0, color: '#3b82f6' },
        { name: 'Nofollow', value: Number(backlinksSummary.totalNofollow) || 0, color: '#9ca3af' },
    ];
    const filteredBacklinks = (backlinksTable[activeTableTab] || []).filter(row =>
        row.backlinkUrl.toLowerCase().includes(searchTerm.toLowerCase()) ||
        row.title.toLowerCase().includes(searchTerm.toLowerCase())
    );

    return (
        <PageContent>
            <h1 className="text-3xl font-bold text-gray-800 mb-6">Backlinks Analysis</h1>

            <Card className="mb-6">
                <div className="flex items-center space-x-2 mb-4">
                    <h2 className="text-xl font-bold text-gray-800">Your Backlinks Summary</h2>
                    <InfoTooltip text="An overview of your website's backlink profile, showing link types, quality metrics, and recent changes." />
                </div>
                
                <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                    <div className="p-4 bg-slate-50 rounded-lg">
                        <p className="text-sm text-gray-500">Total Backlinks</p>
                        <p className="text-4xl font-bold text-gray-800">{(backlinksSummary.totalBacklinks || 0).toLocaleString()}</p>
                        <p className="text-sm text-gray-500 mt-1">
                            <span className={(Number(backlinksSummary.backlinksChange) || 0) >= 0 ? 'text-green-600' : 'text-red-600'}>
                                {(Number(backlinksSummary.backlinksChange) || 0) >= 0 ? '+' : ''}{Number(backlinksSummary.backlinksChange) || 0}
                            </span> last month
                        </p>
                    </div>
                    <div className="p-4 bg-slate-50 rounded-lg">
                        <p className="text-sm text-gray-500">Referring Domains</p>
                        <p className="text-4xl font-bold text-gray-800">{backlinksSummary.topReferringDomains || 0}</p>
                    </div>
                    <div className="p-4 bg-slate-50 rounded-lg">
                        <p className="text-sm text-gray-500">Avg. Spam Score</p>
                        <p className="text-4xl font-bold text-gray-800">{backlinksSummary.avgSpamScore || 0}%</p>
                        <p className="text-sm text-gray-500 mt-1">
                            <span className={(Number(backlinksSummary.spamScoreChange) || 0) <= 0 ? 'text-green-600' : 'text-red-600'}>
                                {(Number(backlinksSummary.spamScoreChange) || 0) >= 0 ? '+' : ''}{Number(backlinksSummary.spamScoreChange) || 0}%
                            </span> last month
                        </p>
                    </div>
                    <div className="p-4 bg-slate-50 rounded-lg">
                        <p className="text-sm text-gray-500">Avg. Referring Rank</p>
                        <p className="text-4xl font-bold text-gray-800">{backlinksSummary.avgRefferRank || 0}</p>
                    </div>
                </div>

                <div className="grid grid-cols-1 md:grid-cols-2 gap-6 mt-6">
                    <div className="bg-slate-50 rounded-lg p-4">
                        <div className="flex items-center space-x-2 mb-2">
                            <PlusCircle className="w-4 h-4 text-green-500" />
                            <span className="text-sm text-gray-500">New Links</span>
                            <span className="text-xl font-bold text-gray-800">{backlinksSummary.newLinks || 0}</span>
                            <span className="text-sm text-gray-500">This Run</span>
                        </div>
                        <div className="flex items-center space-x-2">
                            <MinusCircle className="w-4 h-4 text-red-500" />
                            <span className="text-sm text-gray-500">Lost Links</span>
                            <span className="text-xl font-bold text-gray-800">{backlinksSummary.lostLinks || 0}</span>
                            <span className="text-sm text-gray-500">This Run</span>
                        </div>
                    </div>
                    <div className="bg-slate-50 rounded-lg p-4">
                        <ResponsiveContainer width="100%" height={100}>
                            <PieChart>
                                <Pie
                                    data={followData}
                                    dataKey="value"
                                    nameKey="name"
                                    cx="50%"
                                    cy="50%"
                                    innerRadius={25}
                                    outerRadius={40}
                                >
                                    {followData.map((entry, index) => (
                                        <Cell key={`cell-${index}`} fill={entry.color} />
                                    ))}
                                </Pie>
                                <Tooltip />
                            </PieChart>
                        </ResponsiveContainer>
                        <div className="flex justify-center space-x-4 text-sm">
                            <div className="flex items-center">
                                <div className="w-3 h-3 rounded-full bg-blue-500 mr-2"></div>
                                <span>Dofollow: {backlinksSummary.totalDofollow || 0}</span>
                            </div>
                            <div className="flex items-center">
                                <div className="w-3 h-3 rounded-full bg-gray-400 mr-2"></div>
                                <span>Nofollow: {backlinksSummary.totalNofollow || 0}</span>
                            </div>
                        </div>
                    </div>
                </div>
            </Card>

            <Card>
                <div className="flex justify-between items-center mb-4">
                    <div className="flex items-center space-x-2">
                        <h2 className="text-xl font-bold text-gray-800">Backlinks</h2>
                        <InfoTooltip text="Analyze backlinks for your site and competitors. Use the tabs to switch between different sites." />
                    </div>
                    <button
                        onClick={() => alert('Webhook for Backlinks refresh triggered!')}
                        className="bg-slate-100 hover:bg-slate-200 text-slate-600 font-bold py-1 px-3 rounded-lg text-xs transition-colors duration-300"
                    >
                        Refresh
                    </button>
                </div>

                <div className="mb-4">
                    <div className="relative">
                        <Search className="absolute left-3 top-1/2 -translate-y-1/2 w-5 h-5 text-gray-400" />
                        <input
                            type="text"
                            placeholder="Search by URL or title..."
                            value={searchTerm}
                            onChange={(e) => setSearchTerm(e.target.value)}
                            className="w-full pl-10 pr-4 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500"
                        />
                    </div>
                </div>

                <div className="border-b border-gray-200">
                    <nav className="-mb-px flex space-x-6 overflow-x-auto">
                        {siteNames.map(name => (
                            <button
                                key={name}
                                onClick={() => {
                                    setActiveTableTab(name);
                                    setSearchTerm('');
                                }}
                                className={`whitespace-nowrap py-3 px-1 border-b-2 font-medium text-sm ${
                                    activeTableTab === name
                                    ? 'border-blue-500 text-blue-600'
                                    : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300'
                                }`}
                            >
                                {name}
                            </button>
                        ))}
                    </nav>
                </div>

                <div className="mt-4 overflow-x-auto">
                    <table className="w-full text-left text-sm whitespace-nowrap">
                        <thead>
                            <tr className="border-b-2 border-gray-200 bg-gray-50">
                                <th className="py-2 px-3">Backlink URL</th>
                                <th className="py-2 px-3 text-center">Status</th>
                                <th className="py-2 px-3 text-center">Spam Score</th>
                                <th className="py-2 px-3 text-center">Rank</th>
                                <th className="py-2 px-3 text-center">Type</th>
                                <th className="py-2 px-3">Title</th>
                                <th className="py-2 px-3 text-center">Link</th>
                            </tr>
                        </thead>
                        <tbody>
                            {filteredBacklinks.map((row, index) => (
                                <tr key={index} className="border-b border-gray-100 hover:bg-slate-50">
                                    <td className="py-3 px-3 font-medium text-blue-600 hover:text-blue-800">
                                        <a href={row.backlinkUrl} target="_blank" rel="noopener noreferrer" className="hover:underline">
                                            {row.backlinkUrl}
                                        </a>
                                    </td>
                                    <td className="py-3 px-3 text-center">
                                        {row.isNew ? (
                                            <span className="text-xs font-semibold px-2 py-1 bg-blue-100 text-blue-800 rounded-full">New</span>
                                        ) : row.isLost ? (
                                            <span className="text-xs font-semibold px-2 py-1 bg-red-100 text-red-800 rounded-full">Lost</span>
                                        ) : (
                                            <span className="text-gray-400">-</span>
                                        )}
                                    </td>
                                    <td className="py-3 px-3 text-center">
                                        <span className={`px-2 py-1 rounded-full text-xs font-semibold
                                            ${row.spamScore <= 30 ? 'bg-green-100 text-green-800' :
                                            row.spamScore <= 60 ? 'bg-yellow-100 text-yellow-800' :
                                            'bg-red-100 text-red-800'}`}>
                                            {row.spamScore}%
                                        </span>
                                    </td>
                                    <td className="py-3 px-3 text-center">{row.rank}</td>
                                    <td className="py-3 px-3 text-center">
                                        <span className={`px-2 py-1 rounded-full text-xs font-semibold
                                            ${row.following ? 'bg-blue-100 text-blue-800' : 'bg-gray-100 text-gray-800'}`}>
                                            {row.following ? 'Dofollow' : 'Nofollow'}
                                        </span>
                                    </td>
                                    <td className="py-3 px-3 text-gray-600 max-w-xs truncate" title={row.title}>
                                        {row.title || '-'}
                                    </td>
                                    <td className="py-3 px-3 text-center">
                                        <a href={row.linkUrl} target="_blank" rel="noopener noreferrer" className="text-blue-600 hover:text-blue-800 inline-block">
                                            <ExternalLink className="w-4 h-4" />
                                        </a>
                                    </td>
                                </tr>
                            ))}
                        </tbody>
                    </table>
                    {filteredBacklinks.length === 0 && (
                        <div className="text-center py-8 text-gray-500">
                            No matching backlinks found for "{searchTerm}"
                        </div>
                    )}
                </div>
            </Card>
        </PageContent>
    );
};

const ToolsPage     = () => <PageContent><h2 className="text-center text-gray-500">Tools – coming soon</h2></PageContent>;
const GeogridMaps = () => {
    const { ResponsiveContainer, BarChart, Bar, XAxis, YAxis, Tooltip, CartesianGrid, Cell, LabelList } = window.Recharts;
    const [geogridData, setGeogridData] = useState(null);
    const [loading, setLoading] = useState(true);
    const [error, setError] = useState(null);

    // List of keywords we want to display
    const targetKeywords = [
        'medspa',
        'medspa near me',
        'beauty spa',
        'medical spa',
        'aesthetics spa',
        'best med spa near me'
    ];
    
    const getRankColor = (rank) => {
        if (rank === null || rank === undefined) return 'bg-gray-400';
        if (rank <= 3) return 'bg-green-500';
        if (rank <= 5) return 'bg-sky-500';
        if (rank <= 10) return 'bg-yellow-500';
        if (rank <= 20) return 'bg-orange-500';
        return 'bg-red-500';
    };

    useEffect(() => {
        const params = new URLSearchParams(window.location.search);
        const workbookId = params.get('workbookId');
        if (!workbookId) {
            setError("No workbook ID provided");
            setLoading(false);
            return;
        }

        // Use a different cache key for the full geogrid data
        const cacheKey = `full_geogrid_${workbookId}`;
        
        // Try to get data from cache first
        const cachedData = sessionStorage.getItem(cacheKey);
        if (cachedData) {
            try {
                const parsed = JSON.parse(cachedData);
                setGeogridData(parsed);
                setLoading(false);
                return;
            } catch (e) {
                console.error('Cache parsing error:', e);
                // Clear invalid cache
                sessionStorage.removeItem(cacheKey);
            }
        }

        // If no cache or invalid cache, fetch fresh data
        setLoading(true);
        const scriptUrl = `https://script.google.com/macros/s/AKfycbxfOMp8d_eCVH4lFD0PNuFU1wH-gyWOwRt2EuME7GQJ4U73ZwpPDciohDH3C566YLWq/exec?workbookId=${workbookId}`;
        
        fetchWithCorsWorkaround(scriptUrl, (err, data) => {
            if (err) {
                setError(err.message);
                setLoading(false);
                return;
            }
            if (data.error) {
                setError(`Script error: ${data.error}`);
                setLoading(false);
                return;
            }
            
            try {
                // Get geogrid data and normalize keywords
                const rawData = data.geogridData || {};
                const normalizedData = {};
                Object.entries(rawData).forEach(([key, value]) => {
                    normalizedData[key.toLowerCase().trim()] = value;
                });

                // Cache the normalized data
                sessionStorage.setItem(cacheKey, JSON.stringify(normalizedData));
                
                setGeogridData(normalizedData);
                setLoading(false);
            } catch (e) {
                console.error('Data processing error:', e);
                setError('Failed to process geogrid data');
                setLoading(false);
            }
        });
    }, []);

    if (loading) {
        return (
            <PageContent>
                <div className="flex justify-between items-center mb-6">
                    <div>
                        <h1 className="text-3xl font-bold text-gray-800">Geogrid Search Results</h1>
                        <p className="text-gray-500 mt-1">Track your local search rankings across different keywords</p>
                    </div>
                    <button
                        disabled
                        className="bg-slate-100 text-slate-400 font-bold py-1 px-3 rounded-lg text-xs cursor-not-allowed"
                    >
                        Refresh
                    </button>
                </div>
                <div className="grid grid-cols-1 md:grid-cols-2 gap-8">
                    {targetKeywords.map(keyword => (
                        <Card key={keyword} className="animate-pulse">
                            <div className="h-[500px] bg-gray-100 rounded-lg"></div>
                        </Card>
                    ))}
                </div>
            </PageContent>
        );
    }

    const GeogridMapCard = ({ keyword, monthlyData }) => {
        const [currentMonthIndex, setCurrentMonthIndex] = useState(0);
        const CHART_COLORS = ['#3b82f6', '#16a34a', '#f97316', '#a855f7', '#ec4899'];

        // Validate monthlyData
        if (!Array.isArray(monthlyData) || monthlyData.length === 0) {
            return (
                <Card>
                    <div className="p-4 text-center text-gray-500">
                        No data available for keyword: {keyword}
                    </div>
                </Card>
            );
        }

        const currentData = monthlyData[currentMonthIndex];
        
        // Validate currentData
        if (!currentData || !currentData.competitors) {
            return (
                <Card>
                    <div className="p-4 text-center text-gray-500">
                        Invalid data format for keyword: {keyword}
                    </div>
                </Card>
            );
        }

        const handleDateChange = (direction) => {
            const newIndex = currentMonthIndex + direction;
            if (newIndex >= 0 && newIndex < monthlyData.length) {
                setCurrentMonthIndex(newIndex);
            }
        };

        // Ensure competitors array exists and has valid data
        const competitors = Array.isArray(currentData.competitors) ? currentData.competitors : [];

        const CustomXAxisTick = ({ x, y, payload }) => {
            const name = payload.value || '';
            // A simple heuristic to split long names
            if (name.length > 15) { 
                const breakPoint = name.lastIndexOf(' ', 15);
                const line1 = breakPoint > 0 ? name.substring(0, breakPoint) : name.substring(0, 15);
                const line2 = breakPoint > 0 ? name.substring(breakPoint + 1) : name.substring(15);
                return (
                    <g transform={`translate(${x},${y})`}>
                        <text x={0} y={0} dy={5} textAnchor="end" fill="#6B7280" fontSize={12} transform="rotate(-40)">
                            <tspan x="0" dy="1em">{line1}</tspan>
                            {line2 && <tspan x="0" dy="1.2em">{line2}</tspan>}
                        </text>
                    </g>
                );
            }

            return (
                <g transform={`translate(${x},${y})`}>
                    <text x={0} y={0} dy={16} textAnchor="end" fill="#6B7280" fontSize={12} transform="rotate(-40)">{name}</text>
                </g>
            );
        };

        return (
            <Card>
                <div className="flex justify-between items-start mb-4">
                    <div>
                        <h2 className="text-xl font-bold text-gray-800">{keyword}</h2>
                        <p className="text-sm text-gray-500 mt-1">Latest Rankings</p>
                    </div>
                    <div className="flex items-center space-x-4">
                        <button 
                            onClick={() => handleDateChange(-1)} 
                            disabled={currentMonthIndex <= 0}
                            className="p-2 rounded-lg bg-gray-100 hover:bg-gray-200 disabled:opacity-50 disabled:cursor-not-allowed text-gray-600"
                        >
                            &lt;
                        </button>
                        <span className="font-semibold text-gray-700">{currentData.date || 'No date'}</span>
                        <button 
                            onClick={() => handleDateChange(1)} 
                            disabled={currentMonthIndex >= monthlyData.length - 1}
                            className="p-2 rounded-lg bg-gray-100 hover:bg-gray-200 disabled:opacity-50 disabled:cursor-not-allowed text-gray-600"
                        >
                            &gt;
                        </button>
                    </div>
                </div>
                
                <div className="grid grid-cols-1 md:grid-cols-4 gap-4">
                    {/* Left Column: Avg Score */}
                    <div className="md:col-span-1">
                        {competitors.length > 0 && (
                            <div>
                                <h3 className="text-lg font-semibold text-gray-800 mb-3">Avg Score</h3>
                                <div className="space-y-2">
                                    {competitors.map((comp, index) => (
                                        <div key={index} className="flex items-center space-x-3 p-2 rounded-lg bg-slate-50 border border-slate-200">
                                            <div className={`flex-shrink-0 w-10 h-10 rounded-lg flex items-center justify-center font-bold text-white text-base ${getRankColor(comp.rank)}`}>
                                                {typeof comp.rank === 'number' ? comp.rank.toFixed(1) : '-'}
                                            </div>
                                            <div className="flex-1 min-w-0">
                                                <p className="font-medium text-sm text-gray-800 leading-tight truncate" title={comp.name || 'Unknown'}>{comp.name || 'Unknown'}</p>
                                                {comp.domain && (
                                                    <p className="text-xs text-gray-500 truncate" title={comp.domain}>{comp.domain}</p>
                                                )}
                                            </div>
                                        </div>
                                    ))}
                                </div>
                            </div>
                        )}
                    </div>

                    {/* Right Column: Map */}
                    <div className="md:col-span-3">
                        {currentData.mapLink ? (
                            <div className="relative w-full h-[550px] overflow-hidden -mx-2">
                                <iframe 
                                    src={currentData.mapLink}
                                    className="w-full h-full rounded-lg"
                                    style={{ background: '#f9fafb' }}
                                    loading="lazy"
                                    allowFullScreen
                                    scrolling="no"
                                />
                                <a 
                                    href={currentData.mapLink} 
                                    target="_blank" 
                                    rel="noopener noreferrer"
                                    className="absolute bottom-2 right-2 bg-white/90 hover:bg-white text-gray-700 px-2 py-1 rounded text-xs flex items-center gap-1 shadow-sm transition-colors"
                                >
                                    <svg className="w-3 h-3" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                                        <path d="M18 13v6a2 2 0 01-2 2H5a2 2 0 01-2-2V8a2 2 0 012-2h6" />
                                        <polyline points="15 3 21 3 21 9" />
                                        <line x1="10" y1="14" x2="21" y2="3" />
                                    </svg>
                                    Open in new tab
                                </a>
                            </div>
                        ) : (
                            <div className="w-full h-[550px] flex flex-col items-center justify-center bg-gray-50 rounded-lg">
                                <div className="bg-gray-100 p-4 rounded-full mb-4">
                                    <svg className="w-12 h-12 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M9 20l-5.447-2.724A1 1 0 013 16.382V5.618a1 1 0 011.447-.894L9 7m0 13l6-3m-6 3V7m6 10l4.553 2.276A1 1 0 0021 18.382V7.618a1 1 0 00-.553-.894L15 4m0 13V4m0 0L9 7" />
                                    </svg>
                                </div>
                                <p className="text-lg font-semibold text-gray-600 mb-2">Map Not Available Yet</p>
                                <p className="text-sm text-gray-500 text-center max-w-md">
                                    The Geogrid map for "{keyword}" is pending setup. Once available, it will show local search rankings across your service area.
                                </p>
                            </div>
                        )}
                    </div>
                </div>

                {/* Bottom Row: Bar Chart */}
                {competitors.length > 0 && (
                    <div className="mt-8">
                        <h3 className="text-lg font-semibold text-gray-800 mb-3">Rankings in Top 5</h3>
                        <ResponsiveContainer width="100%" height={300}>
                            <BarChart data={competitors} margin={{ top: 20, right: 30, left: 0, bottom: 80 }}>
                                 <CartesianGrid strokeDasharray="3 3" vertical={false} />
                                 <XAxis 
                                     dataKey="name" 
                                     type="category" 
                                     interval={0} 
                                     tick={<CustomXAxisTick />} 
                                     height={90}
                                 />
                                 <YAxis 
                                     type="number" 
                                     allowDecimals={false} 
                                     domain={[0, dataMax => (Math.ceil((dataMax || 5) * 1.1 / 5) * 5)]} 
                                     tick={{ fontSize: 12, fill: '#6B7280' }}
                                 />
                                 <Tooltip
                                     cursor={{ fill: 'rgba(241, 245, 249, 0.7)' }}
                                     contentStyle={{
                                         backgroundColor: 'rgba(31, 41, 55, 0.9)',
                                         borderColor: 'rgba(255,255,255,0.2)',
                                         borderRadius: '0.5rem',
                                         boxShadow: '0 4px 6px rgba(0,0,0,0.1)'
                                     }}
                                     itemStyle={{ color: '#fff' }}
                                     labelStyle={{ color: '#fff', fontWeight: 'bold' }}
                                     formatter={(value, name, props) => [`${value}`, 'Top 5 Count']}
                                     labelFormatter={(label) => `${label}`}
                                 />
                                 <Bar dataKey='top5Total' name="Top 5 Rankings" radius={[4, 4, 0, 0]}>
                                     {competitors.map((entry, index) => <Cell key={`cell-${index}`} fill={CHART_COLORS[index % CHART_COLORS.length]} /> )}
                                     <LabelList dataKey="top5Total" position="top" style={{ fill: '#4B5563', fontSize: 12, fontWeight: 'bold' }} />
                                 </Bar>
                            </BarChart>
                        </ResponsiveContainer>
                    </div>
                )}
            </Card>
        );
    };

    return (
        <PageContent>
            <div className="flex justify-between items-center mb-6">
                <div>
                    <h1 className="text-3xl font-bold text-gray-800">Geogrid Search Results</h1>
                    <p className="text-gray-500 mt-1">Track your local search rankings across different keywords</p>
                </div>
                <button
                    onClick={() => alert('Webhook for Geogrid refresh triggered!')}
                    className="bg-slate-100 hover:bg-slate-200 text-slate-600 font-bold py-1 px-3 rounded-lg text-xs transition-colors duration-300"
                >
                    Refresh
                </button>
            </div>

            <div className="grid grid-cols-1 xl:grid-cols-2 gap-4">
                {targetKeywords.map(keyword => (
                    <GeogridMapCard 
                        key={keyword} 
                        keyword={keyword} 
                        monthlyData={geogridData[keyword.toLowerCase().trim()] || []} 
                    />
                ))}
            </div>
        </PageContent>
    );
};

/* ------------------------------------------------------------------ */
/* WEBSITE STATS - HELPER COMPONENTS & DATA                           */
/* ------------------------------------------------------------------ */
const StatCard = ({ label, value, icon, tooltip }) => {
    const cardRef = useRef(null);
    const [tooltipPosition, setTooltipPosition] = useState('top');
    const [tooltipWidthClass, setTooltipWidthClass] = useState('w-64');

    useEffect(() => {
        if (tooltip && tooltip.width === 'large') {
            setTooltipWidthClass('w-[600px]');
        } else {
            setTooltipWidthClass('w-64');
        }

        const cardElement = cardRef.current;
        if (!cardElement || !tooltip) return;

        const handleMouseEnter = () => {
            const cardRect = cardElement.getBoundingClientRect();
            // A more robust heuristic for tooltip positioning
            const spaceAbove = cardRect.top;
            const spaceBelow = window.innerHeight - cardRect.bottom;
            const estimatedHeight = tooltip.width === 'large' ? 350 : 150;

            if (spaceAbove < estimatedHeight && spaceBelow > spaceAbove) {
                setTooltipPosition('bottom');
            } else {
                setTooltipPosition('top');
            }
        };

        cardElement.addEventListener('mouseenter', handleMouseEnter);

        return () => {
            if (cardElement) {
                cardElement.removeEventListener('mouseenter', handleMouseEnter);
            }
        };
    }, [tooltip]);

    const content = (
        <div className="flex items-center space-x-3">
            <div className="p-2 bg-blue-100 rounded-full">{icon}</div>
            <div>
                <p className="text-sm text-gray-500">{label}</p>
                <p className={`font-bold text-lg ${value.color || 'text-gray-800'}`}>{value.text}</p>
            </div>
        </div>
    );

    if (tooltip && tooltip.content) {
        return (
            <div ref={cardRef} className="relative group cursor-help">
                {content}
                <div className={`absolute left-1/2 -translate-x-1/2 ${tooltipWidthClass} bg-gray-800 text-white text-sm rounded-lg shadow-lg opacity-0 group-hover:opacity-100 transition-opacity duration-300 z-50 pointer-events-none ${tooltipPosition === 'top' ? 'bottom-full mb-2' : 'top-full mt-2'}`}>
                    {tooltip.header && (
                         <div className="px-3 py-1.5 bg-gray-700 rounded-t-lg font-semibold border-b border-gray-600">
                            {tooltip.header}
                        </div>
                    )}
                    <div className="p-3">{tooltip.content}</div>
                    <div className={`absolute left-1/2 -translate-x-[6px] w-3 h-3 bg-gray-800 transform rotate-45 ${tooltipPosition === 'top' ? 'bottom-[-6px]' : 'top-[-6px]'}`}></div>
                </div>
            </div>
        );
    }
    return content;
};

const HealthCheckItem = ({ icon, color, title, items }) => (
    <div className="relative group flex items-center space-x-2">
        {icon}
        <div>
            <p className={`font-bold text-lg ${color}`}>{items.length}</p>
            <p className="text-xs text-gray-500">{title}</p>
        </div>
        <div className="absolute left-0 bottom-full mb-2 w-72 p-3 bg-gray-800 text-white text-xs rounded-lg shadow-lg opacity-0 group-hover:opacity-100 transition-opacity duration-300 z-10 pointer-events-none">
            <h4 className="font-bold mb-2 border-b border-gray-600 pb-1">{title} Found</h4>
            <ul className="space-y-1">
                {items.map((item, index) => <li key={index}>- {item.description}</li>)}
            </ul>
            {items.length === 0 && <p className="text-gray-400">No issues found.</p>}
        </div>
    </div>
);

const BooleanCheck = ({ value, tooltipContent }) => {
    const check = value ? <CheckCircle className="w-5 h-5 text-green-500 mx-auto" /> : <XCircle className="w-5 h-5 text-red-500 mx-auto" />;
    const ContentTooltip = ({ content, children }) => (
         <div className="relative group flex justify-center">
            {children}
            <div className="absolute left-1/2 -translate-x-1/2 bottom-full mb-2 w-80 p-3 bg-gray-800 text-white text-xs rounded-lg shadow-lg opacity-0 group-hover:opacity-100 transition-opacity duration-300 z-10 pointer-events-none">
                {content ? content : <span className="text-gray-400">Not Found</span>}
            </div>
        </div>
    );
    if (tooltipContent) {
        return <ContentTooltip content={tooltipContent}>{check}</ContentTooltip>
    }
    return check;
};

const formatDate = (dateString) => {
    if (!dateString) return null;
    const date = new Date(dateString);
    if (isNaN(date.getTime())) return dateString; // Return original if invalid
    return date.toLocaleDateString('en-GB', { day: '2-digit', month: 'short', year: 'numeric' });
};

const CalendarIcon = createIcon(
  <>
    <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
    <line x1="16" y1="2" x2="16" y2="6"></line>
    <line x1="8" y1="2" x2="8" y2="6"></line>
    <line x1="3" y1="10" x2="21" y2="10"></line>
  </>
);

const checkCategories = {
    performance: {
        title: "Performance",
        icon: "⚡",
        checks: { high_loading_time: "Page loads quickly", high_waiting_time: "Server responds quickly", has_render_blocking_resources: "No render-blocking resources", size_greater_than_3mb: "Page size is optimized", small_page_size: "Page is lightweight", large_page_size: "Page size is reasonable" }
    },
    security: {
        title: "Security & Technical",
        icon: "🔒",
        checks: { is_https: "Uses secure HTTPS connection", is_http: "HTTP connection available", is_www: "WWW configuration correct", has_html_doctype: "Proper HTML structure", no_doctype: "DOCTYPE declaration present", canonical: "Canonical URL defined", flash: "No Flash content (deprecated)", frame: "No frame usage (outdated)", has_favicon: "Favicon present" }
    },
    content: {
        title: "Content Quality",
        icon: "📝",
        checks: { low_content_rate: "Sufficient content density", high_content_rate: "Content not overly dense", low_character_count: "Adequate content length", high_character_count: "Content length appropriate", low_readability_rate: "Content is readable", lorem_ipsum: "No placeholder content" }
    },
    seo: {
        title: "SEO Optimization",
        icon: "🎯",
        checks: { has_meta_title: "Meta title present", title_too_long: "Title length optimal", title_too_short: "Title length sufficient", no_title: "Title tag implemented", has_micromarkup: "Rich snippets implemented", has_micromarkup_errors: "Rich snippets valid", irrelevant_title: "Title is relevant", irrelevant_description: "Description is relevant", irrelevant_meta_keywords: "Keywords are relevant", no_description: "Meta description present", duplicate_meta_tag: "No duplicate meta tags", duplicate_title_tag: "No duplicate titles", seo_friendly_url: "URLs are SEO-friendly", seo_friendly_url_characters_check: "URL characters valid", seo_friendly_url_dynamic_check: "URLs not dynamic", seo_friendly_url_keywords_check: "URLs contain keywords", seo_friendly_url_relative_length_check: "URL length appropriate" }
    },
    accessibility: {
        title: "Accessibility",
        icon: "♿",
        checks: { no_image_alt: "Images have alt text", no_image_title: "Images have titles", deprecated_html_tags: "Modern HTML used", no_h1_tag: "Main heading present" }
    }
};

/* ------------------------------------------------------------------ */
/* WEBSITE STATS – polished gauge, colour rules, horizontal bars      */
/* ------------------------------------------------------------------ */
const WebsiteStats = ({ data }) => {
    const { healthData, competitorPerfData, technicalSeoData } = data;
    const { Card, TooltipWrapper } = window['@tremor/react'];
    const { ShieldCheck, Star, Gauge, Link2, Server, AlertTriangle, XCircle, CheckCircle2, Zap } = lucide;

    if (!healthData) return <div className="text-center text-gray-500">Loading website stats...</div>;

    const StatCard = ({ label, value, icon, tooltip }) => {
        const cardElement = React.useRef(null);
        const [tooltipPosition, calculatePosition] = useTooltipPosition(cardElement);

        const content = (
            <div ref={cardElement} onMouseEnter={calculatePosition} className="relative bg-slate-50 p-4 rounded-lg transition-all hover:bg-white hover:shadow-md h-full flex flex-col justify-between">
                <div>
                    <div className="flex items-center text-gray-600">
                        {icon}
                        <span className="ml-2 text-sm font-medium">{label}</span>
                    </div>
                    <p className={`text-2xl font-bold mt-2 ${value.color}`}>{value.text}</p>
                </div>
            </div>
        );

        if (tooltip) {
            return (
                <TooltipWrapper 
                    content={tooltip.content}
                    title={tooltip.title}
                    position={tooltipPosition}
                    width="large"
                    className="cursor-help"
                >
                    {content}
                </TooltipWrapper>
            );
        }
        return content;
    }
    
    const HealthCheckItem = ({ title, status, details, tooltip }) => {
        const statusConfig = {
            'passing': { icon: <CheckCircle2 className="text-green-500" />, text: 'text-gray-800', bg: 'bg-green-50' },
            'failing': { icon: <XCircle className="text-red-500" />, text: 'text-gray-800', bg: 'bg-red-50' },
            'warning': { icon: <AlertTriangle className="text-yellow-500" />, text: 'text-gray-800', bg: 'bg-yellow-50' }
        };
        const config = statusConfig[status];

        return (
            <div 
                className="has-tooltip relative flex items-center justify-between p-3 rounded-md"
            >
                <div className="flex items-center">
                    <div className="mr-3">{config.icon}</div>
                    <span className={`${config.text} text-sm`}>{title}</span>
                </div>
                <span className="text-sm text-gray-500">{details}</span>
                {tooltip && <div className="tooltip absolute z-10 p-2 bg-gray-700 text-white text-xs rounded-md shadow-lg">{tooltip}</div>}
            </div>
        );
    }

    const scoreCol = healthData.pageScore > 89 ? 'text-green-600' : healthData.pageScore > 49 ? 'text-yellow-600' : 'text-red-600';
    const speedSec = parseFloat(healthData.siteSpeed);
    const speedCol = speedSec < 1.5 ? 'text-green-600' : speedSec < 3 ? 'text-yellow-600' : 'text-red-600';
    
    const hasBrokenLinks = healthData.brokenLinks === true || String(healthData.brokenLinks).toLowerCase() === 'true';
    const brokenLinksText = hasBrokenLinks ? 'Found' : '0';
    const linkCol = hasBrokenLinks ? 'text-red-600' : 'text-green-600';

    const sslCol   = healthData.ssl ? 'text-green-600' : 'text-red-600';
    const errorCol = healthData.errors?.length > 0 ? 'text-red-600' : 'text-green-600';
    const warnCol  = healthData.warnings?.length > 0 ? 'text-yellow-600' : 'text-green-600';
 
    // Filter and format speed details for the tooltip
    const formattedSpeedDetails = healthData.speedDetails 
        ? Object.entries(healthData.speedDetails)
            .filter(([key, val]) => val !== null && val !== '' && val !== undefined)
            .map(([key, val]) => {
                // Append 's' to time-based metrics
                const isTime = key.toLowerCase().includes('time') || key.toLowerCase().includes('paint') || key.toLowerCase().includes('delay') || key.toLowerCase().includes('duration') || key.toLowerCase().includes('complete');
                const formattedVal = (typeof val === 'number' && isTime) ? `${val.toFixed(2)}s` : val;
                return [key, formattedVal];
            })
        : [];
 
    const speedDetailsContent = (
        <div className="text-white">
            <p className="mb-3 text-gray-300">Detailed performance metrics based on the latest site crawl.</p>
            {formattedSpeedDetails.length > 0 ? (
                <div className="space-y-1.5 text-xs">
                    {formattedSpeedDetails.map(([key, val]) => (
                        <div key={key} className="flex justify-between items-center">
                            <span>{key}:</span>
                            <span className="font-semibold">{val}</span>
                        </div>
                    ))}
                </div>
            ) : (
                <div className="text-center py-4 text-gray-400">
                    No detailed speed metrics available.
                </div>
            )}
        </div>
    );

    // Restore color logic for Checks Passed based on absolute numbers
    const checksPassed = healthData.checks.checksPassed;
    const passCol = checksPassed >= 46 ? 'text-green-600' : checksPassed >= 36 ? 'text-yellow-600' : 'text-red-600';

    const coreStats = [
        { 
            label: 'Page Score', 
            value: { text: healthData.pageScore, color: scoreCol }, 
            icon: <Star className="w-5 h-5 text-blue-600" />
        },
        { 
            label: 'Site Speed', 
            value: { text: healthData.siteSpeed, color: speedCol },
            icon: <Gauge className="w-5 h-5 text-blue-600" />,
            tooltip: { title: 'Site Speed Details', content: speedDetailsContent }
        },
        { 
            label: 'Broken Links', 
            value: { text: brokenLinksText, color: linkCol }, 
            icon: <Link2 className="w-5 h-5 text-blue-600" />
        },
        { 
            label: 'SSL Enabled', 
            value: { text: healthData.ssl ? 'Yes' : 'No', color: sslCol }, 
            icon: <ShieldCheck className="w-5 h-5 text-blue-600" />
        },
        { 
            label: 'Checks Passed', 
            value: { text: `${healthData.checks.checksPassed} / ${healthData.checks.totalChecks}`, color: passCol }, 
            icon: <CheckCircle2 className="w-5 h-5 text-blue-600" />
        }
    ];

    const lastUpdatedDate = healthData.lastUpdated && healthData.lastUpdated.length > 0
        ? new Date(Math.max.apply(null, healthData.lastUpdated.map(d => new Date(d))))
        : null;

    const formattedDate = lastUpdatedDate 
        ? `${lastUpdatedDate.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' })}`
        :'Not available';

    // Tooltip positioning logic
    const useTooltipPosition = (cardElement) => {
        const [tooltipPosition, setTooltipPosition] = useState('top');
        
        const calculatePosition = () => {
            if (!cardElement.current) return;
            const cardRect = cardElement.current.getBoundingClientRect();
            const spaceAbove = cardRect.top;
            const spaceBelow = window.innerHeight - cardRect.bottom;
            const estimatedHeight = 350; // A generous estimate for tooltip height
            
            if (spaceAbove < estimatedHeight && spaceBelow > spaceAbove) {
                setTooltipPosition('bottom');
            } else {
                setTooltipPosition('top');
            }
        };
        
        return [tooltipPosition, calculatePosition];
    };


    return (
        <div className="space-y-6">
            <Card>
                <div className="flex justify-between items-center mb-4">
                    <h2 className="text-xl font-bold text-gray-800">Website Health & Stats</h2>
                    <span className="text-sm text-gray-500">Last updated: {formattedDate}</span>
                </div>

                <div className="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-5 gap-4">
                    {coreStats.map(stat => <StatCard key={stat.label} {...stat} />)}
                </div>

                {/* AI Notes Section */}
                {healthData.aiNotes && (
                    <div className="mt-6 bg-blue-50 border border-blue-200 rounded-lg p-5">
                        <div className="flex items-center mb-2">
                            <Zap className="w-6 h-6 text-blue-500 mr-3" />
                            <h3 className="text-lg font-semibold text-gray-800">AI-Generated Insights</h3>
                        </div>
                        <p className="text-sm text-gray-700 leading-relaxed whitespace-pre-wrap">{healthData.aiNotes}</p>
                    </div>
                )}
            </Card>

            <div className="grid grid-cols-1 lg:grid-cols-2 gap-6 mt-6">
                <Card>
                    <h3 className="font-bold text-gray-800 mb-4">Technical SEO Health</h3>
                    <div className="space-y-2">
                        <HealthCheckItem title="Content & Structure" status="passing" details={`${healthData.checks.passedList.filter(c => c.includes('title') || c.includes('description')).length} / 5 passed`} />
                        <HealthCheckItem title="Indexing & Crawlability" status="warning" details="3 / 5 passed" />
                        <HealthCheckItem title="Security" status="passing" details="2 / 2 passed" />
                        <HealthCheckItem title="Performance" status="failing" details="1 / 4 passed" />
                    </div>
                </Card>
                
                <Card>
                    <div className="flex justify-between items-center mb-4">
                        <h3 className="font-bold text-gray-800">Errors & Warnings</h3>
                        <div className="flex space-x-4">
                            <span className={`flex items-center text-sm font-medium ${errorCol}`}>
                                <XCircle className="w-4 h-4 mr-1.5" /> {healthData.errors?.length || 0} Errors
                            </span>
                            <span className={`flex items-center text-sm font-medium ${warnCol}`}>
                                <AlertTriangle className="w-4 h-4 mr-1.5" /> {healthData.warnings?.length || 0} Warnings
                            </span>
                        </div>
                    </div>
                    <div className="h-40 overflow-y-auto pr-2 space-y-2">
                        {healthData.errors?.map(e => <div key={e.id} className="text-xs p-2 rounded bg-red-50 text-red-700">{e.description}</div>)}
                        {healthData.warnings?.map(w => <div key={w.id} className="text-xs p-2 rounded bg-yellow-50 text-yellow-700">{w.description}</div>)}
                        {healthData.errors?.length === 0 && healthData.warnings?.length === 0 &&
                            <div className="flex flex-col items-center justify-center h-full text-gray-400">
                                <CheckCircle2 className="w-10 h-10 text-green-500 mb-2" />
                                <span className="font-medium">No issues found</span>
                            </div>
                        }
                    </div>
                </Card>
            </div>

            {/* Competitor Performance Table */}
            {/* ... table jsx ... */}
        </div>
    );
}

/* ------------------------------------------------------------------ */
/* HEADER                                                             */
/* ------------------------------------------------------------------ */
const Header = ({active,setActive}) => {
  const tabs=['Dashboard','Website Stats','Geogrid Maps','Keywords','Backlinks','Tools'];
  return (
    <header className="bg-white shadow-sm sticky top-0 z-20">
      <nav className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
        <div className="flex items-center justify-between h-16">
          <div className="flex items-center">
            <svg className="h-8 w-8" viewBox="0 0 24 24" fill="none"
                 stroke="url(#lg)" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
              <defs>
                <linearGradient id="lg" x1="0%" y1="0%" x2="100%" y2="0%">
                  <stop offset="0%" stopColor="#3b82f6"/><stop offset="100%" stopColor="#ec4899"/>
                </linearGradient>
              </defs>
              <path d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"/>
            </svg>
            <h1 className="text-xl font-bold ml-3 bg-gradient-to-r from-blue-500 to-pink-500 bg-clip-text text-transparent">
              MedSpa SEO
            </h1>
          </div>
          <div className="hidden md:block">
            <div className="ml-10 flex space-x-4">
              {tabs.map(t=>(
                <button key={t}
                        onClick={()=>setActive(t)}
                        className={`px-3 py-2 rounded-md text-sm font-medium
                          ${active===t?'bg-blue-600 text-white':'text-gray-500 hover:bg-gray-100 hover:text-gray-900'}`}>
                  {t}
                </button>
              ))}
            </div>
          </div>
        </div>
      </nav>
    </header>
  );
};

/* ------------------------------------------------------------------ */
/* MAIN APP – fetches data, routes tabs                               */
/* ------------------------------------------------------------------ */
const App = () => {
  const [tab, setTab]   = useState('Dashboard');
  const [data, setData] = useState(null);
  const [err,  setErr]  = useState(null);
  const [load, setLoad] = useState(true);

  useEffect(() => {
    const id = new URLSearchParams(location.search).get('workbookId');
    if (!id) { setErr('Add ?workbookId=YOUR_ID to the URL'); setLoad(false); return; }

    fetch(`https://script.google.com/macros/s/AKfycbxfOMp8d_eCVH4lFD0PNuFU1wH-gyWOwRt2EuME7GQJ4U73ZwpPDciohDH3C566YLWq/exec?workbookId=${id}`)
      .then(r => r.json())
      .then(j => { if (j.error) throw new Error(j.error); setData(j); setLoad(false); })
      .catch(e => { console.error(e); setErr(e.message); setLoad(false); });
  }, []);

  /* routing */
  let body;
  if (load) {
    body = (
      <PageContent>
        <div className="p-8 text-center text-gray-500">Loading data…</div>
      </PageContent>
    );
  } else if (err) {
    body = (
      <PageContent>
        <div className="p-8 text-center text-red-500">{err}</div>
      </PageContent>
    );
  } else {
    switch (tab) {
      case 'Dashboard':
        body = <Dashboard setActiveTab={setTab} />;
        break;
      case 'Website Stats':
        body = <WebsiteStats data={data.websiteStats} />;
        break;
      case 'Geogrid Maps':
        body = <GeogridMaps data={data.geogridData} />;
        break;
      case 'Keywords':
        body = (
          <Keywords
            summary={data.keywordsSummary}
            table={data.keywordsTable}
          />
        );
        break;
      case 'Backlinks':
        body = <Backlinks />;
        break;
      default:
        body = <ToolsPage />;
    }
  }

  /* ----- render ----- */
  return (
    <div className="min-h-screen bg-gray-50 font-sans">
      <Header active={tab} setActive={setTab} />
      {body}
    </div>
  );
};

/* mount React app */
ReactDOM.createRoot(document.getElementById('root')).render(<App />);
</script>
</body>
</html>
