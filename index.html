<!DOCTYPE html>
<!--
  MedSpa SEO Dashboard - Application Overview

  This file, `index.html`, serves as the front-end for the MedSpa SEO tracking dashboard.
  It is built using vanilla HTML, Tailwind CSS for styling, and React (via CDN) for dynamic components.

  Application Architecture:

  The dashboard's data is sourced from a two-workbook system hosted on Google Sheets, each managed by its own Google App Script. This architecture separates client-specific data from general service data.

  1. Client Workbook:
     - A new, unique Google Sheet (workbook) is created for each individual client.
     - This workbook contains all client-specific data, such as website stats, GBP info, keyword rankings, backlink profiles, geogrid maps, and competitor data.
     - It is managed by the `Client Workbook App Script v2.gs`.
     - The dashboard identifies and fetches data from the correct client workbook by reading the `workbookId` from the URL query parameter (e.g., ?workbookId=YOUR_ID).

  2. Services Workbook:
     - A single, shared Google Sheet that contains trend data for MedSpa services (e.g., search volume, competition).
     - This data populates the "Services by Search Volume" and "New Services by Search Volume" cards on the dashboard.
     - It is managed by the `Service Cards (Dashboard) App Script v2.gs`.
     - The script for this workbook is called with a geographic location parameter to fetch relevant data.

  This setup ensures that each client's sensitive data is isolated in its own workbook, while still allowing the dashboard to display general industry trends from a centralized source.
-->
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1.0"/>
  <title>MedSpa SEO Dashboard</title>
  
  <!-- Custom favicon matching header icon -->
  <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%23000' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'><defs><linearGradient id='favicon-gradient' x1='0%25' y1='0%25' x2='100%25' y2='0%25'><stop offset='0%25' stop-color='%233b82f6'/><stop offset='100%25' stop-color='%23ec4899'/></linearGradient></defs><path d='M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z' stroke='url(%23favicon-gradient)'/></svg>">

  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Inter font -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet"/>

  <style>
    body { font-family:'Inter',sans-serif }
    .loader-container {display:flex;flex-direction:column;justify-content:center;align-items:center;height:100vh}
    .loader {border:4px solid #f3f3f3;border-top:4px solid #3498db;border-radius:50%;width:40px;height:40px;animation:spin 1s linear infinite}
    @keyframes spin {0%{transform:rotate(0deg)}100%{transform:rotate(360deg)}}

    /* Dark Mode Theme Variables */
    :root {
      /* Light mode colors */
      --bg-primary: #f9fafb;
      --bg-secondary: #ffffff;
      --bg-tertiary: #f3f4f6;
      --text-primary: #111827;
      --text-secondary: #6b7280;
      --text-tertiary: #9ca3af;
      --border-primary: #e5e7eb;
      --border-secondary: #d1d5db;
      --shadow-light: rgba(0, 0, 0, 0.1);
      --shadow-medium: rgba(0, 0, 0, 0.15);
      --shadow-heavy: rgba(0, 0, 0, 0.25);
      
      /* Card backgrounds */
      --card-bg: #ffffff;
      --card-border: #e5e7eb;
      --card-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
      
      /* Header colors */
      --header-bg: #ffffff;
      --header-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
      
      /* Button colors */
      --btn-secondary-bg: #f3f4f6;
      --btn-secondary-hover: #e5e7eb;
      --btn-secondary-text: #374151;
      
      /* Input colors */
      --input-bg: #ffffff;
      --input-border: #d1d5db;
      --input-focus: #3b82f6;
      
      /* Gradient backgrounds */
      --gradient-blue: linear-gradient(to right, #dbeafe, #e0e7ff);
      --gradient-slate: linear-gradient(to right, #f8fafc, #e2e8f0);
      --gradient-green: linear-gradient(to right, #dcfce7, #bbf7d0);
      
      /* Keywords bar colors */
      --keywords-bar-bg: linear-gradient(to right, #dcfce7, #bbf7d0);
      --keywords-bar-border: #bbf7d0;
      
      /* Chart colors */
      --chart-text: #000000;
    }

    [data-theme="dark"] {
      /* Dark mode colors */
      --bg-primary: #0c1220;
      --bg-secondary: #1e293b;
      --bg-tertiary: #334155;
      --text-primary: #f1f5f9;
      --text-secondary: #cbd5e1;
      --text-tertiary: #94a3b8;
      --border-primary: #334155;
      --border-secondary: #475569;
      --shadow-light: rgba(0, 0, 0, 0.3);
      --shadow-medium: rgba(0, 0, 0, 0.4);
      --shadow-heavy: rgba(0, 0, 0, 0.6);
      
      /* Card backgrounds */
      --card-bg: #1e293b;
      --card-border: #334155;
      --card-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.3), 0 4px 6px -2px rgba(0, 0, 0, 0.15);
      
      /* Header colors */
      --header-bg: #1e293b;
      --header-shadow: 0 1px 2px rgba(0, 0, 0, 0.3);
      
      /* Button colors */
      --btn-secondary-bg: #334155;
      --btn-secondary-hover: #475569;
      --btn-secondary-text: #e2e8f0;
      
      /* Input colors */
      --input-bg: #334155;
      --input-border: #475569;
      --input-focus: #60a5fa;
      
      /* Gradient backgrounds */
      --gradient-blue: linear-gradient(to right, #1e40af, #3730a3);
      --gradient-slate: linear-gradient(to right, #334155, #475569);
      --gradient-green: linear-gradient(to right, #166534, #15803d);
      
      /* Keywords bar colors - more subtle for dark mode */
      --keywords-bar-bg: linear-gradient(to right, #0f3f3c, #134e4a);
      --keywords-bar-border: #0f766e;
      
      /* Chart colors */
      --chart-text: #cbd5e1;
    }

         /* Apply theme variables to base elements */
     body {
       background-color: var(--bg-primary);
       color: var(--text-primary);
       transition: background-color 0.3s ease, color 0.3s ease;
     }

     /* Dark mode text and heading styles */
     [data-theme="dark"] .text-gray-800 { color: var(--text-primary) !important; }
     [data-theme="dark"] .text-gray-900 { color: var(--text-primary) !important; }
     [data-theme="dark"] .text-gray-700 { color: var(--text-secondary) !important; }
     [data-theme="dark"] .text-gray-600 { color: var(--text-secondary) !important; }
     [data-theme="dark"] .text-gray-500 { color: var(--text-tertiary) !important; }
     [data-theme="dark"] .text-gray-400 { color: var(--text-tertiary) !important; }

     /* Dark mode background overrides */
     [data-theme="dark"] .bg-white { background-color: var(--card-bg) !important; }
     [data-theme="dark"] .bg-gray-50 { background-color: var(--bg-tertiary) !important; }
     [data-theme="dark"] .bg-gray-100 { background-color: var(--btn-secondary-bg) !important; }
     [data-theme="dark"] .bg-gray-200 { background-color: var(--btn-secondary-hover) !important; }

     /* Dark mode border overrides */
     [data-theme="dark"] .border-gray-100 { border-color: var(--border-primary) !important; }
     [data-theme="dark"] .border-gray-200 { border-color: var(--border-secondary) !important; }
     [data-theme="dark"] .border-gray-300 { border-color: var(--border-secondary) !important; }

     /* Ensure all summary stat containers have visible borders in dark mode */
     [data-theme="dark"] .space-y-3 > div:not(.metric-card),
     [data-theme="dark"] .space-y-6 > div:not(.metric-card) {
       border: 1px solid var(--border-primary) !important;
       border-radius: 0.75rem;
       background-color: var(--card-bg) !important;
     }

     /* Dark mode input styles */
     [data-theme="dark"] input[type="text"],
     [data-theme="dark"] input[type="search"] {
       background-color: var(--input-bg) !important;
       border-color: var(--input-border) !important;
       color: var(--text-primary) !important;
     }

     [data-theme="dark"] input[type="text"]:focus,
     [data-theme="dark"] input[type="search"]:focus {
       border-color: var(--input-focus) !important;
       box-shadow: 0 0 0 3px rgba(96, 165, 250, 0.1) !important;
     }

     [data-theme="dark"] input::placeholder {
       color: var(--text-tertiary) !important;
     }

     /* Dark mode table styles */
     [data-theme="dark"] table {
       color: var(--text-primary);
     }

     [data-theme="dark"] thead {
       background-color: var(--bg-tertiary) !important;
     }

     [data-theme="dark"] th {
       color: var(--text-primary) !important;
       border-color: var(--border-secondary) !important;
     }

     [data-theme="dark"] td {
       color: var(--text-secondary) !important;
       border-color: var(--border-primary) !important;
     }

     /* Dark mode button styles */
     [data-theme="dark"] .hover\\:bg-gray-100:hover {
       background-color: var(--btn-secondary-hover) !important;
     }

     [data-theme="dark"] .hover\\:bg-gray-200:hover {
       background-color: var(--border-secondary) !important;
     }

     /* Dark mode gradient overrides */
     [data-theme="dark"] .bg-gradient-to-r.from-blue-50.to-indigo-50 {
       background: var(--gradient-blue) !important;
     }

     [data-theme="dark"] .bg-gradient-to-r.from-slate-50.to-blue-50 {
       background: var(--gradient-slate) !important;
     }

     [data-theme="dark"] .bg-gradient-to-r.from-gray-50.to-slate-100 {
       background: var(--gradient-slate) !important;
     }

     /* Dark mode shadow overrides */
     [data-theme="dark"] .shadow-sm { box-shadow: var(--card-shadow) !important; }
     [data-theme="dark"] .shadow-md { box-shadow: 0 4px 6px var(--shadow-light) !important; }
     [data-theme="dark"] .shadow-lg { box-shadow: 0 10px 15px var(--shadow-medium) !important; }
     [data-theme="dark"] .shadow-xl { box-shadow: 0 20px 25px var(--shadow-heavy) !important; }

     /* Dark mode specific component styles */
     [data-theme="dark"] .bg-slate-100 { 
       background-color: var(--bg-tertiary) !important; 
       color: var(--text-primary) !important;
     }

     /* Dark mode tab button styles */
     [data-theme="dark"] .bg-blue-100 { 
       background-color: rgba(59, 130, 246, 0.2) !important; 
       color: #60a5fa !important;
     }

     [data-theme="dark"] .text-blue-800 { 
       color: #60a5fa !important; 
     }

     /* Dark mode rounded containers */
     [data-theme="dark"] .rounded-xl,
     [data-theme="dark"] .rounded-lg {
       background-color: var(--card-bg);
       border-color: var(--border-primary);
     }

     /* Dark mode search icon */
     [data-theme="dark"] .text-gray-400 {
       color: var(--text-tertiary) !important;
     }

     /* Dark mode hover states for navigation */
     [data-theme="dark"] .hover\\:text-gray-900:hover {
       color: var(--text-primary) !important;
     }

     /* Dark mode for specific metric text colors */
     [data-theme="dark"] .text-blue-600 {
       color: #60a5fa !important;
     }

     [data-theme="dark"] .text-green-600 {
       color: #34d399 !important;
     }

     [data-theme="dark"] .text-red-600 {
       color: #f87171 !important;
     }

     [data-theme="dark"] .text-yellow-600 {
       color: #fbbf24 !important;
     }

     [data-theme="dark"] .text-orange-600 {
       color: #fb923c !important;
     }

     /* Ensure metric containers have proper backgrounds */
     [data-theme="dark"] .bg-gradient-to-r.from-green-50.to-emerald-50 {
       background: var(--keywords-bar-bg) !important;
       border-color: var(--keywords-bar-border) !important;
     }

     [data-theme="dark"] .border-green-200 {
       border-color: rgba(34, 197, 94, 0.3) !important;
     }

     /* Dark mode link and hover styles */
     [data-theme="dark"] a {
       color: #60a5fa !important;
     }

     [data-theme="dark"] a:hover {
       color: #93c5fd !important;
       text-decoration: underline;
     }

     /* Dark mode table row hover - subtle background change */
     [data-theme="dark"] tbody tr:hover {
       background-color: rgba(59, 130, 246, 0.05) !important;
     }

     [data-theme="dark"] tbody tr:hover td {
       color: var(--text-primary) !important;
     }

     /* Dark mode button hover improvements */
     [data-theme="dark"] button:hover {
       background-color: var(--btn-secondary-hover) !important;
       color: var(--text-primary) !important;
     }

     /* Specific styling for tab buttons in dark mode */
     [data-theme="dark"] .space-x-1 button {
       background-color: var(--bg-tertiary) !important;
       color: var(--text-secondary) !important;
       border: 1px solid var(--border-primary) !important;
     }

     [data-theme="dark"] .space-x-1 button:hover {
       background-color: var(--btn-secondary-hover) !important;
       color: var(--text-primary) !important;
     }

     /* Dark mode SummaryStat component styling */
     [data-theme="dark"] .bg-slate-50 {
       background-color: var(--bg-tertiary) !important;
       border: 1px solid var(--border-primary) !important;
     }

     [data-theme="dark"] .hover\\:bg-white:hover {
       background-color: var(--btn-secondary-hover) !important;
     }

     /* Ensure all summary containers have proper dark mode styling */
     [data-theme="dark"] .space-y-3 > div:not(.metric-card),
     [data-theme="dark"] .space-y-6 > div:not(.metric-card) {
       background-color: var(--bg-tertiary) !important;
       border: 1px solid var(--border-primary) !important;
       color: var(--text-primary) !important;
     }

     /* Dark mode for metric cards in summary sections */
     [data-theme="dark"] .p-6.bg-slate-100 {
       background-color: var(--bg-tertiary) !important;
       border: 1px solid var(--border-primary) !important;
       color: var(--text-primary) !important;
     }



     /* Geogrid client color fix for dark mode */
     [data-theme="dark"] .text-blue-900 {
       color: #60a5fa !important;
     }

     /* Fix geogrid client white text in dark mode - specifically for star icons */
     [data-theme="dark"] .text-white.font-bold {
       color: #60a5fa !important;
     }

     /* AI Report and client highlights fix for dark mode */
     [data-theme="dark"] .bg-blue-50 {
       background-color: rgba(59, 130, 246, 0.1) !important;
     }

     [data-theme="dark"] .bg-blue-50\/50 {
       background-color: rgba(59, 130, 246, 0.05) !important;
     }

     [data-theme="dark"] .hover\\:bg-blue-100\/50:hover {
       background-color: rgba(59, 130, 246, 0.1) !important;
     }

     /* Remove white highlight effect in dark mode */
     [data-theme="dark"] .bg-gradient-to-b.from-transparent.to-white {
       background: transparent !important;
     }

     /* AI report gradient fix for dark mode */
     [data-theme="dark"] .bg-gradient-to-t.from-white.to-transparent {
       background: linear-gradient(to top, var(--card-bg), transparent) !important;
     }

     /* Fix ordinal numbers (1st, 2nd, 3rd) to be white in dark mode */
     [data-theme="dark"] .text-blue-600 {
       color: #ffffff !important;
     }

     /* Fix geogrid client highlighting - better targeting with better color */
     [data-theme="dark"] .bg-blue-50 .text-blue-900 {
       color: #fbbf24 !important;
     }

     /* Fix geogrid client background to be more subtle in dark mode */
     [data-theme="dark"] .bg-blue-50 {
       background-color: rgba(251, 191, 36, 0.1) !important;
     }

     /* Fix geogrid client star icons and text in dark mode - more specific targeting */
     [data-theme="dark"] .text-white.font-bold:not(.rounded-full) {
       color: #ffffff !important;
     }

     /* Ensure position badges stay white in dark mode */
     [data-theme="dark"] .rounded-full.text-white {
       color: #ffffff !important;
     }

     /* Force white numerals on service rank badges in light mode */
     :root .rank-badge {
       color: #ffffff !important;
     }

     /* Fix hover effects - prevent text shifting */
     .group:hover * {
       backface-visibility: hidden;
       -webkit-backface-visibility: hidden;
       -moz-backface-visibility: hidden;
     }

     /* Fix Ranking Distribution and Keyword Dynamics columns background in dark mode */
     [data-theme="dark"] .lg\\:grid-cols-3 > div:nth-child(2),
     [data-theme="dark"] .lg\\:grid-cols-3 > div:nth-child(3) {
       background-color: var(--bg-primary) !important;
       padding: 1.5rem;
       border-radius: 0.75rem;
     }





     /* Remove white highlight around competitive analysis section */
     [data-theme="dark"] .bg-gradient-to-r.from-blue-50.to-indigo-50 {
       background: linear-gradient(to right, rgba(59, 130, 246, 0.1), rgba(99, 102, 241, 0.1)) !important;
     }

     /* Fix white borders in Website Stats and other sections */
     [data-theme="dark"] .border-gray-200 {
       border-color: var(--border-primary) !important;
     }

     [data-theme="dark"] .border-gray-300 {
       border-color: var(--border-secondary) !important;
     }

     [data-theme="dark"] .hover\\:border-gray-300:hover {
       border-color: var(--border-secondary) !important;
     }

     /* Tooltip specific hover behavior */
    .info-tooltip-trigger:hover + .info-tooltip-content {
      opacity: 1;
    }
    
    /* Map scroll zoom prevention */
    .map-container {
      position: relative;
      /* Isolate map from parent hover effects */
      isolation: isolate;
      /* Ensure map container maintains its position */
      transform: translateZ(0);
      will-change: auto;
    }
    
    /* Disable pointer events by default to prevent scroll zoom */
    .map-iframe {
      pointer-events: none;
      transition: none;
    }
    
    /* Enable pointer events only when explicitly activated (one click) */
    .map-container.active .map-iframe {
      pointer-events: auto;
    }
    
    /* Prevent hover effects from interfering with map interaction */
    .map-container:hover {
      transform: translateZ(0) !important;
      scale: none !important;
    }
    
    /* Ensure parent card hover effects don't affect map container */
    .group:hover .map-container {
      transform: translateZ(0) !important;
      translate: none !important;
    }
    
    /* Prevent card hover transforms from affecting map interaction */
    [class*="hover:-translate-y"]:hover .map-container {
      transform: translateZ(0) !important;
    }
    
    /* Ensure map container click area remains stable */
    .map-container {
      backface-visibility: hidden;
      -webkit-backface-visibility: hidden;
    }
    
    /* Add a subtle overlay to indicate click-to-interact */
    .map-container::before {
      content: 'Click to interact with map';
      position: absolute;
      top: 10px;
      left: 50px;
      background: rgba(0, 0, 0, 0.7);
      color: white;
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 12px;
      z-index: 10;
      opacity: 0;
      transition: opacity 0.3s ease;
      pointer-events: none;
    }
    
    .map-container:hover::before {
      opacity: 1;
    }
    
    .map-container:active::before {
      opacity: 0;
    }

    /* Completely remove bold effects from chart labels */
    .recharts-label-list text {
        font-weight: 400 !important;
        -webkit-font-smoothing: antialiased !important;
        -moz-osx-font-smoothing: grayscale !important;
        text-rendering: optimizeLegibility !important;
        transform: none !important;
        font-feature-settings: 'liga' 1, 'kern' 1 !important;
    }

    /* Ensure no hover effects make chart labels bold */
    .recharts-wrapper:hover .recharts-label-list text,
    .recharts-wrapper .recharts-label-list text:hover,
    .group:hover .recharts-label-list text {
        font-weight: 400 !important;
    }

    /* Ensure InfoTooltip is always on top of all other elements */
    .group\/tooltip {
        z-index: 999998 !important;
        position: relative !important;
    }
    
    .group\/tooltip:hover {
        z-index: 999999 !important;
    }
    
    /* Force tooltip content to be on top and break out of stacking contexts */
    .group\/tooltip > div:last-child {
        z-index: 999999 !important;
        position: absolute !important;
    }
    
    /* Ensure cards don't interfere with tooltip stacking */
    .group:hover {
        z-index: auto !important;
    }
    
    /* Override specific hover z-index for cards when tooltip is active */
    .group\/tooltip:hover ~ * .group:hover,
    .group\/tooltip:hover ~ .group:hover {
        z-index: 1 !important;
    }

    /* Dark mode status icon backgrounds */
    [data-theme="dark"] .bg-green-100 { 
       background-color: rgba(34, 197, 94, 0.1) !important; 
       color: #22c55e !important;
    }
    [data-theme="dark"] .text-green-600 { color: #22c55e !important; }

    [data-theme="dark"] .bg-yellow-100 { 
       background-color: rgba(234, 179, 8, 0.1) !important; 
       color: #eab308 !important;
    }
    [data-theme="dark"] .text-yellow-600 { color: #eab308 !important; }

    [data-theme="dark"] .bg-red-100 { 
       background-color: rgba(239, 68, 68, 0.1) !important; 
       color: #ef4444 !important;
    }
    [data-theme="dark"] .text-red-600 { color: #ef4444 !important; }

    /* Dark mode rounded containers */
    [data-theme="dark"] .rounded-xl,
    [data-theme="dark"] .rounded-2xl {
      background-color: var(--card-bg);
      border-color: var(--border-primary);
    }

    /* Force technical checks tooltip to appear above everything */
    .technical-checks-card {
      isolation: isolate;
    }
    
    .technical-checks-tooltip {
      position: absolute !important;
      z-index: 999999 !important;
      pointer-events: none !important;
    }
    
    .technical-checks-tooltip.show {
      pointer-events: auto !important;
    }
    
    /* Ensure the tooltip appears above all other elements */
    .technical-checks-card:hover .technical-checks-tooltip {
      z-index: 999999 !important;
    }
    
    /* Advanced tooltip stacking fix */
    .technical-checks-card {
      position: relative;
    }
    
    .technical-checks-card:hover {
      z-index: 999999 !important;
      position: relative !important;
    }
    
    .technical-checks-tooltip {
      position: absolute !important;
      z-index: 999999 !important;
      pointer-events: none !important;
    }
    
    .technical-checks-tooltip.show {
      pointer-events: auto !important;
    }
    
    /* Force all other cards to lower z-index when technical checks is hovered */
    .technical-checks-card:hover ~ * {
      z-index: 1 !important;
    }

    /* Prevent table row hover from affecting icon colors */
    tbody tr:hover .text-green-500,
    tbody tr:hover .text-green-500 * {
      color: #22c55e !important;
      stroke: #22c55e !important;
    }
    
    tbody tr:hover .text-red-500,
    tbody tr:hover .text-red-500 * {
      color: #ef4444 !important;
      stroke: #ef4444 !important;
    }
    
    /* Ensure icons maintain their colors on any hover state */
    .text-green-500,
    .text-green-500 * {
      color: #22c55e !important;
      stroke: #22c55e !important;
    }
    
    .text-red-500,
    .text-red-500 * {
      color: #ef4444 !important;
      stroke: #ef4444 !important;
    }

    /* Dark mode styling for redesigned summary cards */
    [data-theme="dark"] .bg-white.rounded-xl.shadow-sm.border.border-gray-200 {
      background-color: var(--bg-secondary) !important;
      border-color: var(--border-primary) !important;
    }
    
    [data-theme="dark"] .bg-gray-50.rounded-lg {
      background-color: var(--bg-tertiary) !important;
    }
    
    /* Fix dark mode spacing for SummaryStat components */
    [data-theme="dark"] .bg-slate-50.rounded-lg {
      background-color: var(--bg-tertiary) !important;
      border: 1px solid var(--border-primary) !important;
      margin-bottom: 2px !important;
    }
    
    /* Remove grey background from Total Active Backlinks card in dark mode */
    [data-theme="dark"] .space-y-6 .p-6.rounded-xl.text-center {
      background-color: transparent !important;
    }
    
    /* Remove grey background from Link Types chart container in dark mode */
    [data-theme="dark"] .bg-gray-50.rounded-lg.p-4 {
      background-color: transparent !important;
    }
    
    [data-theme="dark"] .bg-blue-50,
    [data-theme="dark"] .bg-green-50,
    [data-theme="dark"] .bg-red-50,
    [data-theme="dark"] .bg-yellow-50,
    [data-theme="dark"] .bg-emerald-50 {
      background-color: rgba(59, 130, 246, 0.1) !important;
    }
    
    [data-theme="dark"] .text-gray-700,
    [data-theme="dark"] .text-gray-800 {
      color: var(--text-primary) !important;
    }

    /* Ensure border styling works well in dark mode */
    [data-theme="dark"] .border-gray-200 {
      border-color: var(--border-primary) !important;
    }

    /* Hide white gridlines in Recharts charts (e.g., Link Types) */
    [data-theme="dark"] .recharts-cartesian-grid line {
      stroke: transparent !important;
    }

    /* Fix excessively light divide borders in dark mode tables */
    [data-theme="dark"] .divide-gray-100 > :not([hidden]) ~ :not([hidden]),
    [data-theme="dark"] .divide-gray-200 > :not([hidden]) ~ :not([hidden]) {
      border-color: var(--border-primary) !important;
    }

         /* More subtle geogrid card hover effects in dark mode */
     [data-theme="dark"] .geogrid-card:hover {
       box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06) !important;
       border-color: rgba(148, 163, 184, 0.3) !important;
       transform: none !important;
     }

    /* Fix tooltip visibility in AI report sections without affecting text overflow */
    .ai-report-section .info-tooltip-content {
      z-index: 999999 !important;
      position: fixed !important;
    }
         .ai-report-section .info-tooltip-trigger {
       position: relative !important;
       z-index: 999998 !important;
     }

     /* Ensure service card tooltips appear above AI report sections */
     .service-card .info-tooltip-content,
     .service-card .info-tooltip-trigger .info-tooltip-content {
       z-index: 1000000 !important;
       position: fixed !important;
     }
     
     .service-card .info-tooltip-trigger {
       position: relative !important;
       z-index: 999999 !important;
     }

     /* Restore original service card hover styling */
     .service-row-hover:hover {
       background-color: #F8FAFC !important;
     }
     
     [data-theme="dark"] .service-row-hover:hover {
       background-color: #1F2E45 !important;
     }

     /* Force avg score text color in light and dark modes */
     .avg-score-text {
       color: #1f2937 !important;
     }
     
     [data-theme="dark"] .avg-score-text {
       color: #ffffff !important;
     }

     /* Dark mode styling for geogrid cards */
     [data-theme="dark"] .geogrid-card {
       background-color: transparent !important;
       border: 1px solid var(--border-primary) !important;
     }
     
     [data-theme="dark"] .geogrid-card .bg-gradient-to-br {
       display: none !important;
     }

     /* Competitor table header styling */
     .competitor-table-header {
       background-color: #F9FAFB;
       border-top: 1px solid #e5e7eb;
     }
     
     [data-theme="dark"] .competitor-table-header {
       background-color: #334155 !important;
       border-top: 1px solid #475569 !important;
     }

         /* Dark mode support for new metric cards */
    [data-theme="dark"] .bg-green-100 {
      background-color: rgba(34, 197, 94, 0.1) !important;
    }

    /* Hide cursor lines on AI sentiment charts */
    .recharts-cursor {
      display: none !important;
    }
    
    .recharts-active-dot {
      display: none !important;
    }

    /* Allow bubbles to overflow chart boundaries */
    .bubble-chart-container {
      overflow: visible !important;
    }
    
    .bubble-chart-container .recharts-wrapper {
      overflow: visible !important;
    }
    
    .bubble-chart-container .recharts-surface {
      overflow: visible !important;
    }
    
    /* Dark mode chart styling */
    [data-theme="dark"] .bubble-chart-container .recharts-cartesian-grid-horizontal line,
    [data-theme="dark"] .bubble-chart-container .recharts-cartesian-grid-vertical line {
      stroke: #4b5563 !important;
    }
    
    [data-theme="dark"] .bubble-chart-container .recharts-cartesian-axis-tick-value {
      fill: #9ca3af !important;
    }
     [data-theme="dark"] .bg-blue-100 {
       background-color: rgba(59, 130, 246, 0.1) !important;
     }
     [data-theme="dark"] .bg-purple-100 {
       background-color: rgba(147, 51, 234, 0.1) !important;
     }
     [data-theme="dark"] .bg-orange-100 {
       background-color: rgba(249, 115, 22, 0.1) !important;
     }
     [data-theme="dark"] .group:hover .bg-green-100 {
       background-color: rgba(34, 197, 94, 0.15) !important;
     }
     [data-theme="dark"] .group:hover .bg-blue-100 {
       background-color: rgba(59, 130, 246, 0.15) !important;
     }
     [data-theme="dark"] .group:hover .bg-purple-100 {
       background-color: rgba(147, 51, 234, 0.15) !important;
     }
     [data-theme="dark"] .group:hover .bg-orange-100 {
       background-color: rgba(249, 115, 22, 0.15) !important;
     }
     [data-theme="dark"] .text-green-600 { color: #22c55e !important; }
     [data-theme="dark"] .text-blue-600 { color: #3b82f6 !important; }
     [data-theme="dark"] .text-purple-600 { color: #9333ea !important; }
     [data-theme="dark"] .text-orange-600 { color: #f97316 !important; }

     /* Fix AI Visibility vs Sentiment button styling - the dark: prefixes don't work with data-theme system */
     [data-theme="dark"] .text-black { color: var(--text-primary) !important; }
     [data-theme="dark"] .hover\\:text-black:hover { color: var(--text-primary) !important; }
     [data-theme="dark"] .hover\\:bg-gray-50:hover { background-color: var(--btn-secondary-hover) !important; }
     
     /* Dual Reports Component - Comprehensive styling for light/dark modes */
     
     /* Header container styling */
     .dual-reports-header {
       background-color: #f8fafc !important; /* Light gray background */
     }
     [data-theme="dark"] .dual-reports-header {
       background-color: #1e293b !important; /* Dark slate background */
     }
     
     /* Content area styling */
     .dual-reports-content {
       background-color: white !important;
     }
     [data-theme="dark"] .dual-reports-content {
       background-color: var(--card-bg) !important;
     }

     /* Inactive tab styling - white background, black text */
     .dual-reports-tab-inactive {
       background-color: white !important;
       color: #374151 !important; /* Dark gray text */
       box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05) !important;
     }
     [data-theme="dark"] .dual-reports-tab-inactive {
       background-color: var(--card-bg) !important;
       color: #d1d5db !important; /* Light gray text for dark mode */
       box-shadow: 0 1px 2px rgba(0, 0, 0, 0.2) !important;
     }

     /* Active tab backgrounds - Competitor Analysis (Blue) */
     .dual-reports-active-blue {
       background-color: #eff5ff !important; /* Light blue fill */
       color: #3b82f6 !important; /* Better blue color */
       box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1) !important;
     }
     [data-theme="dark"] .dual-reports-active-blue {
       background-color: #23314e !important; /* Dark blue fill */
       color: #3b82f6 !important; /* Same blue for consistency */
       box-shadow: 0 2px 4px rgba(0, 0, 0, 0.3) !important;
     }

     /* Active tab backgrounds - Error Report (Red) */
     .dual-reports-active-red {
       background-color: #fef2f2 !important; /* Light red fill */
       color: #dc2626 !important;
       box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1) !important;
     }
     [data-theme="dark"] .dual-reports-active-red {
       background-color: #332C3C !important; /* Custom purple-tinted fill */
       color: #f87171 !important; /* Lighter red for dark mode */
       box-shadow: 0 2px 4px rgba(0, 0, 0, 0.3) !important;
     }

     /* Active tab backgrounds - Keywords Report (Green) */
     .dual-reports-active-green {
       background-color: #EEFDF5 !important; /* Light green fill */
       color: #059669 !important; /* Green text */
       box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1) !important;
     }
     [data-theme="dark"] .dual-reports-active-green {
       background-color: #204449 !important; /* Dark green fill */
       color: #10b981 !important; /* Brighter green for dark mode */
       box-shadow: 0 2px 4px rgba(0, 0, 0, 0.3) !important;
     }

     /* Subtle hover effects */
     .dual-reports-tab-inactive:hover,
     .dual-reports-active-blue:hover,
     .dual-reports-active-red:hover,
     .dual-reports-active-green:hover {
       opacity: 0.9;
     }
     
     /* Fix text content styling */
     .dual-reports-text {
       color: #374151 !important; /* Dark gray for light mode */
     }
     [data-theme="dark"] .dual-reports-text {
       color: #d1d5db !important; /* Light gray for dark mode */
     }
     
     /* Fix gradient fade for light/dark modes */
     .dual-reports-fade-light {
       background: linear-gradient(to top, white, transparent) !important;
     }
     [data-theme="dark"] .dual-reports-fade-light {
       background: linear-gradient(to top, var(--card-bg), transparent) !important;
     }
     
     /* Show more button styling */
     .dual-reports-show-more {
       color: #6b7280 !important;
     }
     [data-theme="dark"] .dual-reports-show-more {
       color: #9ca3af !important;
     }
     
     .dual-reports-show-more:hover {
       background-color: #f3f4f6 !important;
     }
     [data-theme="dark"] .dual-reports-show-more:hover {
       background-color: #374151 !important;
     }

     /* Action button dark mode styling */
     [data-theme="dark"] .dual-reports-action-hover {
       color: #9ca3af !important;
     }
     [data-theme="dark"] .dual-reports-action-hover:hover {
       background-color: rgba(75, 85, 99, 0.8) !important;
       color: #d1d5db !important;
     }
  </style>
  
  <!-- Non-critical CSS loaded after page load -->
  <style id="non-critical-css">
    /* Tooltip specific hover behavior */
    .info-tooltip-trigger:hover + .info-tooltip-content {
      opacity: 1;
    }
    
    /* Map scroll zoom prevention */
    .map-container {
      position: relative;
      /* Isolate map from parent hover effects */
      isolation: isolate;
      /* Ensure map container maintains its position */
      transform: translateZ(0);
      will-change: auto;
    }
    
    /* Disable pointer events by default to prevent scroll zoom */
    .map-iframe {
      pointer-events: none;
      transition: none;
    }
    
    /* Enable pointer events when clicked or after first click */
    .map-container.active .map-iframe,
    .map-container:active .map-iframe {
      pointer-events: auto;
    }
    
    /* Prevent hover effects from interfering with map interaction */
    .map-container:hover {
      transform: translateZ(0) !important;
      scale: none !important;
    }
    
    /* Ensure parent card hover effects don't affect map container */
    .group:hover .map-container {
      transform: translateZ(0) !important;
      translate: none !important;
    }
    
    /* Prevent card hover transforms from affecting map interaction */
    [class*="hover:-translate-y"]:hover .map-container {
      transform: translateZ(0) !important;
    }
    
    /* Add a subtle overlay to indicate click-to-interact */
    .map-container::before {
      content: 'Click to interact with map';
      position: absolute;
      top: 10px;
      left: 50px;
      background: rgba(0, 0, 0, 0.7);
      color: white;
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 12px;
      z-index: 10;
      opacity: 0;
      transition: opacity 0.3s ease;
      pointer-events: none;
    }
    
    .map-container:hover::before {
      opacity: 1;
    }
    
    .map-container:active::before {
      opacity: 0;
    }

    /* Tone down chart label boldness on hover */
    .recharts-label-list text {
        font-weight: 500 !important;
        -webkit-font-smoothing: antialiased !important;
        -moz-osx-font-smoothing: grayscale !important;
        text-rendering: optimizeLegibility !important;
    }

    /* Bubble tooltip (AI Visibility vs Sentiment) dark-mode cleanup */
    [data-theme="dark"] .ai-bubble-tooltip .dark\:bg-transparent {
      background: transparent !important;
    }
    [data-theme="dark"] .ai-bubble-tooltip .dark\:border {
      border-color: #374151 !important; /* gray-700 */
    }
    
    /* AI Visibility vs Sentiment tooltip: remove row gray backgrounds in dark mode */
    [data-theme="dark"] .ai-bubble-tooltip .tooltip-header { background: transparent !important; }
    [data-theme="dark"] .ai-bubble-tooltip .space-y-3 > div { background: transparent !important; border: none !important; }
    [data-theme="dark"] .ai-bubble-tooltip .space-y-3 > div * { background: transparent !important; }
  </style>

  <!-- Enhanced preconnect to CDNs and APIs for faster loading -->
  <link rel="preconnect" href="https://unpkg.com" crossorigin>
  <link rel="preconnect" href="https://script.google.com" crossorigin>
  <link rel="dns-prefetch" href="https://unpkg.com">
  <link rel="dns-prefetch" href="https://script.google.com">
  <link rel="prefetch" href="https://unpkg.com/react@18/umd/react.production.min.js">
  <link rel="prefetch" href="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js">
  
  <!-- React / Babel / Recharts with optimized loading -->
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone@7.23.1/babel.min.js"></script>
  <script src="https://unpkg.com/prop-types@15/prop-types.min.js"></script>
  
  <!-- Recharts - using older stable version -->
  <script src="https://unpkg.com/recharts@1.8.5/umd/Recharts.js"></script>
</head>

<body class="bg-gray-50">
  <div id="root">
    <div class="loader-container">
      <div class="loader"></div>
      <p class="text-gray-500 mt-4">Loading application…</p>
      <div class="mt-6 text-xs text-gray-400">
        <div id="load-progress">Initializing...</div>
      </div>
    </div>
  </div>

<script type="text/babel">
/* ------------------------------------------------------------------ */
/* shared helpers / icons / generic components                        */
/* ------------------------------------------------------------------ */

// Optimized Skeleton Loading Component
const DashboardSkeleton = React.memo(() => {
    return (
        <PageContent>
            <div className="grid grid-cols-12 gap-6">
                {/* Geogrid Section Skeleton - Left side large map */}
                <Card className="col-span-12 lg:col-span-8">
                    <div className="animate-pulse">
                        <div className="flex justify-between items-center mb-4">
                            <div className="h-6 bg-gray-200 rounded w-48"></div>
                            <div className="h-8 bg-gray-200 rounded w-24"></div>
                        </div>
                        <div className="h-[400px] bg-gray-200 rounded-lg mb-4"></div>
                        <div className="grid grid-cols-4 gap-4">
                            {[...Array(4)].map((_, i) => (
                                <div key={i} className="text-center">
                                    <div className="h-8 bg-gray-200 rounded mb-2"></div>
                                    <div className="h-4 bg-gray-100 rounded"></div>
                                </div>
                            ))}
                        </div>
                    </div>
                </Card>

                {/* Census Info Skeleton - Right side */}
                <Card className="col-span-12 lg:col-span-4">
                    <div className="animate-pulse">
                        <div className="h-6 bg-gray-200 rounded w-32 mb-4"></div>
                        <div className="space-y-4">
                            {[...Array(6)].map((_, i) => (
                                <div key={i} className="flex justify-between items-center">
                                    <div className="h-4 bg-gray-200 rounded w-24"></div>
                                    <div className="h-4 bg-gray-100 rounded w-16"></div>
                                </div>
                            ))}
                        </div>
                    </div>
                </Card>

                {/* Service Cards Skeleton */}
                {[...Array(2)].map((_, i) => (
                    <Card key={i} className="col-span-12 md:col-span-6">
                        <div className="animate-pulse">
                            <div className="flex justify-between items-start mb-4">
                                <div className="h-6 bg-gray-200 rounded w-48"></div>
                                <div className="h-8 bg-gray-200 rounded w-20"></div>
                            </div>
                            <div className="space-y-3">
                                {[...Array(5)].map((_, j) => (
                                    <div key={j} className="flex justify-between items-center p-3 bg-gray-50 rounded">
                                        <div className="h-4 bg-gray-200 rounded w-32"></div>
                                        <div className="h-4 bg-gray-100 rounded w-16"></div>
                                    </div>
                                ))}
                            </div>
                        </div>
                    </Card>
                ))}

                {/* AI Sentiment Bubble Chart Skeleton */}
                <Card className="col-span-12 md:col-span-7">
                    <div className="animate-pulse">
                        <div className="flex justify-between items-center mb-4">
                            <div className="h-6 bg-gray-200 rounded w-56"></div>
                            <div className="flex space-x-2">
                                {[...Array(3)].map((_, i) => (
                                    <div key={i} className="h-8 bg-gray-200 rounded w-20"></div>
                                ))}
                            </div>
                        </div>
                        <div className="h-[300px] bg-gray-200 rounded-lg"></div>
                    </div>
                </Card>

                {/* Right Column - AI Bar Chart + Mini Stats */}
                <div className="col-span-12 md:col-span-5 flex flex-col space-y-4">
                    {/* AI Bar Chart Skeleton */}
                    <Card className="flex-1">
                        <div className="animate-pulse">
                            <div className="h-6 bg-gray-200 rounded w-40 mb-4"></div>
                            <div className="h-[180px] bg-gray-200 rounded-lg"></div>
                        </div>
                    </Card>
                    
                    {/* Mini Stats Grid */}
                    <div className="grid grid-cols-2 gap-4">
                        {[...Array(4)].map((_, i) => (
                            <Card key={i} className="p-4">
                                <div className="animate-pulse text-center">
                                    <div className="h-8 bg-gray-200 rounded w-12 mx-auto mb-2"></div>
                                    <div className="h-3 bg-gray-100 rounded w-16 mx-auto"></div>
                                </div>
                            </Card>
                        ))}
                    </div>
                </div>

                {/* Overview Table Skeleton */}
                <Card className="col-span-12">
                    <div className="animate-pulse">
                        <div className="flex justify-between items-center mb-4">
                            <div className="h-6 bg-gray-200 rounded w-40"></div>
                            <div className="h-8 bg-gray-200 rounded w-24"></div>
                        </div>
                        <div className="overflow-x-auto">
                            <div className="min-w-full">
                                {/* Table Header */}
                                <div className="grid grid-cols-6 gap-4 p-4 border-b">
                                    {[...Array(6)].map((_, i) => (
                                        <div key={i} className="h-4 bg-gray-200 rounded"></div>
                                    ))}
                                </div>
                                {/* Table Rows */}
                                {[...Array(5)].map((_, i) => (
                                    <div key={i} className="grid grid-cols-6 gap-4 p-4 border-b">
                                        {[...Array(6)].map((_, j) => (
                                            <div key={j} className="h-4 bg-gray-100 rounded"></div>
                                        ))}
                                    </div>
                                ))}
                            </div>
                        </div>
                    </div>
                </Card>
            </div>
        </PageContent>
    );
});
const {useState, useEffect, useRef, useMemo, useCallback} = React;
// React.memo will be used directly

// --- Iframe detection and session management ---
const isRunningInIframe = () => {
    try {
        return window.self !== window.top;
    } catch (e) {
        // If we can't access window.top due to cross-origin, we're likely in an iframe
        return true;
    }
};

const getIframeAdjustedCacheTime = () => {
    // Shorter cache time in iframe to handle session timeouts better
    return isRunningInIframe() ? 5 * 60 * 1000 : 10 * 60 * 1000; // 5min vs 10min
};

// --- Google Apps Script Test Function (for debugging) ---
window.testGoogleAppsScript = (workbookId) => {
    const testUrl = `https://script.google.com/macros/s/AKfycbxfOMp8d_eCVH4lFD0PNuFU1wH-gyWOwRt2EuME7GQJ4U73ZwpPDciohDH3C566YLWq/exec?workbookId=${workbookId || '1bDx2KvIbM_fnLWZODBtiNGeJRSC777_QmqoHdblCYqk'}&sections=dashboard`;
    
    console.log('🧪 Testing Google Apps Script directly...');
    console.log('📍 Test URL:', testUrl);
    
    // Test 1: Try a simple JSONP request
    const script = document.createElement('script');
    const callbackName = 'testCallback_' + Date.now();
    
    window[callbackName] = (data) => {
        console.log('✅ JSONP Test Success! Data received:', data);
        document.head.removeChild(script);
        delete window[callbackName];
    };
    
    script.onerror = (e) => {
        console.error('❌ JSONP Test Failed:', e);
        document.head.removeChild(script);
        delete window[callbackName];
    };
    
    script.src = `${testUrl}&callback=${callbackName}`;
    document.head.appendChild(script);
    
    // Test 2: Try opening the URL directly
    console.log('🔗 Try opening this URL directly in a new tab to test:', testUrl);
    
    return testUrl;
};

// --- Check if Google Apps Script needs redeployment ---
window.checkScriptDeployment = () => {
    console.log('🔧 Google Apps Script Deployment Status:');
    console.log('');
    console.log('✅ JSONP support has been added and deployed');
    console.log('✅ Permissions are correctly set to "Anyone"');
    console.log('✅ Direct script access is working');
    console.log('');
    console.log('🔍 Current issue: Iframe vs Direct Access difference');
    console.log('📋 Next steps:');
    console.log('   1. Wait 5-10 minutes for full propagation');
    console.log('   2. Run: testJSONPInIframe() to test from iframe context');
    console.log('   3. Check if there are any remaining CORS/iframe restrictions');
    console.log('');
    console.log('💡 The script is working - this may be an iframe-specific delay or caching issue');
};

// --- Test JSONP specifically in iframe context ---
window.testJSONPInIframe = () => {
    console.log('🧪 Testing JSONP in current context (iframe vs direct)...');
    console.log('🖼️ In iframe:', isRunningInIframe());
    
    const workbookId = '1bDx2KvIbM_fnLWZODBtiNGeJRSC777_QmqoHdblCYqk';
    const testUrl = `https://script.google.com/macros/s/AKfycbxfOMp8d_eCVH4lFD0PNuFU1wH-gyWOwRt2EuME7GQJ4U73ZwpPDciohDH3C566YLWq/exec?workbookId=${workbookId}&sections=dashboard`;
    
    fetchWithCorsWorkaround(testUrl, (err, data) => {
        if (err) {
            console.error('❌ JSONP test failed in current context:', err);
            console.log('🔄 This suggests iframe-specific restrictions or propagation delay');
            console.log('⏰ Try again in 5-10 minutes');
        } else {
            console.log('✅ JSONP test succeeded in current context!');
            console.log('📊 Data keys received:', Object.keys(data || {}));
            console.log('🎉 The iframe issue should be resolved now!');
        }
    });
};

// --- Clear all SEO app cache (for troubleshooting) ---
window.clearSEOCache = () => {
    console.log('🧹 Clearing all SEO app cache...');
    let clearedCount = 0;
    
    // Clear all sessionStorage keys that start with 'seo_data_'
    Object.keys(sessionStorage).forEach(key => {
        if (key.startsWith('seo_data_') || key.includes('dashboard_data_') || key.includes('services_') || key.includes('keywords_') || key.includes('backlinks_') || key.includes('geogrid_')) {
            sessionStorage.removeItem(key);
            clearedCount++;
            console.log('🗑️ Cleared:', key);
        }
    });
    
    console.log(`✅ Cleared ${clearedCount} cache entries`);
    console.log('🔄 Now refresh the page or wait for automatic data reload');
};

// --- Enhanced Helper function with improved caching and iframe support ---
const fetchWithCorsWorkaround = (url, callback, retryCount = 0) => {
    // Check cache first (iframe-adjusted cache time)
    const cacheKey = `seo_data_${btoa(url).slice(0, 32)}`; // Shorter cache keys
    const cached = sessionStorage.getItem(cacheKey);
    if (cached) {
        try {
        const { data, timestamp } = JSON.parse(cached);
            if (Date.now() - timestamp < getIframeAdjustedCacheTime()) {
                console.log('📦 Using cached data for:', url.slice(0, 50) + '...');
                // Use setTimeout to avoid blocking UI
                setTimeout(() => callback(null, data), 0);
            return;
            }
        } catch (e) {
            // Clear corrupted cache
            sessionStorage.removeItem(cacheKey);
        }
    }
    
    // Detect if we're in an iframe
    const isInIframe = isRunningInIframe();

    // If calling Google Apps Script web app, prefer JSONP immediately to avoid CORS entirely
    const isGoogleAppsScript = /https?:\/\/script\.google\.com\/macros\//i.test(url);
    if (isInIframe || isGoogleAppsScript) {
        console.log('🖼️ Iframe detected, using JSONP for:', url.slice(0, 50) + '...');
        tryJsonpRequest();
        return;
    }
    
    // Try regular fetch with extended timeout for iframe contexts
    const controller = new AbortController();
    const timeoutId = setTimeout(() => controller.abort(), isInIframe ? 30000 : 15000);
    
    fetch(url, {
        method: 'GET',
        mode: 'cors',
        credentials: 'omit', // Avoid cookie issues in iframe
        signal: controller.signal
        // IMPORTANT: Do not set non-simple headers here (like Cache-Control),
        // as that would trigger a CORS preflight which Apps Script does not allow.
    })
    .then(response => {
        clearTimeout(timeoutId);
        if (!response.ok) throw new Error(`HTTP ${response.status}`);
        return response.json();
    })
    .then(data => {
        // Cache the response
        try {
        sessionStorage.setItem(cacheKey, JSON.stringify({
            data,
            timestamp: Date.now()
        }));
        } catch (e) {
            // Ignore cache storage errors
        }
        callback(null, data);
    })
    .catch(err => {
        clearTimeout(timeoutId);
        console.log('Regular fetch failed, trying JSONP-style request...');
        tryJsonpRequest();
    });
    
    function tryJsonpRequest() {
        const script = document.createElement('script');
        const callbackName = 'jsonpCallback_' + Math.random().toString(36).substr(2, 9);
        let hasResponded = false;
        
        console.log(`🔄 Attempting JSONP request with callback: ${callbackName}`);
        
        // Set a timeout for JSONP requests
        const jsonpTimeout = setTimeout(() => {
            if (!hasResponded) {
                hasResponded = true;
                console.error('❌ JSONP request timed out after 30s');
                cleanup();
                
                // Retry logic for timeout
                if (retryCount < 2) {
                    const delay = Math.pow(2, retryCount) * 1000; // 1s, 2s
                    console.log(`🔄 Retrying after timeout in ${delay}ms (attempt ${retryCount + 1}/2)`);
                    setTimeout(() => {
                        fetchWithCorsWorkaround(url, callback, retryCount + 1);
                    }, delay);
                } else {
                    callback(new Error('Request timed out after retries'), null);
                }
            }
        }, 30000);
        
        window[callbackName] = (data) => {
            if (hasResponded) return;
            hasResponded = true;
            clearTimeout(jsonpTimeout);
            
            console.log('✅ JSONP response received:', { 
                hasError: !!data.error, 
                dataKeys: Object.keys(data || {}),
                callbackName 
            });
            
            // Cache the response
            try {
                sessionStorage.setItem(cacheKey, JSON.stringify({
                    data,
                    timestamp: Date.now()
                }));
            } catch (e) {
                console.warn('Cache storage failed:', e);
            }
            
            callback(null, data);
            cleanup();
        };
        
        script.onerror = (event) => {
            if (hasResponded) return;
            hasResponded = true;
            clearTimeout(jsonpTimeout);
            console.error('❌ JSONP script failed to load:', {
                url: script.src,
                callbackName,
                event,
                retryCount
            });
            cleanup();
            
            // Retry logic with exponential backoff (max 2 retries)
            if (retryCount < 2) {
                const delay = Math.pow(2, retryCount) * 1000; // 1s, 2s
                console.log(`🔄 Retrying JSONP request in ${delay}ms (attempt ${retryCount + 1}/2)`);
                setTimeout(() => {
                    fetchWithCorsWorkaround(url, callback, retryCount + 1);
                }, delay);
            } else {
                callback(new Error('Failed to load data after retries'), null);
            }
        };
        
        script.onload = () => {
            console.log('📜 JSONP script loaded successfully');
            // Give a brief moment for callback to execute
            setTimeout(() => {
                if (!hasResponded) {
                    hasResponded = true;
                    clearTimeout(jsonpTimeout);
                    console.error('❌ JSONP script loaded but callback never executed');
                    cleanup();
                    
                    // Retry logic for callback not executed
                    if (retryCount < 2) {
                        const delay = Math.pow(2, retryCount) * 1000; // 1s, 2s
                        console.log(`🔄 Retrying after callback failure in ${delay}ms (attempt ${retryCount + 1}/2)`);
                        setTimeout(() => {
                            fetchWithCorsWorkaround(url, callback, retryCount + 1);
                        }, delay);
                    } else {
                        callback(new Error('Callback not executed after retries'), null);
                    }
                }
            }, 1000);
        };
        
        function cleanup() {
            try {
                if (script.parentNode) {
                    document.head.removeChild(script);
                }
                delete window[callbackName];
            } catch (e) {
                console.warn('Cleanup error:', e);
            }
        }
        
        const separator = url.includes('?') ? '&' : '?';
        const finalUrl = `${url}${separator}callback=${callbackName}`;
        console.log('🚀 Loading JSONP script:', finalUrl);
        
        // Add additional debugging
        script.onabort = () => console.error('❌ JSONP script was aborted');
        script.oncancel = () => console.error('❌ JSONP script was cancelled');
        
        script.src = finalUrl;
        document.head.appendChild(script);
        
        // Removed HEAD probe which could show misleading 403s and isn't needed
    }
};

    // --- Map URL Processing for Better Centering ---
    const processMapUrlForCentering = (mapUrl) => {
        if (!mapUrl) return mapUrl;
        
        try {
            // For Google Maps embed URLs, we can add parameters to improve centering
            if (mapUrl.includes('google.com/maps/embed')) {
                let processedUrl = mapUrl;
                
                // Add zoom parameter if not present - 12 is good for local area with multiple pins
                if (!processedUrl.includes('z=') && !processedUrl.includes('zoom=')) {
                    processedUrl += processedUrl.includes('?') ? '&z=12' : '?z=12';
                }
                
                // Add output parameter to ensure proper embedding
                if (!processedUrl.includes('output=embed')) {
                    processedUrl += processedUrl.includes('?') ? '&output=embed' : '?output=embed';
                }
                
                return processedUrl;
            }
            
            // For other map services, return as-is
            return mapUrl;
        } catch (error) {
            console.warn('Error processing map URL:', error);
            return mapUrl;
        }
    };

    // Simple map activation on click; deactivation on mouseleave is handled via events on containers
    const handleMapActivate = (event) => {
        event.stopPropagation();
        const container = event.currentTarget;
        container.classList.add('active');
        const iframe = container.querySelector('iframe');
        if (iframe) {
            iframe.style.pointerEvents = 'auto';
            iframe.style.transition = 'none';
        }
    };

    const handleMapDeactivate = (event) => {
        const container = event.currentTarget;
        container.classList.remove('active');
                const iframe = container.querySelector('iframe');
                if (iframe) {
            iframe.style.pointerEvents = 'none';
        }
    };

/* ------------------------------------------------------------------ */
/* helpers  – icon factory  +  shared icons                           */
/* ------------------------------------------------------------------ */
const createIcon = path => props => (
  <svg
    xmlns="http://www.w3.org/2000/svg"
    width="24"
    height="24"
    viewBox="0 0 24 24"
    fill="none"
    stroke="currentColor"
    strokeWidth="2"
    strokeLinecap="round"
    strokeLinejoin="round"
    {...props}
  >
    {path}
  </svg>
);

/* reusable icons --------------------------------------------------- */
const Info = createIcon(
  <>
    <circle cx="12" cy="12" r="10" />
    <line  x1="12" y1="16" x2="12" y2="12" />
    <line  x1="12" y1="8"  x2="12.01" y2="8" />
  </>
);

const AlertTriangle = createIcon(
  <>
    <path d="m21.73 18-8-14a2 2 0 0 0-3.46 0l-8 14A2 2 0 0 0 4 21h16a2 2 0 0 0 1.73-3Z" />
    <line x1="12" y1="9"  x2="12" y2="13" />
    <line x1="12" y1="17" x2="12.01" y2="17" />
  </>
);

const Star = createIcon(
  <polygon points="12 2 15 8.5 22 9.3 17 14 18.3 21 12 17.7 5.7 21 7 14 2 9.3 9 8.5 12 2" />
);

const ArrowUp = createIcon(
  <>
    <line x1="12" y1="19" x2="12" y2="5" />
    <polyline points="5 12 12 5 19 12" />
  </>
);

const ArrowDown = createIcon(
  <>
    <line x1="12" y1="5"  x2="12" y2="19" />
    <polyline points="19 12 12 19 5 12" />
  </>
);

const CheckCircle  = createIcon(
  <>
    <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14" />
    <polyline points="22 4 12 14.01 9 11.01" />
  </>
);
const XCircle = createIcon(
  <>
    <circle cx="12" cy="12" r="10" />
    <line x1="15" y1="9" x2="9" y2="15" />
    <line x1="9" y1="9" x2="15" y2="15" />
  </>
);
const TrendingUp = createIcon(<polyline points="23 6 13.5 15.5 8.5 10.5 1 18" />);
const Link2 = createIcon(
  <>
    <path d="M9 17H7A5 5 0 0 1 7 7h2" />
    <path d="M15 7h2a5 5 0 0 1 0 10h-2" />
    <line x1="8" y1="12" x2="16" y2="12" />
  </>
);
const ShieldCheck = createIcon(
  <>
    <path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z" />
    <path d="m9 12 2 2 4-4" />
  </>
);

const CalendarIcon = createIcon(
    <React.Fragment>
        <rect x="3" y="4" width="18" height="18" rx="2" ry="2" />
        <line x1="16" y1="2" x2="16" y2="6" />
        <line x1="8" y1="2" x2="8" y2="6" />
        <line x1="3" y1="10" x2="21" y2="10" />
    </React.Fragment>
);

/* --- generic wrappers --- */
const Card        = ({children,className=''}) => (
  <div className={`rounded-xl p-6 ${className}`} style={{ backgroundColor: 'var(--card-bg)', border: '1px solid var(--card-border)', boxShadow: 'var(--card-shadow)' }}>{children}</div>);
const PageContent = ({children}) => (
  <main className="flex-1 p-4 sm:p-6 lg:p-8">{children}</main>);

// --- Reusable Components ---
const InfoTooltip = ({ text }) => (
    <div className="relative flex items-center group/tooltip">
        <Info className="w-4 h-4 text-gray-400" />
        <div className="absolute left-1/2 -translate-x-1/2 bottom-full mb-2 w-64 p-3 bg-gray-800 text-white text-xs rounded-lg shadow-2xl opacity-0 group-hover/tooltip:opacity-100 transition-opacity duration-300 pointer-events-none" style={{ zIndex: 999999 }}>
            {text}
            <svg className="absolute text-gray-800 h-2 w-full left-0 top-full" x="0px" y="0px" viewBox="0 0 255 255"><polygon className="fill-current" points="0,0 127.5,127.5 255,0"/></svg>
        </div>
    </div>
);

/* ------------------------------------------------------------------ */
// Minimal Sun/Moon Toggle Button for Dark/Light Mode
const ThemeToggleButton = ({ isLight, onToggle }) => {
  const iconColor = isLight ? '#6b7280' : '#cbd5e1';
  const gradientId = 'theme-toggle-gradient';
  return (
    <button
      onClick={() => onToggle(!isLight)}
      aria-label={`Switch to ${isLight ? 'dark' : 'light'} mode`}
      className={`transition-all duration-200 w-7 h-7 flex items-center justify-center rounded-full border focus:outline-none focus:ring-2 focus:ring-blue-400
        ${isLight ? 'bg-white border-gray-200' : 'bg-gray-800 border-gray-600'}
        relative overflow-hidden group`}
      style={{ outline: 'none', boxShadow: '0 1px 2px rgba(0,0,0,0.04)' }}
      tabIndex={0}
      onKeyDown={e => {
        if (e.key === 'Enter' || e.key === ' ') {
          e.preventDefault();
          onToggle(!isLight);
        }
      }}
    >
      <svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke={`url(#${gradientId})`} strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="transition-colors duration-200">
        <defs>
          <linearGradient id={gradientId} x1="0%" y1="0%" x2="100%" y2="0%" gradientUnits="userSpaceOnUse">
            <stop offset="0%" stopColor="#3b82f6"/>
            <stop offset="100%" stopColor="#ec4899"/>
          </linearGradient>
        </defs>
        {isLight ? (
          <g>
            <circle cx="12" cy="12" r="5" fill="none" className="icon-main-ray" />
            <line className="icon-main-ray" x1="12" y1="1" x2="12" y2="3" />
            <line className="icon-main-ray" x1="12" y1="21" x2="12" y2="23" />
            <line className="icon-main-ray" x1="4.22" y1="4.22" x2="5.64" y2="5.64" />
            <line className="icon-main-ray" x1="18.36" y1="18.36" x2="19.78" y2="19.78" />
            <line className="icon-main-ray" x1="1" y1="12" x2="3" y2="12" />
            <line className="icon-main-ray" x1="21" y1="12" x2="23" y2="12" />
            <line className="icon-main-ray" x1="4.22" y1="19.78" x2="5.64" y2="18.36" />
            <line className="icon-main-ray" x1="18.36" y1="5.64" x2="19.78" y2="4.22" />
          </g>
        ) : (
          <path d="M21 12.79A9 9 0 1111.21 3a7 7 0 109.79 9.79z" fill="none" className="icon-main-ray" />
        )}
      </svg>
      <style>{`
        .group:hover .icon-main-ray, .group:hover svg {
          stroke: ${iconColor} !important;
        }
      `}</style>
    </button>
  );
};

/* ------------------------------------------------------------------ */
/* PLACEHOLDER PAGES – replace each later with real JSX               */
/* ------------------------------------------------------------------ */

/* ------------------------------------------------------------------ */
/* AI Report Section (used on multiple pages)                         */
/* ------------------------------------------------------------------ */
const AIReportSection = ({ reportText, title = "SWOT Analysis" }) => {
    const [isExpanded, setIsExpanded] = useState(false);
    const [copySuccess, setCopySuccess] = useState(false);
    
    console.log('AIReportSection received reportText:', reportText);
    console.log('Type of reportText:', typeof reportText);
    
    // More robust type checking and conversion
    let formattedText = '';
    try {
        if (!reportText) {
            console.log('reportText is empty');
            return null;
        }
        
        // Convert to string if it's not already a string
        formattedText = String(reportText).trim();
        console.log('Converted formattedText:', formattedText);
        
        if (!formattedText) {
            console.log('formattedText is empty after trimming');
            return null;
        }
    } catch (error) {
        console.error('Error processing reportText:', error);
        return null;
    }

    const ChevronDown = createIcon(<polyline points="6 9 12 15 18 9" />);
    const ChevronUp = createIcon(<polyline points="18 15 12 9 6 15" />);
    const Copy = createIcon(
        <>
            <rect x="9" y="9" width="13" height="13" rx="2" ry="2" />
            <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1" />
        </>
    );
    const Check = createIcon(<polyline points="20 6 9 17 4 12" />);

    const handleCopyReport = async () => {
        try {
            // Get plain text version of the report
            const plainText = formattedText
                .replace(/<br\s*\/?>/gi, '\n')
                .replace(/<strong>(.*?)<\/strong>/gi, '**$1**')
                .replace(/<em>(.*?)<\/em>/gi, '*$1*')
                .replace(/<[^>]*>/g, ''); // Remove any remaining HTML tags
            
            await navigator.clipboard.writeText(plainText);
            setCopySuccess(true);
            setTimeout(() => setCopySuccess(false), 2000);
        } catch (err) {
            console.error('Failed to copy text: ', err);
        }
    };

    return (
                        <Card className="mt-8 group hover:shadow-xl transition-all duration-300 hover:-translate-y-0.5 hover:border-blue-200/60 ai-report-section">
            <div className="flex items-center justify-between mb-1">
                <div className="flex items-center space-x-2">
                    <h2 className="text-xl font-bold text-gray-800">AI Report</h2>
                    <InfoTooltip text="AI-generated analysis of your website's technical health, performance metrics, and competitive positioning." />
                    <button 
                        onClick={() => setIsExpanded(!isExpanded)} 
                        className="text-blue-600 hover:text-blue-800 text-sm font-semibold flex items-center transition-colors dark:text-blue-400 dark:hover:text-blue-300"
                    >
                        {isExpanded ? 'Show Less' : 'Show More'}
                        {isExpanded ? <ChevronUp className="w-4 h-4 ml-1" /> : <ChevronDown className="w-4 h-4 ml-1" />}
                    </button>
                </div>
                <div className="flex items-center">
                    <button 
                        onClick={handleCopyReport}
                        className="flex items-center space-x-1 px-3 py-1.5 bg-gray-100 hover:bg-gray-200 text-gray-700 text-sm font-medium rounded-lg transition-colors"
                    >
                        {copySuccess ? (
                            <>
                                <Check className="w-4 h-4 text-green-600" />
                                <span className="text-green-600">Copied!</span>
                            </>
                        ) : (
                            <>
                                <Copy className="w-4 h-4" />
                                <span>Copy Report</span>
                            </>
                        )}
                    </button>
                </div>
            </div>
            <h3 className="text-md font-semibold text-gray-600 mb-3">{title}</h3>
            <div className={`prose prose-sm max-w-none text-gray-600 overflow-hidden relative transition-all duration-300 ${isExpanded ? 'max-h-full' : 'max-h-24'}`}>
                <div 
                    dangerouslySetInnerHTML={{ 
                        __html: formattedText
                            .replace(/\n/g, '<br />')
                            .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                            .replace(/\*(.*?)\*/g, '<em>$1</em>')
                    }} 
                />
                {!isExpanded && (
                    <div className="absolute bottom-0 left-0 w-full h-12 bg-gradient-to-t from-white to-transparent"></div>
                )}
            </div>
        </Card>
    );
};
/* Single Keywords Report Component */
const KeywordsReport = ({ reportText }) => {
    const [isExpanded, setIsExpanded] = useState(false);
    const [copySuccess, setCopySuccess] = useState('');
    const [isCopyingError, setIsCopyingError] = useState(false);
    const [promptCopyStateError, setPromptCopyStateError] = useState('');
    const [cachedErrorPrompt, setCachedErrorPrompt] = useState('');
    const [isCopyingCompetitor, setIsCopyingCompetitor] = useState(false);
    const [promptCopyStateCompetitor, setPromptCopyStateCompetitor] = useState('');
    const [cachedCompetitorPrompt, setCachedCompetitorPrompt] = useState('');
    // competitor prompt states are managed in DualReports; no competitor states here
    const [promptCopyState, setPromptCopyState] = useState(''); // 'ok' | 'err' | ''
    const [isCopying, setIsCopying] = useState(false);
    const [cachedPrompt, setCachedPrompt] = useState('');

    // Icons
    const ChevronDown = createIcon(<polyline points="6 9 12 15 18 9" />);
    const ChevronUp = createIcon(<polyline points="18 15 12 9 6 15" />);
    const Copy = createIcon(
        <>
            <rect x="9" y="9" width="13" height="13" rx="2" ry="2" />
            <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1" />
        </>
    );
    const Download = createIcon(
        <>
            <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4" />
            <polyline points="7 10 12 15 17 10" />
            <line x1="12" y1="15" x2="12" y2="3" />
        </>
    );
    const Check = createIcon(<polyline points="20 6 9 17 4 12" />);

    const handleToggleExpand = () => {
        setIsExpanded(!isExpanded);
    };

    const handleCopyReport = async () => {
        try {
            await navigator.clipboard.writeText(reportText || '');
            setCopySuccess('copied');
            setTimeout(() => setCopySuccess(''), 2000);
        } catch (err) {
            console.error('Failed to copy text: ', err);
        }
    };

    const handleDownloadReport = () => {
        const element = document.createElement('a');
        const file = new Blob([reportText || ''], { type: 'text/plain' });
        element.href = URL.createObjectURL(file);
        element.download = 'keywords-targets-report.txt';
        document.body.appendChild(element);
        element.click();
        document.body.removeChild(element);
    };

    // ---- Prompt Builder for "Implement Recommendations Myself" ----
    const readSessionJson = (key) => {
        try {
            const raw = sessionStorage.getItem(key);
            return raw ? JSON.parse(raw) : null;
        } catch { return null; }
    };

    const fetchSections = (workbookId, sections) => new Promise((resolve) => {
        const base = 'https://script.google.com/macros/s/AKfycbxfOMp8d_eCVH4lFD0PNuFU1wH-gyWOwRt2EuME7GQJ4U73ZwpPDciohDH3C566YLWq/exec';
        const url = `${base}?workbookId=${workbookId}&sections=${encodeURIComponent(sections)}`;
        fetchWithCorsWorkaround(url, (err, data) => {
            resolve(err ? null : data);
        });
    });

    const toArray = (v) => Array.isArray(v) ? v : (v ? [v] : []);

    const pickCaseInsensitive = (obj, keyLike) => {
        if (!obj) return undefined;
        const entries = Object.entries(obj);
        const found = entries.find(([k]) => k.toLowerCase() === keyLike.toLowerCase());
        if (found) return found[1];
        // fuzzy contains
        const fuzzy = entries.find(([k]) => k.toLowerCase().includes(keyLike.toLowerCase()));
        return fuzzy ? fuzzy[1] : undefined;
    };

    // Format any ISO timestamps in text to US-readable date/time
    const formatISOToUSInText = (text) => {
        try {
            return String(text || '').replace(/\b\d{4}-\d{2}-\d{2}T\d{2}:\d{2}:\d{2}(?:\.\d+)?Z\b/g, (m) => {
                const d = new Date(m);
                if (isNaN(d.getTime())) return m;
                return d.toLocaleString('en-US', {
                    year: 'numeric', month: 'short', day: '2-digit',
                    hour: 'numeric', minute: '2-digit'
                });
            });
        } catch { return text; }
    };

    const buildImplementationPrompt = async () => {
        try {
            const params = new URLSearchParams(window.location.search);
            const workbookId = params.get('workbookId') || '';

            // Try caches first
            const kwCache = readSessionJson(`keywords_${workbookId}`);
            const dashCache = readSessionJson(`dashboard_data_${workbookId}`);

            let keywordsSummary = kwCache?.keywordsSummary || {};
            let keywordsTable = kwCache?.keywordsTable || {};
            let overviewData = dashCache?.overviewData || [];
            let websiteStats = null;
            let gbpInsights = null;

            // Attempt to read generic cache for websiteStats from previous calls
            const base = 'https://script.google.com/macros/s/AKfycbxfOMp8d_eCVH4lFD0PNuFU1wH-gyWOwRt2EuME7GQJ4U73ZwpPDciohDH3C566YLWq/exec';
            const wsUrl = `${base}?workbookId=${workbookId}&sections=websiteStats`;
            const wsCache = readSessionJson(`seo_data_${wsUrl}`);
            if (wsCache?.websiteStats) websiteStats = wsCache.websiteStats;

            // Fetch missing pieces in one shot
            if (!websiteStats || !overviewData || Object.keys(keywordsTable).length === 0) {
                const data = await fetchSections(workbookId, 'websiteStats,keywordsSummary,keywordsTable,dashboard,gbpInsights');
                if (data) {
                    websiteStats = websiteStats || data.websiteStats || data?.websiteStats;
                    keywordsSummary = Object.keys(keywordsSummary).length ? keywordsSummary : (data.keywordsSummary || {});
                    keywordsTable = Object.keys(keywordsTable).length ? keywordsTable : (data.keywordsTable || {});
                    if ((!overviewData || overviewData.length === 0) && data.dashboard?.overviewData) {
                        overviewData = data.dashboard.overviewData;
                    }
                    if (data.gbpInsights) {
                        gbpInsights = data.gbpInsights;
                    }
                }
            }
            // If still missing, try a direct gbpInsights fetch
            if (!gbpInsights) {
                const gbpData = await fetchSections(workbookId, 'gbpInsights');
                if (gbpData && gbpData.gbpInsights) gbpInsights = gbpData.gbpInsights;
            }

            // Identify client site (first key used throughout UI)
            const siteNamesAll = Object.keys(keywordsTable || {});
            const clientSite = siteNamesAll.length > 0 ? siteNamesAll[0] : (keywordsSummary?.siteName || 'Client');
            const clientRows = clientSite ? (keywordsTable[clientSite] || []) : [];

            // Build Client Top 30 keywords (rank asc, >0)
            const topClientKeywords = clientRows
                .filter(r => Number(r?.rank_now) > 0)
                .sort((a,b) => Number(a.rank_now) - Number(b.rank_now))
                .slice(0, 30)
                .map(r => ({ k: r.keyword, rank: Number(r.rank_now), sv: Number(r.search_vol || r.sv || r.search_volume || 0), url: r.ranking_url || '', title: r.ranking_title || '' }));

            // Competitor keywords – for each competitor (other site names)
            const competitorSites = siteNamesAll.slice(1);
            const competitorData = competitorSites.map(name => {
                const rows = (keywordsTable[name] || []).slice();
                const byRank = rows.filter(r => Number(r?.rank_now) > 0)
                                   .sort((a,b) => Number(a.rank_now) - Number(b.rank_now))
                                   .slice(0, 20)
                                   .map(r => ({ k: r.keyword, rank: Number(r.rank_now), sv: Number(r.sv || r.search_volume || 0) }));
                const bySvAll = rows.slice().sort((a,b) => Number(b.search_vol || b.sv || b.search_volume || 0) - Number(a.search_vol || a.sv || a.search_volume || 0));
                const bySv = [];
                const top20Set = new Set(byRank.map(x => x.k?.toLowerCase()));
                for (const r of bySvAll) {
                    const kw = String(r.keyword || '').toLowerCase();
                    if (top20Set.has(kw)) continue; // exclude those already in top20 by rank
                    bySv.push({ k: r.keyword, sv: Number(r.search_vol || r.sv || r.search_volume || 0), rank: Number(r.rank_now || 0) });
                    if (bySv.length >= 15) break;
                }
                // Include SV on the topByRank items as well
                const byRankWithSv = byRank.map(r => ({ ...r, sv: Number(r.search_vol || r.sv || r.search_volume || 0) }));
                return { name, topByRank: byRankWithSv, topBySv: bySv };
            });

            // Pull Website Stats (On-Page Insights proxy)
            const health = websiteStats?.healthData || {};
            const tseo = toArray(websiteStats?.technicalSeoData || []);
            const perf = toArray(websiteStats?.competitorPerfData || []).find(x => x?.isClient) || {};
            const siteSpeedMs = Number(health?.siteSpeed) || 0;
            const siteSpeedDisplayMs = isFinite(siteSpeedMs) && siteSpeedMs > 0 ? `${Math.round(siteSpeedMs)} ms` : 'N/A';
            const pageScore = isFinite(Number(health?.pageScore)) ? Number(health.pageScore) : null;
            const ssl = (health?.ssl === true || health?.ssl === 'true' || health?.ssl === 'Yes') ? 'Yes' : (health?.ssl === false ? 'No' : 'Unknown');
            const hasSchema = (health?.hasSchema === true || health?.hasSchema === 'true' || health?.hasSchema === 'Yes') ? 'Yes' : (health?.hasSchema === false ? 'No' : (health?.hasSchemaErrors ? 'Has errors' : 'Unknown'));
            const referringDomains = isFinite(Number(perf['Referring Domains'])) ? Number(perf['Referring Domains']) : undefined;
            const totalBacklinks = isFinite(Number(perf['Total Backlinks'])) ? Number(perf['Total Backlinks']) : undefined;

            // Extract H1/Title/Meta from technicalSeoData for client
            const tseoClient = tseo.find(s => (s?.isClient || (s?.clinicName || s?.name || '').toLowerCase().includes('client')) ) || tseo[0] || {};
            const titleTag = tseoClient?.title || '';
            const metaDescription = tseoClient?.description || '';
            const h1 = tseoClient?.h1 || '';
            const website = tseoClient?.website || (keywordsSummary?.website || '');
            const clinicName = tseoClient?.clinicName || keywordsSummary?.siteName || clientSite || 'Client';

            // Dashboard/GBP fields via overviewData (best-effort, keys vary)
            const clientOverview = toArray(overviewData).find(x => (x?.isClient || (x?.Clinic || x?.clinic || x?.clinicName) === clinicName)) || {};
            const accountType = pickCaseInsensitive(clientOverview, 'Account Type') || '';
            const borough = pickCaseInsensitive(clientOverview, 'Borough') || '';
            const city = pickCaseInsensitive(clientOverview, 'City') || '';
            const state = pickCaseInsensitive(clientOverview, 'State') || '';

            // Prefer GBP Insights tab for GBP-specific fields; fallback to overview
            let gbpRecord = null;
            if (Array.isArray(gbpInsights)) {
                gbpRecord = gbpInsights.find(r => {
                    const at = String(pickCaseInsensitive(r, 'Account Type') || pickCaseInsensitive(r, 'AccountType') || pickCaseInsensitive(r, 'Type') || '').toLowerCase();
                    return at.includes('client');
                }) || gbpInsights[0] || null;
            } else if (gbpInsights && typeof gbpInsights === 'object') {
                // Apps Script returns a flat object with the client fields directly
                gbpRecord = gbpInsights;
            }

            const primaryCategory = (gbpRecord?.primaryCategory || pickCaseInsensitive(gbpRecord, 'Primary Categorie') || pickCaseInsensitive(gbpRecord, 'Primary Category') || pickCaseInsensitive(clientOverview, 'Primary Category') || '').toString();
            const secondaryCategories = (gbpRecord?.secondaryCategories || pickCaseInsensitive(gbpRecord, 'Secondary Categories') || pickCaseInsensitive(clientOverview, 'Secondary Categories') || '').toString();
            const gbpDescription = (gbpRecord?.description || pickCaseInsensitive(gbpRecord, 'Description') || pickCaseInsensitive(clientOverview, 'Description') || '').toString();
            const reviewScore = (gbpRecord?.reviewScore || pickCaseInsensitive(gbpRecord, 'Review Score') || pickCaseInsensitive(clientOverview, 'Review Score') || '').toString();
            const reviewCount = (gbpRecord?.reviewCount || pickCaseInsensitive(gbpRecord, 'Review Count') || pickCaseInsensitive(clientOverview, 'Review Count') || '').toString();
            const photoCount = (gbpRecord?.photoCount || gbpRecord?.totalPhotos || pickCaseInsensitive(gbpRecord, 'Photo Count') || pickCaseInsensitive(gbpRecord, 'Total Photos') || pickCaseInsensitive(clientOverview, 'Photo Count') || pickCaseInsensitive(clientOverview, 'Total Photos') || '').toString();
            const qaCount = (gbpRecord?.qaCount || pickCaseInsensitive(gbpRecord, 'QACount') || pickCaseInsensitive(gbpRecord, 'Q&A Count') || pickCaseInsensitive(clientOverview, 'QACount') || pickCaseInsensitive(clientOverview, 'Q&A Count') || '').toString();

            // Website Crawl Pages (lightweight list of path slugs from websiteStats)
            const crawlPages = toArray(health?.checksAggregate?.pagesList || health?.pagesList || health?.topPages || [])
                .map(p => (typeof p === 'string' ? p : (p?.url || p?.path || '')))
                .filter(Boolean)
                .slice(0, 60);

            // Compose prompt
            const lines = [];
            // Strong role + context preamble (keyword-centric)
            lines.push('ROLE: You are a senior MedSpa SEO strategist and implementation partner.');
            lines.push('CONTEXT: The client has just generated a monthly keyword-focused report. Use the data below to guide them step-by-step to implement the most impactful actions first, while keeping instructions practical and non-technical.');
            lines.push('GOAL: Improve keyword rankings, organic traffic, and conversions by prioritizing keyword opportunities, mapping them to pages, and executing on-page/content/internal-linking tasks.');
            lines.push('WORKING MODE:');
            lines.push('- Start by analyzing the data below and, if needed, conduct brief independent research to fill gaps.');
            lines.push('- Present a succinct plan and the first actionable step immediately (do not wait for answers).');
            lines.push('- The first action must be click-by-click with the exact URL(s) the client should visit (e.g., https://business.google.com/ for Google Business Profile).');
            lines.push('- Ask only the most essential 1–3 questions after the first step (e.g., CMS, target areas/cities, brand voice) to tailor follow-up steps.');
            lines.push('- Keep outputs concise and actionable: include exact Titles/H1s/Meta, URL suggestions, internal link anchors, FAQ ideas, and schema notes.');
            lines.push('- After each step, confirm completion and offer to continue to the next step.');
            lines.push('');
            lines.push('CLIENT PROFILE:');
            lines.push(`- Clinic Name: ${clinicName}`);
            lines.push(`- Website: ${website || 'N/A'}`);
            if (accountType) lines.push(`- Account Type: ${accountType}`);
            const locParts = [borough, city, state].filter(Boolean).join(', ');
            if (locParts) lines.push(`- Location: ${locParts}`);
            lines.push('');
            lines.push('CORE ON-PAGE / TECHNICAL SNAPSHOT:');
            lines.push(`- Title Tag: ${titleTag || 'N/A'}`);
            lines.push(`- Meta Description: ${metaDescription || 'N/A'}`);
            lines.push(`- H1: ${h1 || 'N/A'}`);
            lines.push(`- Site Speed: ${siteSpeedDisplayMs}`);
            lines.push(`- Page Score: ${pageScore !== null ? pageScore : 'N/A'}`);
            lines.push(`- Referring Domains: ${typeof referringDomains !== 'undefined' ? referringDomains : 'N/A'}`);
            if (typeof totalBacklinks !== 'undefined') lines.push(`- Total Backlinks: ${totalBacklinks}`);
            lines.push(`- SSL: ${ssl}`);
            lines.push(`- Schema: ${hasSchema}`);
            lines.push('');
            // GBP mini section (always include, with placeholders if missing)
            lines.push('');
            lines.push('GOOGLE BUSINESS PROFILE INSIGHTS:');
            lines.push(`- Primary Category: ${primaryCategory || 'N/A'}`);
            lines.push(`- Secondary Categories: ${secondaryCategories || 'N/A'}`);
            lines.push(`- Description: ${gbpDescription || 'N/A'}`);
            lines.push(`- Stats: ${[
                `Review Score: ${reviewScore || 'N/A'}`,
                `Reviews: ${reviewCount || 'N/A'}`,
                `Photos: ${photoCount || 'N/A'}`,
                `Q&A: ${qaCount || 'N/A'}`
            ].join(' | ')}`);
            lines.push('');
            lines.push('CLIENT WEBPAGES:');
            if (crawlPages.length) {
                lines.push(crawlPages.map(p => `- ${p}`).join('\n'));
            } else {
                lines.push('- N/A');
            }
            lines.push('');
            lines.push('TOP 30 CLIENT KEYWORDS (by best rank):');
            if (topClientKeywords.length) {
                lines.push(topClientKeywords.map(r => `- ${r.k} — rank ${r.rank}${r.sv?`, sv ${r.sv}`:''}${r.url?` — ${r.url}`:''}`).join('\n'));
            } else {
                lines.push('- N/A');
            }
            lines.push('');
            lines.push('COMPETITOR KEYWORDS:');
            competitorData.forEach(c => {
                lines.push(`• ${c.name} — Top by Rank (20):`);
                lines.push(c.topByRank.map(r => `  - ${r.k} — rank ${r.rank}${r.sv?`, sv ${r.sv}`:''}`).join('\n') || '  - N/A');
                lines.push(`  Top by Search Volume (15, excluding above):`);
                lines.push(c.topBySv.map(r => `  - ${r.k} — sv ${r.sv}${r.rank?`, rank ${r.rank}`:''}`).join('\n') || '  - N/A');
            });
            lines.push('');
            lines.push('KEYWORDS AI REPORT (Client):');
            lines.push(String(reportText || '').trim() || 'N/A');
            lines.push('');
            lines.push('--- End of report ---');
            lines.push('');
            lines.push('OPERATING PLAN (follow in this order):');
            lines.push('1) Rapid Analysis + Plan: In 5 bullets, summarize the biggest keyword wins (intent + impact) and outline a short plan. Include any quick GBP fixes (missing category or description) if they materially affect visibility.');
            lines.push('2) First Action (Click-by-click): If GBP gaps are detected, give explicit steps to update categories/description now. Use this pattern:');
            lines.push('   - Go to https://business.google.com/ and sign in to your Google Business Profile Manager.');
            lines.push('   - Open your profile > Edit profile > Business category.');
            lines.push('   - Set Primary Category (exact string) and add Secondary Categories (exact strings). Save.');
            lines.push('   - Then go to Business information > About > Description and paste the suggested description. Save.');
            lines.push('   - Confirm the changes are visible on your live profile.');
            lines.push('   If GBP is already correct, provide equivalent click-by-click steps to update Homepage Title/H1/Meta for the top keyword, including the exact strings to paste. If CMS is unknown, give generic paths for WordPress/Wix/Squarespace.');
            lines.push('3) Minimal Questions (≤3): Ask ONLY essentials to refine next steps:');
            lines.push('   - Which CMS/platform powers the site (WordPress, Wix, Squarespace, custom)?');
            lines.push('   - Primary service areas or cities to prioritize (e.g., neighborhoods, suburbs)?');
            lines.push('   - Preferred brand voice (clinical/professional vs friendly/approachable vs luxury)?');
            lines.push('4) Prioritized Keyword Backlog: Create a short, ranked list (10–15) with rationale (current rank/SV, intent, competitor coverage).');
            lines.push('5) Keyword-to-Page Mapping: For top 3–5 targets, map each to an existing URL (or propose a new URL) and note gaps.');
            lines.push('6) On-Page Implementation for the NEXT target (or GBP optimization if prioritized):');
            lines.push('   - Provide exact Title (<=60 chars), H1, Meta Description (<=155 chars), H2/H3 outline, and 5–7 keywords/LSIs.');
            lines.push('   - Internal links: list 3–5 anchor texts and source pages to link from.');
            lines.push('   - Content additions: bullets, FAQs (3–5) with concise answers; suggest adding local modifiers.');
            lines.push('   - Schema: specify the most relevant type(s) to add/update (e.g., LocalBusiness, FAQ). If GBP changes apply, note the exact Primary/Secondary category string(s) and a suggested 750+ character description.');
            lines.push('7) Implementation Checklist: Provide a checkbox list the client can work through inside their CMS.');
            lines.push('8) Measurement Plan: define success metrics (rank targets, CTR, impressions) and how to verify in GSC/GA4 weekly.');
            lines.push('9) Next Step: after finishing the first target, offer to proceed to the next item in the backlog.');

            let output = lines.join('\n');
            output = formatISOToUSInText(output);
            return output;
        } catch (e) {
            console.error('Prompt build error', e);
            throw e;
        }
    };

    const handleCopyImplementationPrompt = async () => {
        if (isCopying) return;
        try {
            setIsCopying(true);
            setPromptCopyState('');
            // If we have a prebuilt prompt ready, copy instantly
            if (cachedPrompt) {
                await navigator.clipboard.writeText(cachedPrompt);
                setPromptCopyState('ok');
                return;
            }
            // Fallback: build on-demand, then cache and copy
            const prompt = await buildImplementationPrompt();
            try {
                const params = new URLSearchParams(window.location.search);
                const workbookId = params.get('workbookId') || '';
                const cacheKey = `impl_prompt_${workbookId}`;
                const payload = { prompt, aiText: String(reportText || ''), ts: Date.now() };
                sessionStorage.setItem(cacheKey, JSON.stringify(payload));
                setCachedPrompt(prompt);
            } catch {}
            await navigator.clipboard.writeText(prompt);
            setPromptCopyState('ok');
        } catch (e) {
            setPromptCopyState('err');
        } finally {
            setTimeout(() => { setPromptCopyState(''); setIsCopying(false); }, 20000);
        }
    };

    // Prebuild the prompt after initial render (idle or short delay) and cache it
    useEffect(() => {
        try {
            const params = new URLSearchParams(window.location.search);
            const workbookId = params.get('workbookId') || '';
            const cacheKey = `impl_prompt_${workbookId}`;
            // Read existing cache
            const raw = sessionStorage.getItem(cacheKey);
            if (raw) {
                try {
                    const parsed = JSON.parse(raw);
                    const isFresh = parsed && parsed.aiText === String(reportText || '') && (Date.now() - (parsed.ts || 0) < 10 * 60 * 1000);
                    if (isFresh && parsed.prompt) {
                        setCachedPrompt(parsed.prompt);
                        return;
                    }
                } catch {}
            }
            const build = async () => {
                try {
                    const prompt = await buildImplementationPrompt();
                    const payload = { prompt, aiText: String(reportText || ''), ts: Date.now() };
                    sessionStorage.setItem(cacheKey, JSON.stringify(payload));
                    setCachedPrompt(prompt);
                } catch {}
            };
            // Defer to idle time if available, else small timeout so we don't affect initial load
            if ('requestIdleCallback' in window) {
                window.requestIdleCallback(() => { build(); }, { timeout: 3000 });
            } else {
                setTimeout(build, 2500);
            }
        } catch {}
    }, [reportText]);

    const handleRequestImplement = () => {
        window.open('https://www.skool.com/forever-booked/classroom/a23620ff?md=00953c20f4574ccdb6d5edfe0a0298ed', '_blank');
    };

    // Reuse robust markdown parser
    const escapeHtmlKW = (str) => String(str || '')
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;');
    const applyInlineMarkdownKW = (str) => {
        let s = str;
        s = s.replace(/\u00A0/g, ' ').replace(/[\u200B-\u200D\uFEFF]/g, '');
        s = s.replace(/\*\*([\s\S]+?)\*\*/g, '<strong class="font-bold">$1</strong>');
        s = s.replace(/__([\s\S]+?)__/g, '<strong class="font-bold">$1</strong>');
        s = s.replace(/(^|[^*])\*(?!\*)([^*]+)\*(?!\*)/g, '$1<em>$2</em>');
        s = s.replace(/_([^_]+)_/g, '<em>$1</em>');
        s = s.replace(/(https?:\/\/[^\s<]+)/g, '<a href="$1" target="_blank" rel="noopener" class="text-blue-600 underline">$1<\/a>');
        return s;
    };
    const parseMarkdownToHtmlKW = (markdown) => {
        const lines = escapeHtmlKW(markdown).replace(/\r\n?/g, '\n').split('\n');
        const html = []; let inUl = false, inOl = false, blankStreak = 0, inTable = false; let tableRows = [];
        const closeLists = () => { if (inUl) { html.push('</ul>'); inUl = false; } if (inOl) { html.push('</ol>'); inOl = false; } };
        const flushTable = () => {
            if (!inTable || tableRows.length === 0) return;
            let headerCells = null;
            if (tableRows.length >= 2 && tableRows[1].every(cell => /^:?-{3,}:?$/.test(cell))) { headerCells = tableRows[0]; tableRows = tableRows.slice(2); }
            const thead = headerCells ? '<thead><tr>' + headerCells.map((c) => `<th class=\"border border-gray-200 px-3 py-2 font-semibold bg-gray-100 dark:bg-gray-700 text-gray-900 dark:text-gray-100\">${applyInlineMarkdownKW(c)}</th>`).join('') + '</tr></thead>' : '';
            const tbody = '<tbody>' + tableRows.map(row => ('<tr>' + row.map((c,i) => `<td class=\"border border-gray-200 px-3 py-2 ${i===0?'font-medium':''} whitespace-nowrap\">${applyInlineMarkdownKW(c)}</td>`).join('') + '</tr>')).join('') + '</tbody>';
            html.push(`<div class=\"my-4\"><div class=\"max-w-full overflow-x-auto\"><table class=\"table-auto w-auto text-sm border border-gray-200 rounded-lg border-collapse\">${thead}${tbody}</table></div></div>`);
            inTable = false; tableRows = [];
        };
        lines.forEach(raw => {
            const line = raw.replace(/\s+$/,'').replace(/^\s+/, '');
            if (!line) { blankStreak++; closeLists(); flushTable(); return; }
            if (blankStreak > 0) { html.push(`<div class=\"${blankStreak >= 2 ? 'my-8' : 'my-5'}\"></div>`); blankStreak = 0; }
            if (/^---+$/.test(line)) { closeLists(); flushTable(); html.push('<hr class=\"my-8 border-t border-gray-200\" />'); return; }
            if (/^####\s+/.test(line)) { closeLists(); flushTable(); html.push(`<h4 class=\"mt-4 mb-2 font-semibold text-lg leading-tight\">${applyInlineMarkdownKW(line.replace(/^####\s+/, ''))}</h4>`); return; }
            if (/^###\s+/.test(line)) { closeLists(); flushTable(); html.push(`<h3 class=\"mt-5 mb-3 font-semibold text-xl leading-tight\">${applyInlineMarkdownKW(line.replace(/^###\s+/, ''))}</h3>`); return; }
            if (/^##\s+/.test(line)) { closeLists(); flushTable(); html.push(`<h2 class=\"mt-6 mb-4 font-semibold text-2xl leading-tight\">${applyInlineMarkdownKW(line.replace(/^##\s+/, ''))}</h2>`); return; }
            if (/^#\s+/.test(line)) { closeLists(); flushTable(); html.push(`<h1 class=\"mt-7 mb-5 font-bold text-4xl leading-tight\">${applyInlineMarkdownKW(line.replace(/^#\s+/, ''))}</h1>`); return; }
            if (/^\|.*\|$/.test(line)) { const cells = line.replace(/^\|/, '').replace(/\|$/, '').split('|').map(c => c.trim()); if (!inTable) { inTable = true; tableRows = []; } tableRows.push(cells); return; }
            flushTable();
            if (/^\d+\.\s+/.test(line)) { if (!inOl) { closeLists(); html.push('<ol class=\"list-decimal pl-5 my-2 space-y-1.5\">'); inOl = true; } html.push(`<li>${applyInlineMarkdownKW(line.replace(/^\d+\.\s+/, ''))}</li>`); return; }
            if (/^(?:-|\u2022|\u2013)\s+/.test(line)) { if (!inUl) { closeLists(); html.push('<ul class=\"list-disc pl-5 my-2 space-y-1.5\">'); inUl = true; } html.push(`<li>${applyInlineMarkdownKW(line.replace(/^(?:-|\u2022|\u2013)\s+/, ''))}</li>`); return; }
            closeLists(); html.push(`<p class=\"my-5\">${applyInlineMarkdownKW(line)}</p>`);
        });
        closeLists(); flushTable();
        let result = html.join('\n');
        result = result.replace(/(<p[^>]*>[^<:]*:[^<]*<\/p>)\s*(<div class=\"my-5\"><\/div>)/g, '$1');
        return result;
    };
    const formattedContent = parseMarkdownToHtmlKW(String(reportText || 'Keywords targeting report will appear here once generated.'));

    // Check if this is just placeholder text
    const isPlaceholderOnly = !reportText || reportText.trim() === '' || reportText === 'Keywords targeting report will appear here once generated.';

    return (
        <div className="rounded-2xl shadow-lg overflow-hidden transition-all duration-300 bg-white dark:bg-gray-800" style={{border: 'none', outline: 'none', boxShadow: '0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05)'}}>
            {/* Single Tab Header */}
            <div className="flex p-1 rounded-t-xl dual-reports-header">
                <div className="flex-1 relative px-6 py-4 text-base font-semibold transition-all duration-200 rounded-xl dual-reports-active-green">
                    <div className="flex items-center justify-between">
                        <div className="flex items-center space-x-2">
                            <span>Keywords to Target this Month</span>
                            <InfoTooltip text="AI-generated recommendations for high-value keyword opportunities to target this month based on competitor analysis and search trends." />
                            <button
                                onClick={(e) => {
                                    e.stopPropagation();
                                    handleToggleExpand();
                                }}
                                className="flex items-center space-x-1 px-2 py-1 rounded-md transition-colors text-gray-500 hover:text-gray-700 text-xs dual-reports-action-hover"
                                title={isExpanded ? "Show less" : "Show more"}
                            >
                                <span>{isExpanded ? "Show Less" : "Show More"}</span>
                                {isExpanded ? (
                                    <ChevronUp className="w-3 h-3" />
                                ) : (
                                    <ChevronDown className="w-3 h-3" />
                                )}
                            </button>
                        </div>
                        <div className="flex items-center space-x-1">
                            <button
                                onClick={(e) => {
                                    e.stopPropagation();
                                    handleCopyReport();
                                }}
                                className={`p-1 rounded-md transition-colors ${
                                    copySuccess === 'copied'
                                        ? 'text-green-600'
                                        : 'text-green-600 hover:text-green-800 hover:bg-green-50 dual-reports-action-hover'
                                }`}
                                title="Copy report"
                            >
                                {copySuccess === 'copied' ? (
                                    <Check className="w-4 h-4" />
                                ) : (
                                    <Copy className="w-4 h-4" />
                                )}
                            </button>
                            <button
                                onClick={(e) => {
                                    e.stopPropagation();
                                    handleDownloadReport();
                                }}
                                className="p-1 rounded-md transition-colors text-green-600 hover:text-green-800 hover:bg-green-50 dual-reports-action-hover"
                                title="Download report as text file"
                            >
                                <Download className="w-4 h-4" />
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            {/* Content Area */}
            <div className="rounded-b-xl dual-reports-content">
                <div className="p-6 relative">
                    {/* Preview/Summary when collapsed */}
                    {!isExpanded && (
                        <div className="space-y-2">
                            <div className="relative">
                                {/* Text content */}
                                <div 
                                    className="prose prose-sm max-w-none leading-relaxed overflow-hidden select-text cursor-text dual-reports-text prose-p:my-3 prose-h1:mt-6 prose-h1:mb-3 prose-h2:mt-5 prose-h2:mb-2.5 prose-h3:mt-4 prose-h3:mb-2 prose-ul:my-2 prose-ol:my-2"
                                    style={{ maxHeight: '160px' }}
                                    dangerouslySetInnerHTML={{ __html: formattedContent }}
                                />
                                {/* Only show fade if not placeholder text */}
                                {!isPlaceholderOnly && (
                                    <div className="absolute bottom-0 left-0 right-0 h-8 pointer-events-none dual-reports-fade-light"></div>
                                )}
                            </div>

                            {/* Clickable area to expand - only show if not placeholder */}
                            {!isPlaceholderOnly && (
                                <div
                                    className="text-center py-2 cursor-pointer rounded-lg transition-colors text-sm dual-reports-show-more"
                                    onClick={handleToggleExpand}
                                >
                                    Show More
                                </div>
                            )}
                        </div>
                    )}

                    {/* Full content when expanded */}
                    {isExpanded && (
                        <div className="space-y-2">
                            {/* Text content */}
                            <div
                                className="prose prose-sm max-w-none leading-relaxed select-text cursor-text dual-reports-text prose-p:my-3 prose-h1:mt-6 prose-h1:mb-3 prose-h2:mt-5 prose-h2:mb-2.5 prose-h3:mt-4 prose-h3:mb-2 prose-ul:my-2 prose-ol:my-2"
                                dangerouslySetInnerHTML={{ __html: formattedContent }}
                            />

                            {/* Action Buttons - above Show Less, bottom-right inside report */}
                            <div className="mt-2 flex items-center justify-end space-x-3">
                                <button
                                    onClick={handleCopyImplementationPrompt}
                                    className="px-4 py-2 rounded-lg font-semibold text-white bg-gradient-to-r from-blue-600 to-blue-700 hover:from-blue-700 hover:to-blue-800 shadow-md disabled:opacity-60"
                                    title="Copy implementation prompt"
                                    disabled={isCopying}
                                >
                                    Implement Recommendations Myself
                                </button>
                                <button
                                    onClick={handleRequestImplement}
                                    className="px-4 py-2 rounded-lg font-semibold text-white"
                                    style={{ backgroundColor: '#F8857E' }}
                                    title="Request paid implementation"
                                >
                                    Request Forever Booked Implement (Paid SEO)
                                </button>
                            </div>
                            {!!promptCopyState && (
                                <div className={`mt-1 text-right text-sm ${promptCopyState==='ok'?'text-green-600':'text-red-600'}`}>
                                    {promptCopyState==='ok' 
                                        ? 'Prompt copied! Open your favourite AI model and paste it into the chat to get started.' 
                                        : 'Failed to build or copy the prompt. Please try again in a moment.'}
                                </div>
                            )}

                            {/* Clickable area to collapse */}
                            <div
                                className="text-center py-2 cursor-pointer rounded-lg transition-colors text-sm dual-reports-show-more"
                                onClick={handleToggleExpand}
                            >
                                Show Less
                            </div>
                        </div>
                    )}
                </div>
            </div>
        </div>
    );
};
/* GBP Report Component (Dashboard) */
const GBPReportSection = ({ reportText }) => {
    const [isExpanded, setIsExpanded] = useState(false);
    const [copySuccess, setCopySuccess] = useState('');
    const [isCopying, setIsCopying] = useState(false);
    const [promptCopyState, setPromptCopyState] = useState('');
    const [cachedPrompt, setCachedPrompt] = useState('');

    // Icons
    const ChevronDown = createIcon(<polyline points="6 9 12 15 18 9" />);
    const ChevronUp = createIcon(<polyline points="18 15 12 9 6 15" />);
    const Copy = createIcon(
        <>
            <rect x="9" y="9" width="13" height="13" rx="2" ry="2" />
            <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1" />
        </>
    );
    const Download = createIcon(
        <>
            <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4" />
            <polyline points="7 10 12 15 17 10" />
            <line x1="12" y1="15" x2="12" y2="3" />
        </>
    );
    const Check = createIcon(<polyline points="20 6 9 17 4 12" />);

    const handleToggleExpand = () => {
        setIsExpanded(!isExpanded);
    };

    const handleCopyReport = async () => {
        try {
            await navigator.clipboard.writeText(reportText || '');
            setCopySuccess('copied');
            setTimeout(() => setCopySuccess(''), 2000);
        } catch (err) {
            console.error('Failed to copy text: ', err);
        }
    };

    const handleDownloadReport = () => {
        const element = document.createElement('a');
        const file = new Blob([reportText || ''], { type: 'text/plain' });
        element.href = URL.createObjectURL(file);
        element.download = 'gbp-report.txt';
        document.body.appendChild(element);
        element.click();
        document.body.removeChild(element);
    };

    // Markdown helpers (match DualReports behavior)
    const escapeHtml = (str) => String(str || '')
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;');

    const applyInlineMarkdown = (str) => {
        let s = str;
        s = s.replace(/\u00A0/g, ' ').replace(/[\u200B-\u200D\uFEFF]/g, '');
        s = s.replace(/\*\*([\s\S]+?)\*\*/g, '<strong class="font-bold">$1</strong>');
        s = s.replace(/__([\s\S]+?)__/g, '<strong class="font-bold">$1</strong>');
        s = s.replace(/(^|[^*])\*(?!\*)([^*]+)\*(?!\*)/g, '$1<em>$2</em>');
        s = s.replace(/_([^_]+)_/g, '<em>$1</em>');
        s = s.replace(/(https?:\/\/[^\s<]+)/g, '<a href="$1" target="_blank" rel="noopener" class="text-blue-600 underline">$1<\/a>');
        return s;
    };

    const parseMarkdownToHtml = (markdown) => {
        const lines = escapeHtml(markdown).replace(/\r\n?/g, '\n').split('\n');
        const html = [];
        let inUl = false, inOl = false;
        let blankStreak = 0;
        let inTable = false;
        let tableRows = [];

        const closeLists = () => {
            if (inUl) { html.push('</ul>'); inUl = false; }
            if (inOl) { html.push('</ol>'); inOl = false; }
        };

        const flushTable = () => {
            if (!inTable || tableRows.length === 0) return;
            let headerCells = null;
            if (tableRows.length >= 2 && tableRows[1].every(cell => /^:?-{3,}:?$/.test(cell))) {
                headerCells = tableRows[0];
                tableRows = tableRows.slice(2);
            }
            const thead = headerCells
                ? '<thead><tr>' + headerCells.map((c) => `<th class="border border-gray-200 px-3 py-2 font-semibold bg-gray-100 dark:bg-gray-700 text-gray-900 dark:text-gray-100">${applyInlineMarkdown(c)}</th>`).join('') + '</tr></thead>'
                : '';
            const tbody = '<tbody>' + tableRows.map(row => (
                '<tr>' + row.map((c,i) => `<td class=\"border border-gray-200 px-3 py-2 ${i===0?'font-medium':''} whitespace-nowrap\">${applyInlineMarkdown(c)}</td>`).join('') + '</tr>'
            )).join('') + '</tbody>';
            html.push(`<div class="my-4"><div class="max-w-full overflow-x-auto"><table class="table-auto w-auto text-sm border border-gray-200 rounded-lg border-collapse">${thead}${tbody}</table></div></div>`);
            inTable = false;
            tableRows = [];
        };

        lines.forEach(raw => {
            const line = raw.replace(/\s+$/,'').replace(/^\s+/, '');
            if (!line) { blankStreak++; closeLists(); flushTable(); return; }
            if (blankStreak > 0) { html.push(`<div class="${blankStreak >= 2 ? 'my-8' : 'my-5'}"></div>`); blankStreak = 0; }
            if (/^---+$/.test(line)) { closeLists(); flushTable(); html.push('<hr class="my-8 border-t border-gray-200" />'); return; }
            if (/^####\s+/.test(line)) { closeLists(); flushTable(); html.push(`<h4 class="mt-4 mb-2 font-semibold text-lg leading-tight">${applyInlineMarkdown(line.replace(/^####\s+/, ''))}</h4>`); return; }
            if (/^###\s+/.test(line)) { closeLists(); flushTable(); html.push(`<h3 class="mt-5 mb-3 font-semibold text-xl leading-tight">${applyInlineMarkdown(line.replace(/^###\s+/, ''))}</h3>`); return; }
            if (/^##\s+/.test(line)) { closeLists(); flushTable(); html.push(`<h2 class="mt-6 mb-4 font-semibold text-2xl leading-tight">${applyInlineMarkdown(line.replace(/^##\s+/, ''))}</h2>`); return; }
            if (/^#\s+/.test(line)) { closeLists(); flushTable(); html.push(`<h1 class="mt-7 mb-5 font-bold text-4xl leading-tight">${applyInlineMarkdown(line.replace(/^#\s+/, ''))}</h1>`); return; }
            if (/^\|.*\|$/.test(line)) {
                const cells = line.replace(/^\|/, '').replace(/\|$/, '').split('|').map(c => c.trim());
                if (!inTable) { inTable = true; tableRows = []; }
                tableRows.push(cells);
                return;
            }
            flushTable();
            if (/^\d+\.\s+/.test(line)) {
                if (!inOl) { closeLists(); html.push('<ol class="list-decimal pl-5 my-2 space-y-1.5">'); inOl = true; }
                html.push(`<li>${applyInlineMarkdown(line.replace(/^\d+\.\s+/, ''))}</li>`);
                return;
            }
            if (/^(?:-|\u2022|\u2013)\s+/.test(line)) {
                if (!inUl) { closeLists(); html.push('<ul class="list-disc pl-5 my-2 space-y-1.5">'); inUl = true; }
                html.push(`<li>${applyInlineMarkdown(line.replace(/^(?:-|\u2022|\u2013)\s+/, ''))}</li>`);
                return;
            }
            closeLists();
            html.push(`<p class="my-5">${applyInlineMarkdown(line)}</p>`);
        });
        closeLists();
        flushTable();
        let result = html.join('\n');
        result = result.replace(/(<p[^>]*>[^<:]*:[^<]*<\/p>)\s*(<div class=\"my-5\"><\/div>)/g, '$1');
        return result;
    };

    const formattedContent = parseMarkdownToHtml(String(reportText || 'Google Business Profile analysis will appear here once generated.'));

    // Check if this is just placeholder text
    const isPlaceholderOnly = !reportText || reportText.trim() === '' || reportText === 'Google Business Profile analysis will appear here once generated.';

    // ---------- GBP Implementation Prompt Builder ----------
    const formatISOToUSInTextGBP = (text) => {
        try {
            return String(text || '').replace(/\b\d{4}-\d{2}-\d{2}T\d{2}:\d{2}:\d{2}(?:\.\d+)?Z\b/g, (m) => {
                const d = new Date(m);
                if (isNaN(d.getTime())) return m;
                return d.toLocaleString('en-US', {
                    year: 'numeric', month: 'short', day: '2-digit',
                    hour: 'numeric', minute: '2-digit'
                });
            });
        } catch { return text; }
    };

    const readSessionJsonGBP = (key) => {
        try {
            const raw = sessionStorage.getItem(key);
            return raw ? JSON.parse(raw) : null;
        } catch { return null; }
    };
    const fetchSectionsGBP = (workbookId, sections) => new Promise((resolve) => {
        const base = 'https://script.google.com/macros/s/AKfycbxfOMp8d_eCVH4lFD0PNuFU1wH-gyWOwRt2EuME7GQJ4U73ZwpPDciohDH3C566YLWq/exec';
        const url = `${base}?workbookId=${workbookId}&sections=${encodeURIComponent(sections)}`;
        fetchWithCorsWorkaround(url, (err, data) => {
            resolve(err ? null : data);
        });
    });
    const toArrayGBP = (v) => Array.isArray(v) ? v : (v ? [v] : []);
    const pickCaseInsensitiveGBP = (obj, keyLike) => {
        if (!obj) return undefined;
        const entries = Object.entries(obj);
        const found = entries.find(([k]) => k.toLowerCase() === keyLike.toLowerCase());
        if (found) return found[1];
        const fuzzy = entries.find(([k]) => k.toLowerCase().includes(keyLike.toLowerCase()));
        return fuzzy ? fuzzy[1] : undefined;
    };

    const buildGbpImplementationPrompt = async () => {
        const params = new URLSearchParams(window.location.search);
        const workbookId = params.get('workbookId') || '';

        const dashCache = readSessionJsonGBP(`dashboard_data_${workbookId}`);
        let overviewData = dashCache?.overviewData || [];

        // Try cached websiteStats
        const base = 'https://script.google.com/macros/s/AKfycbxfOMp8d_eCVH4lFD0PNuFU1wH-gyWOwRt2EuME7GQJ4U73ZwpPDciohDH3C566YLWq/exec';
        const wsUrl = `${base}?workbookId=${workbookId}&sections=websiteStats`;
        const wsCache = readSessionJsonGBP(`seo_data_${wsUrl}`);
        let websiteStats = wsCache?.websiteStats || null;
        let gbpInsights = null;
        let keywordsSummary = null;
        let keywordsTable = null;

        if (!websiteStats || !overviewData) {
            const data = await fetchSectionsGBP(workbookId, 'websiteStats,dashboard,gbpInsights,keywordsSummary,keywordsTable');
            if (data) {
                websiteStats = websiteStats || data.websiteStats || data?.websiteStats;
                if ((!overviewData || overviewData.length === 0) && data.dashboard?.overviewData) overviewData = data.dashboard.overviewData;
                if (data.gbpInsights) gbpInsights = data.gbpInsights;
                if (data.keywordsSummary) keywordsSummary = data.keywordsSummary;
                if (data.keywordsTable) keywordsTable = data.keywordsTable;
            }
        }
        if (!gbpInsights) {
            const g = await fetchSectionsGBP(workbookId, 'gbpInsights');
            if (g && g.gbpInsights) gbpInsights = g.gbpInsights;
        }

        // Determine client context
        const health = websiteStats?.healthData || {};
        const tseo = toArrayGBP(websiteStats?.technicalSeoData || []);
        const perf = toArrayGBP(websiteStats?.competitorPerfData || []).find(x => x?.isClient) || {};
        const siteSpeedMs = Number(health?.siteSpeed) || 0;
        const siteSpeedDisplayMs = isFinite(siteSpeedMs) && siteSpeedMs > 0 ? `${Math.round(siteSpeedMs)} ms` : 'N/A';
        const pageScore = isFinite(Number(health?.pageScore)) ? Number(health.pageScore) : null;
        const referringDomains = isFinite(Number(perf['Referring Domains'])) ? Number(perf['Referring Domains']) : undefined;
        const totalBacklinks = isFinite(Number(perf['Total Backlinks'])) ? Number(perf['Total Backlinks']) : undefined;

        const tseoClient = tseo.find(s => (s?.isClient || (s?.clinicName || s?.name || '').toLowerCase().includes('client')) ) || tseo[0] || {};
        const titleTag = tseoClient?.title || '';
        const metaDescription = tseoClient?.description || '';
        const h1 = tseoClient?.h1 || '';
        const website = tseoClient?.website || '';
        const clinicName = tseoClient?.clinicName || 'Client';

        // Keyword positions
        let pos1 = keywordsSummary?.['Position 1'] ?? keywordsSummary?.['Keywords Position 1'] ?? keywordsSummary?.pos1 ?? null;
        let pos23 = keywordsSummary?.['Position 2-3'] ?? keywordsSummary?.['Keywords Position 2-3'] ?? keywordsSummary?.pos23 ?? null;
        let pos410 = keywordsSummary?.['Position 4-10'] ?? keywordsSummary?.['Keywords Position 4-10'] ?? keywordsSummary?.pos410 ?? null;
        if ((pos1 == null && pos23 == null && pos410 == null) && keywordsTable) {
            const siteKey = Object.keys(keywordsTable)[0];
            const rows = (keywordsTable[siteKey] || []).filter(r => Number(r?.rank_now) > 0);
            let c1 = 0, c23 = 0, c410c = 0;
            for (const r of rows) {
                const rank = Number(r.rank_now);
                if (!isFinite(rank)) continue;
                if (rank === 1) c1++;
                else if (rank >= 2 && rank <= 3) c23++;
                else if (rank >= 4 && rank <= 10) c410c++;
            }
            pos1 = c1; pos23 = c23; pos410 = c410c;
        }

        // GBP client record
        let gbpRecord = null;
        if (Array.isArray(gbpInsights)) {
            gbpRecord = gbpInsights.find(r => {
                const at = String(pickCaseInsensitiveGBP(r, 'Account Type') || pickCaseInsensitiveGBP(r, 'AccountType') || pickCaseInsensitiveGBP(r, 'Type') || '').toLowerCase();
                return at.includes('client');
            }) || gbpInsights[0] || null;
        } else if (gbpInsights && typeof gbpInsights === 'object') {
            gbpRecord = gbpInsights;
        }

        const gbpClaimed = (gbpRecord?.claimed ?? pickCaseInsensitiveGBP(gbpRecord, 'Claimed') ?? '').toString();
        const gbpPrimary = (gbpRecord?.primaryCategory || pickCaseInsensitiveGBP(gbpRecord, 'Primary Categorie') || pickCaseInsensitiveGBP(gbpRecord, 'Primary Category') || '').toString();
        const gbpSecondary = (gbpRecord?.secondaryCategories || pickCaseInsensitiveGBP(gbpRecord, 'Secondary Categories') || '').toString();
        const gbpHours = (gbpRecord?.openingHours ?? pickCaseInsensitiveGBP(gbpRecord, 'Opening Hours') ?? '').toString();
        const gbpLogo = (gbpRecord?.logo ?? pickCaseInsensitiveGBP(gbpRecord, 'Logo') ?? '').toString();
        const gbpAttributes = (gbpRecord?.attributes ?? pickCaseInsensitiveGBP(gbpRecord, 'Attributes') ?? pickCaseInsensitiveGBP(gbpRecord, 'Attributes (e.g 7/7)') ?? '').toString();
        const gbpQACount = (gbpRecord?.qaCount ?? pickCaseInsensitiveGBP(gbpRecord, 'Q&A Count') ?? pickCaseInsensitiveGBP(gbpRecord, 'Questions & Answers Count') ?? '').toString();
        const gbpTopics = (gbpRecord?.placeTopicsCount ?? pickCaseInsensitiveGBP(gbpRecord, 'Place Topics Count') ?? '').toString();
        const gbpReviewScore = (gbpRecord?.reviewScore ?? pickCaseInsensitiveGBP(gbpRecord, 'Review Score') ?? '').toString();
        const gbpReviewCount = (gbpRecord?.reviewCount ?? pickCaseInsensitiveGBP(gbpRecord, 'Review Count') ?? '').toString();
        const gbpDescription = (gbpRecord?.description ?? pickCaseInsensitiveGBP(gbpRecord, 'Description') ?? '').toString();
        const gbpTotalPhotos = (gbpRecord?.totalPhotos ?? pickCaseInsensitiveGBP(gbpRecord, 'Total Photos') ?? pickCaseInsensitiveGBP(gbpRecord, 'Photo Count') ?? pickCaseInsensitiveGBP(gbpRecord, 'Photos') ?? '').toString();
        const gbpBookOnline = (gbpRecord?.bookOnline ?? pickCaseInsensitiveGBP(gbpRecord, 'Book Online') ?? '').toString();
        const gbpWebsiteGBP = (gbpRecord?.gbpWebsite ?? pickCaseInsensitiveGBP(gbpRecord, 'GBP Website') ?? pickCaseInsensitiveGBP(gbpRecord, 'Website (GBP)') ?? pickCaseInsensitiveGBP(gbpRecord, 'GBP Link') ?? '').toString();

        // Client website pages
        const crawlPages = toArrayGBP(health?.checksAggregate?.pagesList || health?.pagesList || health?.topPages || [])
            .map(p => (typeof p === 'string' ? p : (p?.url || p?.path || '')))
            .filter(Boolean)
            .slice(0, 60);

        const lines = [];
        lines.push('ROLE: You are a senior MedSpa Local SEO strategist focused on Google Business Profile (GBP) performance.');
        lines.push('CONTEXT: The client has generated a GBP report. Use the data below to optimize visibility in local search and align the website with GBP.');
        lines.push('GOAL: Improve local pack rankings and conversions by fixing GBP configuration, strengthening local signals, and mapping categories to relevant pages.');
        lines.push('WORKING MODE:');
        lines.push('- Provide the first actionable step immediately, click-by-click, with exact URLs and fields to update.');
        lines.push('- If needed, perform light independent research (e.g., find official pages for category/attribute definitions or submission portals).');
        lines.push('- Keep outputs concise and operational; include suggested text for categories, description, services, and photos/Q&A.');
        lines.push('- After the first step, ask only 1–3 essential questions to tailor follow-ups.');
        lines.push('');
        lines.push('CLIENT PROFILE:');
        lines.push(`- Clinic Name: ${clinicName}`);
        lines.push(`- Website: ${website || 'N/A'}`);
        lines.push('');
        lines.push('CORE ON-PAGE / TECHNICAL SNAPSHOT:');
        if (titleTag) lines.push(`- Title Tag: ${titleTag}`);
        if (metaDescription) lines.push(`- Meta Description: ${metaDescription}`);
        if (h1) lines.push(`- H1: ${h1}`);
        lines.push(`- Site Speed: ${siteSpeedDisplayMs}`);
        if (pageScore !== null) lines.push(`- Page Score: ${pageScore}`);
        if (typeof referringDomains !== 'undefined') lines.push(`- Referring Domains: ${referringDomains}`);
        if (typeof totalBacklinks !== 'undefined') lines.push(`- Total Backlinks: ${totalBacklinks}`);
        lines.push(`- SSL: ${ (health?.ssl === true || health?.ssl === 'true' || health?.ssl === 'Yes') ? 'Yes' : (health?.ssl === false ? 'No' : 'Unknown') }`);
        lines.push(`- Schema: ${ (health?.hasSchema === true || health?.hasSchema === 'true' || health?.hasSchema === 'Yes') ? 'Yes' : (health?.hasSchema === false ? 'No' : (health?.hasSchemaErrors ? 'Has errors' : 'Unknown')) }`);
        if (pos1 != null || pos23 != null || pos410 != null) {
            lines.push(`- Keywords Position 1: ${pos1 ?? 'N/A'}`);
            lines.push(`- Keywords Position 2-3: ${pos23 ?? 'N/A'}`);
            lines.push(`- Keywords Position 4-10: ${pos410 ?? 'N/A'}`);
        }
        lines.push('');
        lines.push('GOOGLE BUSINESS PROFILE INSIGHTS:');
        lines.push(`- Total Photos: ${gbpTotalPhotos || 'N/A'}`);
        lines.push(`- Book Online: ${gbpBookOnline || 'N/A'}`);
        lines.push(`- GBP Website: ${gbpWebsiteGBP || 'N/A'}`);
        lines.push(`- Claimed: ${gbpClaimed || 'N/A'}`);
        lines.push(`- Primary Category: ${gbpPrimary || 'N/A'}`);
        lines.push(`- Secondary Categories: ${gbpSecondary || 'N/A'}`);
        lines.push(`- Opening Hours: ${gbpHours || 'N/A'}`);
        lines.push(`- Logo: ${gbpLogo || 'N/A'}`);
        lines.push(`- Attributes: ${gbpAttributes || 'N/A'}`);
        lines.push(`- Questions & Answers Count: ${gbpQACount || 'N/A'}`);
        lines.push(`- Place Topics Count: ${gbpTopics || 'N/A'}`);
        lines.push(`- Review Score: ${gbpReviewScore || 'N/A'}`);
        lines.push(`- Review Count: ${gbpReviewCount || 'N/A'}`);
        lines.push(`- Description: ${gbpDescription || 'N/A'}`);
        if (crawlPages.length) {
            lines.push('');
            lines.push('CLIENT WEBSITE PAGES:');
            lines.push(crawlPages.map(p => `- ${p}`).join('\n'));
        }
        lines.push('');
        lines.push('GBP AI REPORT (Client):');
        lines.push(String(reportText || '').trim() || 'N/A');
        lines.push('');
        lines.push('--- End of report ---');
        lines.push('');
        lines.push('OPERATING PLAN (follow in this order):');
        lines.push('1) Analysis + Plan: In 5 bullets, summarize the most impactful GBP improvements (categories, description, services, photos, hours, attributes, Q&A).');
        lines.push('2) First Action (Click-by-click): Give explicit steps to implement now. Prefer the highest-impact gap:');
        lines.push('   - Go to https://business.google.com/ and sign in to your profile.');
        lines.push('   - Edit profile > Business category: set Primary Category (exact string) and add Secondary Categories. Save.');
        lines.push('   - Edit profile > Business information > About: update the Description with the suggested text. Save.');
        lines.push('   - If relevant, update Opening Hours, add Photos, and answer Q&A.');
        lines.push('3) Minimal Questions (≤3): Ask essentials to tailor next steps (primary service areas/neighborhoods, brand voice, key flagship services).');
        lines.push('4) Category-to-Page Mapping: Map each GBP category/service to the best matching website page (or propose a new page) and note content gaps.');
        lines.push('5) Enhancement Checklist: Photos (before/after, team, interior), services list, UTM tracking on profile links, and local citations to reinforce categories.');
        lines.push('6) Measurement Plan: define success (local pack rank on priority terms, calls/directions, views) and how to verify weekly in GBP Insights.');

        let output = lines.join('\n');
        output = formatISOToUSInTextGBP(output);
        return output;
    };

    const handleCopyImplementationPromptGBP = async () => {
        if (isCopying) return;
        try {
            setIsCopying(true);
            setPromptCopyState('');
            if (cachedPrompt) {
                await navigator.clipboard.writeText(cachedPrompt);
                setPromptCopyState('ok');
                return;
            }
            const prompt = await buildGbpImplementationPrompt();
            try {
                const params = new URLSearchParams(window.location.search);
                const workbookId = params.get('workbookId') || '';
                const cacheKey = `impl_prompt_gbp_${workbookId}`;
                const payload = { prompt, aiText: String(reportText || ''), ts: Date.now() };
                sessionStorage.setItem(cacheKey, JSON.stringify(payload));
                setCachedPrompt(prompt);
            } catch {}
            await navigator.clipboard.writeText(prompt);
            setPromptCopyState('ok');
        } catch (e) {
            setPromptCopyState('err');
        } finally {
            setTimeout(() => { setPromptCopyState(''); setIsCopying(false); }, 20000);
        }
    };

    useEffect(() => {
        try {
            const params = new URLSearchParams(window.location.search);
            const workbookId = params.get('workbookId') || '';
            const cacheKey = `impl_prompt_gbp_${workbookId}`;
            const raw = sessionStorage.getItem(cacheKey);
            if (raw) {
                try {
                    const parsed = JSON.parse(raw);
                    const isFresh = parsed && parsed.aiText === String(reportText || '') && (Date.now() - (parsed.ts || 0) < 10 * 60 * 1000);
                    if (isFresh && parsed.prompt) {
                        setCachedPrompt(parsed.prompt);
                        return;
                    }
                } catch {}
            }
            const build = async () => {
                try {
                    const prompt = await buildGbpImplementationPrompt();
                    const payload = { prompt, aiText: String(reportText || ''), ts: Date.now() };
                    sessionStorage.setItem(cacheKey, JSON.stringify(payload));
                    setCachedPrompt(prompt);
                } catch {}
            };
            if ('requestIdleCallback' in window) {
                window.requestIdleCallback(() => { build(); }, { timeout: 3000 });
            } else {
                setTimeout(build, 2500);
            }
        } catch {}
    }, [reportText]);

    return (
        <div className="rounded-2xl shadow-lg overflow-hidden transition-all duration-300 bg-white dark:bg-gray-800" style={{border: 'none', outline: 'none', boxShadow: '0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05)'}}>
            {/* Single Tab Header */}
            <div className="flex p-1 rounded-t-xl dual-reports-header">
                <div className="flex-1 relative px-6 py-4 text-base font-semibold transition-all duration-200 rounded-xl dual-reports-active-blue">
                    <div className="flex items-center justify-between">
                        <div className="flex items-center space-x-2">
                            <span>Google Business Profile Report</span>
                            <InfoTooltip text="AI-generated analysis of your Google Business Profile performance, including insights on visibility, engagement, and optimization opportunities." />
                            <button
                                onClick={(e) => {
                                    e.stopPropagation();
                                    handleToggleExpand();
                                }}
                                className="flex items-center space-x-1 px-2 py-1 rounded-md transition-colors text-gray-500 hover:text-gray-700 text-xs dual-reports-action-hover"
                                title={isExpanded ? "Show less" : "Show more"}
                            >
                                <span>{isExpanded ? "Show Less" : "Show More"}</span>
                                {isExpanded ? (
                                    <ChevronUp className="w-3 h-3" />
                                ) : (
                                    <ChevronDown className="w-3 h-3" />
                                )}
                            </button>
                        </div>
                        <div className="flex items-center space-x-1">
                            <button
                                onClick={(e) => {
                                    e.stopPropagation();
                                    handleCopyReport();
                                }}
                                className={`p-1 rounded-md transition-colors ${
                                    copySuccess === 'copied'
                                        ? 'text-blue-600'
                                        : 'text-blue-600 hover:text-blue-800 hover:bg-blue-50 dual-reports-action-hover'
                                }`}
                                title="Copy report"
                            >
                                {copySuccess === 'copied' ? (
                                    <Check className="w-4 h-4" />
                                ) : (
                                    <Copy className="w-4 h-4" />
                                )}
                            </button>
                            <button
                                onClick={(e) => {
                                    e.stopPropagation();
                                    handleDownloadReport();
                                }}
                                className="p-1 rounded-md transition-colors text-blue-600 hover:text-blue-800 hover:bg-blue-50 dual-reports-action-hover"
                                title="Download report as text file"
                            >
                                <Download className="w-4 h-4" />
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            {/* Content Area */}
            <div className="rounded-b-xl dual-reports-content">
                <div className="p-6">
                    {/* Preview/Summary when collapsed */}
                    {!isExpanded && (
                        <div className="space-y-2">
                            <div className="relative">
                                {/* Text content */}
                                <div 
                                    className="text-sm leading-relaxed overflow-hidden select-text cursor-text dual-reports-text"
                                    style={{ maxHeight: '160px' }}
                                    dangerouslySetInnerHTML={{ __html: formattedContent }}
                                />
                                {/* Only show fade if not placeholder text */}
                                {!isPlaceholderOnly && (
                                    <div className="absolute bottom-0 left-0 right-0 h-8 pointer-events-none dual-reports-fade-light"></div>
                                )}
                            </div>
                            
                            {/* Clickable area to expand - only show if not placeholder */}
                            {!isPlaceholderOnly && (
                                <div 
                                    className="text-center py-2 cursor-pointer rounded-lg transition-colors text-sm dual-reports-show-more"
                                    onClick={handleToggleExpand}
                                >
                                    Show More
                                </div>
                            )}
                        </div>
                    )}

                    {/* Full content when expanded */}
                    {isExpanded && (
                        <div className="space-y-2">
                            {/* Text content */}
                            <div 
                                className="prose prose-base max-w-none leading-relaxed select-text cursor-text dual-reports-text prose-p:my-5 prose-h1:mt-7 prose-h1:mb-5 prose-h2:mt-6 prose-h2:mb-4 prose-h3:mt-5 prose-h3:mb-3 prose-ul:my-3 prose-ol:my-3"
                                dangerouslySetInnerHTML={{ __html: formattedContent }}
                            />
                            {/* Action Buttons - above Show Less, bottom-right inside report */}
                            <div className="mt-2 flex items-center justify-end space-x-3">
                                <button
                                    onClick={handleCopyImplementationPromptGBP}
                                    className="px-4 py-2 rounded-lg font-semibold text-white bg-gradient-to-r from-blue-600 to-blue-700 hover:from-blue-700 hover:to-blue-800 shadow-md disabled:opacity-60"
                                    title="Copy implementation prompt"
                                    disabled={isCopying}
                                >
                                    Implement Recommendations Myself
                                </button>
                                <button
                                    onClick={() => window.open('https://www.skool.com/forever-booked/classroom/a23620ff?md=00953c20f4574ccdb6d5edfe0a0298ed', '_blank')}
                                    className="px-4 py-2 rounded-lg font-semibold text-white"
                                    style={{ backgroundColor: '#F8857E' }}
                                    title="Request paid implementation"
                                >
                                    Request Forever Booked Implement (Paid SEO)
                                </button>
                            </div>
                            {!!promptCopyState && (
                                <div className={`mt-1 text-right text-sm ${promptCopyState==='ok'?'text-green-600':'text-red-600'}`}>
                                    {promptCopyState==='ok' 
                                        ? 'Prompt copied! Open your favourite AI model and paste it into the chat to get started.' 
                                        : 'Failed to build or copy the prompt. Please try again in a moment.'}
                                </div>
                            )}
                        </div>
                    )}
                </div>
            </div>
        </div>
    );
};
/* Single Backlinks Report Component */
const BacklinksReport = ({ reportText }) => {
    const [isExpanded, setIsExpanded] = useState(false);
    const [copySuccess, setCopySuccess] = useState('');
    const [isCopying, setIsCopying] = useState(false);
    const [promptCopyState, setPromptCopyState] = useState('');
    const [cachedPrompt, setCachedPrompt] = useState('');

    // Icons
    const ChevronDown = createIcon(<polyline points="6 9 12 15 18 9" />);
    const ChevronUp = createIcon(<polyline points="18 15 12 9 6 15" />);
    const Copy = createIcon(
        <>
            <rect x="9" y="9" width="13" height="13" rx="2" ry="2" />
            <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1" />
        </>
    );
    const Download = createIcon(
        <>
            <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4" />
            <polyline points="7 10 12 15 17 10" />
            <line x1="12" y1="15" x2="12" y2="3" />
        </>
    );
    const Check = createIcon(<polyline points="20 6 9 17 4 12" />);

    const handleToggleExpand = () => {
        setIsExpanded(!isExpanded);
    };

    const handleCopyReport = async () => {
        try {
            await navigator.clipboard.writeText(reportText || '');
            setCopySuccess('copied');
            setTimeout(() => setCopySuccess(''), 2000);
        } catch (err) {
            console.error('Failed to copy text: ', err);
        }
    };

    const handleDownloadReport = () => {
        const element = document.createElement('a');
        const file = new Blob([reportText || ''], { type: 'text/plain' });
        element.href = URL.createObjectURL(file);
        element.download = 'backlinks-targets-report.txt';
        document.body.appendChild(element);
        element.click();
        document.body.removeChild(element);
    };

    // ---- Prompt Builder for "Implement Recommendations Myself" (Backlinks) ----
    // Local ISO timestamp formatter for this component
    const formatISOToUSInTextBL = (text) => {
        try {
            return String(text || '').replace(/\b\d{4}-\d{2}-\d{2}T\d{2}:\d{2}:\d{2}(?:\.\d+)?Z\b/g, (m) => {
                const d = new Date(m);
                if (isNaN(d.getTime())) return m;
                return d.toLocaleString('en-US', {
                    year: 'numeric', month: 'short', day: '2-digit',
                    hour: 'numeric', minute: '2-digit'
                });
            });
        } catch { return text; }
    };

    const readSessionJsonBL = (key) => {
        try {
            const raw = sessionStorage.getItem(key);
            return raw ? JSON.parse(raw) : null;
        } catch { return null; }
    };
    const fetchSectionsBL = (workbookId, sections) => new Promise((resolve) => {
        const base = 'https://script.google.com/macros/s/AKfycbxfOMp8d_eCVH4lFD0PNuFU1wH-gyWOwRt2EuME7GQJ4U73ZwpPDciohDH3C566YLWq/exec';
        const url = `${base}?workbookId=${workbookId}&sections=${encodeURIComponent(sections)}`;
        fetchWithCorsWorkaround(url, (err, data) => {
            resolve(err ? null : data);
        });
    });
    const toArrayBL = (v) => Array.isArray(v) ? v : (v ? [v] : []);
    const pickCaseInsensitiveBL = (obj, keyLike) => {
        if (!obj) return undefined;
        const entries = Object.entries(obj);
        const found = entries.find(([k]) => k.toLowerCase() === keyLike.toLowerCase());
        if (found) return found[1];
        const fuzzy = entries.find(([k]) => k.toLowerCase().includes(keyLike.toLowerCase()));
        return fuzzy ? fuzzy[1] : undefined;
    };

    const buildBacklinksImplementationPrompt = async () => {
        const params = new URLSearchParams(window.location.search);
        const workbookId = params.get('workbookId') || '';

        // Try caches first
        const blCache = readSessionJsonBL(`backlinks_${workbookId}`);
        const dashCache = readSessionJsonBL(`dashboard_data_${workbookId}`);
        const kwCache = readSessionJsonBL(`keywords_${workbookId}`);

        let backlinksSummary = blCache?.backlinksSummary || {};
        let backlinksTable = blCache?.backlinksTable || {};
        let overviewData = dashCache?.overviewData || [];
        let websiteStats = null;
        let gbpInsights = null;
        let keywordsSummary = kwCache?.keywordsSummary || {};
        let keywordsTableForFallback = null;

        // Attempt to read generic cache for websiteStats
        const base = 'https://script.google.com/macros/s/AKfycbxfOMp8d_eCVH4lFD0PNuFU1wH-gyWOwRt2EuME7GQJ4U73ZwpPDciohDH3C566YLWq/exec';
        const wsUrl = `${base}?workbookId=${workbookId}&sections=websiteStats`;
        const wsCache = readSessionJsonBL(`seo_data_${wsUrl}`);
        if (wsCache?.websiteStats) websiteStats = wsCache.websiteStats;

        // Fetch missing in one shot
        if (!websiteStats || !overviewData || Object.keys(backlinksTable).length === 0) {
            const data = await fetchSectionsBL(workbookId, 'websiteStats,backlinksSummary,backlinksTable,dashboard,gbpInsights,keywordsSummary,keywordsTable');
            if (data) {
                websiteStats = websiteStats || data.websiteStats || data?.websiteStats;
                backlinksSummary = Object.keys(backlinksSummary).length ? backlinksSummary : (data.backlinksSummary || {});
                backlinksTable = Object.keys(backlinksTable).length ? backlinksTable : (data.backlinksTable || {});
                if ((!overviewData || overviewData.length === 0) && data.dashboard?.overviewData) overviewData = data.dashboard.overviewData;
                if (!keywordsSummary && data.keywordsSummary) keywordsSummary = data.keywordsSummary;
                if (data.keywordsTable) keywordsTableForFallback = data.keywordsTable;
                if (data.gbpInsights) gbpInsights = data.gbpInsights;
            }
        }
        if (!gbpInsights) {
            const gbpData = await fetchSectionsBL(workbookId, 'gbpInsights');
            if (gbpData && gbpData.gbpInsights) gbpInsights = gbpData.gbpInsights;
        }

        // Identify client site (first key)
        const siteNamesAll = Object.keys(backlinksTable || {});
        const clientSite = siteNamesAll.length > 0 ? siteNamesAll[0] : (backlinksSummary?.siteName || 'Client');
        const clientLinks = clientSite ? (backlinksTable[clientSite] || []) : [];

        // Competitor backlinks top 20 each (dofollow first, low spam score, then higher rank)
        const competitorSites = siteNamesAll.slice(1);
        const competitorBacklinks = competitorSites.map(name => {
            const rows = (backlinksTable[name] || []).slice();
            rows.sort((a, b) => {
                const af = a.following ? 1 : 0; const bf = b.following ? 1 : 0;
                const aSpam = isFinite(Number(a.spamScore)) ? Number(a.spamScore) : 999;
                const bSpam = isFinite(Number(b.spamScore)) ? Number(b.spamScore) : 999;
                const aRank = isFinite(Number(a.rank)) ? Number(a.rank) : -1;
                const bRank = isFinite(Number(b.rank)) ? Number(b.rank) : -1;
                if (bf !== af) return bf - af; // dofollow first
                if (aSpam !== bSpam) return aSpam - bSpam; // lower spam first
                return bRank - aRank; // higher rank first
            });
            const top20 = rows.slice(0, 20).map(r => ({ url: r.backlinkUrl, follow: !!r.following, spam: Number(r.spamScore ?? 0), rank: Number(r.rank ?? 0), title: r.title || '', link: r.linkUrl || '' }));
            return { name, top20 };
        });

        // Website stats
        const health = websiteStats?.healthData || {};
        const tseo = toArrayBL(websiteStats?.technicalSeoData || []);
        const perf = toArrayBL(websiteStats?.competitorPerfData || []).find(x => x?.isClient) || {};
        const siteSpeedMs = Number(health?.siteSpeed) || 0;
        const siteSpeedDisplayMs = isFinite(siteSpeedMs) && siteSpeedMs > 0 ? `${Math.round(siteSpeedMs)} ms` : 'N/A';
        const pageScore = isFinite(Number(health?.pageScore)) ? Number(health.pageScore) : null;
        const referringDomains = isFinite(Number(perf['Referring Domains'])) ? Number(perf['Referring Domains']) : undefined;

        // Extract H1/Title/Meta for client
        const tseoClient = tseo.find(s => (s?.isClient || (s?.clinicName || s?.name || '').toLowerCase().includes('client')) ) || tseo[0] || {};
        const titleTag = tseoClient?.title || '';
        const metaDescription = tseoClient?.description || '';
        const h1 = tseoClient?.h1 || '';
        const website = tseoClient?.website || '';
        const clinicName = tseoClient?.clinicName || clientSite || 'Client';

        // GBP fields
        let gbpRecord = null;
        if (Array.isArray(gbpInsights)) {
            gbpRecord = gbpInsights.find(r => {
                const at = String(pickCaseInsensitiveBL(r, 'Account Type') || pickCaseInsensitiveBL(r, 'AccountType') || pickCaseInsensitiveBL(r, 'Type') || '').toLowerCase();
                return at.includes('client');
            }) || gbpInsights[0] || null;
        } else if (gbpInsights && typeof gbpInsights === 'object') {
            gbpRecord = gbpInsights;
        }
        const primaryCategory = (gbpRecord?.primaryCategory || pickCaseInsensitiveBL(gbpRecord, 'Primary Categorie') || pickCaseInsensitiveBL(gbpRecord, 'Primary Category') || '').toString();
        const secondaryCategories = (gbpRecord?.secondaryCategories || pickCaseInsensitiveBL(gbpRecord, 'Secondary Categories') || '').toString();
        const gbpDescription = (gbpRecord?.description || pickCaseInsensitiveBL(gbpRecord, 'Description') || '').toString();
        const reviewScore = (gbpRecord?.reviewScore || pickCaseInsensitiveBL(gbpRecord, 'Review Score') || '').toString();
        const reviewCount = (gbpRecord?.reviewCount || pickCaseInsensitiveBL(gbpRecord, 'Review Count') || '').toString();
        const photoCount = (gbpRecord?.photoCount || gbpRecord?.totalPhotos || pickCaseInsensitiveBL(gbpRecord, 'Photo Count') || pickCaseInsensitiveBL(gbpRecord, 'Total Photos') || '').toString();
        const qaCount = (gbpRecord?.qaCount || pickCaseInsensitiveBL(gbpRecord, 'QACount') || pickCaseInsensitiveBL(gbpRecord, 'Q&A Count') || '').toString();

        // Keyword position buckets (from On-Page/Keywords summary if available)
        let pos1 = keywordsSummary['Position 1'] ?? keywordsSummary['Keywords Position 1'] ?? keywordsSummary.pos1 ?? null;
        let pos23 = keywordsSummary['Position 2-3'] ?? keywordsSummary['Keywords Position 2-3'] ?? keywordsSummary.pos23 ?? null;
        let pos410 = keywordsSummary['Position 4-10'] ?? keywordsSummary['Keywords Position 4-10'] ?? keywordsSummary.pos410 ?? null;
        // Fallback: compute from keywords table if values are missing
        if ((pos1 == null && pos23 == null && pos410 == null) && keywordsTableForFallback) {
            const rows = (keywordsTableForFallback[clientSite] || []).filter(r => Number(r?.rank_now) > 0);
            let c1 = 0, c23 = 0, c410c = 0;
            for (const r of rows) {
                const rank = Number(r.rank_now);
                if (!isFinite(rank)) continue;
                if (rank === 1) c1++;
                else if (rank >= 2 && rank <= 3) c23++;
                else if (rank >= 4 && rank <= 10) c410c++;
            }
            pos1 = c1; pos23 = c23; pos410 = c410c;
        }

        // Compose prompt
        const lines = [];
        lines.push('ROLE: You are a senior MedSpa SEO strategist and link-building partner.');
        lines.push('CONTEXT: The client has generated a backlinks-focused report. Use the data below to craft a practical link acquisition plan, prioritizing low-risk, high-impact opportunities.');
        lines.push('GOAL: Improve authority and rankings by acquiring quality, relevant backlinks, reclaiming lost links, and strengthening local signals.');
        lines.push('WORKING MODE:');
        lines.push('- Present a succinct plan and the first actionable step immediately.');
        lines.push('- The first action must be click-by-click with direct URL(s) to visit (e.g., top citation/directories or specific outreach targets).');
        lines.push('- If needed, perform light independent research to validate targets or find contact/submission pages.');
        lines.push('- Keep outputs concise and operational: include target URLs, outreach angle, suggested anchor texts, and risk notes.');
        lines.push('- After the first step, ask only 1–3 essential questions (CMS/platform optional).');
        lines.push('');
        lines.push('CLIENT PROFILE:');
        lines.push(`- Clinic Name: ${clinicName}`);
        lines.push(`- Website: ${website || 'N/A'}`);
        lines.push('');
        lines.push('CORE ON-PAGE / TECHNICAL SNAPSHOT:');
        if (titleTag) lines.push(`- Title Tag: ${titleTag}`);
        if (metaDescription) lines.push(`- Meta Description: ${metaDescription}`);
        if (h1) lines.push(`- H1: ${h1}`);
        lines.push(`- Site Speed: ${siteSpeedDisplayMs}`);
        if (pageScore !== null) lines.push(`- Page Score: ${pageScore}`);
        if (typeof referringDomains !== 'undefined') lines.push(`- Referring Domains: ${referringDomains}`);
        lines.push(`- SSL: ${ (health?.ssl === true || health?.ssl === 'true' || health?.ssl === 'Yes') ? 'Yes' : (health?.ssl === false ? 'No' : 'Unknown') }`);
        lines.push(`- Schema: ${ (health?.hasSchema === true || health?.hasSchema === 'true' || health?.hasSchema === 'Yes') ? 'Yes' : (health?.hasSchema === false ? 'No' : (health?.hasSchemaErrors ? 'Has errors' : 'Unknown')) }`);
        if (pos1 != null || pos23 != null || pos410 != null) {
            lines.push(`- Keywords Position 1: ${pos1 ?? 'N/A'}`);
            lines.push(`- Keywords Position 2-3: ${pos23 ?? 'N/A'}`);
            lines.push(`- Keywords Position 4-10: ${pos410 ?? 'N/A'}`);
        }
        lines.push('');
        lines.push('GOOGLE BUSINESS PROFILE INSIGHTS:');
        lines.push(`- Primary Category: ${primaryCategory || 'N/A'}`);
        lines.push(`- Secondary Categories: ${secondaryCategories || 'N/A'}`);
        lines.push(`- Description: ${gbpDescription || 'N/A'}`);
        lines.push(`- Stats: ${[ `Review Score: ${reviewScore || 'N/A'}`, `Reviews: ${reviewCount || 'N/A'}`, `Photos: ${photoCount || 'N/A'}`, `Q&A: ${qaCount || 'N/A'}` ].join(' | ')}`);
        lines.push('');
        lines.push('CLIENT BACKLINKS (all):');
        if (clientLinks.length) {
            lines.push(clientLinks.map(r => `- ${r.backlinkUrl} — ${r.following?'dofollow':'nofollow'} — spam ${r.spamScore ?? 'N/A'} — rank ${r.rank ?? 'N/A'}${r.title?` — ${r.title}`:''}`).join('\n'));
        } else {
            lines.push('- N/A');
        }
        lines.push('');
        lines.push('COMPETITOR BACKLINKS (Top 20 each):');
        competitorBacklinks.forEach(c => {
            lines.push(`• ${c.name}:`);
            if (c.top20.length) {
                lines.push(c.top20.map(r => `  - ${r.url} — ${r.follow?'dofollow':'nofollow'} — spam ${r.spam} — rank ${r.rank}${r.title?` — ${r.title}`:''}`).join('\n'));
            } else {
                lines.push('  - N/A');
            }
        });
        lines.push('');
        lines.push('BACKLINKS AI REPORT (Client):');
        lines.push(String(reportText || '').trim() || 'N/A');
        lines.push('');
        lines.push('--- End of report ---');
        lines.push('');
        lines.push('OPERATING PLAN (follow in this order):');
        lines.push('1) Analysis + Plan: In 5 bullets, summarize the highest-impact backlink opportunities (citations, partnerships, PR mentions, resource pages, guest posts, supplier/brand links).');
        lines.push('2) First Action (Click-by-click): Provide explicit steps to execute now. Prefer the quickest, lowest-risk win (e.g., top citation submission or reclaiming a lost link). Include:');
        lines.push('   - Exact URL(s) to visit to submit or contact.');
        lines.push('   - What to fill in (business name, website, categories).');
        lines.push('   - Suggested anchor text and target page on client site.');
        lines.push('   - If outreach is needed, include a short email template.');
        lines.push('3) Minimal Questions (≤3): Ask ONLY essentials to refine next steps (primary service areas/cities to prioritize, CMS if needed for adding links, brand voice for outreach).');
        lines.push('4) Prioritized Prospect List: 10–20 opportunities with rationale (relevance, spam score, authority proxies like rank metric, competitor overlap).');
        lines.push('5) Outreach/Submission Tracker: Provide a simple checklist with status fields.');
        lines.push('6) Measurement Plan: define success (new links acquired, referring domains, traffic to target pages) and how to verify monthly.');

        let output = lines.join('\n');
        output = formatISOToUSInTextBL(output);
        return output;
    };

    const handleCopyImplementationPromptBL = async () => {
        if (isCopying) return;
        try {
            setIsCopying(true);
            setPromptCopyState('');
            // If we have a prebuilt prompt ready, copy instantly
            if (cachedPrompt) {
                await navigator.clipboard.writeText(cachedPrompt);
                setPromptCopyState('ok');
                return;
            }
            // Fallback: build on-demand, then cache and copy
            const prompt = await buildBacklinksImplementationPrompt();
            try {
                const params = new URLSearchParams(window.location.search);
                const workbookId = params.get('workbookId') || '';
                const cacheKey = `impl_prompt_backlinks_${workbookId}`;
                const payload = { prompt, aiText: String(reportText || ''), ts: Date.now() };
                sessionStorage.setItem(cacheKey, JSON.stringify(payload));
                setCachedPrompt(prompt);
            } catch {}
            await navigator.clipboard.writeText(prompt);
            setPromptCopyState('ok');
        } catch (e) {
            setPromptCopyState('err');
        } finally {
            setTimeout(() => { setPromptCopyState(''); setIsCopying(false); }, 20000);
        }
    };

    // Prebuild the prompt after initial render (idle or short delay) and cache it
    useEffect(() => {
        try {
            const params = new URLSearchParams(window.location.search);
            const workbookId = params.get('workbookId') || '';
            const cacheKey = `impl_prompt_backlinks_${workbookId}`;
            const raw = sessionStorage.getItem(cacheKey);
            if (raw) {
                try {
                    const parsed = JSON.parse(raw);
                    const isFresh = parsed && parsed.aiText === String(reportText || '') && (Date.now() - (parsed.ts || 0) < 10 * 60 * 1000);
                    if (isFresh && parsed.prompt) {
                        setCachedPrompt(parsed.prompt);
                        return;
                    }
                } catch {}
            }
            const build = async () => {
                try {
                    const prompt = await buildBacklinksImplementationPrompt();
                    const payload = { prompt, aiText: String(reportText || ''), ts: Date.now() };
                    sessionStorage.setItem(cacheKey, JSON.stringify(payload));
                    setCachedPrompt(prompt);
                } catch {}
            };
            if ('requestIdleCallback' in window) {
                window.requestIdleCallback(() => { build(); }, { timeout: 3000 });
            } else {
                setTimeout(build, 2500);
            }
        } catch {}
    }, [reportText]);

    const handleRequestImplementBL = () => {
        window.open('https://www.skool.com/forever-booked/classroom/a23620ff?md=00953c20f4574ccdb6d5edfe0a0298ed', '_blank');
    };

    // Reuse robust inline+block markdown parser from DualReports
    const escapeHtmlBL = (str) => String(str || '')
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;');
    const applyInlineMarkdownBL = (str) => {
        let s = str;
        s = s.replace(/\u00A0/g, ' ').replace(/[\u200B-\u200D\uFEFF]/g, '');
        s = s.replace(/\*\*([\s\S]+?)\*\*/g, '<strong class="font-bold">$1</strong>');
        s = s.replace(/__([\s\S]+?)__/g, '<strong class="font-bold">$1</strong>');
        s = s.replace(/(^|[^*])\*(?!\*)([^*]+)\*(?!\*)/g, '$1<em>$2</em>');
        s = s.replace(/_([^_]+)_/g, '<em>$1</em>');
        s = s.replace(/(https?:\/\/[^\s<]+)/g, '<a href="$1" target="_blank" rel="noopener" class="text-blue-600 underline">$1<\/a>');
        return s;
    };
    const parseMarkdownToHtmlBL = (markdown) => {
        const lines = escapeHtmlBL(markdown).replace(/\r\n?/g, '\n').split('\n');
        const html = [];
        let inUl = false, inOl = false, blankStreak = 0, inTable = false; let tableRows = [];
        const closeLists = () => { if (inUl) { html.push('</ul>'); inUl = false; } if (inOl) { html.push('</ol>'); inOl = false; } };
        const flushTable = () => {
            if (!inTable || tableRows.length === 0) return;
            let headerCells = null;
            if (tableRows.length >= 2 && tableRows[1].every(cell => /^:?-{3,}:?$/.test(cell))) { headerCells = tableRows[0]; tableRows = tableRows.slice(2); }
            const thead = headerCells ? '<thead><tr>' + headerCells.map((c) => `<th class=\"border border-gray-200 px-3 py-2 font-semibold bg-gray-100 dark:bg-gray-700 text-gray-900 dark:text-gray-100\">${applyInlineMarkdownBL(c)}</th>`).join('') + '</tr></thead>' : '';
            const tbody = '<tbody>' + tableRows.map(row => ('<tr>' + row.map((c,i) => `<td class=\"border border-gray-200 px-3 py-2 ${i===0?'font-medium':''} whitespace-nowrap\">${applyInlineMarkdownBL(c)}</td>`).join('') + '</tr>')).join('') + '</tbody>';
            html.push(`<div class=\"my-4\"><div class=\"max-w-full overflow-x-auto\"><table class=\"table-auto w-auto text-sm border border-gray-200 rounded-lg border-collapse\">${thead}${tbody}</table></div></div>`);
            inTable = false; tableRows = [];
        };
        lines.forEach(raw => {
            const line = raw.replace(/\s+$/,'').replace(/^\s+/, '');
            if (!line) { blankStreak++; closeLists(); flushTable(); return; }
            if (blankStreak > 0) { html.push(`<div class=\"${blankStreak >= 2 ? 'my-8' : 'my-5'}\"></div>`); blankStreak = 0; }
            if (/^---+$/.test(line)) { closeLists(); flushTable(); html.push('<hr class=\"my-8 border-t border-gray-200\" />'); return; }
            if (/^####\s+/.test(line)) { closeLists(); flushTable(); html.push(`<h4 class=\"mt-4 mb-2 font-semibold text-lg leading-tight\">${applyInlineMarkdownBL(line.replace(/^####\s+/, ''))}</h4>`); return; }
            if (/^###\s+/.test(line)) { closeLists(); flushTable(); html.push(`<h3 class=\"mt-5 mb-3 font-semibold text-xl leading-tight\">${applyInlineMarkdownBL(line.replace(/^###\s+/, ''))}</h3>`); return; }
            if (/^##\s+/.test(line)) { closeLists(); flushTable(); html.push(`<h2 class=\"mt-6 mb-4 font-semibold text-2xl leading-tight\">${applyInlineMarkdownBL(line.replace(/^##\s+/, ''))}</h2>`); return; }
            if (/^#\s+/.test(line)) { closeLists(); flushTable(); html.push(`<h1 class=\"mt-7 mb-5 font-bold text-4xl leading-tight\">${applyInlineMarkdownBL(line.replace(/^#\s+/, ''))}</h1>`); return; }
            if (/^\|.*\|$/.test(line)) { const cells = line.replace(/^\|/, '').replace(/\|$/, '').split('|').map(c => c.trim()); if (!inTable) { inTable = true; tableRows = []; } tableRows.push(cells); return; }
            flushTable();
            if (/^\d+\.\s+/.test(line)) { if (!inOl) { closeLists(); html.push('<ol class=\"list-decimal pl-5 my-2 space-y-1.5\">'); inOl = true; } html.push(`<li>${applyInlineMarkdownBL(line.replace(/^\d+\.\s+/, ''))}</li>`); return; }
            if (/^(?:-|\u2022|\u2013)\s+/.test(line)) { if (!inUl) { closeLists(); html.push('<ul class=\"list-disc pl-5 my-2 space-y-1.5\">'); inUl = true; } html.push(`<li>${applyInlineMarkdownBL(line.replace(/^(?:-|\u2022|\u2013)\s+/, ''))}</li>`); return; }
            closeLists(); html.push(`<p class=\"my-5\">${applyInlineMarkdownBL(line)}</p>`);
        });
        closeLists(); flushTable();
        let result = html.join('\n');
        result = result.replace(/(<p[^>]*>[^<:]*:[^<]*<\/p>)\s*(<div class=\"my-5\"><\/div>)/g, '$1');
        return result;
    };
    const formattedContent = parseMarkdownToHtmlBL(String(reportText || 'Backlinks targeting report will appear here once generated.'));

    // Check if this is just placeholder text
    const isPlaceholderOnly = !reportText || reportText.trim() === '' || reportText === 'Backlinks targeting report will appear here once generated.';

    return (
        <div className="rounded-2xl shadow-lg overflow-hidden transition-all duration-300 bg-white dark:bg-gray-800" style={{border: 'none', outline: 'none', boxShadow: '0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05)'}}>
            {/* Single Tab Header */}
            <div className="flex p-1 rounded-t-xl dual-reports-header">
                <div className="flex-1 relative px-6 py-4 text-base font-semibold transition-all duration-200 rounded-xl dual-reports-active-blue">
                    <div className="flex items-center justify-between">
                                                   <div className="flex items-center space-x-2">
                               <span>Backlinks to Target this Month</span>
                            <InfoTooltip text="AI-generated recommendations for high-value backlink opportunities to pursue this month based on competitor analysis and market research." />
                            <button
                                onClick={(e) => {
                                    e.stopPropagation();
                                    handleToggleExpand();
                                }}
                                className="flex items-center space-x-1 px-2 py-1 rounded-md transition-colors text-gray-500 hover:text-gray-700 text-xs dual-reports-action-hover"
                                title={isExpanded ? "Show less" : "Show more"}
                            >
                                <span>{isExpanded ? "Show Less" : "Show More"}</span>
                                {isExpanded ? (
                                    <ChevronUp className="w-3 h-3" />
                                ) : (
                                    <ChevronDown className="w-3 h-3" />
                                )}
                            </button>
                        </div>
                        <div className="flex items-center space-x-1">
                            <button
                                onClick={(e) => {
                                    e.stopPropagation();
                                    handleCopyReport();
                                }}
                                className={`p-1 rounded-md transition-colors ${
                                    copySuccess === 'copied'
                                        ? 'text-green-600'
                                        : 'text-blue-600 hover:text-blue-800 hover:bg-blue-50 dual-reports-action-hover'
                                }`}
                                title="Copy report"
                            >
                                {copySuccess === 'copied' ? (
                                    <Check className="w-4 h-4" />
                                ) : (
                                    <Copy className="w-4 h-4" />
                                )}
                            </button>
                            <button
                                onClick={(e) => {
                                    e.stopPropagation();
                                    handleDownloadReport();
                                }}
                                className="p-1 rounded-md transition-colors text-blue-600 hover:text-blue-800 hover:bg-blue-50 dual-reports-action-hover"
                                title="Download report as text file"
                            >
                                <Download className="w-4 h-4" />
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            {/* Content Area */}
            <div className="rounded-b-xl dual-reports-content">
                <div className="p-6">
                    {/* Preview/Summary when collapsed */}
                    {!isExpanded && (
                        <div className="space-y-2">
                            <div className="relative">
                                {/* Text content */}
                                <div 
                                    className="text-sm leading-relaxed overflow-hidden select-text cursor-text dual-reports-text"
                                    style={{ maxHeight: '160px' }}
                                    dangerouslySetInnerHTML={{ __html: formattedContent }}
                                />
                                {/* Only show fade if not placeholder text */}
                                {!isPlaceholderOnly && (
                                    <div className="absolute bottom-0 left-0 right-0 h-8 pointer-events-none dual-reports-fade-light"></div>
                                )}
                            </div>
                            
                            {/* Clickable area to expand - only show if not placeholder */}
                            {!isPlaceholderOnly && (
                                <div 
                                    className="text-center py-2 cursor-pointer rounded-lg transition-colors text-sm dual-reports-show-more"
                                    onClick={handleToggleExpand}
                                >
                                    Show More
                                </div>
                            )}
                        </div>
                    )}

                    {/* Full content when expanded */}
                    {isExpanded && (
                        <div className="space-y-2">
                            {/* Text content */}
                            <div 
                                className="prose prose-sm max-w-none leading-relaxed select-text cursor-text dual-reports-text"
                                dangerouslySetInnerHTML={{ __html: formattedContent }}
                            />
                            {/* Action Buttons - above Show Less, bottom-right inside report */}
                            <div className="mt-2 flex items-center justify-end space-x-3">
                                <button
                                    onClick={handleCopyImplementationPromptBL}
                                    className="px-4 py-2 rounded-lg font-semibold text-white bg-gradient-to-r from-blue-600 to-blue-700 hover:from-blue-700 hover:to-blue-800 shadow-md disabled:opacity-60"
                                    title="Copy implementation prompt"
                                    disabled={isCopying}
                                >
                                    Implement Recommendations Myself
                                </button>
                                <button
                                    onClick={handleRequestImplementBL}
                                    className="px-4 py-2 rounded-lg font-semibold text-white"
                                    style={{ backgroundColor: '#F8857E' }}
                                    title="Request paid implementation"
                                >
                                    Request Forever Booked Implement (Paid SEO)
                                </button>
                            </div>
                            {!!promptCopyState && (
                                <div className={`mt-1 text-right text-sm ${promptCopyState==='ok'?'text-green-600':'text-red-600'}`}>
                                    {promptCopyState==='ok' 
                                        ? 'Prompt copied! Open your favourite AI model and paste it into the chat to get started.' 
                                        : 'Failed to build or copy the prompt. Please try again in a moment.'}
                                </div>
                            )}
                            
                            {/* Clickable area to collapse */}
                            <div
                                className="text-center py-2 cursor-pointer rounded-lg transition-colors text-sm dual-reports-show-more"
                                onClick={handleToggleExpand}
                            >
                                Show Less
                            </div>
                        </div>
                    )}
                </div>
            </div>
        </div>
    );
};
/* Dual Report Section (Competitor Analysis + Error Report) */
const DualReports = ({ competitorText, errorText }) => {
    const [activeTab, setActiveTab] = useState('competitor');
    const [isExpanded, setIsExpanded] = useState(false);
    const [copySuccess, setCopySuccess] = useState('');
    const [isCopyingError, setIsCopyingError] = useState(false);
    const [promptCopyStateError, setPromptCopyStateError] = useState('');
    const [cachedErrorPrompt, setCachedErrorPrompt] = useState('');
    const [isCopyingCompetitor, setIsCopyingCompetitor] = useState(false);
    const [promptCopyStateCompetitor, setPromptCopyStateCompetitor] = useState('');
    const [cachedCompetitorPrompt, setCachedCompetitorPrompt] = useState('');


    const tabs = [
        {
            id: 'competitor',
            title: 'Competitor Analysis',
            content: competitorText,
            color: 'blue',
            info: 'AI-powered analysis comparing your website performance against top competitors in your market.'
        },
        {
            id: 'error',
            title: 'Error Report',
            content: errorText,
            color: 'red',
            info: 'Comprehensive technical issues and optimization opportunities identified during website crawling.'
        }
    ];

    const activeTabData = tabs.find(tab => tab.id === activeTab);
    const currentContent = activeTabData?.content || 'No report available yet.';

    const handleToggleExpand = () => {
        setIsExpanded(!isExpanded);
    };

    const handleCopyReport = async () => {
        try {
            const plainText = String(currentContent)
                .replace(/<br\s*\/?>/gi, '\n')
                .replace(/<strong>(.*?)<\/strong>/gi, '**$1**')
                .replace(/<em>(.*?)<\/em>/gi, '*$1*')
                .replace(/<[^>]*>/g, '');
            await navigator.clipboard.writeText(plainText);
            setCopySuccess(activeTab);
            setTimeout(() => setCopySuccess(''), 2000);
        } catch (err) {
            console.error('Failed to copy text: ', err);
        }
    };

    const handleDownloadReport = () => {
        const plainText = String(currentContent)
            .replace(/<br\s*\/?>/gi, '\n')
            .replace(/<strong>(.*?)<\/strong>/gi, '**$1**')
            .replace(/<em>(.*?)<\/em>/gi, '*$1*')
            .replace(/<[^>]*>/g, '');

        const baseFilename = activeTabData?.title.replace(/\s+/g, '_') || 'Report';
        const blob = new Blob([plainText], { type: 'text/plain' });
        const filename = `${baseFilename}.txt`;
        
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = filename;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
    };

    // Icons
    const ChevronDown = createIcon(<polyline points="6 9 12 15 18 9" />);
    const ChevronUp = createIcon(<polyline points="18 15 12 9 6 15" />);
    const Copy = createIcon(
        <>
            <rect x="9" y="9" width="13" height="13" rx="2" ry="2" />
            <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1" />
        </>
    );
    const Download = createIcon(
        <>
            <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4" />
            <polyline points="7 10 12 15 17 10" />
            <line x1="12" y1="15" x2="12" y2="3" />
        </>
    );
    const Check = createIcon(<polyline points="20 6 9 17 4 12" />);

    // Markdown parsing for Competitor Analysis (headings, hr, lists, bold/italic)
    const escapeHtml = (str) => String(str || '')
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;');

    const applyInlineMarkdown = (str) => {
        let s = str;
        // Normalize NBSP and remove zero-width chars that often trail emojis
        s = s.replace(/\u00A0/g, ' ').replace(/[\u200B-\u200D\uFEFF]/g, '');
        // Bold first
        s = s.replace(/\*\*([\s\S]+?)\*\*/g, '<strong class="font-bold">$1</strong>');
        // Also support __bold__ syntax
        s = s.replace(/__([\s\S]+?)__/g, '<strong class="font-bold">$1</strong>');
        // Italic using single asterisks (avoid matching bold)
        s = s.replace(/(^|[^*])\*(?!\*)([^*]+)\*(?!\*)/g, '$1<em>$2</em>');
        // Italic using underscores
        s = s.replace(/_([^_]+)_/g, '<em>$1</em>');
        // Auto-link plain URLs
        s = s.replace(/(https?:\/\/[^\s<]+)/g, '<a href="$1" target="_blank" rel="noopener" class="text-blue-600 underline">$1<\/a>');
        return s;
    };

    const parseMarkdownToHtml = (markdown) => {
        const lines = escapeHtml(markdown).replace(/\r\n?/g, '\n').split('\n');
        const html = [];
        let inUl = false, inOl = false;
        let blankStreak = 0;
        // Table parsing state
        let inTable = false;
        let tableRows = []; // array of string[] (cells)

        const closeLists = () => {
            if (inUl) { html.push('</ul>'); inUl = false; }
            if (inOl) { html.push('</ol>'); inOl = false; }
        };

        const flushTable = () => {
            if (!inTable || tableRows.length === 0) return;
            // Detect header separator row like --- or :---: etc.
            let headerCells = null;
            if (tableRows.length >= 2 && tableRows[1].every(cell => /^:?-{3,}:?$/.test(cell))) {
                headerCells = tableRows[0];
                tableRows = tableRows.slice(2);
            }
            const thead = headerCells
                ? '<thead><tr>' + headerCells.map((c) => `<th class="border border-gray-200 px-3 py-2 font-semibold bg-gray-100 dark:bg-gray-700 text-gray-900 dark:text-gray-100">${applyInlineMarkdown(c)}</th>`).join('') + '</tr></thead>'
                : '';
            const tbody = '<tbody>' + tableRows.map(row => (
                '<tr>' + row.map((c,i) => `<td class=\"border border-gray-200 px-3 py-2 ${i===0?'font-medium':''} whitespace-nowrap\">${applyInlineMarkdown(c)}</td>`).join('') + '</tr>'
            )).join('') + '</tbody>';
            html.push(`<div class="my-4"><div class="max-w-full overflow-x-auto"><table class="table-auto w-auto text-sm border border-gray-200 rounded-lg border-collapse">${thead}${tbody}</table></div></div>`);
            inTable = false;
            tableRows = [];
        };

        lines.forEach(raw => {
            const line = raw.replace(/\s+$/,'').replace(/^\s+/,'');
            if (!line) { blankStreak++; closeLists(); flushTable(); return; }
            if (blankStreak > 0) { html.push(`<div class="${blankStreak >= 2 ? 'my-8' : 'my-5'}"></div>`); blankStreak = 0; }
            if (/^---+$/.test(line)) { closeLists(); flushTable(); html.push('<hr class="my-8 border-t border-gray-200" />'); return; }
            if (/^####\s+/.test(line)) { closeLists(); flushTable(); html.push(`<h4 class="mt-4 mb-2 font-semibold text-lg leading-tight">${applyInlineMarkdown(line.replace(/^####\s+/, ''))}</h4>`); return; }
            if (/^###\s+/.test(line)) { closeLists(); flushTable(); html.push(`<h3 class="mt-5 mb-3 font-semibold text-xl leading-tight">${applyInlineMarkdown(line.replace(/^###\s+/, ''))}</h3>`); return; }
            if (/^##\s+/.test(line)) { closeLists(); flushTable(); html.push(`<h2 class="mt-6 mb-4 font-semibold text-2xl leading-tight">${applyInlineMarkdown(line.replace(/^##\s+/, ''))}</h2>`); return; }
            if (/^#\s+/.test(line)) { closeLists(); flushTable(); html.push(`<h1 class="mt-7 mb-5 font-bold text-4xl leading-tight">${applyInlineMarkdown(line.replace(/^#\s+/, ''))}</h1>`); return; }
            if (/^\|.*\|$/.test(line)) {
                // Accumulate markdown table rows, will flush on non-table line
                const cells = line.replace(/^\|/, '').replace(/\|$/, '').split('|').map(c => c.trim());
                if (!inTable) { inTable = true; tableRows = []; }
                tableRows.push(cells);
                return;
            }
            // Non-table content triggers a flush
            flushTable();
            if (/^\d+\.\s+/.test(line)) {
                if (!inOl) { closeLists(); html.push('<ol class="list-decimal pl-5 my-2 space-y-1.5">'); inOl = true; }
                html.push(`<li>${applyInlineMarkdown(line.replace(/^\d+\.\s+/, ''))}</li>`);
                return;
            }
            if (/^(?:-|\u2022|\u2013)\s+/.test(line)) { // -, •, –
                if (!inUl) { closeLists(); html.push('<ul class="list-disc pl-5 my-2 space-y-1.5">'); inUl = true; }
                html.push(`<li>${applyInlineMarkdown(line.replace(/^(?:-|\u2022|\u2013)\s+/, ''))}</li>`);
                return;
            }
            closeLists();
            html.push(`<p class="my-5">${applyInlineMarkdown(line)}</p>`);
        });
        closeLists();
        flushTable();
        // Post-process: if a line ends with ':' and is followed by a block gap, ensure only a small gap
        let result = html.join('\n');
        result = result.replace(/(<p[^>]*>[^<:]*:[^<]*<\/p>)\s*(<div class=\"my-5\"><\/div>)/g, '$1');
        return result;
    };

    const formattedContent = parseMarkdownToHtml(String(currentContent || ''));
    // Error tab: use Keywords markdown rendering and sizing for consistency
    const escapeHtmlKW_ER = (str) => String(str || '')
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;');
    const applyInlineMarkdownKW_ER = (str) => {
        let s = str;
        s = s.replace(/\u00A0/g, ' ').replace(/[\u200B-\u200D\uFEFF]/g, '');
        s = s.replace(/\*\*([\s\S]+?)\*\*/g, '<strong class="font-bold">$1</strong>');
        s = s.replace(/__([\s\S]+?)__/g, '<strong class="font-bold">$1</strong>');
        s = s.replace(/(^|[^*])\*(?!\*)([^*]+)\*(?!\*)/g, '$1<em>$2</em>');
        s = s.replace(/_([^_]+)_/g, '<em>$1</em>');
        s = s.replace(/(https?:\/\/[^\s<]+)/g, '<a href="$1" target="_blank" rel="noopener" class="text-blue-600 underline">$1<\/a>');
        return s;
    };
    const parseMarkdownToHtmlKW_ER = (markdown) => {
        const lines = escapeHtmlKW_ER(markdown).replace(/\r\n?/g, '\n').split('\n');
        const html = []; let inUl = false, inOl = false, blankStreak = 0, inTable = false; let tableRows = [];
        const closeLists = () => { if (inUl) { html.push('<\/ul>'); inUl = false; } if (inOl) { html.push('<\/ol>'); inOl = false; } };
        const flushTable = () => {
            if (!inTable || tableRows.length === 0) return;
            let headerCells = null;
            if (tableRows.length >= 2 && tableRows[1].every(cell => /^:?-{3,}:?$/.test(cell))) { headerCells = tableRows[0]; tableRows = tableRows.slice(2); }
            const thead = headerCells ? '<thead><tr>' + headerCells.map((c) => `<th class=\"border border-gray-200 px-3 py-2 font-semibold bg-gray-100 dark:bg-gray-700 text-gray-900 dark:text-gray-100\">${applyInlineMarkdownKW_ER(c)}</th>`).join('') + '</tr></thead>' : '';
            const tbody = '<tbody>' + tableRows.map(row => ('<tr>' + row.map((c,i) => `<td class=\"border border-gray-200 px-3 py-2 ${i===0?'font-medium':''} whitespace-nowrap\">${applyInlineMarkdownKW_ER(c)}</td>`).join('') + '</tr>')).join('') + '</tbody>';
            html.push(`<div class=\"my-4\"><div class=\"max-w-full overflow-x-auto\"><table class=\"table-auto w-auto text-sm border border-gray-200 rounded-lg border-collapse\">${thead}${tbody}</table></div></div>`);
            inTable = false; tableRows = [];
        };
        lines.forEach(raw => {
            const line = raw.replace(/\s+$/, '').replace(/^\s+/, '');
            if (!line) { blankStreak++; closeLists(); flushTable(); return; }
            if (blankStreak > 0) { html.push(`<div class=\"${blankStreak >= 2 ? 'my-8' : 'my-5'}\"></div>`); blankStreak = 0; }
            if (/^---+$/.test(line)) { closeLists(); flushTable(); html.push('<hr class=\"my-8 border-t border-gray-200\" />'); return; }
            if (/^####\s+/.test(line)) { closeLists(); flushTable(); html.push(`<h4 class=\"mt-4 mb-2 font-semibold text-lg leading-tight\">${applyInlineMarkdownKW_ER(line.replace(/^####\s+/, ''))}</h4>`); return; }
            if (/^###\s+/.test(line)) { closeLists(); flushTable(); html.push(`<h3 class=\"mt-5 mb-3 font-semibold text-xl leading-tight\">${applyInlineMarkdownKW_ER(line.replace(/^###\s+/, ''))}</h3>`); return; }
            if (/^##\s+/.test(line)) { closeLists(); flushTable(); html.push(`<h2 class=\"mt-6 mb-4 font-semibold text-2xl leading-tight\">${applyInlineMarkdownKW_ER(line.replace(/^##\s+/, ''))}</h2>`); return; }
            if (/^#\s+/.test(line)) { closeLists(); flushTable(); html.push(`<h1 class=\"mt-7 mb-5 font-bold text-4xl leading-tight\">${applyInlineMarkdownKW_ER(line.replace(/^#\s+/, ''))}</h1>`); return; }
            if (/^\|.*\|$/.test(line)) { const cells = line.replace(/^\|/, '').replace(/\|$/, '').split('|').map(c => c.trim()); if (!inTable) { inTable = true; tableRows = []; } tableRows.push(cells); return; }
            flushTable();
            if (/^\d+\.\s+/.test(line)) { if (!inOl) { closeLists(); html.push('<ol class=\"list-decimal pl-5 my-2 space-y-1.5\">'); inOl = true; } html.push(`<li>${applyInlineMarkdownKW_ER(line.replace(/^\d+\.\s+/, ''))}</li>`); return; }
            if (/^(?:-|\u2022|\u2013)\s+/.test(line)) { if (!inUl) { closeLists(); html.push('<ul class=\"list-disc pl-5 my-2 space-y-1.5\">'); inUl = true; } html.push(`<li>${applyInlineMarkdownKW_ER(line.replace(/^(?:-|\u2022|\u2013)\s+/, ''))}</li>`); return; }
            closeLists(); html.push(`<p class=\"my-5\">${applyInlineMarkdownKW_ER(line)}</p>`);
        });
        closeLists(); flushTable();
        let result = html.join('\n');
        result = result.replace(/(<p[^>]*>[^<:]*:[^<]*<\/p>)\s*(<div class=\"my-5\"><\/div>)/g, '$1');
        return result;
    };
    const formattedContentErrorKW = parseMarkdownToHtmlKW_ER(String(currentContent || ''));
    const isPlaceholderOnlyError = (!currentContent || currentContent.trim() === '' || currentContent === 'Error Report will appear here once generated in Website Crawl Summary (AK2).');

    // ---------- Error Report Implementation Prompt (only for error tab) ----------
    const formatISOToUSInTextER = (text) => {
        try {
            return String(text || '').replace(/\b\d{4}-\d{2}-\d{2}T\d{2}:\d{2}:\d{2}(?:\.\d+)?Z\b/g, (m) => {
                const d = new Date(m);
                if (isNaN(d.getTime())) return m;
                return d.toLocaleString('en-US', { year: 'numeric', month: 'short', day: '2-digit', hour: 'numeric', minute: '2-digit' });
            });
        } catch { return text; }
    };
    const readSessionJsonER = (key) => { try { const raw = sessionStorage.getItem(key); return raw ? JSON.parse(raw) : null; } catch { return null; } };
    const fetchSectionsER = (workbookId, sections) => new Promise((resolve) => {
        const base = 'https://script.google.com/macros/s/AKfycbxfOMp8d_eCVH4lFD0PNuFU1wH-gyWOwRt2EuME7GQJ4U73ZwpPDciohDH3C566YLWq/exec';
        const url = `${base}?workbookId=${workbookId}&sections=${encodeURIComponent(sections)}`;
        fetchWithCorsWorkaround(url, (err, data) => resolve(err ? null : data));
    });
    const toArrayER = (v) => Array.isArray(v) ? v : (v ? [v] : []);
    const pickCaseInsensitiveER = (obj, keyLike) => {
        if (!obj) return undefined;
        const entries = Object.entries(obj);
        const found = entries.find(([k]) => k.toLowerCase() === keyLike.toLowerCase());
        if (found) return found[1];
        const fuzzy = entries.find(([k]) => k.toLowerCase().includes(keyLike.toLowerCase()));
        return fuzzy ? fuzzy[1] : undefined;
    };

    const buildErrorImplementationPrompt = async () => {
        const params = new URLSearchParams(window.location.search);
        const workbookId = params.get('workbookId') || '';

        // Try caches
        const dashCache = readSessionJsonER(`dashboard_data_${workbookId}`);
        const wsUrl = `https://script.google.com/macros/s/AKfycbxfOMp8d_eCVH4lFD0PNuFU1wH-gyWOwRt2EuME7GQJ4U73ZwpPDciohDH3C566YLWq/exec?workbookId=${workbookId}&sections=websiteStats`;
        const wsCache = readSessionJsonER(`seo_data_${wsUrl}`);
        let websiteStats = wsCache?.websiteStats || null;
        let overviewData = dashCache?.overviewData || [];
        let gbpInsights = null;

        if (!websiteStats || !overviewData) {
            const data = await fetchSectionsER(workbookId, 'websiteStats,dashboard,gbpInsights');
            if (data) {
                websiteStats = websiteStats || data.websiteStats || data?.websiteStats;
                if ((!overviewData || overviewData.length === 0) && data.dashboard?.overviewData) overviewData = data.dashboard.overviewData;
                if (data.gbpInsights) gbpInsights = data.gbpInsights;
            }
        }
        if (!gbpInsights) {
            const g = await fetchSectionsER(workbookId, 'gbpInsights');
            if (g && g.gbpInsights) gbpInsights = g.gbpInsights;
        }

        // On-page snapshot
        const health = websiteStats?.healthData || {};
        const tseo = toArrayER(websiteStats?.technicalSeoData || []);
        const perf = toArrayER(websiteStats?.competitorPerfData || []).find(x => x?.isClient) || {};
        const siteSpeedMs = Number(health?.siteSpeed) || 0;
        const siteSpeedDisplayMs = isFinite(siteSpeedMs) && siteSpeedMs > 0 ? `${Math.round(siteSpeedMs)} ms` : 'N/A';
        const pageScore = isFinite(Number(health?.pageScore)) ? Number(health.pageScore) : null;
        const ssl = (health?.ssl === true || health?.ssl === 'true' || health?.ssl === 'Yes') ? 'Yes' : (health?.ssl === false ? 'No' : 'Unknown');
        const hasSchema = (health?.hasSchema === true || health?.hasSchema === 'true' || health?.hasSchema === 'Yes') ? 'Yes' : (health?.hasSchema === false ? 'No' : (health?.hasSchemaErrors ? 'Has errors' : 'Unknown'));
        const referringDomains = isFinite(Number(perf['Referring Domains'])) ? Number(perf['Referring Domains']) : undefined;
        const totalBacklinks = isFinite(Number(perf['Total Backlinks'])) ? Number(perf['Total Backlinks']) : undefined;

        const tseoClient = tseo.find(s => (s?.isClient || (s?.clinicName || s?.name || '').toLowerCase().includes('client')) ) || tseo[0] || {};
        const titleTag = tseoClient?.title || '';
        const metaDescription = tseoClient?.description || '';
        const h1 = tseoClient?.h1 || '';
        const website = tseoClient?.website || '';
        const clinicName = tseoClient?.clinicName || 'Client';

        // Quick GBP fields
        let gbpRecord = null;
        if (Array.isArray(gbpInsights)) {
            gbpRecord = gbpInsights.find(r => {
                const at = String(pickCaseInsensitiveER(r, 'Account Type') || pickCaseInsensitiveER(r, 'AccountType') || pickCaseInsensitiveER(r, 'Type') || '').toLowerCase();
                return at.includes('client');
            }) || gbpInsights[0] || null;
        } else if (gbpInsights && typeof gbpInsights === 'object') {
            gbpRecord = gbpInsights;
        }
        const primaryCategory = (gbpRecord?.primaryCategory || pickCaseInsensitiveER(gbpRecord, 'Primary Categorie') || pickCaseInsensitiveER(gbpRecord, 'Primary Category') || '').toString();
        const secondaryCategories = (gbpRecord?.secondaryCategories || pickCaseInsensitiveER(gbpRecord, 'Secondary Categories') || '').toString();
        const gbpDescription = (gbpRecord?.description || pickCaseInsensitiveER(gbpRecord, 'Description') || '').toString();
        const reviewScore = (gbpRecord?.reviewScore || pickCaseInsensitiveER(gbpRecord, 'Review Score') || '').toString();
        const reviewCount = (gbpRecord?.reviewCount || pickCaseInsensitiveER(gbpRecord, 'Review Count') || '').toString();

        // Website pages
        const crawlPages = toArrayER(health?.checksAggregate?.pagesList || health?.pagesList || health?.topPages || [])
            .map(p => (typeof p === 'string' ? p : (p?.url || p?.path || ''))) 
            .filter(Boolean)
            .slice(0, 60);

        // Error report content (plain text best-effort)
        const errorTextPlain = String(errorText || currentContent || '')
            .replace(/<br\s*\/?>/gi, '\n')
            .replace(/<[^>]*>/g, '')
            .trim();

        const lines = [];
        lines.push('ROLE: You are a senior MedSpa Technical SEO specialist.');
        lines.push('CONTEXT: The client has generated a Website Error Report. Use the data below to diagnose and fix issues pragmatically for a non-technical user.');
        lines.push('GOAL: Improve technical health and rankings by resolving the highest-impact issues first, while keeping steps simple.');
        lines.push('WORKING MODE:');
        lines.push('- Provide one concrete, click-by-click first action with exact paths/fields (tailor by common CMS if unknown).');
        lines.push('- You may perform light independent checks/scrapes to validate issues or suggest precise fixes.');
        lines.push('- Keep outputs concise and operational; include exact text/fields to paste where applicable.');
        lines.push('- After the first step, ask 2–3 essential questions (CMS, who manages the site: owner vs dev/agency, staging/deployment process).');
        lines.push('');
        lines.push('CLIENT PROFILE:');
        lines.push(`- Clinic Name: ${clinicName}`);
        lines.push(`- Website: ${website || 'N/A'}`);
        lines.push('');
        lines.push('CORE ON-PAGE / TECHNICAL SNAPSHOT:');
        lines.push(`- Title Tag: ${titleTag || 'N/A'}`);
        lines.push(`- Meta Description: ${metaDescription || 'N/A'}`);
        lines.push(`- H1: ${h1 || 'N/A'}`);
        lines.push(`- Site Speed: ${siteSpeedDisplayMs}`);
        lines.push(`- Page Score: ${pageScore !== null ? pageScore : 'N/A'}`);
        lines.push(`- Referring Domains: ${typeof referringDomains !== 'undefined' ? referringDomains : 'N/A'}`);
        if (typeof totalBacklinks !== 'undefined') lines.push(`- Total Backlinks: ${totalBacklinks}`);
        lines.push(`- SSL: ${ssl}`);
        lines.push(`- Schema: ${hasSchema}`);
        lines.push('');
        lines.push('GOOGLE BUSINESS PROFILE (Quick View):');
        lines.push(`- Primary Category: ${primaryCategory || 'N/A'}`);
        lines.push(`- Secondary Categories: ${secondaryCategories || 'N/A'}`);
        lines.push(`- Description: ${gbpDescription || 'N/A'}`);
        lines.push(`- Review Score: ${reviewScore || 'N/A'} | Reviews: ${reviewCount || 'N/A'}`);
        if (crawlPages.length) {
            lines.push('');
            lines.push('CLIENT WEBPAGES:');
            lines.push(crawlPages.map(p => `- ${p}`).join('\n'));
        }
        lines.push('');
        lines.push('ERROR REPORT (Client):');
        lines.push(errorTextPlain || 'N/A');
        lines.push('');
        lines.push('--- End of report ---');
        lines.push('');
        lines.push('OPERATING PLAN (follow in this order):');
        lines.push('1) First Action (Click-by-click): Select the highest-impact issue (e.g., missing meta titles, render-blocking resources, SSL, 4xx/5xx, or duplicate tags) and provide exact steps to fix now. Include:');
        lines.push('   - CMS-specific path (WordPress, Wix, Squarespace, generic) to update settings/content/code.');
        lines.push('   - Exact text to paste or configuration to toggle, and where.');
        lines.push('   - How to verify the fix (view-source, devtools, or live URL).');
        lines.push('2) Minimal Questions (≤3): CMS/platform, who manages the site (owner vs developer/agency), and whether a staging environment exists.');
        lines.push('3) Prioritized Fix List: Short ranked list of next 5–10 fixes with brief rationale (impact/risk/effort).');
        lines.push('4) Verification & Monitoring: How to validate fixes (crawl, Lighthouse, GSC Coverage) and monitor weekly.');

        let output = lines.join('\n');
        output = formatISOToUSInTextER(output);
        return output;
    };

    const handleCopyImplementationPromptError = async () => {
        if (isCopyingError) return;
        try {
            setIsCopyingError(true);
            setPromptCopyStateError('');
            if (cachedErrorPrompt) {
                await navigator.clipboard.writeText(cachedErrorPrompt);
                setPromptCopyStateError('ok');
                return;
            }
            const prompt = await buildErrorImplementationPrompt();
            try {
                const params = new URLSearchParams(window.location.search);
                const workbookId = params.get('workbookId') || '';
                const cacheKey = `impl_prompt_error_${workbookId}`;
                const payload = { prompt, aiText: String(currentContent || ''), ts: Date.now() };
                sessionStorage.setItem(cacheKey, JSON.stringify(payload));
                setCachedErrorPrompt(prompt);
            } catch {}
            await navigator.clipboard.writeText(prompt);
            setPromptCopyStateError('ok');
        } catch (e) {
            setPromptCopyStateError('err');
        } finally {
            setTimeout(() => { setPromptCopyStateError(''); setIsCopyingError(false); }, 20000);
        }
    };

    useEffect(() => {
        try {
            if (activeTab !== 'error') return;
            const params = new URLSearchParams(window.location.search);
            const workbookId = params.get('workbookId') || '';
            const cacheKey = `impl_prompt_error_${workbookId}`;
            const raw = sessionStorage.getItem(cacheKey);
            if (raw) {
                try {
                    const parsed = JSON.parse(raw);
                    const isFresh = parsed && parsed.aiText === String(currentContent || '') && (Date.now() - (parsed.ts || 0) < 10 * 60 * 1000);
                    if (isFresh && parsed.prompt) {
                        setCachedErrorPrompt(parsed.prompt);
                        return;
                    }
                } catch {}
            }
            const build = async () => {
                try {
                    const prompt = await buildErrorImplementationPrompt();
                    const payload = { prompt, aiText: String(currentContent || ''), ts: Date.now() };
                    sessionStorage.setItem(cacheKey, JSON.stringify(payload));
                    setCachedErrorPrompt(prompt);
                } catch {}
            };
            if ('requestIdleCallback' in window) {
                window.requestIdleCallback(() => { build(); }, { timeout: 3000 });
            } else {
                setTimeout(build, 2500);
            }
        } catch {}
    }, [activeTab, currentContent]);

    // ---------- Competitor Analysis Implementation Prompt (only for competitor tab) ----------
    const formatISOToUSInTextCA = (text) => {
        try {
            return String(text || '').replace(/\b\d{4}-\d{2}-\d{2}T\d{2}:\d{2}:\d{2}(?:\.\d+)?Z\b/g, (m) => {
                const d = new Date(m);
                if (isNaN(d.getTime())) return m;
                return d.toLocaleString('en-US', { year: 'numeric', month: 'short', day: '2-digit', hour: 'numeric', minute: '2-digit' });
            });
        } catch { return text; }
    };

    const buildCompetitorImplementationPrompt = async () => {
        const params = new URLSearchParams(window.location.search);
        const workbookId = params.get('workbookId') || '';

        const data = await fetchSectionsER(workbookId, 'websiteStats,gbpInsights,dashboard');
        const websiteStats = data?.websiteStats || {};
        const gbpInsights = data?.gbpInsights || null;
        const health = websiteStats?.healthData || {};
        // On-Page Insights: AI Notes (CP)
        let aiNotesText = '';
        try {
            const rawAiNotes = health?.aiNotes;
            if (rawAiNotes !== null && rawAiNotes !== undefined) {
                const cleaned = String(rawAiNotes).trim();
                if (cleaned && !['true', 'false'].includes(cleaned.toLowerCase())) {
                    aiNotesText = cleaned;
                }
            }
        } catch {}
        const tseo = Array.isArray(websiteStats?.technicalSeoData) ? websiteStats.technicalSeoData : [];
        const perfAll = Array.isArray(websiteStats?.competitorPerfData) ? websiteStats.competitorPerfData : [];

        const clientTseo = tseo.find(s => s?.isClient || (String(s?.clinicName || s?.name || '').toLowerCase().includes('client'))) || tseo[0] || {};
        const clientName = clientTseo?.clinicName || clientTseo?.name || 'Client';
        const clientWebsite = clientTseo?.website || '';
        const titleTag = clientTseo?.title || '';
        const metaDescription = clientTseo?.description || '';
        const h1 = clientTseo?.h1 || '';

        const siteSpeedMs = Number(health?.siteSpeed) || 0;
        const siteSpeedDisplayMs = isFinite(siteSpeedMs) && siteSpeedMs > 0 ? `${Math.round(siteSpeedMs)} ms` : 'N/A';
        const pageScore = isFinite(Number(health?.pageScore)) ? Number(health.pageScore) : null;
        const ssl = (health?.ssl === true || health?.ssl === 'true' || health?.ssl === 'Yes') ? 'Yes' : (health?.ssl === false ? 'No' : 'Unknown');
        const hasSchema = (health?.hasSchema === true || health?.hasSchema === 'true' || health?.hasSchema === 'Yes') ? 'Yes' : (health?.hasSchema === false ? 'No' : (health?.hasSchemaErrors ? 'Has errors' : 'Unknown'));

        const kd = websiteStats?.keywordsDistribution || health?.keywordsDistribution || {};
        const kwPos1 = Number(kd?.pos1 || kd?.position1 || kd?.p1 || 0) || 0;
        const kwPos2to3 = Number(kd?.pos2_3 || kd?.pos2to3 || kd?.position2_3 || 0) || 0;
        const kwPos4to10 = Number(kd?.pos4_10 || kd?.pos4to10 || kd?.position4_10 || 0) || 0;

        const clientPerf = perfAll.find(p => String(p?.Name || p?.Clinic || p?.clinicName || '').toLowerCase().includes(String(clientName).toLowerCase()))
            || perfAll.find(p => p?.isClient) || {};
        const referringDomains = isFinite(Number(clientPerf['Referring Domains'] ?? clientPerf.referringDomains)) ? Number(clientPerf['Referring Domains'] ?? clientPerf.referringDomains) : undefined;
        const totalBacklinks = isFinite(Number(clientPerf['Total Backlinks'] ?? clientPerf.totalBacklinks)) ? Number(clientPerf['Total Backlinks'] ?? clientPerf.totalBacklinks) : undefined;

        let clientGbp = null;
        if (Array.isArray(gbpInsights)) {
            clientGbp = gbpInsights.find(r => {
                const nm = String(pickCaseInsensitiveER(r, 'Clinic Name') || pickCaseInsensitiveER(r, 'Name') || '').toLowerCase();
                return nm && clientName && nm.includes(String(clientName).toLowerCase());
            }) || gbpInsights.find(r => (r?.isClient)) || gbpInsights[0] || null;
        } else if (gbpInsights && typeof gbpInsights === 'object') {
            clientGbp = gbpInsights;
        }
        const gbpPrimary = (clientGbp?.primaryCategory || pickCaseInsensitiveER(clientGbp, 'Primary Category') || '').toString();
        const gbpSecondary = (clientGbp?.secondaryCategories || pickCaseInsensitiveER(clientGbp, 'Secondary Categories') || '').toString();
        const gbpDesc = (clientGbp?.description || pickCaseInsensitiveER(clientGbp, 'Description') || '').toString();
        const gbpScore = (clientGbp?.reviewScore || pickCaseInsensitiveER(clientGbp, 'Review Score') || '').toString();
        const gbpCount = (clientGbp?.reviewCount || pickCaseInsensitiveER(clientGbp, 'Review Count') || '').toString();

        const crawlPages = (Array.isArray(health?.checksAggregate?.pagesList) ? health.checksAggregate.pagesList : (health?.pagesList || health?.topPages || []))
            .map(p => (typeof p === 'string' ? p : (p?.url || p?.path || '')))
            .filter(Boolean)
            .slice(0, 80);

        const competitorsTseo = tseo.filter(s => !(s?.isClient) && !String(s?.clinicName || s?.name || '').toLowerCase().includes('client')).slice(0, 4);
        const findPerfFor = (name) => {
            return perfAll.find(p => String(p?.Name || p?.Clinic || p?.clinicName || '').toLowerCase().includes(String(name || '').toLowerCase())) || {};
        };
        const findGbpFor = (name) => {
            if (!Array.isArray(gbpInsights)) return null;
            return gbpInsights.find(r => {
                const nm = String(pickCaseInsensitiveER(r, 'Clinic Name') || pickCaseInsensitiveER(r, 'Name') || '').toLowerCase();
                return nm && name && nm.includes(String(name).toLowerCase());
            }) || null;
        };

        const lines = [];
        lines.push('ROLE: You are a senior MedSpa SEO strategist.');
        lines.push('CONTEXT: Analyze the client vs top competitors using on-page, technical, GBP, and authority data.');
        lines.push('GOAL: Provide focused, actionable steps to close competitive gaps and grow qualified traffic.');
        lines.push('');
        lines.push('CLIENT PROFILE:');
        lines.push(`- Clinic Name: ${clientName}`);
        lines.push(`- Website: ${clientWebsite || 'N/A'}`);
        lines.push('');
        lines.push('CORE ON-PAGE / TECHNICAL SNAPSHOT:');
        lines.push(`- Title Tag: ${titleTag || 'N/A'}`);
        lines.push(`- Meta Description: ${metaDescription || 'N/A'}`);
        lines.push(`- H1: ${h1 || 'N/A'}`);
        lines.push(`- Site Speed: ${siteSpeedDisplayMs}`);
        lines.push(`- Page Score: ${pageScore !== null ? pageScore : 'N/A'}`);
        lines.push(`- Referring Domains: ${typeof referringDomains !== 'undefined' ? referringDomains : 'N/A'}`);
        if (typeof totalBacklinks !== 'undefined') lines.push(`- Total Backlinks: ${totalBacklinks}`);
        lines.push(`- SSL: ${ssl}`);
        lines.push(`- Schema: ${hasSchema}`);
        lines.push(`- Keywords Position 1: ${kwPos1}`);
        lines.push(`- Keywords Position 2-3: ${kwPos2to3}`);
        lines.push(`- Keywords Position 4-10: ${kwPos4to10}`);
        lines.push('');
        lines.push('GOOGLE BUSINESS PROFILE (Quick View):');
        lines.push(`- Primary Category: ${gbpPrimary || 'N/A'}`);
        lines.push(`- Secondary Categories: ${gbpSecondary || 'N/A'}`);
        lines.push(`- Description: ${gbpDesc || 'N/A'}`);
        lines.push(`- Review Score: ${gbpScore || 'N/A'} | Reviews: ${gbpCount || 'N/A'}`);
        if (crawlPages.length) {
            lines.push('');
            lines.push('CLIENT WEBPAGES:');
            lines.push(crawlPages.map(p => `- ${p}`).join('\n'));
        }
        // Include On-Page Insights AI Notes for added context
        if (aiNotesText) {
            lines.push('');
            lines.push('ON-PAGE INSIGHTS - AI NOTES:');
            lines.push(aiNotesText);
        }
        lines.push('');
        lines.push('COMPETITOR PROFILES (On-Page + GBP + Authority):');
        competitorsTseo.forEach((comp, idx) => {
            const name = comp?.clinicName || comp?.name || `Competitor ${idx+1}`;
            const compPerf = findPerfFor(name);
            const compGbp = findGbpFor(name) || {};
            const compRD = isFinite(Number(compPerf['Referring Domains'] ?? compPerf.referringDomains)) ? Number(compPerf['Referring Domains'] ?? compPerf.referringDomains) : 'N/A';
            const compBL = isFinite(Number(compPerf['Total Backlinks'] ?? compPerf.totalBacklinks)) ? Number(compPerf['Total Backlinks'] ?? compPerf.totalBacklinks) : 'N/A';
            const cPrim = (compGbp?.primaryCategory || pickCaseInsensitiveER(compGbp, 'Primary Category') || 'N/A').toString();
            const cSec = (compGbp?.secondaryCategories || pickCaseInsensitiveER(compGbp, 'Secondary Categories') || 'N/A').toString();
            const cDesc = (compGbp?.description || pickCaseInsensitiveER(compGbp, 'Description') || 'N/A').toString();
            const cScore = (compGbp?.reviewScore || pickCaseInsensitiveER(compGbp, 'Review Score') || 'N/A').toString();
            const cCount = (compGbp?.reviewCount || pickCaseInsensitiveER(compGbp, 'Review Count') || 'N/A').toString();
            lines.push(`- ${name}:`);
            lines.push(`  - Title: ${comp?.title || 'N/A'}`);
            lines.push(`  - Meta: ${comp?.description || 'N/A'}`);
            lines.push(`  - H1: ${comp?.h1 || 'N/A'}`);
            lines.push(`  - Referring Domains: ${compRD} | Total Backlinks: ${compBL}`);
            lines.push(`  - GBP: Primary=${cPrim}; Secondary=${cSec}; Reviews=${cScore} (${cCount})`);
        });
        lines.push('');
        lines.push('OPERATING PLAN:');
        lines.push('1) First Action (High-Impact): Close the most critical gap (authority, GBP completeness, or on-page targeting). Provide exact edits (title/H1/meta), GBP category additions, or 10 backlink targets to pursue now.');
        lines.push('2) Next 30 Days: Short weekly plan to improve rankings for 3–5 priority services.');
        lines.push('3) Minimal Questions (≤3): CMS/platform, internal dev resources, current backlink partners.');

        let output = lines.join('\n');
        output = formatISOToUSInTextCA(output);
        return output;
    };

    const handleCopyImplementationPromptCompetitor = async () => {
        if (isCopyingCompetitor) return;
        try {
            setIsCopyingCompetitor(true);
            setPromptCopyStateCompetitor('');
            if (cachedCompetitorPrompt) {
                await navigator.clipboard.writeText(cachedCompetitorPrompt);
                setPromptCopyStateCompetitor('ok');
                return;
            }
            const prompt = await buildCompetitorImplementationPrompt();
            try {
                const params = new URLSearchParams(window.location.search);
                const workbookId = params.get('workbookId') || '';
                const cacheKey = `impl_prompt_competitor_${workbookId}`;
                const payload = { prompt, aiText: String(currentContent || ''), ts: Date.now() };
                sessionStorage.setItem(cacheKey, JSON.stringify(payload));
                setCachedCompetitorPrompt(prompt);
            } catch {}
            await navigator.clipboard.writeText(prompt);
            setPromptCopyStateCompetitor('ok');
        } catch (e) {
            setPromptCopyStateCompetitor('err');
        } finally {
            setTimeout(() => { setPromptCopyStateCompetitor(''); setIsCopyingCompetitor(false); }, 20000);
        }
    };

    useEffect(() => {
        try {
            if (activeTab !== 'competitor') return;
            const params = new URLSearchParams(window.location.search);
            const workbookId = params.get('workbookId') || '';
            const cacheKey = `impl_prompt_competitor_${workbookId}`;
            const raw = sessionStorage.getItem(cacheKey);
            if (raw) {
                try {
                    const parsed = JSON.parse(raw);
                    const isFresh = parsed && parsed.aiText === String(currentContent || '') && (Date.now() - (parsed.ts || 0) < 10 * 60 * 1000);
                    if (isFresh && parsed.prompt) {
                        setCachedCompetitorPrompt(parsed.prompt);
                        return;
                    }
                } catch {}
            }
            const build = async () => {
                try {
                    const prompt = await buildCompetitorImplementationPrompt();
                    const payload = { prompt, aiText: String(currentContent || ''), ts: Date.now() };
                    sessionStorage.setItem(cacheKey, JSON.stringify(payload));
                    setCachedCompetitorPrompt(prompt);
                } catch {}
            };
            if ('requestIdleCallback' in window) {
                window.requestIdleCallback(() => { build(); }, { timeout: 3000 });
            } else {
                setTimeout(build, 2500);
            }
        } catch {}
    }, [activeTab, currentContent]);
    return (
        <div className="rounded-2xl shadow-lg overflow-hidden transition-all duration-300 bg-white dark:bg-gray-800 border-0">
            {/* Modern Tab Headers */}
            <div className="flex p-1 rounded-t-xl dual-reports-header">
                {tabs.map((tab, index) => (
                    <button
                        key={tab.id}
                        onClick={() => setActiveTab(tab.id)}
                        className={`flex-1 relative px-6 py-4 text-base font-semibold transition-all duration-200 ${
                            index === 0 ? 'rounded-l-xl' : 'rounded-r-xl'
                        } ${
                            activeTab === tab.id
                                ? tab.color === 'blue' ? 'dual-reports-active-blue' : 'dual-reports-active-red'
                                : 'dual-reports-tab-inactive'
                        }`}
                    >
                        <div className="flex items-center justify-between">
                            <div className="flex items-center space-x-2">
                                <span>{tab.title}</span>
                                <InfoTooltip text={tab.info} />
                                <button
                                    onClick={(e) => {
                                        e.stopPropagation();
                                        handleToggleExpand();
                                    }}
                                    className="flex items-center space-x-1 px-2 py-1 rounded-md transition-colors text-gray-500 hover:text-gray-700 text-xs dual-reports-action-hover"
                                    title={isExpanded ? "Show less" : "Show more"}
                                >
                                    <span>{isExpanded ? "Show Less" : "Show More"}</span>
                                    {isExpanded ? (
                                        <ChevronUp className="w-3 h-3" />
                                    ) : (
                                        <ChevronDown className="w-3 h-3" />
                                    )}
                                </button>
                            </div>
                            <div className="flex items-center space-x-1">
                                <button
                                    onClick={(e) => {
                                        e.stopPropagation();
                                        handleCopyReport();
                                    }}
                                    className={`p-1 rounded-md transition-colors ${
                                        copySuccess === activeTab
                                            ? 'text-green-600'
                                            : `${tab.color === 'blue' ? 'text-blue-600 hover:text-blue-800 hover:bg-blue-50' : 'text-red-600 hover:text-red-800 hover:bg-red-50'} dual-reports-action-hover`
                                    }`}
                                    title="Copy report"
                                >
                                    {copySuccess === activeTab ? (
                                        <Check className="w-4 h-4" />
                                    ) : (
                                        <Copy className="w-4 h-4" />
                                    )}
                                </button>
                                <button
                                    onClick={(e) => {
                                        e.stopPropagation();
                                        handleDownloadReport();
                                    }}
                                    className={`p-1 rounded-md transition-colors ${tab.color === 'blue' ? 'text-blue-600 hover:text-blue-800 hover:bg-blue-50' : 'text-red-600 hover:text-red-800 hover:bg-red-50'} dual-reports-action-hover`}
                                    title="Download report as text file"
                                >
                                    <Download className="w-4 h-4" />
                                </button>
                            </div>
                        </div>
                    </button>
                ))}
            </div>

            {/* Content Area */}
            <div className="rounded-b-xl dual-reports-content">
                <div className="p-6">
                    {/* Preview/Summary when collapsed */}
                    {!isExpanded && (
                        <div className="space-y-2">
                            <div className="relative">
                                {/* Text content */}
                                <div 
                                    className={activeTab === 'error' 
                                        ? "prose prose-sm max-w-none leading-relaxed overflow-hidden select-text cursor-text dual-reports-text prose-p:my-3 prose-h1:mt-6 prose-h1:mb-3 prose-h2:mt-5 prose-h2:mb-2.5 prose-h3:mt-4 prose-h3:mb-2 prose-ul:my-2 prose-ol:my-2"
                                        : "prose prose-base max-w-none leading-relaxed overflow-hidden select-text cursor-text dual-reports-text prose-p:my-5 prose-h1:mt-7 prose-h1:mb-5 prose-h2:mt-6 prose-h2:mb-4 prose-h3:mt-5 prose-h3:mb-3 prose-ul:my-3 prose-ol:my-3"}
                                    style={activeTab === 'error' ? { maxHeight: '160px' } : { maxHeight: '120px' }}
                                    dangerouslySetInnerHTML={{ __html: activeTab === 'error' ? formattedContentErrorKW : formattedContent }}
                                />
                                {(activeTab === 'error' ? !isPlaceholderOnlyError : true) && (
                                    <div className="absolute bottom-0 left-0 right-0 h-8 pointer-events-none dual-reports-fade-light"></div>
                                )}
                            </div>
                            
                            {/* Clickable area to expand */}
                            <div 
                                className="text-center py-2 cursor-pointer rounded-lg transition-colors text-sm dual-reports-show-more"
                                onClick={handleToggleExpand}
                            >
                                Show More
                            </div>
                        </div>
                    )}

                    {/* Full content when expanded */}
                    {isExpanded && (
                        <div className="space-y-2">
                            {/* Text content */}
                            <div 
                                className={activeTab === 'error' 
                                    ? "prose prose-sm max-w-none leading-relaxed select-text cursor-text dual-reports-text prose-p:my-3 prose-h1:mt-6 prose-h1:mb-3 prose-h2:mt-5 prose-h2:mb-2.5 prose-h3:mt-4 prose-h3:mb-2 prose-ul:my-2 prose-ol:my-2"
                                    : "prose prose-sm max-w-none leading-relaxed select-text cursor-text dual-reports-text"}
                                dangerouslySetInnerHTML={{ __html: activeTab === 'error' ? formattedContentErrorKW : formattedContent }}
                            />
                            {activeTab === 'competitor' && (
                                <>
                                    <div className="mt-2 flex items-center justify-end space-x-3">
                                        <button
                                            onClick={handleCopyImplementationPromptCompetitor}
                                            className="px-4 py-2 rounded-lg font-semibold text-white bg-gradient-to-r from-blue-600 to-blue-700 hover:from-blue-700 hover:to-blue-800 shadow-md disabled:opacity-60"
                                            title="Copy implementation prompt"
                                            disabled={isCopyingCompetitor}
                                        >
                                            Implement Recommendations Myself
                                        </button>
                                        <button
                                            onClick={() => window.open('https://www.skool.com/forever-booked/classroom/a23620ff?md=00953c20f4574ccdb6d5edfe0a0298ed', '_blank')}
                                            className="px-4 py-2 rounded-lg font-semibold text-white"
                                            style={{ backgroundColor: '#F8857E' }}
                                            title="Request paid implementation"
                                        >
                                            Request Forever Booked Implement (Paid SEO)
                                        </button>
                                    </div>
                                    {!!promptCopyStateCompetitor && (
                                        <div className={`mt-1 text-right text-sm ${promptCopyStateCompetitor==='ok'?'text-green-600':'text-red-600'}`}>
                                            {promptCopyStateCompetitor==='ok' 
                                                ? 'Prompt copied! Open your favourite AI model and paste it into the chat to get started.' 
                                                : 'Failed to build or copy the prompt. Please try again in a moment.'}
                                        </div>
                                    )}
                                </>
                            )}
                            {activeTab === 'error' && (
                                <>
                                    <div className="mt-2 flex items-center justify-end space-x-3">
                                        <button
                                            onClick={handleCopyImplementationPromptError}
                                            className="px-4 py-2 rounded-lg font-semibold text-white bg-gradient-to-r from-blue-600 to-blue-700 hover:from-blue-700 hover:to-blue-800 shadow-md disabled:opacity-60"
                                            title="Copy implementation prompt"
                                            disabled={isCopyingError}
                                        >
                                            Implement Recommendations Myself
                                        </button>
                                        <button
                                            onClick={() => window.open('https://www.skool.com/forever-booked/classroom/a23620ff?md=00953c20f4574ccdb6d5edfe0a0298ed', '_blank')}
                                            className="px-4 py-2 rounded-lg font-semibold text-white"
                                            style={{ backgroundColor: '#F8857E' }}
                                            title="Request paid implementation"
                                        >
                                            Request Forever Booked Implement (Paid SEO)
                                        </button>
                                    </div>
                                    {!!promptCopyStateError && (
                                        <div className={`mt-1 text-right text-sm ${promptCopyStateError==='ok'?'text-green-600':'text-red-600'}`}>
                                            {promptCopyStateError==='ok' 
                                                ? 'Prompt copied! Open your favourite AI model and paste it into the chat to get started.' 
                                                : 'Failed to build or copy the prompt. Please try again in a moment.'}
                                        </div>
                                    )}
                                </>
                            )}
                            
                            {/* Clickable area to collapse */}
                            <div 
                                className="text-center py-2 cursor-pointer rounded-lg transition-colors text-sm dual-reports-show-more"
                                onClick={handleToggleExpand}
                            >
                                Show Less
                            </div>
                        </div>
                    )}
                </div>
            </div>
        </div>
    );
};
// --- AI Sentiment Components ---
const AISentimentBubbleChart = React.memo(({ data, loading, error }) => {
    const { ResponsiveContainer, ScatterChart, CartesianGrid, XAxis, YAxis, Tooltip, Cell, Scatter } = window.Recharts;
    const [selectedPlatform, setSelectedPlatform] = useState('chatGpt');
    
    // Define colors before early return so they're always available
    const platformColors = {
        chatGpt: '#3b82f6',   // blue-500
        gemini: '#f472b6',    // pink-400
        perplexity: '#8b5cf6' // purple-500
    };
    
    const clientColor = '#3b82f6'; // blue-500 (lighter blue for client)
    const competitorColors = [
        '#10b981', // emerald-500
        '#ec4899', // pink-500 (Ahrefs style pink instead of yellow)
        '#ef4444', // red-500
        '#8b5cf6', // violet-500
    ];
    
    // Debug logging
    console.log('AISentimentBubbleChart - Loading:', loading, 'Error:', error, 'Data:', data);
    
    // Early return for any invalid data state
    if (loading || error || !data || !Array.isArray(data) || data.length === 0) {
        const message = loading ? "Loading AI sentiment data..." : 
                       error ? "Error loading AI sentiment data" : 
                       "No AI sentiment data available";
        console.log('AISentimentBubbleChart - Early return:', message);
        return (
            <Card className="col-span-12 md:col-span-6 group hover:shadow-xl transition-all duration-300 hover:-translate-y-0.5 hover:border-blue-200/60">
                <div className="flex items-center justify-center h-96">
                    <p className="text-gray-500">{message}</p>
                </div>
            </Card>
        );
    }
    
    // Transform data for the scatter plot
    console.log('Raw AI sentiment data:', data);
    let competitorIndex = 0;
    const chartData = (data || []).map(item => {
        const platformData = item[selectedPlatform];
        if (!platformData) {
            console.warn('No platform data for:', item.clinicName, selectedPlatform);
            return null;
        }
        
        // Debug logging for Perplexity data in bubble chart
        if (item.isClient && selectedPlatform === 'perplexity') {
            console.log('Bubble Chart Perplexity Debug for Client:', {
                platformData: platformData,
                signedSentiment: platformData.signedSentiment,
                visibility: platformData.visibility,
                strength: platformData.strength,
                sentiment: platformData.sentiment
            });
        }
        
        const sentScore = platformData.strength * (platformData.sentiment >= 0 ? 1 : -1) * 100;
        
        // Assign colors: client gets blue, competitors get different colors
        let fillColor;
        if (item.isClient) {
            fillColor = clientColor;
        } else {
            fillColor = competitorColors[competitorIndex % competitorColors.length];
            competitorIndex++;
        }
        
        // Bubble size based on Appearance (share of voice/frequency)
        // Appearance: 1 = 100%, 0 = 0%, but minimum 40% size
        const maxSize = 96; // Maximum bubble size (100%) - 60% increase from 60px
        const minSize = maxSize * 0.4; // Minimum bubble size (40% of max) = 38.4px
        const appearanceValue = Math.max(0, Math.min(1, platformData.appearance || 0)); // Clamp to 0-1
        const sizeRange = maxSize - minSize;
        const bubbleRadius = minSize + (appearanceValue * sizeRange);
        
        // Opacity based on Confidence (data quality indicator)
        const confidence = Math.max(0, Math.min(1, platformData.confidence || 0)); // Clamp to 0-1
        const minOpacity = 0.25; // Minimum opacity for low confidence (25%)
        const maxOpacity = 0.5; // Maximum opacity for high confidence (50%)
        const bubbleOpacity = minOpacity + (confidence * (maxOpacity - minOpacity));
        
        const result = {
            clinicName: item.clinicName,
            visibility: platformData.visibility * 100, // Convert to percentage
            signedSentiment: sentScore,
            appearance: platformData.appearance || 0,
            confidence: platformData.confidence || 0,
            r: bubbleRadius, // Bubble radius based on appearance
            opacity: bubbleOpacity, // Bubble opacity based on confidence
            fill: fillColor, // Custom fill color for each bubble
            isClient: item.isClient,
            summary: platformData.summary || '',
            // Handle missing data - but still show the bubble
            hasData: platformData.visibility > 0 || platformData.strength > 0 || platformData.appearance > 0
        };
        
        // Debug logging
        console.log('Bubble chart data point:', result);
        
        return result;
    }).filter(item => item !== null); // Remove null entries
    
    console.log('AISentimentBubbleChart - Final chartData:', chartData);
    

    
    const CustomTooltip = ({ active, payload }) => {
        if (active && payload && payload.length) {
            const data = payload[0].payload;
            const platformName = selectedPlatform === 'chatGpt' ? 'ChatGPT' : 
                                 selectedPlatform === 'gemini' ? 'Gemini' : 'Perplexity';
            const sentimentText = data.signedSentiment >= 0 ? 'Positive' : 'Negative';
            const summary = data.summary.length > 500 ? data.summary.substring(0, 500) + '...' : data.summary;
            
            return (
                <div className="ai-bubble-tooltip bg-white dark:bg-gray-900 p-5 border border-gray-200 dark:border-gray-700 rounded-xl shadow-xl max-w-sm backdrop-blur-sm">
                    <div className="flex items-center justify-between mb-3">
                        <p className="font-bold text-gray-800 dark:text-gray-100">{data.clinicName}</p>
                        {data.isClient && (
                            <span className="text-xs bg-gradient-to-r from-blue-500 to-blue-600 text-white px-3 py-1 rounded-full font-medium">Your Business</span>
                        )}
                    </div>
                    <div className="space-y-3">
                        <div className="tooltip-header flex items-center justify-between p-2 bg-gray-50 dark:bg-transparent dark:border dark:border-gray-700 rounded-lg">
                            <span className="text-sm font-medium" style={{ color: platformColors[selectedPlatform] }}>
                                {platformName} Sentiment
                            </span>
                            <span className="text-sm font-bold dark:text-gray-100">
                                {data.hasData ? `${data.signedSentiment >= 0 ? '+' : ''}${Math.round(data.signedSentiment)}% ${sentimentText}` : 'Not found'}
                            </span>
                        </div>
                        <div className="flex items-center justify-between dark:bg-transparent">
                            <span className="text-sm text-gray-600 dark:text-gray-300">Visibility</span>
                            <span className="text-sm font-semibold text-gray-800 dark:text-gray-100">{Math.round(data.visibility)}%</span>
                        </div>
                        <div className="flex items-center justify-between dark:bg-transparent">
                            <span className="text-sm text-gray-600 dark:text-gray-300">Appearance</span>
                            <span className="text-sm font-semibold text-gray-800 dark:text-gray-100">{Math.round(data.appearance * 100)}%</span>
                        </div>
                        <div className="flex items-center justify-between dark:bg-transparent">
                            <span className="text-sm text-gray-600 dark:text-gray-300">Confidence</span>
                            <span className="text-sm font-semibold text-gray-800 dark:text-gray-100">{Math.round(data.confidence * 100)}%</span>
                        </div>
                        {data.hasData && summary && (
                            <div className="mt-4 pt-3 border-t border-gray-200 dark:border-gray-700">
                                <p className="text-xs text-gray-600 dark:text-gray-300 leading-relaxed">{summary}</p>
                            </div>
                        )}
                    </div>
                </div>
            );
        }
        return null;
    };
    
    return (
        <Card className="col-span-12 md:col-span-7 group hover:shadow-xl transition-all duration-300 hover:-translate-y-0.5 hover:border-blue-200/60 dark:hover:border-blue-400/60 min-h-[853px]">
            {/* Header */}
            <div className="flex justify-between items-center mb-6">
                <div className="flex items-center space-x-2">
                    <h2 className="text-xl font-bold" style={{ color: 'var(--text-primary)' }}>AI Visibility vs Sentiment</h2>
                    <InfoTooltip text="Bubble chart showing the relationship between AI platform visibility and sentiment strength. Bubble size represents appearance frequency." />
                </div>
                
                {/* Platform Toggle */}
                <div className="flex rounded-lg p-1 shadow-sm" style={{ backgroundColor: 'var(--btn-secondary-bg)' }}>
                    <button
                        onClick={() => setSelectedPlatform('chatGpt')}
                        className="px-4 py-2 rounded-md text-sm font-medium transition-colors duration-200"
                        style={{
                            backgroundColor: selectedPlatform === 'chatGpt' ? '#3b82f6' : 'transparent',
                            color: selectedPlatform === 'chatGpt' ? '#ffffff' : 'var(--text-primary)'
                        }}
                    >
                        ChatGPT
                    </button>
                    <button
                        onClick={() => setSelectedPlatform('gemini')}
                        className="px-4 py-2 rounded-md text-sm font-medium transition-colors duration-200"
                        style={{
                            backgroundColor: selectedPlatform === 'gemini' ? '#ec4899' : 'transparent',
                            color: selectedPlatform === 'gemini' ? '#ffffff' : 'var(--text-primary)'
                        }}
                    >
                        Gemini
                    </button>
                    <button
                        onClick={() => setSelectedPlatform('perplexity')}
                        className="px-4 py-2 rounded-md text-sm font-medium transition-colors duration-200"
                        style={{
                            backgroundColor: selectedPlatform === 'perplexity' ? '#8b5cf6' : 'transparent',
                            color: selectedPlatform === 'perplexity' ? '#ffffff' : 'var(--text-primary)'
                        }}
                    >
                        Perplexity
                    </button>
                </div>
            </div>
            
            {/* Chart */}
            <div className="h-[587px] relative">
                <div className="w-full h-full flex items-center justify-center">
                    <div className="w-full h-full relative">
                        {/* Y-axis label */}
                        <div className="absolute -left-8 top-1/2 transform -translate-y-1/2 -rotate-90 text-sm font-normal" style={{ color: 'var(--text-primary)' }}>
                            Sentiment Score (%)
                        </div>
                        {/* X-axis label */}
                        <div className="absolute bottom-2 left-1/2 transform -translate-x-1/2 text-sm font-normal" style={{ color: 'var(--text-primary)' }}>
                            Visibility (%)
                        </div>
                        <div className="ml-2 mr-8 h-full pb-8 pt-8">
                            <div className="bubble-chart-container h-full">
                                <ResponsiveContainer width="100%" height="100%">
                                    <ScatterChart margin={{ top: 60, right: 60, bottom: 40, left: 20 }}>
                                    <CartesianGrid strokeDasharray="2 2" stroke="#e5e7eb" strokeOpacity={0.5} />
                                    <XAxis 
                                        type="number" 
                                        dataKey="visibility" 
                                        name="Visibility" 
                                        domain={[-25, 100]}
                                        tickFormatter={(value) => value === -25 ? '' : `${value}%`}
                                        ticks={[-25, 0, 25, 50, 75, 100]}
                                        axisLine={false}
                                        tickLine={false}
                                        tick={{ fontSize: 12, fill: 'var(--chart-text)', fontWeight: 'normal' }}
                                    />
                                    <YAxis 
                                        type="number" 
                                        dataKey="signedSentiment" 
                                        name="Signed Sentiment" 
                                        domain={[0, 100]}
                                        ticks={[0, 20, 40, 60, 80, 100]}
                                        tickCount={6}
                                        interval={0}
                                        tickFormatter={(value) => `${value}`}
                                        axisLine={false}
                                        tickLine={false}
                                        tick={{ fontSize: 12, fill: 'var(--chart-text)', fontWeight: 'normal' }}
                                        allowDataOverflow={false}
                                        scale="linear"
                                    />
                                <Tooltip content={<CustomTooltip />} />
                                <Scatter 
                                    data={chartData} 
                                    fill="#8884d8"
                                    shape={(props) => {
                                        const { cx, cy, payload } = props;
                                        if (!payload || !cx || !cy) return null;
                                        
                                        const radius = payload.r || 8;
                                        const fillColor = payload.fill || '#8884d8';
                                        const strokeColor = payload.isClient ? '#1d4ed8' : fillColor;
                                        
                                        return (
                                            <g>
                                                {/* Outer glow effect for client */}
                                                {payload.isClient && (
                                                    <circle
                                                        cx={cx}
                                                        cy={cy}
                                                        r={radius + 2}
                                                        fill={strokeColor}
                                                        fillOpacity={0.15}
                                                    />
                                                )}
                                                {/* Main bubble */}
                                                <circle
                                                    cx={cx}
                                                    cy={cy}
                                                    r={radius}
                                                    fill={fillColor}
                                                    fillOpacity={payload.opacity || 0.7}
                                                    stroke={strokeColor}
                                                    strokeWidth={payload.isClient ? 2.5 : 1.5}
                                                    strokeOpacity={payload.opacity || 0.7}
                                                    filter="drop-shadow(0 2px 4px rgba(0,0,0,0.1))"
                                                />
                                            </g>
                                        );
                                    }}
                                />
                            </ScatterChart>
                        </ResponsiveContainer>
                    </div>
                </div>
            </div>
            </div>
            
            {/* Bottom Legend */}
            {data && data.length > 0 && (
                <div className="mt-6 pt-6 border-t border-gray-100">
                    <div className="flex flex-col items-center space-y-2">
                        {/* Top row - 3 items */}
                        <div className="flex justify-center space-x-6">
                            {data.slice(0, 3).map((item, index) => {
                                const truncateName = (name, maxLength = 14) => {
                                    if (!name || typeof name !== 'string') return name || 'Unknown';
                                    if (name.length <= maxLength) return name;
                                    return name.substring(0, maxLength - 1) + '…';
                                };
                                
                                return (
                                    <div key={item.clinicName} className="flex items-center space-x-2 min-w-0">
                                        <div 
                                            className="w-3 h-3 rounded shadow-sm flex-shrink-0"
                                            style={{ 
                                                backgroundColor: item.isClient ? clientColor : competitorColors[(index - (data.findIndex(d => d.isClient) >= 0 ? 1 : 0)) % competitorColors.length]
                                            }}
                                        ></div>
                                        <span className="text-xs font-medium truncate" style={{ color: 'var(--text-primary)' }} title={item.clinicName}>
                                            {truncateName(item.clinicName, 14)}
                                            {item.isClient && ' ⭐'}
                                        </span>
                                    </div>
                                );
                            })}
                        </div>
                        {/* Bottom row - 2 items (if they exist) */}
                        {data.length > 3 && (
                            <div className="flex justify-center space-x-6">
                                {data.slice(3).map((item, index) => {
                                    const actualIndex = index + 3;
                                    const truncateName = (name, maxLength = 14) => {
                                        if (!name || typeof name !== 'string') return name || 'Unknown';
                                        if (name.length <= maxLength) return name;
                                        return name.substring(0, maxLength - 1) + '…';
                                    };
                                    
                                    return (
                                        <div key={item.clinicName} className="flex items-center space-x-2 min-w-0">
                                            <div 
                                                className="w-3 h-3 rounded shadow-sm flex-shrink-0"
                                                style={{ 
                                                    backgroundColor: item.isClient ? clientColor : competitorColors[(actualIndex - (data.findIndex(d => d.isClient) >= 0 ? 1 : 0)) % competitorColors.length]
                                                }}
                                            ></div>
                                            <span className="text-xs font-medium truncate" style={{ color: 'var(--text-primary)' }} title={item.clinicName}>
                                                {truncateName(item.clinicName, 14)}
                                                {item.isClient && ' ⭐'}
                                            </span>
                                        </div>
                                    );
                                })}
                            </div>
                        )}
                    </div>
                </div>
            )}
        </div>
        </Card>
    );
});

const AISentimentBarChart = React.memo(({ data, loading, error }) => {
    const { ResponsiveContainer, BarChart, Bar, XAxis, YAxis, Tooltip, CartesianGrid, Cell } = window.Recharts;
    
    // Debug logging
    console.log('AISentimentBarChart - Loading:', loading, 'Error:', error, 'Data:', data);
    
    // Early return for any invalid data state
    if (loading || error || !data || !Array.isArray(data) || data.length === 0) {
        const message = loading ? "Loading AI sentiment data..." : 
                       error ? "Error loading AI sentiment data" : 
                       "No AI sentiment data available";
        console.log('AISentimentBarChart - Early return:', message);
        return (
            <Card className="col-span-12 md:col-span-5 group hover:shadow-xl transition-all duration-300 hover:-translate-y-0.5 hover:border-blue-200/60" style={{ backgroundColor: 'var(--card-bg)', minHeight: '740px' }}>
                <div className="flex items-center justify-center h-80">
                    <p className="text-gray-500">{message}</p>
                </div>
            </Card>
        );
    }
    
    // Transform and sort data
    const chartData = (data || []).map(item => {
        console.log('Processing item:', item);
        
        // Handle missing platform data gracefully
        const chatGptData = item.chatGpt || {};
        const geminiData = item.gemini || {};
        const perplexityData = item.perplexity || {};
        
        // Debug logging for Perplexity data
        if (item.isClient) {
            console.log('Frontend Perplexity Debug for Client:', {
                perplexityData: perplexityData,
                visibility: perplexityData.visibility,
                strength: perplexityData.strength,
                sentiment: perplexityData.sentiment,
                signedSentiment: perplexityData.signedSentiment
            });
        }
        
        // Use absolute strength values for bars (always positive direction)
        const chatGptScore = (chatGptData.strength || 0) * 100;
        const geminiScore  = (geminiData.strength  || 0) * 100;
        const perplexityScore = (perplexityData.strength || 0) * 100;
        
        const result = {
            clinicName: item.clinicName,
            chatGptScore: chatGptScore,
            geminiScore: geminiScore,
            perplexityScore: perplexityScore,
            avgScore: (chatGptScore + geminiScore + perplexityScore) / 3,
            isClient: item.isClient,
            chatGptSummary: chatGptData.summary || '',
            geminiSummary: geminiData.summary || '',
            perplexitySummary: perplexityData.summary || '',
            chatGptHasData: (chatGptData.visibility > 0 || chatGptData.strength > 0 || chatGptData.appearance > 0),
            geminiHasData: (geminiData.visibility > 0 || geminiData.strength > 0 || geminiData.appearance > 0),
            perplexityHasData: (perplexityData.visibility > 0 || perplexityData.strength > 0 || perplexityData.appearance > 0)
        };
        
        // Debug logging
        console.log('Bar chart data point:', result);
        
        return result;
    });
    
    console.log('AISentimentBarChart - Final chartData:', chartData);
    
    // If no data, create some test data to show the chart structure
    let displayData;
    if (chartData.length === 0) {
        console.log('No data available, creating test data');
        displayData = [
            { clinicName: 'Your Business', chatGptScore: 75, geminiScore: 60, perplexityScore: 65, avgScore: 66.7, isClient: true, chatGptHasData: true, geminiHasData: true, perplexityHasData: true },
            { clinicName: 'Competitor 1', chatGptScore: 45, geminiScore: 30, perplexityScore: 40, avgScore: 38.3, isClient: false, chatGptHasData: true, geminiHasData: true, perplexityHasData: true },
            { clinicName: 'Competitor 2', chatGptScore: 20, geminiScore: 40, perplexityScore: 25, avgScore: 28.3, isClient: false, chatGptHasData: true, geminiHasData: true, perplexityHasData: true }
        ];
    } else {
        displayData = [...chartData];
    }
    
    // Always show all companies, but filter bars based on view selection
    // This ensures the chart always shows something even if data is missing
    
    // Sort data - client always first, then by average score
    const sortedData = displayData.sort((a, b) => {
        // Client always first
        if (a.isClient && !b.isClient) return -1;
        if (!a.isClient && b.isClient) return 1;
        
        // Then sort by average score
        return b.avgScore - a.avgScore;
    });
    
    const CustomTooltip = ({ active, payload, label }) => {
        if (active && payload && payload.length) {
            const data = sortedData.find(item => item.clinicName === label);
            if (!data) return null;
            
            return (
                <div className="bg-white p-4 border border-gray-200 rounded-lg shadow-lg max-w-sm">
                    <p className="font-semibold text-gray-800 mb-2">{data.clinicName}</p>
                    <div className="space-y-2">
                        <div className="flex items-center justify-between">
                            <div className="flex items-center space-x-2">
                                <div className="w-3 h-3 bg-blue-500 rounded"></div>
                                <span className="text-sm font-medium pr-1">ChatGPT</span>
                            </div>
                            <span className="text-sm font-semibold">
                                {data.chatGptHasData ? `${Math.round(data.chatGptScore)}%` : 'Not found'}
                            </span>
                        </div>
                        <div className="flex items-center justify-between">
                            <div className="flex items-center space-x-2">
                                <div className="w-3 h-3 bg-pink-400 rounded"></div>
                                <span className="text-sm font-medium pr-1">Gemini</span>
                            </div>
                            <span className="text-sm font-semibold">
                                {data.geminiHasData ? `${Math.round(data.geminiScore)}%` : 'Not found'}
                            </span>
                        </div>
                        <div className="flex items-center justify-between">
                            <div className="flex items-center space-x-2">
                                <div className="w-3 h-3 bg-purple-500 rounded"></div>
                                <span className="text-sm font-medium pr-1">Perplexity</span>
                            </div>
                            <span className="text-sm font-semibold">
                                {data.perplexityHasData ? `${Math.round(data.perplexityScore)}%` : 'Not found'}
                            </span>
                        </div>
                        {data.isClient && (
                            <div className="mt-2 pt-2 border-t border-gray-200">
                                <span className="text-xs text-blue-600 font-medium">Your Business</span>
                            </div>
                        )}
                    </div>
                </div>
            );
        }
        return null;
    };
    
    return (
        <Card className="col-span-12 md:col-span-5 group hover:shadow-xl transition-all duration-300 hover:-translate-y-0.5 hover:border-blue-200/60" style={{ backgroundColor: 'var(--card-bg)', minHeight: '720px' }}>
            {/* Header */}
            <div className="flex justify-between items-center mb-4">
                <div className="flex items-center space-x-2">
                    <h2 className="text-xl font-bold" style={{ color: 'var(--text-primary)' }}>AI Perception</h2>
                    <InfoTooltip text="Horizontal bar chart comparing sentiment scores across AI platforms. Shows signed sentiment (strength × sentiment direction) for each brand." />
                </div>
                
                {/* Removed platform selector for simplicity */}
            </div>
            
            {/* Legend */}
            <div className="flex items-center space-x-6 mb-4">
                <div className="flex items-center space-x-2">
                    <div className="w-3 h-3 rounded" style={{ backgroundColor: '#3b82f6' }}></div>
                    <span className="text-sm" style={{ color: 'var(--text-primary)' }}>ChatGPT</span>
                </div>
                <div className="flex items-center space-x-2">
                    <div className="w-3 h-3 rounded" style={{ backgroundColor: '#ec4899' }}></div>
                    <span className="text-sm" style={{ color: 'var(--text-primary)' }}>Gemini</span>
                </div>
                <div className="flex items-center space-x-2">
                    <div className="w-3 h-3 rounded" style={{ backgroundColor: '#8b5cf6' }}></div>
                    <span className="text-sm" style={{ color: 'var(--text-primary)' }}>Perplexity</span>
                </div>
            </div>
            
            {/* Chart */}
            <div className="h-[580px] relative">
                <div className="w-full h-full">
                    <div className="w-full h-full relative">
                        {/* X-axis label */}
                        <div className="absolute left-[55%] transform -translate-x-1/2 text-sm font-normal" style={{ color: 'var(--text-primary)', bottom: '28px', left: 'calc(55% - 10px)' }}>
                            Sentiment
                        </div>
                        <div className="h-full pb-8">
                            <ResponsiveContainer width="95%" height="100%">
                                <BarChart
                                    data={sortedData}
                                    layout="vertical"
                                    margin={{ top: 10, right: 0, left: 0, bottom: 60 }}
                                    barCategoryGap={14}
                                    barGap={4}
                                >
                                    <CartesianGrid strokeDasharray="2 2" stroke="#e5e7eb" strokeOpacity={0.5} />
                                    <XAxis 
                                        type="number" 
                                        domain={[0, 100]}
                                        ticks={[0,20,40,60,80,100]}
                                        tickFormatter={(value) => `${value}%`}
                                        axisLine={false}
                                        tickLine={false}
                                        tick={{ fontSize: 12, fill: 'var(--chart-text)', fontWeight: 'normal' }}
                                    />
                                    <YAxis 
                                        type="category" 
                                        dataKey="clinicName" 
                                        width={90}
                                        tickMargin={10}
                                        tick={{ fontSize: 13, fill: (document.documentElement.getAttribute('data-theme')==='dark')? 'var(--text-primary)' : '#4b5563', fontWeight: '500', whiteSpace: 'pre-line' }}
                                        axisLine={false}
                                        tickLine={false}
                                        tickFormatter={(value) => {
                                            if (!value) return '';
                                            const maxLine = 14;
                                            if (value.length <= maxLine) return value;
                                            const first = value.substring(0, maxLine).trim();
                                            let second = value.substring(maxLine).trim();
                                            if (second.length > maxLine - 1) second = second.substring(0, maxLine - 1) + '…';
                                            return `${first}\n${second}`;
                                        }}
                                    />
                                    <Tooltip content={<CustomTooltip />} />
                                    <Bar dataKey="chatGptScore" fill="#3b82f6" name="ChatGPT" radius={[0,4,4,0]} barSize={18}>
                                       {sortedData.map((entry, idx)=>(<Cell key={`cg-${idx}`} fill="#3b82f6" fillOpacity={entry.chatGptHasData?0.9:0.2}/>))}
                                    </Bar>
                                    <Bar dataKey="geminiScore" fill="#ec4899" name="Gemini" radius={[0,4,4,0]} barSize={18}>
                                       {sortedData.map((entry, idx)=>(<Cell key={`gm-${idx}`} fill="#ec4899" fillOpacity={entry.geminiHasData?0.9:0.2}/>))}
                                    </Bar>
                                    <Bar dataKey="perplexityScore" fill="#8b5cf6" name="Perplexity" radius={[0,4,4,0]} barSize={18}>
                                       {sortedData.map((entry, idx)=>(<Cell key={`px-${idx}`} fill="#8b5cf6" fillOpacity={entry.perplexityHasData?0.9:0.2}/>))}
                                    </Bar>
                                </BarChart>
                            </ResponsiveContainer>
                        </div>
                    </div>
                </div>
            </div>

            {/* Mini Stat Cards removed – now independent cards */}
        </Card>
    );
});
const Dashboard = ({ setActiveTab, webhooks, setData }) => {
    const { ResponsiveContainer, BarChart, Bar, XAxis, YAxis, Tooltip, CartesianGrid, Cell, PieChart, Pie, Legend, ScatterChart, Scatter } = window.Recharts;
    
    // --- Additional Icon Components for this page ---
    const ExternalLink = createIcon(
      <>
        <path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6" />
        <polyline points="15 3 21 3 21 9" />
        <line x1="10" y1="14" x2="21" y2="3" />
      </>
    );
    const ChevronDown = createIcon(<polyline points="6 9 12 15 18 9" />);
    const ChevronUp = createIcon(<polyline points="18 15 12 9 6 15" />);

    // --- Reusable Components for this page ---
    const AdIndicator = ({ status, link }) => {
        if (status === 'No Ads Found') {
            return <span className="px-2 py-1 text-xs font-semibold rounded-full bg-red-100 text-red-800">No Ads</span>;
        }
        if (status === '1 Ad Found' || status === 'Multiple Ads Found') {
            return (
                <a href={link} target="_blank" rel="noopener noreferrer" 
                   className="inline-flex items-center px-2 py-1 bg-green-100 text-green-800 text-xs font-semibold rounded-full hover:bg-green-200 transition-colors">
                    {status === '1 Ad Found' ? '1 Ad' : 'Multiple'} <ExternalLink className="w-3 h-3 ml-1.5" />
                </a>
            );
        }
        return <span className="px-2 py-1 text-xs font-semibold rounded-full bg-gray-100 text-gray-800">Unknown</span>;
    };

    // --- Mini Stat Card Components (Visibility & Sentiment) ---
    const ArrowUp = createIcon(<polyline points="6 15 12 9 18 15" />);
    const ArrowDown = createIcon(<polyline points="6 9 12 15 18 9" />);

    const VisibilityStatCard = ({ data }) => {
        const client = (data || []).find(d => d.isClient) || {};
        const vis1 = client.chatGpt?.visibility ?? 0;
        const vis2 = client.gemini?.visibility ?? 0;
        const vis3 = client.perplexity?.visibility ?? 0;
        let avgVis = (vis1 + vis2 + vis3) / 3;
        if (avgVis <= 1) avgVis = avgVis * 100; // convert ratio to percentage if needed
        const value = Math.round(avgVis);
        const change = 0;
        return (
            <Card className="w-full hover:shadow-lg transition-all duration-300 border border-gray-100 dark:border-gray-700" style={{ backgroundColor: 'var(--card-bg)', minHeight: '160px' }}>
                <div className="flex items-center justify-between p-5">
                    <div>
                        <p className="text-sm font-medium" style={{ color: 'var(--text-secondary)' }}>Your&nbsp;Avg&nbsp;AI&nbsp;Visibility</p>
                        <p className="text-2xl font-bold" style={{ color: 'var(--text-primary)' }}>{value}%</p>
                    </div>
                    <div className={`flex items-center ${change >= 0 ? 'text-green-600' : 'text-red-600'}`}> 
                        {change >= 0 ? <ArrowUp className="w-4 h-4" /> : <ArrowDown className="w-4 h-4" />} 
                        <span className="ml-1 text-sm font-semibold">{Math.abs(change)}%</span>
                    </div>
                </div>
            </Card>
        );
    };

    const SentimentStatCard = ({ data }) => {
        const client = (data || []).find(d => d.isClient) || {};
        const sent1 = client.chatGpt?.signedSentiment ?? client.chatGpt?.sentiment ?? 0;
        const sent2 = client.gemini?.signedSentiment ?? client.gemini?.sentiment ?? 0;
        const sent3 = client.perplexity?.signedSentiment ?? client.perplexity?.sentiment ?? 0;
        const value = Math.round(((sent1 + sent2 + sent3) / 3) * 100);
        const change = 0;
        return (
            <Card className="w-full hover:shadow-lg transition-all duration-300 border border-gray-100 dark:border-gray-700" style={{ backgroundColor: 'var(--card-bg)', minHeight: '160px' }}>
                <div className="flex items-center justify-between p-5">
                    <div>
                        <p className="text-sm font-medium" style={{ color: 'var(--text-secondary)' }}>Your&nbsp;Avg&nbsp;AI&nbsp;Sentiment</p>
                        <p className="text-2xl font-bold" style={{ color: 'var(--text-primary)' }}>{value}%</p>
                    </div>
                    <div className={`flex items-center ${change >= 0 ? 'text-green-600' : 'text-red-600'}`}> 
                        {change >= 0 ? <ArrowUp className="w-4 h-4" /> : <ArrowDown className="w-4 h-4" />} 
                        <span className="ml-1 text-sm font-semibold">{Math.abs(change)}%</span>
                    </div>
                </div>
            </Card>
        );
    };

    // --- Sub-components for Dashboard ---
    const GeogridSection = React.memo(({ setActiveTab }) => {
        const [geogridData, setGeogridData] = useState(null);
        const [loading, setLoading] = useState(true);
        const [error, setError] = useState(null);
        const [dashboardMonthIndex, setDashboardMonthIndex] = useState(0);

        useEffect(() => {
            const params = new URLSearchParams(window.location.search);
            const workbookId = params.get('workbookId');
            if (!workbookId) {
                setError("No workbook ID provided");
                setLoading(false);
                return;
            }

            // Check cache first
            const cacheKey = `geogrid_${workbookId}`;
            const cachedData = sessionStorage.getItem(cacheKey);
            if (cachedData) {
                try {
                    const parsed = JSON.parse(cachedData);
                    const medspaNearMe = parsed['medspa near me'] || [];
                    
                    // Apply same date formatting as fresh data
                    const fixDateFormatting = (monthlyData) => {
                        const parsedDates = monthlyData.map((monthData, index) => {
                            let parsedDate = null;
                            
                            // First try to use the backend's parsedDate if available
                            if (monthData.parsedDate) {
                                parsedDate = new Date(monthData.parsedDate);
                            }
                            
                            // If parsedDate is invalid or not available, try other approaches
                            if (!parsedDate || isNaN(parsedDate.getTime())) {
                                // Try parsing the date field directly
                                if (monthData.date) {
                                    parsedDate = new Date(monthData.date);
                                    
                                    // If that fails, try US date format parsing
                                    if (isNaN(parsedDate.getTime())) {
                                        const dateStr = monthData.date.toString();
                                        const parts = dateStr.split('/');
                                        if (parts.length === 3) {
                                            const month = parseInt(parts[0]) - 1; // Convert to 0-based
                                            const day = parseInt(parts[1]);
                                            const year = parseInt(parts[2]);
                                            parsedDate = new Date(year, month, day);
                                        }
                                    }
                                }
                                
                                // Try parsing rawDate if available
                                if ((!parsedDate || isNaN(parsedDate.getTime())) && monthData.rawDate) {
                                    parsedDate = new Date(monthData.rawDate);
                                    
                                    // If that fails, try US date format parsing on rawDate
                                    if (isNaN(parsedDate.getTime())) {
                                        const dateStr = monthData.rawDate.toString();
                                        const parts = dateStr.split('/');
                                        if (parts.length === 3) {
                                            const month = parseInt(parts[0]) - 1; // Convert to 0-based
                                            const day = parseInt(parts[1]);
                                            const year = parseInt(parts[2]);
                                            parsedDate = new Date(year, month, day);
                                        }
                                    }
                                }
                            }
                            
                            return {
                                ...monthData,
                                originalDate: monthData.date,
                                parsedDate: parsedDate,
                                index: index
                            };
                        });
                        
                        // Check if we have valid parsed dates
                        const validDates = parsedDates.filter(item => item.parsedDate && !isNaN(item.parsedDate.getTime()));
                        
                        if (validDates.length === 0) {
                            console.log('⚠️ Dashboard cache: No valid dates found, using fallback sequential logic');
                            // Fallback to sequential month logic
                            return monthlyData.map((monthData, index) => {
                                const currentDate = new Date();
                                const currentMonth = currentDate.getMonth();
                                const currentYear = currentDate.getFullYear();
                                
                                let targetMonth = currentMonth - index;
                                let targetYear = currentYear;
                                
                                if (targetMonth < 0) {
                                    targetMonth += 12;
                                    targetYear--;
                                }
                                
                                const correctedDate = new Date(targetYear, targetMonth, 1);
                                const formattedDate = correctedDate.toLocaleString('default', { 
                                    month: 'long', 
                                    year: 'numeric'
                                });
                                
                                return {
                                    ...monthData,
                                    date: formattedDate,
                                    originalDate: monthData.date,
                                    correctedDate: correctedDate
                                };
                            });
                        }
                        
                        // If we have valid dates, sort by date (newest first) and format properly
                        validDates.sort((a, b) => b.parsedDate.getTime() - a.parsedDate.getTime());
                        
                        console.log('✅ Dashboard cache: Valid dates after sorting:', validDates.map(v => ({
                            date: v.parsedDate.toLocaleString('default', { month: 'long', year: 'numeric' }),
                            parsedDate: v.parsedDate,
                            originalDate: v.originalDate
                        })));
                        
                        return validDates.map(item => {
                            const formattedDate = item.parsedDate.toLocaleString('default', { 
                                month: 'long', 
                                year: 'numeric'
                            });
                            
                            return {
                                ...item,
                                date: formattedDate,
                                correctedDate: item.parsedDate
                            };
                        });
                    };
                    
                    // Process the cached data with proper date formatting
                    const processedMedspaNearMe = medspaNearMe.length > 0 ? fixDateFormatting(medspaNearMe) : [];
                    setGeogridData(processedMedspaNearMe);
                    setLoading(false);
                    return;
                } catch (e) {
                    // Invalid cache, continue with fresh fetch
                    console.error('Cache parsing error:', e);
                }
            }

            const scriptUrl = `https://script.google.com/macros/s/AKfycbxfOMp8d_eCVH4lFD0PNuFU1wH-gyWOwRt2EuME7GQJ4U73ZwpPDciohDH3C566YLWq/exec?workbookId=${workbookId}`;
            
            fetchWithCorsWorkaround(scriptUrl, (err, data) => {
                if (err) {
                    setError(err.message);
                    setLoading(false);
                    return;
                }
                if (data.error) {
                    setError(`Script error: ${data.error}`);
                    setLoading(false);
                    return;
                }
                
                try {
                    // Enhanced date formatting function (same as in GeogridMaps)
                    const fixDateFormatting = (monthlyData) => {
                        const parsedDates = monthlyData.map((monthData, index) => {
                            let parsedDate = null;
                            
                            // First try to use the backend's parsedDate if available
                            if (monthData.parsedDate) {
                                parsedDate = new Date(monthData.parsedDate);
                                console.log(`Using backend parsedDate for index ${index}:`, parsedDate);
                            }
                            
                            // If parsedDate is invalid or not available, try other approaches
                            if (!parsedDate || isNaN(parsedDate.getTime())) {
                                // Try parsing the date field directly
                                if (monthData.date) {
                                    parsedDate = new Date(monthData.date);
                                    
                                    // If that fails, try US date format parsing
                                    if (isNaN(parsedDate.getTime())) {
                                        const dateStr = monthData.date.toString();
                                        const parts = dateStr.split('/');
                                        if (parts.length === 3) {
                                            const month = parseInt(parts[0]) - 1; // Convert to 0-based
                                            const day = parseInt(parts[1]);
                                            const year = parseInt(parts[2]);
                                            parsedDate = new Date(year, month, day);
                                        }
                                    }
                                }
                                
                                // Try parsing rawDate if available
                                if ((!parsedDate || isNaN(parsedDate.getTime())) && monthData.rawDate) {
                                    parsedDate = new Date(monthData.rawDate);
                                    
                                    // If that fails, try US date format parsing on rawDate
                                    if (isNaN(parsedDate.getTime())) {
                                        const dateStr = monthData.rawDate.toString();
                                        const parts = dateStr.split('/');
                                        if (parts.length === 3) {
                                            const month = parseInt(parts[0]) - 1; // Convert to 0-based
                                            const day = parseInt(parts[1]);
                                            const year = parseInt(parts[2]);
                                            parsedDate = new Date(year, month, day);
                                        }
                                    }
                                }
                            }
                            
                            return {
                                ...monthData,
                                originalDate: monthData.date,
                                parsedDate: parsedDate,
                                index: index
                            };
                        });
                        
                        // Check if we have valid parsed dates
                        const validDates = parsedDates.filter(item => item.parsedDate && !isNaN(item.parsedDate.getTime()));
                        
                        if (validDates.length === 0) {
                            console.log('⚠️ Dashboard: No valid dates found, using fallback sequential logic');
                            // Fallback to sequential month logic
                            return monthlyData.map((monthData, index) => {
                                const currentDate = new Date();
                                const currentMonth = currentDate.getMonth();
                                const currentYear = currentDate.getFullYear();
                                
                                let targetMonth = currentMonth - index;
                                let targetYear = currentYear;
                                
                                if (targetMonth < 0) {
                                    targetMonth += 12;
                                    targetYear--;
                                }
                                
                                const correctedDate = new Date(targetYear, targetMonth, 1);
                                const formattedDate = correctedDate.toLocaleString('default', { 
                                    month: 'long', 
                                    year: 'numeric'
                                });
                                
                                return {
                                    ...monthData,
                                    date: formattedDate,
                                    originalDate: monthData.date,
                                    correctedDate: correctedDate
                                };
                            });
                        }
                        
                        // If we have valid dates, sort by date (newest first) and format properly
                        validDates.sort((a, b) => b.parsedDate.getTime() - a.parsedDate.getTime());
                        
                        console.log('✅ Dashboard: Valid dates after sorting:', validDates.map(v => ({
                            date: v.parsedDate.toLocaleString('default', { month: 'long', year: 'numeric' }),
                            parsedDate: v.parsedDate,
                            originalDate: v.originalDate
                        })));
                        
                        return validDates.map(item => {
                            const formattedDate = item.parsedDate.toLocaleString('default', { 
                                month: 'long', 
                                year: 'numeric'
                            });
                            
                            return {
                                ...item,
                                date: formattedDate,
                                correctedDate: item.parsedDate
                            };
                        });
                    };

                    // Get the geogrid data for 'medspa near me' with all months
                    const allGeogridData = data.geogridData || {};
                    const medspaNearMe = allGeogridData['medspa near me'] || [];
                    
                    // Apply date formatting to the dashboard data
                    const processedMedspaNearMe = medspaNearMe.length > 0 ? fixDateFormatting(medspaNearMe) : [];
                    
                    // Store the full geogrid data in cache (but don't overwrite the processed data)
                    sessionStorage.setItem(cacheKey, JSON.stringify(allGeogridData));
                    
                    // Set the processed monthly data for dashboard display
                    setGeogridData(processedMedspaNearMe);
                    setLoading(false);
                } catch (e) {
                    console.error('Data processing error:', e);
                    setError('Failed to process geogrid data');
                    setLoading(false);
                }
            });
        }, []);

        if (loading) {
            return (
                <Card className="col-span-12 lg:col-span-8">
                    <div className="flex items-center justify-center p-12 select-none">
                        <div className="w-6 h-6 border-2 border-blue-500 border-t-transparent rounded-full animate-spin mr-3"></div>
                        <p className="text-gray-500">Loading Geogrid data...</p>
                    </div>
                </Card>
            );
        }
        if (error) {
            return <Card className="col-span-12 lg:col-span-8 flex items-center justify-center"><p className="text-red-500">Geogrid Error: {error}</p></Card>;
        }
        if (!geogridData || geogridData.length === 0) {
            return <Card className="col-span-12 lg:col-span-8 flex items-center justify-center"><p className="text-gray-500">No Geogrid data to display for 'medspa near me'.</p></Card>;
        }

        const getRankColor = (rank) => {
            if (rank === null || rank === undefined) return 'bg-gray-400';
            if (rank <= 3) return 'bg-green-500';
            if (rank <= 5) return 'bg-sky-500';
            if (rank <= 10) return 'bg-yellow-500';
            if (rank <= 20) return 'bg-orange-500';
            return 'bg-red-500';
        };

        // Calculate current data based on state
        const currentDashboardData = geogridData[dashboardMonthIndex] || geogridData[0];
        const displayMonthNumber = geogridData.length - dashboardMonthIndex;

        const handleDashboardDateChange = (direction) => {
            const newIndex = dashboardMonthIndex + direction;
            if (newIndex >= 0 && newIndex < geogridData.length) {
                setDashboardMonthIndex(newIndex);
            }
        };

        if (!currentDashboardData) {
            return <Card className="col-span-12 lg:col-span-8 flex items-center justify-center"><p className="text-gray-500">No current month data available.</p></Card>;
        }

        return (
            <Card className="col-span-12 lg:col-span-8">
                <div className="grid grid-cols-1 lg:grid-cols-4 gap-6">
                    {/* Modern Competitor Rankings */}
                    {currentDashboardData.competitors && currentDashboardData.competitors.length > 0 && (
                        <div className="lg:col-span-1 flex flex-col">
                            <div className="flex justify-between items-center mb-4 min-h-[60px]">
                                <div className="flex items-center space-x-2">
                                    <h2 className="text-xl font-bold text-gray-800">Avg Score</h2>
                                </div>
                            </div>
                            <div className="space-y-2.5 max-h-[580px] overflow-visible">
                                {currentDashboardData.competitors.map((comp, index) => {
                                    const isClient = comp.isClient;
                                    const rank = typeof comp.rank === 'number' ? comp.rank : 0;
                                    
                                    // Improved color scheme for geogrid scores (lower is better)
                                    const getScoreColors = (score) => {
                                        if (score <= 3) {
                                            return {
                                                border: 'border-green-500',
                                                bg: 'bg-green-50',
                                                text: 'text-green-700',
                                                accent: 'bg-green-500'
                                            };
                                        } else if (score <= 7) {
                                            return {
                                                border: 'border-yellow-500',
                                                bg: 'bg-yellow-50',
                                                text: 'text-yellow-700',
                                                accent: 'bg-yellow-500'
                                            };
                                        } else {
                                            return {
                                                border: 'border-red-500',
                                                bg: 'bg-red-50',
                                                text: 'text-red-700',
                                                accent: 'bg-red-500'
                                            };
                                        }
                                    };
                                    
                                    const scoreColors = getScoreColors(rank);
                                    
                                    // Position indicators
                                    const getPositionText = (index) => {
                                        const positions = ['1st', '2nd', '3rd', '4th', '5th'];
                                        return positions[index] || `${index + 1}th`;
                                    };
                                    
                                    return (
                                        <div key={index} className="group relative overflow-visible rounded-xl transition-all duration-300 hover:shadow-lg bg-white border border-gray-200 hover:border-gray-300 hover:shadow-md geogrid-card">
                                            {/* Position Badge - Top Left, Half In/Half Out */}
                                            <div className="absolute -top-1 -left-1 z-10">
                                                <span className={`inline-block px-1.5 py-0.5 rounded-full text-[11px] font-bold shadow-sm ${
                                                    index === 0 ? 'bg-yellow-500 text-white' :
                                                    index === 1 ? 'bg-gray-500 text-white' :
                                                    index === 2 ? 'bg-orange-500 text-white' :
                                                    'bg-blue-500 text-white'
                                                }`}>
                                                    {getPositionText(index)}
                                                </span>
                                            </div>
                                            
                                            {/* Subtle background pattern */}
                                            <div className="absolute inset-0 bg-gradient-to-br from-white/50 to-transparent pointer-events-none"></div>
                                            
                                            <div className="relative p-2.5 pt-5.5 flex items-center justify-between">
                                                {/* Business Info */}
                                                <div className="flex-1 min-w-0 pr-3">
                                                    <div className="flex items-center space-x-2">
                                                        <p className="font-semibold text-sm leading-tight truncate text-gray-800" title={comp.name || 'Unknown'}>
                                                            {comp.name || 'Unknown'}
                                                        </p>
                                                        {isClient && (
                                                            <div className="flex-shrink-0 w-4 h-4 bg-blue-500 rounded-full flex items-center justify-center">
                                                                <span className="text-xs text-white font-bold">★</span>
                                                            </div>
                                                        )}
                                                    </div>
                                                </div>
                                                
                                                {/* Score Display with Colored Circle */}
                                                <div className="flex-shrink-0 text-right">
                                                    <div className={`w-12 h-12 rounded-full border-2 flex items-center justify-center ${
                                                        index === 0 ? 'border-green-600' :
                                                        index === 1 ? 'border-green-500' :
                                                        index === 2 ? 'border-green-400' :
                                                        index >= 3 && index <= 7 ? 'border-yellow-500' :
                                                        index >= 8 && index <= 11 ? 'border-blue-500' :
                                                        'border-red-500'
                                                    }`}>
                                                        <span className="text-sm font-bold avg-score-text">
                                                            {rank > 0 ? rank.toFixed(1) : '-'}
                                                        </span>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    );
                                })}
                            </div>
                        </div>
                    )}
                    
                    {/* Geogrid Map on the Right */}
                    <div className="lg:col-span-3">
                        <div className="flex justify-between items-center mb-4">
                            <div className="flex items-center space-x-2">
                                <h2 className="text-xl font-bold text-gray-800">Medspa Near Me</h2>
                                <InfoTooltip text="A snapshot of your Geogrid map for the keyword 'medspa near me'." />
                                <button onClick={() => setActiveTab('Geogrid Maps')} className="text-xs font-normal text-blue-600 hover:text-blue-800">(See More)</button>
                            </div>
                            
                            {/* Month slider controls */}
                            {geogridData.length > 1 && (
                                <div className="flex items-center space-x-3">
                                    <button 
                                        onClick={() => handleDashboardDateChange(1)} 
                                        disabled={dashboardMonthIndex >= geogridData.length - 1}
                                        className="flex items-center justify-center w-8 h-8 rounded-lg bg-blue-100 hover:bg-blue-200 disabled:opacity-50 disabled:cursor-not-allowed text-blue-600 transition-colors"
                                        title="Go back to older month"
                                    >
                                        <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M15 19l-7-7 7-7" />
                                        </svg>
                                    </button>
                                    <div className="text-center">
                                        <span className="font-semibold text-gray-700 text-sm">{currentDashboardData.date || 'No date'}</span>
                                        <div className="text-xs text-gray-500">
                                            {displayMonthNumber} of {geogridData.length}
                                        </div>
                                        <div className="flex items-center justify-center space-x-1 mt-1">
                                            {geogridData.map((_, index) => {
                                                const visualIndex = geogridData.length - 1 - index;
                                                return (
                                                    <div
                                                        key={index}
                                                        className={`w-2 h-2 rounded-full ${
                                                            index === dashboardMonthIndex 
                                                                ? 'bg-blue-600' 
                                                                : 'bg-gray-300 hover:bg-gray-400'
                                                        } cursor-pointer transition-colors`}
                                                        onClick={() => setDashboardMonthIndex(index)}
                                                        title={`Go to ${geogridData[index]?.date || 'Unknown month'} (${geogridData.length - index} of ${geogridData.length})`}
                                                        style={{ order: visualIndex }}
                                                    />
                                                );
                                            })}
                                        </div>
                                    </div>
                                    <button 
                                        onClick={() => handleDashboardDateChange(-1)} 
                                        disabled={dashboardMonthIndex <= 0}
                                        className="flex items-center justify-center w-8 h-8 rounded-lg bg-blue-100 hover:bg-blue-200 disabled:opacity-50 disabled:cursor-not-allowed text-blue-600 transition-colors"
                                        title="Go forward to newer month"
                                    >
                                        <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M9 5l7 7-7 7" />
                                        </svg>
                                    </button>
                                </div>
                            )}
                            
                            {/* Single month display */}
                            {geogridData.length === 1 && (
                                <span className="font-semibold text-gray-700">{currentDashboardData.date}</span>
                            )}
                        </div>
                        {currentDashboardData.mapLink ? (
                            <div className="relative w-full h-[600px] overflow-hidden map-container" onClick={handleMapActivate} onMouseLeave={handleMapDeactivate}>
                                <iframe 
                                    src={processMapUrlForCentering(currentDashboardData.mapLink)}
                                    className="w-full h-full rounded-lg border border-gray-200 map-iframe"
                                    style={{ background: '#f9fafb' }}
                                    loading="lazy"
                                    allowFullScreen
                                    scrolling="no"
                                />
                                <a 
                                    href={currentDashboardData.mapLink} 
                                    target="_blank" 
                                    rel="noopener noreferrer"
                                    className="absolute bottom-2 right-2 bg-white/90 hover:bg-white text-gray-700 px-2 py-1 rounded text-xs flex items-center gap-1 shadow-sm transition-colors"
                                >
                                    <ExternalLink className="w-3 h-3 mr-1" />
                                    Open in new tab
                                </a>
                            </div>
                        ) : (
                            <div className="w-full h-[600px] flex flex-col items-center justify-center bg-gray-50 rounded-lg border-2 border-dashed border-gray-200">
                                <div className="bg-gray-100 p-4 rounded-full mb-4">
                                    <svg className="w-12 h-12 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M9 20l-5.447-2.724A1 1 0 013 16.382V5.618a1 1 0 011.447-.894L9 7m0 13l6-3m-6 3V7m6 10l4.553 2.276A1 1 0 0021 18.382V7.618a1 1 0 00-.553-.894L15 4m0 13V4m0 0L9 7" />
                                    </svg>
                                </div>
                                <p className="text-lg font-semibold text-gray-600 mb-2">Map Not Available Yet</p>
                                <p className="text-sm text-gray-500 text-center max-w-md">
                                    The Geogrid map for "medspa near me" is pending setup. Once available, it will show local search rankings across your service area.
                                </p>
                            </div>
                        )}
                    </div>
                </div>
            </Card>
        );
    });

    const CensusInfo = React.memo(({ censusData, loading, error }) => {
        if (loading) {
            return <Card className="col-span-12 lg:col-span-4 h-full flex items-center justify-center"><p className="text-gray-500">Loading Census data...</p></Card>;
        }
        if (error) {
            return <Card className="col-span-12 lg:col-span-4 h-full flex items-center justify-center"><p className="text-red-500">Census Error: {error}</p></Card>;
        }
        if (!censusData) {
            return <Card className="col-span-12 lg:col-span-4 h-full flex items-center justify-center"><p className="text-gray-500">No census data available.</p></Card>;
        }

        return (
                            <Card className="col-span-12 lg:col-span-4 h-full group hover:shadow-xl transition-all duration-300 hover:-translate-y-0.5 hover:border-blue-200/60">
                 <div className="flex items-center space-x-2 mb-4">
                    <h2 className="text-xl font-bold text-gray-800">Census Data</h2>
                    <InfoTooltip text="Provides demographic and economic information for your target service area." />
                 </div>
                <div>
                    {Object.entries(censusData).map(([key, value]) => {
                        if (!value) return null;
                        
                        // Special formatting for multi-line values
                        if (['Age Ranges', 'Ethnicity', 'Gender', 'Languages'].includes(key)) {
                            let items = [];
                            
                            if (key === 'Gender' || key === 'Languages') {
                                items = value.split(' / ');
                            } else if (key === 'Age Ranges' || key === 'Ethnicity') {
                                // Parse age ranges and ethnicity data that comes in format like "0-17 11.3% 18-34: 19.1%"
                                // Split by patterns that indicate new entries (age range followed by percentage)
                                const regex = /(\d+[-\w\s]+?):\s*(\d+\.?\d*%)/g;
                                let match;
                                const parsedItems = [];
                                
                                while ((match = regex.exec(value)) !== null) {
                                    parsedItems.push(`${match[1].trim()}: ${match[2]}`);
                                }
                                
                                // If regex parsing didn't work, fall back to simpler splitting
                                if (parsedItems.length === 0) {
                                    // Try alternative parsing - split on percentage signs and rebuild
                                    const parts = value.split('%');
                                    for (let i = 0; i < parts.length - 1; i++) {
                                        const part = parts[i].trim();
                                        const lastSpaceIndex = part.lastIndexOf(' ');
                                        if (lastSpaceIndex > 0) {
                                            const label = part.substring(0, lastSpaceIndex).trim();
                                            const percentage = part.substring(lastSpaceIndex + 1).trim();
                                            if (label && percentage) {
                                                const cleanLabel = label.replace(/:+\s*$/, '').trim();
                                                parsedItems.push(`${cleanLabel}: ${percentage}%`);
                                            }
                                        }
                                    }
                                }
                                
                                items = parsedItems.length > 0 ? parsedItems : value.split(' ');
                            } else {
                                items = value.split(' ');
                            }
                            
                            return (
                                <div key={key} className="flex justify-between text-sm py-3 border-t border-gray-100 first:border-t-0 first:pt-0">
                                    <span className="text-gray-600">{key}</span>
                                    <div className="text-right text-gray-600 space-y-1">
                                        {items.map((item, idx) => (
                                            <div key={idx}>{item.trim()}</div>
                                        ))}
                                    </div>
                                </div>
                            );
                        }
                        
                        // Default display for other fields
                        let displayValue = value;
                        if (key === 'Median Income' && !String(value).startsWith('$')) {
                            displayValue = `$${value}`;
                        }
                        
                        return (
                            <div key={key} className="flex justify-between items-center text-sm py-3 border-t border-gray-100 first:border-t-0 first:pt-0">
                                <span className="text-gray-600">{key}</span>
                                <span className="text-gray-600 text-right">{displayValue}</span>
                            </div>
                        )
                    })}
                </div>
            </Card>
        );
    });
    const OverviewTable = React.memo(({ overviewData, loading, error, onRefresh, isRefreshing, refreshProgress, refreshMessage }) => {
        if (loading) {
            return <Card className="col-span-12 overflow-x-auto flex items-center justify-center"><p className="text-gray-500">Loading Overview data...</p></Card>;
        }
        if (error) {
            return <Card className="col-span-12 overflow-x-auto flex items-center justify-center"><p className="text-red-500">Overview Error: {error}</p></Card>;
        }
        if (!overviewData || overviewData.length === 0) {
            return <Card className="col-span-12 overflow-x-auto flex items-center justify-center"><p className="text-gray-500">No overview data available.</p></Card>;
        }

        return (
            <Card className="col-span-12 overflow-x-auto hover:shadow-xl transition-all duration-300 hover:-translate-y-0.5 hover:border-blue-200/60">
                {/* Header Section */}
                <div className="bg-gradient-to-r from-blue-50 to-indigo-50 px-6 py-5 border-b border-gray-100">
                    <div className="flex justify-between items-start">
                        <div className="flex items-center space-x-3">
                            <div className="p-2 bg-blue-100 rounded-lg">
                                <svg className="w-5 h-5 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                                </svg>
                            </div>
                            <div>
                                <h2 className="text-xl font-bold text-gray-800">Competitor Overview</h2>
                                <p className="text-sm text-gray-600 mt-1">Overview analysis of your business vs key competitors</p>
                            </div>
                        </div>
                        <div className="flex items-center space-x-4">
                            {/* Inline Progress Indicator */}
                            {isRefreshing && (
                                <div className="flex items-center space-x-3 bg-white rounded-xl shadow-md px-4 py-2 border border-gray-100">
                                    <div className="flex items-center space-x-2">
                                        <div className="w-4 h-4 border-2 border-blue-500 border-t-transparent rounded-full animate-spin"></div>
                                        <span className="text-sm font-medium text-gray-700">{refreshMessage}</span>
                                    </div>
                                    <div className="w-16 bg-gray-200 rounded-full h-2">
                                        <div 
                                            className="bg-gradient-to-r from-blue-500 to-blue-600 h-2 rounded-full transition-all duration-500 ease-out"
                                            style={{ width: `${refreshProgress}%` }}
                                        ></div>
                                    </div>
                                    <span className="text-xs font-medium text-blue-600 min-w-[2rem]">{refreshProgress}%</span>
                                </div>
                            )}
                            
                            <button 
                                onClick={onRefresh}
                                disabled={isRefreshing}
                                className={`px-4 py-2 rounded-lg font-medium transition-all duration-200 shadow-md hover:shadow-lg text-sm ${
                                    isRefreshing 
                                        ? 'bg-gray-300 text-gray-500 cursor-not-allowed' 
                                        : 'bg-gradient-to-r from-blue-500 to-blue-600 hover:from-blue-600 hover:to-blue-700 text-white'
                                }`}
                            >
                                {isRefreshing ? 'Updating...' : 'Update Analytics'}
                            </button>
                        </div>
                    </div>
                </div>

                <table className="w-full text-left text-sm whitespace-nowrap">
                    <colgroup>
                        <col style={{ width: '28%' }} />
                        <col style={{ width: '10%' }} />
                        <col style={{ width: '10%' }} />
                        <col style={{ width: '10%' }} />
                        <col style={{ width: '22%' }} />
                        <col style={{ width: '8%' }} />
                        <col style={{ width: '6%' }} />
                        <col style={{ width: '6%' }} />
                    </colgroup>
                    <thead>
                        <tr className="competitor-table-header border-b border-gray-200">
                            <th className="py-4 px-4 font-semibold text-gray-800 text-left">Clinic</th>
                            <th className="py-4 px-4 text-center font-semibold text-gray-800">Site Speed</th>
                            <th className="py-4 px-4 text-center font-semibold text-gray-800">Keywords #1</th>
                            <th className="py-4 px-4 text-center font-semibold text-gray-800">Backlinks</th>
                            <th className="py-4 px-4 font-semibold text-gray-800 text-left">Opening Hours</th>
                            <th className="py-4 px-4 text-center font-semibold text-gray-800">Links</th>
                            <th className="py-4 px-4 text-center font-semibold text-gray-800">Google Ads</th>
                            <th className="py-4 px-4 text-center font-semibold text-gray-800">Facebook Ads</th>
                        </tr>
                    </thead>
                    <tbody className="divide-y divide-gray-100 bg-white">
                        {overviewData.map(c => (
                            <tr key={c.id} className="service-row-hover transition-colors duration-200">
                                <td className="py-4 px-4">
                                    <div>
                                        <div className="flex items-baseline gap-2">
                                            <span className="font-semibold text-gray-800">{c.clinicName}</span>
                                            <span className="text-sm text-gray-600">
                                                {c.reviewScore} <span className="text-yellow-400">★</span> ({c.reviewCount} reviews)
                                            </span>
                                        </div>
                                        <div className="text-xs text-gray-500">
                                            {[c.address, c.borough, c.city].filter(Boolean).join(', ')}
                                        </div>
                                        {c.website && (
                                            <a href={c.website} target="_blank" rel="noopener noreferrer" 
                                               className="text-xs text-blue-600 hover:text-blue-800 hover:underline">
                                                {c.website.replace(/^https?:\/\//i, '')}
                                            </a>
                                        )}
                                    </div>
                                </td>
                                <td className="py-4 px-4 text-center font-medium">
                                    {(() => {
                                        const speed = c.speed;
                                        if (speed && speed !== 'N/A') {
                                            // Parse the speed value, removing any non-numeric characters except decimal points
                                            const numericSpeed = parseFloat(String(speed).replace(/[^\d.]/g, ''));
                                            
                                            if (!isNaN(numericSpeed)) {
                                                // ALL data is in milliseconds, always convert to seconds
                                                const seconds = (numericSpeed / 1000).toFixed(3);
                                                return `${seconds}s`;
                                            }
                                        }
                                        return speed || 'N/A';
                                    })()}
                                </td>
                                <td className="py-4 px-4 text-center font-medium">{c.kwPos1}</td>
                                <td className="py-4 px-4 text-center font-medium">{c.backlinks.toLocaleString()}</td>
                                <td className="py-4 px-4 text-gray-600">
                                    {(() => {
                                        if (!c.hours || c.hours === 'N/A') return 'N/A';
                                        
                                        const daysOrder = ['MON', 'TUE', 'WED', 'THU', 'FRI', 'SAT', 'SUN'];
                                        const hoursMap = {};
                                        
                                        // Handle both comma and semicolon separators for robust parsing
                                        c.hours.split(/, ?|; ?/).forEach(part => {
                                            const bits = part.split(/:\s?/);
                                            if (bits.length < 2) return;
                                            
                                            const day = bits[0].trim().substring(0, 3).toUpperCase();
                                            const time = bits.slice(1).join(':').trim();
                                            
                                            if (daysOrder.includes(day)) {
                                                hoursMap[day] = time;
                                            }
                                        });

                                        if (Object.keys(hoursMap).length === 0) return c.hours;
                                        
                                        const openDays = [];
                                        const closedDays = [];
                                        
                                        daysOrder.forEach(day => {
                                            const time = hoursMap[day];
                                            if (time && time.toLowerCase() !== 'closed') {
                                                openDays.push({ day, time });
                                            } else {
                                                closedDays.push(day);
                                            }
                                        });

                                        return (
                                            <div className="text-xs space-y-1 leading-tight">
                                                {/* Open days */}
                                                <div className="space-y-0.5">
                                                    {openDays.map(item => (
                                                        <div key={item.day} className="font-medium">
                                                            <span className="text-gray-700">{item.day}: {item.time}</span>
                                                            <span className="text-blue-600 ml-1">Open</span>
                                                        </div>
                                                    ))}
                                                </div>
                                                {/* Closed days */}
                                                {closedDays.length > 0 && (
                                                    <div className="text-red-500 font-medium">
                                                        {closedDays.join(', ')} Closed
                                                    </div>
                                                )}
                                            </div>
                                        );
                                    })()}
                                </td>
                                {/* Social Links */}
                                <td className="py-4 px-4 text-center">
                                    <div className="inline-flex items-center gap-3">
                                        {c.facebook && (
                                            <a href={c.facebook} target="_blank" rel="noopener noreferrer" className="hover:opacity-90" title="Facebook" aria-label="Facebook">
                                                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" className="w-5 h-5" aria-hidden="true">
                                                    <circle cx="12" cy="12" r="12" fill="#1877F2"/>
                                                    <path fill="#ffffff" d="M13.5 21V13.5H16l.5-3H13.5V8.5c0-.8.2-1.3 1.3-1.3H16V4.3c-.3 0-1.3-.1-2.4-.1-2.4 0-4 1.5-4 4.2V10.5H7V13.5h2.6V21H13.5z"/>
                                                </svg>
                                            </a>
                                        )}
                                        {c.instagram && (
                                            <a href={c.instagram} target="_blank" rel="noopener noreferrer" className="hover:opacity-90" title="Instagram" aria-label="Instagram">
                                                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" className="w-5 h-5" aria-hidden="true">
                                                    <defs>
                                                        <linearGradient id="ig-stroke" x1="0%" y1="100%" x2="100%" y2="0%">
                                                            <stop offset="0%" stopColor="#F58529"/>
                                                            <stop offset="50%" stopColor="#DD2A7B"/>
                                                            <stop offset="100%" stopColor="#8134AF"/>
                                                        </linearGradient>
                                                    </defs>
                                                    <rect x="2" y="2" width="20" height="20" rx="5" ry="5" fill="none" stroke="url(#ig-stroke)" strokeWidth="2.2"/>
                                                    <circle cx="12" cy="12" r="4.8" fill="none" stroke="url(#ig-stroke)" strokeWidth="2.2"/>
                                                    <circle cx="17.2" cy="6.8" r="1.3" fill="url(#ig-stroke)"/>
                                                </svg>
                                            </a>
                                        )}
                                        {c.youtube && (
                                            <a href={c.youtube} target="_blank" rel="noopener noreferrer" className="hover:opacity-90" title="YouTube" aria-label="YouTube">
                                                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 17" className="w-5 h-5" aria-hidden="true">
                                                    <rect width="24" height="17" rx="3" ry="3" fill="#FF0000"/>
                                                    <polygon points="9,5 9,12 16,8.5" fill="#ffffff"/>
                                                </svg>
                                            </a>
                                        )}
                                    </div>
                                </td>
                                <td className="py-4 px-4 text-center"><AdIndicator status={c.gAds} link={c.gAdsLink} /></td>
                                <td className="py-4 px-4 text-center"><AdIndicator status={c.fbAds} link={c.fbAdsLink} /></td>
                            </tr>
                        ))}
                    </tbody>
                </table>
            </Card>
        );
    });
    
    // Modern Location Selector Component
    const LocationSelector = React.memo(({ value, onChange }) => {
        const [isOpen, setIsOpen] = useState(false);
        const [searchTerm, setSearchTerm] = useState('');
        const [focusedIndex, setFocusedIndex] = useState(-1);
        const [recentSelections, setRecentSelections] = useState([]);
        const selectorRef = useRef(null);
        const inputRef = useRef(null);
        const listRef = useRef(null);

        // Comprehensive location data
        const locations = {
            countries: [
                { id: 'USA', name: 'United States', flag: '🇺🇸', category: 'Countries' },
                { id: 'Canada', name: 'Canada', flag: '🇨🇦', category: 'Countries' }
            ],
            usStates: [
                                 { id: 'Alabama', name: 'Alabama', flag: '🇺🇸', category: '🇺🇸 States' },
                 { id: 'Alaska', name: 'Alaska', flag: '🇺🇸', category: '🇺🇸 States' },
                 { id: 'Arizona', name: 'Arizona', flag: '🇺🇸', category: '🇺🇸 States' },
                 { id: 'Arkansas', name: 'Arkansas', flag: '🇺🇸', category: '🇺🇸 States' },
                 { id: 'California', name: 'California', flag: '🇺🇸', category: '🇺🇸 States' },
                 { id: 'Colorado', name: 'Colorado', flag: '🇺🇸', category: '🇺🇸 States' },
                 { id: 'Connecticut', name: 'Connecticut', flag: '🇺🇸', category: '🇺🇸 States' },
                 { id: 'Delaware', name: 'Delaware', flag: '🇺🇸', category: '🇺🇸 States' },
                 { id: 'Florida', name: 'Florida', flag: '🇺🇸', category: '🇺🇸 States' },
                 { id: 'Georgia', name: 'Georgia', flag: '🇺🇸', category: '🇺🇸 States' },
                 { id: 'Hawaii', name: 'Hawaii', flag: '🇺🇸', category: '🇺🇸 States' },
                 { id: 'Idaho', name: 'Idaho', flag: '🇺🇸', category: '🇺🇸 States' },
                 { id: 'Illinois', name: 'Illinois', flag: 'Illinois', flag: '🇺🇸', category: '🇺🇸 States' },
                 { id: 'Indiana', name: 'Indiana', flag: 'Indiana', flag: '🇺🇸', category: '🇺🇸 States' },
                 { id: 'Iowa', name: 'Iowa', flag: '🇺🇸', category: '🇺🇸 States' },
                 { id: 'Kansas', name: 'Kansas', flag: '🇺🇸', category: '🇺🇸 States' },
                 { id: 'Kentucky', name: 'Kentucky', flag: '🇺🇸', category: '🇺🇸 States' },
                 { id: 'Louisiana', name: 'Louisiana', flag: 'Louisiana', flag: '🇺🇸', category: '🇺🇸 States' },
                 { id: 'Maine', name: 'Maine', flag: '🇺🇸', category: '🇺🇸 States' },
                 { id: 'Maryland', name: 'Maryland', flag: '🇺🇸', category: '🇺🇸 States' },
                 { id: 'Massachusetts', name: 'Massachusetts', flag: '🇺🇸', category: '🇺🇸 States' },
                 { id: 'Michigan', name: 'Michigan', flag: '🇺🇸', category: '🇺🇸 States' },
                 { id: 'Minnesota', name: 'Minnesota', flag: '🇺🇸', category: '🇺🇸 States' },
                 { id: 'Mississippi', name: 'Mississippi', flag: '🇺🇸', category: '🇺🇸 States' },
                 { id: 'Missouri', name: 'Missouri', flag: '🇺🇸', category: '🇺🇸 States' },
                 { id: 'Montana', name: 'Montana', flag: '🇺🇸', category: '🇺🇸 States' },
                 { id: 'Nebraska', name: 'Nebraska', flag: '🇺🇸', category: '🇺🇸 States' },
                 { id: 'Nevada', name: 'Nevada', flag: '🇺🇸', category: '🇺🇸 States' },
                 { id: 'New Hampshire', name: 'New Hampshire', flag: '🇺🇸', category: '🇺🇸 States' },
                 { id: 'New Jersey', name: 'New Jersey', flag: '🇺🇸', category: '🇺🇸 States' },
                 { id: 'New Mexico', name: 'New Mexico', flag: '🇺🇸', category: '🇺🇸 States' },
                 { id: 'New York', name: 'New York', flag: '🇺🇸', category: '🇺🇸 States' },
                 { id: 'North Carolina', name: 'North Carolina', flag: '🇺🇸', category: '🇺🇸 States' },
                 { id: 'North Dakota', name: 'North Dakota', flag: '🇺🇸', category: '🇺🇸 States' },
                 { id: 'Ohio', name: 'Ohio', flag: '🇺🇸', category: '🇺🇸 States' },
                 { id: 'Oklahoma', name: 'Oklahoma', flag: '🇺🇸', category: '🇺🇸 States' },
                 { id: 'Oregon', name: 'Oregon', flag: '🇺🇸', category: '🇺🇸 States' },
                 { id: 'Pennsylvania', name: 'Pennsylvania', flag: '🇺🇸', category: '🇺🇸 States' },
                 { id: 'Rhode Island', name: 'Rhode Island', flag: '🇺🇸', category: '🇺🇸 States' },
                 { id: 'South Carolina', name: 'South Carolina', flag: '🇺🇸', category: '🇺🇸 States' },
                 { id: 'South Dakota', name: 'South Dakota', flag: '🇺🇸', category: '🇺🇸 States' },
                 { id: 'Tennessee', name: 'Tennessee', flag: '🇺🇸', category: '🇺🇸 States' },
                 { id: 'Texas', name: 'Texas', flag: '🇺🇸', category: '🇺🇸 States' },
                 { id: 'Utah', name: 'Utah', flag: '🇺🇸', category: '🇺🇸 States' },
                 { id: 'Vermont', name: 'Vermont', flag: '🇺🇸', category: '🇺🇸 States' },
                 { id: 'Virginia', name: 'Virginia', flag: '🇺🇸', category: '🇺🇸 States' },
                 { id: 'Washington', name: 'Washington', flag: '🇺🇸', category: '🇺🇸 States' },
                 { id: 'West Virginia', name: 'West Virginia', flag: '🇺🇸', category: '🇺🇸 States' },
                 { id: 'Wisconsin', name: 'Wisconsin', flag: '🇺🇸', category: '🇺🇸 States' },
                 { id: 'Wyoming', name: 'Wyoming', flag: '🇺🇸', category: '🇺🇸 States' }
            ],
                         canadianProvinces: [
                 { id: 'Alberta', name: 'Alberta', flag: '🇨🇦', category: '🇨🇦 Provinces' },
                 { id: 'British Columbia', name: 'British Columbia', flag: '🇨🇦', category: '🇨🇦 Provinces' },
                 { id: 'Manitoba', name: 'Manitoba', flag: '🇨🇦', category: '🇨🇦 Provinces' },
                 { id: 'New Brunswick', name: 'New Brunswick', flag: '🇨🇦', category: '🇨🇦 Provinces' },
                 { id: 'Newfoundland and Labrador', name: 'Newfoundland and Labrador', flag: '🇨🇦', category: '🇨🇦 Provinces' },
                 { id: 'Northwest Territories', name: 'Northwest Territories', flag: '🇨🇦', category: '🇨🇦 Provinces' },
                 { id: 'Nova Scotia', name: 'Nova Scotia', flag: '🇨🇦', category: '🇨🇦 Provinces' },
                 { id: 'Nunavut', name: 'Nunavut', flag: '🇨🇦', category: '🇨🇦 Provinces' },
                 { id: 'Ontario', name: 'Ontario', flag: '🇨🇦', category: '🇨🇦 Provinces' },
                 { id: 'Prince Edward Island', name: 'Prince Edward Island', flag: '🇨🇦', category: '🇨🇦 Provinces' },
                 { id: 'Quebec', name: 'Quebec', flag: '🇨🇦', category: '🇨🇦 Provinces' },
                 { id: 'Saskatchewan', name: 'Saskatchewan', flag: '🇨🇦', category: '🇨🇦 Provinces' },
                 { id: 'Yukon', name: 'Yukon', flag: '🇨🇦', category: '🇨🇦 Provinces' }
             ],
            cities: []
        };

        // Load city list from backend once (memoized by simple flag)
        const [citiesLoaded, setCitiesLoaded] = useState(false);
        useEffect(() => {
            if (citiesLoaded) return;
            const url = 'https://script.google.com/macros/s/AKfycbys_HQL8HQdyL_-DoS0Aakvj-IzDWWW5HtNJDiFhbUwgCuKEYJ7N6iZGC-F62I7uZlV/exec?action=listCities';
            fetchWithCorsWorkaround(url, (err, payload) => {
                if (err) { console.error('City list fetch error:', err); return; }
                if (payload && Array.isArray(payload.cities)) {
                    // Map to display objects and limit to reasonable chunk (list is large); search will still work client-side
                    const mapped = payload.cities.map(c => ({ id: c.id, name: c.id, flag: c.country === 'Canada' ? '🇨🇦' : '🇺🇸', category: 'Cities' }));
                    locations.cities.push(...mapped);
                    setCitiesLoaded(true);
                }
            });
        }, [citiesLoaded]);

        // Flatten all locations for searching
        const allLocations = [
            ...locations.countries,
            ...locations.usStates,
            ...locations.canadianProvinces,
            ...locations.cities
        ];

        // Get current location display info
        const currentLocation = allLocations.find(loc => loc.id === value) || allLocations[0];

        // Load recent selections from localStorage
        useEffect(() => {
            const saved = localStorage.getItem('recentLocationSelections');
            if (saved) {
                try {
                    setRecentSelections(JSON.parse(saved));
                } catch (e) {
                    console.error('Error loading recent selections:', e);
                }
            }
        }, []);

        // Save recent selections to localStorage
        const saveRecentSelection = (locationId) => {
            const updated = [locationId, ...recentSelections.filter(id => id !== locationId)].slice(0, 5);
            setRecentSelections(updated);
            localStorage.setItem('recentLocationSelections', JSON.stringify(updated));
        };

        // Filter locations based on search term
        const filteredLocations = useMemo(() => {
            if (!searchTerm.trim()) {
                return allLocations;
            }

            const term = searchTerm.toLowerCase();
            return allLocations.filter(location => 
                location.name.toLowerCase().includes(term) ||
                location.category.toLowerCase().includes(term)
            ).sort((a, b) => {
                // Prioritize exact matches at the beginning
                const aStartsWith = a.name.toLowerCase().startsWith(term);
                const bStartsWith = b.name.toLowerCase().startsWith(term);
                if (aStartsWith && !bStartsWith) return -1;
                if (!aStartsWith && bStartsWith) return 1;
                return a.name.localeCompare(b.name);
            });
        }, [searchTerm, allLocations]);

        // Group filtered locations by category
        const groupedLocations = useMemo(() => {
            const groups = {};
            filteredLocations.forEach(location => {
                if (!groups[location.category]) {
                    groups[location.category] = [];
                }
                groups[location.category].push(location);
            });
            return groups;
        }, [filteredLocations]);

        // Get recent selections data
        const recentLocationsData = recentSelections
            .map(id => allLocations.find(loc => loc.id === id))
            .filter(Boolean);

        // Handle keyboard navigation
        const handleKeyDown = (e) => {
            if (!isOpen) {
                if (e.key === 'Enter' || e.key === ' ' || e.key === 'ArrowDown') {
                    e.preventDefault();
                    setIsOpen(true);
                    setFocusedIndex(0);
                }
                return;
            }

            switch (e.key) {
                case 'ArrowDown':
                    e.preventDefault();
                    setFocusedIndex(prev => 
                        prev < filteredLocations.length - 1 ? prev + 1 : 0
                    );
                    break;
                case 'ArrowUp':
                    e.preventDefault();
                    setFocusedIndex(prev => 
                        prev > 0 ? prev - 1 : filteredLocations.length - 1
                    );
                    break;
                case 'Enter':
                    e.preventDefault();
                    if (focusedIndex >= 0 && focusedIndex < filteredLocations.length) {
                        const selected = filteredLocations[focusedIndex];
                        onChange(selected.id);
                        saveRecentSelection(selected.id);
                        setIsOpen(false);
                        setSearchTerm('');
                        setFocusedIndex(-1);
                    }
                    break;
                case 'Escape':
                    e.preventDefault();
                    setIsOpen(false);
                    setSearchTerm('');
                    setFocusedIndex(-1);
                    break;
            }
        };

        // Handle selection
        const handleSelect = (location) => {
            onChange(location.id);
            saveRecentSelection(location.id);
            setIsOpen(false);
            setSearchTerm('');
            setFocusedIndex(-1);
        };

        // Close dropdown when clicking outside
        useEffect(() => {
            const handleClickOutside = (event) => {
                if (selectorRef.current && !selectorRef.current.contains(event.target)) {
                    setIsOpen(false);
                    setSearchTerm('');
                    setFocusedIndex(-1);
                }
            };

            document.addEventListener('mousedown', handleClickOutside);
            return () => document.removeEventListener('mousedown', handleClickOutside);
        }, []);

        // Scroll focused item into view
        useEffect(() => {
            if (focusedIndex >= 0 && listRef.current) {
                const focusedElement = listRef.current.querySelector(`[data-index="${focusedIndex}"]`);
                if (focusedElement) {
                    focusedElement.scrollIntoView({ block: 'nearest' });
                }
            }
        }, [focusedIndex]);

        return (
            <div className="relative" ref={selectorRef}>
                {/* Trigger Button */}
                <button
                    type="button"
                    onClick={() => {
                        setIsOpen(!isOpen);
                        if (!isOpen) {
                            setTimeout(() => inputRef.current?.focus(), 50);
                        }
                    }}
                    onKeyDown={handleKeyDown}
                    className="flex items-center justify-between w-full min-w-[200px] px-4 py-2.5 text-sm bg-white border border-gray-300 rounded-lg shadow-sm hover:border-gray-400 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors"
                >
                    <div className="flex items-center space-x-2">
                        <span className="text-lg leading-none inline-flex items-center justify-center w-5 h-5">{currentLocation.flag}</span>
                        <span className="font-medium text-gray-900">{currentLocation.name}</span>
                    </div>
                    <svg 
                        className={`w-4 h-4 text-gray-400 transition-transform ${isOpen ? 'rotate-180' : ''}`}
                        fill="none" 
                        stroke="currentColor" 
                        viewBox="0 0 24 24"
                    >
                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M19 9l-7 7-7-7" />
                    </svg>
                </button>

                {/* Dropdown Panel */}
                {isOpen && (
                    <div className="absolute top-full left-0 right-0 mt-1 bg-white border border-gray-200 rounded-lg shadow-lg z-50 max-h-96 overflow-hidden">
                        {/* Search Input */}
                        <div className="p-3 border-b border-gray-100">
                            <div className="relative">
                                <svg className="absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                                </svg>
                                <input
                                    ref={inputRef}
                                    type="text"
                                    placeholder="Search locations..."
                                    value={searchTerm}
                                    onChange={(e) => {
                                        setSearchTerm(e.target.value);
                                        setFocusedIndex(0);
                                    }}
                                    onKeyDown={handleKeyDown}
                                    className="w-full pl-10 pr-4 py-2 text-sm border border-gray-200 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                                />
                            </div>
                        </div>

                        {/* Results */}
                        <div className="max-h-80 overflow-y-auto" ref={listRef}>
                            {/* Recent Selections */}
                            {!searchTerm && recentLocationsData.length > 0 && (
                                <div className="p-2">
                                    <div className="px-2 py-1 text-xs font-semibold text-gray-500 uppercase tracking-wider">
                                        Recent
                                    </div>
                                    {recentLocationsData.map((location, index) => (
                                        <button
                                            key={`recent-${location.id}`}
                                            onClick={() => handleSelect(location)}
                                            className="w-full flex items-center space-x-3 px-3 py-2 text-left hover:bg-blue-50 rounded-md transition-colors"
                                        >
                                            <span className="text-lg leading-none inline-flex items-center justify-center w-5 h-5">{location.flag}</span>
                                            <div className="flex-1 min-w-0">
                                                <div className="font-medium text-gray-900 truncate">{location.name}</div>
                                                <div className="text-xs text-gray-500">{location.category}</div>
                                            </div>
                                            <svg className="w-4 h-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
                                            </svg>
                                        </button>
                                    ))}
                                    <div className="border-t border-gray-100 mt-2 pt-2"></div>
                                </div>
                            )}

                            {/* Grouped Results */}
                            {Object.entries(groupedLocations).map(([category, locations]) => (
                                <div key={category} className="p-2">
                                    <div className="px-2 py-1 text-xs font-semibold text-gray-500 uppercase tracking-wider">
                                        {category}
                                    </div>
                                    {locations.map((location, index) => {
                                        const globalIndex = filteredLocations.findIndex(loc => loc.id === location.id);
                                        const isFocused = globalIndex === focusedIndex;
                                        
                                        return (
                                            <button
                                                key={location.id}
                                                data-index={globalIndex}
                                                onClick={() => handleSelect(location)}
                                                className={`w-full flex items-center space-x-3 px-3 py-2 text-left rounded-md transition-colors ${
                                                    isFocused 
                                                        ? 'bg-blue-100 text-blue-900' 
                                                        : 'hover:bg-gray-50 text-gray-900'
                                                }`}
                                            >
                                                <span className="text-lg leading-none inline-flex items-center justify-center w-5 h-5">{location.flag}</span>
                                                <div className="flex-1 min-w-0">
                                                    <div className="font-medium truncate">{location.name}</div>
                                                    {location.category !== 'Countries' && (
                                                        <div className="text-xs text-gray-500">{location.category}</div>
                                                    )}
                                                </div>
                                                {value === location.id && (
                                                    <svg className="w-4 h-4 text-blue-600" fill="currentColor" viewBox="0 0 20 20">
                                                        <path fillRule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clipRule="evenodd" />
                                                    </svg>
                                                )}
                                            </button>
                                        );
                                    })}
                                </div>
                            ))}

                            {/* No Results */}
                            {searchTerm && filteredLocations.length === 0 && (
                                <div className="p-4 text-center text-gray-500">
                                    <svg className="w-8 h-8 mx-auto mb-2 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M9.172 16.172a4 4 0 015.656 0M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                                    </svg>
                                    <p className="text-sm">No locations found for "{searchTerm}"</p>
                                </div>
                            )}
                        </div>
                    </div>
                )}
            </div>
        );
    });
    
    const ServiceList = React.memo(({ title, dataSet, tooltipText }) => {
        const [serviceData, setServiceData] = useState(null);
        const [loading, setLoading] = useState(true);
        const [error, setError] = useState(null);
        const [selectedLocation, setSelectedLocation] = useState('USA');
        const [expandedService, setExpandedService] = useState(null);
        const [showAll, setShowAll] = useState(false);

        // Clear potentially corrupted service cache on mount
        useEffect(() => {
            const clearServiceCache = () => {
                const keys = Object.keys(sessionStorage);
                const serviceKeys = keys.filter(key => key.startsWith('services_') || key.startsWith('seo_data_'));
                serviceKeys.forEach(key => {
                    if (key.includes('AKfycbys_HQL8HQdyL_-DoS0Aakvj-IzDWWW5HtNJDiFhbUwgCuKEYJ7N6iZGC-F62I7uZlV')) {
                        console.log('[ServiceList] Clearing potentially corrupted cache:', key);
                        sessionStorage.removeItem(key);
                    }
                });
            };
            
            // Clear cache once on component mount to fix any corruption from performance updates
            const hasCleared = sessionStorage.getItem('service_cache_cleared_v2');
            if (!hasCleared) {
                clearServiceCache();
                sessionStorage.setItem('service_cache_cleared_v2', 'true');
                console.log('[ServiceList] Cleared service cache after performance update');
            }
        }, []);

        useEffect(() => {
            const cacheKey = `services_${selectedLocation}_${dataSet}`;
            const cachedData = sessionStorage.getItem(cacheKey);
            
            if (cachedData) {
                try {
                    const parsed = JSON.parse(cachedData);
                    console.log('[ServiceList] Using cached data:', { selectedLocation, dataSet, dataLength: parsed?.length });
                    setServiceData(parsed);
                    setLoading(false);
                    setError(null);
                    return;
                } catch (e) {
                    // Invalid cache, continue with fresh fetch
                    console.warn('[ServiceList] Invalid cache, clearing:', e);
                    sessionStorage.removeItem(cacheKey);
                }
            }

            const scriptUrl = `https://script.google.com/macros/s/AKfycbys_HQL8HQdyL_-DoS0Aakvj-IzDWWW5HtNJDiFhbUwgCuKEYJ7N6iZGC-F62I7uZlV/exec?location=${selectedLocation}`;
            setLoading(true);
            setError(null);
            
            console.log('[ServiceList] Fetching services:', { selectedLocation, dataSet, scriptUrl });
            
            // Temporarily bypass fetchWithCorsWorkaround to test if caching is the issue
            const controller = new AbortController();
            const timeoutId = setTimeout(() => controller.abort(), 30000); // 30 second timeout
            
            console.log('[ServiceList] Making direct fetch call to bypass cache...');
            fetch(scriptUrl, {
                method: 'GET',
                mode: 'cors',
                signal: controller.signal
            })
            .then(response => {
                clearTimeout(timeoutId);
                if (!response.ok) throw new Error(`HTTP ${response.status}`);
                return response.json();
            })
            .then(data => {
                console.log('[ServiceList] Direct fetch successful:', data);
                // Handle response same as fetchWithCorsWorkaround callback
                handleServiceResponse(null, data);
            })
            .catch(err => {
                clearTimeout(timeoutId);
                console.error('[ServiceList] Direct fetch error:', err);
                handleServiceResponse(err, null);
            });
            
            // Extract the response handling logic into a function
            function handleServiceResponse(err, data) {
                if (err) {
                    console.error("ServiceList Fetch Error:", err);
                    setError(err.message);
                    setLoading(false);
                    return;
                }

                if (data.error) {
                    // 🔍 DEBUG: Show debug info even for errors
                    if (data._debug) {
                        console.error(`🚨 SERVICE CARDS ERROR DEBUG for "${selectedLocation}":`, data._debug);
                    }
                    console.error("Service Cards API Error:", data.error);
                    setError(data.error);
                    setLoading(false);
                    return;
                }

                // 🔍 DEBUG: Log the debug information from the backend
                if (data._debug) {
                    console.log(`🔍 SERVICE CARDS DEBUG for "${selectedLocation}":`, {
                        requestLocation: data._debug.requestLocation,
                        selectedSheet: data._debug.selectedSheet,
                        targetColumn: data._debug.targetColumn,
                        targetColumnHeader: data._debug.targetColumnHeader,
                        sheetRows: data._debug.sheetRows,
                        dataRowsFound: data._debug.dataRowsFound,
                        availableSheets: data._debug.availableSheets,
                        monthHeaders: data._debug.monthHeaders,
                        stateSamples: data._debug.stateSamples,
                        uniqueStatesSample: data._debug.uniqueStatesSample,
                        targetPresentExact: data._debug.targetPresentExact,
                        targetPresentCaseInsensitive: data._debug.targetPresentCaseInsensitive,
                        topServicesCount: data.topServices?.length || 0,
                        newServicesCount: data.newServices?.length || 0
                    });
                    
                    // If no data found, show additional debug info
                    if (data._debug.dataRowsFound === 0) {
                        console.warn(`❌ NO DATA FOUND for "${selectedLocation}":`);
                        console.warn(`- Sheet: ${data._debug.selectedSheet}`);
                        console.warn(`- Target column: ${data._debug.targetColumn} (${data._debug.targetColumnHeader})`);
                        console.warn(`- Sheet has ${data._debug.sheetRows} total rows`);
                        console.warn(`- Available sheets:`, data._debug.availableSheets);
                    }
                }

                console.log('[ServiceList] API Response:', { 
                    selectedLocation, 
                    dataSet, 
                    hasTopServices: !!data.topServices, 
                    hasNewServices: !!data.newServices,
                    topServicesLength: data.topServices?.length,
                    newServicesLength: data.newServices?.length,
                    hasDebugInfo: !!data._debug,
                    fullData: data
                });

                // Log debug information from the Service Cards script
                if (data._debug) {
                    console.log('[ServiceList] Service Cards Debug Info:', {
                        requestLocation: data._debug.requestLocation,
                        selectedSheet: data._debug.selectedSheet,
                        sheetRows: data._debug.sheetRows,
                        dataRowsFound: data._debug.dataRowsFound,
                        availableSheets: data._debug.availableSheets,
                        hasSheet: data._debug.hasSheet,
                        targetColumn: data._debug.targetColumn,
                        targetColumnHeader: data._debug.targetColumnHeader
                    });
                }

                const services = dataSet === 'topServices' ? data.topServices : data.newServices;
                if (services && services.length > 0) {
                    // Calculate total volume for percentage
                    const totalVolume = services.reduce((sum, service) => sum + service.totalVolume, 0);
                    const servicesWithPercentage = services.map(service => ({
                        ...service,
                        volumePercentage: totalVolume > 0 ? ((service.totalVolume / totalVolume) * 100).toFixed(1) : 0
                    }));
                    console.log('[ServiceList] Setting service data:', { selectedLocation, dataSet, count: servicesWithPercentage.length });
                    sessionStorage.setItem(cacheKey, JSON.stringify(servicesWithPercentage));
                    setServiceData(servicesWithPercentage);
                } else {
                    console.warn('[ServiceList] No services found:', { selectedLocation, dataSet, services });
                    setServiceData([]);
                }
                setLoading(false);
            }
        }, [selectedLocation, dataSet]);

        if (loading) {
            return (
                <Card className="col-span-12 md:col-span-6">
                    <div className="flex justify-between items-start mb-4">
                        <div className="flex items-center space-x-2">
                            <h2 className="text-xl font-bold text-gray-800">{title}</h2>
                            <InfoTooltip text={tooltipText} />
                        </div>
                        <LocationSelector 
                            value={selectedLocation} 
                            onChange={setSelectedLocation}
                        />
                    </div>
                    <div className="flex items-center justify-center py-8">
                        <p className="text-gray-500">Loading Service Data...</p>
                    </div>
                </Card>
            );
        }
        
        if (error) {
            return (
                <Card className="col-span-12 md:col-span-6">
                    <div className="flex justify-between items-start mb-4">
                        <div className="flex items-center space-x-2">
                            <h2 className="text-xl font-bold text-gray-800">{title}</h2>
                            <InfoTooltip text={tooltipText} />
                        </div>
                        <LocationSelector 
                            value={selectedLocation} 
                            onChange={setSelectedLocation}
                        />
                    </div>
                    <div className="flex items-center justify-center py-8">
                        <p className="text-red-500">Service Error: {error}</p>
                    </div>
                </Card>
            );
        }
        
        if (!serviceData || serviceData.length === 0) {
            return (
                <Card className="col-span-12 md:col-span-6">
                    <div className="flex justify-between items-start mb-4">
                        <div className="flex items-center space-x-2">
                            <h2 className="text-xl font-bold text-gray-800">{title}</h2>
                            <InfoTooltip text={tooltipText} />
                        </div>
                        <LocationSelector 
                            value={selectedLocation} 
                            onChange={setSelectedLocation}
                        />
                    </div>
                    <div className="flex items-center justify-center py-8">
                        <p className="text-gray-500">No service data found for {selectedLocation}.</p>
                    </div>
                </Card>
            );
        }
        
        // Get displayed services based on showAll toggle
        const displayedServices = showAll ? serviceData : serviceData.slice(0, 5);
        
        return (
            <div className="col-span-12 md:col-span-6 service-card">
                <div className={"bg-white rounded-xl shadow-lg border border-gray-100 overflow-hidden group hover:shadow-xl transition-all duration-300 hover:-translate-y-0.5 hover:border-blue-200/60"}>
                    {/* Header Section */}
                    <div className="bg-gradient-to-r from-blue-50 to-indigo-50 px-6 py-5 border-b border-gray-100">
                        <div className="flex justify-between items-start">
                            <div className="flex items-center space-x-3">
                                <div className="p-2 bg-blue-100 rounded-lg">
                                    <svg className="w-5 h-5 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" />
                                    </svg>
                                </div>
                                <div>
                                    <h2 className="text-xl font-bold text-gray-800">{title}</h2>
                                    <p className="text-sm text-gray-600 mt-1">{displayedServices.length} services • {selectedLocation}</p>
                                </div>
                                <InfoTooltip text={tooltipText} />
                            </div>
                            <LocationSelector 
                                value={selectedLocation} 
                                onChange={setSelectedLocation}
                            />
                        </div>
                    </div>

                    {/* Services List */}
                    <div className="divide-y divide-gray-100">
                        {displayedServices.map((service, index) => (
                            <div key={service.name} className="group">
                                {/* Service Row */}
                                <div 
                                    className="service-row-hover px-6 py-4 cursor-pointer transition-colors duration-200"
                                    onClick={() => setExpandedService(expandedService === service.name ? null : service.name)}
                                >
                                    <div className="flex items-center justify-between">
                                        <div className="flex items-center space-x-4" style={{ width: 'calc(100% - 280px)' }}>
                                            {/* Rank Badge */}
                                            <div className="flex-shrink-0">
                                                <div className={`rank-badge w-8 h-8 rounded-full flex items-center justify-center text-sm font-bold ${
                                                    index === 0 ? 'bg-amber-400 text-white dark:bg-amber-500/25 dark:text-amber-200' :
                                                    index === 1 ? 'bg-gray-400 text-white dark:bg-gray-400/25 dark:text-gray-200' :
                                                    index === 2 ? 'bg-amber-700 text-white dark:bg-amber-700/25 dark:text-amber-200' :
                                                    'bg-blue-500 text-white dark:bg-blue-500/15 dark:text-blue-200'
                                                }`}>
                                                    {index + 1}
                                                </div>
                                            </div>
                                            
                                            {/* Service Info */}
                                            <div className="flex-1 min-w-0">
                                                <div className="flex items-center space-x-2">
                                                    <h3 
                                                        className="font-semibold text-gray-900 truncate sm:max-w-[200px] md:max-w-[250px] lg:max-w-[300px]" 
                                                        title={service.name === 'NAD' ? 'NAD+' : service.name}
                                                    >
                                                        {service.name === 'NAD' ? 'NAD+' : service.name}
                                                    </h3>
                                                    {/* Trend Badge */}
                                                    <div className={`inline-flex items-center px-2 py-1 rounded-full text-xs font-medium ${
                                                        service.trend === 1 ? 'bg-green-100 text-green-700' :
                                                        service.trend === -1 ? 'bg-red-100 text-red-700' :
                                                        'bg-gray-100 text-gray-600'
                                                    }`}>
                                                        {service.trend === 1 && <ArrowUp className="w-3 h-3 mr-1" />}
                                                        {service.trend === -1 && <ArrowDown className="w-3 h-3 mr-1" />}
                                                        {service.trend === 1 ? 'Rising' : service.trend === -1 ? 'Falling' : 'Stable'}
                                                    </div>
                                                </div>
                                                <p className="text-sm text-gray-500 mt-1">
                                                    {service.volumePercentage}% of total volume
                                                </p>
                                            </div>
                                        </div>

                                        {/* Metrics - Fixed width container */}
                                        <div className="flex items-center space-x-6 text-sm" style={{ width: '280px', justifyContent: 'flex-end' }}>
                                            <div className="text-center min-w-0">
                                                <div className="font-semibold text-gray-900 whitespace-nowrap">{service.avgCompetition}</div>
                                                <div className="text-gray-500 text-xs">Competition</div>
                                            </div>
                                            <div className="text-center min-w-0">
                                                <div className="font-semibold text-gray-900 whitespace-nowrap">${service.avgCpc}</div>
                                                <div className="text-gray-500 text-xs">Avg CPC</div>
                                            </div>
                                            <div className="text-center min-w-0">
                                                <div className="font-semibold text-gray-900 whitespace-nowrap">{service.volumePercentage}%</div>
                                                <div className="text-gray-500 text-xs">Volume</div>
                                            </div>
                                        </div>

                                        {/* Expand Arrow */}
                                        <div className="ml-4 flex-shrink-0">
                                            <svg 
                                                className={`w-5 h-5 text-gray-400 transition-transform duration-200 ${
                                                    expandedService === service.name ? 'rotate-180' : ''
                                                }`}
                                                fill="none" 
                                                stroke="currentColor" 
                                                viewBox="0 0 24 24"
                                            >
                                                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M19 9l-7 7-7-7" />
                                            </svg>
                                        </div>
                                    </div>
                                </div>

                                {/* Expanded Keywords Section */}
                                {expandedService === service.name && (
                                    <div className="px-6 py-4 bg-gray-50 border-t border-gray-100">
                                        <div className="space-y-3">
                                            <div className="flex items-center justify-between">
                                                <h4 className="font-semibold text-gray-800 flex items-center">
                                                    <svg className="w-4 h-4 mr-2 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M7 7h.01M7 3h5c.512 0 1.024.195 1.414.586l7 7a2 2 0 010 2.828l-7 7a2 2 0 01-2.828 0l-7-7A1.994 1.994 0 013 12V7a4 4 0 014-4z" />
                                                    </svg>
                                                    Top Keywords for {service.name}
                                                </h4>
                                                <span className="text-sm text-gray-500">
                                                    {service.keywords.length} total keywords
                                                </span>
                                            </div>
                                            
                                            <div className="grid grid-cols-1 md:grid-cols-2 gap-3">
                                                {service.keywords.map((kw, idx) => (
                                                    <div key={idx} className="flex items-center justify-between p-3 bg-white rounded-lg border border-gray-200 hover:border-blue-200 transition-colors">
                                                        <div className="flex items-center space-x-3">
                                                            <div className="w-2 h-2 bg-blue-400 rounded-full"></div>
                                                            <span className="text-sm font-medium text-gray-700">{kw.name}</span>
                                                        </div>
                                                        <div className="text-right flex items-center space-x-2">
                                                            <div>
                                                                <div className="text-sm font-semibold text-gray-900">
                                                                    {kw.volume.toLocaleString()}
                                                                </div>
                                                                <div className="text-xs text-gray-500">searches</div>
                                                            </div>
                                                            <div className="ml-2">
                                                                {kw.trend === 1 && <ArrowUp className="w-3 h-3 text-green-500" title="Increasing" />}
                                                                {kw.trend === -1 && <ArrowDown className="w-3 h-3 text-red-500" title="Decreasing" />}
                                                                {kw.trend === 0 && <span className="text-gray-400 text-xs" title="No Change">-</span>}
                                                            </div>
                                                        </div>
                                                    </div>
                                                ))}
                                            </div>
                                        </div>
                                    </div>
                                )}
                            </div>
                        ))}
                    </div>

                    {/* Footer */}
                    {serviceData.length > 5 && (
                        <div className="px-6 py-4 bg-gray-50 border-t border-gray-100">
                            <button 
                                onClick={() => setShowAll(!showAll)}
                                className="w-full flex items-center justify-center space-x-2 py-2 px-4 bg-white border border-gray-200 rounded-lg hover:bg-gray-50 hover:border-gray-300 transition-colors duration-200 text-sm font-medium text-gray-700 dark:text-[#97C7FD] dark:hover:text-blue-300"
                            >
                                <span>
                                    {showAll ? 'Show Less' : `Show ${serviceData.length - 5} More Services`}
                                </span>
                                {showAll ? <ChevronUp className="w-4 h-4" /> : <ChevronDown className="w-4 h-4" />}
                            </button>
                        </div>
                    )}
                </div>
            </div>
        );
    });
    
    const [dashboardData, setDashboardData] = useState(null);
    const [loading, setLoading] = useState(true);
    const [error, setError] = useState(null);
    
    // Overview table refresh state management
    const [isOverviewRefreshing, setIsOverviewRefreshing] = useState(false);
    const [overviewRefreshProgress, setOverviewRefreshProgress] = useState(0);
    const [overviewRefreshMessage, setOverviewRefreshMessage] = useState('');
    const overviewPollIntervalRef = useRef(null);
    const overviewRefreshStartTimeRef = useRef(null);

    // Cleanup polling on unmount
    useEffect(() => {
        return () => {
            if (overviewPollIntervalRef.current) {
                clearInterval(overviewPollIntervalRef.current);
            }
        };
    }, []);

    // Overview table refresh functionality
    const triggerOverviewRefresh = async () => {
        // Prevent multiple simultaneous refreshes
        if (isOverviewRefreshing) {
            console.log('Overview refresh already in progress, ignoring request');
            return;
        }
        
        console.log('Overview table refresh triggered');
        console.log('Available webhooks:', webhooks);
        
        // Check for required webhooks from Config tab
        const requiredWebhooks = ['On-Page Insights', 'GBP Insights', 'Facebook Ads', 'Google Ads'];
        const availableWebhooks = requiredWebhooks.filter(name => webhooks && webhooks[name]);
        
        if (availableWebhooks.length === 0) {
            alert('Dashboard refresh webhooks not configured for this workbook');
            console.log('Webhook check failed. Required:', requiredWebhooks, 'Available:', availableWebhooks);
            return;
        }
        
        setIsOverviewRefreshing(true);
        setOverviewRefreshProgress(5);
        setOverviewRefreshMessage('Analytics update in progress, check back in 10 minutes...');
        overviewRefreshStartTimeRef.current = Date.now();

        try {
            // Get the workbook ID from URL parameters
            const params = new URLSearchParams(window.location.search);
            const workbookId = params.get('workbookId');
            
            if (!workbookId) {
                throw new Error('No workbook ID found in URL');
            }

            const webhookPromises = [];
            
            // Trigger On-Page Insights webhook
            if (webhooks['On-Page Insights']) {
                const url = `${webhooks['On-Page Insights']}?spreadsheetId=${workbookId}&tabName=${encodeURIComponent('On-Page Insights')}`;
                console.log('Triggering On-Page Insights webhook:', url);
                webhookPromises.push(
                    fetch(url, { method: 'GET', mode: 'no-cors' }).catch(error => console.error('On-Page Insights webhook error:', error))
                );
            }
            
            // Trigger GBP Insights webhook
            if (webhooks['GBP Insights']) {
                const url = `${webhooks['GBP Insights']}?spreadsheetId=${workbookId}&tabName=${encodeURIComponent('GBP Insights')}`;
                console.log('Triggering GBP Insights webhook:', url);
                webhookPromises.push(
                    fetch(url, { method: 'GET', mode: 'no-cors' }).catch(error => console.error('GBP Insights webhook error:', error))
                );
            }
            
            // Trigger Facebook Ads webhook
            if (webhooks['Facebook Ads']) {
                const url = `${webhooks['Facebook Ads']}?spreadsheetId=${workbookId}&tabName=${encodeURIComponent('Links')}`;
                console.log('Triggering Facebook Ads webhook:', url);
                webhookPromises.push(
                    fetch(url, { method: 'GET', mode: 'no-cors' }).catch(error => console.error('Facebook Ads webhook error:', error))
                );
            }
            
            // Trigger Google Ads webhook
            if (webhooks['Google Ads']) {
                const url = `${webhooks['Google Ads']}?spreadsheetId=${workbookId}&tabName=${encodeURIComponent('Links')}`;
                console.log('Triggering Google Ads webhook:', url);
                webhookPromises.push(
                    fetch(url, { method: 'GET', mode: 'no-cors' }).catch(error => console.error('Google Ads webhook error:', error))
                );
            }
            
            // Wait for all webhooks to be triggered
            await Promise.allSettled(webhookPromises);
            
            // Show success message
            console.log('Analytics update webhooks triggered successfully!');
            
            setOverviewRefreshProgress(15);
            setOverviewRefreshMessage('Analytics update in progress, check back in 10 minutes...');
            
            // Wait 2 minutes before starting to poll for changes to avoid detecting data wipe
            setTimeout(() => {
                console.log('Dashboard polling: Starting after 2-minute delay to avoid data wipe detection');
                startOverviewPolling();
            }, 120000); // 2 minutes delay
            
        } catch (error) {
            console.error('Error triggering analytics update:', error);
            setIsOverviewRefreshing(false);
            setOverviewRefreshProgress(0);
            setOverviewRefreshMessage('');
            alert(`Failed to trigger analytics update: ${error.message}`);
        }
    };

    const startOverviewPolling = () => {
        let attempts = 0;
        const maxAttempts = 10; // Poll for ~10 minutes (60s intervals) for analytics update
        
        const poll = async () => {
            attempts++;
            const elapsed = (Date.now() - overviewRefreshStartTimeRef.current) / 1000;
            const progress = Math.min(15 + (attempts * 8), 95); // Spread progress over 10 attempts
            
            setOverviewRefreshProgress(progress);
            
            // Updated messaging for longer automation
            let message;
            if (elapsed < 300) { // First 5 minutes
                message = `Analytics update in progress, check back in 10 minutes...`;
            } else if (elapsed < 480) { // 5-8 minutes
                message = `Processing data updates...`;
            } else { // 8+ minutes
                message = `Finalizing analytics report...`;
            }
            setOverviewRefreshMessage(message);
            
            try {
                // Check if data has been updated by fetching fresh data
                const params = new URLSearchParams(window.location.search);
                const workbookId = params.get('workbookId');
                
                if (workbookId) {
                    const scriptUrl = `https://script.google.com/macros/s/AKfycbxfOMp8d_eCVH4lFD0PNuFU1wH-gyWOwRt2EuME7GQJ4U73ZwpPDciohDH3C566YLWq/exec?workbookId=${workbookId}`;
                    
                    const response = await fetch(scriptUrl);
                    const newData = await response.json();
                    
                    // Check for changes in overview data only
                    if (newData.dashboard && newData.dashboard.overviewData && hasOverviewDataChanged(dashboardData, newData.dashboard)) {
                        // Data has changed! Stop polling and update only the overview table
                        clearInterval(overviewPollIntervalRef.current);
                        setOverviewRefreshProgress(100);
                        setOverviewRefreshMessage('Analytics update complete! Loading fresh data...');
                        
                        // Update only the overview data in the dashboard, keeping other data intact
                        const updatedDashboardData = {
                            ...dashboardData,
                            overviewData: newData.dashboard.overviewData
                        };
                        
                        // Only update the dashboard cache, don't touch geogrid cache
                        const cacheKey = `dashboard_data_${workbookId}`;
                        sessionStorage.setItem(cacheKey, JSON.stringify(updatedDashboardData));
                        
                        setDashboardData(updatedDashboardData);
                        
                        // Clear refresh state after a brief success message
                        setTimeout(() => {
                            setIsOverviewRefreshing(false);
                            setOverviewRefreshProgress(0);
                            setOverviewRefreshMessage('');
                        }, 2000);
                        return;
                    }
                }
            } catch (error) {
                console.error('Error polling for overview updates:', error);
            }
            
            // Auto-refresh after max attempts
            if (attempts >= maxAttempts) {
                clearInterval(overviewPollIntervalRef.current);
                setOverviewRefreshProgress(100);
                setOverviewRefreshMessage('Automation complete! Refreshing with latest data...');
                
                try {
                    const params = new URLSearchParams(window.location.search);
                    const workbookId = params.get('workbookId');
                    
                    if (workbookId) {
                        const scriptUrl = `https://script.google.com/macros/s/AKfycbxfOMp8d_eCVH4lFD0PNuFU1wH-gyWOwRt2EuME7GQJ4U73ZwpPDciohDH3C566YLWq/exec?workbookId=${workbookId}`;
                        
                        fetch(scriptUrl)
                            .then(response => response.json())
                            .then(finalData => {
                                if (finalData.dashboard && finalData.dashboard.overviewData) {
                                    // Update only the overview data, keeping other data intact
                                    const updatedDashboardData = {
                                        ...dashboardData,
                                        overviewData: finalData.dashboard.overviewData
                                    };
                                    
                                    // Only update the dashboard cache, don't touch geogrid cache
                                    const cacheKey = `dashboard_data_${workbookId}`;
                                    sessionStorage.setItem(cacheKey, JSON.stringify(updatedDashboardData));
                                    
                                    setDashboardData(updatedDashboardData);
                                    console.log('Fallback: Overview table data refreshed after timeout');
                                    
                                    setTimeout(() => {
                                        setIsOverviewRefreshing(false);
                                        setOverviewRefreshProgress(0);
                                        setOverviewRefreshMessage('');
                                    }, 1500);
                                } else {
                                    setIsOverviewRefreshing(false);
                                    setOverviewRefreshProgress(0);
                                    setOverviewRefreshMessage('');
                                }
                            })
                            .catch(e => {
                                console.log('Fallback failed:', e);
                                setIsOverviewRefreshing(false);
                                setOverviewRefreshProgress(0);
                                setOverviewRefreshMessage('');
                            });
                    } else {
                        setIsOverviewRefreshing(false);
                        setOverviewRefreshProgress(0);
                        setOverviewRefreshMessage('');
                    }
                } catch (error) {
                    console.error('Error in fallback:', error);
                    setIsOverviewRefreshing(false);
                    setOverviewRefreshProgress(0);
                    setOverviewRefreshMessage('');
                }
            }
        };
        
        // Start with immediate poll, then continue with 60-second intervals
        overviewPollIntervalRef.current = setInterval(poll, 60000);
        
        // Poll immediately to start
        poll();
    };

    const hasOverviewDataChanged = (oldData, newData) => {
        // Primary check: Has the GBP Insights AI Notes been generated? This indicates completion
        const oldAiReport = oldData?.aiReport;
        const newAiReport = newData?.aiReport;
        
        // Check if AI report has meaningful content (not just empty/placeholder/wiped)
        const hasAiReport = newAiReport && 
                           String(newAiReport).trim() !== '' &&
                           String(newAiReport).trim().length > 100 && // Increased threshold for substantial content
                           !String(newAiReport).toLowerCase().includes('generating') &&  // Avoid placeholder text
                           !String(newAiReport).toLowerCase().includes('processing'); // Avoid placeholder text
        
        // Additional validation: Check if we have meaningful overview data (not wiped)
        const hasMeaningfulOverviewData = newData?.overviewData && 
                                         Array.isArray(newData.overviewData) && 
                                         newData.overviewData.length > 0 &&
                                         newData.overviewData.some(item => item.clinicName && item.clinicName.trim() !== '');
        
        // Log AI Report comparison for debugging
        console.log('Dashboard AI Report comparison:', {
            old: oldAiReport,
            new: newAiReport,
            hasAiReport: hasAiReport,
            hasMeaningfulOverviewData: hasMeaningfulOverviewData,
            newLength: newAiReport?.length || 0,
            overviewDataLength: newData?.overviewData?.length || 0,
            changed: oldAiReport !== newAiReport
        });
        
        // Additional validation: Check if we have meaningful data updates
        const hasOtherChanges = (
            // Check other key data as backup indicators - but only if data looks complete
            hasMeaningfulOverviewData && (
            JSON.stringify(oldData?.overviewData) !== JSON.stringify(newData?.overviewData) ||
                JSON.stringify(oldData?.censusData) !== JSON.stringify(newData?.censusData)
            )
        );
        
        // Consider complete when BOTH AI report is generated AND we have meaningful data
        const hasChanges = hasAiReport && hasMeaningfulOverviewData;
        
        console.log('Analytics update completion check:', {
            hasAiReport: hasAiReport,
            hasMeaningfulOverviewData: hasMeaningfulOverviewData,
            hasOtherChanges: hasOtherChanges,
            overallChanged: hasChanges
        });
        
        return hasChanges;
    };

    useEffect(() => {
        const params = new URLSearchParams(window.location.search);
        const workbookId = params.get('workbookId');
        if (!workbookId) {
            setError("No workbook ID provided");
            setLoading(false);
            return;
        }

        // Use a single cache key for all dashboard data
        const cacheKey = `dashboard_data_${workbookId}`;
        const cachedData = sessionStorage.getItem(cacheKey);
        if (cachedData) {
            try {
                const parsed = JSON.parse(cachedData);
                setDashboardData(parsed);
                setLoading(false);
                // Do not return; fetch fresh in background to update fields like aiReport if empty/stale
            } catch (e) {
                // Invalid cache, continue with fresh fetch
            }
        }

        const scriptUrl = `https://script.google.com/macros/s/AKfycbxfOMp8d_eCVH4lFD0PNuFU1wH-gyWOwRt2EuME7GQJ4U73ZwpPDciohDH3C566YLWq/exec?workbookId=${workbookId}`;
        
        fetchWithCorsWorkaround(scriptUrl, (err, data) => {
            if (err) {
                setError(err.message);
                setLoading(false);
                return;
            }
            if (data.error) {
                setError(`Script error: ${data.error}`);
                setLoading(false);
                return;
            }
            
            const dashboard = data.dashboard;
            if (dashboard) {
                sessionStorage.setItem(cacheKey, JSON.stringify(dashboard));
            }
            setDashboardData(dashboard);
            setLoading(false);
        });
    }, []);

    return (
        <PageContent>
            <div className="grid grid-cols-12 gap-6">
                <GeogridSection setActiveTab={setActiveTab} />
                <CensusInfo censusData={dashboardData?.censusData} loading={loading} error={error} />
                {/* Google Business Profile Report */}
                {!loading && !error && dashboardData?.aiReport && String(dashboardData.aiReport).trim() && (
                    <div className="col-span-12">
                       <GBPReportSection reportText={dashboardData.aiReport} />
                    </div>
                )}
                <OverviewTable 
                    overviewData={dashboardData?.overviewData} 
                    loading={loading} 
                    error={error}
                    onRefresh={triggerOverviewRefresh}
                    isRefreshing={isOverviewRefreshing}
                    refreshProgress={overviewRefreshProgress}
                    refreshMessage={overviewRefreshMessage}
                />
                
                {/* Service Cards - positioned after map/census, before AI sentiment */}
                <ServiceList title="Services by Search Volume" dataSet="topServices" tooltipText="Lists the most popular, established MedSpa services based on monthly search volume in the selected geographic area." />
                <ServiceList title="New Services by Search Volume" dataSet="newServices" tooltipText="Highlights emerging or newer services with growing search interest, indicating potential new market opportunities." />

                {/* AI Sentiment Cards */}
                <AISentimentBubbleChart 
                    data={dashboardData?.aiSentimentData} 
                    loading={loading} 
                    error={error} 
                />
                {/* Right column: AI Perception + mini stats */}
                <div className="col-span-12 md:col-span-5 flex flex-col space-y-4">
                    <AISentimentBarChart 
                        data={dashboardData?.aiSentimentData} 
                        loading={loading} 
                        error={error} 
                    />
                    <div className="grid grid-cols-2 gap-4">
                        <VisibilityStatCard data={dashboardData?.aiSentimentData} />
                        <SentimentStatCard data={dashboardData?.aiSentimentData} />
                    </div>
                </div>

            </div>
        </PageContent>
    );
};
/* ------------------------------------------------------------------ */
/* KEYWORDS PAGE – full live version                                  */
/* ------------------------------------------------------------------ */
const Keywords = ({ summary, table, webhooks, setData }) => {
    const [active, setActive] = useState('');
    const [searchTerm, setSearchTerm] = useState('');
    const [currentMonthIndex, setCurrentMonthIndex] = useState(0);
    const [keywordsData, setKeywordsData] = useState(null);

    // Safely use table/summary from props or fall back to background-fetched state
    const effectiveTable = table || (keywordsData && keywordsData.keywordsTable) || {};
    const effectiveSummary = summary || (keywordsData && keywordsData.keywordsSummary) || {};
    const siteNames = Object.keys(effectiveTable);
    
    // Refresh state management
    const [isRefreshing, setIsRefreshing] = useState(false);
    const [refreshProgress, setRefreshProgress] = useState(0);
    const [refreshMessage, setRefreshMessage] = useState('');
    const [lastRefresh, setLastRefresh] = useState(null);
    const pollIntervalRef = useRef(null);
    const refreshStartTimeRef = useRef(null);
    
    // Set initial active site to the first one
    useEffect(() => {
        if (!active && siteNames.length > 0) {
            setActive(siteNames[0]);
        }
    }, [siteNames]);

    // Fetch keywords data on component mount (works with new sections API or full payload)
    useEffect(() => {
        const params = new URLSearchParams(window.location.search);
        const workbookId = params.get('workbookId');
        if (!workbookId) {
            return;
        }

        // Check cache first
        const cacheKey = `keywords_${workbookId}`;
        const cachedData = sessionStorage.getItem(cacheKey);
        if (cachedData) {
            try {
                const parsed = JSON.parse(cachedData);
                setKeywordsData(parsed);
                return;
            } catch (e) {
                // Invalid cache, continue with fresh fetch
            }
        }

        const scriptUrl = `https://script.google.com/macros/s/AKfycbxfOMp8d_eCVH4lFD0PNuFU1wH-gyWOwRt2EuME7GQJ4U73ZwpPDciohDH3C566YLWq/exec?workbookId=${workbookId}&sections=${encodeURIComponent('keywordsSummary,keywordsTable,keywordsSummaryArchive')}`;
        
        fetchWithCorsWorkaround(scriptUrl, (err, data) => {
            if (err) {
                console.error('Error fetching keywords data:', err);
                return;
            }
            if (data.error) {
                console.error('Script error:', data.error);
                return;
            }
            
            const keywords = {
                keywordsSummary: data.keywordsSummary || data?.dashboard?.keywordsSummary || {},
                keywordsTable: data.keywordsTable || data?.dashboard?.keywordsTable || {},
                keywordsSummaryArchive: data.keywordsSummaryArchive || []
            };
            
            if (keywords.keywordsSummary && keywords.keywordsTable) {
                sessionStorage.setItem(cacheKey, JSON.stringify(keywords));
            }
            setKeywordsData(keywords);
        });
    }, []);

    // Cleanup polling on unmount
    useEffect(() => {
        return () => {
            if (pollIntervalRef.current) {
                clearInterval(pollIntervalRef.current);
            }
        };
    }, []);

    // Refresh functionality
    const triggerRefresh = async () => {
        console.log('Keywords refresh triggered');
        console.log('Webhooks data:', webhooks);
        
        // Use the new n8n webhook URL from Config tab, or fallback to direct URL
        const webhookUrl = webhooks?.Keywords || 'https://n8n.foreverbooked.com/webhook/0a292f97-a1a2-4dc3-ac90-15077cacb676';
        
        if (!webhookUrl) {
            alert('Refresh webhook not configured for keywords');
            console.log('Webhook check failed. Webhooks:', webhooks);
            return;
        }

        setIsRefreshing(true);
        setRefreshProgress(5);
        setRefreshMessage('Triggering keywords automation...');
        refreshStartTimeRef.current = Date.now();

        try {
            // Get the workbook ID from URL parameters
            const params = new URLSearchParams(window.location.search);
            const workbookId = params.get('workbookId');
            
            if (!workbookId) {
                throw new Error('No workbook ID found in URL');
            }

            // Construct the webhook URL with required parameters
            const fullWebhookUrl = `${webhookUrl}?spreadsheetId=${workbookId}&tabName=${encodeURIComponent('Keywords Archive')}`;
            
            console.log('Triggering keywords webhook:', fullWebhookUrl);
            
            const response = await fetch(fullWebhookUrl, {
                method: 'GET',
                mode: 'no-cors' // Many webhooks don't support CORS
            });
            
            // Show success message
            console.log('Keywords webhook triggered successfully!');
            console.log('Webhook response status:', response.status);
            
            setRefreshProgress(15);
            setRefreshMessage('In Progress, Check back in 1.30min...');
            
            // Start polling for data changes
            startPolling();
            
        } catch (error) {
            console.error('Error triggering keywords refresh:', error);
            setIsRefreshing(false);
            setRefreshProgress(0);
            setRefreshMessage('');
            alert(`Failed to trigger keywords refresh: ${error.message}`);
        }
    };

    const startPolling = () => {
        let attempts = 0;
        const maxAttempts = 12; // Poll for ~3 minutes (15s intervals) since keywords now takes ~1.5 minutes
        
        const poll = async () => {
            attempts++;
            const elapsed = (Date.now() - refreshStartTimeRef.current) / 1000;
            const progress = Math.min(15 + (attempts * 7), 95); // Adjusted progress for 12 attempts
            
            setRefreshProgress(progress);
            
            let message;
            if (elapsed < 90) { // First 1.5 minutes
                message = `Keywords automation running... (~1.30min expected)`;
            } else {
                message = `Finalizing AI report and checking for completion...`;
            }
            setRefreshMessage(message);
            
            try {
                // Check if data has been updated by fetching fresh data
                const params = new URLSearchParams(window.location.search);
                const workbookId = params.get('workbookId');
                
                if (workbookId) {
                    const scriptUrl = `https://script.google.com/macros/s/AKfycbxfOMp8d_eCVH4lFD0PNuFU1wH-gyWOwRt2EuME7GQJ4U73ZwpPDciohDH3C566YLWq/exec?workbookId=${workbookId}`;
                    
                    const response = await fetch(scriptUrl);
                    const newData = await response.json();
                    
                                         // Check for changes in keywords data
                     if (newData.keywordsSummary && newData.keywordsTable && hasKeywordsDataChanged(summary, table, newData.keywordsSummary, newData.keywordsTable)) {
                         // Data has changed! Stop polling and update in-place
                         clearInterval(pollIntervalRef.current);
                         setRefreshProgress(100);
                         setRefreshMessage('AI report complete! Loading fresh data...');
                         
                         // Update the data in-place
                         setData(newData);
                         setLastRefresh(new Date());
                         
                         // Update keywords archive data
                         const newKeywordsData = {
                             keywordsSummary: newData.keywordsSummary,
                             keywordsTable: newData.keywordsTable,
                             keywordsSummaryArchive: newData.keywordsSummaryArchive || []
                         };
                         
                         // Update cache
                         const params = new URLSearchParams(window.location.search);
                         const workbookId = params.get('workbookId');
                         if (workbookId) {
                             const cacheKey = `keywords_${workbookId}`;
                             sessionStorage.setItem(cacheKey, JSON.stringify(newKeywordsData));
                         }
                         
                         setKeywordsData(newKeywordsData);
                         
                         // Clear refresh state after a brief success message
                         setTimeout(() => {
                             setIsRefreshing(false);
                             setRefreshProgress(0);
                             setRefreshMessage('');
                         }, 2000);
                         return;
                     }
                }
            } catch (error) {
                console.error('Error polling for keywords updates:', error);
            }
            
            // Hybrid approach: After max attempts, auto-refresh with latest data
            if (attempts >= maxAttempts) {
                clearInterval(pollIntervalRef.current);
                setRefreshProgress(100);
                setRefreshMessage('Automation complete! Refreshing with latest data...');
                
                // Auto-refresh after timeout - fetch the latest data regardless
                try {
                    const params = new URLSearchParams(window.location.search);
                    const workbookId = params.get('workbookId');
                    
                    if (workbookId) {
                        const scriptUrl = `https://script.google.com/macros/s/AKfycbxfOMp8d_eCVH4lFD0PNuFU1wH-gyWOwRt2EuME7GQJ4U73ZwpPDciohDH3C566YLWq/exec?workbookId=${workbookId}`;
                        
                        fetch(scriptUrl)
                            .then(response => response.json())
                            .then(finalData => {
                                if (finalData.keywordsSummary && finalData.keywordsTable) {
                                    setData(finalData);
                                    setLastRefresh(new Date());
                                    console.log('Hybrid fallback: Keywords data refreshed after timeout');
                                    
                                    // Update keywords archive data
                                    const finalKeywordsData = {
                                        keywordsSummary: finalData.keywordsSummary,
                                        keywordsTable: finalData.keywordsTable,
                                        keywordsSummaryArchive: finalData.keywordsSummaryArchive || []
                                    };
                                    
                                    // Update cache
                                    const params = new URLSearchParams(window.location.search);
                                    const workbookId = params.get('workbookId');
                                    if (workbookId) {
                                        const cacheKey = `keywords_${workbookId}`;
                                        sessionStorage.setItem(cacheKey, JSON.stringify(finalKeywordsData));
                                    }
                                    
                                    setKeywordsData(finalKeywordsData);
                                    
                                    // Clear refresh state after updating
                                    setTimeout(() => {
                                        setIsRefreshing(false);
                                        setRefreshProgress(0);
                                        setRefreshMessage('');
                                    }, 1500);
                                } else {
                                    // Fallback failed, clear state
                                    setIsRefreshing(false);
                                    setRefreshProgress(0);
                                    setRefreshMessage('');
                                }
                            })
                            .catch(e => {
                                console.log('Hybrid fallback failed:', e);
                                setIsRefreshing(false);
                                setRefreshProgress(0);
                                setRefreshMessage('');
                            });
                    } else {
                        setIsRefreshing(false);
                        setRefreshProgress(0);
                        setRefreshMessage('');
                    }
                } catch (error) {
                    console.error('Error in hybrid fallback:', error);
                    setIsRefreshing(false);
                    setRefreshProgress(0);
                    setRefreshMessage('');
                }
            }
        };
        
        // Start with immediate poll, then continue with 15-second intervals for reliable detection
        pollIntervalRef.current = setInterval(poll, 15000);
        
        // Wait 30 seconds before first poll to avoid detecting data wipe as completion
        setTimeout(() => {
            console.log('Keywords polling: Starting after 30-second delay to avoid data wipe detection');
        poll();
        }, 30000);
    };

    const hasKeywordsDataChanged = (oldSummary, oldTable, newSummary, newTable) => {
        // Primary check: Has the AI report been generated? This indicates completion
        const hasAiReport = newSummary?.keywordsAiReport && 
                           String(newSummary.keywordsAiReport).trim() !== '' &&
                           String(newSummary.keywordsAiReport).trim().length > 50; // Ensure it's substantial content, not just placeholder
        
        // Additional validation: Check if we have meaningful summary data (not wiped)
        const hasMeaningfulData = newSummary?.totalKeywords && 
                                 parseInt(newSummary.totalKeywords) > 0 &&
                                 newSummary?.website && 
                                 String(newSummary.website).trim() !== '';
        
        // Combined check: Must have both AI report AND meaningful data
        const isComplete = hasAiReport && hasMeaningfulData;
        
        // Secondary check: Has other key keywords data changed (as backup)
        let hasActualChanges = false;
        
        // Check if any keyword data has actually changed (positions, URLs, etc.)
        Object.keys(oldTable || {}).forEach(siteName => {
            const oldKeywords = oldTable[siteName] || [];
            const newKeywords = newTable[siteName] || [];
            
            // Quick check - different number of keywords
            if (oldKeywords.length !== newKeywords.length) {
                console.log(`Keywords count changed for ${siteName}: ${oldKeywords.length} -> ${newKeywords.length}`);
                hasActualChanges = true;
                return;
            }
            
            // Deeper check - compare first few keyword entries for changes
            const checkCount = Math.min(5, oldKeywords.length); // Check first 5 keywords
            for (let i = 0; i < checkCount; i++) {
                const oldKw = oldKeywords[i];
                const newKw = newKeywords[i];
                
                if (oldKw && newKw) {
                    // Check key fields that would indicate fresh data
                    if (oldKw.rank_now !== newKw.rank_now || 
                        oldKw.rank_prev !== newKw.rank_prev ||
                        oldKw.ranking_url !== newKw.ranking_url ||
                        oldKw.ranking_title !== newKw.ranking_title) {
                        console.log(`Keyword data changed for ${siteName}: ${oldKw.keyword} position ${oldKw.rank_now} -> ${newKw.rank_now}`);
                        hasActualChanges = true;
                        return;
                    }
                }
            }
        });
        
        // Also check summary changes as backup
        const hasSummaryChanges = (
            parseInt(oldSummary?.totalKeywords) !== parseInt(newSummary?.totalKeywords) ||
            parseInt(oldSummary?.pos1) !== parseInt(newSummary?.pos1) ||
            parseInt(oldSummary?.isNew) !== parseInt(newSummary?.isNew) ||
            parseInt(oldSummary?.isUp) !== parseInt(newSummary?.isUp) ||
            parseInt(oldSummary?.isDown) !== parseInt(newSummary?.isDown) ||
            parseInt(oldSummary?.isLost) !== parseInt(newSummary?.isLost)
        );
        
        console.log('Keywords polling check:', {
            hasAiReport: hasAiReport,
            hasMeaningfulData: hasMeaningfulData,
            isComplete: isComplete,
            aiReportContent: newSummary?.keywordsAiReport?.substring(0, 100) + '...',
            aiReportLength: newSummary?.keywordsAiReport?.length || 0,
            actualDataChanges: hasActualChanges,
            summaryChanges: hasSummaryChanges,
            keywordsTableSites: Object.keys(newTable || {}),
            totalKeywords: newSummary?.totalKeywords,
            website: newSummary?.website
        });
        
        // Consider complete when both AI report is generated AND we have meaningful data
        return isComplete;
    };

    const cancelRefresh = () => {
        if (pollIntervalRef.current) {
            clearInterval(pollIntervalRef.current);
        }
        setIsRefreshing(false);
        setRefreshProgress(0);
        setRefreshMessage('');
    };

    // Icons
    const Search = createIcon(
        <>
            <circle cx="11" cy="11" r="8" />
            <line x1="21" y1="21" x2="16.65" y2="16.65" />
        </>
    );
    const ExternalLink = createIcon(
        <>
            <path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6" />
            <polyline points="15 3 21 3 21 9" />
            <line x1="10" y1="14" x2="21" y2="3" />
        </>
    );

    // Reusable component for each stat in the summary
    const SummaryStat = ({ label, value, color, icon, valuePrefix = '' }) => (
        <div className="flex items-center justify-between p-3 bg-slate-50 rounded-lg transition-all hover:shadow-md hover:bg-white">
            <div className="flex items-center">
                {icon && <div className="mr-3 text-gray-400">{icon}</div>}
                <span className="text-sm text-gray-600 font-medium">{label}</span>
            </div>
            <span className={`text-lg font-bold ${color}`}>
                {value > 0 ? valuePrefix : ''}{value}
            </span>
        </div>
    );

    // Format number with fallback
    const formatNumber = (num) => {
        if (num === undefined || num === null) return '-';
        return typeof num === 'number' ? num.toLocaleString() : num;
    };

    // Format currency with fallback
    const formatCurrency = (num) => {
        if (num === undefined || num === null) return '-';
        return typeof num === 'number' ? `$${num.toFixed(2)}` : num;
    };

    // Process archive data for month slider
    const processedArchiveData = keywordsData?.keywordsSummaryArchive && keywordsData.keywordsSummaryArchive.length > 0 
        ? keywordsData.keywordsSummaryArchive.map((item, index) => {
            let parsedDate = null;
            
            // Try to use the backend's parsedDate if available
            if (item.parsedDate) {
                parsedDate = new Date(item.parsedDate);
            }
            
            // If parsedDate is invalid or not available, try other approaches
            if (!parsedDate || isNaN(parsedDate.getTime())) {
                if (item.date) {
                    parsedDate = new Date(item.date);
                    
                    // If that fails, try US date format parsing
                    if (isNaN(parsedDate.getTime())) {
                        const dateStr = item.date.toString();
                        const parts = dateStr.split('/');
                        if (parts.length === 3) {
                            const month = parseInt(parts[0]) - 1;
                            const day = parseInt(parts[1]);
                            const year = parseInt(parts[2]);
                            parsedDate = new Date(year, month, day);
                        }
                    }
                }
                
                if ((!parsedDate || isNaN(parsedDate.getTime())) && item.rawDate) {
                    parsedDate = new Date(item.rawDate);
                    
                    if (isNaN(parsedDate.getTime())) {
                        const dateStr = item.rawDate.toString();
                        const parts = dateStr.split('/');
                        if (parts.length === 3) {
                            const month = parseInt(parts[0]) - 1;
                            const day = parseInt(parts[1]);
                            const year = parseInt(parts[2]);
                            parsedDate = new Date(year, month, day);
                        }
                    }
                }
            }
            
            const formattedDate = parsedDate && !isNaN(parsedDate.getTime()) 
                ? parsedDate.toLocaleString('default', { month: 'long', year: 'numeric' })
                : item.date;
            
            return {
                ...item,
                date: formattedDate,
                parsedDate: parsedDate
            };
        }).sort((a, b) => {
            // Sort by parsed date (newest first)
            if (a.parsedDate && b.parsedDate) {
                return b.parsedDate.getTime() - a.parsedDate.getTime();
            }
            return 0;
        })
        : [];
    
    // Determine which summary data to use based on current month selection
    const currentSummaryData = (processedArchiveData.length > 0 && currentMonthIndex < processedArchiveData.length
        ? processedArchiveData[currentMonthIndex]
        : effectiveSummary) || {};
    return (
        <PageContent>
            {/* Header Section */}
            <div className="mb-6">
                <div className="flex justify-between items-center">
                    <div>
                        <h1 className="text-3xl font-bold text-gray-800">Keyword Analysis</h1>
                        <p className="text-gray-600 mt-1">Track your keyword rankings and performance metrics</p>
                    </div>
                    <div className="flex items-center space-x-4">
                        {lastRefresh && (
                            <span className="text-sm text-gray-500">
                                Last updated: {lastRefresh.toLocaleTimeString()}
                            </span>
                        )}
                        
                        {/* Inline Progress Indicator */}
                        {isRefreshing && (
                            <div className="flex items-center space-x-3 bg-white rounded-xl shadow-md px-4 py-2 border border-gray-100">
                                <div className="flex items-center space-x-2">
                                    <div className="w-4 h-4 border-2 border-blue-500 border-t-transparent rounded-full animate-spin"></div>
                                    <span className="text-sm font-medium text-gray-700">{refreshMessage}</span>
                                </div>
                                <div className="w-16 bg-gray-200 rounded-full h-2">
                                    <div 
                                        className="bg-gradient-to-r from-blue-500 to-blue-600 h-2 rounded-full transition-all duration-500 ease-out"
                                        style={{ width: `${refreshProgress}%` }}
                                    ></div>
                                </div>
                                <span className="text-xs font-medium text-blue-600 min-w-[2rem]">{refreshProgress}%</span>
                            </div>
                        )}
                        
                        <button 
                            onClick={isRefreshing ? cancelRefresh : triggerRefresh}
                            disabled={!webhooks && !webhooks?.Keywords}
                            className={`px-6 py-2 rounded-xl font-medium transition-all duration-200 shadow-lg hover:shadow-xl ${
                                isRefreshing 
                                    ? 'bg-red-500 hover:bg-red-600 text-white' 
                                    : 'bg-gradient-to-r from-blue-500 to-blue-600 hover:from-blue-600 hover:to-blue-700 text-white'
                            } disabled:opacity-50 disabled:cursor-not-allowed`}
                        >
                            {isRefreshing ? 'Cancel' : 'Rescan Keywords'}
                        </button>
                    </div>
                </div>
            </div>

            <Card className="mb-6 group hover:shadow-xl transition-all duration-300 hover:-translate-y-0.5 hover:border-blue-200/60">
                <div className="flex justify-between items-center mb-4">
                    <div className="flex items-center space-x-2">
                        <h2 className="text-xl font-bold text-gray-800">Keywords Summary</h2>
                        <InfoTooltip text="Overview of your keyword rankings, showing positions, changes, and estimated values." />
                    </div>
                    
                    {/* Month slider controls */}
                    {processedArchiveData.length > 1 && (
                        <div className="flex items-center space-x-3">
                            <button 
                                onClick={() => {
                                    const newIndex = currentMonthIndex + 1;
                                    if (newIndex < processedArchiveData.length) {
                                        setCurrentMonthIndex(newIndex);
                                    }
                                }} 
                                disabled={currentMonthIndex >= processedArchiveData.length - 1}
                                className="flex items-center justify-center w-8 h-8 rounded-lg bg-blue-100 hover:bg-blue-200 disabled:opacity-50 disabled:cursor-not-allowed text-blue-600 transition-colors"
                                title="Go back to older month"
                            >
                                <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M15 19l-7-7 7-7" />
                                </svg>
                            </button>
                            <div className="text-center">
                                <span className="font-semibold text-gray-700 text-sm">
                                    {currentMonthIndex < processedArchiveData.length 
                                        ? processedArchiveData[currentMonthIndex].date 
                                        : 'Current'}
                                </span>
                                <div className="text-xs text-gray-500">
                                    {processedArchiveData.length - currentMonthIndex} of {processedArchiveData.length}
                                </div>
                                <div className="flex items-center justify-center space-x-1 mt-1">
                                    {processedArchiveData.map((_, index) => {
                                        const visualIndex = processedArchiveData.length - 1 - index;
                                        return (
                                            <div
                                                key={index}
                                                className={`w-2 h-2 rounded-full ${
                                                    index === currentMonthIndex 
                                                        ? 'bg-blue-600' 
                                                        : 'bg-gray-300 hover:bg-gray-400'
                                                } cursor-pointer transition-colors`}
                                                onClick={() => setCurrentMonthIndex(index)}
                                                title={`Go to ${processedArchiveData[index]?.date || 'Unknown month'} (${processedArchiveData.length - index} of ${processedArchiveData.length})`}
                                                style={{ order: visualIndex }}
                                            />
                                        );
                                    })}
                                </div>
                            </div>
                            <button 
                                onClick={() => {
                                    const newIndex = currentMonthIndex - 1;
                                    if (newIndex >= 0) {
                                        setCurrentMonthIndex(newIndex);
                                    }
                                }} 
                                disabled={currentMonthIndex <= 0}
                                className="flex items-center justify-center w-8 h-8 rounded-lg bg-blue-100 hover:bg-blue-200 disabled:opacity-50 disabled:cursor-not-allowed text-blue-600 transition-colors"
                                title="Go forward to newer month"
                            >
                                <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M9 5l7 7-7 7" />
                                </svg>
                            </button>
                        </div>
                    )}
                    
                    {/* Single month display */}
                    {processedArchiveData.length <= 1 && (
                        <span className="font-semibold text-gray-700">
                            {processedArchiveData.length === 1 ? processedArchiveData[0].date : 'Current'}
                        </span>
                    )}
                </div>

                <div className="grid grid-cols-1 lg:grid-cols-3 gap-8">
                    {/* Column 1: Core & Financial Metrics */}
                    <div className="space-y-6 flex flex-col">
                        <div className="p-6 rounded-xl text-center flex-grow flex flex-col justify-center border border-gray-200">
                            <p className="text-base text-gray-500">Total Keywords Tracked</p>
                            <p className="text-5xl font-bold text-blue-600">{(() => {
                                // Use Client_kw count from effectiveTable as source of truth
                                const siteNamesAll = Object.keys(effectiveTable || {});
                                const clientSite = siteNamesAll.length > 0 ? siteNamesAll[0] : '';
                                const clientRows = clientSite ? (effectiveTable[clientSite] || []) : [];
                                const tableTotal = clientRows.length;

                                // Fallback to summary if table not available yet
                                const summaryTotal = parseInt(summary?.totalKeywords) || parseInt(currentSummaryData?.totalKeywords) || 0;
                                const display = tableTotal > 0 ? tableTotal : summaryTotal;

                                console.log('Total Keywords Tracked - Computed:', { clientSite, tableTotal, summaryTotal, display });
                                return Number(display).toLocaleString();
                            })()}</p>
                            <p className="text-sm text-gray-500 mt-2">
                                <span className={(Number(currentSummaryData?.totalKeywordsChange) || 0) >= 0 ? 'text-green-600' : 'text-red-600'}>
                                    {(Number(currentSummaryData?.totalKeywordsChange) || 0) >= 0 ? '+' : ''}{Number(currentSummaryData?.totalKeywordsChange) || 0}
                                </span> vs prev month
                            </p>
                            </div>
                        <div className="space-y-4">
                            {/* Est. Traffic Value Card */}
                            <div className="bg-white rounded-xl shadow-sm border border-gray-200 p-4 hover:shadow-md transition-all duration-300 group metric-card">
                                <div className="flex items-center justify-between">
                                    <div className="flex items-center space-x-3">
                                        <div className="p-2 bg-green-100 rounded-lg group-hover:bg-green-200 transition-colors">
                                            <svg className="w-5 h-5 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1" />
                                            </svg>
                                        </div>
                                        <div>
                                            <p className="text-sm font-medium text-gray-600">Est. Traffic Value</p>
                                            <p className="text-xs text-gray-500">Monthly organic value</p>
                                        </div>
                                    </div>
                                    <div className="text-right">
                                        <p className="text-xl font-bold text-gray-800">${(parseFloat(currentSummaryData.etv) || 0).toFixed(2)}</p>
                                        <p className="text-xs text-gray-500">
                                            <span className={(Number(currentSummaryData.etvChange) || 0) >= 0 ? 'text-green-600' : 'text-red-600'}>
                                                {(Number(currentSummaryData.etvChange) || 0) >= 0 ? '+' : ''}${(Number(currentSummaryData.etvChange) || 0).toFixed(2)}
                                            </span> vs prev month
                                        </p>
                                    </div>
                                </div>
                            </div>

                            {/* Est. Paid Cost Card */}
                            <div className="bg-white rounded-xl shadow-sm border border-gray-200 p-4 hover:shadow-md transition-all duration-300 group metric-card">
                                <div className="flex items-center justify-between">
                                    <div className="flex items-center space-x-3">
                                        <div className="p-2 bg-blue-100 rounded-lg group-hover:bg-blue-200 transition-colors">
                                            <svg className="w-5 h-5 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M17 9V7a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2m2 4h10a2 2 0 002-2v-6a2 2 0 00-2-2H9a2 2 0 00-2 2v6a2 2 0 002 2zm7-5a2 2 0 11-4 0 2 2 0 014 0z" />
                                            </svg>
                                        </div>
                                        <div>
                                            <p className="text-sm font-medium text-gray-600">Est. Paid Cost</p>
                                            <p className="text-xs text-gray-500">PPC equivalent cost</p>
                                        </div>
                                    </div>
                                    <div className="text-right">
                                        <p className="text-xl font-bold text-gray-800">${(parseFloat(currentSummaryData.estPaidCost) || 0).toFixed(2)}</p>
                                        <p className="text-xs text-gray-500">
                                            <span className={(Number(currentSummaryData.estPaidCostChange) || 0) >= 0 ? 'text-green-600' : 'text-red-600'}>
                                                {(Number(currentSummaryData.estPaidCostChange) || 0) >= 0 ? '+' : ''}${(Number(currentSummaryData.estPaidCostChange) || 0).toFixed(2)}
                                            </span> vs prev month
                                        </p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    {/* Column 2: Ranking Distribution */}
                    <div className="bg-white rounded-xl shadow-sm border border-gray-200 p-6 hover:shadow-md transition-all duration-300">
                        <div className="flex items-center justify-between mb-4">
                            <h3 className="text-lg font-semibold text-gray-800">Ranking Distribution</h3>
                            <InfoTooltip text="Shows how many keywords rank in different position ranges. Higher positions (1-3) drive more traffic and are more valuable for SEO." />
                        </div>
                        <div className="space-y-3">
                            {(() => {
                                // Comprehensive debug logging for ranking distribution
                                console.log('Full Keywords Summary Object:', currentSummaryData);
                                console.log('All Summary Keys:', Object.keys(currentSummaryData || {}));
                                console.log('Ranking Distribution Debug:', {
                                    // Try different possible field names
                                    pos1: currentSummaryData.pos1,
                                    'Position 1': currentSummaryData['Position 1'],
                                    pos2_3: currentSummaryData.pos2_3,
                                    'Position 2-3': currentSummaryData['Position 2-3'],
                                    'Positions 2-3': currentSummaryData['Positions 2-3'],
                                    pos4_10: currentSummaryData.pos4_10,
                                    'Position 4-10': currentSummaryData['Position 4-10'],
                                    'Positions 4-10': currentSummaryData['Positions 4-10'],
                                    pos11_20: currentSummaryData.pos11_20,
                                    'Position 11-20': currentSummaryData['Position 11-20'],
                                    'Positions 11-20': currentSummaryData['Positions 11-20']
                                });
                                return null;
                            })()}
                            {(() => {
                                // Calculate ranking distribution ONLY for CLIENT keywords
                                const calculateClientRankingDistribution = () => {
                                    // IMPORTANT: Always use first website (client) for ranking distribution
                                    // regardless of which tab is currently active
                                    const siteNames = Object.keys(effectiveTable || {});
                                    let clientKeywords = [];
                                    let clientSiteName = '';
                                    
                                    if (siteNames.length > 0) {
                                        // Always use the FIRST website as the client for ranking distribution
                                        // This ensures consistency regardless of active tab
                                        clientSiteName = siteNames[0];
                                        const clientSiteData = effectiveTable[clientSiteName] || [];
                                        
                                        clientKeywords = clientSiteData.filter(keyword => 
                                            keyword.rank_now && keyword.rank_now > 0
                                        );
                                        
                                        console.log(`Ranking Distribution - Using ${clientSiteName} as CLIENT with ${clientKeywords.length} ranked keywords`);
                                    }
                                    
                                    // Calculate position buckets with correct ranges - CLIENT ONLY
                                    const pos1Count = clientKeywords.filter(kw => kw.rank_now === 1).length;
                                    const pos2_3Count = clientKeywords.filter(kw => kw.rank_now >= 2 && kw.rank_now <= 3).length;
                                    const pos4_10Count = clientKeywords.filter(kw => kw.rank_now >= 4 && kw.rank_now <= 10).length;
                                    const pos11_20Count = clientKeywords.filter(kw => kw.rank_now >= 11 && kw.rank_now <= 20).length;
                                    
                                    console.log('CLIENT ONLY Ranking Distribution:', {
                                        clientSite: clientSiteName,
                                        totalClientKeywords: clientKeywords.length,
                                        pos1: pos1Count,
                                        pos2_3: pos2_3Count,
                                        pos4_10: pos4_10Count,
                                        pos11_20: pos11_20Count,
                                        total: pos1Count + pos2_3Count + pos4_10Count + pos11_20Count
                                    });
                                    
                                    return {
                                        pos1: pos1Count,
                                        pos2_3: pos2_3Count,
                                        pos4_10: pos4_10Count,
                                        pos11_20: pos11_20Count
                                    };
                                };
                                
                                const distributionData = calculateClientRankingDistribution();
                                const pos1Value = distributionData.pos1;
                                const pos2_3Value = distributionData.pos2_3;
                                const pos4_10Value = distributionData.pos4_10;
                                const pos11_20Value = distributionData.pos11_20;
                                
                                const positions = [
                                    { label: "Position 1", value: pos1Value, color: pos1Value > 0 ? 'text-emerald-600' : 'text-gray-500', bgColor: pos1Value > 0 ? 'bg-emerald-50' : 'bg-gray-50', icon: "🥇" },
                                    { label: "Positions 2-3", value: pos2_3Value, color: pos2_3Value > 0 ? 'text-emerald-500' : 'text-gray-500', bgColor: pos2_3Value > 0 ? 'bg-emerald-50' : 'bg-gray-50', icon: "🥈" },
                                    { label: "Positions 4-10", value: pos4_10Value, color: pos4_10Value > 0 ? 'text-blue-500' : 'text-gray-500', bgColor: pos4_10Value > 0 ? 'bg-blue-50' : 'bg-gray-50', icon: "🥉" },
                                    { label: "Positions 11-20", value: pos11_20Value, color: pos11_20Value > 0 ? 'text-yellow-500' : 'text-gray-500', bgColor: pos11_20Value > 0 ? 'bg-yellow-50' : 'bg-gray-50', icon: "📊" }
                                ];
                                
                                return positions.map((position, index) => (
                                    <div key={index} className={`flex items-center justify-between p-3 rounded-lg ${position.bgColor} transition-all hover:shadow-sm`}>
                                        <div className="flex items-center space-x-3">
                                            <span className="text-lg">{position.icon}</span>
                                            <span className="text-sm font-medium text-gray-700">{position.label}</span>
                                        </div>
                                        <span className={`text-lg font-bold ${position.color}`}>{position.value}</span>
                                    </div>
                                ));
                            })()}
                        </div>
                    </div>

                    {/* Column 3: Keyword Dynamics */}
                    <div className="bg-white rounded-xl shadow-sm border border-gray-200 p-6 hover:shadow-md transition-all duration-300">
                        <div className="flex items-center justify-between mb-4">
                            <h3 className="text-lg font-semibold text-gray-800">Keyword Dynamics</h3>
                            <InfoTooltip text="Tracks keyword movement over time. Shows which keywords are improving, declining, newly ranking, or have been lost since the last update." />
                        </div>
                        <div className="space-y-3">
                            {(() => {
                                const dynamics = [
                                    { 
                                        label: "Improved", 
                                        value: parseInt(currentSummaryData.isUp) || 0, 
                                        color: (parseInt(currentSummaryData.isUp) || 0) > 0 ? 'text-green-600' : 'text-gray-500',
                                        bgColor: (parseInt(currentSummaryData.isUp) || 0) > 0 ? 'bg-green-50' : 'bg-gray-50',
                                        icon: <ArrowUp className="w-5 h-5" />,
                                        valuePrefix: "+"
                                    },
                                    { 
                                        label: "New", 
                                        value: parseInt(currentSummaryData.isNew) || 0, 
                                        color: (parseInt(currentSummaryData.isNew) || 0) > 0 ? 'text-blue-600' : 'text-gray-500',
                                        bgColor: (parseInt(currentSummaryData.isNew) || 0) > 0 ? 'bg-blue-50' : 'bg-gray-50',
                                        icon: <Star className="w-5 h-5 text-blue-500" fill="currentColor"/>,
                                        valuePrefix: ""
                                    },
                                    { 
                                        label: "Declined", 
                                        value: parseInt(currentSummaryData.isDown) || 0, 
                                        color: (parseInt(currentSummaryData.isDown) || 0) > 0 ? 'text-red-600' : 'text-gray-500',
                                        bgColor: (parseInt(currentSummaryData.isDown) || 0) > 0 ? 'bg-red-50' : 'bg-gray-50',
                                        icon: <ArrowDown className="w-5 h-5" />,
                                        valuePrefix: ""
                                    },
                                    { 
                                        label: "Lost", 
                                        value: parseInt(currentSummaryData.isLost) || 0, 
                                        color: (parseInt(currentSummaryData.isLost) || 0) > 0 ? 'text-red-600' : 'text-gray-500',
                                        bgColor: (parseInt(currentSummaryData.isLost) || 0) > 0 ? 'bg-red-50' : 'bg-gray-50',
                                        icon: <XCircle className="w-5 h-5" />,
                                        valuePrefix: ""
                                    }
                                ];
                                
                                return dynamics.map((dynamic, index) => (
                                    <div key={index} className={`flex items-center justify-between p-3 rounded-lg ${dynamic.bgColor} transition-all hover:shadow-sm`}>
                                        <div className="flex items-center space-x-3">
                                            <div className={`${dynamic.color}`}>{dynamic.icon}</div>
                                            <span className="text-sm font-medium text-gray-700">{dynamic.label}</span>
                                        </div>
                                        <span className={`text-lg font-bold ${dynamic.color}`}>
                                            {dynamic.value > 0 ? dynamic.valuePrefix : ''}{dynamic.value}
                                        </span>
                                    </div>
                                ));
                            })()}
                        </div>
                    </div>
                </div>
            </Card>

            {/* Keywords Report Section */}
            <div className="mb-8">
                <KeywordsReport 
                    reportText={effectiveSummary?.keywordsAiReport || 'Keywords targeting report will appear here once generated.'}
                />
            </div>

            <Card className="group hover:shadow-xl transition-all duration-300 hover:-translate-y-0.5 hover:border-blue-200/60">
                                <div className="flex items-center space-x-2 mb-4">
                    <h2 className="text-xl font-bold text-gray-800">Keywords</h2>
                    <InfoTooltip text="Analyze keyword rankings for your site and competitors. Use the tabs to switch between different sites." />
                </div>

                <div className="mb-4">
                    <div className="relative">
                        <Search className="absolute left-3 top-1/2 -translate-y-1/2 w-5 h-5 text-gray-400" />
                        <input
                            type="text"
                            placeholder="Search by keyword, URL, or title..."
                            value={searchTerm}
                            onChange={(e) => setSearchTerm(e.target.value)}
                            className="w-full pl-10 pr-4 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500"
                        />
                </div>
                </div>

                <div className="flex space-x-1 mb-4 overflow-x-auto">
                    {siteNames.map(name => (
                    <button
                            key={name}
                            onClick={() => {
                                setActive(name);
                                setSearchTerm('');
                            }}
                            className={`px-4 py-2 text-sm font-medium rounded-lg whitespace-nowrap transition-colors duration-200
                                ${active === name
                                    ? 'bg-green-100 text-green-800'
                                    : 'text-gray-600 hover:bg-gray-100'}`}
                        >
                            {name}
                    </button>
                    ))}
            </div>
            
                {/* Website Keywords Summary Bar */}
                {active && (
                    <div className="mb-3 py-1.5 px-3 bg-gradient-to-r from-green-50 to-emerald-50 rounded-lg">
                        <div className="flex items-center justify-start space-x-10">
                            {(() => {
                                const siteData = effectiveTable[active] || [];
                                // Use the loaded table length for per-website totals
                                // This shows the actual count for each individual website
                                const totalKeywords = siteData.length;
                                const newKeywords = siteData.filter(kw => kw.is_new).length;
                                const upKeywords = siteData.filter(kw => kw.is_up).length;
                                const downKeywords = siteData.filter(kw => kw.is_down).length;
                                const lostKeywords = siteData.filter(kw => kw.is_lost).length;
                                const avgPosition = siteData.length > 0 && siteData.some(kw => kw.rank_now > 0)
                                    ? (siteData.filter(kw => kw.rank_now > 0).reduce((sum, kw) => sum + (kw.rank_now || 0), 0) / siteData.filter(kw => kw.rank_now > 0).length).toFixed(1)
                                    : 0;
                                const avgVolume = siteData.length > 0 && siteData.some(kw => kw.search_vol > 0)
                                    ? Math.round(siteData.filter(kw => kw.search_vol > 0).reduce((sum, kw) => sum + (kw.search_vol || 0), 0) / siteData.filter(kw => kw.search_vol > 0).length)
                                    : 0;
                                const avgDifficulty = siteData.length > 0 && siteData.some(kw => kw.keyword_difficulty > 0)
                                    ? (siteData.filter(kw => kw.keyword_difficulty > 0).reduce((sum, kw) => sum + (kw.keyword_difficulty || 0), 0) / siteData.filter(kw => kw.keyword_difficulty > 0).length).toFixed(0)
                                    : 0;

                                return (
                                    <>
                                        <div className="flex-1 text-center border-r border-gray-200 pr-5">
                                            <div className="text-base font-bold text-blue-600">{totalKeywords}</div>
                                            <div className="text-xs text-gray-600">Total Keywords</div>
                        </div>
                                        <div className="flex-1 text-center border-r border-gray-200 pr-5">
                                            <div className="text-base font-bold text-green-600">{newKeywords}</div>
                                            <div className="text-xs text-gray-600">New Keywords</div>
                                        </div>
                                        <div className="flex-1 text-center border-r border-gray-200 pr-5">
                                            <div className="text-base font-bold text-orange-600">{avgPosition}</div>
                                            <div className="text-xs text-gray-600">Avg Position</div>
                                        </div>
                                        <div className="flex-1 text-center border-r border-gray-200 pr-5">
                                            <div className="text-base font-bold text-gray-700">{avgVolume.toLocaleString()}</div>
                                            <div className="text-xs text-gray-600">Avg Volume</div>
                                        </div>
                                        <div className="flex-1 text-center border-r border-gray-200 pr-5">
                                            <div className={`text-base font-bold ${avgDifficulty <= 30 ? 'text-green-600' : avgDifficulty <= 60 ? 'text-yellow-600' : 'text-red-600'}`}>
                                                {avgDifficulty}
                                            </div>
                                            <div className="text-xs text-gray-600">Avg Difficulty</div>
                                        </div>
                                        <div className="flex-1 text-center border-r border-gray-200 pr-5">
                                            <div className="flex justify-center items-center space-x-4">
                                                <div className="text-center">
                                                    <div className="flex items-center justify-center space-x-1">
                                                        <svg className="w-3 h-3 text-green-600" fill="currentColor" viewBox="0 0 20 20">
                                                            <path fillRule="evenodd" d="M5.293 9.707a1 1 0 010-1.414l4-4a1 1 0 011.414 0l4 4a1 1 0 01-1.414 1.414L11 7.414V15a1 1 0 11-2 0V7.414L6.707 9.707a1 1 0 01-1.414 0z" clipRule="evenodd" />
                                                        </svg>
                                                        <div className="text-sm font-bold text-green-600">{upKeywords}</div>
                                                    </div>
                                                    <div className="text-xs text-gray-600">Up</div>
                                                </div>
                                                <div className="text-center">
                                                    <div className="flex items-center justify-center space-x-1">
                                                        <div className="text-sm font-bold text-red-600">{downKeywords}</div>
                                                        <svg className="w-3 h-3 text-red-600" fill="currentColor" viewBox="0 0 20 20">
                                                            <path fillRule="evenodd" d="M14.707 10.293a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 111.414-1.414L9 12.586V5a1 1 0 012 0v7.586l2.293-2.293a1 1 0 011.414 0z" clipRule="evenodd" />
                                                        </svg>
                                                    </div>
                                                    <div className="text-xs text-gray-600">Down</div>
                                                </div>
                                            </div>
                                        </div>
                                    </>
                                );
                            })()}
                        </div>
                                                        </div>
                                                    )}

                <div className="mt-4 overflow-x-auto">
                    <table className="w-full text-left text-sm whitespace-nowrap">
                        <thead>
                            <tr className="border-b-2 border-t border-gray-200 bg-gray-50">
                                <th className="py-2 px-3">Keyword</th>
                                <th className="py-2 px-3 text-center">Position</th>
                                <th className="py-2 px-3 text-center">Previous</th>
                                <th className="py-2 px-3 text-center">Change</th>
                                <th className="py-2 px-3 text-center">Status</th>
                                <th className="py-2 px-3 text-center">Volume</th>
                                <th className="py-2 px-3 text-center">CPC</th>
                                <th className="py-2 px-3 text-center">Difficulty</th>
                                <th className="py-2 px-3 text-center">Intent</th>
                                <th className="py-2 px-3 text-center">Competition</th>
                                <th className="py-2 px-3">Title</th>
                                <th className="py-2 px-3 text-center">Check</th>
                            </tr>
                        </thead>
                        <tbody>
                            {effectiveTable[active]?.filter(row =>
                                row.keyword?.toLowerCase().includes(searchTerm.toLowerCase()) ||
                                row.ranking_url?.toLowerCase().includes(searchTerm.toLowerCase()) ||
                                row.ranking_title?.toLowerCase().includes(searchTerm.toLowerCase())
                            )?.map((row, index) => (
                                <tr key={index} className="border-b border-gray-100 hover:bg-slate-50">
                                    <td className="py-3 px-3 font-medium">{row.keyword}</td>
                                    <td className="py-3 px-3 text-center font-medium">
                                        <span className={`inline-block px-2 py-1 rounded-full text-xs font-semibold
                                            ${row.rank_now <= 1 ? 'bg-emerald-100 text-emerald-800' :
                                            row.rank_now <= 3 ? 'bg-emerald-50 text-emerald-700' :
                                            row.rank_now <= 10 ? 'bg-blue-50 text-blue-700' :
                                            'bg-yellow-50 text-yellow-700'}`}>
                                            {formatNumber(row.rank_now)}
                                        </span>
                                    </td>
                                    <td className="py-3 px-3 text-center">{formatNumber(row.rank_prev) || '-'}</td>
                                    <td className="py-3 px-3 text-center">
                                        {row.rank_prev && row.rank_now ? (
                                            <span className={
                                                row.rank_prev > row.rank_now ? 'text-green-600' :
                                                row.rank_prev < row.rank_now ? 'text-red-600' :
                                                'text-gray-400'
                                            }>
                                                {row.rank_prev > row.rank_now ? '+' : ''}{row.rank_prev - row.rank_now || '-'}
                                            </span>
                                        ) : '-'}
                                    </td>
                                    <td className="py-3 px-3 text-center">
                                        {row.is_new ? (
                                            <span className="text-xs font-semibold px-2 py-1 bg-blue-100 text-blue-800 rounded-full">New</span>
                                        ) : row.is_lost ? (
                                            <span className="text-xs font-semibold px-2 py-1 bg-red-100 text-red-800 rounded-full">Lost</span>
                                        ) : row.is_up ? (
                                            <span className="text-xs font-semibold px-2 py-1 bg-green-100 text-green-800 rounded-full">Up</span>
                                        ) : row.is_down ? (
                                            <span className="text-xs font-semibold px-2 py-1 bg-yellow-100 text-yellow-800 rounded-full">Down</span>
                                        ) : (
                                            <span className="text-gray-400">-</span>
                                        )}
                                    </td>
                                    <td className="py-3 px-3 text-center">{formatNumber(row.search_vol)}</td>
                                    <td className="py-3 px-3 text-center">{formatCurrency(row.cpc_usd)}</td>
                                    <td className="py-3 px-3 text-center">
                                        <span className={`px-2 py-1 rounded-full text-xs font-semibold
                                            ${row.keyword_difficulty <= 30 ? 'bg-green-100 text-green-800' :
                                            row.keyword_difficulty <= 60 ? 'bg-yellow-100 text-yellow-800' :
                                            'bg-red-100 text-red-800'}`}>
                                            {row.keyword_difficulty || '-'}
                                        </span>
                                    </td>
                                    <td className="py-3 px-3 text-center">
                                        <span className={`px-2 py-1 rounded-full text-xs font-semibold
                                            ${row.intent === 'commercial' ? 'bg-green-100 text-green-800' :
                                            row.intent === 'informational' ? 'bg-blue-100 text-blue-800' :
                                            row.intent === 'navigational' ? 'bg-purple-100 text-purple-800' :
                                            'bg-gray-100 text-gray-800'}`}>
                                            {row.intent || '-'}
                                        </span>
                                    </td>
                                    <td className="py-3 px-3 text-center">
                                        <span className={`px-2 py-1 rounded-full text-xs font-semibold
                                            ${row.competition_lvl === 'low' ? 'bg-green-100 text-green-800' :
                                            row.competition_lvl === 'medium' ? 'bg-yellow-100 text-yellow-800' :
                                            row.competition_lvl === 'high' ? 'bg-red-100 text-red-800' :
                                            'bg-gray-100 text-gray-800'}`}>
                                            {row.competition_lvl || '-'}
                                        </span>
                                    </td>
                                    <td className="py-3 px-3 text-gray-600 max-w-xs truncate" title={row.ranking_title}>
                                        {row.ranking_title || '-'}
                                    </td>
                                    <td className="py-3 px-3 text-center">
                                        {row.check_url && (
                                            <a href={row.check_url} target="_blank" rel="noopener noreferrer" className="text-blue-600 hover:text-blue-800 inline-block">
                                                <ExternalLink className="w-4 h-4" />
                                            </a>
                                        )}
                                    </td>
                                </tr>
                            ))}
                        </tbody>
                    </table>
                    {effectiveTable[active]?.filter(row =>
                        row.keyword?.toLowerCase().includes(searchTerm.toLowerCase()) ||
                        row.ranking_url?.toLowerCase().includes(searchTerm.toLowerCase()) ||
                        row.ranking_title?.toLowerCase().includes(searchTerm.toLowerCase())
                    )?.length === 0 && (
                        <div className="text-center py-8 text-gray-500">
                            No matching keywords found for "{searchTerm}"
                            </div>
                    )}
                </div>
            </Card>
        </PageContent>
    );
};
const Backlinks = ({ webhooks }) => {
    // Destructure chart components here, as they are only used in this component.
    const { PieChart, Pie, Cell, ResponsiveContainer, Tooltip, BarChart, Bar, XAxis, YAxis, CartesianGrid } = window.Recharts;

    // --- Additional Icon Components for this page ---
    const PlusCircle = createIcon(
      <>
        <circle cx="12" cy="12" r="10" />
        <line x1="12" y1="8" x2="12" y2="16" />
        <line x1="8" y1="12" x2="16" y2="12" />
      </>
    );
    const MinusCircle = createIcon(
      <>
        <circle cx="12" cy="12" r="10" />
        <line x1="8" y1="12" x2="16" y2="12" />
      </>
    );
    const Search = createIcon(
      <>
        <circle cx="11" cy="11" r="8" />
        <line x1="21" y1="21" x2="16.65" y2="16.65" />
      </>
    );
    const ExternalLink = createIcon(
      <>
        <path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6" />
        <polyline points="15 3 21 3 21 9" />
        <line x1="10" y1="14" x2="21" y2="3" />
      </>
    );
    const LinkIcon = createIcon(
      <>
        <path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71" />
        <path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71" />
      </>
    );
    const ShieldCheck = createIcon(
      <>
        <path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z" />
        <path d="M9 12l2 2 4-4" />
      </>
    );
    const Globe = createIcon(
      <>
        <circle cx="12" cy="12" r="10" />
        <line x1="2" y1="12" x2="22" y2="12" />
        <path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z" />
      </>
    );

    // --- Component State and Data ---
    const [backlinksData, setBacklinksData] = useState(null);
    const [loading, setLoading] = useState(true);
    const [error, setError] = useState(null);
    const [activeTableTab, setActiveTableTab] = useState('');
    const [searchTerm, setSearchTerm] = useState('');
    const [currentMonthIndex, setCurrentMonthIndex] = useState(0);
    
    // Refresh state management
    const [isRefreshing, setIsRefreshing] = useState(false);
    const [refreshProgress, setRefreshProgress] = useState(0);
    const [refreshMessage, setRefreshMessage] = useState('');
    const [lastRefresh, setLastRefresh] = useState(null);
    const pollIntervalRef = useRef(null);
    const refreshStartTimeRef = useRef(null);

    // Cleanup polling on unmount
    useEffect(() => {
        return () => {
            if (pollIntervalRef.current) {
                clearInterval(pollIntervalRef.current);
            }
        };
    }, []);

    // Refresh functionality
    const triggerRefresh = async () => {
        console.log('Backlinks refresh triggered');
        console.log('Webhooks data:', webhooks);
        
        // Use the new n8n webhook URL from Config tab, or fallback to direct URL
        const webhookUrl = webhooks?.Backlinks || 'https://n8n.foreverbooked.com/webhook/90c4abee-7fac-416e-90e2-96d93fb2ae0f';
        
        if (!webhookUrl) {
            alert('Refresh webhook not configured for backlinks');
            console.log('Webhook check failed. Webhooks:', webhooks);
            return;
        }
        
        setIsRefreshing(true);
        setRefreshProgress(5);
        setRefreshMessage('Triggering backlinks automation...');
        refreshStartTimeRef.current = Date.now();

        try {
            // Get the workbook ID from URL parameters
            const params = new URLSearchParams(window.location.search);
            const workbookId = params.get('workbookId');
            
            if (!workbookId) {
                throw new Error('No workbook ID found in URL');
            }

            // Construct the webhook URL with required parameters
            const fullWebhookUrl = `${webhookUrl}?spreadsheetId=${workbookId}&tabName=${encodeURIComponent('Backlinks')}`;
            
            console.log('Triggering backlinks webhook:', fullWebhookUrl);
            
            const response = await fetch(fullWebhookUrl, {
                method: 'GET',
                mode: 'no-cors' // Many webhooks don't support CORS
            });
            
            // Show success message
            console.log('Backlinks webhook triggered successfully!');
            console.log('Webhook response status:', response.status);
            
            setRefreshProgress(15);
            setRefreshMessage('In Progress, Check back in 1.30min...');
            
            // Start polling for data changes
            startPolling();
            
        } catch (error) {
            console.error('Error triggering backlinks refresh:', error);
            setIsRefreshing(false);
            setRefreshProgress(0);
            setRefreshMessage('');
            alert(`Failed to trigger backlinks refresh: ${error.message}`);
        }
    };

    const startPolling = () => {
        let attempts = 0;
        const maxAttempts = 6; // Poll for ~3 minutes (30s intervals) since backlinks now takes ~1.5 minutes
        
        const poll = async () => {
            attempts++;
            const elapsed = (Date.now() - refreshStartTimeRef.current) / 1000;
            const progress = Math.min(15 + (attempts * 12), 95); // Slower progress for longer duration
            
            setRefreshProgress(progress);
            
            let message;
            if (elapsed < 90) { // First 1.5 minutes
                message = `Backlinks automation running... (~1.30min expected)`;
            } else {
                message = `Finalizing AI report and checking for completion...`;
            }
            setRefreshMessage(message);
            
            try {
                // Check if data has been updated by fetching fresh data
                const params = new URLSearchParams(window.location.search);
                const workbookId = params.get('workbookId');
                
                if (workbookId) {
                    const scriptUrl = `https://script.google.com/macros/s/AKfycbxfOMp8d_eCVH4lFD0PNuFU1wH-gyWOwRt2EuME7GQJ4U73ZwpPDciohDH3C566YLWq/exec?workbookId=${workbookId}`;
                    
                    const response = await fetch(scriptUrl);
                    const newData = await response.json();
                    
                    // Check for changes in backlinks data
                    if (newData.backlinksSummary && newData.backlinksTable && hasBacklinksDataChanged(backlinksData, { backlinksSummary: newData.backlinksSummary, backlinksTable: newData.backlinksTable })) {
                        // Data has changed! Stop polling and update in-place
                        clearInterval(pollIntervalRef.current);
                        setRefreshProgress(100);
                        setRefreshMessage('AI report complete! Loading fresh data...');
                        
                        // Update the data in-place
                        const newBacklinksData = {
                            backlinksSummary: newData.backlinksSummary,
                            backlinksTable: newData.backlinksTable,
                            backlinksSummaryArchive: newData.backlinksSummaryArchive || []
                        };
                        
                        // Update cache
                        const cacheKey = `backlinks_${workbookId}`;
                        sessionStorage.setItem(cacheKey, JSON.stringify(newBacklinksData));
                        
                        setBacklinksData(newBacklinksData);
                        setLastRefresh(new Date());
                        
                        // Clear refresh state after a brief success message
                        setTimeout(() => {
                            setIsRefreshing(false);
                            setRefreshProgress(0);
                            setRefreshMessage('');
                        }, 2000);
                        return;
                    }
                }
            } catch (error) {
                console.error('Error polling for backlinks updates:', error);
            }
            
            // Auto-refresh after max attempts
            if (attempts >= maxAttempts) {
                clearInterval(pollIntervalRef.current);
                setRefreshProgress(100);
                setRefreshMessage('Automation complete! Refreshing with latest data...');
                
                try {
                    const params = new URLSearchParams(window.location.search);
                    const workbookId = params.get('workbookId');
                    
                    if (workbookId) {
                        const scriptUrl = `https://script.google.com/macros/s/AKfycbxfOMp8d_eCVH4lFD0PNuFU1wH-gyWOwRt2EuME7GQJ4U73ZwpPDciohDH3C566YLWq/exec?workbookId=${workbookId}`;
                        
                        fetch(scriptUrl)
                            .then(response => response.json())
                            .then(finalData => {
                                if (finalData.backlinksSummary && finalData.backlinksTable) {
                                    const finalBacklinksData = {
                                        backlinksSummary: finalData.backlinksSummary,
                                        backlinksTable: finalData.backlinksTable,
                                        backlinksSummaryArchive: finalData.backlinksSummaryArchive || []
                                    };
                                    
                                    // Update cache
                                    const cacheKey = `backlinks_${workbookId}`;
                                    sessionStorage.setItem(cacheKey, JSON.stringify(finalBacklinksData));
                                    
                                    setBacklinksData(finalBacklinksData);
                                    setLastRefresh(new Date());
                                    console.log('Fallback: Backlinks data refreshed after timeout');
                                    
                                    setTimeout(() => {
                                        setIsRefreshing(false);
                                        setRefreshProgress(0);
                                        setRefreshMessage('');
                                    }, 1500);
                                } else {
                                    setIsRefreshing(false);
                                    setRefreshProgress(0);
                                    setRefreshMessage('');
                                }
                            })
                            .catch(e => {
                                console.log('Fallback failed:', e);
                                setIsRefreshing(false);
                                setRefreshProgress(0);
                                setRefreshMessage('');
                            });
                    } else {
                        setIsRefreshing(false);
                        setRefreshProgress(0);
                        setRefreshMessage('');
                    }
                } catch (error) {
                    console.error('Error in fallback:', error);
                    setIsRefreshing(false);
                    setRefreshProgress(0);
                    setRefreshMessage('');
                }
            }
        };
        
        // Start with immediate poll, then continue with 30-second intervals
        pollIntervalRef.current = setInterval(poll, 30000);
        
        // Poll immediately to start
        poll();
    };

    const hasBacklinksDataChanged = (oldData, newData) => {
        // Primary check: Has the AI report been generated? This indicates completion
        const hasAiReport = newData?.backlinksSummary?.backlinksAiReport && 
                           String(newData.backlinksSummary.backlinksAiReport).trim() !== '';
        
        // Secondary check: Has other key backlinks data changed (as backup)
        const hasDataChanges = (
            oldData?.backlinksSummary?.totalBacklinks !== newData?.backlinksSummary?.totalBacklinks ||
            oldData?.backlinksSummary?.newLinks !== newData?.backlinksSummary?.newLinks ||
            oldData?.backlinksSummary?.lostLinks !== newData?.backlinksSummary?.lostLinks ||
            oldData?.backlinksSummary?.totalDofollow !== newData?.backlinksSummary?.totalDofollow ||
            oldData?.backlinksSummary?.totalNofollow !== newData?.backlinksSummary?.totalNofollow ||
            JSON.stringify(oldData?.backlinksTable) !== JSON.stringify(newData?.backlinksTable)
        );
        
        console.log('Backlinks polling check:', {
            hasAiReport: hasAiReport,
            aiReportContent: newData?.backlinksSummary?.backlinksAiReport?.substring(0, 50) + '...',
            hasDataChanges: hasDataChanges
        });
        
        // Consider complete when AI report is generated (primary indicator)
        return hasAiReport;
    };

    const cancelRefresh = () => {
        if (pollIntervalRef.current) {
            clearInterval(pollIntervalRef.current);
        }
        setIsRefreshing(false);
        setRefreshProgress(0);
        setRefreshMessage('');
    };

    useEffect(() => {
        const params = new URLSearchParams(window.location.search);
        const workbookId = params.get('workbookId');
        if (!workbookId) {
            setError("No workbook ID provided");
            setLoading(false);
            return;
        }

        // Check cache first
        const cacheKey = `backlinks_${workbookId}`;
        const cachedData = sessionStorage.getItem(cacheKey);
        if (cachedData) {
            try {
                const parsed = JSON.parse(cachedData);
                setBacklinksData(parsed);
                setActiveTableTab(Object.keys(parsed.backlinksTable)[0] || '');
                setLoading(false);
                return;
            } catch (e) {
                // Invalid cache, continue with fresh fetch
            }
        }

        const scriptUrl = `https://script.google.com/macros/s/AKfycbxfOMp8d_eCVH4lFD0PNuFU1wH-gyWOwRt2EuME7GQJ4U73ZwpPDciohDH3C566YLWq/exec?workbookId=${workbookId}`;
        
        fetchWithCorsWorkaround(scriptUrl, (err, data) => {
            if (err) {
                setError(err.message);
                setLoading(false);
                return;
            }
            if (data.error) {
                setError(`Script error: ${data.error}`);
                setLoading(false);
                return;
            }
            
            const backlinks = {
                backlinksSummary: data.backlinksSummary,
                backlinksTable: data.backlinksTable,
                backlinksSummaryArchive: data.backlinksSummaryArchive || []
            };
            
            if (backlinks.backlinksSummary && backlinks.backlinksTable) {
                sessionStorage.setItem(cacheKey, JSON.stringify(backlinks));
                setActiveTableTab(Object.keys(backlinks.backlinksTable)[0] || '');
            }
            setBacklinksData(backlinks);
            setLoading(false);
        });
    }, []);

    if (loading) {
        return <PageContent><div className="p-8 text-center text-gray-500">Loading backlinks data...</div></PageContent>;
    }
    if (error) {
        return <PageContent><div className="p-8 text-center text-red-500">Backlinks Error: {error}</div></PageContent>;
    }
    if (!backlinksData || !backlinksData.backlinksSummary || !backlinksData.backlinksTable) {
        return <PageContent><div className="p-8 text-center text-gray-500">No backlinks data available.</div></PageContent>;
    }

    const { backlinksSummary, backlinksTable, backlinksSummaryArchive } = backlinksData;
    const siteNames = Object.keys(backlinksTable);
    
    // Process historical data with date formatting (similar to geogrid)
    const processedArchiveData = backlinksSummaryArchive && backlinksSummaryArchive.length > 0 
        ? backlinksSummaryArchive.map((item, index) => {
            let parsedDate = null;
            
            // Try to use the backend's parsedDate if available
            if (item.parsedDate) {
                parsedDate = new Date(item.parsedDate);
            }
            
            // If parsedDate is invalid or not available, try other approaches
            if (!parsedDate || isNaN(parsedDate.getTime())) {
                if (item.date) {
                    parsedDate = new Date(item.date);
                    
                    // If that fails, try US date format parsing
                    if (isNaN(parsedDate.getTime())) {
                        const dateStr = item.date.toString();
                        const parts = dateStr.split('/');
                        if (parts.length === 3) {
                            const month = parseInt(parts[0]) - 1;
                            const day = parseInt(parts[1]);
                            const year = parseInt(parts[2]);
                            parsedDate = new Date(year, month, day);
                        }
                    }
                }
                
                if ((!parsedDate || isNaN(parsedDate.getTime())) && item.rawDate) {
                    parsedDate = new Date(item.rawDate);
                    
                    if (isNaN(parsedDate.getTime())) {
                        const dateStr = item.rawDate.toString();
                        const parts = dateStr.split('/');
                        if (parts.length === 3) {
                            const month = parseInt(parts[0]) - 1;
                            const day = parseInt(parts[1]);
                            const year = parseInt(parts[2]);
                            parsedDate = new Date(year, month, day);
                        }
                    }
                }
            }
            
            const formattedDate = parsedDate && !isNaN(parsedDate.getTime()) 
                ? parsedDate.toLocaleString('default', { month: 'long', year: 'numeric' })
                : item.date;
            
            return {
                ...item,
                date: formattedDate,
                parsedDate: parsedDate
            };
        }).sort((a, b) => {
            // Sort by parsed date (newest first)
            if (a.parsedDate && b.parsedDate) {
                return b.parsedDate.getTime() - a.parsedDate.getTime();
            }
            return 0;
        })
        : [];
    
    // Determine which summary data to use based on current month selection
    const currentSummaryData = processedArchiveData.length > 0 && currentMonthIndex < processedArchiveData.length
        ? processedArchiveData[currentMonthIndex]
        : backlinksSummary;
    
    const followData = [
        { name: 'Dofollow', value: Number(currentSummaryData.totalDofollow) || 0, color: '#3b82f6' },
        { name: 'Nofollow', value: Number(currentSummaryData.totalNofollow) || 0, color: '#9ca3af' },
    ];
    const filteredBacklinks = (backlinksTable[activeTableTab] || []).filter(row =>
        row.backlinkUrl.toLowerCase().includes(searchTerm.toLowerCase()) ||
        row.title.toLowerCase().includes(searchTerm.toLowerCase())
    );

    // Reusable component for each stat in the summary
    const SummaryStat = ({ label, value, color, icon, valuePrefix = '', subtitle = null }) => (
        <div className="flex items-center justify-between p-3 bg-slate-50 rounded-lg transition-all hover:shadow-md hover:bg-white">
            <div className="flex items-center">
                {icon && <div className="mr-3 text-gray-400">{icon}</div>}
                <div>
                    <span className="text-sm text-gray-600 font-medium">{label}</span>
                    {subtitle && <p className="text-xs text-gray-500 mt-0.5">{subtitle}</p>}
                </div>
            </div>
            <span className={`text-lg font-bold ${color}`}>
                {value > 0 ? valuePrefix : ''}{value}
            </span>
        </div>
    );
    return (
        <PageContent>
            {/* Header Section */}
            <div className="mb-6">
                <div className="flex justify-between items-center">
                    <div>
                        <h1 className="text-3xl font-bold text-gray-800">Backlinks Analysis</h1>
                        <p className="text-gray-600 mt-1">Track your backlink profile and analyze link quality metrics</p>
                    </div>
                    <div className="flex items-center space-x-4">
                        {lastRefresh && (
                            <span className="text-sm text-gray-500">
                                Last updated: {lastRefresh.toLocaleTimeString()}
                            </span>
                        )}
                        
                        {/* Inline Progress Indicator */}
                        {isRefreshing && (
                            <div className="flex items-center space-x-3 bg-white rounded-xl shadow-md px-4 py-2 border border-gray-100">
                                <div className="flex items-center space-x-2">
                                    <div className="w-4 h-4 border-2 border-blue-500 border-t-transparent rounded-full animate-spin"></div>
                                    <span className="text-sm font-medium text-gray-700">{refreshMessage}</span>
                                </div>
                                <div className="w-16 bg-gray-200 rounded-full h-2">
                                    <div 
                                        className="bg-gradient-to-r from-blue-500 to-blue-600 h-2 rounded-full transition-all duration-500 ease-out"
                                        style={{ width: `${refreshProgress}%` }}
                                    ></div>
                                </div>
                                <span className="text-xs font-medium text-blue-600 min-w-[2rem]">{refreshProgress}%</span>
                            </div>
                        )}
                        
                        <button 
                            onClick={isRefreshing ? cancelRefresh : triggerRefresh}
                            disabled={!webhooks && !webhooks?.Backlinks}
                            className={`px-6 py-2 rounded-xl font-medium transition-all duration-200 shadow-lg hover:shadow-xl ${
                                isRefreshing 
                                    ? 'bg-red-500 hover:bg-red-600 text-white' 
                                    : 'bg-gradient-to-r from-blue-500 to-blue-600 hover:from-blue-600 hover:to-blue-700 text-white'
                            } disabled:opacity-50 disabled:cursor-not-allowed`}
                        >
                            {isRefreshing ? 'Cancel' : 'Rescan Backlinks'}
                        </button>
                    </div>
                </div>
            </div>

            <Card className="mb-6 hover:shadow-xl transition-all duration-300 hover:-translate-y-0.5 hover:border-blue-200/60">
                <div className="flex justify-between items-center mb-4">
                    <div className="flex items-center space-x-2">
                        <h2 className="text-xl font-bold text-gray-800">Backlinks Summary</h2>
                        <InfoTooltip text="An overview of your website's backlink profile, showing link types, quality metrics, and recent changes." />
                    </div>
                    
                    {/* Month slider controls */}
                    {processedArchiveData.length > 1 && (
                        <div className="flex items-center space-x-3">
                            <button 
                                onClick={() => {
                                    const newIndex = currentMonthIndex + 1;
                                    if (newIndex < processedArchiveData.length) {
                                        setCurrentMonthIndex(newIndex);
                                    }
                                }} 
                                disabled={currentMonthIndex >= processedArchiveData.length - 1}
                                className="flex items-center justify-center w-8 h-8 rounded-lg bg-blue-100 hover:bg-blue-200 disabled:opacity-50 disabled:cursor-not-allowed text-blue-600 transition-colors"
                                title="Go back to older month"
                            >
                                <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M15 19l-7-7 7-7" />
                                </svg>
                            </button>
                            <div className="text-center">
                                <span className="font-semibold text-gray-700 text-sm">
                                    {currentMonthIndex < processedArchiveData.length 
                                        ? processedArchiveData[currentMonthIndex].date 
                                        : 'Current'}
                                </span>
                                <div className="text-xs text-gray-500">
                                    {processedArchiveData.length - currentMonthIndex} of {processedArchiveData.length}
                                </div>
                                <div className="flex items-center justify-center space-x-1 mt-1">
                                    {processedArchiveData.map((_, index) => {
                                        const visualIndex = processedArchiveData.length - 1 - index;
                                        return (
                                            <div
                                                key={index}
                                                className={`w-2 h-2 rounded-full ${
                                                    index === currentMonthIndex 
                                                        ? 'bg-blue-600' 
                                                        : 'bg-gray-300 hover:bg-gray-400'
                                                } cursor-pointer transition-colors`}
                                                onClick={() => setCurrentMonthIndex(index)}
                                                title={`Go to ${processedArchiveData[index]?.date || 'Unknown month'} (${processedArchiveData.length - index} of ${processedArchiveData.length})`}
                                                style={{ order: visualIndex }}
                                            />
                                        );
                                    })}
                                </div>
                            </div>
                            <button 
                                onClick={() => {
                                    const newIndex = currentMonthIndex - 1;
                                    if (newIndex >= 0) {
                                        setCurrentMonthIndex(newIndex);
                                    }
                                }} 
                                disabled={currentMonthIndex <= 0}
                                className="flex items-center justify-center w-8 h-8 rounded-lg bg-blue-100 hover:bg-blue-200 disabled:opacity-50 disabled:cursor-not-allowed text-blue-600 transition-colors"
                                title="Go forward to newer month"
                            >
                                <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M9 5l7 7-7 7" />
                                </svg>
                            </button>
                        </div>
                    )}
                    
                    {/* Single month display */}
                    {processedArchiveData.length <= 1 && (
                        <span className="font-semibold text-gray-700">
                            {processedArchiveData.length === 1 ? processedArchiveData[0].date : 'Current'}
                        </span>
                    )}
                </div>

                <div className="grid grid-cols-1 lg:grid-cols-3 gap-8">
                    {/* Column 1: Core Metrics */}
                    <div className="space-y-6 flex flex-col">
                        <div className="p-6 rounded-xl text-center flex-grow flex flex-col justify-center border border-gray-200">
                            <p className="text-base text-gray-500">Total Active Backlinks</p>
                            <p className="text-5xl font-bold text-blue-600">{(currentSummaryData.totalBacklinks || 0).toLocaleString()}</p>
                            <p className="text-sm text-gray-500 mt-2">
                                <span className={(Number(currentSummaryData.backlinksChange) || 0) >= 0 ? 'text-green-600' : 'text-red-600'}>
                                    {(Number(currentSummaryData.backlinksChange) || 0) >= 0 ? '+' : ''}{Number(currentSummaryData.backlinksChange) || 0}
                                </span> vs prev month
                            </p>
                        </div>
                        <div className="space-y-4">
                            {/* Referring Domains Card */}
                            <div className="bg-white rounded-xl shadow-sm border border-gray-200 p-4 hover:shadow-md transition-all duration-300 metric-card">
                                <div className="flex items-center justify-between">
                                    <div className="flex items-center space-x-3">
                                        <div className="p-2 bg-purple-100 rounded-lg hover:bg-purple-200 transition-colors">
                                            <Globe className="w-5 h-5 text-purple-600" />
                                        </div>
                                        <div>
                                            <p className="text-sm font-medium text-gray-600">Referring Domains</p>
                                            <p className="text-xs text-gray-500">Unique linking domains</p>
                                        </div>
                                    </div>
                                    <div className="text-right">
                                        <p className="text-xl font-bold text-gray-800">{(currentSummaryData.topReferringDomains || 0).toLocaleString()}</p>
                                        <p className="text-xs text-gray-500">Total unique sources</p>
                                    </div>
                                </div>
                            </div>

                            {/* Avg. Referring Rank Card */}
                            <div className="bg-white rounded-xl shadow-sm border border-gray-200 p-4 hover:shadow-md transition-all duration-300 metric-card">
                                <div className="flex items-center justify-between">
                                    <div className="flex items-center space-x-3">
                                        <div className="p-2 bg-orange-100 rounded-lg hover:bg-orange-200 transition-colors">
                                            <ShieldCheck className="w-5 h-5 text-orange-600" />
                                        </div>
                                        <div>
                                            <p className="text-sm font-medium text-gray-600">Avg. Referring Rank</p>
                                            <p className="text-xs text-gray-500">Domain authority score</p>
                                        </div>
                                    </div>
                                    <div className="text-right">
                                        <p className="text-xl font-bold text-gray-800">{currentSummaryData.avgRefferRank || 0}</p>
                                        <p className="text-xs text-gray-500">
                                            <span className={`${(currentSummaryData.avgRefferRank || 0) >= 50 ? 'text-green-600' : (currentSummaryData.avgRefferRank || 0) >= 30 ? 'text-yellow-600' : 'text-red-600'}`}>
                                                {(currentSummaryData.avgRefferRank || 0) >= 50 ? 'High Authority' : (currentSummaryData.avgRefferRank || 0) >= 30 ? 'Medium Authority' : 'Low Authority'}
                                            </span>
                                        </p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    {/* Column 2: Link Types Distribution */}
                    <div className="bg-white rounded-xl shadow-sm border border-gray-200 p-6 hover:shadow-md transition-all duration-300">
                        <div className="flex items-center justify-between mb-4">
                            <h3 className="text-lg font-semibold text-gray-800">Link Types</h3>
                            <InfoTooltip text="Dofollow links pass SEO authority and help improve search rankings. Nofollow links don't pass authority but can still drive traffic and provide value." />
                        </div>
                        
                        {/* Modern Chart Container */}
                        <div className="bg-gray-50 rounded-lg p-4 mb-4">
                            <ResponsiveContainer width="100%" height={180}>
                                <BarChart data={followData} layout="vertical" margin={{ top: 25, right: 20, left: 0, bottom: 60 }} barCategoryGap={12} barGap={8}>
                                    <defs>
                                        <linearGradient id="dofollowGradient" x1="0" y1="0" x2="1" y2="0">
                                            <stop offset="0%" stopColor="#3b82f6" />
                                            <stop offset="100%" stopColor="#1e40af" />
                                        </linearGradient>
                                        <linearGradient id="nofollowGradient" x1="0" y1="0" x2="1" y2="0">
                                            <stop offset="0%" stopColor="#9ca3af" />
                                            <stop offset="100%" stopColor="#6b7280" />
                                        </linearGradient>
                                    </defs>
                                    <CartesianGrid strokeDasharray="3 3" stroke="#f1f5f9" className="dark:!stroke-transparent" />
                                    <XAxis 
                                        type="number" 
                                        tick={{ fontSize: 12, fill: '#64748b', className: 'dark:!fill-[#94A3B8]' }}
                                        tickFormatter={(value) => value >= 1000 ? `${(value / 1000).toFixed(1)}k` : value.toString()}
                                        domain={[0, 'dataMax']}
                                        ticks={[0, 15, 30, 45, 60, 75]}
                                        interval={0}
                                    />
                                    <YAxis 
                                        dataKey="name" 
                                        type="category" 
                                        tick={{ fontSize: 12, fill: '#64748b', className: 'dark:!fill-[#94A3B8]' }}
                                        width={70}
                                    />
                                    <Tooltip 
                                        contentStyle={{ 
                                            backgroundColor: 'rgba(255, 255, 255, 0.95)', 
                                            border: '1px solid #e2e8f0', 
                                            borderRadius: '12px',
                                            boxShadow: '0 20px 25px -5px rgb(0 0 0 / 0.1)'
                                        }}
                                        itemStyle={{ color: '#374151' }}
                                        labelStyle={{ color: '#374151', fontWeight: 'bold' }}
                                        formatter={(value, name) => [value.toLocaleString(), name]}
                                    />
                                    <Bar dataKey="value" radius={[0, 6, 6, 0]} barSize={28}>
                                        {followData.map((entry, index) => (
                                            <Cell 
                                                key={`cell-${index}`} 
                                                fill={entry.name === 'Dofollow' ? 'url(#dofollowGradient)' : 'url(#nofollowGradient)'} 
                                            />
                                        ))}
                                    </Bar>
                                </BarChart>
                            </ResponsiveContainer>
                        </div>
                        
                        {/* Modern Link Type Summary */}
                        <div className="grid grid-cols-2 gap-3">
                            <div className="flex items-center justify-between p-3 rounded-lg bg-blue-50 transition-all hover:shadow-sm">
                                <div className="flex items-center space-x-3">
                                    <div className="w-3 h-3 rounded-full bg-blue-500"></div>
                                    <span className="text-sm font-medium text-gray-700">Dofollow</span>
                                </div>
                                <span className="text-lg font-bold text-blue-600">{(currentSummaryData.totalDofollow || 0).toLocaleString()}</span>
                            </div>
                            <div className="flex items-center justify-between p-3 rounded-lg bg-gray-50 transition-all hover:shadow-sm">
                                <div className="flex items-center space-x-3">
                                    <div className="w-3 h-3 rounded-full bg-gray-400"></div>
                                    <span className="text-sm font-medium text-gray-700">Nofollow</span>
                                </div>
                                <span className="text-lg font-bold text-gray-600">{(currentSummaryData.totalNofollow || 0).toLocaleString()}</span>
                            </div>
                        </div>
                    </div>

                    {/* Column 3: Link Dynamics */}
                    <div className="bg-white rounded-xl shadow-sm border border-gray-200 p-6 hover:shadow-md transition-all duration-300">
                        <div className="flex items-center justify-between mb-4">
                            <h3 className="text-lg font-semibold text-gray-800">Link Dynamics</h3>
                            <InfoTooltip text="New Links: Recently acquired backlinks. Lost Links: Previously detected links that are no longer active. Spam Score: Average percentage indicating potential low-quality or spammy linking domains." />
                        </div>
                        <div className="space-y-3">
                            {(() => {
                                const dynamics = [
                                    { 
                                        label: "New Links", 
                                        value: currentSummaryData.newLinks || 0, 
                                        color: 'text-green-600',
                                        bgColor: 'bg-green-50',
                                        icon: <PlusCircle className="w-5 h-5" />,
                                        valuePrefix: "+",
                                        subtitle: "Gained this period"
                                    },
                                    { 
                                        label: "Lost Links", 
                                        value: currentSummaryData.lostLinks || 0, 
                                        color: 'text-red-600',
                                        bgColor: 'bg-red-50',
                                        icon: <MinusCircle className="w-5 h-5" />,
                                        valuePrefix: "",
                                        subtitle: "Lost this period"
                                    },
                                    { 
                                        label: "Spam Score", 
                                        value: `${(Number(currentSummaryData.avgSpamScore) || 0).toFixed(1)}%`, 
                                        color: (Number(currentSummaryData.avgSpamScore) || 0) <= 30 ? 'text-green-600' : (Number(currentSummaryData.avgSpamScore) || 0) <= 60 ? 'text-yellow-600' : 'text-red-600',
                                        bgColor: (Number(currentSummaryData.avgSpamScore) || 0) <= 30 ? 'bg-green-50' : (Number(currentSummaryData.avgSpamScore) || 0) <= 60 ? 'bg-yellow-50' : 'bg-red-50',
                                        icon: <ShieldCheck className="w-5 h-5" />,
                                        valuePrefix: "",
                                        subtitle: `${(Number(currentSummaryData.spamScoreChange) || 0) <= 0 ? '↓' : '↑'} ${Math.abs(Number(currentSummaryData.spamScoreChange) || 0).toFixed(1)}% vs prev month`
                                    }
                                ];
                                
                                return dynamics.map((dynamic, index) => (
                                    <div key={index} className={`${dynamic.bgColor} rounded-lg p-4 transition-all hover:shadow-sm`}>
                                        <div className="flex items-center justify-between mb-2">
                                            <div className="flex items-center space-x-3">
                                                <div className={`${dynamic.color}`}>{dynamic.icon}</div>
                                                <span className="text-sm font-medium text-gray-700">{dynamic.label}</span>
                                            </div>
                                            <span className={`text-lg font-bold ${dynamic.color}`}>
                                                {dynamic.value > 0 ? dynamic.valuePrefix : ''}{dynamic.value}
                                            </span>
                                        </div>
                                        {dynamic.subtitle && (
                                            <p className="text-xs text-gray-500 ml-8">{dynamic.subtitle}</p>
                                        )}
                                    </div>
                                ));
                            })()}
                        </div>
                    </div>
                </div>
            </Card>

            {/* Backlinks Report Section */}
            <div className="mb-8">
                {(() => {
                    console.log('Backlinks Report Debug:', {
                        backlinksSummary: backlinksSummary,
                        backlinksAiReport: backlinksSummary?.backlinksAiReport,
                        reportLength: backlinksSummary?.backlinksAiReport?.length || 0
                    });
                    return null;
                })()}
                <BacklinksReport 
                    reportText={backlinksSummary?.backlinksAiReport || 'Backlinks targeting report will appear here once generated.'}
                />
            </div>

            <Card className="hover:shadow-xl transition-all duration-300 hover:-translate-y-0.5 hover:border-blue-200/60">
                <div className="flex justify-between items-center mb-4">
                    <div className="flex items-center space-x-2">
                        <h2 className="text-xl font-bold text-gray-800">Backlinks</h2>
                        <InfoTooltip text="Analyze backlinks for your site and competitors. Use the tabs to switch between different sites." />
                    </div>
                    </div>
                    
                <div className="mb-4">
                    <div className="relative">
                        <Search className="absolute left-3 top-1/2 -translate-y-1/2 w-5 h-5 text-gray-400" />
                        <input
                            type="text"
                            placeholder="Search by URL or title..."
                            value={searchTerm}
                            onChange={(e) => setSearchTerm(e.target.value)}
                            className="w-full pl-10 pr-4 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500"
                        />
                    </div>
                </div>

                <div className="flex space-x-1 mb-4 overflow-x-auto">
                    {siteNames.map(site => (
                        <button
                            key={site}
                            onClick={() => setActiveTableTab(site)}
                            className={`px-4 py-2 text-sm font-medium rounded-lg whitespace-nowrap transition-colors duration-200
                                ${activeTableTab === site
                                    ? 'bg-blue-100 text-blue-800'
                                    : 'text-gray-600 hover:bg-gray-100'}`}
                        >
                            {site}
                        </button>
                    ))}
                </div>

                {/* Website Summary Bar */}
                {activeTableTab && (
                    <div className="mb-3 py-1.5 px-3 bg-gradient-to-r from-blue-50 to-indigo-50 rounded-lg border border-blue-200">
                        <div className="flex items-center justify-start space-x-10">
                            {(() => {
                                const siteData = backlinksTable[activeTableTab] || [];
                                const totalBacklinks = siteData.length;
                                const newBacklinks = siteData.filter(link => link.isNew).length;
                                const dofollowCount = siteData.filter(link => link.following).length;
                                const nofollowCount = siteData.filter(link => !link.following).length;
                                const avgSpamScore = siteData.length > 0 
                                    ? (siteData.reduce((sum, link) => sum + (link.spamScore || 0), 0) / siteData.length).toFixed(1)
                                    : 0;
                                const avgRank = siteData.length > 0 
                                    ? (siteData.reduce((sum, link) => sum + (link.rank || 0), 0) / siteData.length).toFixed(0)
                                    : 0;

                                return (
                                    <>
                                        <div className="flex-1 text-center border-r border-gray-200 pr-5">
                                            <div className="text-base font-bold text-blue-600">{totalBacklinks}</div>
                                            <div className="text-xs text-gray-600">Total Backlinks</div>
                                        </div>
                                        <div className="flex-1 text-center border-r border-gray-200 pr-5">
                                            <div className="text-base font-bold text-green-600">{newBacklinks}</div>
                                            <div className="text-xs text-gray-600">New Links</div>
                                        </div>
                                        <div className="flex-1 text-center border-r border-gray-200 pr-5">
                                            <div className={`text-base font-bold ${avgSpamScore <= 30 ? 'text-green-600' : avgSpamScore <= 60 ? 'text-yellow-600' : 'text-red-600'}`}>
                                                {avgSpamScore}%
                                            </div>
                                            <div className="text-xs text-gray-600">Avg Spam Score</div>
                                        </div>
                                        <div className="flex-1 text-center border-r border-gray-200 pr-5">
                                            <div className="text-base font-bold text-gray-700">{avgRank}</div>
                                            <div className="text-xs text-gray-600">Avg Rank</div>
                                        </div>
                                        <div className="flex-1 text-center border-r border-gray-200 pr-5">
                                            <div className="flex justify-center items-center space-x-3">
                                                <div className="text-center">
                                                    <div className="text-sm font-bold text-blue-600">{dofollowCount}</div>
                                                    <div className="text-xs text-gray-600">Dofollow</div>
                                                </div>
                                                <div className="text-gray-400 text-sm">|</div>
                                                <div className="text-center">
                                                    <div className="text-sm font-bold text-gray-600">{nofollowCount}</div>
                                                    <div className="text-xs text-gray-600">Nofollow</div>
                                                </div>
                                            </div>
                                        </div>
                                    </>
                                );
                            })()}
                        </div>
                    </div>
                )}

                <div className="mt-4 overflow-x-auto">
                    <table className="w-full text-left text-sm whitespace-nowrap">
                        <thead>
                            <tr className="border-b-2 border-t border-gray-200 bg-gray-50">
                                <th className="py-2 px-3">Backlink URL</th>
                                <th className="py-2 px-3 text-center">Status</th>
                                <th className="py-2 px-3 text-center">Spam Score</th>
                                <th className="py-2 px-3 text-center">Rank</th>
                                <th className="py-2 px-3 text-center">Type</th>
                                <th className="py-2 px-3">Title</th>
                                <th className="py-2 px-3 text-center">Link</th>
                            </tr>
                        </thead>
                        <tbody>
                            {filteredBacklinks.map((row, index) => (
                                <tr key={index} className="border-b border-gray-100 hover:bg-slate-50">
                                    <td className="py-3 px-3 font-medium text-blue-600 hover:text-blue-800">
                                        <a href={row.backlinkUrl} target="_blank" rel="noopener noreferrer" className="hover:underline">
                                            {row.backlinkUrl}
                                        </a>
                                    </td>
                                    <td className="py-3 px-3 text-center">
                                        {row.isNew ? (
                                            <span className="text-xs font-semibold px-2 py-1 bg-blue-100 text-blue-800 rounded-full">New</span>
                                        ) : row.isLost ? (
                                            <span className="text-xs font-semibold px-2 py-1 bg-red-100 text-red-800 rounded-full">Lost</span>
                                        ) : (
                                            <span className="text-gray-400">-</span>
                                        )}
                                    </td>
                                    <td className="py-3 px-3 text-center">
                                        <span className={`px-2 py-1 rounded-full text-xs font-semibold
                                            ${row.spamScore <= 30 ? 'bg-green-100 text-green-800' :
                                            row.spamScore <= 60 ? 'bg-yellow-100 text-yellow-800' :
                                            'bg-red-100 text-red-800'}`}>
                                            {row.spamScore}%
                                        </span>
                                    </td>
                                    <td className="py-3 px-3 text-center">{row.rank}</td>
                                    <td className="py-3 px-3 text-center">
                                        <span className={`px-2 py-1 rounded-full text-xs font-semibold
                                            ${row.following ? 'bg-blue-100 text-blue-800' : 'bg-gray-100 text-gray-800'}`}>
                                            {row.following ? 'Dofollow' : 'Nofollow'}
                                        </span>
                                    </td>
                                    <td className="py-3 px-3 text-gray-600 max-w-xs truncate" title={row.title}>
                                        {row.title || '-'}
                                    </td>
                                    <td className="py-3 px-3 text-center">
                                        <a href={row.linkUrl} target="_blank" rel="noopener noreferrer" className="text-blue-600 hover:text-blue-800 inline-block">
                                            <ExternalLink className="w-4 h-4" />
                                        </a>
                                    </td>
                                </tr>
                            ))}
                        </tbody>
                    </table>
                    {filteredBacklinks.length === 0 && (
                        <div className="text-center py-8 text-gray-500">
                            No matching backlinks found for "{searchTerm}"
                        </div>
                    )}
                </div>
            </Card>
        </PageContent>
    );
};
const HelpLibrary = () => {
    const [searchQuery, setSearchQuery] = useState('');
    const [selectedGuide, setSelectedGuide] = useState(null);

    // Check URL parameters for guide routing
    useEffect(() => {
        const urlParams = new URLSearchParams(window.location.search);
        const guide = urlParams.get('guide');
        if (guide) {
            setSelectedGuide(guide);
        } else {
            setSelectedGuide(null);
        }
    }, []);

    // Listen for help library reset events
    useEffect(() => {
        const handleReset = () => {
            setSelectedGuide(null);
            setSearchQuery('');
        };
        
        const handleGuideNavigation = (event) => {
            setSelectedGuide(event.detail.guideId);
        };
        
        window.addEventListener('help-library-reset', handleReset);
        window.addEventListener('guide-navigation', handleGuideNavigation);
        return () => {
            window.removeEventListener('help-library-reset', handleReset);
            window.removeEventListener('guide-navigation', handleGuideNavigation);
        };
    }, []);

    // Update URL when guide is selected
    const openGuide = (guideId) => {
        setSelectedGuide(guideId);
        const urlParams = new URLSearchParams(window.location.search);
        urlParams.set('guide', guideId);
        window.history.replaceState({}, '', `${window.location.pathname}?${urlParams.toString()}`);
    };

    // Close guide and return to help library
    const closeGuide = () => {
        setSelectedGuide(null);
        const urlParams = new URLSearchParams(window.location.search);
        urlParams.delete('guide');
        window.history.replaceState({}, '', `${window.location.pathname}?${urlParams.toString()}`);
    };

    // Help Library Icons
    const BookOpen = createIcon(<path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z" />);
    const BarChart3 = createIcon(
        <>
            <path d="M3 3v18h18" />
            <path d="M18.7 8l-5.1 5.2-2.8-2.7L7 14.3" />
        </>
    );
    const Search = createIcon(
        <>
            <circle cx="11" cy="11" r="8" />
            <path d="m21 21-4.35-4.35" />
        </>
    );
    const ArrowLeft = createIcon(<path d="M19 12H6m6-7-7 7 7 7" />);
    const ChevronRight = createIcon(<polyline points="9 18 15 12 9 6" />);
    const TrendingUp = createIcon(<polyline points="23 6 13.5 15.5 8.5 10.5 1 18" />);
    const MapPin = createIcon(
        <>
            <path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z" />
            <circle cx="12" cy="10" r="3" />
        </>
    );

    // Guide categories and cards
    const guideCategories = [
        {
            title: "Getting Started",
            description: "Essential guides to get you up and running quickly",
            icon: <BookOpen className="w-8 h-8" />,
            guides: [
                {
                    id: "getting-started",
                    title: "Getting Started",
                    description: "Learn the basics of navigating and using your Competitor Analysis Tool effectively",
                    icon: <BookOpen className="w-6 h-6" />,
                    category: "Essentials"
                }
            ]
        },
        {
            title: "App Sections",
            description: "Comprehensive guides for each tab in your competitor analysis tool",
            icon: <BarChart3 className="w-8 h-8" />,
            guides: [
                {
                    id: "dashboard",
                    title: "Dashboard",
                    description: "Understand all the metrics, charts, and insights on your main dashboard",
                    icon: <BarChart3 className="w-6 h-6" />,
                    category: "Dashboard"
                },
                {
                    id: "website-stats",
                    title: "Website Stats",
                    description: "Complete breakdown of website health, performance metrics, and technical SEO analysis",
                    icon: <TrendingUp className="w-6 h-6" />,
                    category: "Technical"
                },
                {
                    id: "keywords",
                    title: "Keywords",
                    description: "Master keyword tracking, ranking analysis, and competitive keyword research",
                    icon: <Search className="w-6 h-6" />,
                    category: "Keywords"
                },
                {
                    id: "backlinks",
                    title: "Backlinks",
                    description: "Master backlink analysis, link building strategies, and competitive link intelligence",
                    icon: <Link2 className="w-6 h-6" />,
                    category: "Backlinks"
                },
                {
                    id: "geogrid-maps",
                    title: "Geogrid Maps",
                    description: "Master local search visibility, geographic ranking analysis, and location-based SEO strategy",
                    icon: <MapPin className="w-6 h-6" />,
                    category: "Local SEO"
                }
            ]
        }
    ];

    // Filter guides based on search query
    const filteredGuides = searchQuery.trim() === '' 
        ? guideCategories
        : guideCategories.map(category => ({
            ...category,
            guides: category.guides.filter(guide => 
                guide.title.toLowerCase().includes(searchQuery.toLowerCase()) ||
                guide.description.toLowerCase().includes(searchQuery.toLowerCase())
            )
        })).filter(category => category.guides.length > 0);

    // If a guide is selected, show the guide content
    if (selectedGuide) {
        return <GuideContent guideId={selectedGuide} onBack={closeGuide} />;
    }

    return (
        <PageContent>
            <div className="max-w-6xl mx-auto">
                {/* Header */}
                <div className="text-center mb-8">
                    <h1 className="text-3xl font-bold mb-4" style={{ color: 'var(--text-primary)' }}>
                        Help Library
                    </h1>
                    <p className="text-lg" style={{ color: 'var(--text-secondary)' }}>
                        Find guides, tutorials, and answers to help you make the most of your SEO dashboard
                    </p>
                </div>

                {/* Search Bar */}
                <div className="relative mb-8 max-w-2xl mx-auto">
                    <div className="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                        <Search className="w-5 h-5" style={{ color: 'var(--text-secondary)' }} />
                    </div>
                    <input
                        type="text"
                        placeholder="Search for anything"
                        value={searchQuery}
                        onChange={(e) => setSearchQuery(e.target.value)}
                        className="block w-full pl-10 pr-3 py-3 border border-gray-300 rounded-xl leading-5 text-gray-900 placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all duration-200"
                        style={{
                            backgroundColor: 'var(--card-bg)',
                            color: 'var(--text-primary)',
                            borderColor: 'var(--card-border)'
                        }}
                    />
                </div>

                {/* Guide Categories */}
                <div className="space-y-8">
                    {filteredGuides.map((category, categoryIndex) => (
                        <div key={categoryIndex}>
                            {/* Category Header */}
                            <div className="flex items-center mb-6">
                                <div className="flex items-center space-x-3">
                                    <div 
                                        className="p-2 rounded-lg bg-gradient-to-r from-blue-500 to-blue-600 text-white"
                                    >
                                        {category.icon}
                                    </div>
                                    <div>
                                        <h2 className="text-xl font-bold" style={{ color: 'var(--text-primary)' }}>
                                            {category.title}
                                        </h2>
                                        <p className="text-sm" style={{ color: 'var(--text-secondary)' }}>
                                            {category.description}
                                        </p>
                                    </div>
                                </div>
                            </div>

                            {/* Guide Cards */}
                            <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                                {category.guides.map((guide) => (
                                    <div
                                        key={guide.id}
                                        onClick={() => openGuide(guide.id)}
                                        className="group cursor-pointer rounded-xl p-6 border transition-all duration-300 hover:shadow-xl hover:-translate-y-1 hover:border-blue-200"
                                        style={{
                                            backgroundColor: 'var(--card-bg)',
                                            borderColor: 'var(--card-border)',
                                            boxShadow: 'var(--card-shadow)'
                                        }}
                                    >
                                        <div className="flex items-start space-x-4">
                                            <div className="flex-shrink-0">
                                                <div 
                                                    className="p-3 rounded-lg bg-gradient-to-r from-blue-100 to-blue-200 text-blue-600 group-hover:from-blue-500 group-hover:to-blue-600 group-hover:text-white transition-all duration-300"
                                                >
                                                    {guide.icon}
                                                </div>
                                            </div>
                                            <div className="flex-1 min-w-0">
                                                <div className="flex items-center justify-between mb-2">
                                                    <h3 className="text-lg font-semibold group-hover:text-blue-600 transition-colors duration-200" style={{ color: 'var(--text-primary)' }}>
                                                        {guide.title}
                                                    </h3>
                                                    <span className="text-xs px-2 py-1 rounded-full bg-gray-100 text-gray-600" style={{ backgroundColor: 'var(--bg-secondary)', color: 'var(--text-secondary)' }}>
                                                        {guide.category}
                                                    </span>
                                                </div>
                                                <p className="text-sm leading-relaxed" style={{ color: 'var(--text-secondary)' }}>
                                                    {guide.description}
                                                </p>
                                                <div className="mt-4 flex items-center text-sm font-medium text-blue-600 group-hover:text-blue-700">
                                                    <span>Read guide</span>
                                                    <ChevronRight className="w-4 h-4 ml-1 group-hover:translate-x-1 transition-transform duration-200" />
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                ))}
                            </div>
                        </div>
                    ))}
                </div>

                {/* No Results */}
                {filteredGuides.length === 0 && searchQuery.trim() !== '' && (
                    <div className="text-center py-12">
                        <div className="w-16 h-16 mx-auto mb-4 rounded-full bg-gray-100 flex items-center justify-center" style={{ backgroundColor: 'var(--bg-secondary)' }}>
                            <Search className="w-8 h-8" style={{ color: 'var(--text-secondary)' }} />
                        </div>
                        <h3 className="text-lg font-medium mb-2" style={{ color: 'var(--text-primary)' }}>
                            No guides found
                        </h3>
                        <p style={{ color: 'var(--text-secondary)' }}>
                            Try searching with different keywords or browse our categories above.
                        </p>
                    </div>
                )}
            </div>
        </PageContent>
    );
};

const GuideContent = ({ guideId, onBack }) => {
    const ArrowLeft = createIcon(<path d="M19 12H6m6-7-7 7 7 7" />);
    const ArrowRight = createIcon(<path d="M5 12h14m-7-7 7 7-7 7" />);
    
    // Define guide progression order
    const guideProgression = ['dashboard', 'website-stats', 'keywords', 'backlinks', 'geogrid-maps'];
    const currentIndex = guideProgression.indexOf(guideId);
    const nextGuideId = currentIndex >= 0 && currentIndex < guideProgression.length - 1 
        ? guideProgression[currentIndex + 1] 
        : null;
    const prevGuideId = currentIndex > 0 
        ? guideProgression[currentIndex - 1] 
        : null;
    
    // Get guide info
    const getGuideInfo = (id) => {
        const guideInfo = {
            'dashboard': { title: 'Dashboard', category: 'Dashboard' },
            'website-stats': { title: 'Website Stats', category: 'Technical' },
            'keywords': { title: 'Keywords', category: 'Keywords' },
            'backlinks': { title: 'Backlinks', category: 'Backlinks' },
            'geogrid-maps': { title: 'Geogrid Maps', category: 'Local SEO' }
        };
        return guideInfo[id] || null;
    };
    
    const nextGuideInfo = nextGuideId ? getGuideInfo(nextGuideId) : null;
    const prevGuideInfo = prevGuideId ? getGuideInfo(prevGuideId) : null;
    
    // Navigate to next guide
    const goToNextGuide = () => {
        if (nextGuideId) {
            const urlParams = new URLSearchParams(window.location.search);
            urlParams.set('guide', nextGuideId);
            window.history.replaceState({}, '', `${window.location.pathname}?${urlParams.toString()}`);
            // Use event-based navigation for instant loading
            setTimeout(() => {
                window.dispatchEvent(new CustomEvent('guide-navigation', { detail: { guideId: nextGuideId } }));
            }, 10);
        }
    };
    
    // Navigate to previous guide
    const goToPrevGuide = () => {
        if (prevGuideId) {
            const urlParams = new URLSearchParams(window.location.search);
            urlParams.set('guide', prevGuideId);
            window.history.replaceState({}, '', `${window.location.pathname}?${urlParams.toString()}`);
            // Use event-based navigation for instant loading
            setTimeout(() => {
                window.dispatchEvent(new CustomEvent('guide-navigation', { detail: { guideId: prevGuideId } }));
            }, 10);
        }
    };
    
    // Guide content data
    const guideData = {
        'getting-started': {
            title: "Getting Started with Your Competitor Analysis Tool",
            category: "Essentials",
            readTime: "5 min read",
            content: {
                sections: [
                    {
                        title: "Welcome to Your Competitor Analysis Tool",
                        content: `Your Competitor Analysis Tool is a comprehensive platform designed to help you monitor, analyze, and improve your medical spa's online presence against your competitors. This guide will walk you through the essential features and help you get started.`
                    },
                    {
                        title: "Getting Started Video Tutorial",
                        content: `Watch this comprehensive walkthrough to get familiar with your dashboard and its key features:`,
                        video: "https://www.loom.com/share/YOUR_LOOM_VIDEO_ID"
                    },
                    {
                        title: "How It Works",
                        content: `The platform helps you view your statistics and performance versus your competitors, make small improvements following the reports, then monitor your performance month-to-month to see how you're progressing. Key features include:`,
                        list: [
                            "**Competitive Analysis** - Compare your performance against local competitors",
                            "**Monthly Monitoring** - Track your progress over time with detailed reports",
                            "**AI-powered Insights** - Get intelligent recommendations for improvement",
                            "**Implementation Support** - Choose to implement changes yourself or upgrade to Forever Booked's paid SEO package",
                            "**Detailed Tooltips** - Hover over any 'i' icon on cards for more information about that metric"
                        ]
                    },
                    {
                        title: "Dashboard Overview",
                        content: `The main dashboard provides a bird's-eye view of your competitive performance with key sections including:`,
                        list: [
                            "**'Medspa Near Me' Geogrid Map** - Your ranking vs competitors for this key search term",
                            "**Census Data** - Population, ethnicity, languages, and income data for your area",
                            "**Google Business Profile Report** - Detailed analysis with improvement recommendations", 
                            "**Competitor Overview** - Direct comparison with up to 4 local competitors",
                            "**Service Performance** - Search volume data for popular and emerging services",
                            "**AI Sentiment Analysis** - How AI platforms perceive your business vs competitors"
                        ]
                    },
                    {
                        title: "Navigation",
                        content: `Use the top navigation to access different sections:`,
                        list: [
                            "**Dashboard** - Overview of all your key metrics",
                            "**Website Stats** - Technical SEO analysis and website health",
                            "**Keywords** - Keyword rankings and performance tracking",
                            "**Backlinks** - Backlink profile and link building insights",
                            "**Geogrid Maps** - Local search visibility mapping",
                            "**Tools** - Additional SEO tools and utilities"
                        ]
                    },
                    {
                        title: "Key Metrics to Monitor",
                        content: `Focus on these important metrics for your medical spa:`,
                        list: [
                            "**Google Business Profile Score** - Your local presence strength",
                            "**Website Health Score** - Technical SEO performance",
                            "**Keyword Rankings** - How you rank for important search terms",
                            "**Competitor Analysis** - How you compare to local competitors",
                            "**AI Sentiment** - How AI platforms perceive your business"
                        ]
                    },
                    {
                        title: "Implementation Options",
                        content: `Each report includes two implementation options to help you act on the insights:`,
                        list: [
                            "**'Implement Recommendations Myself'** - Copy a detailed prompt to paste into your favorite AI chat model (ChatGPT, Claude, etc.) for step-by-step implementation guidance",
                            "**'Request Forever Booked Implement'** - Upgrade to the paid SEO package and have Forever Booked's experts implement the changes for you with 50% off your first month"
                        ]
                    },
                    {
                        title: "Getting the Most Value",
                        content: `To maximize the value of your analysis tool:`,
                        list: [
                            "**Monitor Monthly** - Check your performance against competitors regularly to track progress",
                            "**Use Tooltips** - Hover over 'i' icons on any card for detailed explanations of metrics",
                            "**Act on Insights** - Use the AI-generated recommendations to make targeted improvements",
                            "**Track Competitors** - Monitor what your competitors are doing to identify new opportunities",
                            "**Leverage Census Data** - Use demographic insights to optimize your marketing campaigns and targeting"
                        ]
                    }
                ]
            }
        },
        'dashboard': {
            title: "Dashboard Overview",
            category: "Dashboard",
            readTime: "8 min read",
            content: {
                sections: [
                    {
                        title: "Dashboard Components",
                        content: `Your dashboard is organized into several key sections, each providing valuable insights into different aspects of your competitive performance and local market analysis.`
                    },
                    {
                        title: "'Medspa Near Me' Geogrid Map",
                        content: `This section shows your ranking performance versus competitors for the critical keyword 'Medspa Near Me':`,
                        list: [
                            "**Geogrid visualization** - Map showing your search visibility across different locations",
                            "**Average Geogrid Score** - Your overall performance score compared to competitors in your area", 
                            "**Competitor comparison** - See how you rank against up to 4 local competitors",
                            "**Geographic insights** - Understand which areas you're performing well in and which need improvement"
                        ]
                    },
                    {
                        title: "Census Data Section",
                        content: `Essential demographic information about your town and city to inform your marketing strategy:`,
                        list: [
                            "**Population** - Helpful when setting radius for advertising campaigns",
                            "**Ethnicity Distribution** - Useful for choosing which creative assets and imagery to use in campaigns",
                            "**Languages Spoken** - Helps decide whether to run multi-language campaigns",
                            "**Median Income** - Critical for determining whether to launch low, mid, or high-ticket service campaigns"
                        ]
                    },
                    {
                        title: "Google Business Profile Report",
                        content: `Comprehensive analysis of your Google Business Profile with actionable recommendations:`,
                        list: [
                            "**Detailed GBP analysis** - In-depth review of your profile completeness and optimization",
                            "**Improvement recommendations** - Specific areas where you can enhance your profile",
                            "**'Show More' option** - Click to view the complete detailed report",
                            "**Implementation options** - Choose to implement recommendations yourself or request Forever Booked's help",
                            "**50% discount offer** - Special pricing for upgrading to the paid SEO package"
                        ]
                    },
                    {
                        title: "GBP Insights Section",
                        content: `The Google Business Profile section shows:`,
                        list: [
                            "**Profile completeness score** - How well your GBP is optimized",
                            "**Review metrics** - Star rating, review count, and recent reviews",
                            "**Photo performance** - Number of photos and engagement",
                            "**Q&A activity** - Customer questions and your responses",
                            "**AI-generated SWOT analysis** - Strengths, weaknesses, opportunities, and threats"
                        ]
                    },
                    {
                        title: "Competitor Overview",
                        content: `The competitor section displays:`,
                        list: [
                            "**Competitor rankings** - How you stack up against local competitors",
                            "**Website performance** - Site speed, backlinks, and traffic estimates",
                            "**Social media presence** - Links to competitor social profiles",
                            "**Advertising activity** - Google Ads and Facebook Ads detection",
                            "**Review comparison** - How your reviews compare to competitors"
                        ]
                    },
                    {
                        title: "Service Performance Cards",
                        content: `Two key service sections show:`,
                        list: [
                            "**Top Services by Search Volume** - Most popular established services",
                            "**New Services by Search Volume** - Emerging opportunities",
                            "**Search volume data** - Monthly search estimates for each service",
                            "**Trend indicators** - Whether services are growing or declining"
                        ]
                    },
                    {
                        title: "AI Visibility vs Sentiment Chart",
                        content: `This advanced chart shows how different AI platforms (ChatGPT, Gemini, Perplexity) perceive your business:`,
                        list: [
                            "**X-axis (Visibility)** - How often your business appears in AI responses",
                            "**Y-axis (Sentiment)** - How positively AI platforms describe your business",
                            "**Bubble size** - Represents share of voice/frequency of mentions",
                            "**Bubble opacity** - Indicates confidence level of the data",
                            "**Color coding** - Blue for your business, other colors for competitors"
                        ]
                    },
                    {
                        title: "AI Perception Bar Chart",
                        content: `Shows comparative AI sentiment scores across platforms:`,
                        list: [
                            "**Platform comparison** - ChatGPT vs Gemini vs Perplexity scores",
                            "**Competitor benchmarking** - How your AI presence compares to competitors",
                            "**Average scores** - Overall AI perception rating",
                            "**Data availability indicators** - Which platforms have data for each business"
                        ]
                    },
                    {
                        title: "Implementation & Support Options",
                        content: `Every report includes actionable recommendations with flexible implementation options:`,
                        list: [
                            "**DIY Implementation** - Use the 'Implement Recommendations Myself' button to copy detailed prompts for your favorite AI assistant",
                            "**Professional Implementation** - Click 'Request Forever Booked Implement' to upgrade to the paid SEO package with expert implementation",
                            "**Special Offer** - Get 50% off your first month when upgrading to professional implementation",
                            "**Community Support** - Access the exclusive [Forever Booked Skool community](https://www.skool.com/forever-booked/classroom/a23620ff?md=00953c20f4574ccdb6d5edfe0a0298ed) for additional guidance and networking"
                        ]
                    },
                    {
                        title: "Using Dashboard Data for Strategy",
                        content: `Leverage your competitive analysis insights to:`,
                        list: [
                            "**Target High-Value Services** - Focus on services with high search volume in your area",
                            "**Optimize Demographics** - Use census data to tailor your marketing campaigns and ad targeting",
                            "**Monitor Competitive Gaps** - Identify opportunities where competitors are weak",
                            "**Track Monthly Progress** - Compare your performance month-over-month against the same competitors",
                            "**Improve Local Presence** - Use Geogrid data to strengthen your 'Medspa Near Me' rankings"
                        ]
                    }
                ]
            }
        },
        'website-stats': {
            title: "Website Stats Complete Guide",
            category: "Technical",
            readTime: "12 min read",
            content: {
                sections: [
                    {
                        title: "Website Stats Overview",
                        content: `The Website Stats section provides a comprehensive technical analysis of your website's performance, health, and SEO optimization. This is where you can monitor your site's technical foundation and identify areas for improvement to enhance your search engine visibility.`
                    },
                    {
                        title: "Overall Page Score Gauge",
                        content: `The centerpiece of your Website Stats is the large circular gauge showing your overall website health score:`,
                        list: [
                            "**Score Range** - Rated from 0-100, with higher scores indicating better website health",
                            "**Color Coding** - Green (excellent), yellow (good), red (needs improvement)",
                            "**Real-time Updates** - Refreshes when you run website scans to show current performance",
                            "**Composite Metric** - Combines multiple technical factors into one easy-to-understand score"
                        ]
                    },
                    {
                        title: "Key Health Metrics Cards",
                        content: `Three essential metrics displayed prominently below the main gauge:`,
                        list: [
                            "**Site Speed** - How fast your website loads (measured in seconds). Target: under 3 seconds for good performance",
                            "**SSL Certificate** - Shows whether your site has proper HTTPS encryption (essential for Google rankings)",
                            "**Checks Passed** - Percentage of technical SEO checks your website passes (higher is better)"
                        ]
                    },
                    {
                        title: "Speed Performance Details",
                        content: `Detailed breakdown of various loading metrics to help identify specific performance bottlenecks:`,
                        list: [
                            "**Time to Interactive** - How long before users can interact with your page",
                            "**DOM Complete** - Time for the page structure to fully load",
                            "**Largest Contentful Paint** - When the main content becomes visible",
                            "**First Input Delay** - Responsiveness to user interactions",
                            "**Connection & Download Times** - Network performance metrics",
                            "**TTFB (Time to First Byte)** - Server response speed"
                        ]
                    },
                    {
                        title: "Technical SEO Checks",
                        content: `Comprehensive analysis of technical SEO elements organized by category:`,
                        list: [
                            "**HTTPS & Security** - SSL certificates, secure connections, and security protocols",
                            "**HTML Structure** - Proper DOCTYPE, meta tags, heading structure (H1, H2, etc.)",
                            "**Content Optimization** - Content length, readability, keyword optimization",
                            "**Performance** - Page size, loading times, render-blocking resources",
                            "**Accessibility** - Image alt tags, proper markup for screen readers",
                            "**SEO Fundamentals** - Meta descriptions, title tags, canonical URLs"
                        ]
                    },
                    {
                        title: "Issues to Review Section",
                        content: `Two categories of issues that need attention:`,
                        list: [
                            "**Errors (Red)** - Critical issues that can significantly impact SEO and user experience",
                            "**Warnings (Yellow)** - Important improvements that should be addressed for optimal performance",
                            "**Detailed Descriptions** - Each issue includes specific information about what needs to be fixed",
                            "**Priority Guidance** - Focus on errors first, then address warnings for maximum impact"
                        ]
                    },
                    {
                        title: "Broken Links Card",
                        content: `Monitors and reports broken internal and external links:`,
                        list: [
                            "**Link Health Status** - Shows 'All Good' or number of broken links found",
                            "**Hover Details** - Hover over issue count to see specific broken URLs and status codes",
                            "**Impact on SEO** - Broken links hurt user experience and search engine rankings",
                            "**Regular Monitoring** - Check regularly as links can break over time"
                        ]
                    },
                    {
                        title: "AI Website Analysis Report",
                        content: `AI-generated comprehensive analysis of your website's technical performance:`,
                        list: [
                            "**Intelligent Insights** - AI analyzes all technical data to provide actionable recommendations",
                            "**Priority Recommendations** - Suggestions ranked by potential impact on performance",
                            "**Implementation Guidance** - Specific steps to address identified issues",
                            "**Show More Option** - Click to view the complete detailed AI analysis",
                            "**Copy Prompts** - Use 'Implement Recommendations Myself' to get AI assistance with fixes"
                        ]
                    },
                    {
                        title: "Competitor Performance Comparison",
                        content: `Compare your website's technical performance against competitors:`,
                        list: [
                            "**Site Speed Comparison** - See how your loading times compare to competitors",
                            "**Backlink Profiles** - Compare referring domains and total backlinks",
                            "**Traffic Estimates** - Estimated monthly traffic for you vs competitors",
                            "**Technical Health** - Overall website health scores across all analyzed sites",
                            "**Competitive Advantage** - Identify where you're ahead and where you need improvement"
                        ]
                    },
                    {
                        title: "Refresh & Update System",
                        content: `Keep your website analysis current with the refresh functionality:`,
                        list: [
                            "**Manual Refresh** - Click the refresh button to trigger new website scans",
                            "**Automated Webhooks** - Connects to Forever Booked's scanning systems for fresh data",
                            "**Progress Tracking** - Real-time updates during scan process",
                            "**Data Validation** - Ensures accuracy of all technical metrics",
                            "**Historical Tracking** - Monitor improvements over time"
                        ]
                    },
                    {
                        title: "Using Website Stats Strategically",
                        content: `Maximize the value of your technical analysis:`,
                        list: [
                            "**Prioritize Critical Issues** - Fix errors before warnings for maximum SEO impact",
                            "**Monitor Speed Regularly** - Page speed is a crucial Google ranking factor",
                            "**Track Competitor Gaps** - Identify technical advantages you can exploit",
                            "**Implement AI Recommendations** - Use the detailed AI analysis for systematic improvements",
                            "**Monthly Health Checks** - Regular monitoring prevents technical debt accumulation",
                            "**Professional Support** - Use 'Request Forever Booked Implement' for complex technical fixes"
                        ]
                    }
                ]
            }
        },
        'keywords': {
            title: "Keywords Complete Guide",
            category: "Keywords",
            readTime: "15 min read",
            content: {
                sections: [
                    {
                        title: "Keywords Section Overview",
                        content: `The Keywords section is your command center for tracking search engine rankings, analyzing keyword performance, and monitoring your competitive position. This comprehensive tool helps you understand how well your medical spa ranks for important search terms compared to your competitors.`
                    },
                    {
                        title: "Keywords Summary Dashboard",
                        content: `The top section provides a high-level overview of your keyword performance:`,
                        list: [
                            "**Total Keywords Tracked** - The complete number of keywords being monitored for your business",
                            "**Position 1 Rankings** - How many keywords you rank #1 for (the ultimate goal)",
                            "**Top 3 Rankings (Positions 2-3)** - Keywords where you're highly visible but have room to improve",
                            "**Page 1 Rankings (Positions 4-10)** - Keywords with good visibility that need optimization",
                            "**Page 2 Rankings (Positions 11-20)** - Keywords that need significant improvement",
                            "**Keyword Movement** - Tracks which keywords are moving up, down, or are newly ranked"
                        ]
                    },
                    {
                        title: "Keyword Movement Indicators",
                        content: `Understanding how your keywords are performing over time:`,
                        list: [
                            "**New Keywords** - Terms you've started ranking for (great for content strategy validation)",
                            "**Improved Rankings** - Keywords moving up in search results (shows SEO progress)",
                            "**Declined Rankings** - Keywords losing position (need immediate attention)",
                            "**Lost Keywords** - Terms you no longer rank for (requires investigation and action)",
                            "**Movement Trends** - Overall direction of your keyword portfolio"
                        ]
                    },
                    {
                        title: "Traffic Value Metrics",
                        content: `Financial impact and potential of your keyword rankings:`,
                        list: [
                            "**Estimated Traffic Value (ETV)** - Dollar value of organic traffic you're receiving",
                            "**Estimated Paid Cost** - What you'd pay for the same traffic through Google Ads",
                            "**ROI Calculation** - Compare organic value vs potential advertising costs",
                            "**Growth Opportunities** - Identify high-value keywords to prioritize",
                            "**Budget Planning** - Use data to inform paid advertising decisions"
                        ]
                    },
                    {
                        title: "AI Keywords Analysis Report",
                        content: `Intelligent insights and recommendations based on your keyword data:`,
                        list: [
                            "**Performance Analysis** - AI evaluation of your overall keyword strategy",
                            "**Opportunity Identification** - Keywords with high potential for improvement",
                            "**Competitive Gaps** - Terms where competitors are outperforming you",
                            "**Content Recommendations** - Suggested content topics based on keyword data",
                            "**Priority Actions** - Ranked list of keywords to focus on first",
                            "**Implementation Guidance** - Specific steps to improve keyword rankings"
                        ]
                    },
                    {
                        title: "Detailed Keywords Table",
                        content: `Comprehensive breakdown of every tracked keyword with actionable data:`,
                        list: [
                            "**Current Rank** - Your current position in search results",
                            "**Previous Rank** - Last month's position for comparison",
                            "**Rank Change** - Visual indicators showing improvement or decline",
                            "**Search Volume** - Monthly searches for each keyword",
                            "**Competition Level** - How difficult it is to rank for this keyword",
                            "**Cost Per Click (CPC)** - What advertisers pay for this keyword",
                            "**Keyword Difficulty** - SEO difficulty score for ranking improvements",
                            "**Search Intent** - Whether users are looking to buy, learn, or find locations"
                        ]
                    },
                    {
                        title: "Competitor Keywords Analysis",
                        content: `Compare your keyword performance against up to 4 local competitors:`,
                        list: [
                            "**Head-to-Head Rankings** - See where you and competitors rank for the same terms",
                            "**Competitive Gaps** - Keywords where competitors rank but you don't",
                            "**Opportunity Keywords** - Terms where you could outrank weaker competitors",
                            "**Market Share Analysis** - Your visibility compared to the competitive landscape",
                            "**Competitor Strategies** - Understand what keywords competitors are targeting",
                            "**Benchmark Performance** - Track your progress relative to market leaders"
                        ]
                    },
                    {
                        title: "Keyword Categories & Intent",
                        content: `Understanding different types of keywords and their strategic value:`,
                        list: [
                            "**Service Keywords** - Terms related to your treatments (botox, fillers, laser)",
                            "**Location Keywords** - Geographic terms (medspa near me, [city] medical spa)",
                            "**Commercial Intent** - Buying-focused terms (best medspa, medspa prices)",
                            "**Informational Intent** - Educational searches (botox benefits, laser hair removal)",
                            "**Brand Keywords** - Terms including your business name",
                            "**Long-tail Keywords** - Specific, lower-competition phrases with high conversion potential"
                        ]
                    },
                    {
                        title: "Keyword Research & Expansion",
                        content: `Growing your keyword portfolio strategically:`,
                        list: [
                            "**Gap Analysis** - Find keywords your competitors rank for but you don't",
                            "**Related Keywords** - Discover variations and synonyms of your main terms",
                            "**Local Modifiers** - Add location-specific terms to capture local searches",
                            "**Service Variations** - Different ways people search for your treatments",
                            "**Question Keywords** - FAQ-style searches that indicate high buyer intent",
                            "**Seasonal Keywords** - Terms that peak during specific times of year"
                        ]
                    },
                    {
                        title: "Ranking Factors & Optimization",
                        content: `Key elements that influence your keyword rankings:`,
                        list: [
                            "**On-Page SEO** - Title tags, meta descriptions, header tags, and content optimization",
                            "**Content Quality** - Comprehensive, valuable content that matches search intent",
                            "**Local SEO** - Google Business Profile optimization and local citations",
                            "**Technical SEO** - Site speed, mobile-friendliness, and crawlability",
                            "**Backlink Profile** - Quality and quantity of websites linking to your pages",
                            "**User Experience** - Bounce rate, time on page, and engagement metrics"
                        ]
                    },
                    {
                        title: "Monthly Keyword Tracking",
                        content: `Using historical data to measure progress and plan strategy:`,
                        list: [
                            "**Trend Analysis** - Track ranking improvements and declines over time",
                            "**Seasonal Patterns** - Identify when certain keywords perform better",
                            "**Algorithm Impact** - Understand how Google updates affect your rankings",
                            "**Campaign Effectiveness** - Measure the impact of your SEO efforts",
                            "**Competitive Monitoring** - Track how competitors' keyword strategies evolve",
                            "**ROI Measurement** - Calculate the value of your keyword improvements"
                        ]
                    },
                    {
                        title: "Implementation Strategies",
                        content: `Actionable approaches to improve your keyword rankings:`,
                        list: [
                            "**Content Creation** - Develop pages targeting specific keyword clusters",
                            "**Content Optimization** - Improve existing pages for better keyword performance",
                            "**Local SEO Focus** - Optimize for location-based searches in your area",
                            "**Competitor Analysis** - Study top-ranking competitors' content and strategies",
                            "**Link Building** - Acquire quality backlinks to boost keyword authority",
                            "**Technical Improvements** - Fix site issues that may be hurting rankings"
                        ]
                    },
                    {
                        title: "Using Keywords Data Strategically",
                        content: `Maximize the value of your keyword intelligence for business growth:`,
                        list: [
                            "**Content Planning** - Use keyword data to guide blog topics and page creation",
                            "**PPC Campaign Optimization** - Identify high-value organic keywords for paid campaigns",
                            "**Service Expansion** - Discover new treatment opportunities based on search demand",
                            "**Local Market Analysis** - Understand what services are most searched in your area",
                            "**Competitive Positioning** - Find gaps where you can outperform competitors",
                            "**Business Intelligence** - Use search trends to inform business decisions",
                            "**Professional Support** - Leverage Forever Booked's expertise for advanced keyword strategies"
                        ]
                    }
                ]
            }
        },
        'backlinks': {
            title: "Backlinks Complete Guide",
            category: "Backlinks",
            readTime: "18 min read",
            content: {
                sections: [
                    {
                        title: "Backlinks Section Overview",
                        content: `The Backlinks section is your comprehensive link intelligence center, providing detailed analysis of your backlink profile and competitive link landscape. Understanding your backlinks is crucial for SEO success, as quality backlinks are one of Google's most important ranking factors for medical spa websites.`
                    },
                    {
                        title: "Backlinks Summary Dashboard",
                        content: `The top section provides essential metrics about your overall backlink health:`,
                        list: [
                            "**Total Backlinks** - Complete count of all links pointing to your website",
                            "**Total Dofollow Links** - Links that pass SEO authority (most valuable for rankings)",
                            "**Total Nofollow Links** - Links that don't pass authority but still provide traffic and credibility",
                            "**New Links This Period** - Recently acquired backlinks showing growth momentum",
                            "**Lost Links This Period** - Links that were removed or became inactive",
                            "**Average Spam Score** - Quality indicator of your link profile (lower is better)",
                            "**Top Referring Domains** - Number of unique websites linking to you"
                        ]
                    },
                    {
                        title: "Link Quality & Authority Metrics",
                        content: `Understanding the quality and value of your backlink portfolio:`,
                        list: [
                            "**Domain Authority** - Strength of websites linking to you (higher is better)",
                            "**Page Authority** - Strength of specific pages linking to you",
                            "**Link Context** - How relevant the linking content is to your medical spa services",
                            "**Anchor Text Distribution** - The words used in links pointing to your site",
                            "**Link Placement** - Whether links are in content, sidebars, footers, or navigation",
                            "**Geographic Relevance** - Local websites and directories linking to your business"
                        ]
                    },
                    {
                        title: "Competitive Backlink Analysis",
                        content: `Compare your link profile against up to 4 local competitors:`,
                        list: [
                            "**Link Gap Analysis** - Domains linking to competitors but not to you",
                            "**Competitive Benchmarking** - How your metrics compare to market leaders",
                            "**Shared Link Opportunities** - Websites that link to multiple competitors",
                            "**Competitor Link Strategies** - Understanding how competitors acquire links",
                            "**Market Share Analysis** - Your portion of total backlinks in your market",
                            "**Quality Comparison** - Average domain authority of competitor vs your links"
                        ]
                    },
                    {
                        title: "Link Types & Categories",
                        content: `Different types of backlinks and their strategic value for medical spas:`,
                        list: [
                            "**Editorial Links** - Natural mentions in articles and blog posts (highest value)",
                            "**Directory Links** - Medical spa directories and local business listings",
                            "**Resource Page Links** - Links from 'best of' lists and resource compilations",
                            "**Guest Post Links** - Links from content you've contributed to other sites",
                            "**Social Media Links** - Links from social platforms (usually nofollow)",
                            "**Review Platform Links** - Links from Yelp, Google Reviews, and medical review sites",
                            "**Partnership Links** - Links from business partners, suppliers, and associations"
                        ]
                    },
                    {
                        title: "AI Backlinks Analysis Report",
                        content: `Intelligent insights and strategic recommendations for your link profile:`,
                        list: [
                            "**Link Profile Health Assessment** - Overall quality and risk evaluation",
                            "**Growth Opportunities** - Specific link building opportunities identified by AI",
                            "**Risk Analysis** - Potentially harmful links that could hurt rankings",
                            "**Competitive Gaps** - High-value link opportunities your competitors have",
                            "**Content Recommendations** - Content ideas that could attract natural links",
                            "**Outreach Strategies** - Personalized approaches for link acquisition"
                        ]
                    },
                    {
                        title: "Detailed Backlinks Table",
                        content: `Comprehensive breakdown of every backlink with actionable intelligence:`,
                        list: [
                            "**Source Domain** - The website linking to you with authority metrics",
                            "**Linking Page** - Specific page containing your link",
                            "**Target Page** - Which of your pages is being linked to",
                            "**Anchor Text** - The clickable text used for your link",
                            "**Link Type** - Dofollow vs nofollow classification",
                            "**Discovery Date** - When the link was first detected",
                            "**Link Status** - Active, lost, or newly discovered",
                            "**Spam Score** - Quality assessment of the linking domain"
                        ]
                    },
                    {
                        title: "Link Building Opportunities",
                        content: `Strategic approaches to acquire high-quality backlinks for medical spas:`,
                        list: [
                            "**Local Business Partnerships** - Cross-promotion with complementary businesses",
                            "**Medical Directory Submissions** - Industry-specific directory listings",
                            "**Content Marketing** - Creating linkable assets like treatment guides and research",
                            "**Digital PR** - Newsworthy announcements and expert commentary",
                            "**Resource Page Outreach** - Getting listed on relevant resource compilations",
                            "**Broken Link Building** - Replacing broken links with your content",
                            "**Community Involvement** - Links from local organizations and events"
                        ]
                    },
                    {
                        title: "Link Risk Management",
                        content: `Protecting your website from harmful or low-quality backlinks:`,
                        list: [
                            "**Toxic Link Identification** - Spotting potentially harmful backlinks",
                            "**Spam Score Monitoring** - Regular assessment of link quality",
                            "**Disavow File Management** - Telling Google to ignore bad links",
                            "**Link Removal Strategies** - How to get harmful links removed",
                            "**Penalty Prevention** - Avoiding Google penalties from bad links",
                            "**Recovery Tactics** - Recovering from link-based penalties"
                        ]
                    },
                    {
                        title: "Local Link Building for Medical Spas",
                        content: `Specialized strategies for building local authority and relevance:`,
                        list: [
                            "**Local Chamber of Commerce** - Business association memberships and links",
                            "**Healthcare Directories** - Medical and wellness directory submissions",
                            "**Local News Coverage** - Getting featured in local media outlets",
                            "**Community Event Sponsorship** - Links from event websites and coverage",
                            "**Professional Associations** - Medical and aesthetic industry organizations",
                            "**Local Blogger Outreach** - Partnerships with local lifestyle and wellness bloggers"
                        ]
                    },
                    {
                        title: "Content-Driven Link Acquisition",
                        content: `Creating content that naturally attracts high-quality backlinks:`,
                        list: [
                            "**Treatment Guides** - Comprehensive guides to popular procedures",
                            "**Before/After Galleries** - Visual content that others want to reference",
                            "**Research and Studies** - Original research in aesthetics and wellness",
                            "**Expert Commentary** - Thought leadership on industry trends",
                            "**Infographics** - Visual content about treatments, recovery, and results",
                            "**Video Content** - Educational videos that others embed or reference"
                        ]
                    },
                    {
                        title: "Backlink Monitoring & Maintenance",
                        content: `Ongoing management of your link profile for sustained SEO success:`,
                        list: [
                            "**Regular Audits** - Monthly review of new and lost links",
                            "**Competitor Monitoring** - Tracking competitor link acquisition strategies",
                            "**Link Health Checks** - Ensuring your best links remain active",
                            "**Anchor Text Optimization** - Maintaining natural anchor text distribution",
                            "**Relationship Management** - Nurturing relationships with key linking domains",
                            "**Performance Tracking** - Measuring the SEO impact of link building efforts"
                        ]
                    },
                    {
                        title: "Advanced Link Intelligence",
                        content: `Sophisticated strategies for competitive link intelligence and market domination:`,
                        list: [
                            "**Link Intersection Analysis** - Finding domains that link to multiple competitors",
                            "**Temporal Link Analysis** - Understanding seasonal link building patterns",
                            "**Content Gap Identification** - Topics that attract links but you haven't covered",
                            "**Link Velocity Monitoring** - Tracking the rate of link acquisition",
                            "**Authority Flow Mapping** - Understanding how authority passes through link networks",
                            "**Strategic Link Prioritization** - Focusing efforts on highest-impact opportunities"
                        ]
                    },
                    {
                        title: "Using Backlinks Data Strategically",
                        content: `Maximizing the business value of your backlink intelligence:`,
                        list: [
                            "**SEO Strategy Development** - Using link data to guide overall SEO approach",
                            "**Competitive Positioning** - Identifying and exploiting competitor weaknesses",
                            "**Content Planning** - Creating content based on successful competitor link magnets",
                            "**Partnership Development** - Identifying potential business partnerships through shared links",
                            "**PR and Outreach Strategy** - Targeting high-authority domains for maximum impact",
                            "**ROI Measurement** - Calculating the value of link building investments",
                            "**Professional Implementation** - Leveraging Forever Booked's expertise for advanced link building campaigns"
                        ]
                    }
                ]
            }
        },
        'geogrid-maps': {
            title: "Geogrid Maps Complete Guide",
            category: "Local SEO",
            readTime: "16 min read",
            content: {
                sections: [
                    {
                        title: "Geogrid Maps Overview",
                        content: `The Geogrid Maps section is your comprehensive local search visibility command center. This powerful tool shows you exactly where your medical spa ranks in local search results across different geographic locations, giving you unprecedented insight into your local SEO performance and competitive positioning.`
                    },
                    {
                        title: "Interactive Map Features",
                        content: `Your geogrid maps are fully interactive, providing detailed geographic analysis:`,
                        list: [
                            "**Click and Drag Navigation** - Move around the map to explore different areas and neighborhoods",
                            "**Zoom Controls** - Zoom in for street-level detail or zoom out for broader market overview",
                            "**Street View Toggle** - Switch between street view for detailed location context",
                            "**Satellite View Toggle** - Use satellite imagery to understand geographic and demographic context",
                            "**Clickable Data Points** - Click on any location pin to see detailed ranking information",
                            "**Competitor Overlay** - View your rankings alongside up to 4 competitors simultaneously",
                            "**Color-Coded Results** - Instant visual feedback on performance across different locations"
                        ]
                    },
                    {
                        title: "Understanding Average Geogrid Scores",
                        content: `Your Average Geogrid Score is a critical metric that summarizes your local search performance:`,
                        list: [
                            "**Score Range** - Scores typically range from 0-100, with higher scores indicating better local visibility",
                            "**Calculation Method** - Average of all individual location rankings across your geographic market",
                            "**Weighted by Population** - Locations with higher population density may carry more weight",
                            "**Real-Time Updates** - Scores refresh regularly to reflect current search result positions",
                            "**Competitor Benchmarking** - Compare your average score against local competitors",
                            "**Trend Analysis** - Track how your average score changes over time",
                            "**Market Context** - Understand what constitutes a good score in your specific market"
                        ]
                    },
                    {
                        title: "Top 5 Rankings Explained",
                        content: `The \"Rankings in Top 5\" metric shows your local search dominance:`,
                        list: [
                            "**Definition** - Number of geographic locations where you rank in positions 1-5 for target keywords",
                            "**High-Value Positions** - Top 5 rankings typically receive 70%+ of all clicks",
                            "**Market Coverage** - Higher numbers indicate broader geographic market coverage",
                            "**Competitive Analysis** - Compare your top 5 coverage against competitors",
                            "**Growth Tracking** - Monitor how your top 5 presence expands over time",
                            "**Revenue Impact** - Top 5 rankings directly correlate with increased appointment bookings",
                            "**Strategic Priority** - Focus efforts on converting positions 6-10 into top 5 rankings"
                        ]
                    },
                    {
                        title: "Monthly Data Analysis",
                        content: `Toggle between months to understand your local SEO trends and seasonal patterns:`,
                        list: [
                            "**Historical Performance** - Review up to 12 months of geogrid ranking data",
                            "**Seasonal Trends** - Identify patterns related to aesthetic treatment seasons",
                            "**Progress Tracking** - Measure the impact of your local SEO efforts over time",
                            "**Competitor Movement** - Track how competitor rankings change month by month",
                            "**Algorithm Updates** - Identify ranking changes that correlate with Google updates",
                            "**Campaign Results** - Measure the geographic impact of marketing campaigns",
                            "**Strategic Planning** - Use historical data to plan future local SEO strategies"
                        ]
                    },
                    {
                        title: "Geographic Market Analysis",
                        content: `Understanding the geographic distribution of your local search performance:`,
                        list: [
                            "**Coverage Areas** - Identify neighborhoods and areas where you rank well",
                            "**Coverage Gaps** - Spot geographic areas where competitors outrank you",
                            "**Population Density Impact** - Understand how population affects ranking difficulty",
                            "**Distance Factors** - Analyze how proximity to your location affects rankings",
                            "**Neighborhood Targeting** - Identify specific areas for focused local SEO efforts",
                            "**Market Expansion** - Use data to guide decisions about opening new locations",
                            "**Service Area Optimization** - Align your service areas with your ranking strengths"
                        ]
                    },
                    {
                        title: "Competitive Intelligence",
                        content: `Leverage geogrid data for comprehensive competitive analysis:`,
                        list: [
                            "**Market Share Analysis** - Understand your share of local search visibility",
                            "**Competitor Strengths** - Identify where competitors have geographic advantages",
                            "**Opportunity Identification** - Find areas where competitors are weak",
                            "**Ranking Gaps** - Discover locations where you can overtake competitors",
                            "**Market Dynamics** - Understand how the competitive landscape changes over time",
                            "**Strategic Positioning** - Position your business in underserved geographic areas",
                            "**Competitive Benchmarking** - Set realistic goals based on competitor performance"
                        ]
                    },
                    {
                        title: "Local SEO Strategy Development",
                        content: `Use geogrid insights to develop targeted local SEO strategies:`,
                        list: [
                            "**Priority Area Identification** - Focus efforts on high-opportunity geographic areas",
                            "**Content Localization** - Create location-specific content for underperforming areas",
                            "**Local Citation Building** - Build citations in directories relevant to weak geographic areas",
                            "**Google Business Profile Optimization** - Optimize for keywords that improve geogrid performance",
                            "**Local Link Building** - Acquire links from businesses in target geographic areas",
                            "**Review Generation** - Encourage reviews from customers in specific neighborhoods",
                            "**Local Advertising Alignment** - Align paid advertising with organic ranking strengths"
                        ]
                    },
                    {
                        title: "Improving Your Geogrid Rankings",
                        content: `Actionable strategies to boost your local search visibility:`,
                        list: [
                            "**Google Business Profile Completeness** - Ensure 100% profile completion with accurate information",
                            "**Consistent NAP Data** - Maintain identical Name, Address, Phone across all online platforms",
                            "**Location-Specific Landing Pages** - Create pages targeting specific neighborhoods and areas",
                            "**Local Keyword Optimization** - Include neighborhood and area names in your content",
                            "**Customer Review Management** - Generate reviews mentioning specific locations and services",
                            "**Local Event Participation** - Engage with community events in target geographic areas",
                            "**Proximity Optimization** - Ensure Google understands your exact business location and service areas"
                        ]
                    },
                    {
                        title: "Technical Local SEO Factors",
                        content: `Technical elements that impact your geogrid performance:`,
                        list: [
                            "**Schema Markup** - Implement LocalBusiness schema with precise location data",
                            "**Mobile Optimization** - Ensure excellent mobile experience for local searchers",
                            "**Site Speed** - Fast loading times are crucial for local search rankings",
                            "**Local Structured Data** - Include address, phone, hours, and service area markup",
                            "**Location Pages** - Create dedicated pages for each service area or neighborhood",
                            "**Internal Linking** - Link between location pages and service pages strategically",
                            "**URL Structure** - Use location-based URLs for geographic targeting"
                        ]
                    },
                    {
                        title: "Content Strategy for Local SEO",
                        content: `Content approaches that improve geogrid rankings:`,
                        list: [
                            "**Neighborhood Guides** - Create content about local areas and attractions",
                            "**Local Treatment Trends** - Write about aesthetic trends specific to your market",
                            "**Community Involvement** - Showcase participation in local events and causes",
                            "**Local Testimonials** - Feature reviews and stories from specific neighborhoods",
                            "**Area-Specific Services** - Highlight services popular in different geographic areas",
                            "**Local Partnerships** - Content featuring collaborations with local businesses",
                            "**Geographic Landing Pages** - Dedicated pages for each target area with unique content"
                        ]
                    },
                    {
                        title: "Monitoring and Maintenance",
                        content: `Ongoing management for sustained geogrid performance:`,
                        list: [
                            "**Weekly Monitoring** - Regular check-ins on ranking changes and competitor movement",
                            "**Monthly Analysis** - Deep dive into trends and performance patterns",
                            "**Quarterly Strategy Review** - Adjust local SEO strategy based on geogrid insights",
                            "**Citation Auditing** - Regular cleanup of incorrect or inconsistent business listings",
                            "**Review Response Management** - Respond to reviews mentioning specific locations",
                            "**Competitor Tracking** - Monitor new competitors entering your geographic market",
                            "**Algorithm Update Response** - Adjust strategy when Google updates affect local results"
                        ]
                    },
                    {
                        title: "Advanced Geogrid Strategies",
                        content: `Sophisticated approaches for market domination:`,
                        list: [
                            "**Micro-Location Targeting** - Target specific intersections and landmarks",
                            "**Seasonal Geographic Optimization** - Adjust strategy based on seasonal search patterns",
                            "**Multi-Location Coordination** - Coordinate multiple locations to avoid keyword cannibalization",
                            "**Local Search Ad Integration** - Align paid search geography with organic strengths",
                            "**Voice Search Optimization** - Optimize for \"near me\" voice searches",
                            "**Local Inventory Integration** - Show location-specific service availability",
                            "**Geographic A/B Testing** - Test different approaches in different areas"
                        ]
                    },
                    {
                        title: "Using Geogrid Data Strategically",
                        content: `Maximizing business value from your local search intelligence:`,
                        list: [
                            "**Market Expansion Planning** - Use ranking data to guide new location decisions",
                            "**Marketing Budget Allocation** - Invest more in areas with strong organic presence",
                            "**Service Area Definition** - Define service areas based on ranking strength",
                            "**Competitive Positioning** - Position against competitors in your strongest areas",
                            "**Customer Acquisition Strategy** - Focus acquisition efforts in high-ranking neighborhoods",
                            "**ROI Measurement** - Calculate the revenue impact of improved geogrid performance",
                            "**Professional Implementation** - Leverage Forever Booked's local SEO expertise for advanced geogrid optimization strategies"
                        ]
                    }
                ]
            }
        }
    };

    const currentGuide = guideData[guideId];

    if (!currentGuide) {
        return (
            <PageContent>
                <div className="text-center py-12">
                    <h2 className="text-2xl font-bold mb-4" style={{ color: 'var(--text-primary)' }}>Guide not found</h2>
                    <button 
                        onClick={onBack}
                        className="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors"
                    >
                        Back to Help Library
                    </button>
                </div>
            </PageContent>
        );
    }

    return (
        <PageContent>
            <div className="max-w-4xl mx-auto">
                {/* Back Button */}
                <div className="mb-6">
                    <button
                        onClick={onBack}
                        className="flex items-center space-x-2 text-blue-600 hover:text-blue-700 transition-colors group"
                    >
                        <ArrowLeft className="w-4 h-4 group-hover:-translate-x-1 transition-transform duration-200" />
                        <span>Back to Help Library</span>
                    </button>
                </div>

                {/* Guide Header */}
                <div className="mb-8">
                    <div className="flex items-center space-x-3 mb-4">
                        <span className="px-3 py-1 text-xs font-medium rounded-full bg-blue-100 text-blue-800" style={{ backgroundColor: 'var(--bg-secondary)', color: 'var(--text-primary)' }}>
                            {currentGuide.category}
                        </span>
                        <span className="text-sm" style={{ color: 'var(--text-secondary)' }}>
                            {currentGuide.readTime}
                        </span>
                    </div>
                    <h1 className="text-3xl font-bold" style={{ color: 'var(--text-primary)' }}>
                        {currentGuide.title}
                    </h1>
                </div>

                {/* Guide Content */}
                <div className="prose prose-lg max-w-none" style={{ color: 'var(--text-primary)' }}>
                    {currentGuide.content.sections.map((section, index) => (
                        <div key={index} className="mb-8">
                            <h2 className="text-xl font-semibold mb-4" style={{ color: 'var(--text-primary)' }}>
                                {section.title}
                            </h2>
                            <p className="mb-4 leading-relaxed" style={{ color: 'var(--text-secondary)' }}>
                                {section.content}
                            </p>
                            {section.video && (
                                <div className="mb-6">
                                    {(() => {
                                        const videoUrl = section.video;
                                        
                                        // Check if it's a Loom video
                                        if (videoUrl.includes('loom.com')) {
                                            // Handle both share and embed URLs
                                            let embedUrl = videoUrl;
                                            if (videoUrl.includes('/share/')) {
                                                // Convert share URL to embed URL
                                                embedUrl = videoUrl.replace('/share/', '/embed/');
                                            }
                                            // Remove any query parameters for cleaner embed
                                            embedUrl = embedUrl.split('?')[0];
                                            
                                            return (
                                                <div className="relative w-full" style={{ paddingBottom: '56.25%' }}>
                                                    <iframe
                                                        src={embedUrl}
                                                        className="absolute top-0 left-0 w-full h-full rounded-lg"
                                                        frameBorder="0"
                                                        allowFullScreen
                                                        title={`${section.title} Video`}
                                                    />
                                                </div>
                                            );
                                        }
                                        
                                        // Check if it's a Google Drive link
                                        if (videoUrl.includes('drive.google.com')) {
                                            // Extract file ID from Google Drive URL
                                            const fileId = videoUrl.match(/[-\w]{25,}/);
                                            if (fileId) {
                                                const embedUrl = `https://drive.google.com/file/d/${fileId[0]}/preview`;
                                                return (
                                                    <div className="relative w-full" style={{ paddingBottom: '56.25%' }}>
                                                        <iframe
                                                            src={embedUrl}
                                                            className="absolute top-0 left-0 w-full h-full rounded-lg"
                                                            frameBorder="0"
                                                            allowFullScreen
                                                            title={`${section.title} Video`}
                                                        />
                                                    </div>
                                                );
                                            }
                                        }
                                        
                                        // Check if it's a direct video file (MP4, etc.)
                                        if (videoUrl.match(/\.(mp4|webm|ogg)(\?.*)?$/i)) {
                                            return (
                                                <div className="relative w-full">
                                                    <video
                                                        controls
                                                        className="w-full h-auto rounded-lg"
                                                        style={{ maxHeight: '400px' }}
                                                    >
                                                        <source src={videoUrl} type="video/mp4" />
                                                        Your browser does not support the video tag.
                                                    </video>
                                                </div>
                                            );
                                        }
                                        
                                        // Default iframe for YouTube, Vimeo, etc.
                                        return (
                                            <div className="relative w-full" style={{ paddingBottom: '56.25%' }}>
                                                <iframe
                                                    src={videoUrl}
                                                    className="absolute top-0 left-0 w-full h-full rounded-lg"
                                                    frameBorder="0"
                                                    allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture"
                                                    allowFullScreen
                                                    title={`${section.title} Video`}
                                                />
                                            </div>
                                        );
                                    })()}
                                </div>
                            )}
                            {section.list && (
                                <ul className="space-y-2 mb-4">
                                    {section.list.map((item, itemIndex) => (
                                        <li key={itemIndex} className="flex items-start space-x-3">
                                            <div className="w-2 h-2 rounded-full bg-blue-500 mt-2 flex-shrink-0"></div>
                                            <span 
                                                className="leading-relaxed"
                                                style={{ color: 'var(--text-secondary)' }}
                                                dangerouslySetInnerHTML={{
                                                    __html: item.replace(/\*\*(.*?)\*\*/g, '<strong style="color: var(--text-primary)">$1</strong>')
                                                }}
                                            />
                                        </li>
                                    ))}
                                </ul>
                            )}
                        </div>
                    ))}
                </div>

                {/* Navigation Footer */}
                <div className="mt-12 pt-8 border-t" style={{ borderColor: 'var(--card-border)' }}>
                    <div className="text-center">
                        <p className="mb-6" style={{ color: 'var(--text-secondary)' }}>
                            Was this guide helpful?
                        </p>
                        
                        {/* Three-button navigation layout */}
                        <div className="flex flex-col lg:flex-row gap-6 justify-center items-center max-w-4xl mx-auto">
                            {/* Previous Guide - Left */}
                            <div className="flex justify-start lg:flex-1">
                                {prevGuideInfo ? (
                                    <div className="text-center">
                                        <div className="text-xs font-medium mb-2" style={{ color: 'var(--text-secondary)' }}>
                                            Previous
                                        </div>
                                        <button
                                            onClick={goToPrevGuide}
                                            className="flex items-center space-x-2 px-4 py-2.5 bg-purple-600 text-white rounded-lg hover:bg-purple-700 transition-all duration-200 group shadow-sm hover:shadow-md"
                                        >
                                            <ArrowLeft className="w-4 h-4 group-hover:-translate-x-1 transition-transform duration-200 flex-shrink-0" />
                                            <span className="font-medium text-sm">{prevGuideInfo.title}</span>
                                        </button>
                                    </div>
                                ) : (
                                    <div className="w-32"></div>
                                )}
                            </div>
                            
                            {/* Back to Help Library - Center */}
                            <div className="flex-shrink-0">
                                <button
                                    onClick={onBack}
                                    className="flex items-center space-x-2 px-4 py-2.5 bg-gray-400 text-white rounded-lg hover:bg-gray-500 transition-all duration-200 font-medium shadow-sm hover:shadow-md"
                                >
                                    <span className="text-sm">Help Library</span>
                                </button>
                            </div>
                            
                            {/* Next Guide - Right */}
                            <div className="flex justify-end lg:flex-1">
                                {nextGuideInfo ? (
                                    <div className="text-center">
                                        <div className="text-xs font-medium mb-2" style={{ color: 'var(--text-secondary)' }}>
                                            Next
                                        </div>
                                        <button
                                            onClick={goToNextGuide}
                                            className="flex items-center space-x-2 px-4 py-2.5 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-all duration-200 group shadow-sm hover:shadow-md"
                                        >
                                            <span className="font-medium text-sm">{nextGuideInfo.title}</span>
                                            <ArrowRight className="w-4 h-4 group-hover:translate-x-1 transition-transform duration-200 flex-shrink-0" />
                                        </button>
                                    </div>
                                ) : (
                                    <div className="w-32 flex justify-end">
                                        <div className="text-xs px-3 py-2 bg-green-100 text-green-800 rounded-lg font-medium" style={{ 
                                            backgroundColor: 'var(--success-bg, #dcfce7)', 
                                            color: 'var(--success-text, #166534)' 
                                        }}>
                                            🎉 Complete!
                                        </div>
                                    </div>
                                )}
                            </div>
                        </div>
                        
                        {/* Mobile stacked layout */}
                        <div className="lg:hidden mt-4 text-xs" style={{ color: 'var(--text-secondary)' }}>
                            Navigate between guides or return to the library
                        </div>
                    </div>
                </div>
            </div>
        </PageContent>
    );
};

const ToolsPage     = () => <PageContent><h2 className="text-center text-gray-500">Tools – coming soon</h2></PageContent>;
const GeogridMaps = ({ data }) => {
    const { ResponsiveContainer, BarChart, Bar, XAxis, YAxis, Tooltip, CartesianGrid, Cell, LabelList } = window.Recharts;
    const [geogridData, setGeogridData] = useState(data || null);
    const [loading, setLoading] = useState(!data);
    const [error, setError] = useState(null);

    // Dynamically pick up to 6 relevant keywords based on patterns
    const keywordPatterns = [
        /^medspa$/i,
        /^medspa near me$/i,
        /facial\s+spa/i,
        /medspa near/i,
        /best\s+medspa/i,
        /luxury.*spa/i
    ];

    const targetKeywords = React.useMemo(() => {
        if (!geogridData) return [];
        const allKeywords = Object.keys(geogridData);
        const matched = allKeywords.filter(kw => keywordPatterns.some(p => p.test(kw)));
        // Fallback: if less than 6 matched, add the first ones to fill
        const fallback = allKeywords.filter(kw => !matched.includes(kw));
        return [...matched, ...fallback].slice(0, 6);
    }, [geogridData]);
    
    const getRankColor = (rank) => {
        if (rank === null || rank === undefined) return 'bg-gray-400';
        if (rank <= 3) return 'bg-green-500';
        if (rank <= 5) return 'bg-sky-500';
        if (rank <= 10) return 'bg-yellow-500';
        if (rank <= 20) return 'bg-orange-500';
        return 'bg-red-500';
    };

    // Update geogrid data when prop changes
    useEffect(() => {
        if (data && data !== geogridData) {
            setGeogridData(data);
            setLoading(false);
            setError(null);
        }
    }, [data, geogridData]);

    useEffect(() => {
        // Only fetch data if not provided via props
        if (data) {
            return;
        }

        const params = new URLSearchParams(window.location.search);
        const workbookId = params.get('workbookId');
        if (!workbookId) {
            setError("No workbook ID provided");
            setLoading(false);
            return;
        }

        // Use a different cache key for the full geogrid data
        const cacheKey = `full_geogrid_${workbookId}`;
        
        // Try to get data from cache first
        const cachedData = sessionStorage.getItem(cacheKey);
        if (cachedData) {
            try {
                const parsed = JSON.parse(cachedData);
                setGeogridData(parsed);
                setLoading(false);
                return;
            } catch (e) {
                console.error('Cache parsing error:', e);
                // Clear invalid cache
                sessionStorage.removeItem(cacheKey);
            }
        }

        // If no cache or invalid cache, fetch fresh data
        setLoading(true);
        const scriptUrl = `https://script.google.com/macros/s/AKfycbxfOMp8d_eCVH4lFD0PNuFU1wH-gyWOwRt2EuME7GQJ4U73ZwpPDciohDH3C566YLWq/exec?workbookId=${workbookId}`;
        
        fetchWithCorsWorkaround(scriptUrl, (err, data) => {
            if (err) {
                setError(err.message);
                setLoading(false);
                return;
            }
            if (data.error) {
                setError(`Script error: ${data.error}`);
                setLoading(false);
                return;
            }
            
            try {
                // Enhanced helper function to fix date parsing and handle missing months
                const fixDateFormatting = (monthlyData) => {
                    if (!Array.isArray(monthlyData) || monthlyData.length === 0) return monthlyData;
                    
                    console.log('📅 Original monthly data:', monthlyData.map(m => ({ 
                        date: m.date, 
                        originalDate: m.date, 
                        rawDate: m.rawDate,
                        parsedDate: m.parsedDate 
                    })));
                    
                    // Try to parse the original dates first
                    const parsedDates = monthlyData.map((monthData, index) => {
                        let parsedDate = null;
                        
                        // If we have a parsedDate from the backend, use it
                        if (monthData.parsedDate) {
                            parsedDate = new Date(monthData.parsedDate);
                        }
                        
                        // If no parsedDate from backend, try multiple parsing approaches
                        if (!parsedDate || isNaN(parsedDate.getTime())) {
                            if (monthData.date) {
                                // First try parsing as-is
                                parsedDate = new Date(monthData.date);
                                
                                // If that fails, try US date format parsing
                                if (isNaN(parsedDate.getTime())) {
                                    // Try parsing MM/DD/YYYY format
                                    const dateStr = monthData.date.toString();
                                    const parts = dateStr.split('/');
                                    if (parts.length === 3) {
                                        const month = parseInt(parts[0]) - 1; // Convert to 0-based
                                        const day = parseInt(parts[1]);
                                        const year = parseInt(parts[2]);
                                        parsedDate = new Date(year, month, day);
                                    }
                                }
                            }
                            
                            // Try parsing rawDate if available
                            if ((!parsedDate || isNaN(parsedDate.getTime())) && monthData.rawDate) {
                                parsedDate = new Date(monthData.rawDate);
                                
                                // If that fails, try US date format parsing on rawDate
                                if (isNaN(parsedDate.getTime())) {
                                    const dateStr = monthData.rawDate.toString();
                                    const parts = dateStr.split('/');
                                    if (parts.length === 3) {
                                        const month = parseInt(parts[0]) - 1; // Convert to 0-based
                                        const day = parseInt(parts[1]);
                                        const year = parseInt(parts[2]);
                                        parsedDate = new Date(year, month, day);
                                    }
                                }
                            }
                        }
                        
                        return {
                            ...monthData,
                            originalDate: monthData.date,
                            parsedDate: parsedDate,
                            index: index
                        };
                    });
                    
                    // Check if we have valid parsed dates
                    const validDates = parsedDates.filter(item => item.parsedDate && !isNaN(item.parsedDate.getTime()));
                    
                    if (validDates.length === 0) {
                        console.log('⚠️ No valid dates found, using fallback sequential logic');
                        // Fallback to sequential month logic
                        return monthlyData.map((monthData, index) => {
                            const currentDate = new Date();
                            const currentMonth = currentDate.getMonth();
                            const currentYear = currentDate.getFullYear();
                            
                            let targetMonth = currentMonth - index;
                            let targetYear = currentYear;
                            
                            if (targetMonth < 0) {
                                targetMonth += 12;
                                targetYear--;
                            }
                            
                            const correctedDate = new Date(targetYear, targetMonth, 1);
                            const formattedDate = correctedDate.toLocaleString('default', { 
                                month: 'long', 
                                year: 'numeric'
                            });
                            
                            return {
                                ...monthData,
                                date: formattedDate,
                                originalDate: monthData.date,
                                correctedDate: correctedDate
                            };
                        });
                    }
                    
                    // If we have valid dates, sort by date (newest first) and format properly
                    validDates.sort((a, b) => b.parsedDate.getTime() - a.parsedDate.getTime());
                    
                    console.log('✅ Valid dates after sorting:', validDates.map(v => ({
                        date: v.parsedDate.toLocaleString('default', { month: 'long', year: 'numeric' }),
                        parsedDate: v.parsedDate,
                        originalDate: v.originalDate
                    })));
                    
                    return validDates.map(item => {
                        const formattedDate = item.parsedDate.toLocaleString('default', { 
                            month: 'long', 
                            year: 'numeric'
                        });
                        
                        return {
                            ...item,
                            date: formattedDate,
                            correctedDate: item.parsedDate
                        };
                    });
                };

                // Get geogrid data and normalize keywords
                const rawData = data.geogridData || {};
                console.log('🔍 Raw geogrid data from server:', rawData);
                
                const normalizedData = {};
                Object.entries(rawData).forEach(([key, value]) => {
                    if (Array.isArray(value)) {
                        console.log(`📅 Processing keyword "${key}" with ${value.length} months:`, value.map(v => v.date));
                        
                        // Always apply our enhanced date formatting
                        const processedData = fixDateFormatting(value);
                        console.log(`✅ Processed "${key}":`, processedData.map(v => ({ date: v.date, originalDate: v.originalDate })));
                        
                        normalizedData[key.toLowerCase().trim()] = processedData;
                    } else {
                        normalizedData[key.toLowerCase().trim()] = value;
                    }
                });

                // Cache the normalized data
                sessionStorage.setItem(cacheKey, JSON.stringify(normalizedData));
                
                setGeogridData(normalizedData);
                setLoading(false);
            } catch (e) {
                console.error('Data processing error:', e);
                setError('Failed to process geogrid data');
                setLoading(false);
            }
        });
    }, [data]);

    if (loading) {
        return (
            <PageContent>
                <div className="flex justify-between items-center mb-6">
                    <div>
                        <h1 className="text-3xl font-bold text-gray-800">Geogrid Search Results</h1>
                        <p className="text-gray-500 mt-1">Track your local search rankings across different keywords</p>
                    </div>
                        <button
                        disabled
                        className="bg-slate-100 text-slate-400 font-bold py-1 px-3 rounded-lg text-xs cursor-not-allowed"
                    >
                        Refresh
                        </button>
                    </div>
                <div className="grid grid-cols-1 md:grid-cols-2 gap-8">
                    {targetKeywords.map(keyword => (
                        <Card key={keyword} className="animate-pulse">
                            <div className="h-[500px] bg-gray-100 rounded-lg"></div>
                        </Card>
                    ))}
                </div>
            </PageContent>
        );
    }

    const GeogridMapCard = ({ keyword, monthlyData }) => {
        const [currentMonthIndex, setCurrentMonthIndex] = useState(0);
        const CHART_COLORS = ['#3b82f6', '#16a34a', '#f97316', '#a855f7', '#ec4899'];
        const isDarkMode = document.documentElement.getAttribute('data-theme') === 'dark';
        
        // Initialize to show the newest month (index 0 since data is sorted newest first)
        // But we want to display it as "X of Y" where X starts at the total count
        const displayMonthNumber = monthlyData.length - currentMonthIndex;

        // Debug logging
        console.log(`GeogridMapCard for "${keyword}":`, {
            monthlyDataLength: monthlyData?.length,
            monthlyData: monthlyData,
            currentMonthIndex,
            dates: monthlyData?.map(m => m.date),
            currentData: monthlyData?.[currentMonthIndex],
            availableIndices: monthlyData?.map((_, i) => i)
        });

        // Validate monthlyData
        if (!Array.isArray(monthlyData) || monthlyData.length === 0) {
            return (
                <Card>
                    <div className="p-4 text-center text-gray-500">
                        No data available for keyword: {keyword}
                            </div>
                </Card>
            );
        }

        const currentData = monthlyData[currentMonthIndex];
        
        // Validate currentData
        if (!currentData || !currentData.competitors) {
            return (
                <Card>
                    <div className="p-4 text-center text-gray-500">
                        Invalid data format for keyword: {keyword}
                            </div>
                </Card>
            );
        }

        const handleDateChange = (direction) => {
            const newIndex = currentMonthIndex + direction;
            console.log(`📅 Month navigation for "${keyword}":`, {
                direction,
                currentIndex: currentMonthIndex,
                newIndex,
                maxIndex: monthlyData.length - 1,
                isValidIndex: newIndex >= 0 && newIndex < monthlyData.length,
                availableDates: monthlyData.map((m, i) => ({ index: i, date: m.date })),
                displayMonthNumber: monthlyData.length - currentMonthIndex,
                newDisplayNumber: monthlyData.length - newIndex
            });
            
            if (newIndex >= 0 && newIndex < monthlyData.length) {
                setCurrentMonthIndex(newIndex);
                console.log(`✅ Changed to month index ${newIndex}: ${monthlyData[newIndex]?.date} (Display: ${monthlyData.length - newIndex} of ${monthlyData.length})`);
            } else {
                console.log(`❌ Invalid month index ${newIndex} for keyword "${keyword}"`);
            }
        };

        // Ensure competitors array exists and has valid data
        const competitors = Array.isArray(currentData.competitors) ? currentData.competitors : [];

        const CustomXAxisTick = ({ x, y, payload }) => {
            const name = payload.value || '';
            
            // Smart text truncation for competitor names
            const truncateText = (text, maxLength = 15) => {
                if (text.length <= maxLength) return text;
                
                // Try to break at a space if possible
                const lastSpace = text.lastIndexOf(' ', maxLength - 1);
                if (lastSpace > maxLength * 0.6) { // Only break at space if it's not too early
                    return text.substring(0, lastSpace) + '…';
                }
                
                // Otherwise, just truncate with ellipsis
                return text.substring(0, maxLength - 1) + '…';
            };
            
            const displayName = truncateText(name);
            
            return (
                <g transform={`translate(${x},${y})`}>
                    <text 
                        x={0} 
                        y={0} 
                        dy={16} 
                        textAnchor="end" 
                        fill="#6B7280" 
                        fontSize={12} 
                        transform="rotate(-40)"
                    >
                        {displayName}
                    </text>
                </g>
            );
        };

        // Define formatLabel here so it's in scope for GeogridMapCard
        const formatLabel = (value) => {
            if (value >= 1000) return `${(value / 1000).toFixed(1)}k`;
            return value.toString();
        };

        return (
            <Card className="group hover:shadow-xl transition-all duration-300 hover:-translate-y-0.5 hover:border-blue-200/60">
                <div className="flex justify-between items-start mb-4">
                    <div>
                        <h2 className="text-xl font-bold text-gray-800">{keyword}</h2>
                        <p className="text-sm text-gray-500 mt-1">
                            {monthlyData.length > 1 ? `${monthlyData.length} months of data available` : 'Latest Rankings'}
                        </p>
                    </div>
                    <div className="flex items-center space-x-3">
                        <button 
                            onClick={() => handleDateChange(1)} 
                            disabled={currentMonthIndex >= monthlyData.length - 1}
                            className="flex items-center justify-center w-8 h-8 rounded-lg bg-blue-100 hover:bg-blue-200 disabled:opacity-50 disabled:cursor-not-allowed text-blue-600 transition-colors"
                            title="Go back to older month"
                        >
                            <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M15 19l-7-7 7-7" />
                            </svg>
                        </button>
                        <div className="text-center">
                            <span className="font-semibold text-gray-700 text-sm">{currentData.date || 'No date'}</span>
                            {monthlyData.length > 1 && (
                                <div className="text-xs text-gray-500">
                                    {displayMonthNumber} of {monthlyData.length}
                                </div>
                            )}
                            {monthlyData.length > 1 && (
                                <div className="flex items-center justify-center space-x-1 mt-1">
                                    {monthlyData.map((_, index) => {
                                        // Reverse the visual order so newest (index 0) appears on the right
                                        const visualIndex = monthlyData.length - 1 - index;
                                        return (
                                            <div
                                                key={index}
                                                className={`w-2 h-2 rounded-full ${
                                                    index === currentMonthIndex 
                                                        ? 'bg-blue-600' 
                                                        : 'bg-gray-300 hover:bg-gray-400'
                                                } cursor-pointer transition-colors`}
                                                onClick={() => setCurrentMonthIndex(index)}
                                                title={`Go to ${monthlyData[index]?.date || 'Unknown month'} (${monthlyData.length - index} of ${monthlyData.length})`}
                                                style={{ order: visualIndex }}
                                            />
                                        );
                                    })}
                                </div>
                            )}
                        </div>
                        <button 
                            onClick={() => handleDateChange(-1)} 
                            disabled={currentMonthIndex <= 0}
                            className="flex items-center justify-center w-8 h-8 rounded-lg bg-blue-100 hover:bg-blue-200 disabled:opacity-50 disabled:cursor-not-allowed text-blue-600 transition-colors"
                            title="Go forward to newer month"
                        >
                            <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M9 5l7 7-7 7" />
                            </svg>
                        </button>
                    </div>
                </div>
                
                <div className="grid grid-cols-1 md:grid-cols-4 gap-4">
                    {/* Modern Rankings Column */}
                    <div className="md:col-span-1">
                        {competitors.length > 0 && (
                            <div>
                                <div className="flex items-center space-x-2 mb-3">
                                    <h3 className="text-lg font-semibold text-gray-800">Avg Score</h3>
                                </div>
                                <div className="space-y-2.5">
                                    {competitors.map((comp, index) => {
                                        const isClient = comp.isClient;
                                        const rank = typeof comp.rank === 'number' ? comp.rank : 0;
                                        
                                        // Improved color scheme for geogrid scores (lower is better)
                                        const getScoreColors = (score) => {
                                            if (score <= 3) {
                                                return {
                                                    border: 'border-green-500',
                                                    bg: 'bg-green-50',
                                                    text: 'text-green-700',
                                                    accent: 'bg-green-500'
                                                };
                                            } else if (score <= 7) {
                                                return {
                                                    border: 'border-yellow-500',
                                                    bg: 'bg-yellow-50',
                                                    text: 'text-yellow-700',
                                                    accent: 'bg-yellow-500'
                                                };
                                            } else {
                                                return {
                                                    border: 'border-red-500',
                                                    bg: 'bg-red-50',
                                                    text: 'text-red-700',
                                                    accent: 'bg-red-500'
                                                };
                                            }
                                        };
                                        
                                        const scoreColors = getScoreColors(rank);
                                        
                                        // Position indicators
                                        const getPositionText = (index) => {
                                            const positions = ['1st', '2nd', '3rd', '4th', '5th'];
                                            return positions[index] || `${index + 1}th`;
                                        };
                                        
                                        return (
                                            <div key={index} className="group relative overflow-visible rounded-xl transition-all duration-300 hover:shadow-lg bg-white border border-gray-200 hover:border-gray-300 hover:shadow-md geogrid-card">
                                            {/* Position Badge - Top Left, Half In/Half Out */}
                                            <div className="absolute -top-1 -left-1 z-10">
                                                <span className={`inline-block px-1.5 py-0.5 rounded-full text-[11px] font-bold shadow-sm ${
                                                    index === 0 ? 'bg-yellow-500 text-white' :
                                                    index === 1 ? 'bg-gray-500 text-white' :
                                                    index === 2 ? 'bg-orange-500 text-white' :
                                                    'bg-blue-500 text-white'
                                                }`}>
                                                    {getPositionText(index)}
                                                </span>
                                            </div>
                                            
                                            {/* Subtle background pattern */}
                                            <div className="absolute inset-0 bg-gradient-to-br from-white/50 to-transparent pointer-events-none"></div>
                                            
                                            <div className="relative p-2 pt-4 flex items-center justify-between">
                                                    {/* Business Info */}
                                                    <div className="flex-1 min-w-0 pr-3">
                                                        <div className="flex items-center space-x-2">
                                                            <p className="font-semibold text-xs leading-tight truncate text-gray-800 max-w-[120px]" title={comp.name || 'Unknown'}>
                                                                {comp.name || 'Unknown'}
                                                            </p>
                                                            {isClient && (
                                                                <div className="flex-shrink-0 w-3 h-3 bg-blue-500 rounded-full flex items-center justify-center">
                                                                    <span className="text-xs text-white font-bold">★</span>
                                                                </div>
                                                            )}
                                                        </div>
                                                    </div>
                                                    
                                                    {/* Score Display with Colored Circle */}
                                                    <div className="flex-shrink-0 text-right">
                                                        <div className={`w-10 h-10 rounded-full border-2 flex items-center justify-center ${
                                                            index === 0 ? 'border-green-600' :
                                                            index === 1 ? 'border-green-500' :
                                                            index === 2 ? 'border-green-400' :
                                                            index >= 3 && index <= 7 ? 'border-yellow-500' :
                                                            index >= 8 && index <= 11 ? 'border-blue-500' :
                                                            'border-red-500'
                                                        }`}>
                                                            <span className="text-xs font-bold avg-score-text">
                                                                {rank > 0 ? rank.toFixed(1) : '-'}
                                                            </span>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        );
                                    })}
                                </div>
                            </div>
                        )}
                    </div>

                    {/* Right Column: Map */}
                    <div className="md:col-span-3">
                        {currentData.mapLink ? (
                            <div className="relative w-full h-[550px] overflow-hidden mx-0 map-container" onClick={handleMapActivate} onMouseLeave={handleMapDeactivate}>
                                <iframe 
                                    src={processMapUrlForCentering(currentData.mapLink)}
                                    className="w-full h-full rounded-lg map-iframe"
                                    style={{ background: '#f9fafb' }}
                                    loading="lazy"
                                    allowFullScreen
                                    scrolling="no"
                                />
                                <a 
                                    href={currentData.mapLink} 
                                    target="_blank" 
                                    rel="noopener noreferrer"
                                    className="absolute bottom-2 right-2 bg-white/90 hover:bg-white text-gray-700 px-2 py-1 rounded text-xs flex items-center gap-1 shadow-sm transition-colors"
                                >
                                    <svg className="w-3 h-3" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                                        <path d="M18 13v6a2 2 0 01-2 2H5a2 2 0 01-2-2V8a2 2 0 012-2h6" />
                                        <polyline points="15 3 21 3 21 9" />
                                        <line x1="10" y1="14" x2="21" y2="3" />
                                    </svg>
                                    Open in new tab
                                </a>
                            </div>
                        ) : (
                            <div className="w-full h-[550px] flex flex-col items-center justify-center bg-gray-50 rounded-lg">
                                <div className="bg-gray-100 p-4 rounded-full mb-4">
                                    <svg className="w-12 h-12 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M9 20l-5.447-2.724A1 1 0 013 16.382V5.618a1 1 0 011.447-.894L9 7m0 13l6-3m-6 3V7m6 10l4.553 2.276A1 1 0 0021 18.382V7.618a1 1 0 00-.553-.894L15 4m0 13V4m0 0L9 7" />
                                    </svg>
                                </div>
                                <p className="text-lg font-semibold text-gray-600 mb-2">Map Not Available Yet</p>
                                <p className="text-sm text-gray-500 text-center max-w-md">
                                    The Geogrid map for "{keyword}" is pending setup. Once available, it will show local search rankings across your service area.
                                </p>
                            </div>
                        )}
                    </div>
                </div>

                                 {/* Bottom Row: Bar Chart */}
                 {competitors.length > 0 && (
                     <div className="mt-8">
                         <h3 className="text-lg font-semibold text-gray-800 mb-3">Rankings in Top 5</h3>
                         <div className="relative">
                             {/* Compact Legend - Top Right */}
                             <div className="absolute -top-1 right-8 z-10 bg-white/90 backdrop-blur-sm rounded-lg px-3 py-2 shadow-sm border border-gray-200">
                                 <div className="flex items-center space-x-4 text-xs">
                                     <div className="flex items-center space-x-1.5">
                                         <div className="w-3 h-3 rounded shadow-sm" style={{ backgroundColor: '#3b82f6' }}></div>
                                         <span className="font-medium text-gray-700">Client</span>
                                     </div>
                                     <div className="flex items-center space-x-1.5">
                                         <div className="w-3 h-3 rounded shadow-sm" style={{ backgroundColor: '#7c3aed' }}></div>
                                         <span className="font-medium text-gray-700">Competitors</span>
                                     </div>
                                 </div>
                             </div>
                             
                             <ResponsiveContainer width="100%" height={280}>
                                 <BarChart data={competitors} margin={{ top: 40, right: 30, left: 20, bottom: 20 }}>
                                  <defs>
                                      {/* Simple two-color system for geogrid charts */}
                                      <linearGradient id="geogrid-client-gradient" x1="0" y1="0" x2="0" y2="1">
                                          <stop offset="0%" stopColor="#3b82f6" />
                                          <stop offset="50%" stopColor="#3b82f6" />
                                          <stop offset="100%" stopColor="#3b82f640" />
                                      </linearGradient>
                                      <linearGradient id="geogrid-competitor-gradient" x1="0" y1="0" x2="0" y2="1">
                                          <stop offset="0%" stopColor="#7c3aed" />
                                          <stop offset="50%" stopColor="#8b5cf6" />
                                          <stop offset="100%" stopColor="#7c3aed40" />
                                      </linearGradient>
                                  </defs>
                                  {!isDarkMode ? (
                                    <CartesianGrid strokeDasharray="3 3" stroke="#f1f5f9" />
                                  ) : (
                                    <CartesianGrid stroke="transparent" />
                                  )}
                                            <XAxis 
                                      dataKey="name" 
                                      tick={{ fontSize: 12, fill: '#64748b', className: 'dark:!fill-[#94A3B8]' }}
                                      height={40}
                                      interval={0}
                                      tickFormatter={(value) => {
                                          // Truncate names for X-axis display
                                          const truncateName = (name, maxLength = 12) => {
                                              if (!name || typeof name !== 'string') return name || 'Unknown';
                                              if (name.length <= maxLength) return name;
                                              return name.substring(0, maxLength - 1) + '…';
                                          };
                                          return truncateName(value);
                                      }}
                                            />
                                            <YAxis 
                                      tick={{ fontSize: 12, fill: '#64748b', className: 'dark:!fill-[#94A3B8]' }}
                                      domain={[0, dataMax => {
                                          const maxValue = Math.max(...competitors.map(c => c.top5Total || 0));
                                          const increment = 5;
                                          const suggestedMax = Math.max(10, Math.ceil(maxValue / increment) * increment);
                                          return suggestedMax;
                                      }]}
                                      ticks={(() => {
                                          const maxValue = Math.max(...competitors.map(c => c.top5Total || 0));
                                          const increment = 5;
                                          const suggestedMax = Math.max(10, Math.ceil(maxValue / increment) * increment);
                                          return [0, increment, increment * 2, increment * 3, suggestedMax];
                                      })()}
                                      tickFormatter={(value) => value.toString()}
                                  />
                                  <Tooltip 
                                      contentStyle={{ 
                                          backgroundColor: 'rgba(31, 41, 55, 0.95)', 
                                          border: '1px solid #374151', 
                                          borderRadius: '12px',
                                          boxShadow: '0 20px 25px -5px rgb(0 0 0 / 0.1)',
                                          color: '#fff'
                                      }}
                                      itemStyle={{ color: '#fff' }}
                                      labelStyle={{ color: '#fff', fontWeight: 'bold' }}
                                      formatter={(value, name, props) => [
                                          <div key="tooltip">
                                              <div style={{ fontWeight: 'bold' }}>{value}</div>
                                              <div style={{ fontSize: '11px', opacity: 0.8 }}>Top 5 Rankings</div>
                                              {props.payload?.isClient === true && <div style={{ fontSize: '11px', color: '#60a5fa' }}>⭐ Your Business</div>}
                                          </div>,
                                          'Top 5 Count'
                                      ]}
                                      cursor={{ fill: 'rgba(59, 130, 246, 0.04)' }}
                                  />
                                  <Bar dataKey='top5Total' name="Top 5 Rankings" radius={[6, 6, 0, 0]} barSize={40} barGap={4} barCategoryGap={14}>
                                      {competitors.map((entry, index) => {
                                          const isClient = entry.isClient === true;
                                          const gradientId = isClient ? 'geogrid-client-gradient' : 'geogrid-competitor-gradient';
                                          return (
                                              <Cell 
                                                  key={`cell-${index}`} 
                                                  fill={`url(#${gradientId})`}
                                              />
                                          );
                                      })}
                                      <LabelList 
                                          dataKey="top5Total" 
                                          position="top" 
                                          style={{ fontSize: 12, fontWeight: 400, fill: '#64748b' }}
                                          formatter={formatLabel}
                                      />
                                  </Bar>
                             </BarChart>
                         </ResponsiveContainer>
                         </div>
                     </div>
                 )}
            </Card>
        );
    };

    // Get all available months across all keywords
    const getAvailableMonths = () => {
        const allMonths = new Set();
        Object.values(geogridData || {}).forEach(keywordData => {
            if (Array.isArray(keywordData)) {
                keywordData.forEach(monthData => {
                    if (monthData.date) {
                        allMonths.add(monthData.date);
                    }
                });
            }
        });
        return Array.from(allMonths).sort();
    };

    const availableMonths = getAvailableMonths();

    return (
        <PageContent>
            <div className="flex justify-between items-center mb-6">
                <div>
                    <h1 className="text-3xl font-bold text-gray-800">Geogrid Search Results</h1>
                    <p className="text-gray-500 mt-1">Track your local search rankings across different keywords</p>
                    {availableMonths.length > 0 && (
                        <div className="flex items-center gap-2 mt-2">
                            <span className="text-sm text-gray-600">Available months:</span>
                            <div className="flex gap-1">
                                {availableMonths.map(month => (
                                    <span key={month} className="px-2 py-1 bg-blue-100 text-blue-800 text-xs rounded-full">
                                        {month}
                                    </span>
                                ))}
                            </div>
                        </div>
                    )}
                </div>

            </div>

            <div className="grid grid-cols-1 xl:grid-cols-2 gap-4">
                {targetKeywords.map(keyword => (
                    <GeogridMapCard 
                        key={keyword} 
                        keyword={keyword} 
                        monthlyData={geogridData[keyword.toLowerCase().trim()] || []} 
                    />
                ))}
            </div>
        </PageContent>
    );
};

/* ------------------------------------------------------------------ */
/* CONSISTENT COLOR MAPPING SYSTEM                                   */
/* ------------------------------------------------------------------ */

// Consistent color mapping system for competitors across all charts
const getConsistentColor = (businessName, isClient, allBusinesses = []) => {
    // Client always gets blue
    if (isClient) {
        return {
            start: '#3b82f6',
            end: '#3b82f6',
            gradientStart: '#3b82f6',
            gradientEnd: '#3b82f640'
        };
    }
    
    // Define consistent competitor colors (same as ModernComparisonChart)
    const competitorColors = [
        { start: '#7c3aed', end: '#6d28d9', gradientStart: '#7c3aed', gradientEnd: '#7c3aed40' }, // Dark Purple
        { start: '#8b5cf6', end: '#7c3aed', gradientStart: '#8b5cf6', gradientEnd: '#8b5cf640' }, // Purple  
        { start: '#6366f1', end: '#4f46e5', gradientStart: '#6366f1', gradientEnd: '#6366f140' }, // Indigo
        { start: '#10b981', end: '#059669', gradientStart: '#10b981', gradientEnd: '#10b98140' }, // Emerald
        { start: '#f97316', end: '#ea580c', gradientStart: '#f97316', gradientEnd: '#f9731640' }  // Orange
    ];
    
    // Get all non-client businesses and sort them consistently
    const competitors = allBusinesses
        .filter(business => !business.isClient)
        .sort((a, b) => (a.name || '').localeCompare(b.name || ''));
    
    // Find the index of this business in the sorted competitor list
    const competitorIndex = competitors.findIndex(comp => comp.name === businessName);
    
    // If found, use the consistent color, otherwise use a fallback
    if (competitorIndex !== -1 && competitorIndex < competitorColors.length) {
        return competitorColors[competitorIndex];
    }
    
    // Fallback for unknown competitors (use gray)
    return {
        start: '#6b7280',
        end: '#4b5563',
        gradientStart: '#6b7280',
        gradientEnd: '#6b728040'
    };
};
/* ------------------------------------------------------------------ */
/* WEBSITE STATS - HELPER COMPONENTS & DATA                           */
/* ------------------------------------------------------------------ */
const StatCard = ({ label, value, icon, tooltip }) => {
    const cardRef = useRef(null);
    const [tooltipPosition, setTooltipPosition] = useState('top');
    const [tooltipWidthClass, setTooltipWidthClass] = useState('w-64');

    useEffect(() => {
        if (tooltip && tooltip.width === 'large') {
            setTooltipWidthClass('w-[600px]');
        } else {
            setTooltipWidthClass('w-64');
        }

        const cardElement = cardRef.current;
        if (!cardElement || !tooltip) return;

        const handleMouseEnter = () => {
            const cardRect = cardElement.getBoundingClientRect();
            const spaceAbove = cardRect.top;
            
            // A simple heuristic to decide tooltip position
            // Estimate tooltip height. large is w-[600px] so it can be tall.
            const estimatedHeight = tooltip.width === 'large' ? 350 : 150;

            if (spaceAbove < estimatedHeight && (window.innerHeight - cardRect.bottom) > spaceAbove) {
                setTooltipPosition('bottom');
            } else {
                setTooltipPosition('top');
            }
        };

        cardElement.addEventListener('mouseenter', handleMouseEnter);

        return () => {
            if (cardElement) {
                cardElement.removeEventListener('mouseenter', handleMouseEnter);
            }
        };
    }, [tooltip]);

    const content = (
        <div className="flex items-center space-x-3">
            <div className="p-2 bg-blue-100 rounded-full">{icon}</div>
            <div>
                <p className="text-sm text-gray-500">{label}</p>
                <p className={`font-bold text-lg ${value.color || 'text-gray-800'}`}>{value.text}</p>
            </div>
        </div>
    );

    if (tooltip && tooltip.content) {
        return (
            <div ref={cardRef} className="relative group cursor-help">
                {content}
                <div className={`absolute left-1/2 -translate-x-1/2 ${tooltipWidthClass} bg-gray-800 text-white text-sm rounded-lg shadow-lg opacity-0 group-hover:opacity-100 transition-opacity duration-300 z-50 pointer-events-none ${tooltipPosition === 'top' ? 'bottom-full mb-2' : 'top-full mt-2'}`}>
                    {tooltip.header && (
                         <div className="px-3 py-1.5 bg-gray-700 rounded-t-lg font-semibold border-b border-gray-600">
                            {tooltip.header}
                        </div>
                    )}
                    <div className="p-3">{tooltip.content}</div>
                    <div className={`absolute left-1/2 -translate-x-[6px] w-3 h-3 bg-gray-800 transform rotate-45 ${tooltipPosition === 'top' ? 'bottom-[-6px]' : 'top-[-6px]'}`}></div>
                </div>
            </div>
        );
    }
    return content;
};

const HealthCheckItem = ({ icon, color, title, items }) => (
    <div className="relative group flex items-center space-x-2">
        {icon}
        <div>
            <p className={`font-bold text-lg ${color}`}>{items.length}</p>
            <p className="text-xs text-gray-500">{title}</p>
             </div>
        <div className="absolute left-0 bottom-full mb-2 w-72 p-3 bg-gray-800 text-white text-xs rounded-lg shadow-lg opacity-0 group-hover:opacity-100 transition-opacity duration-300 z-10 pointer-events-none">
            <h4 className="font-bold mb-2 border-b border-gray-600 pb-1">{title} Found</h4>
            <ul className="space-y-1">
                {items.map((item, index) => <li key={index}>- {item.description}</li>)}
            </ul>
            {items.length === 0 && <p className="text-gray-400">No issues found.</p>}
                </div>
            </div>
        );

const BooleanCheck = ({ value, tooltipContent }) => {
    const check = value ? 
        <CheckCircle className="w-6 h-6 text-green-500 mx-auto cursor-pointer" /> : 
        <XCircle className="w-6 h-6 text-red-500 mx-auto cursor-pointer" />;
    const ContentTooltip = ({ content, children }) => (
         <div className="relative group/content flex justify-center">
            {children}
            <div className="absolute left-1/2 -translate-x-1/2 bottom-full mb-2 w-80 p-3 bg-gray-800 text-white text-xs rounded-lg shadow-lg opacity-0 group-hover/content:opacity-100 transition-opacity duration-300 z-10 pointer-events-none">
                {content ? content : <span className="text-gray-400">Not Found</span>}
            </div>
        </div>
    );
    if (tooltipContent) {
        return <ContentTooltip content={tooltipContent}>{check}</ContentTooltip>
    }
    return check;
};

const formatDate = (dateString) => {
    if (!dateString) return null;
        const date = new Date(dateString);
    if (isNaN(date.getTime())) return dateString; // Return original if invalid
    return date.toLocaleDateString('en-GB', { day: '2-digit', month: 'short', year: 'numeric' });
};

const checkCategories = {
    performance: {
        title: "Performance",
        icon: "⚡",
        checks: { high_loading_time: "Page loads quickly", high_waiting_time: "Server responds quickly", has_render_blocking_resources: "No render-blocking resources", size_greater_than_3mb: "Page size is optimized", small_page_size: "Page is lightweight", large_page_size: "Page size is reasonable" }
    },
    security: {
        title: "Security & Technical",
        icon: "🔒",
        checks: { is_https: "Uses secure HTTPS connection", is_http: "HTTP connection available", is_www: "WWW configuration correct", has_html_doctype: "Proper HTML structure", no_doctype: "DOCTYPE declaration present", canonical: "Canonical URL defined", flash: "No Flash content (deprecated)", frame: "No frame usage (outdated)", has_favicon: "Favicon present" }
    },
    content: {
        title: "Content Quality",
        icon: "📝",
        checks: { low_content_rate: "Sufficient content density", high_content_rate: "Content not overly dense", low_character_count: "Adequate content length", high_character_count: "Content length appropriate", low_readability_rate: "Content is readable", lorem_ipsum: "No placeholder content" }
    },
    seo: {
        title: "SEO Optimization",
        icon: "🎯",
        checks: { has_meta_title: "Meta title present", title_too_long: "Title length optimal", title_too_short: "Title length sufficient", no_title: "Title tag implemented", has_micromarkup: "Rich snippets implemented", has_micromarkup_errors: "Rich snippets valid", irrelevant_title: "Title is relevant", irrelevant_description: "Description is relevant", irrelevant_meta_keywords: "Keywords are relevant", no_description: "Meta description present", duplicate_meta_tag: "No duplicate meta tags", duplicate_title_tag: "No duplicate titles", seo_friendly_url: "URLs are SEO-friendly", seo_friendly_url_characters_check: "URL characters valid", seo_friendly_url_dynamic_check: "URLs not dynamic", seo_friendly_url_keywords_check: "URLs contain keywords", seo_friendly_url_relative_length_check: "URL length appropriate" }
    },
    accessibility: {
        title: "Accessibility",
        icon: "♿",
        checks: { no_image_alt: "Images have alt text", no_image_title: "Images have titles", deprecated_html_tags: "Modern HTML used", no_h1_tag: "Main heading present" }
    }
};

/* ------------------------------------------------------------------ */
/* WEBSITE STATS – Modern SEO Dashboard Design                        */
/* ------------------------------------------------------------------ */
const WebsiteStats = ({ data, webhooks, setData }) => {
    const { ResponsiveContainer, BarChart, Bar, XAxis, YAxis, Tooltip, CartesianGrid, Cell, RadialBarChart, RadialBar, Legend, PieChart, Pie, LineChart, Line, Area, AreaChart } = window.Recharts;
    
    // Refresh state management
    const [isRefreshing, setIsRefreshing] = useState(false);
    const [refreshProgress, setRefreshProgress] = useState(0);
    const [refreshMessage, setRefreshMessage] = useState('');
    const [lastRefresh, setLastRefresh] = useState(null);
    const pollIntervalRef = useRef(null);
    const refreshStartTimeRef = useRef(null);

    // Cleanup polling on unmount
    useEffect(() => {
        return () => {
            if (pollIntervalRef.current) {
                clearInterval(pollIntervalRef.current);
            }
        };
    }, []);

    // Refresh functionality
    const triggerRefresh = async () => {
        console.log('Webhooks data:', webhooks);
        console.log('All data keys:', Object.keys(data || {}));
        
        // Check for both required webhooks
        const hasOnPageInsights = webhooks && webhooks['On-Page Insights'];
        const hasWebsiteFullScan = webhooks && webhooks['Website Full Scan'];
        
        if (!hasOnPageInsights && !hasWebsiteFullScan) {
            alert('Website refresh webhooks not configured for this workbook');
            console.log('Webhook check failed. Webhooks:', webhooks);
            return;
        }

        setIsRefreshing(true);
        setRefreshProgress(5);
        setRefreshMessage('Full scan underway, check back in 10 minutes...');
        refreshStartTimeRef.current = Date.now();

        try {
            // Get the workbook ID from URL parameters
            const params = new URLSearchParams(window.location.search);
            const workbookId = params.get('workbookId');
            
            if (!workbookId) {
                throw new Error('No workbook ID found in URL');
            }

            const webhookPromises = [];
            
            // Trigger On-Page Insights webhook if available
            if (hasOnPageInsights) {
                const onPageWebhookUrl = `${webhooks['On-Page Insights']}?spreadsheetId=${workbookId}&tabName=${encodeURIComponent('On-Page Insights')}`;
                console.log('Triggering On-Page Insights webhook:', onPageWebhookUrl);
                
                webhookPromises.push(
                    fetch(onPageWebhookUrl, {
                method: 'GET',
                        mode: 'no-cors'
                    }).catch(error => console.error('On-Page Insights webhook error:', error))
                );
            }
            
            // Trigger Website Full Scan webhook if available
            if (hasWebsiteFullScan) {
                const fullScanWebhookUrl = `${webhooks['Website Full Scan']}?spreadsheetId=${workbookId}&tabName=${encodeURIComponent('On-Page Insights')}`;
                console.log('Triggering Website Full Scan webhook:', fullScanWebhookUrl);
                
                webhookPromises.push(
                    fetch(fullScanWebhookUrl, {
                        method: 'GET',
                        mode: 'no-cors'
                    }).catch(error => console.error('Website Full Scan webhook error:', error))
                );
            }
            
            // Wait for all webhooks to be triggered
            await Promise.allSettled(webhookPromises);
            
            // Show success message
            console.log('Website scan webhooks triggered successfully!');
            
            setRefreshProgress(15);
            setRefreshMessage('Full scan underway, check back in 10 minutes...');
            
            // Start polling for data changes
            startPolling();
            
        } catch (error) {
            console.error('Error triggering website refresh:', error);
            setIsRefreshing(false);
            setRefreshProgress(0);
            setRefreshMessage('');
            alert(`Failed to trigger website scan: ${error.message}`);
        }
    };

    const startPolling = () => {
        let attempts = 0;
        const maxAttempts = 11; // Poll for ~11 minutes (60s intervals) for full website scan
        
        const poll = async () => {
            attempts++;
            const elapsed = (Date.now() - refreshStartTimeRef.current) / 1000;
            const progress = Math.min(15 + (attempts * 7), 95); // Spread progress over 11 attempts
            
            setRefreshProgress(progress);
            
            // Updated messaging for longer automation
            let message;
            if (elapsed < 300) { // First 5 minutes
                message = `Full scan underway, check back in 10 minutes...`;
            } else if (elapsed < 600) { // 5-10 minutes
                message = `Analyzing website data...`;
            } else { // 10+ minutes
                message = `Finalizing AI report...`;
            }
            setRefreshMessage(message);
            
            try {
                // Check if data has been updated by fetching fresh data
                const params = new URLSearchParams(window.location.search);
                const workbookId = params.get('workbookId');
                
                if (workbookId) {
                    const scriptUrl = `https://script.google.com/macros/s/AKfycbxfOMp8d_eCVH4lFD0PNuFU1wH-gyWOwRt2EuME7GQJ4U73ZwpPDciohDH3C566YLWq/exec?workbookId=${workbookId}`;
                    
                    const response = await fetch(scriptUrl);
                    const newData = await response.json();
                    
                    // Check specifically for AI Report and other key changes
                    if (newData.websiteStats && hasDataChanged(data, newData.websiteStats)) {
                        // Data has changed! Stop polling and update in-place
                        clearInterval(pollIntervalRef.current);
                        setRefreshProgress(100);
                        setRefreshMessage('Website scan complete! Loading fresh data...');
                        
                        // Update the data in-place instead of page reload
                        setData(newData);
                        setLastRefresh(new Date());
                        
                        // Clear refresh state after a brief success message
                        setTimeout(() => {
                            setIsRefreshing(false);
                            setRefreshProgress(0);
                            setRefreshMessage('');
                        }, 2000);
                        return;
                    }
                }
            } catch (error) {
                console.error('Error polling for updates:', error);
            }
            
            // Stop polling after max attempts
            if (attempts >= maxAttempts) {
                clearInterval(pollIntervalRef.current);
                setIsRefreshing(false);
                setRefreshProgress(0);
                setRefreshMessage('');
                
                // Try one final check for updates
                try {
                    const params = new URLSearchParams(window.location.search);
                    const workbookId = params.get('workbookId');
                    
                    if (workbookId) {
                        const scriptUrl = `https://script.google.com/macros/s/AKfycbxfOMp8d_eCVH4lFD0PNuFU1wH-gyWOwRt2EuME7GQJ4U73ZwpPDciohDH3C566YLWq/exec?workbookId=${workbookId}`;
                        
                        fetch(scriptUrl)
                            .then(response => response.json())
                            .then(finalData => {
                                if (finalData.websiteStats) {
                                    setData(finalData);
                                    setLastRefresh(new Date());
                                    console.log('Final data update applied');
                                }
                            })
                            .catch(e => console.log('Final check failed:', e));
                    }
                } catch (error) {
                    console.error('Error in final update check:', error);
                }
            }
        };
        
        // Start with immediate poll, then continue with 60-second intervals for full website scan
        pollIntervalRef.current = setInterval(poll, 60000);
        
        // Poll immediately to start
        poll();
    };

    const hasDataChanged = (oldData, newData) => {
        // Primary check: Has the AI error report been generated? This indicates completion
        const oldErrorReport = oldData.websiteStats?.errorReport;
        const newErrorReport = newData.websiteStats?.errorReport;
        
        // Check if AI error report has meaningful content (not just empty/placeholder)
        const hasAiErrorReport = newErrorReport && 
                                String(newErrorReport).trim() !== '' &&
                                String(newErrorReport).trim().length > 50; // Ensure substantial content
        
        // Log AI Error Report comparison for debugging
        console.log('Website AI Error Report comparison:', {
            old: oldErrorReport,
            new: newErrorReport,
            hasAiErrorReport: hasAiErrorReport,
            newLength: newErrorReport?.length || 0,
            changed: oldErrorReport !== newErrorReport
        });
        
        // Additional validation: Check if we have meaningful data updates
        const hasOtherChanges = (
            // Check other key metrics as backup indicators
            oldData.websiteStats?.healthData?.pageScore !== newData.websiteStats?.healthData?.pageScore ||
            oldData.websiteStats?.healthData?.siteSpeed !== newData.websiteStats?.healthData?.siteSpeed ||
            JSON.stringify(oldData.websiteStats?.healthData?.speedDetails) !== JSON.stringify(newData.websiteStats?.healthData?.speedDetails) ||
            // Check if crawl summary has been updated
            oldData.websiteStats?.healthData?.brokenLinks !== newData.websiteStats?.healthData?.brokenLinks
        );
        
        // Consider complete when AI error report is generated (primary indicator)
        const hasChanges = hasAiErrorReport || hasOtherChanges;
        
        console.log('Website scan completion check:', {
            hasAiErrorReport: hasAiErrorReport,
            hasOtherChanges: hasOtherChanges,
            overallChanged: hasChanges
        });
        
        return hasChanges;
    };

    const cancelRefresh = () => {
        if (pollIntervalRef.current) {
            clearInterval(pollIntervalRef.current);
        }
        setIsRefreshing(false);
        setRefreshProgress(0);
        setRefreshMessage('');
    };

    if (!data) {
        return (
            <PageContent>
                <div className="p-8 text-center text-gray-500">
                    <div className="flex flex-col items-center space-y-3">
                        <div className="w-6 h-6 border-2 border-blue-500 border-t-transparent rounded-full animate-spin"></div>
                        <div>Loading Website Stats…</div>
                    </div>
                </div>
            </PageContent>
        );
    }

    const { healthData, competitorPerfData: rawCompetitorPerfData, technicalSeoData, brokenLinksDetails } = data;
    
    // AI Report handling
    let aiReport = null;
    try {
        const aiNotes = healthData?.aiNotes;
        if (aiNotes !== null && aiNotes !== undefined) {
            const cleanedNotes = String(aiNotes).trim();
            if (cleanedNotes && !['true', 'false'].includes(cleanedNotes.toLowerCase())) {
                aiReport = cleanedNotes;
            }
        }
    } catch (error) {
        console.error('Error processing AI Notes:', error);
    }

    // Enhanced competitor data processing - ALL data is in milliseconds, convert to seconds
    const competitorPerfData = (rawCompetitorPerfData || []).map(comp => {
        // Process site speed - ALL data comes in milliseconds, always convert to seconds
        let siteSpeedSeconds = 0;
        const rawSpeed = String(comp['Site Speed (s)'] || '0');
        
        if (rawSpeed && rawSpeed !== '0') {
            // Remove any non-numeric characters except decimal points
            const numericSpeed = parseFloat(rawSpeed.replace(/[^\d.]/g, '')) || 0;
            
            // ALL data is in milliseconds, always convert to seconds
            siteSpeedSeconds = numericSpeed / 1000;
        }
        
        return {
            name: comp.name || 'Unknown',
            isClient: comp.isClient || false,
            'Site Speed (seconds)': parseFloat(siteSpeedSeconds.toFixed(3)), // Round to 3 decimal places
            'Est. Monthly Traffic': parseInt(String(comp['Est. Monthly Traffic'] || '0').replace(/,/g, ''), 10) || 0,
            'Referring Domains': parseInt(String(comp['Referring Domains'] || '0').replace(/,/g, ''), 10) || 0,
            'Total Backlinks': parseInt(String(comp['Total Backlinks'] || '0').replace(/,/g, ''), 10) || 0
        };
    });

    // Enhanced color schemes
    const getScoreColor = (score) => {
        if (score >= 90) return { primary: '#10b981', secondary: '#065f46', bg: 'from-emerald-500 to-green-600' };
        if (score >= 70) return { primary: '#f59e0b', secondary: '#92400e', bg: 'from-yellow-500 to-orange-500' };
        return { primary: '#ef4444', secondary: '#991b1b', bg: 'from-red-500 to-red-600' };
    };

    const scoreColors = getScoreColor(healthData.pageScore);
    // Speed processing for status calculation - ALL data is in milliseconds
    const rawSpeedValue = parseFloat(String(healthData.siteSpeed).replace(/[^\d.]/g, '')) || 0;
    const speedSec = rawSpeedValue / 1000; // Always convert from milliseconds to seconds
    
    const speedStatus = speedSec < 1.5 ? 'excellent' : speedSec < 3 ? 'good' : 'error';
    
    const brokenLinksCount = Number(healthData.brokenLinks) || 0;
    const hasBrokenLinks = brokenLinksCount > 0;
    // Prefer whole-site aggregate from Website Crawl Pages if available; fallback to legacy single-row checks
    const aggregate = healthData.checksAggregate;
    const checksPassed = aggregate ? (aggregate.totalPassed || 0) : (healthData.checks.checksPassed || 0);
    const checksTotal = aggregate ? (aggregate.totalChecks || 0) : (healthData.checks.totalChecks || 0);
    const checksPercentage = checksTotal > 0 ? (checksPassed / checksTotal) * 100 : 0;

    // Enhanced gradient colors for charts
    const GRADIENT_COLORS = [
        { client: '#3b82f6', competitor: '#7c3aed' },
        { client: '#10b981', competitor: '#8b5cf6' },
        { client: '#f59e0b', competitor: '#6d28d9' },
        { client: '#8b5cf6', competitor: '#7c3aed' },
        { client: '#ec4899', competitor: '#db2777' },
        { client: '#06b6d4', competitor: '#0891b2' }
    ];

    // Enhanced metric cards with smart tooltip positioning
            const ModernMetricCard = ({ title, value, subtitle, icon, status, trend, details, tooltip, alwaysShowDetails, categoryBreakdown }) => {
            const cardRef = useRef(null);
            const [tooltipPosition, setTooltipPosition] = useState('center-top');
            const [showTooltip, setShowTooltip] = useState(false);
            const hoverTimeoutRef = useRef(null);

        useEffect(() => {
            if (!tooltip || !cardRef.current) return;

            const handleMouseEnter = () => {
                // Clear any existing timeout
                if (hoverTimeoutRef.current) {
                    clearTimeout(hoverTimeoutRef.current);
                }
                
                // Add a small delay to prevent accidental triggers
                hoverTimeoutRef.current = setTimeout(() => {
                    const cardRect = cardRef.current?.getBoundingClientRect();
                    if (!cardRect) return;
                    
                    const tooltipWidth = tooltip.width === 'large' ? 600 : 320;
                    const viewportWidth = window.innerWidth;
                    const viewportHeight = window.innerHeight;
                    
                    // Calculate if tooltip would overflow horizontally
                    const tooltipLeft = cardRect.left + cardRect.width / 2 - tooltipWidth / 2;
                    const tooltipRight = tooltipLeft + tooltipWidth;
                    
                    // Calculate if tooltip would overflow vertically
                    const estimatedTooltipHeight = tooltip.width === 'large' ? 400 : 200;
                    const spaceAbove = cardRect.top;
                    const spaceBelow = viewportHeight - cardRect.bottom;
                    
                    let position = 'center-top';
                    
                    // Determine horizontal positioning
                    if (tooltipLeft < 20) {
                        position = 'left-top';
                    } else if (tooltipRight > viewportWidth - 20) {
                        position = 'right-top';
                    }
                    
                    // Determine vertical positioning
                    if (spaceAbove < estimatedTooltipHeight && spaceBelow > spaceAbove) {
                        position = position.replace('-top', '-bottom');
                    }
                    
                    setTooltipPosition(position);
                    setShowTooltip(true);
                }, 200); // 200ms delay
            };

            const handleMouseLeave = () => {
                // Clear timeout and hide tooltip
                if (hoverTimeoutRef.current) {
                    clearTimeout(hoverTimeoutRef.current);
                }
                setShowTooltip(false);
            };

            const cardElement = cardRef.current;
            cardElement.addEventListener('mouseenter', handleMouseEnter);
            cardElement.addEventListener('mouseleave', handleMouseLeave);
            
            return () => {
                if (cardElement) {
                    cardElement.removeEventListener('mouseenter', handleMouseEnter);
                    cardElement.removeEventListener('mouseleave', handleMouseLeave);
                }
                if (hoverTimeoutRef.current) {
                    clearTimeout(hoverTimeoutRef.current);
                }
            };
        }, [tooltip]);

        // Generate tooltip classes based on position
        const getTooltipClasses = () => {
            const baseClasses = `absolute ${tooltip?.width === 'large' ? 'w-[600px]' : 'w-80'} bg-gray-900 text-white text-sm rounded-xl shadow-2xl transition-all duration-300 z-50 pointer-events-none ${showTooltip ? 'opacity-100' : 'opacity-0'}`;
            
                         switch (tooltipPosition) {
                 case 'left-top':
                     return `${baseClasses} left-0 bottom-full mb-1`;
                 case 'right-top':
                     return `${baseClasses} right-0 bottom-full mb-1`;
                 case 'center-bottom':
                     return `${baseClasses} left-1/2 -translate-x-1/2 top-full mt-1`;
                 case 'left-bottom':
                     return `${baseClasses} left-0 top-full mt-1`;
                 case 'right-bottom':
                     return `${baseClasses} right-0 top-full mt-1`;
                 default: // center-top
                     return `${baseClasses} left-1/2 -translate-x-1/2 bottom-full mb-1`;
             }
        };

        // Generate arrow classes based on position
        const getArrowClasses = () => {
            const isBottom = tooltipPosition.includes('bottom');
            const arrowBase = 'absolute w-0 h-0';
            
            if (isBottom) {
                // Arrow pointing up (tooltip below card)
                const arrowColor = 'border-b-[8px] border-l-[8px] border-r-[8px] border-l-transparent border-r-transparent border-b-gray-900';
                if (tooltipPosition.includes('left')) {
                    return `${arrowBase} ${arrowColor} left-4 bottom-full`;
                } else if (tooltipPosition.includes('right')) {
                    return `${arrowBase} ${arrowColor} right-4 bottom-full`;
                } else {
                    return `${arrowBase} ${arrowColor} left-1/2 -translate-x-1/2 bottom-full`;
                }
            } else {
                // Arrow pointing down (tooltip above card)
                const arrowColor = 'border-t-[8px] border-l-[8px] border-r-[8px] border-l-transparent border-r-transparent border-t-gray-900';
                if (tooltipPosition.includes('left')) {
                    return `${arrowBase} ${arrowColor} left-4 top-full`;
                } else if (tooltipPosition.includes('right')) {
                    return `${arrowBase} ${arrowColor} right-4 top-full`;
                } else {
                    return `${arrowBase} ${arrowColor} left-1/2 -translate-x-1/2 top-full`;
                }
            }
        };


        
        // Determine icon styling based on status
        const iconClasses = status === 'excellent' ? 'bg-green-100 text-green-600' : 
            status === 'good' ? 'bg-green-100 text-green-600' : 
            status === 'warning' ? 'bg-yellow-100 text-yellow-600' : 
            status === 'error' ? 'bg-red-100 text-red-600' : 'bg-blue-100 text-blue-600';
        
        return (
            <div ref={cardRef} className="bg-white rounded-2xl shadow-lg hover:shadow-xl transition-all duration-300 p-6 border border-gray-100 hover:border-blue-200/60 group relative hover:-translate-y-0.5 will-change-transform group-hover:z-50">
                <div className="flex items-start justify-between mb-4">
                    <div className={`p-3 rounded-xl ${iconClasses}`}>
                        {icon}
                    </div>
                    {trend && (
                        <div className={`flex items-center text-sm ${trend.direction === 'up' ? 'text-green-600' : 'text-red-600'}`}>
                            {trend.direction === 'up' ? <ArrowUp className="w-4 h-4 mr-1" /> : <ArrowDown className="w-4 h-4 mr-1" />}
                            {trend.value}
                        </div>
                    )}
                </div>
                <h3 className="text-gray-600 text-sm font-medium mb-2">{title}</h3>
                <p className="text-2xl font-bold text-gray-900 mb-1">{value}</p>
                {subtitle && <p className="text-sm text-gray-500">{subtitle}</p>}
                
                                 {/* Always show details for certain cards */}
                {details && alwaysShowDetails && (
                    <div className="mt-4 pt-4 border-t border-gray-100">
                        <div className="grid grid-cols-2 gap-2 text-xs">
                            {Object.entries(details).slice(0, 10).map(([key, val]) => {
                                // Convert technical terms to user-friendly labels
                                const friendlyLabels = {
                                    'Time to Interactive': 'Time to Interactive',
                                    'DOM Complete': 'Page Structure Ready',
                                    'Largest Contentful Paint': 'Main Content Loaded',
                                    'First Input Delay': 'Response Time',
                                    'Connection Time': 'Server Connection',
                                    'Time to Secure Connection': 'Security Setup',
                                    'Request Sent Time': 'Request Processing',
                                    'Waiting Time (TTFB)': 'Server Response',
                                    'Download Time': 'Content Download',
                                    'Full Page Load': 'Complete Load Time'
                                };
                                const displayLabel = friendlyLabels[key] || key;
                                
                                return (
                                    <div key={key} className="flex justify-between">
                                        <span className="text-gray-500">{displayLabel}:</span>
                                        <span className="font-medium">{val || 'N/A'}</span>
                                    </div>
                                );
                            })}
                        </div>
                    </div>
                )}
                
                {/* Category breakdown for technical checks */}
                {categoryBreakdown && (
                    <div className="mt-4 pt-4 border-t border-gray-100">
                        <div className="grid grid-cols-1 gap-2">
                            {categoryBreakdown.map((category, index) => (
                                <div key={index} className="flex items-center justify-between text-xs">
                                    <div className="flex items-center">
                                        <span className="mr-2">{category.icon}</span>
                                        <span className="text-gray-600">{category.title}</span>
                                    </div>
                                    <div className="flex items-center">
                                        <span className={`mr-1 ${category.hasErrors ? 'text-red-500' : 'text-green-500'}`}>
                                            {category.hasErrors ? '❌' : '✅'}
                                        </span>
                                        <span className="text-gray-500">{category.passed}/{category.total}</span>
                                    </div>
                                </div>
                            ))}
                        </div>
                    </div>
                )}
                
                {/* Hover-only details for cards without alwaysShowDetails */}
                {details && !alwaysShowDetails && !categoryBreakdown && (
                    <div className="mt-4 pt-4 border-t border-gray-100 opacity-0 group-hover:opacity-100 transition-opacity">
                        <div className="grid grid-cols-2 gap-2 text-xs">
                            {Object.entries(details).slice(0, 4).map(([key, val]) => (
                                <div key={key} className="flex justify-between">
                                    <span className="text-gray-500">{key}:</span>
                                    <span className="font-medium">{val || 'N/A'}</span>
                                </div>
                            ))}
                        </div>
                    </div>
                )}
                {/* Smart Positioned Tooltip - Only show on direct card hover */}
                {tooltip && (
                    <div className={getTooltipClasses() + ' z-[9999]'} style={{maxWidth: 'min(95vw, 600px)', width: tooltip?.width === 'large' ? '600px' : '320px', pointerEvents: 'auto'}}>
                        {tooltip.header && (
                            <div className="px-4 py-3 bg-gray-800 rounded-t-xl font-semibold border-b border-gray-700">
                                {tooltip.header}
                            </div>
                        )}
                        <div className="p-4">{tooltip.content}</div>
                        <div className={getArrowClasses()}></div>
                    </div>
                )}
            </div>
        );
    };

    // Modern warnings/errors display with tooltips
    const ModernIssueCounter = ({ icon, color, title, items, textColor }) => (
        <div className="text-center relative group cursor-help">
            <div className="flex items-center justify-center mb-2">
                {icon}
                <span className={`text-2xl font-bold ${textColor} ml-2`}>{items.length}</span>
            </div>
            <p className="text-sm text-gray-600">{title}</p>
            
            {/* Modern Tooltip */}
            <div className="absolute left-1/2 -translate-x-1/2 bottom-full mb-3 w-80 bg-gray-900 text-white text-sm rounded-xl shadow-2xl opacity-0 group-hover:opacity-100 transition-all duration-300 z-50 pointer-events-none">
                <div className="px-4 py-3 bg-gray-800 rounded-t-xl font-semibold border-b border-gray-700">
                    {title} Found ({items.length})
                </div>
                <div className="p-4 max-h-48 overflow-y-auto">
                    {items.length > 0 ? (
                        <ul className="space-y-2">
                            {items.map((item, index) => (
                                <li key={index} className="flex items-start text-xs leading-relaxed">
                                    <span className="mr-2 mt-1 w-1 h-1 bg-gray-400 rounded-full flex-shrink-0"></span>
                                    <span>{item.description}</span>
                                </li>
                            ))}
                        </ul>
                    ) : (
                        <p className="text-gray-400 text-xs">No issues found.</p>
                    )}
                </div>
                <div className="absolute left-1/2 -translate-x-1/2 top-full w-0 h-0 border-l-[8px] border-r-[8px] border-t-[8px] border-l-transparent border-r-transparent border-t-gray-900"></div>
            </div>
        </div>
    );
        // Enhanced gauge component with smooth animation
    const ModernGauge = ({ score, size = 200 }) => {
        const [isDisableTransition, setIsDisableTransition] = useState(false);
        const [isAnimationCooldown, setIsAnimationCooldown] = useState(false);
        const [hasInitialized, setHasInitialized] = useState(false);
        const [lastScore, setLastScore] = useState(score);
        const circumference = 2 * Math.PI * 85;
        const strokeDasharray = circumference;
        
        // Get score colors for this specific score
        const scoreColors = getScoreColor(score);
        
        // Cap visual progress to ensure there's always a small gap (max 96.5% visual)
        const visualScore = Math.min(score, 96.5);
        const targetOffset = circumference - (visualScore / 100) * circumference;
        
        // Animation state - start empty, animate to target
        const [currentOffset, setCurrentOffset] = useState(circumference);
        
        useEffect(() => {
            // Only animate on initial load or significant score changes
            if (!hasInitialized) {
                const timer = setTimeout(() => {
                    setCurrentOffset(targetOffset);
                    setHasInitialized(true);
                    setLastScore(score);
                }, 500);
                return () => clearTimeout(timer);
            } else if (Math.abs(score - lastScore) > 0.5) {
                // Only re-animate if score changed significantly
                setCurrentOffset(targetOffset);
                setLastScore(score);
            }
        }, [targetOffset, hasInitialized, score, lastScore]);

        const isDarkMode = document.documentElement.getAttribute('data-theme') === 'dark';

        const handleHover = () => {
            if (isAnimationCooldown) return;
            setIsAnimationCooldown(true);

            // Reset instantly (no transition)
            setIsDisableTransition(true);
            setCurrentOffset(circumference);

            // Let the DOM apply, then animate to target with transition
            requestAnimationFrame(() => {
                setIsDisableTransition(false);
                setCurrentOffset(targetOffset);
            });

            // Cool-down before allowing another replay
            setTimeout(() => setIsAnimationCooldown(false), 1200);
        };

        return (
            <div className="relative flex flex-col items-center">
                <div 
                    className="relative cursor-pointer" 
                    style={{ width: size, height: size }}
                    onMouseEnter={handleHover}
                >
                    <svg width={size} height={size} className="transform -rotate-90">
                        <defs>
                            <linearGradient id="gaugeGradient" x1="0%" y1="0%" x2="100%" y2="100%">
                                <stop offset="0%" stopColor={scoreColors.primary} />
                                <stop offset="100%" stopColor={scoreColors.secondary} />
                            </linearGradient>
                        </defs>
                        {/* Background circle */}
                        <circle
                            cx={size / 2}
                            cy={size / 2}
                            r="85"
                            fill="transparent"
                            stroke={isDarkMode ? '#1E293B' : '#f3f4f6'}
                            strokeWidth="12"
                        />
                        {/* Progress circle */}
                        <circle
                            cx={size / 2}
                            cy={size / 2}
                            r="85"
                            fill="transparent"
                            stroke="url(#gaugeGradient)"
                            strokeWidth="12"
                            strokeDasharray={strokeDasharray}
                            strokeDashoffset={currentOffset}
                            strokeLinecap="butt"
                            className={isDisableTransition ? '' : 'transition-all duration-1000 ease-out'}
                                                                    style={{ 
                                filter: 'drop-shadow(0 2px 4px rgba(0,0,0,0.1))'
                            }}
                        />
                    </svg>
                    <div className="absolute inset-0 flex flex-col items-center justify-center">
                        <span className="text-4xl font-bold text-gray-900">{score.toFixed(1)}</span>
                        <span className="text-sm text-gray-500 font-medium">out of 100</span>
                    </div>
                    {/* Subtle pulse effect on hover */}
                    <div className="absolute inset-0 rounded-full bg-gradient-to-r from-blue-500/5 to-green-500/5 opacity-0 group-hover:opacity-100 transition-opacity duration-300"></div>
                </div>
                <div className="mt-4 text-center">
                    <div className="flex items-center justify-center space-x-2">
                        <h3 className="text-lg font-semibold text-gray-900">Website Health Score</h3>
                        <div className="relative group">
                            <Info className="w-4 h-4 text-gray-400 cursor-help" />
                            <div className="absolute left-1/2 -translate-x-1/2 bottom-full mb-2 w-80 p-3 bg-gray-800 text-white text-xs rounded-lg shadow-lg opacity-0 group-hover:opacity-100 transition-opacity duration-300 z-30 pointer-events-none">
                                <div className="font-semibold mb-2 border-b border-gray-600 pb-2">Website Health Score</div>
                                <div>The score starts at 100 and deducts weighted points for any critical errors (e.g. slow load, insecure HTTP, broken links) and lesser warnings (e.g. missing meta tags, large page size).</div>
                                <div className="absolute left-1/2 -translate-x-1/2 top-full w-0 h-0 border-l-[6px] border-r-[6px] border-t-[6px] border-l-transparent border-r-transparent border-t-gray-800"></div>
                            </div>
                        </div>
                    </div>
                    <p className={`text-sm font-medium ${score >= 90 ? 'text-green-600' : score >= 70 ? 'text-yellow-600' : 'text-red-600'}`}>
                        {score >= 90 ? 'Excellent' : score >= 70 ? 'Good' : 'Needs Improvement'}
                    </p>
                </div>
            </div>
        );
    };

    // Modern comparison chart with value labels and color legend
    const ModernComparisonChart = ({ data, dataKey, title, color, isInverted = false }) => {
        const { LabelList } = window.Recharts;
        
        // Smart Y-axis calculation
        const getSmartYAxisConfig = (data, dataKey) => {
            const maxValue = Math.max(...data.map(item => item[dataKey] || 0));
            
            if (dataKey === 'Site Speed (seconds)') {
                // For seconds: 0.15, 0.30, 0.45, then max or 0.60
                const suggestedMax = Math.max(0.60, Math.ceil(maxValue * 6.67) / 6.67);
                const ticks = [0, 0.15, 0.30, 0.45, suggestedMax];
                return {
                    domain: [0, suggestedMax],
                    ticks: ticks,
                    tickFormatter: (value) => `${value.toFixed(2)}s`
                };
            } else if (dataKey.includes('Traffic')) {
                // For traffic: smart increments based on max value
                let increment, suggestedMax;
                if (maxValue <= 1000) {
                    increment = 250;
                    suggestedMax = Math.max(1000, Math.ceil(maxValue / increment) * increment);
                } else if (maxValue <= 5000) {
                    increment = 1000;
                    suggestedMax = Math.ceil(maxValue / increment) * increment;
                } else if (maxValue <= 20000) {
                    increment = 5000;
                    suggestedMax = Math.ceil(maxValue / increment) * increment;
                } else {
                    increment = 10000;
                    suggestedMax = Math.ceil(maxValue / increment) * increment;
                }
                const ticks = [0, increment, increment * 2, increment * 3, suggestedMax];
                return {
                    domain: [0, suggestedMax],
                    ticks: ticks,
                    tickFormatter: (value) => value >= 1000 ? `${(value / 1000).toFixed(0)}k` : value.toString()
                };
            } else if (dataKey.includes('Domains')) {
                // For referring domains: 20, 40, 60, 80, or based on max
                const increment = 20;
                const suggestedMax = Math.max(80, Math.ceil(maxValue / increment) * increment);
                const ticks = [0, increment, increment * 2, increment * 3, suggestedMax];
                return {
                    domain: [0, suggestedMax],
                    ticks: ticks,
                    tickFormatter: (value) => value.toString()
                };
            } else if (dataKey.includes('Backlinks')) {
                // For backlinks: 50, 100, 150, 200, or based on max
                let increment = 50;
                if (maxValue > 1000) increment = 250;
                else if (maxValue > 500) increment = 100;
                
                const suggestedMax = Math.max(200, Math.ceil(maxValue / increment) * increment);
                const ticks = [0, increment, increment * 2, increment * 3, suggestedMax];
                return {
                    domain: [0, suggestedMax],
                    ticks: ticks,
                    tickFormatter: (value) => value >= 1000 ? `${(value / 1000).toFixed(1)}k` : value.toString()
                };
            }
            
            // Default fallback
            return {
                domain: [0, 'dataMax * 1.1'],
                ticks: undefined,
                tickFormatter: (value) => value.toString()
            };
        };

        // Use consistent color mapping across all charts
        const getBusinessColors = () => {
            return data.map(business => {
                const colorInfo = getConsistentColor(business.name, business.isClient, data);
                return {
                    ...business,
                    colorInfo
                };
            });
        };

        const businessesWithColors = getBusinessColors();
        
        // Truncate name function
        const truncateName = (name, maxLength = 12) => {
            if (!name || typeof name !== 'string') return name || 'Unknown';
            if (name.length <= maxLength) return name;
            return name.substring(0, maxLength - 1) + '…';
        };
        
        // Custom label formatter for different data types
        const formatLabel = (value) => {
            if (dataKey === 'Site Speed (seconds)') {
                return `${value}s`;
            } else if (dataKey.includes('Traffic') || dataKey.includes('Backlinks') || dataKey.includes('Domains')) {
                return value >= 1000 ? `${(value / 1000).toFixed(1)}k` : value.toString();
            }
            return value.toString();
        };
        
        // Custom tooltip formatter with performance indicators
        const formatTooltip = (value, name, props) => {
            const entry = props.payload;
            const isClient = entry?.isClient;
            
            // Calculate average for comparison
            const average = data.reduce((sum, item) => sum + item[dataKey], 0) / data.length;
            const isAboveAverage = isInverted ? value < average : value > average;
            
            let formattedValue;
            let displayName;
            
            if (name === 'Site Speed (seconds)') {
                formattedValue = `${value} seconds`;
                displayName = 'Site Speed';
            } else if (name.includes('Traffic')) {
                formattedValue = value.toLocaleString();
                displayName = 'Monthly Traffic';
            } else if (name.includes('Domains')) {
                formattedValue = value.toLocaleString();
                displayName = 'Referring Domains';
            } else if (name.includes('Backlinks')) {
                formattedValue = value.toLocaleString();
                displayName = 'Total Backlinks';
            } else {
                formattedValue = value.toLocaleString();
                displayName = name;
            }
            
            const indicator = isAboveAverage ? '📈 Above Average' : '📉 Below Average';
            const clientBadge = isClient ? '⭐ Your Business' : '';
            
            return [
                <div key="tooltip">
                    <div style={{ fontWeight: 'bold' }}>{formattedValue}</div>
                    <div style={{ fontSize: '11px', opacity: 0.8 }}>{indicator}</div>
                    {clientBadge && <div style={{ fontSize: '11px', color: '#60a5fa' }}>{clientBadge}</div>}
                </div>,
                displayName
            ];
        };

        // Assign colors to each entry with truncated names
        const dataWithColors = businessesWithColors.map((entry, index) => { 
            const truncatedName = truncateName(entry.name);
            return { 
                ...entry, 
                name: truncatedName,
                gradientId: `business-gradient-${index}`, 
                color: entry.colorInfo.start,
                originalName: entry.name
            };
        });

        const yAxisConfig = getSmartYAxisConfig(data, dataKey);

        const isDarkMode = document.documentElement.getAttribute('data-theme') === 'dark';

        return (
            <div className="bg-white rounded-2xl shadow-lg hover:shadow-xl transition-all duration-300 p-6 border border-gray-100 hover:border-blue-200/60 group hover:-translate-y-0.5 will-change-transform">
                <div className="flex justify-between items-start mb-4">
                    <div>
                        <h3 className="text-lg font-semibold text-gray-900 mb-2">{title}</h3>
                        <p className="text-sm text-gray-500">
                            {isInverted ? 'Lower is better' : 'Higher is better'}
                            {dataKey === 'Site Speed (seconds)' && ' • Measured in seconds'}
                        </p>
                    </div>
                </div>
                <ResponsiveContainer width="100%" height={280}>
                    <BarChart data={dataWithColors} margin={{ top: 40, right: 30, left: 20, bottom: 20 }}>
                        <defs>
                            {/* Business gradients */}
                            {businessesWithColors.map((business, index) => (
                                <linearGradient key={`business-gradient-${index}`} id={`business-gradient-${index}`} x1="0" y1="0" x2="0" y2="1">
                                    <stop offset="0%" stopColor={business.colorInfo.gradientStart} />
                                    <stop offset="50%" stopColor={business.colorInfo.start} />
                                    <stop offset="100%" stopColor={business.colorInfo.gradientEnd} />
                                </linearGradient>
                            ))}
                        </defs>
                        {(!isDarkMode) && (
                          <CartesianGrid strokeDasharray="3 3" stroke="#f1f5f9" />
                        )}
                        {isDarkMode && (
                          <CartesianGrid stroke="transparent" />
                        )}
                        <XAxis 
                            dataKey="name" 
                            tick={{ fontSize: 12, fill: '#64748b', className: 'dark:!fill-[#94A3B8]' }}
                            height={40}
                            interval={0}
                        />
                        <YAxis 
                            tick={{ fontSize: 12, fill: '#64748b', className: 'dark:!fill-[#94A3B8]' }}
                            domain={yAxisConfig.domain}
                            ticks={yAxisConfig.ticks}
                            tickFormatter={yAxisConfig.tickFormatter}
                        />
                        <Tooltip 
                            contentStyle={{ 
                                backgroundColor: 'rgba(31, 41, 55, 0.95)', 
                                border: '1px solid #374151', 
                                borderRadius: '12px',
                                boxShadow: '0 20px 25px -5px rgb(0 0 0 / 0.1)',
                                color: '#fff'
                            }}
                            itemStyle={{ color: '#fff' }}
                            labelStyle={{ color: '#fff', fontWeight: 'bold' }}
                            formatter={formatTooltip}
                            cursor={{ fill: 'rgba(59, 130, 246, 0.04)' }}
                        />
                        <Bar dataKey={dataKey} radius={[6, 6, 0, 0]} barSize={40}>
                            {dataWithColors.map((entry, index) => (
                                <Cell 
                                    key={`cell-${index}`} 
                                    fill={`url(#${entry.gradientId})`}
                                />
                            ))}
                            <LabelList 
                                dataKey={dataKey} 
                                position="top" 
                                style={{ fontSize: 12, fill: isDarkMode ? '#94A3B8' : '#64748b', fontWeight: 400 }}
                                formatter={formatLabel}
                            />
                        </Bar>
                    </BarChart>
                </ResponsiveContainer>
                
                {/* Color Legend at Bottom */}
                <div className="mt-4 pt-4 border-t border-gray-100">
                    <div className="flex flex-col items-center space-y-2">
                        {/* Top row - 3 items */}
                        <div className="flex justify-center space-x-6">
                            {dataWithColors.slice(0, 3).map((entry, index) => (
                                <div key={index} className="flex items-center space-x-2 min-w-0">
                                    <div 
                                        className="w-3 h-3 rounded shadow-sm flex-shrink-0" 
                                        style={{ backgroundColor: entry.color }}
                                                                ></div>
                                    <span className="text-xs text-gray-600 font-medium truncate" title={entry.originalName}>
                                        {truncateName(entry.originalName, 14)}
                                                                    {entry.isClient && ' ⭐'}
                                                                </span>
                                                            </div>
                                                ))}
                                </div>
                        {/* Bottom row - 2 items (if they exist) */}
                        {dataWithColors.length > 3 && (
                            <div className="flex justify-center space-x-6">
                                {dataWithColors.slice(3).map((entry, index) => (
                                    <div key={index + 3} className="flex items-center space-x-2 min-w-0">
                                        <div 
                                            className="w-3 h-3 rounded shadow-sm flex-shrink-0" 
                                            style={{ backgroundColor: entry.color }}
                                        ></div>
                                        <span className="text-xs text-gray-600 font-medium truncate" title={entry.originalName}>
                                            {truncateName(entry.originalName, 14)}
                                            {entry.isClient && ' ⭐'}
                                        </span>
            </div>
                                ))}
                        </div>
                        )}
                    </div>
                </div>
            </div>
        );
    };
    return (
        <PageContent>
            {/* Header Section */}
            <div className="mb-8">
                <div className="flex justify-between items-center">
                    <div>
                        <h1 className="text-3xl font-bold text-gray-900">Website Performance</h1>
                        <p className="text-gray-600 mt-1">Comprehensive technical SEO analysis and competitor comparison</p>
                    </div>
                    <div className="flex items-center space-x-4">
                        {lastRefresh && (
                            <span className="text-sm text-gray-500">
                                Last updated: {lastRefresh.toLocaleTimeString()}
                            </span>
                        )}
                        
                        {/* Inline Progress Indicator */}
                        {isRefreshing && (
                            <div className="flex items-center space-x-3 bg-white rounded-xl shadow-md px-4 py-2 border border-gray-100">
                                <div className="flex items-center space-x-2">
                                    <div className="w-4 h-4 border-2 border-blue-500 border-t-transparent rounded-full animate-spin"></div>
                                    <span className="text-sm font-medium text-gray-700">{refreshMessage}</span>
                                </div>
                                <div className="w-16 bg-gray-200 rounded-full h-2">
                                    <div 
                                        className="bg-gradient-to-r from-blue-500 to-blue-600 h-2 rounded-full transition-all duration-500 ease-out"
                                        style={{ width: `${refreshProgress}%` }}
                                    ></div>
                                </div>
                                <span className="text-xs font-medium text-blue-600 min-w-[2rem]">{refreshProgress}%</span>
                            </div>
                        )}
                        
                        <button 
                            onClick={isRefreshing ? cancelRefresh : triggerRefresh}
                            disabled={!webhooks && (!webhooks?.['On-Page Insights'] && !webhooks?.['Website Full Scan'])}
                            className={`px-6 py-2 rounded-xl font-medium transition-all duration-200 shadow-lg hover:shadow-xl ${
                                isRefreshing 
                                    ? 'bg-red-500 hover:bg-red-600 text-white' 
                                    : 'bg-gradient-to-r from-blue-500 to-blue-600 hover:from-blue-600 hover:to-blue-700 text-white'
                            } disabled:opacity-50 disabled:cursor-not-allowed`}
                        >
                            {isRefreshing ? 'Cancel' : 'Rescan Website'}
                        </button>
                    </div>
                </div>
            </div>

            {/* Main Health Dashboard */}
            <div className="grid grid-cols-1 xl:grid-cols-12 gap-6 mb-8">
                {/* Health Score Gauge - Left Column */}
                <div className="xl:col-span-4">
                    <div className="bg-white rounded-2xl shadow-lg p-8 border border-gray-100 h-full flex flex-col justify-center hover:-translate-y-0.5 transition-all duration-300 hover:shadow-xl hover:border-blue-200/60 will-change-transform">
                        <ModernGauge score={Number(healthData.pageScore) || 0} />
                        <div className="flex justify-center space-x-8 mt-6">
                            <ModernIssueCounter
                                icon={<AlertTriangle className="w-5 h-5 text-yellow-500" />}
                                title="Warnings"
                                items={healthData.warnings || []}
                                textColor="text-yellow-600"
                            />
                            <ModernIssueCounter
                                icon={<XCircle className="w-5 h-5 text-red-500" />}
                                title="Errors"
                                items={healthData.errors || []}
                                textColor="text-red-600"
                            />
                        </div>
                    </div>
                </div>

                {/* Right Column - 2x2 + 3 Layout */}
                <div className="xl:col-span-8 space-y-4 relative z-20">
                    {/* Top Row - 2 Large Cards */}
                    <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div className="bg-white rounded-2xl shadow-lg hover:shadow-xl transition-all duration-300 p-6 border border-gray-100 hover:border-blue-200/60 relative hover:-translate-y-0.5 will-change-transform">
                            <div className="flex items-start justify-between mb-4">
                                <div className={`p-3 rounded-xl ${speedStatus === 'excellent' ? 'bg-green-100 text-green-600' : speedStatus === 'good' ? 'bg-green-100 text-green-600' : 'bg-red-100 text-red-600'}`}>
                                    <TrendingUp className="w-6 h-6" />
                                </div>
                            </div>
                            <div className="flex items-center space-x-2 mb-2">
                                <h3 className="text-gray-600 text-sm font-medium">Page Load Speed</h3>
                                <div className="relative">
                                    <div className="info-tooltip-trigger cursor-help">
                                        <Info className="w-4 h-4 text-gray-400" />
                                    </div>
                                    <div className="absolute left-1/2 -translate-x-1/2 bottom-full mb-2 w-80 p-3 bg-gray-800 text-white text-xs rounded-lg shadow-lg opacity-0 transition-opacity duration-300 z-30 pointer-events-none info-tooltip-content">
                                        <div className="font-semibold mb-2 border-b border-gray-600 pb-2">Page Load Speed Testing</div>
                                        <div>Each test loads your page in a fresh browser and measures it in real time. Shifts in network traffic, server load, or third-party scripts may vary results.</div>
                                        <svg className="absolute text-gray-800 h-2 w-full left-0 top-full" x="0px" y="0px" viewBox="0 0 255 255"><polygon className="fill-current" points="0,0 127.5,127.5 255,0"/></svg>
                                    </div>
                                </div>
                            </div>
                            <p className="text-2xl font-bold text-gray-900 mb-1">
                                {(() => {
                                    const speed = healthData.siteSpeed;
                                    if (speed && !isNaN(speed)) {
                                        // ALL data comes in milliseconds, always convert to seconds
                                        const numericSpeed = parseFloat(speed);
                                        const seconds = (numericSpeed / 1000).toFixed(3);
                                        return `${seconds} seconds`;
                                    }
                                    return speed || 'N/A';
                                })()}
                            </p>
                            <p className="text-sm text-gray-500">{speedStatus === 'excellent' ? 'Excellent' : speedStatus === 'good' ? 'Good' : 'Poor Performance'}</p>
                            
                            {/* Speed Details */}
                            <div className="mt-4 pt-4 border-t border-gray-100">
                                <div className="grid grid-cols-2 gap-2 text-xs">
                                    {Object.entries(healthData.speedDetails).slice(0, 10).map(([key, val]) => {
                                        // Convert technical terms to user-friendly labels
                                        const friendlyLabels = {
                                            'Time to Interactive': 'Time to Interactive',
                                            'DOM Complete': 'Page Structure Ready',
                                            'Largest Contentful Paint': 'Main Content Loaded',
                                            'First Input Delay': 'Response Time',
                                            'Connection Time': 'Server Connection',
                                            'Time to Secure Connection': 'Security Setup',
                                            'Request Sent Time': 'Request Processing',
                                            'Waiting Time (TTFB)': 'Server Response',
                                            'Download Time': 'Content Download',
                                            'Full Page Load': 'Complete Load Time'
                                        };
                                        const displayLabel = friendlyLabels[key] || key;
                                        
                                        // Format the value - ALL data is in milliseconds, convert to seconds
                                        let formattedVal = val || '-';
                                        if (val && !isNaN(val)) {
                                            const numericVal = parseFloat(val);
                                            // ALL data is in milliseconds, always convert to seconds
                                            const seconds = (numericVal / 1000).toFixed(3);
                                            formattedVal = `${seconds}s`;
                                        } else if (val && typeof val === 'string' && val.includes('ms')) {
                                            // If already in ms format, convert to seconds
                                            const msValue = parseFloat(val.replace('ms', ''));
                                            if (!isNaN(msValue)) {
                                                formattedVal = `${(msValue / 1000).toFixed(3)}s`;
                                            }
                                        }
                                        
                                        return (
                                            <div key={key} className="text-gray-600 flex">
                                                <span className="text-gray-500 w-32">{displayLabel}:</span>
                                                <span className="font-medium ml-4">{formattedVal}</span>
                                            </div>
                                        );
                                    })}
                                </div>
                            </div>
                        </div>
                                                <div className="technical-checks-card bg-white rounded-2xl shadow-lg hover:shadow-xl transition-all duration-300 p-6 border border-gray-100 hover:border-blue-200/60 group relative hover:-translate-y-0.5 will-change-transform group-hover:z-50">
                            <div className="flex items-start justify-between mb-4">
                                <div className={`p-3 rounded-xl ${checksPercentage >= 90 ? 'bg-green-100 text-green-600' : checksPercentage >= 70 ? 'bg-yellow-100 text-yellow-600' : 'bg-red-100 text-red-600'}`}>
                                    {/* Keep icon color stable on hover */}
                                    <CheckCircle className={`w-6 h-6 ${checksPercentage >= 90 ? 'text-green-600' : checksPercentage >= 70 ? 'text-yellow-600' : 'text-red-600'}`} />
                                </div>
                            </div>
                            <div className="flex items-center space-x-2 mb-2">
                                <h3 className="text-gray-600 text-sm font-medium">Technical Checks</h3>
                                <div className="relative">
                                    <div className="info-tooltip-trigger cursor-help">
                                        <Info className="w-4 h-4 text-gray-400" />
                                    </div>
                                    <div className="absolute left-1/2 -translate-x-1/2 bottom-full mb-2 w-80 p-3 bg-gray-800 text-white text-xs rounded-lg shadow-lg opacity-0 transition-opacity duration-300 z-30 pointer-events-none info-tooltip-content">
                                        <div className="font-semibold mb-2 border-b border-gray-600 pb-2">Technical SEO Health Check</div>
                                        <div>Automated checks for essential SEO elements including performance, security, content quality, accessibility, and technical implementation. Each check validates best practices that impact search rankings and user experience.</div>
                                        <svg className="absolute text-gray-800 h-2 w-full left-0 top-full" x="0px" y="0px" viewBox="0 0 255 255"><polygon className="fill-current" points="0,0 127.5,127.5 255,0"/></svg>
                                    </div>
                                </div>
                            </div>
                            <p className="text-2xl font-bold text-gray-900 mb-1">{checksPassed}/{checksTotal}</p>
                            <p className="text-sm text-gray-500">{checksPercentage.toFixed(1)}% passed</p>
                            
                            {/* Category Breakdown */}
                            <div className="mt-4 pt-4 border-t border-gray-100">
                                <div className="grid grid-cols-1 gap-2">
                                    {(() => {
                                        // Reorder categories as requested: Performance, Security & Technical, SEO Optimization, Content Quality, Accessibility
                                        const orderedCategories = ['performance', 'security', 'seo', 'content', 'accessibility'];
                                        return orderedCategories.map(category => {
                                            const categoryData = checkCategories[category];
                                            if (!categoryData) return null;
                                            
                                            // Compute category totals using aggregate when available
                                            const entries = Object.entries(categoryData.checks);
                                            // Prefer aggregate per-check counts
                                            const categoryTotals = entries.map(([checkName]) => {
                                                const agg = aggregate?.perCheck?.[checkName];
                                                if (agg && typeof agg.passed === 'number' && typeof agg.total === 'number') {
                                                    return agg;
                                                }
                                                // Fallback to legacy boolean lists => pass=1/0, total=1 if present
                                                const isConsidered = (healthData.checks.passedList || []).includes(checkName) || (healthData.checks.failedList || []).includes(checkName);
                                                if (!isConsidered) return null;
                                                const isPassed = (healthData.checks.passedList || []).includes(checkName);
                                                return { passed: isPassed ? 1 : 0, total: 1 };
                                            }).filter(Boolean);
                                            if (categoryTotals.length === 0) return null;
                                            const passedCount = categoryTotals.reduce((s,c)=>s + c.passed, 0);
                                            const totalCount = categoryTotals.reduce((s,c)=>s + c.total, 0);
                                            const pct = totalCount > 0 ? (passedCount/totalCount)*100 : 0;
                                            const catColor = pct >= 90 ? 'text-green-500' : pct >= 70 ? 'text-yellow-500' : 'text-red-500';
                                            const catIcon = pct >= 90 ? '✅' : pct >= 70 ? '⚠️' : '❌';
                                            
                                            return (
                                                <div key={category} className="flex items-center justify-between text-xs">
                                                    <div className="flex items-center">
                                                        <span className="mr-2">{categoryData.icon}</span>
                                                        <span className="text-gray-600">{categoryData.title}</span>
                                                    </div>
                                                    <div className="flex items-center">
                                                        <span className={`mr-1 ${catColor}`}>
                                                            {catIcon}
                                                        </span>
                                                        <span className="text-gray-500">{passedCount}/{totalCount}</span>
                                                    </div>
                                                </div>
                                            );
                                        });
                                    })()}
                                </div>
                            </div>
                            
                            {/* Detailed Hover Tooltip – centred unless it would overflow right edge */}
                            <div className="technical-checks-tooltip opacity-0 group-hover:opacity-100 transition-opacity duration-300 pointer-events-none group-hover:pointer-events-auto group-hover:show w-[760px] max-w-[96vw] bg-gray-900 text-white text-sm rounded-xl shadow-2xl" style={{
                                position: 'absolute',
                                top: '100%',
                                left: '50%',
                                // Bias slightly left to avoid right-edge cutoff
                                transform: 'translate(calc(-50% - 40px), 16px)',
                                zIndex: 999999,
                                maxHeight: '80vh',
                                margin: '0'
                            }}>
                                <div className="px-4 py-3 bg-gray-800 rounded-t-xl font-semibold border-b border-gray-700">
                                    Technical SEO Health Check Results
                                </div>
                                <div className="p-4">
                                    <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                                        {(() => {
                                            // Reorder categories as requested: Performance, Security & Technical, SEO Optimization, Content Quality, Accessibility
                                            const topRowCategories = ['performance', 'security', 'seo'];
                                            const bottomRowCategories = ['content', 'accessibility'];
                                            const allCategories = [...topRowCategories, ...bottomRowCategories];
                                            
                                            return allCategories.map(category => {
                                                const categoryData = checkCategories[category];
                                                if (!categoryData) return null;
                                                
                                                const entries = Object.entries(categoryData.checks);
                                                const categoryTotals = entries.map(([checkName, description]) => {
                                                    const agg = aggregate?.perCheck?.[checkName];
                                                    if (agg && typeof agg.passed === 'number' && typeof agg.total === 'number') {
                                                        return { checkName, description, passed: agg.passed, total: agg.total };
                                                    }
                                                    const isConsidered = (healthData.checks.passedList || []).includes(checkName) || (healthData.checks.failedList || []).includes(checkName);
                                                    if (!isConsidered) return null;
                                                    const isPassed = (healthData.checks.passedList || []).includes(checkName);
                                                    return { checkName, description, passed: isPassed ? 1 : 0, total: 1 };
                                                }).filter(Boolean);
                                                if (categoryTotals.length === 0) return null;
                                                
                                                return (
                                                    <div key={category} className="space-y-2">
                                                        <h4 className="font-semibold flex items-center text-gray-300 text-sm">
                                                            <span className="mr-2">{categoryData.icon}</span>
                                                            {categoryData.title}
                                                        </h4>
                                                        <ul className="space-y-1.5">
                                                            {categoryTotals.map(({ checkName, description, passed, total }) => {
                                                                const pct = total > 0 ? (passed / total) * 100 : 0;
                                                                const color = pct >= 90 ? 'text-green-300' : pct >= 70 ? 'text-yellow-300' : 'text-red-300';
                                                                const icon = pct >= 90 ? '✅' : pct >= 70 ? '⚠️' : '❌';
                                                                return (
                                                                    <li key={checkName} className="flex items-start text-xs leading-relaxed">
                                                                        <span className="mr-2 flex-shrink-0 text-sm">{icon}</span>
                                                                        <span className={color}>
                                                                            {description} — {passed}/{total} ({pct.toFixed(0)}%)
                                                                        </span>
                                                                    </li>
                                                                );
                                                            })}
                                                        </ul>
                                                    </div>
                                                );
                                            });
                                        })()}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    {/* Bottom Row - 3 Compact Cards */}
                    <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div className="bg-white rounded-xl shadow-md hover:shadow-lg transition-all duration-300 p-4 border border-gray-100 hover:border-blue-200/60 hover:-translate-y-0.5 will-change-transform relative group">
                            <div className="flex items-center justify-between">
                                <div className={`p-2 rounded-lg ${hasBrokenLinks ? 'bg-red-100 text-red-600' : 'bg-green-100 text-green-600'}`}>
                                    <Link2 className="w-5 h-5" />
                                </div>
                            </div>
                            <div className="flex items-center space-x-1 mt-3 mb-1">
                                <h3 className="text-gray-600 text-sm font-medium">Broken Links</h3>
                                <InfoTooltip text="Checks for broken internal and external links on your website. Broken links hurt user experience and can negatively impact SEO rankings." />
                            </div>
                            <div className="relative">
                                <p className={`text-lg font-bold text-gray-900 ${hasBrokenLinks && brokenLinksDetails && brokenLinksDetails.length > 0 ? 'cursor-help' : ''}`}>
                                    {hasBrokenLinks ? `${brokenLinksCount} issue${brokenLinksCount === 1 ? '' : 's'}` : 'All Good'}
                                </p>
                                {hasBrokenLinks && brokenLinksDetails && brokenLinksDetails.length > 0 && (
                                    <div className="absolute left-0 bottom-full mb-2 w-80 p-3 bg-gray-800 text-white text-xs rounded-lg shadow-2xl opacity-0 group-hover:opacity-100 transition-opacity duration-300 pointer-events-none z-50">
                                        <div className="font-semibold mb-2">Broken Links Found:</div>
                                        <div className="max-h-32 overflow-y-auto space-y-1">
                                            {brokenLinksDetails.slice(0, 5).map((link, index) => (
                                                <div key={index} className="border-b border-gray-600 last:border-b-0 pb-1 last:pb-0">
                                                    <div className="font-medium text-red-300 break-all">{link.url}</div>
                                                    {link.statusCode && link.statusCode !== 'Unknown' && (
                                                        <div className="text-gray-400">Status: {link.statusCode}</div>
                                                    )}
                                                </div>
                                            ))}
                                            {brokenLinksDetails.length > 5 && (
                                                <div className="text-gray-400 italic">...and {brokenLinksDetails.length - 5} more</div>
                                            )}
                                        </div>
                                        <svg className="absolute text-gray-800 h-2 w-full left-0 top-full" x="0px" y="0px" viewBox="0 0 255 255"><polygon className="fill-current" points="0,0 127.5,127.5 255,0"/></svg>
                                    </div>
                                )}
                            </div>
                            <p className="text-xs text-gray-500">{hasBrokenLinks ? 'Broken links detected' : 'No broken links'}</p>
                        </div>
                        
                        <div className="bg-white rounded-xl shadow-md hover:shadow-lg transition-all duration-300 p-4 border border-gray-100 hover:border-blue-200/60 hover:-translate-y-0.5 will-change-transform">
                            <div className="flex items-center justify-between">
                                <div className={`p-2 rounded-lg ${healthData.ssl ? 'bg-green-100 text-green-600' : 'bg-red-100 text-red-600'}`}>
                                    <ShieldCheck className="w-5 h-5" />
                                </div>
                            </div>
                            <div className="flex items-center space-x-1 mt-3 mb-1">
                                <h3 className="text-gray-600 text-sm font-medium">SSL Certificate</h3>
                                <InfoTooltip text="Ensures your website uses HTTPS encryption to protect user data and improve search rankings. Google requires SSL certificates for secure browsing." />
                            </div>
                            <p className="text-lg font-bold text-gray-900">{healthData.ssl ? 'Secure' : 'Not Secure'}</p>
                            <p className="text-xs text-gray-500">{healthData.ssl ? 'HTTPS enabled' : 'HTTPS required'}</p>
                        </div>
                        
                        <div className="bg-white rounded-xl shadow-md hover:shadow-lg transition-all duration-300 p-4 border border-gray-100 hover:border-blue-200/60 hover:-translate-y-0.5 will-change-transform">
                            <div className="flex items-center justify-between">
                                <div className={`p-2 rounded-lg ${
                                    healthData.hasSchema 
                                        ? (healthData.hasSchemaErrors ? 'bg-yellow-100 text-yellow-600' : 'bg-green-100 text-green-600')
                                        : 'bg-red-100 text-red-600'
                                }`}>
                                    <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M10 20l4-16m4 4l4 4-4 4M6 16l-4-4 4-4" />
                                    </svg>
                                </div>
                            </div>
                            <div className="flex items-center space-x-1 mt-3 mb-1">
                                <h3 className="text-gray-600 text-sm font-medium">Schema Markup</h3>
                                <InfoTooltip text="Structured data that helps search engines understand your content better. Schema markup can improve rich snippets and local business visibility in search results." />
                            </div>
                            <p className="text-lg font-bold text-gray-900">{healthData.hasSchema ? 'Implemented' : 'Missing'}</p>
                            <p className="text-xs text-gray-500">
                                {healthData.hasSchema 
                                    ? (healthData.hasSchemaErrors ? 'Has errors to fix' : 'Valid and healthy')
                                    : 'Add structured data'
                                }
                            </p>
                        </div>
                    </div>
                </div>
            </div>

            {/* Dual Reports: Competitor Analysis + Error Report */}
            <div className="mb-8">
                <DualReports 
                    competitorText={aiReport || 'Competitor Analysis will appear when generated.'}
                    errorText={healthData?.errorReport || 'Error Report will appear here once generated in Website Crawl Summary (AK2).'}
                />
            </div>

            {/* Performance Comparison Section */}
            <div className="mb-8">
                <div className="bg-gradient-to-r from-blue-50 to-indigo-50 rounded-2xl p-6 border border-blue-100 dark:border-transparent">
                    <h2 className="text-2xl font-bold text-gray-900 mb-2">Competitive Analysis</h2>
                    <p className="text-gray-600 mb-6">Compare your website performance against key competitors</p>
                    
                    <div className="grid grid-cols-1 lg:grid-cols-2 gap-8">
                        <ModernComparisonChart 
                            data={competitorPerfData} 
                            dataKey="Site Speed (seconds)" 
                            title="Site Speed Comparison"
                            color={GRADIENT_COLORS[0]}
                            isInverted={true}
                        />
                        <ModernComparisonChart 
                            data={competitorPerfData} 
                            dataKey="Est. Monthly Traffic" 
                            title="Monthly Traffic"
                            color={GRADIENT_COLORS[1]}
                        />
                        <ModernComparisonChart 
                            data={competitorPerfData} 
                            dataKey="Referring Domains" 
                            title="Referring Domains"
                            color={GRADIENT_COLORS[2]}
                        />
                        <ModernComparisonChart 
                            data={competitorPerfData} 
                            dataKey="Total Backlinks" 
                            title="Total Backlinks"
                            color={GRADIENT_COLORS[3]}
                        />
                    </div>
                </div>
            </div>

                        {/* Modern Technical SEO Table */}
            {/* Technical SEO Checklist Table */}
            <Card className="mb-8 group hover:shadow-xl transition-all duration-300 hover:-translate-y-0.5 hover:border-blue-200/60">
                {/* Header Section */}
                <div className="bg-gradient-to-r from-blue-50 to-indigo-50 px-6 py-5 border-b border-gray-100">
                    <div className="flex items-center space-x-3">
                        <div className="p-2 bg-blue-100 rounded-lg">
                            <svg className="w-5 h-5 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                            </svg>
                        </div>
                        <div>
                            <h2 className="text-xl font-bold text-gray-800">Technical SEO Checklist</h2>
                            <p className="text-sm text-gray-600 mt-1">Essential technical elements across all websites for optimal search engine performance</p>
                        </div>
                    </div>
                </div>

                <table className="w-full text-left text-sm whitespace-nowrap">
                    <thead>
                        <tr className="competitor-table-header border-b border-gray-200">
                            <th className="py-4 px-4 font-semibold text-gray-800 w-1/4">Clinic</th>
                            <th className="py-4 px-4 text-center font-semibold text-gray-800 w-[12%]">SSL Certificate</th>
                            <th className="py-4 px-4 text-center font-semibold text-gray-800 w-[12%]">Schema Markup</th>
                            <th className="py-4 px-4 text-center font-semibold text-gray-800 w-[12%]">H1 Tag</th>
                            <th className="py-4 px-4 text-center font-semibold text-gray-800 w-[12%]">Title Tag</th>
                            <th className="py-4 px-4 text-center font-semibold text-gray-800 w-[12%]">Meta Description</th>
                        </tr>
                    </thead>
                    <tbody className="divide-y divide-gray-100 bg-white">
                        {technicalSeoData.map((site, index) => (
                            <tr key={site.name || site.id || index} className="service-row-hover transition-colors duration-200">
                                <td className="py-4 px-4">
                                    <div>
                                        <div className="font-semibold text-gray-800">
                                            {site.clinicName || site.name}
                                        </div>
                                        {site.website && (
                                            <div className="text-xs text-gray-500 mt-1">
                                                <a href={site.website} target="_blank" rel="noopener noreferrer" 
                                                   className="text-blue-600 hover:text-blue-800 hover:underline transition-colors">
                                                    {site.website.replace(/^https?:\/\//i, '')}
                                                </a>
                                            </div>
                                        )}
                                    </div>
                                </td>
                                <td className="py-4 px-4 text-center">
                                    {site.hasSSL ? (
                                        <CheckCircle className="w-6 h-6 text-green-500 mx-auto cursor-pointer" />
                                    ) : (
                                        <XCircle className="w-6 h-6 text-red-500 mx-auto cursor-pointer" />
                                    )}
                                </td>
                                <td className="py-4 px-4 text-center">
                                    {site.hasSchema ? (
                                        <CheckCircle className="w-6 h-6 text-green-500 mx-auto cursor-pointer" />
                                    ) : (
                                        <XCircle className="w-6 h-6 text-red-500 mx-auto cursor-pointer" />
                                    )}
                                </td>
                                <td className="py-4 px-4 text-center">
                                    <BooleanCheck value={site.h1} tooltipContent={site.h1} />
                                </td>
                                <td className="py-4 px-4 text-center">
                                    <BooleanCheck value={site.title} tooltipContent={site.title} />
                                </td>
                                <td className="py-4 px-4 text-center">
                                    <BooleanCheck value={site.description} tooltipContent={site.description} />
                                </td>
                            </tr>
                        ))}
                    </tbody>
                </table>
            </Card>
        </PageContent>
    );
};

/* ------------------------------------------------------------------ */
/* HEADER                                                             */
/* ------------------------------------------------------------------ */
const Header = ({active,setActive,theme,onThemeToggle}) => {
  const tabs=['Dashboard','Website Stats','Keywords','Backlinks','Geogrid Maps','Tools','Help Library'];
  return (
    <header className="sticky top-0 z-20" style={{ backgroundColor: 'var(--header-bg)', boxShadow: 'var(--header-shadow)' }}>
      <nav className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
        <div className="flex items-center justify-between h-16">
          <div className="flex items-center">
            <svg className="h-8 w-8" viewBox="0 0 24 24" fill="none"
                 stroke="url(#lg)" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
              <defs>
                <linearGradient id="lg" x1="0%" y1="0%" x2="100%" y2="0%">
                  <stop offset="0%" stopColor="#3b82f6"/><stop offset="100%" stopColor="#ec4899"/>
                </linearGradient>
              </defs>
              <path d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"/>
            </svg>
            <h1 className="text-xl font-bold ml-3 bg-gradient-to-r from-blue-500 to-pink-500 bg-clip-text text-transparent">
              MedSpa SEO
            </h1>
          </div>
          <div className="flex items-center space-x-6">
            <div className="hidden md:block">
              <div className="ml-10 flex space-x-4">
                {tabs.map(t=>(
                  <button key={t}
                          onClick={()=>{
                            // If clicking Help Library, clear any guide parameters
                            if (t === 'Help Library') {
                              const urlParams = new URLSearchParams(window.location.search);
                              urlParams.delete('guide');
                              window.history.replaceState({}, '', `${window.location.pathname}?${urlParams.toString()}`);
                              // Set the active tab first, then trigger a small delay to ensure state updates
                              setActive(t);
                              // Use a small timeout to ensure the component re-renders properly
                              setTimeout(() => {
                                // This will trigger the HelpLibrary component to reset its internal state
                                window.dispatchEvent(new Event('help-library-reset'));
                              }, 10);
                              return; // Don't call setActive again below
                            }
                            setActive(t);
                          }}
                          className={`px-3 py-2 rounded-md text-sm font-medium transition-colors
                            ${active===t?'bg-blue-600 text-white':'text-gray-500 hover:bg-gray-100 hover:text-gray-900'}`}
                          style={active !== t ? {
                            color: theme === 'dark' ? 'var(--text-secondary)' : undefined
                          } : undefined}>
                    {t}
                  </button>
                ))}
              </div>
            </div>
            {/* Theme Toggle Button */}
            <ThemeToggleButton isLight={theme === 'light'} onToggle={onThemeToggle} />
          </div>
        </div>
      </nav>
    </header>
  );
};

/* ------------------------------------------------------------------ */
/* MAIN APP – fetches data, routes tabs                               */
/* ------------------------------------------------------------------ */
const App = () => {
  // Initialize tab from URL parameter, fallback to 'Dashboard'
  const getInitialTab = () => {
    const urlParams = new URLSearchParams(location.search);
    const tabFromUrl = urlParams.get('tab');
    const validTabs = ['Dashboard', 'Website Stats', 'Geogrid Maps', 'Keywords', 'Backlinks', 'Tools', 'Help Library'];
    return validTabs.includes(tabFromUrl) ? tabFromUrl : 'Dashboard';
  };

  // Initialize theme from localStorage, fallback to 'light'
  const getInitialTheme = () => {
    const saved = localStorage.getItem('medSpaTheme');
    return saved === 'dark' ? 'dark' : 'light';
  };

  const [tab, setTab]   = useState(getInitialTab());
  const [data, setData] = useState(null);
  const [err,  setErr]  = useState(null);
  const [load, setLoad] = useState(true);
  const [theme, setTheme] = useState(getInitialTheme());

  // Update URL when tab changes
  useEffect(() => {
    const urlParams = new URLSearchParams(location.search);
    if (tab !== 'Dashboard') {
      urlParams.set('tab', tab);
    } else {
      urlParams.delete('tab');
    }
    const newUrl = `${location.pathname}?${urlParams.toString()}`;
    window.history.replaceState({}, '', newUrl);
  }, [tab]);

  // Handle theme changes and persist to localStorage
  const handleThemeToggle = useCallback((isDay) => {
    const newTheme = isDay ? 'light' : 'dark';
    setTheme(newTheme);
    localStorage.setItem('medSpaTheme', newTheme);
    
    // Apply theme to document root
    document.documentElement.setAttribute('data-theme', newTheme);
  }, []);

  // Apply theme on mount and when theme changes
  useEffect(() => {
    document.documentElement.setAttribute('data-theme', theme);
  }, [theme]);

    // Helper to prefetch remaining sections in the background after dashboard loads
  const prefetchRemainingSections = useCallback((workbookId) => {
      const base = 'https://script.google.com/macros/s/AKfycbxfOMp8d_eCVH4lFD0PNuFU1wH-gyWOwRt2EuME7GQJ4U73ZwpPDciohDH3C566YLWq/exec';
      const fetchJson = (sections) => fetch(`${base}?workbookId=${workbookId}&sections=${encodeURIComponent(sections)}`)
        .then(r => r.json())
        .catch(() => null);

      Promise.all([
        fetchJson('websiteStats'),
        fetchJson('geogridData'),
        fetchJson('keywordsSummary,keywordsTable,keywordsSummaryArchive'),
        fetchJson('backlinksSummary,backlinksTable,backlinksSummaryArchive')
      ]).then(([ws, gg, kw, bl]) => {
        if (ws && ws.websiteStats) {
          setData(prev => ({ ...(prev || {}), websiteStats: ws.websiteStats }));
        }
        if (gg && gg.geogridData) {
          setData(prev => ({ ...(prev || {}), geogridData: gg.geogridData }));
          // Cache geogrid data for both dashboard and full geogrid pages
          try {
            sessionStorage.setItem(`geogrid_${workbookId}`, JSON.stringify(gg.geogridData));
            sessionStorage.setItem(`full_geogrid_${workbookId}`, JSON.stringify(gg.geogridData));
          } catch (e) {
            console.warn('Failed to cache geogrid data:', e);
          }
        }
        if (kw && kw.keywordsSummary && kw.keywordsTable) {
          const kwPayload = {
            keywordsSummary: kw.keywordsSummary,
            keywordsTable: kw.keywordsTable,
            keywordsSummaryArchive: kw.keywordsSummaryArchive || []
          };
          sessionStorage.setItem(`keywords_${workbookId}`, JSON.stringify(kwPayload));
        }
        if (bl && bl.backlinksSummary && bl.backlinksTable) {
          const blPayload = {
            backlinksSummary: bl.backlinksSummary,
            backlinksTable: bl.backlinksTable,
            backlinksSummaryArchive: bl.backlinksSummaryArchive || []
          };
          sessionStorage.setItem(`backlinks_${workbookId}`, JSON.stringify(blPayload));
        }
      });
  }, [setData]);

  useEffect(() => {
    const id = new URLSearchParams(location.search).get('workbookId');
    if (!id) { setErr('Add ?workbookId=YOUR_ID to the URL'); setLoad(false); return; }

    // First load only dashboard + webhooks to reduce payload, then prefetch the rest
    fetchWithCorsWorkaround(`https://script.google.com/macros/s/AKfycbxfOMp8d_eCVH4lFD0PNuFU1wH-gyWOwRt2EuME7GQJ4U73ZwpPDciohDH3C566YLWq/exec?workbookId=${id}&sections=${encodeURIComponent('dashboard,webhooks')}`, (err, j) => {
      if (err) {
        console.error(err);
        setErr(err.message);
        setLoad(false);
        return;
      }
      if (j.error) {
        setErr(`Script error: ${j.error}`);
        setLoad(false);
        return;
      }
      console.log('Initial sections loaded:', Object.keys(j));
      setData(j); 
      setLoad(false); 
      // Kick off background prefetch for other sections so tabs are ready
      prefetchRemainingSections(id);
    });
  }, [prefetchRemainingSections]);

  /* routing */
  let body;
  if (load) {
    body = <DashboardSkeleton />;
  } else if (err) {
    body = (
      <PageContent>
        <div className="p-8 text-center text-red-500">{err}</div>
      </PageContent>
    );
  } else {
    switch (tab) {
      case 'Dashboard':
        body = <Dashboard setActiveTab={setTab} webhooks={data.webhooks} setData={setData} />;
        break;
      case 'Website Stats':
        body = <WebsiteStats data={data.websiteStats} webhooks={data.webhooks} setData={setData} />;
        break;
      case 'Geogrid Maps':
        body = <GeogridMaps data={data.geogridData} />;
        break;
      case 'Keywords':
        body = (
          <Keywords
            summary={data.keywordsSummary}
            table={data.keywordsTable}
            webhooks={data.webhooks}
            setData={setData}
          />
        );
        break;
      case 'Backlinks':
        body = <Backlinks webhooks={data?.webhooks} />;
        break;
      case 'Help Library':
        body = <HelpLibrary />;
        break;
      case 'Tools':
        body = <ToolsPage />;
        break;
      default:
        body = <ToolsPage />;
    }
  }

  /* ----- render ----- */
            return (
    <div className="min-h-screen font-sans" style={{ backgroundColor: 'var(--bg-primary)' }}>
      <Header active={tab} setActive={setTab} theme={theme} onThemeToggle={handleThemeToggle} />
      {body}
    </div>
  );
};

/* ------------------------------------------------------------------ */
/* Optimized App Initialization                                       */
/* ------------------------------------------------------------------ */

// Enhanced app initialization with comprehensive performance tracking
const initializeApp = () => {
  const requiredGlobals = ['React', 'ReactDOM', 'Recharts'];
  const allLoaded = requiredGlobals.every(global => window[global]);
  
  if (allLoaded) {
    const loadTime = performance.now();
    console.log('✅ All dependencies loaded, mounting React app...');
    console.log(`⚡ Total load time: ${loadTime.toFixed(2)}ms`);
    
    // Basic performance monitoring
    if ('performance' in window && performance.getEntriesByType) {
      try {
        const perfData = performance.getEntriesByType('navigation')[0];
        if (perfData && perfData.loadEventEnd) {
          console.log('📊 Load Time:', `${perfData.loadEventEnd.toFixed(2)}ms`);
        }
      } catch (e) {
        // Ignore performance monitoring errors
      }
    }
    
    // Update progress
    const progressEl = document.getElementById('load-progress');
    if (progressEl) progressEl.textContent = 'Starting application...';
    
    // Use concurrent mode for better performance
    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<App />);
    
    // Clear initial loader after a short delay to ensure smooth transition
    setTimeout(() => {
      const loaderContainer = document.querySelector('.loader-container');
      if (loaderContainer) {
        loaderContainer.style.opacity = '0';
        setTimeout(() => loaderContainer.remove(), 300);
      }
    }, 100);
  } else {
    const missing = requiredGlobals.filter(g => !window[g]);
    console.log('⏳ Waiting for dependencies...', missing);
    
    // Update progress with more specific info
    const progressEl = document.getElementById('load-progress');
    if (progressEl) {
      const loadingMsg = missing.length === 1 ? 
        `Loading ${missing[0]}...` : 
        `Loading ${missing.length} components...`;
      progressEl.textContent = loadingMsg;
    }
    
    // Use requestAnimationFrame for better performance
    requestAnimationFrame(() => setTimeout(initializeApp, 50));
  }
};



// Start initialization when DOM is ready
if (document.readyState === 'loading') {
  document.addEventListener('DOMContentLoaded', initializeApp);
} else {
  initializeApp();
}
</script>
</body>
</html>