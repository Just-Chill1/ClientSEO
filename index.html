<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>MedSpa SEO Dashboard</title>

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Font -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet" />

  <style>
    body{font-family:'Inter',sans-serif}
    .loader-container{display:flex;flex-direction:column;justify-content:center;align-items:center;height:100vh}
    .loader{border:4px solid #f3f3f3;border-top:4px solid #3498db;border-radius:50%;width:40px;height:40px;animation:spin 1s linear infinite}
    @keyframes spin{0%{transform:rotate(0deg)}100%{transform:rotate(360deg)}}
  </style>

  <!-- React -->
  <script crossorigin src="https://cdn.jsdelivr.net/npm/react@18.2.0/umd/react.production.min.js"></script>
  <script crossorigin src="https://cdn.jsdelivr.net/npm/react-dom@18.2.0/umd/react-dom.production.min.js"></script>

  <!-- Babel for in-page JSX -->
  <script src="https://unpkg.com/@babel/standalone@7.23.1/babel.min.js"></script>

  <!-- Recharts + peers -->
  <script src="https://cdn.jsdelivr.net/npm/prop-types@15.8.1/prop-types.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/recharts@2.15.4/umd/Recharts.min.js"></script>
</head>

<body class="bg-gray-50">
  <div id="root">
    <div class="loader-container">
      <div class="loader"></div>
      <p class="text-gray-500 mt-4">Loading Application...</p>
    </div>
  </div>

  <!-- Main React Application -->
  <script type="text/babel">
    const { useState, useEffect } = React;
    const { ResponsiveContainer, BarChart, Bar, XAxis, YAxis, Tooltip } = Recharts;   /* ← makes Recharts symbols available */

    /* -------------------- shell waits for libs -------------------- */
    const AppContainer = () => {
      const [libsLoaded, setLibsLoaded] = useState(false);
      const [libError,  setLibError]   = useState(null);

      useEffect(() => {
        const start = Date.now();
        const interval = setInterval(() => {
          if (window.React && window.ReactDOM && window.Recharts) {
            setLibsLoaded(true);
            clearInterval(interval);
          } else if (Date.now() - start > 10_000) {
            setLibError('Failed to load libraries from CDN.');
            clearInterval(interval);
          }
        }, 100);
        return () => clearInterval(interval);
      }, []);

      if (libError) return <div className="loader-container"><p className="text-red-500">{libError}</p></div>;
      if (!libsLoaded) return (
        <div className="loader-container">
          <div className="loader"></div>
          <p className="text-gray-500 mt-4">Initializing Libraries...</p>
        </div>
      );
      return <App />;
    };
    /* ------------------------------------------------------------- */

    /* ---------- helpers ---------- */
    const Card        = ({children,className=''}) => <div className={`bg-white rounded-xl shadow-md p-6 ${className}`}>{children}</div>;
    const PageContent = ({children}) => <main className="flex-1 p-4 sm:p-6 lg:p-8">{children}</main>;

    /* tiny KPI card */
    const StatCard = ({label,value}) => (
      <div className="flex flex-col items-center bg-white shadow-sm rounded-lg p-4 min-w-[110px]">
        <span className="text-sm text-gray-500">{label}</span>
        <span className="text-xl font-semibold mt-1">{value}</span>
      </div>
    );

    /* ------------------   PAGES ----------------- */
    const Dashboard = () => <PageContent><div className="p-8 text-center text-gray-500">Dashboard Content Placeholder</div></PageContent>;

    const WebsiteStatsPage = ({data}) => {
      if (!data) return <PageContent><div className="p-8 text-center text-gray-500">No data.</div></PageContent>;

      const { healthData, competitorPerfData, technicalSeoData } = data;

      /* KPI cards */
      const cards = [
        { label:'Health Score', value:`${healthData.pageScore.toFixed(0)} /100` },
        { label:'Site Speed',   value: healthData.siteSpeed },
        { label:'Broken Links', value: healthData.brokenLinks ? 'Yes' : 'No' },
        { label:'SSL',          value: healthData.ssl ? '✅' : '❌' },
      ];

      /* bar-chart dataset */
      const chartData = competitorPerfData.map(r => ({
        name: r.name + (r.isClient ? ' (You)' : ''),
        speed: parseFloat(r['Site Speed (s)'])
      }));

      return (
        <PageContent>
          {/* KPI cards */}
          <div className="flex flex-wrap gap-4 mb-8">
            {cards.map(c => <StatCard key={c.label} {...c} />)}
          </div>

          {/* bar chart */}
          <div className="bg-white shadow-sm rounded-lg p-6">
            <h2 className="text-lg font-semibold mb-4">Site Speed (s) – you vs competitors</h2>
            <ResponsiveContainer width="100%" height={280}>
              <BarChart data={chartData}>
                <XAxis dataKey="name" tick={{fontSize: 12}} />
                <YAxis />
                <Tooltip />
                <Bar dataKey="speed" fill="#3b82f6" />
              </BarChart>
            </ResponsiveContainer>
          </div>

          {/* technical SEO table (first 10 rows) */}
          <div className="bg-white shadow-sm rounded-lg p-6 mt-8 overflow-x-auto">
            <h2 className="text-lg font-semibold mb-4">Technical SEO Checks (client)</h2>
            <table className="min-w-[640px] text-sm">
              <thead className="text-left border-b">
                <tr><th className="py-2 pr-4">URL</th><th className="py-2">SSL</th></tr>
              </thead>
              <tbody>
                {technicalSeoData.slice(0,10).map(row => (
                  <tr key={row.url} className="border-b last:border-0">
                    <td className="py-2 pr-4">{row.url}</td>
                    <td className="py-2">{row.hasSSL ? '✅' : '❌'}</td>
                  </tr>
                ))}
              </tbody>
            </table>
            <p className="text-xs text-gray-400 mt-2">Showing first 10 rows for now.</p>
          </div>
        </PageContent>
      );
    };

    const GeogridMapsPage = () => <PageContent><div className="p-8 text-center text-gray-500">Geogrid Maps Placeholder</div></PageContent>;
    const KeywordsPage    = () => <PageContent><div className="p-8 text-center text-gray-500">Keywords Placeholder</div></PageContent>;
    const BacklinksPage   = () => <PageContent><div className="p-8 text-center text-gray-500">Backlinks Placeholder</div></PageContent>;

    /* ------------------ HEADER ------------------ */
    const Header = ({activeTab,setActiveTab}) => {
      const tabs = ['Dashboard','Website Stats','Geogrid Maps','Keywords','Backlinks','Tools'];
      return (
        <header className="bg-white shadow-sm sticky top-0 z-20">
          <nav className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div className="flex items-center justify-between h-16">
              <div className="flex items-center">
                <svg className="h-8 w-8" viewBox="0 0 24 24" fill="none"
                     stroke="url(#logo-gradient)" strokeWidth="2"
                     strokeLinecap="round" strokeLinejoin="round">
                  <defs>
                    <linearGradient id="logo-gradient" x1="0%" y1="0%" x2="100%" y2="0%">
                      <stop offset="0%" style={{stopColor:'#3b82f6'}} />
                      <stop offset="100%" style={{stopColor:'#ec4899'}} />
                    </linearGradient>
                  </defs>
                  <path d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" />
                </svg>
                <h1 className="text-xl font-bold ml-3 bg-gradient-to-r from-blue-500 to-pink-500 bg-clip-text text-transparent">MedSpa SEO</h1>
              </div>

              <div className="hidden md:block">
                <div className="ml-10 flex items-baseline space-x-4">
                  {tabs.map(tab => (
                    <button key={tab}
                            onClick={() => setActiveTab(tab)}
                            className={`px-3 py-2 rounded-md text-sm font-medium
                                        ${activeTab===tab ? 'bg-blue-600 text-white'
                                                          : 'text-gray-500 hover:bg-gray-100 hover:text-gray-900'}`}>
                      {tab}
                    </button>
                  ))}
                </div>
              </div>
            </div>
          </nav>
        </header>
      );
    };

    /* ------------------ MAIN APP ---------------- */
    const App = () => {
      const [activeTab,setActiveTab] = useState('Dashboard');
      const [appData, setAppData]    = useState(null);
      const [loading, setLoading]    = useState(true);
      const [error,   setError]      = useState(null);

      useEffect(() => {
        const params = new URLSearchParams(window.location.search);
        const workbookId = params.get('workbookId');
        if (!workbookId) {
          setError("Add '?workbookId=YOUR_ID' to the URL.");
          setLoading(false);
          return;
        }

        const url = `https://script.google.com/macros/s/AKfycbxfOMp8d_eCVH4lFD0PNuFU1wH-gyWOwRt2EuME7GQJ4U73ZwpPDciohDH3C566YLWq/exec?workbookId=${workbookId}`;

        fetch(url)
          .then(r => r.json())
          .then(json => { if (json.error) throw new Error(json.error); setAppData(json); setLoading(false); })
          .catch(err => { console.error(err); setError(err.message); setLoading(false); });
      }, []);

      const renderContent = () => {
        if (loading)  return <PageContent><div className="p-8 text-center text-gray-500">Loading live data…</div></PageContent>;
        if (error)    return <PageContent><div className="p-8 text-center text-red-500">Error: {error}</div></PageContent>;
        if (!appData) return <PageContent><div className="p-8 text-center text-gray-500">No data found.</div></PageContent>;

        switch (activeTab) {
          case 'Website Stats': return <WebsiteStatsPage data={appData.websiteStats} />;
          case 'Geogrid Maps':  return <GeogridMapsPage />;
          case 'Keywords':      return <KeywordsPage />;
          case 'Backlinks':     return <BacklinksPage />;
          case 'Tools':         return <PageContent><div className="p-8 text-center text-gray-500">Tools Coming Soon…</div></PageContent>;
          default:              return <Dashboard />;
        }
      };

      return (
        <div className="min-h-screen bg-gray-50 font-sans">
          <Header activeTab={activeTab} setActiveTab={setActiveTab} />
          {renderContent()}
        </div>
      );
    };

    ReactDOM.createRoot(document.getElementById('root')).render(<AppContainer />);
  </script>
</body>
</html>
